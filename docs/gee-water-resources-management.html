<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />


<meta name="author" content="Ujaval Gandhi" />


<title>Google Earth Engine for Water Resources Management (Full Course Material)</title>

<script src="site_libs/header-attrs-2.10/header-attrs.js"></script>
<script src="site_libs/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/flatly.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<style>h1 {font-size: 34px;}
       h1.title {font-size: 38px;}
       h2 {font-size: 30px;}
       h3 {font-size: 24px;}
       h4 {font-size: 18px;}
       h5 {font-size: 16px;}
       h6 {font-size: 12px;}
       code {color: inherit; background-color: rgba(0, 0, 0, 0.04);}
       pre:not([class]) { background-color: white }</style>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<link href="site_libs/pagedtable-1.1/css/pagedtable.css" rel="stylesheet" />
<script src="site_libs/pagedtable-1.1/js/pagedtable.js"></script>
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-172372432-3"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-172372432-3');
</script>

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>


<style type="text/css">
  code {
    white-space: pre;
  }
  .sourceCode {
    overflow: visible;
  }
</style>
<style type="text/css" data-origin="pandoc">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */

</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    for (var j = 0; j < rules.length; j++) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") continue;
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') continue;
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>







<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
pre code {
  padding: 0;
}
</style>


<style type="text/css">
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #adb5bd;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script type="text/javascript">
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.tab('show');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');

  // Navbar adjustments
  var navHeight = $(".navbar").first().height() + 15;
  var style = document.createElement('style');
  var pt = "padding-top: " + navHeight + "px; ";
  var mt = "margin-top: -" + navHeight + "px; ";
  var css = "";
  // offset scroll position for anchor links (for fixed navbar)
  for (var i = 1; i <= 6; i++) {
    css += ".section h" + i + "{ " + pt + mt + "}\n";
  }
  style.innerHTML = "body {" + pt + "padding-bottom: 40px; }\n" + css;
  document.head.appendChild(style);
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "&#xe258;";
  border: none;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->




</head>

<body>


<div class="container-fluid main-container">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">Courses</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="http://spatialthoughts.com">Back to Main Site</a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li>
  <a href="#">Back to Top</a>
</li>
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div id="header">



<h1 class="title toc-ignore">Google Earth Engine for Water Resources Management (Full Course Material)</h1>
<h3 class="subtitle">Application-focused Introduction to Google Earth Engine.</h3>
<h4 class="author">Ujaval Gandhi</h4>

</div>

<div id="TOC">
<ul>
<li><a href="#introduction">Introduction</a></li>
<li><a href="#setting-up-the-environment">Setting up the Environment</a>
<ul>
<li><a href="#sign-up-for-google-earth-engine">Sign-up for Google Earth Engine</a></li>
<li><a href="#get-the-course-materials">Get the Course Materials</a></li>
</ul></li>
<li><a href="#module-1-google-earth-engine-fundamentals">Module 1: Google Earth Engine Fundamentals</a>
<ul>
<li><a href="#hello-world">01. Hello World</a>
<ul>
<li><a href="#exercise">Exercise</a></li>
<li><a href="#saving-your-work">Saving Your Work</a></li>
</ul></li>
<li><a href="#working-with-image-collections">02. Working with Image Collections</a>
<ul>
<li><a href="#exercise-1">Exercise</a></li>
</ul></li>
<li><a href="#filtering-image-collections">03. Filtering Image Collections</a>
<ul>
<li><a href="#exercise-2">Exercise</a></li>
</ul></li>
<li><a href="#mosaics-and-composites">04. Mosaics and Composites</a>
<ul>
<li><a href="#exercise-3">Exercise</a></li>
</ul></li>
<li><a href="#feature-collection">05. Feature Collection</a>
<ul>
<li><a href="#exercise-4">Exercise</a></li>
</ul></li>
<li><a href="#clipping">06. Clipping</a>
<ul>
<li><a href="#exercise-5">Exercise</a></li>
</ul></li>
<li><a href="#calculating-indices">07. Calculating Indices</a>
<ul>
<li><a href="#exercise-6">Exercise</a></li>
</ul></li>
<li><a href="#computation-on-images">08. Computation on Images</a>
<ul>
<li><a href="#exercise-7">Exercise</a></li>
</ul></li>
<li><a href="#export">09. Export</a>
<ul>
<li><a href="#exercise-8">Exercise</a></li>
</ul></li>
</ul></li>
<li><a href="#module-2-surface-water-mapping">Module 2: Surface Water Mapping</a>
<ul>
<li><a href="#load-global-surface-water-data">01. Load Global Surface Water Data</a>
<ul>
<li><a href="#exercise-9">Exercise</a></li>
</ul></li>
<li><a href="#create-a-water-mask">02. Create a Water Mask</a>
<ul>
<li><a href="#exercise-10">Exercise</a></li>
</ul></li>
<li><a href="#find-lost-waterbodies">03. Find Lost Waterbodies</a>
<ul>
<li><a href="#exercise-11">Exercise</a></li>
</ul></li>
<li><a href="#get-yearly-water-history">04. Get Yearly Water History</a>
<ul>
<li><a href="#exercise-12">Exercise</a></li>
</ul></li>
<li><a href="#locate-a-subbasin">05. Locate a SubBasin</a>
<ul>
<li><a href="#exercise-13">Exercise</a></li>
</ul></li>
<li><a href="#create-a-surface-water-map">06. Create a Surface Water Map</a>
<ul>
<li><a href="#exercise-14">Exercise</a></li>
</ul></li>
<li><a href="#convert-raster-to-vector">07. Convert Raster to Vector</a>
<ul>
<li><a href="#exercise-15">Exercise</a></li>
</ul></li>
</ul></li>
<li><a href="#module-3-precipitation-time-series-analysis">Module 3: Precipitation Time Series Analysis</a>
<ul>
<li><a href="#mapping-a-function">01. Mapping a Function</a>
<ul>
<li><a href="#exercise-16">Exercise</a></li>
</ul></li>
<li><a href="#reducers">02. Reducers</a>
<ul>
<li><a href="#exercise-17">Exercise</a></li>
</ul></li>
<li><a href="#calculating-total-rainfall">03. Calculating Total Rainfall</a>
<ul>
<li><a href="#exercise-18">Exercise</a></li>
</ul></li>
<li><a href="#aggregating-time-series">04. Aggregating Time Series</a>
<ul>
<li><a href="#exercise-19">Exercise</a></li>
</ul></li>
<li><a href="#charting-monthly-rainfall">05. Charting Monthly Rainfall</a>
<ul>
<li><a href="#exercise-20">Exercise</a></li>
</ul></li>
<li><a href="#import">06. Import</a>
<ul>
<li><a href="#exercise-21">Exercise</a></li>
</ul></li>
<li><a href="#zonal-statistics">07. Zonal Statistics</a>
<ul>
<li><a href="#exercise-22">Exercise</a></li>
</ul></li>
<li><a href="#trend-analysis">08. Trend Analysis</a>
<ul>
<li><a href="#exercise-23">Exercise</a></li>
</ul></li>
</ul></li>
<li><a href="#module-4-land-use-land-coverclassification">Module 4: Land Use Land CoverClassification</a>
<ul>
<li><a href="#introduction-to-machine-learning-and-supervised-classification">Introduction to Machine Learning and Supervised Classification</a></li>
<li><a href="#basic-supervised-classification">01. Basic Supervised Classification</a>
<ul>
<li><a href="#exercise-24">Exercise</a></li>
</ul></li>
<li><a href="#accuracy-assessment">02. Accuracy Assessment</a></li>
<li><a href="#improving-the-classification">03. Improving the Classification</a></li>
<li><a href="#exporting-classification-results">04. Exporting Classification Results</a>
<ul>
<li><a href="#exercise-25">Exercise</a></li>
</ul></li>
<li><a href="#using-existing-landcover-datasets">05. Using Existing Landcover Datasets</a>
<ul>
<li><a href="#exercise-26">Exercise</a></li>
</ul></li>
<li><a href="#calculating-area">06. Calculating Area</a>
<ul>
<li><a href="#exercise-27">Exercise</a></li>
</ul></li>
</ul></li>
<li><a href="#module-5-flood-mapping">Module 5: Flood Mapping</a>
<ul>
<li><a href="#load-and-filter-sentinel-1-data">01. Load and Filter Sentinel-1 Data</a>
<ul>
<li><a href="#exercise-28">Exercise</a></li>
</ul></li>
<li><a href="#visualize-rgb-composites">02. Visualize RGB Composites</a>
<ul>
<li><a href="#exercise-29">Exercise</a></li>
</ul></li>
<li><a href="#apply-speckle-filter">03. Apply Speckle Filter</a></li>
<li><a href="#apply-a-threshold">04. Apply a Threshold</a>
<ul>
<li><a href="#exercise-30">Exercise</a></li>
</ul></li>
<li><a href="#apply-masks">05. Apply Masks</a>
<ul>
<li><a href="#exercise-31">Exercise</a></li>
</ul></li>
<li><a href="#calculate-flooded-area">06. Calculate Flooded Area</a>
<ul>
<li><a href="#exercise-32">Exercise</a></li>
</ul></li>
</ul></li>
<li><a href="#drought-monitoring">06 Drought Monitoring</a>
<ul>
<li><a href="#load-modis-ndvi">01. Load MODIS NDVI</a>
<ul>
<li><a href="#exercise-33">Exercise</a></li>
</ul></li>
<li><a href="#apply-cloud-mask">02. Apply Cloud Mask</a>
<ul>
<li><a href="#exercise-34">Exercise</a></li>
</ul></li>
<li><a href="#extract-and-scale-ndvi-band">03. Extract and Scale NDVI Band</a>
<ul>
<li><a href="#exercise-35">Exercise</a></li>
</ul></li>
<li><a href="#create-monthly-images">04. Create Monthly Images</a>
<ul>
<li><a href="#exercise-36">Exercise</a></li>
</ul></li>
<li><a href="#calculate-min-max-composites">05. Calculate Min Max Composites</a>
<ul>
<li><a href="#exercise-37">Exercise</a></li>
</ul></li>
<li><a href="#calculate-vci">06. Calculate VCI</a>
<ul>
<li><a href="#exercise-38">Exercise</a></li>
</ul></li>
<li><a href="#classify-vci-image">07. Classify VCI Image</a>
<ul>
<li><a href="#exercise-39">Exercise</a></li>
</ul></li>
</ul></li>
<li><a href="#earth-engine-apps">07 Earth Engine Apps</a>
<ul>
<li><a href="#client-vs-server">01. Client vs Server</a></li>
<li><a href="#building-an-app-with-ui-widgets">02. Building an App with UI Widgets</a>
<ul>
<li><a href="#publishing-the-app.">Publishing the App.</a></li>
<li><a href="#exercise-40">Exercise</a></li>
</ul></li>
<li><a href="#performing-calculations">03. Performing Calculations</a>
<ul>
<li><a href="#exercise-41">Exercise</a></li>
</ul></li>
</ul></li>
<li><a href="#supplement">Supplement</a>
<ul>
<li><a href="#drought-monitoring-1">Drought Monitoring</a>
<ul>
<li><a href="#pie-chart-group-statistics">Pie Chart Group Statistics</a></li>
</ul></li>
<li><a href="#hydrology">Hydrology</a>
<ul>
<li><a href="#chart-cumulative-rainfall">Chart Cumulative Rainfall</a></li>
<li><a href="#exporting-precipitation-data">Exporting Precipitation Data</a></li>
<li><a href="#gpm-precipitation-time-series">GPM Precipitation Time Series</a></li>
<li><a href="#imd-number-of-rainy-days">IMD Number of Rainy Days</a></li>
</ul></li>
<li><a href="#surface-water">Surface Water</a>
<ul>
<li><a href="#detect-first-year-of-water">Detect First Year of Water</a></li>
<li><a href="#otsu-dynamic-thresholding">Otsu Dynamic Thresholding</a></li>
<li><a href="#smoothing-vectors">Smoothing Vectors</a></li>
<li><a href="#surface-water-explorer-split-panel-app">Surface Water Explorer Split Panel App</a></li>
<li><a href="#unsupervised-clustering-basic">Unsupervised Clustering Basic</a></li>
<li><a href="#unsupervised-clustering-advanced">Unsupervised Clustering Advanced</a></li>
</ul></li>
<li><a href="#time-series-analysis">Time Series Analysis</a>
<ul>
<li><a href="#mann-kendall-test">Mann Kendall Test</a></li>
</ul></li>
</ul></li>
<li><a href="#data-credits">Data Credits</a></li>
<li><a href="#license">License</a></li>
</ul>
</div>

<div style="page-break-after: always;"></div>
<hr />
<p><img src="images/spatial_thoughts_logo.png" width="250pt" style="display: block; margin: auto;" /></p>
<hr />
<div style="page-break-after: always;"></div>
<div id="introduction" class="section level1">
<h1>Introduction</h1>
<p>GIS and Remote Sensing plays a critical role in the management of water resources. Many practitioners in this field are constrained by the availability of tools and computing resources to use these techniques effectively. Recent advances in cloud computing technology have given rise to platforms such as Google Earth Engine, which provide free access to a large pool of computational resources and datasets. The course is designed for researchers in the water sector, academicians, water managers, and stakeholders with basic knowledge of Remote Sensing. It will enable them to leverage this platform for water resource management applications.</p>
<p><a href="https://docs.google.com/presentation/d/1-PqksKb2QB8YJTQic5M80ZAsKh1Ld6OxOoO6BG77Uhg/edit?usp=sharing" target="_blank"><img src="images/gee_water_resources_management/course_overview.png" width="400" alt="View Presentation" /></a></p>
<p><a href="https://docs.google.com/presentation/d/1-PqksKb2QB8YJTQic5M80ZAsKh1Ld6OxOoO6BG77Uhg/edit?usp=sharing" target="_blank">View the Presentation ↗</a></p>
</div>
<div id="setting-up-the-environment" class="section level1">
<h1>Setting up the Environment</h1>
<div id="sign-up-for-google-earth-engine" class="section level2">
<h2>Sign-up for Google Earth Engine</h2>
<p>If you already have a Google Earth Engine account, you can skip this step.</p>
<p>Visit <a href="https://signup.earthengine.google.com/" target="_blank">https://signup.earthengine.google.com/</a> and sign-up with your Google account. You can use your existing gmail account to sign-up. It usually takes 1-2 days for approval. Hence do this step as soon as possible.</p>
<p>Tips to ensure smooth sign-up process:</p>
<ul>
<li>Use Google Chrome browser.</li>
<li>When signing up for Earth Engine, please log out of all Google accounts and ensure you are logged into only 1 account which you want associated with Earth Engine.</li>
<li>Access to Google Earth Engine is granted via Google Groups. The default settings should be fine, but verify you have the correct setting enabled.
<ul>
<li>Visit <a href="http://groups.google.com/" target="_blank">groups.google.com</a></li>
<li>Click on Settings (gear icon) and select Global Settings.</li>
<li>Make sure the option Allow group managers to add me to their groups is checked.</li>
</ul></li>
</ul>
</div>
<div id="get-the-course-materials" class="section level2">
<h2>Get the Course Materials</h2>
<p>The course material and exercises are in the form of Earth Engine scripts shared via a code repository.</p>
<ol style="list-style-type: decimal">
<li><a href="https://code.earthengine.google.co.in/?accept_repo=users/ujavalgandhi/GEE-Water-Resources-Management">Click this link</a> to open Google Earth Engine code editor and add the repository to your account.</li>
<li>If successful, you will have a new repository named <code>users/ujavalgandhi/GEE-Water-Resources-Management</code> in the <em>Scripts</em> tab in the <em>Reader</em> section.</li>
<li>Verify that your code editor looks like below</li>
</ol>
<blockquote>
<p>If you do not see the repository in the <em>Reader</em> section, refresh your browser tab and it will show up.</p>
</blockquote>
<div class="figure" style="text-align: center">
<img src="images/gee_water_resources_management/repository.png" alt="Code Editor After Adding the Class Repository" width="100%" />
<p class="caption">
Code Editor After Adding the Class Repository
</p>
</div>
<div style="page-break-after: always;"></div>
</div>
</div>
<div id="module-1-google-earth-engine-fundamentals" class="section level1">
<h1>Module 1: Google Earth Engine Fundamentals</h1>
<p>In Module 1, you will gain the essential skills to find datasets, filter them to your region, clip them to your boundary, calculate remote sensing indices, extract water-bodies using binary thresholding, and export raster data.</p>
<div id="hello-world" class="section level2">
<h2>01. Hello World</h2>
<p>This script introduces the basic Javascript syntax and the video covers the programming concepts you need to learn when using Earth Engine. To learn more, visit <a href="https://developers.google.com/earth-engine/tutorials/tutorial_js_01">Introduction to JavaScript for Earth Engine</a> section of the Earth Engine User Guide.</p>
<p><a href="https://www.youtube.com/watch?v=RV3Sv5iogHs" target="_blank"><img src="images/gee_water_resources_management/intro_to_javascript.png" width="400" alt="Video" /></a></p>
<ul>
<li><a href="https://www.youtube.com/watch?v=RV3Sv5iogHs" target="_blank">Watch the Video</a></li>
</ul>
<p>The <em>Code Editor</em> is an Integrated Development Environment (IDE) for Earth Engine Javascript API. It offers an easy way to type, debug, run and manage code. Type the code below and click <em>Run</em> to execute it and see the output in the <em>Console</em> tab.</p>
<blockquote>
<p>Tip: You can use the keyboard shortcut <em>Ctrl+Enter</em> to run the code in the Code Editor</p>
</blockquote>
<div class="figure" style="text-align: center">
<img src="images/gee_water_resources_management/hello_world.png" alt="Hello World" width="100%" />
<p class="caption">
Hello World
</p>
</div>
<div class="sourceCode" id="cb1"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="st">&#39;Hello World&#39;</span>)<span class="op">;</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="co">// Variables</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> city <span class="op">=</span> <span class="st">&#39;Bengaluru&#39;</span><span class="op">;</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> country <span class="op">=</span> <span class="st">&#39;India&#39;</span><span class="op">;</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(city<span class="op">,</span> country)<span class="op">;</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> population <span class="op">=</span> <span class="dv">8400000</span><span class="op">;</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(population)<span class="op">;</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="co">// List</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> majorCities <span class="op">=</span> [<span class="st">&#39;Mumbai&#39;</span><span class="op">,</span> <span class="st">&#39;Delhi&#39;</span><span class="op">,</span> <span class="st">&#39;Chennai&#39;</span><span class="op">,</span> <span class="st">&#39;Kolkata&#39;</span>]<span class="op">;</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(majorCities)<span class="op">;</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="co">// Dictionary</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> cityData <span class="op">=</span> {</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>  <span class="st">&#39;city&#39;</span><span class="op">:</span> city<span class="op">,</span></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>  <span class="st">&#39;population&#39;</span><span class="op">:</span> <span class="dv">8400000</span><span class="op">,</span></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>  <span class="st">&#39;elevation&#39;</span><span class="op">:</span> <span class="dv">930</span></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(cityData)<span class="op">;</span></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a><span class="co">// Function</span></span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> greet <span class="op">=</span> <span class="kw">function</span>(name) {</span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="st">&#39;Hello &#39;</span> <span class="op">+</span> name<span class="op">;</span></span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">greet</span>(<span class="st">&#39;World&#39;</span>))<span class="op">;</span></span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a><span class="co">// This is a comment</span></span></code></pre></div>
<p><a href="https://code.earthengine.google.co.in/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3A01-Earth_Engine_Basics%2F01b_Hello_World_(complete)" target="_blank">Open in Code Editor ↗</a></p>
<div id="exercise" class="section level3">
<h3>Exercise</h3>
<div class="sourceCode" id="cb2"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co">// These are the 5 largest cities in the world: </span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="co">// Tokyo, Delhi, Shanghai, Mexico City, Sao Paulo</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="co">// Create a list named &#39;largeCities&#39;</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="co">// The list should have names of all the above cities</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="co">// Print the list </span></span></code></pre></div>
<p><a href="https://code.earthengine.google.co.in/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3A01-Earth_Engine_Basics%2F01c_Hello_World_(exercise)" target="_blank">Try in Code Editor ↗</a></p>
</div>
<div id="saving-your-work" class="section level3">
<h3>Saving Your Work</h3>
<p>When you modify any script for the course repository, you may want to save a copy for yourself. If you try to click the <em>Save</em> button, you will get an error message like below</p>
<p><img src="images/gee_water_resources_management/setup1.png" width="100%" style="display: block; margin: auto;" /></p>
<p>This is because the shared class repository is a <em>Read-only</em> repository. You can click <em>Yes</em> to save a copy in your repository. If this is the first time you are using Earth Engine, you will be prompted to choose the name of your <em>home folder</em>. Choose the name carefully, as it cannot be changed once created.</p>
<p><img src="images/gee_water_resources_management/setup2.png" width="60%" style="display: block; margin: auto;" /></p>
</div>
</div>
<div id="working-with-image-collections" class="section level2">
<h2>02. Working with Image Collections</h2>
<p>Most datasets in Earth Engine come as a <code>ImageCollection</code>. An ImageCollection is a dataset that consists of images takes at different time and locations - usually from the same satellite or data provider. You can load a collection by searching the <a href="https://developers.google.com/earth-engine/datasets">Earth Engine Data Catalog</a> for the <em>ImageCollection ID</em>. Search for the <em>Sentinel-2 Level 2A</em> dataset and you will find its id <code>COPERNICUS/S2_SR</code>. Visit the <a href="https://developers.google.com/earth-engine/datasets/catalog/COPERNICUS_S2_SR">Sentinel-2, Level 2A page</a> and see <em>Explore in Earth Engine</em> section to find the code snippet to load and visualize the collection. This snippet is a great starting point for your work with this dataset. Click the <strong>Copy Code Sample</strong> button and paste the code into the code editor. Click <em>Run</em> and you will see the image tiles load in the map.</p>
<p><img src="images/gee_water_resources_management/image_collection1.png" width="100%" style="display: block; margin: auto;" /></p>
<p>In the code snippet, You will see a function <code>Map.setCenter()</code> which sets the viewport to a specific location and zoom level. The function takes the X coordinate (longitude), Y coordinate (latitude) and Zoom Level parameters ranging from 1 (whole world) to 22 (pixel level). Replace the X and Y coordinates with the coordinates of your city and click <em>Run</em> to see the images of your city.</p>
<p><img src="images/gee_water_resources_management/image_collection2.png" width="100%" style="display: block; margin: auto;" /></p>
<div class="sourceCode" id="cb3"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co">/**</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="co"> * Function to mask clouds using the Sentinel-2 QA band</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span><span class="an">@param</span><span class="co"> </span><span class="cv">{ee.Image}</span><span class="co"> image Sentinel-2 image</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span><span class="an">@return</span><span class="co"> {ee.Image} cloud masked Sentinel-2 image</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">maskS2clouds</span>(image) {</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> qa <span class="op">=</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;QA60&#39;</span>)<span class="op">;</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Bits 10 and 11 are clouds and cirrus, respectively.</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> cloudBitMask <span class="op">=</span> <span class="dv">1</span> <span class="op">&lt;&lt;</span> <span class="dv">10</span><span class="op">;</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> cirrusBitMask <span class="op">=</span> <span class="dv">1</span> <span class="op">&lt;&lt;</span> <span class="dv">11</span><span class="op">;</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Both flags should be set to zero, indicating clear conditions.</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> mask <span class="op">=</span> qa<span class="op">.</span><span class="fu">bitwiseAnd</span>(cloudBitMask)<span class="op">.</span><span class="fu">eq</span>(<span class="dv">0</span>)</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">and</span>(qa<span class="op">.</span><span class="fu">bitwiseAnd</span>(cirrusBitMask)<span class="op">.</span><span class="fu">eq</span>(<span class="dv">0</span>))<span class="op">;</span></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> image<span class="op">.</span><span class="fu">updateMask</span>(mask)<span class="op">.</span><span class="fu">divide</span>(<span class="dv">10000</span>)<span class="op">;</span></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> dataset <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&#39;COPERNICUS/S2_SR&#39;</span>)</span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>                  <span class="op">.</span><span class="fu">filterDate</span>(<span class="st">&#39;2020-01-01&#39;</span><span class="op">,</span> <span class="st">&#39;2020-01-30&#39;</span>)</span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>                  <span class="co">// Pre-filter to get less cloudy granules.</span></span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>                  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">lt</span>(<span class="st">&#39;CLOUDY_PIXEL_PERCENTAGE&#39;</span><span class="op">,</span><span class="dv">20</span>))</span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>                  <span class="op">.</span><span class="fu">map</span>(maskS2clouds)<span class="op">;</span></span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> visualization <span class="op">=</span> {</span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a>  <span class="dt">min</span><span class="op">:</span> <span class="fl">0.0</span><span class="op">,</span></span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a>  <span class="dt">max</span><span class="op">:</span> <span class="fl">0.3</span><span class="op">,</span></span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a>  <span class="dt">bands</span><span class="op">:</span> [<span class="st">&#39;B4&#39;</span><span class="op">,</span> <span class="st">&#39;B3&#39;</span><span class="op">,</span> <span class="st">&#39;B2&#39;</span>]<span class="op">,</span></span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">setCenter</span>(<span class="fl">77.5925</span><span class="op">,</span> <span class="fl">12.9407</span><span class="op">,</span> <span class="dv">12</span>)<span class="op">;</span></span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-34"><a href="#cb3-34" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(dataset<span class="op">.</span><span class="fu">mean</span>()<span class="op">,</span> visualization<span class="op">,</span> <span class="st">&#39;RGB&#39;</span>)<span class="op">;</span></span></code></pre></div>
<p><a href="https://code.earthengine.google.co.in/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3A01-Earth_Engine_Basics%2F02b_Image_Collections_(complete)" target="_blank">Open in Code Editor ↗</a></p>
<div id="exercise-1" class="section level3">
<h3>Exercise</h3>
<div class="sourceCode" id="cb4"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co">/**</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="co"> * Function to mask clouds using the Sentinel-2 QA band</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span><span class="an">@param</span><span class="co"> </span><span class="cv">{ee.Image}</span><span class="co"> image Sentinel-2 image</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="co"> * </span><span class="an">@return</span><span class="co"> {ee.Image} cloud masked Sentinel-2 image</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">maskS2clouds</span>(image) {</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> qa <span class="op">=</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;QA60&#39;</span>)<span class="op">;</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Bits 10 and 11 are clouds and cirrus, respectively.</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> cloudBitMask <span class="op">=</span> <span class="dv">1</span> <span class="op">&lt;&lt;</span> <span class="dv">10</span><span class="op">;</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> cirrusBitMask <span class="op">=</span> <span class="dv">1</span> <span class="op">&lt;&lt;</span> <span class="dv">11</span><span class="op">;</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Both flags should be set to zero, indicating clear conditions.</span></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> mask <span class="op">=</span> qa<span class="op">.</span><span class="fu">bitwiseAnd</span>(cloudBitMask)<span class="op">.</span><span class="fu">eq</span>(<span class="dv">0</span>)</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">and</span>(qa<span class="op">.</span><span class="fu">bitwiseAnd</span>(cirrusBitMask)<span class="op">.</span><span class="fu">eq</span>(<span class="dv">0</span>))<span class="op">;</span></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> image<span class="op">.</span><span class="fu">updateMask</span>(mask)<span class="op">.</span><span class="fu">divide</span>(<span class="dv">10000</span>)<span class="op">;</span></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> dataset <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&#39;COPERNICUS/S2_SR&#39;</span>)</span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>                  <span class="op">.</span><span class="fu">filterDate</span>(<span class="st">&#39;2020-01-01&#39;</span><span class="op">,</span> <span class="st">&#39;2020-01-30&#39;</span>)</span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>                  <span class="co">// Pre-filter to get less cloudy granules.</span></span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>                  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">lt</span>(<span class="st">&#39;CLOUDY_PIXEL_PERCENTAGE&#39;</span><span class="op">,</span><span class="dv">20</span>))</span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>                  <span class="op">.</span><span class="fu">map</span>(maskS2clouds)<span class="op">;</span></span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> visualization <span class="op">=</span> {</span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a>  <span class="dt">min</span><span class="op">:</span> <span class="fl">0.0</span><span class="op">,</span></span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a>  <span class="dt">max</span><span class="op">:</span> <span class="fl">0.3</span><span class="op">,</span></span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a>  <span class="dt">bands</span><span class="op">:</span> [<span class="st">&#39;B4&#39;</span><span class="op">,</span> <span class="st">&#39;B3&#39;</span><span class="op">,</span> <span class="st">&#39;B2&#39;</span>]<span class="op">,</span></span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">setCenter</span>(<span class="fl">77.5925</span><span class="op">,</span> <span class="fl">12.9407</span><span class="op">,</span> <span class="dv">12</span>)<span class="op">;</span></span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-34"><a href="#cb4-34" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(dataset<span class="op">.</span><span class="fu">mean</span>()<span class="op">,</span> visualization<span class="op">,</span> <span class="st">&#39;RGB&#39;</span>)<span class="op">;</span></span></code></pre></div>
<p><a href="https://code.earthengine.google.co.in/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3A01-Earth_Engine_Basics%2F02c_Image_Collections_(exercise)" target="_blank">Try in Code Editor ↗</a></p>
</div>
</div>
<div id="filtering-image-collections" class="section level2">
<h2>03. Filtering Image Collections</h2>
<p>The collection contains all imagery ever collected by the sensor. The entire collections are not very useful. Most applications require a subset of the images. We use <strong>filters</strong> to select the appropriate images. There are many types of filter functions, look at <code>ee.Filter...</code> module to see all available filters. Select a filter and then run the <code>filter()</code> function with the filter parameters.</p>
<p>We will learn about 3 main types of filtering techniques</p>
<ul>
<li><strong>Filter by metadata</strong>: You can apply a filter on the image metadata using filters such as <code>ee.Filter.eq()</code>, <code>ee.Filter.lt()</code> etc. You can filter by PATH/ROW values, Orbit number, Cloud cover etc.</li>
<li><strong>Filter by date</strong>: You can select images in a particular date range using filters such as <code>ee.Filter.date()</code>.</li>
<li><strong>Filter by location</strong>: You can select the subset of images with a bounding box, location or geometry using the <code>ee.Filter.bounds()</code>. You can also use the drawing tools to draw a geometry for filtering.</li>
</ul>
<p>After applying the filters, you can use the <code>.size()</code> function to check how many images match the filter criteria.</p>
<p><img src="images/gee_water_resources_management/filters.png" width="100%" style="display: block; margin: auto;" /></p>
<div class="sourceCode" id="cb5"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> geometry <span class="op">=</span> ee<span class="op">.</span><span class="at">Geometry</span><span class="op">.</span><span class="fu">Point</span>([<span class="fl">77.60412933051538</span><span class="op">,</span> <span class="fl">12.952912912328241</span>])</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">centerObject</span>(geometry<span class="op">,</span> <span class="dv">10</span>)</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> s2 <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&quot;COPERNICUS/S2_SR&quot;</span>)<span class="op">;</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a><span class="co">// Filter by metadata</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> filtered <span class="op">=</span> s2<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">lt</span>(<span class="st">&#39;CLOUDY_PIXEL_PERCENTAGE&#39;</span><span class="op">,</span> <span class="dv">30</span>))</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a><span class="co">// Filter by date</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> filtered <span class="op">=</span> s2<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(<span class="st">&#39;2019-01-01&#39;</span><span class="op">,</span> <span class="st">&#39;2020-01-01&#39;</span>))</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a><span class="co">// Filter by location</span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> filtered <span class="op">=</span> s2<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">bounds</span>(geometry))</span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a><span class="co">// Let&#39;s apply all the 3 filters together on the collection</span></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a><span class="co">// First apply metadata fileter</span></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> filtered1 <span class="op">=</span> s2<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">lt</span>(<span class="st">&#39;CLOUDY_PIXEL_PERCENTAGE&#39;</span><span class="op">,</span> <span class="dv">30</span>))</span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a><span class="co">// Apply date filter on the results</span></span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> filtered2 <span class="op">=</span> filtered1<span class="op">.</span><span class="fu">filter</span>(</span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>  ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(<span class="st">&#39;2019-01-01&#39;</span><span class="op">,</span> <span class="st">&#39;2020-01-01&#39;</span>))</span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a><span class="co">// Lastly apply the location filter</span></span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> filtered3 <span class="op">=</span> filtered2<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">bounds</span>(geometry))</span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a><span class="co">// Instead of applying filters one after the other, we can &#39;chain&#39; them</span></span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a><span class="co">// Use the . notation to apply all the filters together</span></span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> filtered <span class="op">=</span> s2<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">lt</span>(<span class="st">&#39;CLOUDY_PIXEL_PERCENTAGE&#39;</span><span class="op">,</span> <span class="dv">30</span>))</span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(<span class="st">&#39;2019-01-01&#39;</span><span class="op">,</span> <span class="st">&#39;2020-01-01&#39;</span>))</span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">bounds</span>(geometry))</span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(filtered<span class="op">.</span><span class="fu">size</span>())</span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-33"><a href="#cb5-33" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> rgbVis <span class="op">=</span> {</span>
<span id="cb5-34"><a href="#cb5-34" aria-hidden="true" tabindex="-1"></a>  <span class="dt">min</span><span class="op">:</span> <span class="fl">0.0</span><span class="op">,</span></span>
<span id="cb5-35"><a href="#cb5-35" aria-hidden="true" tabindex="-1"></a>  <span class="dt">max</span><span class="op">:</span> <span class="dv">3000</span><span class="op">,</span></span>
<span id="cb5-36"><a href="#cb5-36" aria-hidden="true" tabindex="-1"></a>  <span class="dt">bands</span><span class="op">:</span> [<span class="st">&#39;B4&#39;</span><span class="op">,</span> <span class="st">&#39;B3&#39;</span><span class="op">,</span> <span class="st">&#39;B2&#39;</span>]<span class="op">,</span></span>
<span id="cb5-37"><a href="#cb5-37" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb5-38"><a href="#cb5-38" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(filtered<span class="op">,</span> rgbVis<span class="op">,</span> <span class="st">&#39;Filtered&#39;</span>) </span></code></pre></div>
<p><a href="https://code.earthengine.google.co.in/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3A01-Earth_Engine_Basics%2F03b_Filtering_Image_Collection_(complete)" target="_blank">Open in Code Editor ↗</a></p>
<div id="exercise-2" class="section level3">
<h3>Exercise</h3>
<div class="sourceCode" id="cb6"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Add one more filter in the script below to select images</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="co">// from only one of the satellites - Sentinel-2A - from the</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="co">// Sentinel-2 constellation</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="co">// Hint1: Use the &#39;SPACECRAFT_NAME&#39; property</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="co">// Hint2: Use the ee.Filter.eq() filter</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> geometry <span class="op">=</span> ee<span class="op">.</span><span class="at">Geometry</span><span class="op">.</span><span class="fu">Point</span>([<span class="fl">77.60412933051538</span><span class="op">,</span> <span class="fl">12.952912912328241</span>])</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">centerObject</span>(geometry<span class="op">,</span> <span class="dv">10</span>)</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> s2 <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&quot;COPERNICUS/S2_SR&quot;</span>)<span class="op">;</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> filtered <span class="op">=</span> s2<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">lt</span>(<span class="st">&#39;CLOUDY_PIXEL_PERCENTAGE&#39;</span><span class="op">,</span> <span class="dv">30</span>))</span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(<span class="st">&#39;2019-01-01&#39;</span><span class="op">,</span> <span class="st">&#39;2020-01-01&#39;</span>))</span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">bounds</span>(geometry))</span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(filtered<span class="op">.</span><span class="fu">size</span>())</span></code></pre></div>
<p><a href="https://code.earthengine.google.co.in/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3A01-Earth_Engine_Basics%2F03c_Filtering_Image_Collection_(exercise)" target="_blank">Try in Code Editor ↗</a></p>
</div>
</div>
<div id="mosaics-and-composites" class="section level2">
<h2>04. Mosaics and Composites</h2>
<p>The default order of the collection is by date. So when you display the collection, it implicitly creates a mosaic with the latest pixels on top. You can call <code>.mosaic()</code> on a ImageCollection to create a mosaic image from the pixels at the top (i.e) first image in the stack.</p>
<p>We can also create a composite image by applying selection criteria to each pixel from all pixels in the stack. Here we use the <code>.median()</code> function to create a composite where each pixel value is the median of all pixels values at each pixel from the stack for all matching bands.</p>
<blockquote>
<p>Tip: If you need to create a mosaic where the images are in a specific order, you can use the <code>.sort()</code> function to sort your collection by a property first.</p>
</blockquote>
<div class="figure" style="text-align: center">
<img src="images/gee_water_resources_management/mosaic_median.png" alt="Mosaic vs. Median Composite" width="100%" />
<p class="caption">
Mosaic vs. Median Composite
</p>
</div>
<div class="sourceCode" id="cb7"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> geometry <span class="op">=</span> ee<span class="op">.</span><span class="at">Geometry</span><span class="op">.</span><span class="fu">Point</span>([<span class="fl">77.60412933051538</span><span class="op">,</span> <span class="fl">12.952912912328241</span>])</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> s2 <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&quot;COPERNICUS/S2_SR&quot;</span>)<span class="op">;</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> rgbVis <span class="op">=</span> {</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">min</span><span class="op">:</span> <span class="fl">0.0</span><span class="op">,</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>  <span class="dt">max</span><span class="op">:</span> <span class="dv">3000</span><span class="op">,</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>  <span class="dt">bands</span><span class="op">:</span> [<span class="st">&#39;B4&#39;</span><span class="op">,</span> <span class="st">&#39;B3&#39;</span><span class="op">,</span> <span class="st">&#39;B2&#39;</span>]<span class="op">,</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> filtered <span class="op">=</span> s2<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">lt</span>(<span class="st">&#39;CLOUDY_PIXEL_PERCENTAGE&#39;</span><span class="op">,</span> <span class="dv">30</span>))</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(<span class="st">&#39;2019-01-01&#39;</span><span class="op">,</span> <span class="st">&#39;2020-01-01&#39;</span>))</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">bounds</span>(geometry))</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> mosaic <span class="op">=</span> filtered<span class="op">.</span><span class="fu">mosaic</span>() </span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> medianComposite <span class="op">=</span> filtered<span class="op">.</span><span class="fu">median</span>()<span class="op">;</span></span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">centerObject</span>(geometry<span class="op">,</span> <span class="dv">10</span>)</span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(filtered<span class="op">,</span> rgbVis<span class="op">,</span> <span class="st">&#39;Filtered Collection&#39;</span>)<span class="op">;</span></span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(mosaic<span class="op">,</span> rgbVis<span class="op">,</span> <span class="st">&#39;Mosaic&#39;</span>)<span class="op">;</span></span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(medianComposite<span class="op">,</span> rgbVis<span class="op">,</span> <span class="st">&#39;Median Composite&#39;</span>)</span></code></pre></div>
<p><a href="https://code.earthengine.google.co.in/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3A01-Earth_Engine_Basics%2F04b_Mosaics_and_Composites_(complete)" target="_blank">Open in Code Editor ↗</a></p>
<div id="exercise-3" class="section level3">
<h3>Exercise</h3>
<div class="sourceCode" id="cb8"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Create a median composite for the year 2020 and load it to the map</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="co">// Compare both the composites to see the changes in your city</span></span></code></pre></div>
<p><a href="https://code.earthengine.google.co.in/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3A01-Earth_Engine_Basics%2F04c_Mosaics_and_Composites_(exercise)" target="_blank">Try in Code Editor ↗</a></p>
</div>
</div>
<div id="feature-collection" class="section level2">
<h2>05. Feature Collection</h2>
<p>Feature Collections are similar to Image Collections - but they contain <em>Features</em>, not images. They are equivalent to Vector Layers in a GIS. We can load, filter and display Feature Collections using similar techniques that we have learned so far.</p>
<p>Search for <em>GAUL Second Level Administrative Boundaries</em> and load the collection. This is a global collection that contains all Admin2 boundaries. We can apply a filter using the <code>ADM1_NAME</code> property to get all Admin2 boundaries (i.e. Districts) from a state.</p>
<p><img src="images/gee_water_resources_management/feature_collection.png" width="100%" style="display: block; margin: auto;" /></p>
<div class="sourceCode" id="cb9"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> admin2 <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">&quot;FAO/GAUL_SIMPLIFIED_500m/2015/level2&quot;</span>)<span class="op">;</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> karnataka <span class="op">=</span> admin2<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;ADM1_NAME&#39;</span><span class="op">,</span> <span class="st">&#39;Karnataka&#39;</span>))</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> visParams <span class="op">=</span> {<span class="st">&#39;color&#39;</span><span class="op">:</span> <span class="st">&#39;red&#39;</span>}</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(karnataka<span class="op">,</span> visParams<span class="op">,</span> <span class="st">&#39;Karnataka Districts&#39;</span>)</span></code></pre></div>
<p><a href="https://code.earthengine.google.co.in/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3A01-Earth_Engine_Basics%2F05b_Feature_Collections_(complete)" target="_blank">Open in Code Editor ↗</a></p>
<div id="exercise-4" class="section level3">
<h3>Exercise</h3>
<div class="sourceCode" id="cb10"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Add the admin2 layer to the map using Map.addLayer() function</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="co">// Go to your home city and inspect the layer to find the name of the region</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="co">// Use the ADM2_NAME property and apply a filter</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="co">// Display only the selected polygon on the map.</span></span></code></pre></div>
<p><a href="https://code.earthengine.google.com/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3A01-Earth_Engine_Basics%2F05c_Feature_Collections_(exercise)" target="_blank">Try in Code Editor ↗</a></p>
</div>
</div>
<div id="clipping" class="section level2">
<h2>06. Clipping</h2>
<p>It is often desirable to clip the images to your area of interest. You can use the <code>clip()</code> function to mask an image using geometry.</p>
<blockquote>
<p>While in Desktop softwares, clipping is used to remove the unnecessary portion of a large image to save computation time, but in the Earth Engine, clipping can <span style="color:red">increase the computation time.</span> As described in the <a href="https://developers.google.com/earth-engine/guides/best_practices?hl=en#if-you-dont-need-to-clip,-dont-use-clip">Earth Engine Coding Best Practices</a> guide, avoid clipping or do it at the very end of your process.</p>
</blockquote>
<div class="figure" style="text-align: center">
<img src="images/gee_water_resources_management/clipping.png" alt="Full Image vs. Clipped Image" width="100%" />
<p class="caption">
Full Image vs. Clipped Image
</p>
</div>
<div class="sourceCode" id="cb11"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> admin2 <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">&quot;FAO/GAUL_SIMPLIFIED_500m/2015/level2&quot;</span>)<span class="op">;</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> s2 <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&quot;COPERNICUS/S2_SR&quot;</span>)<span class="op">;</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> selected <span class="op">=</span> admin2<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;ADM2_NAME&#39;</span><span class="op">,</span> <span class="st">&#39;Bangalore Urban&#39;</span>))</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> geometry <span class="op">=</span> selected<span class="op">.</span><span class="fu">geometry</span>()</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">centerObject</span>(geometry)</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> rgbVis <span class="op">=</span> {</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>  <span class="dt">min</span><span class="op">:</span> <span class="fl">0.0</span><span class="op">,</span></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>  <span class="dt">max</span><span class="op">:</span> <span class="dv">3000</span><span class="op">,</span></span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>  <span class="dt">bands</span><span class="op">:</span> [<span class="st">&#39;B4&#39;</span><span class="op">,</span> <span class="st">&#39;B3&#39;</span><span class="op">,</span> <span class="st">&#39;B2&#39;</span>]<span class="op">,</span> </span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> filtered <span class="op">=</span> s2<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">lt</span>(<span class="st">&#39;CLOUDY_PIXEL_PERCENTAGE&#39;</span><span class="op">,</span> <span class="dv">30</span>))</span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(<span class="st">&#39;2019-01-01&#39;</span><span class="op">,</span> <span class="st">&#39;2020-01-01&#39;</span>))</span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">bounds</span>(geometry))</span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> image <span class="op">=</span> filtered<span class="op">.</span><span class="fu">median</span>()<span class="op">;</span></span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> clipped <span class="op">=</span> image<span class="op">.</span><span class="fu">clip</span>(geometry)</span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(clipped<span class="op">,</span> rgbVis<span class="op">,</span> <span class="st">&#39;Clipped&#39;</span>)</span></code></pre></div>
<p><a href="https://code.earthengine.google.co.in/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3A01-Earth_Engine_Basics%2F06b_Clipping_(complete)" target="_blank">Open in Code Editor ↗</a></p>
<div id="exercise-5" class="section level3">
<h3>Exercise</h3>
<div class="sourceCode" id="cb12"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Add the GAUL admin boundary to the Map</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="co">// Search for your city and inspect the ADM2_NAME</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="co">// Replace the name with the ADM2_NAME of your selected region</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="co">// And display the clipped composite on the map.</span></span></code></pre></div>
<p><a href="https://code.earthengine.google.co.in/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3A01-Earth_Engine_Basics%2F06c_Clipping_(exercise)" target="_blank">Try in Code Editor ↗</a></p>
</div>
</div>
<div id="calculating-indices" class="section level2">
<h2>07. Calculating Indices</h2>
<p>Spectral Indices are central to many aspects of remote sensing. For almost all research/work, you will need to compute a pixel-wise ratio of 2 or more bands. The most commonly used formula for calculating an index is computing the <em>Normalized Difference</em> between 2 bands. Earth Engine provides a helper function <code>normalizedDifference()</code> to help calculate normalized indices, such as Modified Normalized Difference Water Index (MNDWI).</p>
<p>For more complex formulae such as Automated Water Extraction Index (AWEI), you can use the <code>expression()</code> function to describe the calculation. AWEI is a moden technique to do surface water mapping with high accuracy. <a href="https://www.sciencedirect.com/science/article/abs/pii/S0034425713002873">Learn more about AWEI</a></p>
<div class="figure" style="text-align: center">
<img src="images/gee_water_resources_management/indices.png" alt="RGB, MNDWI, NDVI and AWEI images" width="100%" />
<p class="caption">
RGB, MNDWI, NDVI and AWEI images
</p>
</div>
<div class="sourceCode" id="cb13"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> admin2 <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">&quot;FAO/GAUL_SIMPLIFIED_500m/2015/level2&quot;</span>)<span class="op">;</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> s2 <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&quot;COPERNICUS/S2_SR&quot;</span>)<span class="op">;</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> selected <span class="op">=</span> admin2<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;ADM2_NAME&#39;</span><span class="op">,</span> <span class="st">&#39;Bangalore Urban&#39;</span>))</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> geometry <span class="op">=</span> selected<span class="op">.</span><span class="fu">geometry</span>()</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> filtered <span class="op">=</span> s2<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">lt</span>(<span class="st">&#39;CLOUDY_PIXEL_PERCENTAGE&#39;</span><span class="op">,</span> <span class="dv">30</span>))</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(<span class="st">&#39;2019-01-01&#39;</span><span class="op">,</span> <span class="st">&#39;2020-01-01&#39;</span>))</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">bounds</span>(geometry))</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> image <span class="op">=</span> filtered<span class="op">.</span><span class="fu">median</span>()<span class="op">.</span><span class="fu">clip</span>(geometry)<span class="op">;</span> </span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a><span class="co">// Calculate  Normalized Difference Vegetation Index (NDVI)</span></span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a><span class="co">// &#39;NIR&#39; (B8) and &#39;RED&#39; (B4)</span></span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> ndvi <span class="op">=</span> image<span class="op">.</span><span class="fu">normalizedDifference</span>([<span class="st">&#39;B8&#39;</span><span class="op">,</span> <span class="st">&#39;B4&#39;</span>])<span class="op">.</span><span class="fu">rename</span>([<span class="st">&#39;ndvi&#39;</span>])<span class="op">;</span></span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a><span class="co">// Calculate Modified Normalized Difference Water Index (MNDWI)</span></span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a><span class="co">// &#39;GREEN&#39; (B3) and &#39;SWIR1&#39; (B11)</span></span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> mndwi <span class="op">=</span> image<span class="op">.</span><span class="fu">normalizedDifference</span>([<span class="st">&#39;B3&#39;</span><span class="op">,</span> <span class="st">&#39;B11&#39;</span>])<span class="op">.</span><span class="fu">rename</span>([<span class="st">&#39;mndwi&#39;</span>])<span class="op">;</span> </span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a><span class="co">// Calculate Automated Water Extraction Index (AWEI)</span></span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a><span class="co">// AWEI is a Multi-band Index that uses the following bands</span></span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a><span class="co">// &#39;BLUE&#39; (B2), GREEN&#39; (B3), &#39;NIR&#39; (B8), &#39;SWIR1&#39; (B11) and &#39;SWIR2&#39; (B12)</span></span>
<span id="cb13-25"><a href="#cb13-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-26"><a href="#cb13-26" aria-hidden="true" tabindex="-1"></a><span class="co">// Formula for AWEI is as follows</span></span>
<span id="cb13-27"><a href="#cb13-27" aria-hidden="true" tabindex="-1"></a><span class="co">// AWEI = 4 * (GREEN - SWIR2) - (0.25 * NIR + 2.75 * SWIR1)</span></span>
<span id="cb13-28"><a href="#cb13-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-29"><a href="#cb13-29" aria-hidden="true" tabindex="-1"></a><span class="co">// For more complex indices, you can use the expression() function</span></span>
<span id="cb13-30"><a href="#cb13-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-31"><a href="#cb13-31" aria-hidden="true" tabindex="-1"></a><span class="co">// Note: </span></span>
<span id="cb13-32"><a href="#cb13-32" aria-hidden="true" tabindex="-1"></a><span class="co">// For the AWEI formula, the pixel values need to converted to reflectances</span></span>
<span id="cb13-33"><a href="#cb13-33" aria-hidden="true" tabindex="-1"></a><span class="co">// Multiplyng the pixel values by &#39;scale&#39; gives us the reflectance value</span></span>
<span id="cb13-34"><a href="#cb13-34" aria-hidden="true" tabindex="-1"></a><span class="co">// The scale value is 0.0001 for Sentinel-2 dataset</span></span>
<span id="cb13-35"><a href="#cb13-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-36"><a href="#cb13-36" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> awei <span class="op">=</span> image<span class="op">.</span><span class="fu">expression</span>(</span>
<span id="cb13-37"><a href="#cb13-37" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;4*(GREEN - SWIR1) - (0.25*NIR + 2.75*SWIR2)&#39;</span><span class="op">,</span> {</span>
<span id="cb13-38"><a href="#cb13-38" aria-hidden="true" tabindex="-1"></a>      <span class="st">&#39;GREEN&#39;</span><span class="op">:</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;B3&#39;</span>)<span class="op">.</span><span class="fu">multiply</span>(<span class="fl">0.0001</span>)<span class="op">,</span></span>
<span id="cb13-39"><a href="#cb13-39" aria-hidden="true" tabindex="-1"></a>      <span class="st">&#39;NIR&#39;</span><span class="op">:</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;B8&#39;</span>)<span class="op">.</span><span class="fu">multiply</span>(<span class="fl">0.0001</span>)<span class="op">,</span></span>
<span id="cb13-40"><a href="#cb13-40" aria-hidden="true" tabindex="-1"></a>      <span class="st">&#39;SWIR1&#39;</span><span class="op">:</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;B11&#39;</span>)<span class="op">.</span><span class="fu">multiply</span>(<span class="fl">0.0001</span>)<span class="op">,</span></span>
<span id="cb13-41"><a href="#cb13-41" aria-hidden="true" tabindex="-1"></a>      <span class="st">&#39;SWIR2&#39;</span><span class="op">:</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;B12&#39;</span>)<span class="op">.</span><span class="fu">multiply</span>(<span class="fl">0.0001</span>)<span class="op">,</span></span>
<span id="cb13-42"><a href="#cb13-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-43"><a href="#cb13-43" aria-hidden="true" tabindex="-1"></a>})<span class="op">.</span><span class="fu">rename</span>(<span class="st">&#39;awei&#39;</span>)<span class="op">;</span></span>
<span id="cb13-44"><a href="#cb13-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-45"><a href="#cb13-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-46"><a href="#cb13-46" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> rgbVis <span class="op">=</span> {<span class="dt">min</span><span class="op">:</span> <span class="fl">0.0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span> <span class="dv">3000</span><span class="op">,</span> <span class="dt">bands</span><span class="op">:</span> [<span class="st">&#39;B4&#39;</span><span class="op">,</span> <span class="st">&#39;B3&#39;</span><span class="op">,</span> <span class="st">&#39;B2&#39;</span>]}<span class="op">;</span></span>
<span id="cb13-47"><a href="#cb13-47" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> ndviVis <span class="op">=</span> {<span class="dt">min</span><span class="op">:</span><span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span><span class="dv">1</span><span class="op">,</span> <span class="dt">palette</span><span class="op">:</span> [<span class="st">&#39;white&#39;</span><span class="op">,</span> <span class="st">&#39;green&#39;</span>]}</span>
<span id="cb13-48"><a href="#cb13-48" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> ndwiVis <span class="op">=</span> {<span class="dt">min</span><span class="op">:</span><span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span><span class="fl">0.5</span><span class="op">,</span> <span class="dt">palette</span><span class="op">:</span> [<span class="st">&#39;white&#39;</span><span class="op">,</span> <span class="st">&#39;blue&#39;</span>]}</span>
<span id="cb13-49"><a href="#cb13-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-50"><a href="#cb13-50" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">centerObject</span>(geometry<span class="op">,</span> <span class="dv">10</span>)</span>
<span id="cb13-51"><a href="#cb13-51" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(image<span class="op">,</span> rgbVis<span class="op">,</span> <span class="st">&#39;Image&#39;</span>)<span class="op">;</span></span>
<span id="cb13-52"><a href="#cb13-52" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(ndvi<span class="op">,</span> ndviVis<span class="op">,</span> <span class="st">&#39;ndvi&#39;</span>)</span>
<span id="cb13-53"><a href="#cb13-53" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(mndwi<span class="op">,</span> ndwiVis<span class="op">,</span> <span class="st">&#39;mndwi&#39;</span>)</span>
<span id="cb13-54"><a href="#cb13-54" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(awei<span class="op">,</span> ndwiVis<span class="op">,</span> <span class="st">&#39;awei&#39;</span>) </span></code></pre></div>
<p><a href="https://code.earthengine.google.co.in/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3A01-Earth_Engine_Basics%2F07b_Calculating_Indices_(complete)" target="_blank">Open in Code Editor ↗</a></p>
<div id="exercise-6" class="section level3">
<h3>Exercise</h3>
<div class="sourceCode" id="cb14"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> admin2 <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">&quot;FAO/GAUL_SIMPLIFIED_500m/2015/level2&quot;</span>)<span class="op">;</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> s2 <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&quot;COPERNICUS/S2_SR&quot;</span>)<span class="op">;</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> selected <span class="op">=</span> admin2<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;ADM2_NAME&#39;</span><span class="op">,</span> <span class="st">&#39;Bangalore Urban&#39;</span>))</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> geometry <span class="op">=</span> selected<span class="op">.</span><span class="fu">geometry</span>()</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> filtered <span class="op">=</span> s2<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">lt</span>(<span class="st">&#39;CLOUDY_PIXEL_PERCENTAGE&#39;</span><span class="op">,</span> <span class="dv">30</span>))</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(<span class="st">&#39;2019-01-01&#39;</span><span class="op">,</span> <span class="st">&#39;2020-01-01&#39;</span>))</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">bounds</span>(geometry))</span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> image <span class="op">=</span> filtered<span class="op">.</span><span class="fu">median</span>()<span class="op">.</span><span class="fu">clip</span>(geometry)<span class="op">;</span> </span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a><span class="co">// AWEI is also known as AWEInsh (no shadows)</span></span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a><span class="co">// AWEInsh works best where there are no shadows in the scene</span></span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> awei <span class="op">=</span> image<span class="op">.</span><span class="fu">expression</span>(</span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;4*(GREEN - SWIR1) - (0.25*NIR + 2.75*SWIR2)&#39;</span><span class="op">,</span> {</span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>      <span class="st">&#39;GREEN&#39;</span><span class="op">:</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;B3&#39;</span>)<span class="op">.</span><span class="fu">multiply</span>(<span class="fl">0.0001</span>)<span class="op">,</span></span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a>      <span class="st">&#39;NIR&#39;</span><span class="op">:</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;B8&#39;</span>)<span class="op">.</span><span class="fu">multiply</span>(<span class="fl">0.0001</span>)<span class="op">,</span></span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a>      <span class="st">&#39;SWIR1&#39;</span><span class="op">:</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;B11&#39;</span>)<span class="op">.</span><span class="fu">multiply</span>(<span class="fl">0.0001</span>)<span class="op">,</span></span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a>      <span class="st">&#39;SWIR2&#39;</span><span class="op">:</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;B12&#39;</span>)<span class="op">.</span><span class="fu">multiply</span>(<span class="fl">0.0001</span>)<span class="op">,</span></span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a>})<span class="op">.</span><span class="fu">rename</span>(<span class="st">&#39;awei_nsh&#39;</span>)<span class="op">;</span></span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a><span class="co">// There is another version of AWEI called AWEIsh</span></span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true" tabindex="-1"></a><span class="co">// This index is useful where there are mountain or building shadows</span></span>
<span id="cb14-26"><a href="#cb14-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-27"><a href="#cb14-27" aria-hidden="true" tabindex="-1"></a><span class="co">// The expression for AWEI (sh) is as follows</span></span>
<span id="cb14-28"><a href="#cb14-28" aria-hidden="true" tabindex="-1"></a><span class="co">// AWEI (sh) = BLUE + 2.5*GREEN - 1.5*(NIR + SWIR1) - 0.25*SWIR2</span></span>
<span id="cb14-29"><a href="#cb14-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-30"><a href="#cb14-30" aria-hidden="true" tabindex="-1"></a><span class="co">// Works best where there are shadows but no bright reflective surfaces (snow, roof)</span></span>
<span id="cb14-31"><a href="#cb14-31" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> aweiSh <span class="op">=</span> image<span class="op">.</span><span class="fu">expression</span>(</span>
<span id="cb14-32"><a href="#cb14-32" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;BLUE + 2.5*GREEN - 1.5*(NIR + SWIR1) - 0.25*SWIR2&#39;</span><span class="op">,</span> {</span>
<span id="cb14-33"><a href="#cb14-33" aria-hidden="true" tabindex="-1"></a>      <span class="st">&#39;BLUE&#39;</span><span class="op">:</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;B2&#39;</span>)<span class="op">.</span><span class="fu">multiply</span>(<span class="fl">0.0001</span>)<span class="op">,</span></span>
<span id="cb14-34"><a href="#cb14-34" aria-hidden="true" tabindex="-1"></a>      <span class="st">&#39;GREEN&#39;</span><span class="op">:</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;B3&#39;</span>)<span class="op">.</span><span class="fu">multiply</span>(<span class="fl">0.0001</span>)<span class="op">,</span></span>
<span id="cb14-35"><a href="#cb14-35" aria-hidden="true" tabindex="-1"></a>      <span class="st">&#39;NIR&#39;</span><span class="op">:</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;B8&#39;</span>)<span class="op">.</span><span class="fu">multiply</span>(<span class="fl">0.0001</span>)<span class="op">,</span></span>
<span id="cb14-36"><a href="#cb14-36" aria-hidden="true" tabindex="-1"></a>      <span class="st">&#39;SWIR1&#39;</span><span class="op">:</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;B11&#39;</span>)<span class="op">.</span><span class="fu">multiply</span>(<span class="fl">0.0001</span>)<span class="op">,</span></span>
<span id="cb14-37"><a href="#cb14-37" aria-hidden="true" tabindex="-1"></a>      <span class="st">&#39;SWIR2&#39;</span><span class="op">:</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;B12&#39;</span>)<span class="op">.</span><span class="fu">multiply</span>(<span class="fl">0.0001</span>)<span class="op">,</span></span>
<span id="cb14-38"><a href="#cb14-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-39"><a href="#cb14-39" aria-hidden="true" tabindex="-1"></a>})<span class="op">.</span><span class="fu">rename</span>(<span class="st">&#39;awei_sh&#39;</span>)<span class="op">;</span></span>
<span id="cb14-40"><a href="#cb14-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-41"><a href="#cb14-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-42"><a href="#cb14-42" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> rgbVis <span class="op">=</span> {<span class="dt">min</span><span class="op">:</span> <span class="fl">0.0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span> <span class="dv">3000</span><span class="op">,</span> <span class="dt">bands</span><span class="op">:</span> [<span class="st">&#39;B4&#39;</span><span class="op">,</span> <span class="st">&#39;B3&#39;</span><span class="op">,</span> <span class="st">&#39;B2&#39;</span>]}<span class="op">;</span></span>
<span id="cb14-43"><a href="#cb14-43" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> ndviVis <span class="op">=</span> {<span class="dt">min</span><span class="op">:</span><span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span><span class="dv">1</span><span class="op">,</span> <span class="dt">palette</span><span class="op">:</span> [<span class="st">&#39;white&#39;</span><span class="op">,</span> <span class="st">&#39;green&#39;</span>]}</span>
<span id="cb14-44"><a href="#cb14-44" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> ndwiVis <span class="op">=</span> {<span class="dt">min</span><span class="op">:</span><span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span><span class="fl">0.5</span><span class="op">,</span> <span class="dt">palette</span><span class="op">:</span> [<span class="st">&#39;white&#39;</span><span class="op">,</span> <span class="st">&#39;blue&#39;</span>]}</span>
<span id="cb14-45"><a href="#cb14-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-46"><a href="#cb14-46" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">centerObject</span>(geometry<span class="op">,</span> <span class="dv">10</span>)</span>
<span id="cb14-47"><a href="#cb14-47" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(image<span class="op">,</span> rgbVis<span class="op">,</span> <span class="st">&#39;Image&#39;</span>)<span class="op">;</span></span>
<span id="cb14-48"><a href="#cb14-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-49"><a href="#cb14-49" aria-hidden="true" tabindex="-1"></a><span class="co">// Exercise</span></span>
<span id="cb14-50"><a href="#cb14-50" aria-hidden="true" tabindex="-1"></a><span class="co">// Replace the name with the ADM2_NAME of your selected region</span></span>
<span id="cb14-51"><a href="#cb14-51" aria-hidden="true" tabindex="-1"></a><span class="co">// Add both aweiSh and aweiNsh layers to the map and compare the results.</span></span></code></pre></div>
<p><a href="https://code.earthengine.google.co.in/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3A01-Earth_Engine_Basics%2F07c_Calculating_Indices_(exercise)" target="_blank">Try in Code Editor ↗</a></p>
</div>
</div>
<div id="computation-on-images" class="section level2">
<h2>08. Computation on Images</h2>
<p>A standard method to extract information from an image is to threshold the image. We can write conditions for thresholding. The result will be a binary image with pixel values 1 or 0. For all pixel matching, the condition value will be 1, and for other pixels where the condition fails value will be 0. The conditions can be written using the <em>logical operators</em> like greater than <code>.gt()</code>, lesser than <code>.lt()</code>, equal to <code>.eq()</code>, greater than or equal to <code>.gte()</code>, etc. We can also combine multiple layers to create a condition using the <em>boolean operators</em> like AND <code>.and()</code>, OR <code>.or()</code> functions.</p>
<div class="figure" style="text-align: center">
<img src="images/gee_water_resources_management/threshold.png" alt="RGB and Thresholded images" width="100%" />
<p class="caption">
RGB and Thresholded images
</p>
</div>
<div class="sourceCode" id="cb15"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> admin2 <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">&quot;FAO/GAUL_SIMPLIFIED_500m/2015/level2&quot;</span>)<span class="op">;</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> s2 <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&quot;COPERNICUS/S2_SR&quot;</span>)<span class="op">;</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> selected <span class="op">=</span> admin2<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;ADM2_NAME&#39;</span><span class="op">,</span> <span class="st">&#39;Bangalore Urban&#39;</span>))</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> geometry <span class="op">=</span> selected<span class="op">.</span><span class="fu">geometry</span>()</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> filtered <span class="op">=</span> s2<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">lt</span>(<span class="st">&#39;CLOUDY_PIXEL_PERCENTAGE&#39;</span><span class="op">,</span> <span class="dv">30</span>))</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(<span class="st">&#39;2019-01-01&#39;</span><span class="op">,</span> <span class="st">&#39;2020-01-01&#39;</span>))</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">bounds</span>(geometry))</span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> image <span class="op">=</span> filtered<span class="op">.</span><span class="fu">median</span>()<span class="op">.</span><span class="fu">clip</span>(geometry)<span class="op">;</span> </span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">centerObject</span>(geometry<span class="op">,</span> <span class="dv">10</span>)</span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(image<span class="op">,</span> rgbVis<span class="op">,</span> <span class="st">&#39;Image&#39;</span>)<span class="op">;</span></span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> ndvi <span class="op">=</span> image<span class="op">.</span><span class="fu">normalizedDifference</span>([<span class="st">&#39;B8&#39;</span><span class="op">,</span> <span class="st">&#39;B4&#39;</span>])<span class="op">.</span><span class="fu">rename</span>([<span class="st">&#39;ndvi&#39;</span>])<span class="op">;</span></span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> mndwi <span class="op">=</span> image<span class="op">.</span><span class="fu">normalizedDifference</span>([<span class="st">&#39;B3&#39;</span><span class="op">,</span> <span class="st">&#39;B11&#39;</span>])<span class="op">.</span><span class="fu">rename</span>([<span class="st">&#39;mndwi&#39;</span>])<span class="op">;</span> </span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> awei <span class="op">=</span> image<span class="op">.</span><span class="fu">expression</span>(</span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;4*(GREEN - SWIR1) - (0.25*NIR + 2.75*SWIR2)&#39;</span><span class="op">,</span> {</span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true" tabindex="-1"></a>      <span class="st">&#39;GREEN&#39;</span><span class="op">:</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;B3&#39;</span>)<span class="op">.</span><span class="fu">multiply</span>(<span class="fl">0.0001</span>)<span class="op">,</span></span>
<span id="cb15-21"><a href="#cb15-21" aria-hidden="true" tabindex="-1"></a>      <span class="st">&#39;NIR&#39;</span><span class="op">:</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;B8&#39;</span>)<span class="op">.</span><span class="fu">multiply</span>(<span class="fl">0.0001</span>)<span class="op">,</span></span>
<span id="cb15-22"><a href="#cb15-22" aria-hidden="true" tabindex="-1"></a>      <span class="st">&#39;SWIR1&#39;</span><span class="op">:</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;B11&#39;</span>)<span class="op">.</span><span class="fu">multiply</span>(<span class="fl">0.0001</span>)<span class="op">,</span></span>
<span id="cb15-23"><a href="#cb15-23" aria-hidden="true" tabindex="-1"></a>      <span class="st">&#39;SWIR2&#39;</span><span class="op">:</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;B12&#39;</span>)<span class="op">.</span><span class="fu">multiply</span>(<span class="fl">0.0001</span>)<span class="op">,</span></span>
<span id="cb15-24"><a href="#cb15-24" aria-hidden="true" tabindex="-1"></a>})<span class="op">.</span><span class="fu">rename</span>(<span class="st">&#39;awei&#39;</span>)<span class="op">;</span></span>
<span id="cb15-25"><a href="#cb15-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-26"><a href="#cb15-26" aria-hidden="true" tabindex="-1"></a><span class="co">// Simple Thresholding</span></span>
<span id="cb15-27"><a href="#cb15-27" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> waterMndwi <span class="op">=</span> mndwi<span class="op">.</span><span class="fu">gt</span>(<span class="dv">0</span>)</span>
<span id="cb15-28"><a href="#cb15-28" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> waterAwei <span class="op">=</span> awei<span class="op">.</span><span class="fu">gt</span>(<span class="dv">0</span>)</span>
<span id="cb15-29"><a href="#cb15-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-30"><a href="#cb15-30" aria-hidden="true" tabindex="-1"></a><span class="co">// Combining Multiple Conditions</span></span>
<span id="cb15-31"><a href="#cb15-31" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> waterMultiple <span class="op">=</span> ndvi<span class="op">.</span><span class="fu">lt</span>(<span class="dv">0</span>)<span class="op">.</span><span class="fu">and</span>(mndwi<span class="op">.</span><span class="fu">gt</span>(<span class="dv">0</span>))</span>
<span id="cb15-32"><a href="#cb15-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-33"><a href="#cb15-33" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> rgbVis <span class="op">=</span> {<span class="dt">min</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span> <span class="dv">3000</span><span class="op">,</span> <span class="dt">bands</span><span class="op">:</span> [<span class="st">&#39;B4&#39;</span><span class="op">,</span> <span class="st">&#39;B3&#39;</span><span class="op">,</span> <span class="st">&#39;B2&#39;</span>]}<span class="op">;</span></span>
<span id="cb15-34"><a href="#cb15-34" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> waterVis <span class="op">=</span> {<span class="dt">min</span><span class="op">:</span><span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span><span class="dv">1</span><span class="op">,</span> <span class="dt">palette</span><span class="op">:</span> [<span class="st">&#39;white&#39;</span><span class="op">,</span> <span class="st">&#39;blue&#39;</span>]}</span>
<span id="cb15-35"><a href="#cb15-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-36"><a href="#cb15-36" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(image<span class="op">,</span> rgbVis<span class="op">,</span> <span class="st">&#39;Image&#39;</span>)<span class="op">;</span></span>
<span id="cb15-37"><a href="#cb15-37" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(waterMndwi<span class="op">,</span> waterVis<span class="op">,</span> <span class="st">&#39;MNDWI - Simple threshold&#39;</span>)</span>
<span id="cb15-38"><a href="#cb15-38" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(waterAwei<span class="op">,</span> waterVis<span class="op">,</span> <span class="st">&#39;AWEI - Simple threshold&#39;</span>)</span>
<span id="cb15-39"><a href="#cb15-39" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(waterMultiple<span class="op">,</span> waterVis<span class="op">,</span> <span class="st">&#39;MNDWI and NDVI Threshold&#39;</span>)</span></code></pre></div>
<p><a href="https://code.earthengine.google.co.in/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3A01-Earth_Engine_Basics%2F08b_Computation_on_Images_(complete)" target="_blank">Open in Code Editor ↗</a></p>
<div id="exercise-7" class="section level3">
<h3>Exercise</h3>
<div class="sourceCode" id="cb16"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> admin2 <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">&quot;FAO/GAUL_SIMPLIFIED_500m/2015/level2&quot;</span>)<span class="op">;</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> s2 <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&quot;COPERNICUS/S2_SR&quot;</span>)<span class="op">;</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> selected <span class="op">=</span> admin2<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;ADM2_NAME&#39;</span><span class="op">,</span> <span class="st">&#39;Bangalore Urban&#39;</span>))</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> geometry <span class="op">=</span> selected<span class="op">.</span><span class="fu">geometry</span>()</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> filtered <span class="op">=</span> s2<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">lt</span>(<span class="st">&#39;CLOUDY_PIXEL_PERCENTAGE&#39;</span><span class="op">,</span> <span class="dv">30</span>))</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(<span class="st">&#39;2019-01-01&#39;</span><span class="op">,</span> <span class="st">&#39;2020-01-01&#39;</span>))</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">bounds</span>(geometry))</span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> image <span class="op">=</span> filtered<span class="op">.</span><span class="fu">median</span>()<span class="op">.</span><span class="fu">clip</span>(geometry)<span class="op">;</span> </span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> mndwi <span class="op">=</span> image<span class="op">.</span><span class="fu">normalizedDifference</span>([<span class="st">&#39;B3&#39;</span><span class="op">,</span> <span class="st">&#39;B11&#39;</span>])<span class="op">.</span><span class="fu">rename</span>([<span class="st">&#39;mndwi&#39;</span>])<span class="op">;</span> </span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a><span class="co">// Simple Thresholding</span></span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> waterMndwi <span class="op">=</span> mndwi<span class="op">.</span><span class="fu">gt</span>(<span class="dv">0</span>)</span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a><span class="co">// Excercise</span></span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a><span class="co">// Replace the selected region with your choice</span></span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a><span class="co">// And adjust the MNDWI thresholds to extract the waterbodies</span></span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a><span class="co">// Try different thresholds and add images to the map to compare</span></span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true" tabindex="-1"></a><span class="co">// Hint: Try negative thresholds -0.1 and -0.2</span></span>
<span id="cb16-24"><a href="#cb16-24" aria-hidden="true" tabindex="-1"></a><span class="co">// Hint: Try positive thresholds 0.1 and 0.2</span></span>
<span id="cb16-25"><a href="#cb16-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-26"><a href="#cb16-26" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> rgbVis <span class="op">=</span> {<span class="dt">min</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span> <span class="dv">3000</span><span class="op">,</span> <span class="dt">bands</span><span class="op">:</span> [<span class="st">&#39;B4&#39;</span><span class="op">,</span> <span class="st">&#39;B3&#39;</span><span class="op">,</span> <span class="st">&#39;B2&#39;</span>]}<span class="op">;</span></span>
<span id="cb16-27"><a href="#cb16-27" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> waterVis <span class="op">=</span> {<span class="dt">min</span><span class="op">:</span><span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span><span class="dv">1</span><span class="op">,</span> <span class="dt">palette</span><span class="op">:</span> [<span class="st">&#39;black&#39;</span><span class="op">,</span> <span class="st">&#39;white&#39;</span>]}</span>
<span id="cb16-28"><a href="#cb16-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-29"><a href="#cb16-29" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">centerObject</span>(geometry<span class="op">,</span> <span class="dv">10</span>)</span>
<span id="cb16-30"><a href="#cb16-30" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(image<span class="op">,</span> rgbVis<span class="op">,</span> <span class="st">&#39;Image&#39;</span>)<span class="op">;</span></span>
<span id="cb16-31"><a href="#cb16-31" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(waterMndwi<span class="op">,</span> waterVis<span class="op">,</span> <span class="st">&#39;MNDWI (Threshold 0)&#39;</span>)</span></code></pre></div>
<p><a href="https://code.earthengine.google.co.in/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3A01-Earth_Engine_Basics%2F08c_Computation_on_Images_(exercise)" target="_blank">Try in Code Editor ↗</a></p>
</div>
</div>
<div id="export" class="section level2">
<h2>09. Export</h2>
<p>Earth Engine allows for exporting both vector and raster data to be used in an external program. Vector data can be exported as a <code>CSV</code> or a <code>Shapefile</code>, while Rasters can be exported as <code>GeoTIFF</code> files. We will now export the Sentinel-2 Composite as a GeoTIFF file.</p>
<p>During the export, we can export either a raw image or visualized image. The raw image will retain the original reflectance value of each pixel. The visualized image will generate RGB or grayscale visualization of the image. The image will look like it is in the earth engine map view, but the band reflectance information will be lost. The visualized image should not use it for analysis purposes.</p>
<blockquote>
<p>Tip: Code Editor supports autocompletion of API functions using the combination <em>Ctrl+Space</em>. Type a few characters of a function and press <em>Ctrl+Space</em> to see autocomplete suggestions. You can also use the same key combination to fill all parameters of the function automatically.</p>
</blockquote>
<div class="sourceCode" id="cb17"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> admin2 <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">&quot;FAO/GAUL_SIMPLIFIED_500m/2015/level2&quot;</span>)<span class="op">;</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> s2 <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&quot;COPERNICUS/S2_SR&quot;</span>)<span class="op">;</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> selected <span class="op">=</span> admin2<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;ADM2_NAME&#39;</span><span class="op">,</span> <span class="st">&#39;Bangalore Urban&#39;</span>))</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> geometry <span class="op">=</span> selected<span class="op">.</span><span class="fu">geometry</span>()</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> filtered <span class="op">=</span> s2<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">lt</span>(<span class="st">&#39;CLOUDY_PIXEL_PERCENTAGE&#39;</span><span class="op">,</span> <span class="dv">30</span>))</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(<span class="st">&#39;2019-01-01&#39;</span><span class="op">,</span> <span class="st">&#39;2020-01-01&#39;</span>))</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">bounds</span>(geometry))</span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> image <span class="op">=</span> filtered<span class="op">.</span><span class="fu">median</span>()<span class="op">.</span><span class="fu">clip</span>(geometry)<span class="op">;</span> </span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> ndvi <span class="op">=</span> image<span class="op">.</span><span class="fu">normalizedDifference</span>([<span class="st">&#39;B8&#39;</span><span class="op">,</span> <span class="st">&#39;B4&#39;</span>])<span class="op">.</span><span class="fu">rename</span>([<span class="st">&#39;ndvi&#39;</span>])<span class="op">;</span></span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> mndwi <span class="op">=</span> image<span class="op">.</span><span class="fu">normalizedDifference</span>([<span class="st">&#39;B3&#39;</span><span class="op">,</span> <span class="st">&#39;B11&#39;</span>])<span class="op">.</span><span class="fu">rename</span>([<span class="st">&#39;mndwi&#39;</span>])<span class="op">;</span> </span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> waterMndwi <span class="op">=</span> mndwi<span class="op">.</span><span class="fu">gt</span>(<span class="dv">0</span>)</span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> rgbVis <span class="op">=</span> {<span class="dt">min</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span> <span class="dv">3000</span><span class="op">,</span> <span class="dt">bands</span><span class="op">:</span> [<span class="st">&#39;B4&#39;</span><span class="op">,</span> <span class="st">&#39;B3&#39;</span><span class="op">,</span> <span class="st">&#39;B2&#39;</span>]}<span class="op">;</span></span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> waterVis <span class="op">=</span> {<span class="dt">min</span><span class="op">:</span><span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span><span class="dv">1</span><span class="op">,</span> <span class="dt">palette</span><span class="op">:</span> [<span class="st">&#39;black&#39;</span><span class="op">,</span> <span class="st">&#39;white&#39;</span>]}</span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">centerObject</span>(geometry<span class="op">,</span> <span class="dv">10</span>)</span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(image<span class="op">,</span> rgbVis<span class="op">,</span> <span class="st">&#39;Image&#39;</span>)<span class="op">;</span></span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(waterMndwi<span class="op">,</span> waterVis<span class="op">,</span> <span class="st">&#39;MNDWI&#39;</span>)</span>
<span id="cb17-25"><a href="#cb17-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-26"><a href="#cb17-26" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> exportImage <span class="op">=</span> image<span class="op">.</span><span class="fu">select</span>([<span class="st">&#39;B4&#39;</span><span class="op">,</span> <span class="st">&#39;B3&#39;</span><span class="op">,</span> <span class="st">&#39;B2&#39;</span>])</span>
<span id="cb17-27"><a href="#cb17-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-28"><a href="#cb17-28" aria-hidden="true" tabindex="-1"></a>Export<span class="op">.</span><span class="at">image</span><span class="op">.</span><span class="fu">toDrive</span>({</span>
<span id="cb17-29"><a href="#cb17-29" aria-hidden="true" tabindex="-1"></a>  <span class="dt">image</span><span class="op">:</span> exportImage<span class="op">,</span></span>
<span id="cb17-30"><a href="#cb17-30" aria-hidden="true" tabindex="-1"></a>  <span class="dt">description</span><span class="op">:</span> <span class="st">&#39;Raw_Composite_Image&#39;</span><span class="op">,</span></span>
<span id="cb17-31"><a href="#cb17-31" aria-hidden="true" tabindex="-1"></a>  <span class="dt">folder</span><span class="op">:</span> <span class="st">&#39;earthengine&#39;</span><span class="op">,</span></span>
<span id="cb17-32"><a href="#cb17-32" aria-hidden="true" tabindex="-1"></a>  <span class="dt">fileNamePrefix</span><span class="op">:</span> <span class="st">&#39;composite&#39;</span><span class="op">,</span></span>
<span id="cb17-33"><a href="#cb17-33" aria-hidden="true" tabindex="-1"></a>  <span class="dt">region</span><span class="op">:</span> geometry<span class="op">,</span></span>
<span id="cb17-34"><a href="#cb17-34" aria-hidden="true" tabindex="-1"></a>  <span class="dt">scale</span><span class="op">:</span> <span class="dv">10</span><span class="op">,</span></span>
<span id="cb17-35"><a href="#cb17-35" aria-hidden="true" tabindex="-1"></a>  <span class="dt">maxPixels</span><span class="op">:</span> <span class="fl">1e10</span>})</span>
<span id="cb17-36"><a href="#cb17-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-37"><a href="#cb17-37" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> visualizedImage <span class="op">=</span> image<span class="op">.</span><span class="fu">visualize</span>(rgbVis)</span>
<span id="cb17-38"><a href="#cb17-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-39"><a href="#cb17-39" aria-hidden="true" tabindex="-1"></a>Export<span class="op">.</span><span class="at">image</span><span class="op">.</span><span class="fu">toDrive</span>({</span>
<span id="cb17-40"><a href="#cb17-40" aria-hidden="true" tabindex="-1"></a>  <span class="dt">image</span><span class="op">:</span> visualizedImage<span class="op">,</span></span>
<span id="cb17-41"><a href="#cb17-41" aria-hidden="true" tabindex="-1"></a>  <span class="dt">description</span><span class="op">:</span> <span class="st">&#39;Visualized_Composite_Image&#39;</span><span class="op">,</span></span>
<span id="cb17-42"><a href="#cb17-42" aria-hidden="true" tabindex="-1"></a>  <span class="dt">folder</span><span class="op">:</span> <span class="st">&#39;earthengine&#39;</span><span class="op">,</span></span>
<span id="cb17-43"><a href="#cb17-43" aria-hidden="true" tabindex="-1"></a>  <span class="dt">fileNamePrefix</span><span class="op">:</span> <span class="st">&#39;composite_visualized&#39;</span><span class="op">,</span></span>
<span id="cb17-44"><a href="#cb17-44" aria-hidden="true" tabindex="-1"></a>  <span class="dt">region</span><span class="op">:</span> geometry<span class="op">,</span></span>
<span id="cb17-45"><a href="#cb17-45" aria-hidden="true" tabindex="-1"></a>  <span class="dt">scale</span><span class="op">:</span> <span class="dv">10</span><span class="op">,</span></span>
<span id="cb17-46"><a href="#cb17-46" aria-hidden="true" tabindex="-1"></a>  <span class="dt">maxPixels</span><span class="op">:</span> <span class="fl">1e10</span>}) </span></code></pre></div>
<p><a href="https://code.earthengine.google.co.in/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3A01-Earth_Engine_Basics%2F09b_Export_(complete)" target="_blank">Open in Code Editor ↗</a></p>
<p>Once you run this script, the <em>Tasks</em> tab will be highlighted. Switch to the tab and you will see the tasks waiting. Click <em>Run</em> next to each task to start the process. On clicking the <em>Run</em> button, you will be prompted for a confirmation dialog. Verify the settings and click <em>Run</em> to start the export.</p>
<div class="figure" style="text-align: center">
<img src="images/gee_water_resources_management/export_task.png" alt="Console, Tasks and Confirmation." width="150%" />
<p class="caption">
Console, Tasks and Confirmation.
</p>
</div>
<p>Once the Export finishes, a GeoTiff file for each export task will be added to your Google Drive in the specified folder. You can download them and use it in a GIS software.</p>
<div class="figure" style="text-align: center">
<img src="images/gee_water_resources_management/export_image.png" alt="Visualized vs Raw" width="100%" />
<p class="caption">
Visualized vs Raw
</p>
</div>
<div id="exercise-8" class="section level3">
<h3>Exercise</h3>
<div class="sourceCode" id="cb18"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Export the waterMndwi image to your drive </span></span></code></pre></div>
<p><a href="https://code.earthengine.google.co.in/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3A01-Earth_Engine_Basics%2F09c_Export_(exercise)" target="_blank">Try in Code Editor ↗</a></p>
</div>
</div>
</div>
<div id="module-2-surface-water-mapping" class="section level1">
<h1>Module 2: Surface Water Mapping</h1>
<p>In this Module, we will learn create an vectore surface water map for a water shed boundary in <a href="https://www.hydrosheds.org/page/hydrobasins">HydroSheds</a> using <a href="https://global-surface-water.appspot.com/#features">JRC - Global Surface Water</a>. This data contains more accurate global-level surface water information. Using this, we will map the surface water, then learn to water mask and get specific information, execute morphological operations, and create a vector map for a river basin.</p>
<p><a href="https://docs.google.com/presentation/d/15EIaoRWc-obUrl2kqzlw_mYIaSAzYn7aOOE9SyU6XKc/edit?usp=sharing" target="_blank"><img src="images/gee_water_resources_management/Surface_Water_Mapping_ppt.png" width="400" alt="View Presentation" /></a></p>
<p><a href="https://docs.google.com/presentation/d/15EIaoRWc-obUrl2kqzlw_mYIaSAzYn7aOOE9SyU6XKc/edit?usp=sharing" target="_blank">View the Presentation ↗</a></p>
<div id="load-global-surface-water-data" class="section level2">
<h2>01. Load Global Surface Water Data</h2>
<p>Lets load the <a href="https://developers.google.com/earth-engine/datasets/catalog/JRC_GSW1_3_GlobalSurfaceWater">JRC Global Surface Water Mapping Layers</a>. This data is the Spatio-temporal distribution of surface water. It is a single image with 7 bands, where each band contains unique information. Let’s use the <code>occurrence</code> band, which includes information on the frequency of the water present from 1984-2020. The pixel value ranges from 0-100, where 0 represents No trace of water in any year, and 100 represents water present in all 36 years.</p>
<p>Use the Inspector to find the frequency of water present in the location.</p>
<div class="figure" style="text-align: center">
<img src="images/gee_water_resources_management/Load_Global_Surface_Water_Data_01.png" alt="Frequency of water present over Bellandur lake" width="100%" />
<p class="caption">
Frequency of water present over Bellandur lake
</p>
</div>
<p><a href="https://code.earthengine.google.com/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3A02-Surface_Water_Mapping%2F01b_Load_Global_Surface_Water_Data_(complete)" target="_blank">Open in Code Editor ↗</a></p>
<div id="exercise-9" class="section level3">
<h3>Exercise</h3>
<p>The <code>max_extent</code> band gives information on whether a pixel ever contained water or not, 0 represents the pixel has no water present in any of the months, and 1 represents the pixel has contained water in it for at least 1 month.</p>
<p>Load the <code>max_extent</code> band and visualize it with correct parameters.</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Create a map showing everywhere surface water was present.</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="co">// Select the &#39;max_extent&#39; band and display the results</span></span></code></pre></div>
<p><a href="https://code.earthengine.google.com/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3A02-Surface_Water_Mapping%2F01c_Load_Global_Surface_Water_Data_(exercise)" target="_blank">Try in Code Editor ↗</a></p>
</div>
</div>
<div id="create-a-water-mask" class="section level2">
<h2>02. Create a Water Mask</h2>
<p>Earth Engine has a <code>mask</code> function to represent the <em>No Data</em> values in an Image. Any masked pixel of an image will not be used for analysis or visualization. There are two types of masks <code>selfMask</code> and <code>updateMask.</code></p>
<p>The <code>selfMask</code> will remove all the pixel values with <em>zero</em>. In the <code>max_extent</code> band visualization, we saw the pixel value is either 0 or 1, the pixel value with 0 contains no information, but the pixel value with 1 represents the water occurrence. So to remove the No Data pixel within the image, we can use the selfMask function. This will mask all pixel value with 0.</p>
<p>The <code>updateMask</code> will mask a <em>primary image</em> using a <em>mask image</em>. A mask image is an image with 0 1 pixel value. The primary image pixels overlaying with 0-pixel value in mask image will be set as No Data and masked out.</p>
<div class="figure" style="text-align: center">
<img src="images/gee_water_resources_management/water_mask.png" alt="Before applying Mask vs After applying Mask" width="100%" />
<p class="caption">
Before applying Mask vs After applying Mask
</p>
</div>
<div class="sourceCode" id="cb20"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> gsw <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(<span class="st">&quot;JRC/GSW1_3/GlobalSurfaceWater&quot;</span>)<span class="op">;</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="co">// Select the &#39;max_extent&#39; band</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> water <span class="op">=</span> gsw<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;max_extent&#39;</span>)<span class="op">;</span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a><span class="co">// max_extent band has values 0 or 1</span></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a><span class="co">// We can remove the 0 values by masking the layer</span></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a><span class="co">// Mask needs to have 0 or 1 values</span></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a><span class="co">// 0 - remove the pixel</span></span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a><span class="co">// 1 - keep the pixel</span></span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> masked <span class="op">=</span> water<span class="op">.</span><span class="fu">updateMask</span>(water)</span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a><span class="co">// There is a handy short-hand for masking out 0 values for a layer</span></span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a><span class="co">// You can call selfMask() which will mask the image with itself</span></span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a><span class="co">// Effectively removing 0 values and retaining non-zero values</span></span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> masked <span class="op">=</span> water<span class="op">.</span><span class="fu">selfMask</span>()</span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(masked<span class="op">,</span> {}<span class="op">,</span> <span class="st">&#39;Water&#39;</span>)<span class="op">;</span></span></code></pre></div>
<p><a href="https://code.earthengine.google.co.in/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3A02-Surface_Water_Mapping%2F02b_Create_a_Water_Mask_(complete)" target="_blank">Open in Code Editor ↗</a></p>
<div id="exercise-10" class="section level3">
<h3>Exercise</h3>
<p>The <code>seasonality</code> band gives information on the number of months water was present in a pixel. Pixel value ranges from 1 to 12, 1 represents water present for 1 month, and 12 represents water present for 12 months in a year.</p>
<p>Select all pixels in which water present for more than 5 months in a year.</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> gsw <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(<span class="st">&quot;JRC/GSW1_3/GlobalSurfaceWater&quot;</span>)<span class="op">;</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a><span class="co">// Exercise</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a><span class="co">// Use the &#39;seasonality&#39; band to map permanent water</span></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a><span class="co">// Permanent water can be defined where water is </span></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a><span class="co">// present &gt; 5 months in a year</span></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a><span class="co">// Mask the layer and display the map in blue color</span></span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> gsw <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(<span class="st">&quot;JRC/GSW1_3/GlobalSurfaceWater&quot;</span>)<span class="op">;</span></span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> seasonality <span class="op">=</span> gsw<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;seasonality&#39;</span>)<span class="op">;</span></span></code></pre></div>
<p><a href="https://code.earthengine.google.co.in/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3A02-Surface_Water_Mapping%2F02c_Create_a_Water_Mask_(exercise)" target="_blank">Try in Code Editor ↗</a></p>
</div>
</div>
<div id="find-lost-waterbodies" class="section level2">
<h2>03. Find Lost Waterbodies</h2>
<p>The <code>transition</code> band has water class changes between 1986 and 2020. It has <a href="https://developers.google.com/earth-engine/datasets/catalog/JRC_GSW1_3_GlobalSurfaceWater#bands">10 classes</a> representing different changes, in which classes <em>3</em> and <em>6</em> represent <em>permanent</em> and <em>seasonal water loss</em>. We can calculate the total area of surface water lost by selecting both classes.</p>
<p>The <em>binary operator</em> <code>eq</code> is used to select a particular class and create a binary image representing the availability of the class. The <em>boolean operator</em> <code>or</code> is used to create a binary image where either class value is present.</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> gsw <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(<span class="st">&quot;JRC/GSW1_3/GlobalSurfaceWater&quot;</span>)</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="co">// Select the &#39;transition&#39; band</span></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> water <span class="op">=</span> gsw<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;transition&#39;</span>)<span class="op">;</span> </span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> lostWater <span class="op">=</span> water<span class="op">.</span><span class="fu">eq</span>(<span class="dv">3</span>)<span class="op">.</span><span class="fu">or</span>(water<span class="op">.</span><span class="fu">eq</span>(<span class="dv">6</span>))</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> visParams <span class="op">=</span> {</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>  <span class="dt">min</span><span class="op">:</span><span class="dv">0</span><span class="op">,</span></span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>  <span class="dt">max</span><span class="op">:</span><span class="dv">1</span><span class="op">,</span></span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>  <span class="dt">palette</span><span class="op">:</span> [<span class="st">&#39;white&#39;</span><span class="op">,</span><span class="st">&#39;red&#39;</span>]</span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a><span class="co">// Mask &#39;0&#39; value pixels</span></span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> lostWater <span class="op">=</span> lostWater<span class="op">.</span><span class="fu">selfMask</span>()</span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(lostWater<span class="op">,</span> visParams<span class="op">,</span> <span class="st">&#39;Lost Water&#39;</span>) </span></code></pre></div>
<p><a href="https://code.earthengine.google.com/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3A02-Surface_Water_Mapping%2F03b_Find_Lost_Waterbodies_(complete)" target="_blank">Open in Code Editor ↗</a></p>
<div id="exercise-11" class="section level3">
<h3>Exercise</h3>
<p>Use the <code>transition</code> band and find the total surface water gain.</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> gsw <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(<span class="st">&quot;JRC/GSW1_3/GlobalSurfaceWater&quot;</span>)</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> water <span class="op">=</span> gsw<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;transition&#39;</span>)<span class="op">;</span> </span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a><span class="co">// Exercise</span></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a><span class="co">// Find the surface water that was gained between 1984-2020 </span></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a><span class="co">// Display the results on the map</span></span></code></pre></div>
<p><a href="https://code.earthengine.google.com/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3A02-Surface_Water_Mapping%2F03c_Find_Lost_Waterbodies_(exercise)" target="_blank">Try in Code Editor ↗</a></p>
</div>
</div>
<div id="get-yearly-water-history" class="section level2">
<h2>04. Get Yearly Water History</h2>
<p>The <a href="https://developers.google.com/earth-engine/datasets/catalog/JRC_GSW1_3_YearlyHistory">JRC Yearly Water Classification History</a> image collection contains the spatiotemporal map of surface water from 1984 to 2020. A total of 37 images represent 1 image for each year.</p>
<p>Let us filter this collection to visualize the surface water map of the year <em>2020</em>. This data contains 4 bands, where bands 2 and 3 indicate water presence.</p>
<blockquote>
<p>After filtering the Image Collection, the resultant would be a collection even if it contains just 1 image. We can use the function <code>.first()</code> to extract the particular image.</p>
</blockquote>
<div class="sourceCode" id="cb24"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> gswYearly <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&quot;JRC/GSW1_3/YearlyHistory&quot;</span>)<span class="op">;</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a><span class="co">// Filter using the &#39;year&#39; property</span></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> filtered <span class="op">=</span> gswYearly<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;year&#39;</span><span class="op">,</span> <span class="dv">2020</span>))</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> gsw2020 <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(filtered<span class="op">.</span><span class="fu">first</span>())</span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a><span class="co">// Select permanent or seasonal water</span></span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> water2020 <span class="op">=</span> gsw2020<span class="op">.</span><span class="fu">eq</span>(<span class="dv">2</span>)<span class="op">.</span><span class="fu">or</span>(gsw2020<span class="op">.</span><span class="fu">eq</span>(<span class="dv">3</span>))</span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a><span class="co">// Mask &#39;0&#39; value pixels</span></span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> water2020 <span class="op">=</span> water2020<span class="op">.</span><span class="fu">selfMask</span>()</span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> visParams <span class="op">=</span> {</span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a>  <span class="dt">min</span><span class="op">:</span><span class="dv">0</span><span class="op">,</span></span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a>  <span class="dt">max</span><span class="op">:</span><span class="dv">1</span><span class="op">,</span></span>
<span id="cb24-17"><a href="#cb24-17" aria-hidden="true" tabindex="-1"></a>  <span class="dt">palette</span><span class="op">:</span> [<span class="st">&#39;white&#39;</span><span class="op">,</span><span class="st">&#39;blue&#39;</span>]</span>
<span id="cb24-18"><a href="#cb24-18" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb24-19"><a href="#cb24-19" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(water2020<span class="op">,</span> visParams<span class="op">,</span> <span class="st">&#39;2020 Water&#39;</span>)</span></code></pre></div>
<p><a href="https://code.earthengine.google.com/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3A02-Surface_Water_Mapping%2F04b_Get_Yearly_Water_History_(complete)" target="_blank">Open in Code Editor ↗</a></p>
<div id="exercise-12" class="section level3">
<h3>Exercise</h3>
<p>Use the <code>JRC Yearly Water Classification History</code> dataset and visualize the surface water map for the year <em>2010</em>.</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Get the surface water image for the year 2010</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="co">// Display it on the map</span></span></code></pre></div>
<p><a href="https://code.earthengine.google.com/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3A02-Surface_Water_Mapping%2F04c_Get_Yearly_Water_History_(exercise)" target="_blank">Try in Code Editor ↗</a></p>
</div>
</div>
<div id="locate-a-subbasin" class="section level2">
<h2>05. Locate a SubBasin</h2>
<p>The <a href="https://www.hydrosheds.org/">HydroSHEDS</a> is a series of data primarily developed by the <em>World Wildlife Fund</em>. It contains a global level geo-reference stream network, watershed boundaries, and drainage directions. We will use the <code>hydroBASINS,</code> a feature collection containing drainage basin boundaries. This data is created using SRTM DEM data. There are multiple levels of hydroBASINS, ranging from 1 to 11. In level 1, the basin boundaries are delineated as huge groups. Moving levels up, these boundaries will be sub-divided into smaller boundaries.</p>
<p>We will use the Level 7 hydroBASINS feature collection to filter and locate a sun-basin called <em>Arkavathy</em>. The hydroBASINS doesn’t contain basin names, so basins should be visually located and filtered using the <em>HYBAS_ID</em> property to filter a particular basin boundary.</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> hydrobasins <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">&quot;WWF/HydroSHEDS/v1/Basins/hybas_7&quot;</span>)<span class="op">;</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> basin <span class="op">=</span> hydrobasins<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;HYBAS_ID&#39;</span><span class="op">,</span> <span class="dv">4071139640</span>))</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">centerObject</span>(basin)</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(basin<span class="op">,</span> {<span class="dt">color</span><span class="op">:</span> <span class="st">&#39;grey&#39;</span>}<span class="op">,</span> <span class="st">&#39;Arkavathy Sub Basin&#39;</span>)</span></code></pre></div>
<p><a href="https://code.earthengine.google.com/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3A02-Surface_Water_Mapping%2F05b_Locate_a_SubBasin_(complete)" target="_blank">Open in Code Editor ↗</a></p>
<div id="exercise-13" class="section level3">
<h3>Exercise</h3>
<p>Using the Level 7 hydroBASINS, locate and filter a watershed basin in your region of interest.</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Add the hydrobasins layer to the map</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a><span class="co">// Zoom to your region on interest and inspect the layer</span></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a><span class="co">// Find the id for a sub basin of interest and add it to the map.</span></span></code></pre></div>
<p><a href="https://code.earthengine.google.com/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3A02-Surface_Water_Mapping%2F05c_Locate_a_SubBasin_(exercise)" target="_blank">Try in Code Editor ↗</a></p>
</div>
</div>
<div id="create-a-surface-water-map" class="section level2">
<h2>06. Create a Surface Water Map</h2>
<p>A raster image output can be post-processed using morphological operations to create a clean-looking surface map. There are different types of operations like <em>Morphological Opening</em>, <em>Morphological Closing</em>, and <em>Majority Filtering</em>.</p>
<ul>
<li>The opening operation can reduce the salt and pepper noise in the image.</li>
<li>The closing operation can fill holes and create a complete class.</li>
<li>A majority filter will smooth the image. This operation should be used for mapping purposes only and not used while calculating statistics, as it will significantly alter the result.</li>
</ul>
<p>Earth Engine has many functions to perform morphological operations under <code>ee.Image</code>. Let’s use the <code>Max_extent</code> band from Global Surface Water and fill holes to create a surface water map. An <em>Erosion</em> operation follows a <em>Dilation</em> operation to perform a closing operation, which translates as the <em>focalMin</em> function chained with <em>focalMax</em> in the earth engine. Different <em>kernelType</em> are available, let’s use the <em>Square</em> kernel with <em>30</em> as search <em>radius</em> as the JRC’s Global Surface Water spatial resolution is 30m. We can also define a custom kernel if the required kernel is unavailable in kernelType.</p>
<div class="figure" style="text-align: center">
<img src="images/gee_water_resources_management/morphological_operation.png" alt="Before Operation vs After Operation" width="150%" />
<p class="caption">
Before Operation vs After Operation
</p>
</div>
<div class="sourceCode" id="cb28"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> gsw <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(<span class="st">&quot;JRC/GSW1_3/GlobalSurfaceWater&quot;</span>)<span class="op">;</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> hydrobasins <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">&quot;WWF/HydroSHEDS/v1/Basins/hybas_7&quot;</span>)<span class="op">;</span></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> basin <span class="op">=</span> hydrobasins<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;HYBAS_ID&#39;</span><span class="op">,</span> <span class="dv">4071139640</span>))</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> geometry <span class="op">=</span> basin<span class="op">.</span><span class="fu">geometry</span>()</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">centerObject</span>(geometry<span class="op">,</span> <span class="dv">10</span>)</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> water <span class="op">=</span> gsw<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;max_extent&#39;</span>)<span class="op">;</span></span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> clipped <span class="op">=</span> water<span class="op">.</span><span class="fu">clip</span>(geometry)</span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> visParams <span class="op">=</span> {<span class="dt">min</span><span class="op">:</span><span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span><span class="dv">1</span><span class="op">,</span> <span class="dt">palette</span><span class="op">:</span> [<span class="st">&#39;white&#39;</span><span class="op">,</span><span class="st">&#39;blue&#39;</span>]}</span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(clipped<span class="op">,</span> visParams<span class="op">,</span> <span class="st">&#39;Surface Water&#39;</span>) </span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a><span class="co">// Do unmask() to replace masked pixels with 0</span></span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true" tabindex="-1"></a><span class="co">// This avoids extra pixels along the edges</span></span>
<span id="cb28-16"><a href="#cb28-16" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> clipped <span class="op">=</span> clipped<span class="op">.</span><span class="fu">unmask</span>(<span class="dv">0</span>)</span>
<span id="cb28-17"><a href="#cb28-17" aria-hidden="true" tabindex="-1"></a><span class="co">// Perform a morphological closing to fill holes in waterbodies</span></span>
<span id="cb28-18"><a href="#cb28-18" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> waterProcessed <span class="op">=</span> clipped</span>
<span id="cb28-19"><a href="#cb28-19" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">focalMax</span>({</span>
<span id="cb28-20"><a href="#cb28-20" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;radius&#39;</span><span class="op">:</span><span class="dv">30</span><span class="op">,</span></span>
<span id="cb28-21"><a href="#cb28-21" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;units&#39;</span><span class="op">:</span> <span class="st">&#39;meters&#39;</span><span class="op">,</span></span>
<span id="cb28-22"><a href="#cb28-22" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;kernelType&#39;</span><span class="op">:</span> <span class="st">&#39;square&#39;</span>})</span>
<span id="cb28-23"><a href="#cb28-23" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">focalMin</span>({</span>
<span id="cb28-24"><a href="#cb28-24" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;radius&#39;</span><span class="op">:</span><span class="dv">30</span><span class="op">,</span></span>
<span id="cb28-25"><a href="#cb28-25" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;units&#39;</span><span class="op">:</span> <span class="st">&#39;meters&#39;</span><span class="op">,</span></span>
<span id="cb28-26"><a href="#cb28-26" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;kernelType&#39;</span><span class="op">:</span> <span class="st">&#39;square&#39;</span>})<span class="op">;</span></span>
<span id="cb28-27"><a href="#cb28-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-28"><a href="#cb28-28" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(waterProcessed<span class="op">,</span> visParams<span class="op">,</span> <span class="st">&#39;Surface Water (Processed)&#39;</span>)</span></code></pre></div>
<p><a href="https://code.earthengine.google.com/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3A02-Surface_Water_Mapping%2F06b_Create_a_Surface_Water_Map_(complete)" target="_blank">Open in Code Editor ↗</a></p>
<div id="exercise-14" class="section level3">
<h3>Exercise</h3>
<p>By default, the total iteration is 1. We can increase it as required, so the kernel will pass through the image to perform the operation as many times as required.</p>
<p>Set the iteration parameter to 2 and execute the morphological closing operation.</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> gsw <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(<span class="st">&quot;JRC/GSW1_3/GlobalSurfaceWater&quot;</span>)<span class="op">;</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> hydrobasins <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">&quot;WWF/HydroSHEDS/v1/Basins/hybas_7&quot;</span>)<span class="op">;</span></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> basin <span class="op">=</span> hydrobasins<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;HYBAS_ID&#39;</span><span class="op">,</span> <span class="dv">4071139640</span>))</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> geometry <span class="op">=</span> basin<span class="op">.</span><span class="fu">geometry</span>()</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">centerObject</span>(geometry<span class="op">,</span> <span class="dv">10</span>)</span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> water <span class="op">=</span> gsw<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;max_extent&#39;</span>)<span class="op">;</span></span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> clipped <span class="op">=</span> water<span class="op">.</span><span class="fu">clip</span>(geometry)</span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> visParams <span class="op">=</span> {<span class="dt">min</span><span class="op">:</span><span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span><span class="dv">1</span><span class="op">,</span> <span class="dt">palette</span><span class="op">:</span> [<span class="st">&#39;white&#39;</span><span class="op">,</span><span class="st">&#39;blue&#39;</span>]}</span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(clipped<span class="op">,</span> visParams<span class="op">,</span> <span class="st">&#39;Surface Water&#39;</span>) </span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a><span class="co">// Do unmask() to replace masked pixels with 0</span></span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true" tabindex="-1"></a><span class="co">// This avoids extra pixels along the edges</span></span>
<span id="cb29-16"><a href="#cb29-16" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> clipped <span class="op">=</span> clipped<span class="op">.</span><span class="fu">unmask</span>(<span class="dv">0</span>)</span>
<span id="cb29-17"><a href="#cb29-17" aria-hidden="true" tabindex="-1"></a><span class="co">// Perform a morphological closing to fill holes in waterbodies</span></span>
<span id="cb29-18"><a href="#cb29-18" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> waterProcessed <span class="op">=</span> clipped</span>
<span id="cb29-19"><a href="#cb29-19" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">focal_max</span>({</span>
<span id="cb29-20"><a href="#cb29-20" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;radius&#39;</span><span class="op">:</span><span class="dv">30</span><span class="op">,</span></span>
<span id="cb29-21"><a href="#cb29-21" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;units&#39;</span><span class="op">:</span> <span class="st">&#39;meters&#39;</span><span class="op">,</span></span>
<span id="cb29-22"><a href="#cb29-22" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;kernelType&#39;</span><span class="op">:</span> <span class="st">&#39;square&#39;</span>})</span>
<span id="cb29-23"><a href="#cb29-23" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">focal_min</span>({</span>
<span id="cb29-24"><a href="#cb29-24" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;radius&#39;</span><span class="op">:</span><span class="dv">30</span><span class="op">,</span></span>
<span id="cb29-25"><a href="#cb29-25" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;units&#39;</span><span class="op">:</span> <span class="st">&#39;meters&#39;</span><span class="op">,</span></span>
<span id="cb29-26"><a href="#cb29-26" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;kernelType&#39;</span><span class="op">:</span> <span class="st">&#39;square&#39;</span>})<span class="op">;</span></span>
<span id="cb29-27"><a href="#cb29-27" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(waterProcessed<span class="op">,</span> visParams<span class="op">,</span> <span class="st">&#39;Surface Water (Processed)&#39;</span>)</span>
<span id="cb29-28"><a href="#cb29-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-29"><a href="#cb29-29" aria-hidden="true" tabindex="-1"></a><span class="co">// Exercise</span></span>
<span id="cb29-30"><a href="#cb29-30" aria-hidden="true" tabindex="-1"></a><span class="co">// Add an &#39;iterations&#39; parameter with value 2 to </span></span>
<span id="cb29-31"><a href="#cb29-31" aria-hidden="true" tabindex="-1"></a><span class="co">// focal_max and focal_min functions to further process the data</span></span></code></pre></div>
<p><a href="https://code.earthengine.google.com/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3A02-Surface_Water_Mapping%2F06c_Create_a_Surface_Water_Map_(exercise)" target="_blank">Try in Code Editor ↗</a></p>
</div>
</div>
<div id="convert-raster-to-vector" class="section level2">
<h2>07. Convert Raster to Vector</h2>
<p>After creating a final raster map, we can vectorize it. The <code>reduceToVectors</code> function should be used with <em>countEvery</em> reducer to convert a raster to a vector. This reducer will connect all linked pixels of the same class into a single feature and return a feature collection. By default, the connectedness of a pixel is checked in cardinal directions only. To check the connectedness of a pixel in the diagonal direction, <em>eightConnected</em> should be set as <em>true</em>.</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> gsw <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(<span class="st">&quot;JRC/GSW1_3/GlobalSurfaceWater&quot;</span>)<span class="op">;</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> hydrobasins <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">&quot;WWF/HydroSHEDS/v1/Basins/hybas_7&quot;</span>)<span class="op">;</span></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> basin <span class="op">=</span> hydrobasins<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;HYBAS_ID&#39;</span><span class="op">,</span> <span class="dv">4071139640</span>))</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> geometry <span class="op">=</span> basin<span class="op">.</span><span class="fu">geometry</span>()</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">centerObject</span>(geometry<span class="op">,</span> <span class="dv">10</span>)</span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> water <span class="op">=</span> gsw<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;max_extent&#39;</span>)<span class="op">;</span></span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> clipped <span class="op">=</span> water<span class="op">.</span><span class="fu">clip</span>(geometry)</span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> visParams <span class="op">=</span> {<span class="dt">min</span><span class="op">:</span><span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span><span class="dv">1</span><span class="op">,</span> <span class="dt">palette</span><span class="op">:</span> [<span class="st">&#39;white&#39;</span><span class="op">,</span><span class="st">&#39;blue&#39;</span>]}</span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(clipped<span class="op">,</span> visParams<span class="op">,</span> <span class="st">&#39;Surface Water&#39;</span><span class="op">,</span> <span class="kw">false</span>) </span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true" tabindex="-1"></a><span class="co">// Do unmask() to replace masked pixels with 0</span></span>
<span id="cb30-15"><a href="#cb30-15" aria-hidden="true" tabindex="-1"></a><span class="co">// This avoids extra pixels along the edges</span></span>
<span id="cb30-16"><a href="#cb30-16" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> clipped <span class="op">=</span> clipped<span class="op">.</span><span class="fu">unmask</span>(<span class="dv">0</span>)</span>
<span id="cb30-17"><a href="#cb30-17" aria-hidden="true" tabindex="-1"></a><span class="co">// Perform a morphological closing to fill holes in waterbodies</span></span>
<span id="cb30-18"><a href="#cb30-18" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> waterProcessed <span class="op">=</span> clipped</span>
<span id="cb30-19"><a href="#cb30-19" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">focal_max</span>({</span>
<span id="cb30-20"><a href="#cb30-20" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;radius&#39;</span><span class="op">:</span><span class="dv">30</span><span class="op">,</span></span>
<span id="cb30-21"><a href="#cb30-21" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;units&#39;</span><span class="op">:</span> <span class="st">&#39;meters&#39;</span><span class="op">,</span></span>
<span id="cb30-22"><a href="#cb30-22" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;kernelType&#39;</span><span class="op">:</span> <span class="st">&#39;square&#39;</span>})</span>
<span id="cb30-23"><a href="#cb30-23" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">focal_min</span>({</span>
<span id="cb30-24"><a href="#cb30-24" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;radius&#39;</span><span class="op">:</span><span class="dv">30</span><span class="op">,</span></span>
<span id="cb30-25"><a href="#cb30-25" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;units&#39;</span><span class="op">:</span> <span class="st">&#39;meters&#39;</span><span class="op">,</span></span>
<span id="cb30-26"><a href="#cb30-26" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;kernelType&#39;</span><span class="op">:</span> <span class="st">&#39;square&#39;</span>})<span class="op">;</span></span>
<span id="cb30-27"><a href="#cb30-27" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb30-28"><a href="#cb30-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-29"><a href="#cb30-29" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> vector <span class="op">=</span> waterProcessed<span class="op">.</span><span class="fu">reduceToVectors</span>({</span>
<span id="cb30-30"><a href="#cb30-30" aria-hidden="true" tabindex="-1"></a>  <span class="dt">reducer</span><span class="op">:</span> ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">countEvery</span>()<span class="op">,</span></span>
<span id="cb30-31"><a href="#cb30-31" aria-hidden="true" tabindex="-1"></a>  <span class="dt">geometry</span><span class="op">:</span> geometry<span class="op">,</span></span>
<span id="cb30-32"><a href="#cb30-32" aria-hidden="true" tabindex="-1"></a>  <span class="dt">scale</span><span class="op">:</span> <span class="dv">30</span><span class="op">,</span></span>
<span id="cb30-33"><a href="#cb30-33" aria-hidden="true" tabindex="-1"></a>  <span class="dt">maxPixels</span><span class="op">:</span> <span class="fl">1e10</span><span class="op">,</span></span>
<span id="cb30-34"><a href="#cb30-34" aria-hidden="true" tabindex="-1"></a>  <span class="dt">eightConnected</span><span class="op">:</span> <span class="kw">false</span></span>
<span id="cb30-35"><a href="#cb30-35" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb30-36"><a href="#cb30-36" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> visParams <span class="op">=</span> {<span class="dt">color</span><span class="op">:</span> <span class="st">&#39;blue&#39;</span>}</span>
<span id="cb30-37"><a href="#cb30-37" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(vector<span class="op">,</span> visParams<span class="op">,</span> <span class="st">&#39;Surface Water Polygons&#39;</span>)  </span></code></pre></div>
<p><a href="https://code.earthengine.google.com/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3A02-Surface_Water_Mapping%2F07b_Convert_Raster_to_Vector_(complete)" target="_blank">Open in Code Editor ↗</a></p>
<div id="exercise-15" class="section level3">
<h3>Exercise</h3>
<p>The final feature collection will contain the class value from the pixel as the <em>label</em> property. Since the raster is a binary image with 0 - 1 value, the label with value 1 will represent the water bodies.</p>
<p>Use the <em>eq</em> filter and filter the water bodies alone.</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> gsw <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(<span class="st">&quot;JRC/GSW1_3/GlobalSurfaceWater&quot;</span>)<span class="op">;</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> hydrobasins <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">&quot;WWF/HydroSHEDS/v1/Basins/hybas_7&quot;</span>)<span class="op">;</span></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> basin <span class="op">=</span> hydrobasins<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;HYBAS_ID&#39;</span><span class="op">,</span> <span class="dv">4071139640</span>))</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> geometry <span class="op">=</span> basin<span class="op">.</span><span class="fu">geometry</span>()</span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">centerObject</span>(geometry<span class="op">,</span> <span class="dv">10</span>)</span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> water <span class="op">=</span> gsw<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;max_extent&#39;</span>)<span class="op">;</span></span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> clipped <span class="op">=</span> water<span class="op">.</span><span class="fu">clip</span>(geometry)</span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> visParams <span class="op">=</span> {<span class="dt">min</span><span class="op">:</span><span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span><span class="dv">1</span><span class="op">,</span> <span class="dt">palette</span><span class="op">:</span> [<span class="st">&#39;white&#39;</span><span class="op">,</span><span class="st">&#39;blue&#39;</span>]}</span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(clipped<span class="op">,</span> visParams<span class="op">,</span> <span class="st">&#39;Surface Water&#39;</span><span class="op">,</span> <span class="kw">false</span>) </span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-14"><a href="#cb31-14" aria-hidden="true" tabindex="-1"></a><span class="co">// Do unmask() to replace masked pixels with 0</span></span>
<span id="cb31-15"><a href="#cb31-15" aria-hidden="true" tabindex="-1"></a><span class="co">// This avoids extra pixels along the edges</span></span>
<span id="cb31-16"><a href="#cb31-16" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> clipped <span class="op">=</span> clipped<span class="op">.</span><span class="fu">unmask</span>(<span class="dv">0</span>)</span>
<span id="cb31-17"><a href="#cb31-17" aria-hidden="true" tabindex="-1"></a><span class="co">// Perform a morphological closing to fill holes in waterbodies</span></span>
<span id="cb31-18"><a href="#cb31-18" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> waterProcessed <span class="op">=</span> clipped</span>
<span id="cb31-19"><a href="#cb31-19" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">focal_max</span>({</span>
<span id="cb31-20"><a href="#cb31-20" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;radius&#39;</span><span class="op">:</span><span class="dv">30</span><span class="op">,</span></span>
<span id="cb31-21"><a href="#cb31-21" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;units&#39;</span><span class="op">:</span> <span class="st">&#39;meters&#39;</span><span class="op">,</span></span>
<span id="cb31-22"><a href="#cb31-22" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;kernelType&#39;</span><span class="op">:</span> <span class="st">&#39;square&#39;</span>})</span>
<span id="cb31-23"><a href="#cb31-23" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">focal_min</span>({</span>
<span id="cb31-24"><a href="#cb31-24" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;radius&#39;</span><span class="op">:</span><span class="dv">30</span><span class="op">,</span></span>
<span id="cb31-25"><a href="#cb31-25" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;units&#39;</span><span class="op">:</span> <span class="st">&#39;meters&#39;</span><span class="op">,</span></span>
<span id="cb31-26"><a href="#cb31-26" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;kernelType&#39;</span><span class="op">:</span> <span class="st">&#39;square&#39;</span>})<span class="op">;</span></span>
<span id="cb31-27"><a href="#cb31-27" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-28"><a href="#cb31-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-29"><a href="#cb31-29" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> vector <span class="op">=</span> waterProcessed<span class="op">.</span><span class="fu">reduceToVectors</span>({</span>
<span id="cb31-30"><a href="#cb31-30" aria-hidden="true" tabindex="-1"></a>  <span class="dt">reducer</span><span class="op">:</span> ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">countEvery</span>()<span class="op">,</span></span>
<span id="cb31-31"><a href="#cb31-31" aria-hidden="true" tabindex="-1"></a>  <span class="dt">geometry</span><span class="op">:</span> geometry<span class="op">,</span></span>
<span id="cb31-32"><a href="#cb31-32" aria-hidden="true" tabindex="-1"></a>  <span class="dt">scale</span><span class="op">:</span> <span class="dv">30</span><span class="op">,</span></span>
<span id="cb31-33"><a href="#cb31-33" aria-hidden="true" tabindex="-1"></a>  <span class="dt">maxPixels</span><span class="op">:</span> <span class="fl">1e10</span><span class="op">,</span></span>
<span id="cb31-34"><a href="#cb31-34" aria-hidden="true" tabindex="-1"></a>  <span class="dt">eightConnected</span><span class="op">:</span> <span class="kw">false</span></span>
<span id="cb31-35"><a href="#cb31-35" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb31-36"><a href="#cb31-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-37"><a href="#cb31-37" aria-hidden="true" tabindex="-1"></a><span class="co">// Exercise</span></span>
<span id="cb31-38"><a href="#cb31-38" aria-hidden="true" tabindex="-1"></a><span class="co">// The vector variable is a FeatureCollection</span></span>
<span id="cb31-39"><a href="#cb31-39" aria-hidden="true" tabindex="-1"></a><span class="co">// It contains polygons for both water and non-water areas</span></span>
<span id="cb31-40"><a href="#cb31-40" aria-hidden="true" tabindex="-1"></a><span class="co">// Apply a filter to select only water polygons</span></span>
<span id="cb31-41"><a href="#cb31-41" aria-hidden="true" tabindex="-1"></a><span class="co">// Display the results on the map</span></span>
<span id="cb31-42"><a href="#cb31-42" aria-hidden="true" tabindex="-1"></a><span class="co">// Hint: Use ee.Filter.eq() on the &#39;label&#39; property</span></span>
<span id="cb31-43"><a href="#cb31-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-44"><a href="#cb31-44" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> visParams <span class="op">=</span> {<span class="dt">color</span><span class="op">:</span> <span class="st">&#39;blue&#39;</span>}</span></code></pre></div>
<p><a href="https://code.earthengine.google.com/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3A02-Surface_Water_Mapping%2F07c_Convert_Raster_to_Vector_(exercise)" target="_blank">Try in Code Editor ↗</a></p>
</div>
</div>
</div>
<div id="module-3-precipitation-time-series-analysis" class="section level1">
<h1>Module 3: Precipitation Time Series Analysis</h1>
<p>The main advantage of the gridded precipitation dataset is that they offer a consistent long-term time-series. We will cover the basics of gridded rainfall datasets, how to aggregate them to the requirement temporal resolution and prepare a time-series for trend analysis.</p>
<p><a href="https://docs.google.com/presentation/d/1G-v9Nz90DGGQ2OfTPxwD5j-HspPcIYUu9UB-nkNnGn4/edit?usp=sharing" target="_blank"><img src="images/gee_water_resources_management/precipitation_time_series.png" width="400" alt="View Presentation" /></a></p>
<p><a href="https://docs.google.com/presentation/d/1G-v9Nz90DGGQ2OfTPxwD5j-HspPcIYUu9UB-nkNnGn4/edit?usp=sharing" target="_blank">View the Presentation ↗</a></p>
<p>But to fully leverage the computation power of Earth Engine for our analysis, we must first learn about techniques for writing efficient paralell computing code. The Earth Engine API uses <a href="https://en.wikipedia.org/wiki/MapReduce">Map/Reduce</a> paradigm for parallel computing.</p>
<p>In this module, we will first learn about earth engine objects, creating user-defined functions, mapping a function, and using reducers. We will then apply these technique to create a time series chart and carry out spatio-temporal trend analysis of precipitation.</p>
<p><a href="https://docs.google.com/presentation/d/1F_yRyBkItQdpbm-TXOTc4CkMXxynulfKY2p1TG0xS-g/edit?usp=sharing" target="_blank"><img src="images/gee_water_resources_management/map_reduce.png" width="400" alt="View Presentation" /></a></p>
<p><a href="https://docs.google.com/presentation/d/1F_yRyBkItQdpbm-TXOTc4CkMXxynulfKY2p1TG0xS-g/edit?usp=sharing" target="_blank">View the Presentation ↗</a></p>
<div id="mapping-a-function" class="section level2">
<h2>01. Mapping a Function</h2>
<p>This script introduces the basics of the Earth Engine API. Here we map a list of objects over a function to perform a task on all the objects. While defining a function, it should return a result after computation, which can be stored in a variable. To learn more, visit the <a href="https://developers.google.com/earth-engine/tutorial_js_02">Earth Engine Objects and Methods</a> section of the Earth Engine User Guide.</p>
<p>Apart from other regular strings and numbers, the earth engine can understand dates. Under <code>ee.Date</code> there are many functions by which dates can be defined or converted from one format to another.</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Let&#39;s see how to take a list of numbers and add 1 to each element</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> myList <span class="op">=</span> ee<span class="op">.</span><span class="at">List</span><span class="op">.</span><span class="fu">sequence</span>(<span class="dv">1</span><span class="op">,</span> <span class="dv">10</span>)<span class="op">;</span></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a><span class="co">// Define a function that takes a number and adds 1 to it</span></span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> myFunction <span class="op">=</span> <span class="kw">function</span>(number) {</span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> number <span class="op">+</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">myFunction</span>(<span class="dv">1</span>))<span class="op">;</span></span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a><span class="co">//Re-Define a function using Earth Engine API</span></span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> myFunction <span class="op">=</span> <span class="kw">function</span>(number) { </span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> ee<span class="op">.</span><span class="fu">Number</span>(number)<span class="op">.</span><span class="fu">add</span>(<span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a><span class="co">// Map the function of the list</span></span>
<span id="cb32-16"><a href="#cb32-16" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> newList <span class="op">=</span> myList<span class="op">.</span><span class="fu">map</span>(myFunction)<span class="op">;</span></span>
<span id="cb32-17"><a href="#cb32-17" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(newList)<span class="op">;</span> </span>
<span id="cb32-18"><a href="#cb32-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-19"><a href="#cb32-19" aria-hidden="true" tabindex="-1"></a><span class="co">// Let&#39;s write another function to square a number</span></span>
<span id="cb32-20"><a href="#cb32-20" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> squareNumber <span class="op">=</span> <span class="kw">function</span>(number) {</span>
<span id="cb32-21"><a href="#cb32-21" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> ee<span class="op">.</span><span class="fu">Number</span>(number)<span class="op">.</span><span class="fu">pow</span>(<span class="dv">2</span>)</span>
<span id="cb32-22"><a href="#cb32-22" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb32-23"><a href="#cb32-23" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> squares <span class="op">=</span> myList<span class="op">.</span><span class="fu">map</span>(squareNumber)</span>
<span id="cb32-24"><a href="#cb32-24" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(squares)</span>
<span id="cb32-25"><a href="#cb32-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-26"><a href="#cb32-26" aria-hidden="true" tabindex="-1"></a><span class="co">// Extracting value from a list</span></span>
<span id="cb32-27"><a href="#cb32-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-28"><a href="#cb32-28" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> value <span class="op">=</span> newList<span class="op">.</span><span class="fu">get</span>(<span class="dv">0</span>)</span>
<span id="cb32-29"><a href="#cb32-29" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(value)</span>
<span id="cb32-30"><a href="#cb32-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-31"><a href="#cb32-31" aria-hidden="true" tabindex="-1"></a><span class="co">// Casting</span></span>
<span id="cb32-32"><a href="#cb32-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-33"><a href="#cb32-33" aria-hidden="true" tabindex="-1"></a><span class="co">// Let&#39;s try to do some computation on the extracted value</span></span>
<span id="cb32-34"><a href="#cb32-34" aria-hidden="true" tabindex="-1"></a><span class="co">//var newValue = value.add(1)</span></span>
<span id="cb32-35"><a href="#cb32-35" aria-hidden="true" tabindex="-1"></a><span class="co">//print(newValue)</span></span>
<span id="cb32-36"><a href="#cb32-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-37"><a href="#cb32-37" aria-hidden="true" tabindex="-1"></a><span class="co">// You get an error because Earth Engine doesn&#39;t know what is the type of &#39;value&#39;</span></span>
<span id="cb32-38"><a href="#cb32-38" aria-hidden="true" tabindex="-1"></a><span class="co">// We need to cast it to appropriate type first</span></span>
<span id="cb32-39"><a href="#cb32-39" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> value <span class="op">=</span> ee<span class="op">.</span><span class="fu">Number</span>(value)</span>
<span id="cb32-40"><a href="#cb32-40" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> newValue <span class="op">=</span> value<span class="op">.</span><span class="fu">add</span>(<span class="dv">1</span>)</span>
<span id="cb32-41"><a href="#cb32-41" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(newValue)</span>
<span id="cb32-42"><a href="#cb32-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-43"><a href="#cb32-43" aria-hidden="true" tabindex="-1"></a><span class="co">// Dates</span></span>
<span id="cb32-44"><a href="#cb32-44" aria-hidden="true" tabindex="-1"></a><span class="co">// For any date computation, you should use ee.Date module</span></span>
<span id="cb32-45"><a href="#cb32-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-46"><a href="#cb32-46" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> date <span class="op">=</span> ee<span class="op">.</span><span class="at">Date</span><span class="op">.</span><span class="fu">fromYMD</span>(<span class="dv">2019</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">1</span>)</span>
<span id="cb32-47"><a href="#cb32-47" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> futureDate <span class="op">=</span> date<span class="op">.</span><span class="fu">advance</span>(<span class="dv">1</span><span class="op">,</span> <span class="st">&#39;year&#39;</span>)</span>
<span id="cb32-48"><a href="#cb32-48" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(futureDate) </span></code></pre></div>
<p><a href="https://code.earthengine.google.co.in/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3A03-Time_Series_Analysis%2F01b_Mapping_a_Function_(complete)" target="_blank">Open in Code Editor ↗</a></p>
<div id="exercise-16" class="section level3">
<h3>Exercise</h3>
<p>Define the function <code>createDate</code>, map the <code>weeks</code> list as input. The function should return dates incremented by the week number.</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> startDate <span class="op">=</span> ee<span class="op">.</span><span class="at">Date</span><span class="op">.</span><span class="fu">fromYMD</span>(<span class="dv">2019</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">1</span>)</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a><span class="co">// Exercise</span></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a><span class="co">// Create a list of dates for start of every week of the year</span></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a><span class="co">// We first create a list of week numbers </span></span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> weeks <span class="op">=</span> ee<span class="op">.</span><span class="at">List</span><span class="op">.</span><span class="fu">sequence</span>(<span class="dv">0</span><span class="op">,</span> <span class="dv">51</span>)</span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a><span class="co">// Write a function that takes a week number &#39;n&#39;</span></span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a><span class="co">// and returns a date &#39;n&#39; weeks in advance.</span></span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> createDate <span class="op">=</span> <span class="kw">function</span>(n) {</span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Use the .advance() function to find the date &#39;n&#39; weeks from start</span></span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb33-14"><a href="#cb33-14" aria-hidden="true" tabindex="-1"></a><span class="co">// map() the function on list of weeks</span></span>
<span id="cb33-15"><a href="#cb33-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-16"><a href="#cb33-16" aria-hidden="true" tabindex="-1"></a><span class="co">// print the result</span></span></code></pre></div>
<p><a href="https://code.earthengine.google.co.in/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3A03-Time_Series_Analysis%2F01c_Mapping_a_Function_(exercise)" target="_blank">Try in Code Editor ↗</a></p>
</div>
</div>
<div id="reducers" class="section level2">
<h2>02. Reducers</h2>
<p>A <em>Reduce</em> operation allows you to compute statistics on a large amount of inputs. In Earth Engine, you need to run reduction operation when creating composites, calculating statistics, doing regression analysis etc. The Earth Engine API comes with a large number of built-in reducer functions (such as <code>ee.Reducer.sum()</code>, <code>ee.Reducer.histogram()</code>, <code>ee.Reducer.linearFit()</code> etc.) that can perform a variety of statistical operations on input data. You can run reducers using the <code>reduce()</code> function. Earth Engine supports running reducers on all data structures that can hold multiple values, such as Images (reducers run on different bands), ImageCollection, FeatureCollection, List, Dictionary etc. The script below introduces basic concepts related to reducers.</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> geometry <span class="op">=</span> ee<span class="op">.</span><span class="at">Geometry</span><span class="op">.</span><span class="fu">Point</span>([<span class="fl">77.60412933051538</span><span class="op">,</span> <span class="fl">12.952912912328241</span>])</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> s2 <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&quot;COPERNICUS/S2&quot;</span>)<span class="op">;</span></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a><span class="co">// Computing stats on a list</span></span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> myList <span class="op">=</span> ee<span class="op">.</span><span class="at">List</span><span class="op">.</span><span class="fu">sequence</span>(<span class="dv">1</span><span class="op">,</span> <span class="dv">10</span>)<span class="op">;</span></span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(myList)</span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a><span class="co">// Use a reducer to compute min and max in the list</span></span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> mean <span class="op">=</span> myList<span class="op">.</span><span class="fu">reduce</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">mean</span>())<span class="op">;</span></span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(mean)<span class="op">;</span></span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-12"><a href="#cb34-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-13"><a href="#cb34-13" aria-hidden="true" tabindex="-1"></a><span class="co">// Apply a reducer on a image collection</span></span>
<span id="cb34-14"><a href="#cb34-14" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> filtered <span class="op">=</span> s2<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">lt</span>(<span class="st">&#39;CLOUDY_PIXEL_PERCENTAGE&#39;</span><span class="op">,</span> <span class="dv">30</span>))</span>
<span id="cb34-15"><a href="#cb34-15" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(<span class="st">&#39;2019-01-01&#39;</span><span class="op">,</span> <span class="st">&#39;2020-01-01&#39;</span>))</span>
<span id="cb34-16"><a href="#cb34-16" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">bounds</span>(geometry))</span>
<span id="cb34-17"><a href="#cb34-17" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;B.*&#39;</span>)</span>
<span id="cb34-18"><a href="#cb34-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-19"><a href="#cb34-19" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(filtered<span class="op">.</span><span class="fu">size</span>())</span>
<span id="cb34-20"><a href="#cb34-20" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> collMean <span class="op">=</span> filtered<span class="op">.</span><span class="fu">reduce</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">mean</span>())<span class="op">;</span></span>
<span id="cb34-21"><a href="#cb34-21" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="st">&#39;Reducer on Collection&#39;</span><span class="op">,</span> collMean)<span class="op">;</span></span>
<span id="cb34-22"><a href="#cb34-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-23"><a href="#cb34-23" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> image <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(filtered<span class="op">.</span><span class="fu">first</span>())</span>
<span id="cb34-24"><a href="#cb34-24" aria-hidden="true" tabindex="-1"></a><span class="co">// If we want to compute min and max for each band, use reduceRegion instead</span></span>
<span id="cb34-25"><a href="#cb34-25" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> stats <span class="op">=</span> image<span class="op">.</span><span class="fu">reduceRegion</span>({</span>
<span id="cb34-26"><a href="#cb34-26" aria-hidden="true" tabindex="-1"></a>  <span class="dt">reducer</span><span class="op">:</span> ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">mean</span>()<span class="op">,</span></span>
<span id="cb34-27"><a href="#cb34-27" aria-hidden="true" tabindex="-1"></a>  <span class="dt">geometry</span><span class="op">:</span> image<span class="op">.</span><span class="fu">geometry</span>()<span class="op">,</span></span>
<span id="cb34-28"><a href="#cb34-28" aria-hidden="true" tabindex="-1"></a>  <span class="dt">scale</span><span class="op">:</span> <span class="dv">100</span><span class="op">,</span></span>
<span id="cb34-29"><a href="#cb34-29" aria-hidden="true" tabindex="-1"></a>  <span class="dt">maxPixels</span><span class="op">:</span> <span class="fl">1e10</span></span>
<span id="cb34-30"><a href="#cb34-30" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb34-31"><a href="#cb34-31" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(stats)<span class="op">;</span></span></code></pre></div>
<p><a href="https://code.earthengine.google.co.in/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3A03-Time_Series_Analysis%2F02b_Reducers_(complete)" target="_blank">Open in Code Editor ↗</a></p>
<div id="exercise-17" class="section level3">
<h3>Exercise</h3>
<div class="sourceCode" id="cb35"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> geometry <span class="op">=</span> ee<span class="op">.</span><span class="at">Geometry</span><span class="op">.</span><span class="fu">Point</span>([<span class="fl">77.60412933051538</span><span class="op">,</span> <span class="fl">12.952912912328241</span>])</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> s2 <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&quot;COPERNICUS/S2&quot;</span>)<span class="op">;</span></span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a><span class="co">// Apply a reducer on a image collection</span></span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> filtered <span class="op">=</span> s2<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">lt</span>(<span class="st">&#39;CLOUDY_PIXEL_PERCENTAGE&#39;</span><span class="op">,</span> <span class="dv">30</span>))</span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(<span class="st">&#39;2019-01-01&#39;</span><span class="op">,</span> <span class="st">&#39;2020-01-01&#39;</span>))</span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">bounds</span>(geometry))</span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;B.*&#39;</span>)</span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> image <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(filtered<span class="op">.</span><span class="fu">first</span>())</span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true" tabindex="-1"></a><span class="co">// Compute the &#39;mean&#39; of each band</span></span>
<span id="cb35-13"><a href="#cb35-13" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> stats <span class="op">=</span> image<span class="op">.</span><span class="fu">reduceRegion</span>({</span>
<span id="cb35-14"><a href="#cb35-14" aria-hidden="true" tabindex="-1"></a>  <span class="dt">reducer</span><span class="op">:</span> ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">mean</span>()<span class="op">,</span></span>
<span id="cb35-15"><a href="#cb35-15" aria-hidden="true" tabindex="-1"></a>  <span class="dt">geometry</span><span class="op">:</span> image<span class="op">.</span><span class="fu">geometry</span>()<span class="op">,</span></span>
<span id="cb35-16"><a href="#cb35-16" aria-hidden="true" tabindex="-1"></a>  <span class="dt">scale</span><span class="op">:</span> <span class="dv">100</span><span class="op">,</span></span>
<span id="cb35-17"><a href="#cb35-17" aria-hidden="true" tabindex="-1"></a>  <span class="dt">maxPixels</span><span class="op">:</span> <span class="fl">1e10</span></span>
<span id="cb35-18"><a href="#cb35-18" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb35-19"><a href="#cb35-19" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(stats)<span class="op">;</span></span>
<span id="cb35-20"><a href="#cb35-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-21"><a href="#cb35-21" aria-hidden="true" tabindex="-1"></a><span class="co">// Extract the average value for B8 and print it.</span></span>
<span id="cb35-22"><a href="#cb35-22" aria-hidden="true" tabindex="-1"></a><span class="co">// Tip: Result of reduceRegion is a dictionary. </span></span></code></pre></div>
<p><a href="https://code.earthengine.google.co.in/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3A03-Time_Series_Analysis%2F02c_Reducers_(exercise)" target="_blank">Try in Code Editor ↗</a></p>
</div>
</div>
<div id="calculating-total-rainfall" class="section level2">
<h2>03. Calculating Total Rainfall</h2>
<p>The CHIRPS Pentad is 5 days composite of rainfall at ~6 km spatial resolution. To compute this data, both satellite and grounds values are considered. To read more about the methodology, visit <a href="https://www.nature.com/articles/sdata201566">nature.com</a></p>
<p>Using this image collection, lets filter all the images for 2017. To get a yearly rainfall we can reduce the collection using <code>reduce</code> function with <em>sum</em> reducer. This will return a single global image where each pixel represent the total annual rainfall value in <em>mm</em> at that location. Now to get a annual average rainfall at a particular region of interest, we can do a <code>reduceRegions</code> with a <em>mean</em> reducer over the region. This reducer will reduce the region’s image and return a dictionary. The dictionary will contain the average value of all the bands in the image, which can be extracted using the <em>get</em> function.</p>
<div class="sourceCode" id="cb36"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> geometry <span class="op">=</span> ee<span class="op">.</span><span class="at">Geometry</span><span class="op">.</span><span class="fu">Polygon</span>([[[<span class="fl">77.4383382656616</span><span class="op">,</span> <span class="fl">13.049764921558324</span>]<span class="op">,</span></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>          [<span class="fl">77.4383382656616</span><span class="op">,</span> <span class="fl">12.814196240882762</span>]<span class="op">,</span></span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>          [<span class="fl">77.72123621488035</span><span class="op">,</span> <span class="fl">12.814196240882762</span>]<span class="op">,</span></span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>          [<span class="fl">77.72123621488035</span><span class="op">,</span> <span class="fl">13.049764921558324</span>]]])</span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(geometry<span class="op">,</span> {}<span class="op">,</span> <span class="st">&#39;ROI&#39;</span>)</span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> chirps <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&quot;UCSB-CHG/CHIRPS/PENTAD&quot;</span>)</span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> startDate <span class="op">=</span> ee<span class="op">.</span><span class="at">Date</span><span class="op">.</span><span class="fu">fromYMD</span>(<span class="dv">2017</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span><span class="dv">1</span>)</span>
<span id="cb36-12"><a href="#cb36-12" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> endDate <span class="op">=</span> startDate<span class="op">.</span><span class="fu">advance</span>(<span class="dv">1</span><span class="op">,</span> <span class="st">&#39;year&#39;</span>)</span>
<span id="cb36-13"><a href="#cb36-13" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> filtered <span class="op">=</span> chirps</span>
<span id="cb36-14"><a href="#cb36-14" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(startDate<span class="op">,</span> endDate))</span>
<span id="cb36-15"><a href="#cb36-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-16"><a href="#cb36-16" aria-hidden="true" tabindex="-1"></a><span class="co">// Calculate yearly rainfall</span></span>
<span id="cb36-17"><a href="#cb36-17" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> total <span class="op">=</span> filtered<span class="op">.</span><span class="fu">reduce</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">sum</span>())</span>
<span id="cb36-18"><a href="#cb36-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-19"><a href="#cb36-19" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> palette <span class="op">=</span> [<span class="st">&#39;#ffffcc&#39;</span><span class="op">,</span><span class="st">&#39;#a1dab4&#39;</span><span class="op">,</span><span class="st">&#39;#41b6c4&#39;</span><span class="op">,</span><span class="st">&#39;#2c7fb8&#39;</span><span class="op">,</span><span class="st">&#39;#253494&#39;</span>]</span>
<span id="cb36-20"><a href="#cb36-20" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> visParams <span class="op">=</span> {</span>
<span id="cb36-21"><a href="#cb36-21" aria-hidden="true" tabindex="-1"></a>  <span class="dt">min</span><span class="op">:</span><span class="dv">0</span><span class="op">,</span></span>
<span id="cb36-22"><a href="#cb36-22" aria-hidden="true" tabindex="-1"></a>  <span class="dt">max</span><span class="op">:</span> <span class="dv">2000</span><span class="op">,</span></span>
<span id="cb36-23"><a href="#cb36-23" aria-hidden="true" tabindex="-1"></a>  <span class="dt">palette</span><span class="op">:</span> palette</span>
<span id="cb36-24"><a href="#cb36-24" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb36-25"><a href="#cb36-25" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(total<span class="op">,</span> visParams<span class="op">,</span> <span class="st">&#39;Total Precipitation&#39;</span>)</span>
<span id="cb36-26"><a href="#cb36-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-27"><a href="#cb36-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-28"><a href="#cb36-28" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">centerObject</span>(geometry<span class="op">,</span> <span class="dv">10</span>)</span>
<span id="cb36-29"><a href="#cb36-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-30"><a href="#cb36-30" aria-hidden="true" tabindex="-1"></a><span class="co">// Calculate average rainfall across a basin</span></span>
<span id="cb36-31"><a href="#cb36-31" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> stats <span class="op">=</span> total<span class="op">.</span><span class="fu">reduceRegion</span>({</span>
<span id="cb36-32"><a href="#cb36-32" aria-hidden="true" tabindex="-1"></a>  <span class="dt">reducer</span><span class="op">:</span> ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">mean</span>()<span class="op">,</span></span>
<span id="cb36-33"><a href="#cb36-33" aria-hidden="true" tabindex="-1"></a>  <span class="dt">geometry</span><span class="op">:</span> geometry<span class="op">,</span></span>
<span id="cb36-34"><a href="#cb36-34" aria-hidden="true" tabindex="-1"></a>  <span class="dt">scale</span><span class="op">:</span> <span class="dv">5000</span><span class="op">,</span></span>
<span id="cb36-35"><a href="#cb36-35" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb36-36"><a href="#cb36-36" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(stats)</span>
<span id="cb36-37"><a href="#cb36-37" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="st">&#39;Average rainfall across ROI :&#39;</span><span class="op">,</span> stats<span class="op">.</span><span class="fu">get</span>(<span class="st">&#39;precipitation_sum&#39;</span>))</span></code></pre></div>
<p><a href="https://code.earthengine.google.co.in/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3A03-Time_Series_Analysis%2F03b_Calculating_Total_Rainfall_(complete)" target="_blank">Open in Code Editor ↗</a></p>
<p>Output</p>
<pre><code>Average rainfall across ROI :
1345.867775034789</code></pre>
<div id="exercise-18" class="section level3">
<h3>Exercise</h3>
<p>Update the date rage for monsoon season(1 June - 30 September) in India.</p>
<div class="sourceCode" id="cb38"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Update the script to calculate total rainfall for the monsoon season</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a><span class="co">// Monsoon season in India is from 1 June - 30 September</span></span></code></pre></div>
<p><a href="https://code.earthengine.google.co.in/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3A03-Time_Series_Analysis%2F03c_Calculating_Total_Rainfall_(exercise)" target="_blank">Try in Code Editor ↗</a></p>
</div>
</div>
<div id="aggregating-time-series" class="section level2">
<h2>04. Aggregating Time Series</h2>
<p>In the previous exercise, we aggregated to get the average rainfall across a region. Let’s compute a time series representing the total rainfall of each month in 2019.</p>
<p>Earth Engine has a function called <code>ee.Date.fromYMD</code> to create a date from <em>Year</em>, <em>Month</em>, and <em>Date</em>. Using this function and <code>.advance()</code>, we can create the filter date to filter the image collection to a particular month. Then with <code>reduce</code> function with <em>sum</em> as reducer, the monthly image collection is aggregated to the monthly total image. This newly created image won’t have any properties. Hence using the <code>.set()</code> function, we have to assign the <em>Year</em>, <em>Month</em>, <em>system:time_start</em>, and <em>system:time_end</em> properties. With the above procedure in the sequence, we can create a function to input the month’s number and return the monthly total precipitation image.</p>
<p>We can create the month’s list using <code>ee.List.sequence</code> and map it to the function built. Since the mapped object is of type List, the resultant will also be a list with 12 images. This list of images can be converted back as Image Collection using <code>ee.ImageCollection.fromYMD</code>. Once we have the collection print, it will contain 12 images representing the month’s total precipitation.</p>
<blockquote>
<p>The <em>system:time_start</em> is a unique property that the earth engine can natively understand. It is the <a href="https://en.wikipedia.org/wiki/Unix_time">Unix Timestamp</a> that is used to create a time series chart.</p>
</blockquote>
<div class="sourceCode" id="cb39"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> chirps <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&quot;UCSB-CHG/CHIRPS/PENTAD&quot;</span>)</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> year <span class="op">=</span> <span class="dv">2019</span></span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> startDate <span class="op">=</span> ee<span class="op">.</span><span class="at">Date</span><span class="op">.</span><span class="fu">fromYMD</span>(year<span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">1</span>)</span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> endDate <span class="op">=</span> startDate<span class="op">.</span><span class="fu">advance</span>(<span class="dv">1</span><span class="op">,</span> <span class="st">&#39;year&#39;</span>)</span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> yearFiltered <span class="op">=</span> chirps</span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(startDate<span class="op">,</span> endDate))</span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a><span class="co">// CHIRPS collection has 1 image for every pentad (5-days)</span></span>
<span id="cb39-10"><a href="#cb39-10" aria-hidden="true" tabindex="-1"></a><span class="co">// The collection is filtered for 1 year and the time-series</span></span>
<span id="cb39-11"><a href="#cb39-11" aria-hidden="true" tabindex="-1"></a><span class="co">// now has 72 images</span></span>
<span id="cb39-12"><a href="#cb39-12" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(yearFiltered)</span>
<span id="cb39-13"><a href="#cb39-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-14"><a href="#cb39-14" aria-hidden="true" tabindex="-1"></a><span class="co">// We need to aggregate this time series to compute</span></span>
<span id="cb39-15"><a href="#cb39-15" aria-hidden="true" tabindex="-1"></a><span class="co">// monthly images</span></span>
<span id="cb39-16"><a href="#cb39-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-17"><a href="#cb39-17" aria-hidden="true" tabindex="-1"></a><span class="co">// Create a list of months</span></span>
<span id="cb39-18"><a href="#cb39-18" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> months <span class="op">=</span> ee<span class="op">.</span><span class="at">List</span><span class="op">.</span><span class="fu">sequence</span>(<span class="dv">1</span><span class="op">,</span> <span class="dv">12</span>)</span>
<span id="cb39-19"><a href="#cb39-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-20"><a href="#cb39-20" aria-hidden="true" tabindex="-1"></a><span class="co">// Write a function that takes a month number</span></span>
<span id="cb39-21"><a href="#cb39-21" aria-hidden="true" tabindex="-1"></a><span class="co">// and returns a monthly image</span></span>
<span id="cb39-22"><a href="#cb39-22" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> createMonthlyImage <span class="op">=</span> <span class="kw">function</span>(month) {</span>
<span id="cb39-23"><a href="#cb39-23" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> startDate <span class="op">=</span> ee<span class="op">.</span><span class="at">Date</span><span class="op">.</span><span class="fu">fromYMD</span>(year<span class="op">,</span> month<span class="op">,</span> <span class="dv">1</span>)</span>
<span id="cb39-24"><a href="#cb39-24" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> endDate <span class="op">=</span> startDate<span class="op">.</span><span class="fu">advance</span>(<span class="dv">1</span><span class="op">,</span> <span class="st">&#39;month&#39;</span>)</span>
<span id="cb39-25"><a href="#cb39-25" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> monthFiltered <span class="op">=</span> yearFiltered</span>
<span id="cb39-26"><a href="#cb39-26" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(startDate<span class="op">,</span> endDate))</span>
<span id="cb39-27"><a href="#cb39-27" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Calculate total precipitation</span></span>
<span id="cb39-28"><a href="#cb39-28" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> total <span class="op">=</span> monthFiltered<span class="op">.</span><span class="fu">reduce</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">sum</span>())</span>
<span id="cb39-29"><a href="#cb39-29" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> total<span class="op">.</span><span class="fu">set</span>({</span>
<span id="cb39-30"><a href="#cb39-30" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;system:time_start&#39;</span><span class="op">:</span> startDate<span class="op">.</span><span class="fu">millis</span>()<span class="op">,</span></span>
<span id="cb39-31"><a href="#cb39-31" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;system:time_end&#39;</span><span class="op">:</span> endDate<span class="op">.</span><span class="fu">millis</span>()<span class="op">,</span></span>
<span id="cb39-32"><a href="#cb39-32" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;year&#39;</span><span class="op">:</span> year<span class="op">,</span></span>
<span id="cb39-33"><a href="#cb39-33" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;month&#39;</span><span class="op">:</span> month})</span>
<span id="cb39-34"><a href="#cb39-34" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb39-35"><a href="#cb39-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-36"><a href="#cb39-36" aria-hidden="true" tabindex="-1"></a><span class="co">// map() the function on the list  of months</span></span>
<span id="cb39-37"><a href="#cb39-37" aria-hidden="true" tabindex="-1"></a><span class="co">// This creates a list with images for each month in the list</span></span>
<span id="cb39-38"><a href="#cb39-38" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> monthlyImages <span class="op">=</span> months<span class="op">.</span><span class="fu">map</span>(createMonthlyImage)</span>
<span id="cb39-39"><a href="#cb39-39" aria-hidden="true" tabindex="-1"></a><span class="co">// Create an imagecollection</span></span>
<span id="cb39-40"><a href="#cb39-40" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> monthlyCollection <span class="op">=</span> ee<span class="op">.</span><span class="at">ImageCollection</span><span class="op">.</span><span class="fu">fromImages</span>(monthlyImages)</span>
<span id="cb39-41"><a href="#cb39-41" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="st">&#39;Monthly Collection&#39;</span><span class="op">,</span> monthlyCollection)</span></code></pre></div>
<p><a href="https://code.earthengine.google.co.in/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3A03-Time_Series_Analysis%2F04b_Aggregating_Time_Series_(complete)" target="_blank">Open in Code Editor ↗</a></p>
<div id="exercise-19" class="section level3">
<h3>Exercise</h3>
<p>Filter the <code>monthlyCollection</code> for the months June, July, August and September.</p>
<div class="sourceCode" id="cb40"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Apply a filter to select images for the months</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a><span class="co">// June, July, August and September</span></span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a><span class="co">// Print the collection to verify</span></span></code></pre></div>
<p><a href="https://code.earthengine.google.co.in/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3A03-Time_Series_Analysis%2F04c_Aggregating_Time_Series_(exercise)" target="_blank">Try in Code Editor ↗</a></p>
</div>
</div>
<div id="charting-monthly-rainfall" class="section level2">
<h2>05. Charting Monthly Rainfall</h2>
<p>Now we can put together all the skills we have learned so far - filter, map, and reduce to create a chart of monthly total rainfall in the year 2019 over a region. Earth Engine API supports charting functions based on the Google Chart API. There are various charts to use, from which we use the <code>ui.Chart.image.series()</code> function to create a time-series chart.</p>
<p>Image series chart accepts an <em>image collection</em>, <em>geometry</em>, <em>scale</em>, and <em>reducer</em>. The geometry in the region of interest, reducer in the reduction operation the region of interest should be aggregated if the geometry is a polygon. Scale is the resolution at which the image should be reduced. Using <code>.setOptions</code>, we can customize the chart to our needs.</p>
<p>Charting itself is vast, and all function are self explanatory. Google Earth Engine documentation provides all types of <a href="https://developers.google.com/earth-engine/guides/charts_overview.">charting examples</a></p>
<div class="sourceCode" id="cb41"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> geometry <span class="op">=</span> ee<span class="op">.</span><span class="at">Geometry</span><span class="op">.</span><span class="fu">Point</span>([<span class="fl">77.58253382230242</span><span class="op">,</span> <span class="fl">12.942038375108362</span>])<span class="op">;</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(geometry<span class="op">,</span> {}<span class="op">,</span> <span class="st">&#39;POI&#39;</span>)</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> chirps <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&quot;UCSB-CHG/CHIRPS/PENTAD&quot;</span>)</span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> year <span class="op">=</span> <span class="dv">2019</span></span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> startDate <span class="op">=</span> ee<span class="op">.</span><span class="at">Date</span><span class="op">.</span><span class="fu">fromYMD</span>(year<span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">1</span>)</span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> endDate <span class="op">=</span> startDate<span class="op">.</span><span class="fu">advance</span>(<span class="dv">1</span><span class="op">,</span> <span class="st">&#39;year&#39;</span>)</span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> yearFiltered <span class="op">=</span> chirps</span>
<span id="cb41-10"><a href="#cb41-10" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(startDate<span class="op">,</span> endDate))</span>
<span id="cb41-11"><a href="#cb41-11" aria-hidden="true" tabindex="-1"></a><span class="co">// CHIRPS collection has 1 image for every pentad (5-days)</span></span>
<span id="cb41-12"><a href="#cb41-12" aria-hidden="true" tabindex="-1"></a><span class="co">// The collection is filtered for 1 year and the time-series</span></span>
<span id="cb41-13"><a href="#cb41-13" aria-hidden="true" tabindex="-1"></a><span class="co">// now has 72 images</span></span>
<span id="cb41-14"><a href="#cb41-14" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(yearFiltered)</span>
<span id="cb41-15"><a href="#cb41-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-16"><a href="#cb41-16" aria-hidden="true" tabindex="-1"></a><span class="co">// We need to aggregate this time series to compute</span></span>
<span id="cb41-17"><a href="#cb41-17" aria-hidden="true" tabindex="-1"></a><span class="co">// monthly images</span></span>
<span id="cb41-18"><a href="#cb41-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-19"><a href="#cb41-19" aria-hidden="true" tabindex="-1"></a><span class="co">// Create a list of months</span></span>
<span id="cb41-20"><a href="#cb41-20" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> months <span class="op">=</span> ee<span class="op">.</span><span class="at">List</span><span class="op">.</span><span class="fu">sequence</span>(<span class="dv">1</span><span class="op">,</span> <span class="dv">12</span>)</span>
<span id="cb41-21"><a href="#cb41-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-22"><a href="#cb41-22" aria-hidden="true" tabindex="-1"></a><span class="co">// Write a function that takes a month number</span></span>
<span id="cb41-23"><a href="#cb41-23" aria-hidden="true" tabindex="-1"></a><span class="co">// and returns a monthly image</span></span>
<span id="cb41-24"><a href="#cb41-24" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> createMonthlyImage <span class="op">=</span> <span class="kw">function</span>(month) {</span>
<span id="cb41-25"><a href="#cb41-25" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> startDate <span class="op">=</span> ee<span class="op">.</span><span class="at">Date</span><span class="op">.</span><span class="fu">fromYMD</span>(year<span class="op">,</span> month<span class="op">,</span> <span class="dv">1</span>)</span>
<span id="cb41-26"><a href="#cb41-26" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> endDate <span class="op">=</span> startDate<span class="op">.</span><span class="fu">advance</span>(<span class="dv">1</span><span class="op">,</span> <span class="st">&#39;month&#39;</span>)</span>
<span id="cb41-27"><a href="#cb41-27" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> monthFiltered <span class="op">=</span> yearFiltered</span>
<span id="cb41-28"><a href="#cb41-28" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(startDate<span class="op">,</span> endDate))</span>
<span id="cb41-29"><a href="#cb41-29" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Calculate total precipitation</span></span>
<span id="cb41-30"><a href="#cb41-30" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> total <span class="op">=</span> monthFiltered<span class="op">.</span><span class="fu">reduce</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">sum</span>())</span>
<span id="cb41-31"><a href="#cb41-31" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> total<span class="op">.</span><span class="fu">set</span>({</span>
<span id="cb41-32"><a href="#cb41-32" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;system:time_start&#39;</span><span class="op">:</span> startDate<span class="op">.</span><span class="fu">millis</span>()<span class="op">,</span></span>
<span id="cb41-33"><a href="#cb41-33" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;system:time_end&#39;</span><span class="op">:</span> endDate<span class="op">.</span><span class="fu">millis</span>()<span class="op">,</span></span>
<span id="cb41-34"><a href="#cb41-34" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;year&#39;</span><span class="op">:</span> year<span class="op">,</span></span>
<span id="cb41-35"><a href="#cb41-35" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;month&#39;</span><span class="op">:</span> month})</span>
<span id="cb41-36"><a href="#cb41-36" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb41-37"><a href="#cb41-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-38"><a href="#cb41-38" aria-hidden="true" tabindex="-1"></a><span class="co">// map() the function on the list  of months</span></span>
<span id="cb41-39"><a href="#cb41-39" aria-hidden="true" tabindex="-1"></a><span class="co">// This creates a list with images for each month in the list</span></span>
<span id="cb41-40"><a href="#cb41-40" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> monthlyImages <span class="op">=</span> months<span class="op">.</span><span class="fu">map</span>(createMonthlyImage)</span>
<span id="cb41-41"><a href="#cb41-41" aria-hidden="true" tabindex="-1"></a><span class="co">// Create an imagecollection</span></span>
<span id="cb41-42"><a href="#cb41-42" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> monthlyCollection <span class="op">=</span> ee<span class="op">.</span><span class="at">ImageCollection</span><span class="op">.</span><span class="fu">fromImages</span>(monthlyImages)</span>
<span id="cb41-43"><a href="#cb41-43" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(monthlyCollection)</span>
<span id="cb41-44"><a href="#cb41-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-45"><a href="#cb41-45" aria-hidden="true" tabindex="-1"></a><span class="co">// Create a chart of monthly rainfall for a location</span></span>
<span id="cb41-46"><a href="#cb41-46" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> chart <span class="op">=</span> ui<span class="op">.</span><span class="at">Chart</span><span class="op">.</span><span class="at">image</span><span class="op">.</span><span class="fu">series</span>({</span>
<span id="cb41-47"><a href="#cb41-47" aria-hidden="true" tabindex="-1"></a>  <span class="dt">imageCollection</span><span class="op">:</span> monthlyCollection<span class="op">,</span></span>
<span id="cb41-48"><a href="#cb41-48" aria-hidden="true" tabindex="-1"></a>  <span class="dt">region</span><span class="op">:</span> geometry<span class="op">,</span></span>
<span id="cb41-49"><a href="#cb41-49" aria-hidden="true" tabindex="-1"></a>  <span class="dt">reducer</span><span class="op">:</span> ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">mean</span>()<span class="op">,</span></span>
<span id="cb41-50"><a href="#cb41-50" aria-hidden="true" tabindex="-1"></a>  <span class="dt">scale</span><span class="op">:</span> <span class="dv">5566</span></span>
<span id="cb41-51"><a href="#cb41-51" aria-hidden="true" tabindex="-1"></a>})<span class="op">.</span><span class="fu">setOptions</span>({</span>
<span id="cb41-52"><a href="#cb41-52" aria-hidden="true" tabindex="-1"></a>      <span class="dt">lineWidth</span><span class="op">:</span> <span class="dv">1</span><span class="op">,</span></span>
<span id="cb41-53"><a href="#cb41-53" aria-hidden="true" tabindex="-1"></a>      <span class="dt">pointSize</span><span class="op">:</span> <span class="dv">3</span><span class="op">,</span></span>
<span id="cb41-54"><a href="#cb41-54" aria-hidden="true" tabindex="-1"></a>      <span class="dt">title</span><span class="op">:</span> <span class="st">&#39;Monthly Rainfall at Bengaluru&#39;</span><span class="op">,</span></span>
<span id="cb41-55"><a href="#cb41-55" aria-hidden="true" tabindex="-1"></a>      <span class="dt">vAxis</span><span class="op">:</span> {<span class="dt">title</span><span class="op">:</span> <span class="st">&#39;Rainfall (mm)&#39;</span>}<span class="op">,</span></span>
<span id="cb41-56"><a href="#cb41-56" aria-hidden="true" tabindex="-1"></a>      <span class="dt">hAxis</span><span class="op">:</span> {<span class="dt">title</span><span class="op">:</span> <span class="st">&#39;Month&#39;</span><span class="op">,</span> <span class="dt">gridlines</span><span class="op">:</span> {<span class="dt">count</span><span class="op">:</span> <span class="dv">12</span>}}</span>
<span id="cb41-57"><a href="#cb41-57" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb41-58"><a href="#cb41-58" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(chart)</span></code></pre></div>
<p><a href="https://code.earthengine.google.co.in/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3A03-Time_Series_Analysis%2F05b_Charting_Monthly_Rainfall_(complete)" target="_blank">Open in Code Editor ↗</a></p>
<div class="figure" style="text-align: center">
<img src="images/gee_water_resources_management/Charting_Monthly_Rainfall.png" alt="2019 - Monthly rainfall" width="100%" />
<p class="caption">
2019 - Monthly rainfall
</p>
</div>
<div id="exercise-20" class="section level3">
<h3>Exercise</h3>
<p>Change the geometry to your location, comput the monthly total rainfall. Download the timeseries chart generated.</p>
<div class="sourceCode" id="cb42"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Create a chart of monthly rainfall at your selected location</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a><span class="co">// print the chart and download it as a PNG</span></span></code></pre></div>
<p><a href="https://code.earthengine.google.co.in/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3A03-Time_Series_Analysis%2F05c_Charting_Monthly_Rainfall_(exercise)" target="_blank">Try in Code Editor ↗</a></p>
</div>
</div>
<div id="import" class="section level2">
<h2>06. Import</h2>
<p>You can import vector or raster data into Earth Engine. We will now import a shapefile of <a href="https://kgis.ksrsac.in/kgis/downloads.aspx">Taluk</a> for a state in India. Unzip the <code>Taluk.rar</code> into a folder on your computer. In the Code Editor, go to <em>Assets → New → Table Upload → Shape Files</em>. Select the <code>.cpj</code>, <code>.sbn</code>, <code>.shp</code>, <code>.shx</code>, <code>.dbf</code>and .<code>prj</code> files. Enter <code>Taluk_Boundary</code> as the <em>Asset Name</em> and click <em>Upload</em>. In the <em>Tasks</em> tab you can see the progress of the upload. Once the ingestion is complete you will have a new asset in the <em>Assets</em> tab. The shapefile will be imported as a Feature Collection in Earth Engine. Select the <code>Taluk_Boundary</code> asset and click <em>Import</em>. You can then visualize the imported data.</p>
<div class="figure" style="text-align: center">
<img src="images/gee_water_resources_management/upload.png" alt="Importing a Shapefile" width="150%" />
<p class="caption">
Importing a Shapefile
</p>
</div>
<div class="sourceCode" id="cb43"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Let&#39;s import some data to Earth Engine</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a><span class="co">// Download the &#39;Taluk&#39; shapefiles from K-GIS</span></span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a><span class="co">// https://kgis.ksrsac.in/kgis/downloads.aspx</span></span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a><span class="co">// Uncompress and upload the &#39;Taluk_Boundary.shp&#39; shapefile </span></span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a><span class="co">// Import the collection</span></span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> taluks <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">&quot;users/ujavalgandhi/gee-water-resources/kgis_taluks&quot;</span>)<span class="op">;</span></span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-12"><a href="#cb43-12" aria-hidden="true" tabindex="-1"></a><span class="co">// Visualize the collection</span></span>
<span id="cb43-13"><a href="#cb43-13" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">centerObject</span>(taluks)</span>
<span id="cb43-14"><a href="#cb43-14" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(taluks<span class="op">,</span> {<span class="dt">color</span><span class="op">:</span> <span class="st">&#39;gray&#39;</span>}<span class="op">,</span> <span class="st">&#39;Taluks&#39;</span>)</span>
<span id="cb43-15"><a href="#cb43-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-16"><a href="#cb43-16" aria-hidden="true" tabindex="-1"></a><span class="co">// Function to add a new property &#39;area_sqkm&#39;</span></span>
<span id="cb43-17"><a href="#cb43-17" aria-hidden="true" tabindex="-1"></a><span class="co">// Function takes a feature and returns the feature</span></span>
<span id="cb43-18"><a href="#cb43-18" aria-hidden="true" tabindex="-1"></a><span class="co">// with a new property</span></span>
<span id="cb43-19"><a href="#cb43-19" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> addArea <span class="op">=</span> <span class="kw">function</span>(f) {</span>
<span id="cb43-20"><a href="#cb43-20" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> area <span class="op">=</span> ee<span class="op">.</span><span class="fu">Number</span>(f<span class="op">.</span><span class="fu">get</span>(<span class="st">&#39;SHAPE_STAr&#39;</span>))<span class="op">.</span><span class="fu">divide</span>(<span class="fl">1e6</span>)</span>
<span id="cb43-21"><a href="#cb43-21" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> f<span class="op">.</span><span class="fu">set</span>(<span class="st">&#39;area_sqkm&#39;</span><span class="op">,</span> area)</span>
<span id="cb43-22"><a href="#cb43-22" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb43-23"><a href="#cb43-23" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> talukWithArea <span class="op">=</span> taluks<span class="op">.</span><span class="fu">map</span>(addArea)</span>
<span id="cb43-24"><a href="#cb43-24" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(talukWithArea)</span></code></pre></div>
<p><a href="https://code.earthengine.google.co.in/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3A03-Time_Series_Analysis%2F06b_Import_(complete)" target="_blank">Open in Code Editor ↗</a></p>
<div id="exercise-21" class="section level3">
<h3>Exercise</h3>
<p>Explore the uploaded Feature Collection, <code>SHAPE_STAr</code> property contains the area in meter_square, using <code>addArea</code> function area is converted into kilometer_square and stored as <code>area_sqkm</code>. Using this property filter all regions with area greater than 1000 kmsq.</p>
<div class="sourceCode" id="cb44"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Let&#39;s import some data to Earth Engine</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a><span class="co">// Download the &#39;Taluk&#39; shapefiles from K-GIS</span></span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a><span class="co">// https://kgis.ksrsac.in/kgis/downloads.aspx</span></span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a><span class="co">// Uncompress and upload the &#39;Taluk_Boundary.shp&#39; shapefile </span></span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a><span class="co">// Import the collection</span></span>
<span id="cb44-10"><a href="#cb44-10" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> taluks <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">&quot;users/ujavalgandhi/gee-water-resources/kgis_taluks&quot;</span>)<span class="op">;</span></span>
<span id="cb44-11"><a href="#cb44-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-12"><a href="#cb44-12" aria-hidden="true" tabindex="-1"></a><span class="co">// Function to add a new property &#39;area_sqkm&#39;</span></span>
<span id="cb44-13"><a href="#cb44-13" aria-hidden="true" tabindex="-1"></a><span class="co">// Function takes a feature and returns the feature</span></span>
<span id="cb44-14"><a href="#cb44-14" aria-hidden="true" tabindex="-1"></a><span class="co">// with a new property</span></span>
<span id="cb44-15"><a href="#cb44-15" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> addArea <span class="op">=</span> <span class="kw">function</span>(f) {</span>
<span id="cb44-16"><a href="#cb44-16" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> area <span class="op">=</span> ee<span class="op">.</span><span class="fu">Number</span>(f<span class="op">.</span><span class="fu">get</span>(<span class="st">&#39;SHAPE_STAr&#39;</span>))<span class="op">.</span><span class="fu">divide</span>(<span class="fl">1e6</span>)</span>
<span id="cb44-17"><a href="#cb44-17" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> f<span class="op">.</span><span class="fu">set</span>(<span class="st">&#39;area_sqkm&#39;</span><span class="op">,</span> area)</span>
<span id="cb44-18"><a href="#cb44-18" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb44-19"><a href="#cb44-19" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> talukWithArea <span class="op">=</span> taluks<span class="op">.</span><span class="fu">map</span>(addArea)</span>
<span id="cb44-20"><a href="#cb44-20" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(talukWithArea)</span>
<span id="cb44-21"><a href="#cb44-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-22"><a href="#cb44-22" aria-hidden="true" tabindex="-1"></a><span class="co">// Exercise</span></span>
<span id="cb44-23"><a href="#cb44-23" aria-hidden="true" tabindex="-1"></a><span class="co">// Apply a filter to select all polygons with area &gt; 1000 sq. km.</span></span>
<span id="cb44-24"><a href="#cb44-24" aria-hidden="true" tabindex="-1"></a><span class="co">// Add the results to the map</span></span></code></pre></div>
<p><a href="https://code.earthengine.google.co.in/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3A03-Time_Series_Analysis%2F06c_Import_(exercise)" target="_blank">Try in Code Editor ↗</a></p>
</div>
</div>
<div id="zonal-statistics" class="section level2">
<h2>07. Zonal Statistics</h2>
<p>Now that we have uploaded a shapefile with many Taluk boundaries let us calculate the mean rainfall for each district. Before in <code>reduceRegion</code>, we learned to reduce a single image over a whole geometry. But by using the <code>reduceRegions</code>, we can reduce the image for each geometry in the feature collection. This function will return a <em>Feature Collection</em>, which contains all the features with an additional property of the reduced value.</p>
<div class="figure" style="text-align: center">
<img src="images/gee_water_resources_management/zonal_statistics.png" alt="Zonal Statistics" width="100%" />
<p class="caption">
Zonal Statistics
</p>
</div>
<div class="sourceCode" id="cb45"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> taluks <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">&quot;users/ujavalgandhi/gee-water-resources/kgis_taluks&quot;</span>)<span class="op">;</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> chirps <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&#39;UCSB-CHG/CHIRPS/PENTAD&#39;</span>)</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> year <span class="op">=</span> <span class="dv">2019</span></span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> startDate <span class="op">=</span> ee<span class="op">.</span><span class="at">Date</span><span class="op">.</span><span class="fu">fromYMD</span>(year<span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">1</span>)</span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> endDate <span class="op">=</span> startDate<span class="op">.</span><span class="fu">advance</span>(<span class="dv">1</span><span class="op">,</span> <span class="st">&#39;year&#39;</span>)</span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> filtered <span class="op">=</span> chirps</span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(startDate<span class="op">,</span> endDate))</span>
<span id="cb45-10"><a href="#cb45-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-11"><a href="#cb45-11" aria-hidden="true" tabindex="-1"></a><span class="co">// Calculate the total rainfall for the year</span></span>
<span id="cb45-12"><a href="#cb45-12" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> total <span class="op">=</span> filtered<span class="op">.</span><span class="fu">reduce</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">sum</span>())</span>
<span id="cb45-13"><a href="#cb45-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-14"><a href="#cb45-14" aria-hidden="true" tabindex="-1"></a><span class="co">// Display the total rainfall image.</span></span>
<span id="cb45-15"><a href="#cb45-15" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> palette <span class="op">=</span> [<span class="st">&#39;#ffffcc&#39;</span><span class="op">,</span><span class="st">&#39;#a1dab4&#39;</span><span class="op">,</span><span class="st">&#39;#41b6c4&#39;</span><span class="op">,</span><span class="st">&#39;#2c7fb8&#39;</span><span class="op">,</span><span class="st">&#39;#253494&#39;</span>]</span>
<span id="cb45-16"><a href="#cb45-16" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> visParams <span class="op">=</span> {</span>
<span id="cb45-17"><a href="#cb45-17" aria-hidden="true" tabindex="-1"></a>  <span class="dt">min</span><span class="op">:</span><span class="dv">0</span><span class="op">,</span></span>
<span id="cb45-18"><a href="#cb45-18" aria-hidden="true" tabindex="-1"></a>  <span class="dt">max</span><span class="op">:</span> <span class="dv">2000</span><span class="op">,</span></span>
<span id="cb45-19"><a href="#cb45-19" aria-hidden="true" tabindex="-1"></a>  <span class="dt">palette</span><span class="op">:</span> palette</span>
<span id="cb45-20"><a href="#cb45-20" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb45-21"><a href="#cb45-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-22"><a href="#cb45-22" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(total<span class="op">,</span> visParams<span class="op">,</span> <span class="st">&#39;Total Precipitation&#39;</span>)</span>
<span id="cb45-23"><a href="#cb45-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-24"><a href="#cb45-24" aria-hidden="true" tabindex="-1"></a><span class="co">// Compute the average total rainfall for each feature</span></span>
<span id="cb45-25"><a href="#cb45-25" aria-hidden="true" tabindex="-1"></a><span class="co">// reduceRegions() function allows you to do zonal stats</span></span>
<span id="cb45-26"><a href="#cb45-26" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> withRainfall <span class="op">=</span> total<span class="op">.</span><span class="fu">reduceRegions</span>({</span>
<span id="cb45-27"><a href="#cb45-27" aria-hidden="true" tabindex="-1"></a>  <span class="dt">collection</span><span class="op">:</span> taluks<span class="op">,</span></span>
<span id="cb45-28"><a href="#cb45-28" aria-hidden="true" tabindex="-1"></a>  <span class="dt">reducer</span><span class="op">:</span> ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">mean</span>()<span class="op">,</span></span>
<span id="cb45-29"><a href="#cb45-29" aria-hidden="true" tabindex="-1"></a>  <span class="dt">scale</span><span class="op">:</span> <span class="dv">5566</span>})</span>
<span id="cb45-30"><a href="#cb45-30" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb45-31"><a href="#cb45-31" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">centerObject</span>(taluks)</span>
<span id="cb45-32"><a href="#cb45-32" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(withRainfall<span class="op">,</span> {<span class="dt">color</span><span class="op">:</span> <span class="st">&#39;red&#39;</span>}<span class="op">,</span> <span class="st">&#39;Taluks&#39;</span>)</span></code></pre></div>
<p><a href="https://code.earthengine.google.co.in/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3A03-Time_Series_Analysis%2F07b_Zonal_Statistics_(complete)" target="_blank">Open in Code Editor ↗</a></p>
<div id="exercise-22" class="section level3">
<h3>Exercise</h3>
<p>Write an export function to export the Feature Collection as a CSV file.</p>
<div class="sourceCode" id="cb46"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> taluks <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">&quot;users/ujavalgandhi/gee-water-resources/kgis_taluks&quot;</span>)<span class="op">;</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> chirps <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&#39;UCSB-CHG/CHIRPS/PENTAD&#39;</span>)</span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> year <span class="op">=</span> <span class="dv">2019</span></span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> startDate <span class="op">=</span> ee<span class="op">.</span><span class="at">Date</span><span class="op">.</span><span class="fu">fromYMD</span>(year<span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">1</span>)</span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> endDate <span class="op">=</span> startDate<span class="op">.</span><span class="fu">advance</span>(<span class="dv">1</span><span class="op">,</span> <span class="st">&#39;year&#39;</span>)</span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> filtered <span class="op">=</span> chirps</span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(startDate<span class="op">,</span> endDate))</span>
<span id="cb46-10"><a href="#cb46-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-11"><a href="#cb46-11" aria-hidden="true" tabindex="-1"></a><span class="co">// Calculate the total rainfall for the year</span></span>
<span id="cb46-12"><a href="#cb46-12" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> total <span class="op">=</span> filtered<span class="op">.</span><span class="fu">reduce</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">sum</span>())</span>
<span id="cb46-13"><a href="#cb46-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-14"><a href="#cb46-14" aria-hidden="true" tabindex="-1"></a><span class="co">// Display the total rainfall image.</span></span>
<span id="cb46-15"><a href="#cb46-15" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> palette <span class="op">=</span> [<span class="st">&#39;#ffffcc&#39;</span><span class="op">,</span><span class="st">&#39;#a1dab4&#39;</span><span class="op">,</span><span class="st">&#39;#41b6c4&#39;</span><span class="op">,</span><span class="st">&#39;#2c7fb8&#39;</span><span class="op">,</span><span class="st">&#39;#253494&#39;</span>]</span>
<span id="cb46-16"><a href="#cb46-16" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> visParams <span class="op">=</span> {</span>
<span id="cb46-17"><a href="#cb46-17" aria-hidden="true" tabindex="-1"></a>  <span class="dt">min</span><span class="op">:</span><span class="dv">0</span><span class="op">,</span></span>
<span id="cb46-18"><a href="#cb46-18" aria-hidden="true" tabindex="-1"></a>  <span class="dt">max</span><span class="op">:</span> <span class="dv">2000</span><span class="op">,</span></span>
<span id="cb46-19"><a href="#cb46-19" aria-hidden="true" tabindex="-1"></a>  <span class="dt">palette</span><span class="op">:</span> palette</span>
<span id="cb46-20"><a href="#cb46-20" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb46-21"><a href="#cb46-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-22"><a href="#cb46-22" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(total<span class="op">,</span> visParams<span class="op">,</span> <span class="st">&#39;Total Precipitation&#39;</span>)</span>
<span id="cb46-23"><a href="#cb46-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-24"><a href="#cb46-24" aria-hidden="true" tabindex="-1"></a><span class="co">// Compute the total rainfall for each feature</span></span>
<span id="cb46-25"><a href="#cb46-25" aria-hidden="true" tabindex="-1"></a><span class="co">// reduceRegions() function allows you to do zonal stats</span></span>
<span id="cb46-26"><a href="#cb46-26" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> withRainfall <span class="op">=</span> total<span class="op">.</span><span class="fu">reduceRegions</span>({</span>
<span id="cb46-27"><a href="#cb46-27" aria-hidden="true" tabindex="-1"></a>  <span class="dt">collection</span><span class="op">:</span> taluks<span class="op">,</span></span>
<span id="cb46-28"><a href="#cb46-28" aria-hidden="true" tabindex="-1"></a>  <span class="dt">reducer</span><span class="op">:</span> ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">mean</span>()<span class="op">,</span></span>
<span id="cb46-29"><a href="#cb46-29" aria-hidden="true" tabindex="-1"></a>  <span class="dt">scale</span><span class="op">:</span> <span class="dv">5566</span>})</span>
<span id="cb46-30"><a href="#cb46-30" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb46-31"><a href="#cb46-31" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">centerObject</span>(taluks)</span>
<span id="cb46-32"><a href="#cb46-32" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(withRainfall<span class="op">,</span> {<span class="dt">color</span><span class="op">:</span> <span class="st">&#39;blue&#39;</span>}<span class="op">,</span> <span class="st">&#39;Taluks&#39;</span>) </span>
<span id="cb46-33"><a href="#cb46-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-34"><a href="#cb46-34" aria-hidden="true" tabindex="-1"></a><span class="co">// Exercise</span></span>
<span id="cb46-35"><a href="#cb46-35" aria-hidden="true" tabindex="-1"></a><span class="co">// Export the resulting FeatureCollection with average rainfall as a CSV</span></span>
<span id="cb46-36"><a href="#cb46-36" aria-hidden="true" tabindex="-1"></a><span class="co">// Use the Export.table.toDrive() function</span></span>
<span id="cb46-37"><a href="#cb46-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-38"><a href="#cb46-38" aria-hidden="true" tabindex="-1"></a><span class="co">// You can use the .select() function to select only columns you need</span></span>
<span id="cb46-39"><a href="#cb46-39" aria-hidden="true" tabindex="-1"></a><span class="co">// You can also rename the columns</span></span>
<span id="cb46-40"><a href="#cb46-40" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> exportCol <span class="op">=</span> withRainfall<span class="op">.</span><span class="fu">select</span>([<span class="st">&#39;KGISTalukN&#39;</span><span class="op">,</span> <span class="st">&#39;mean&#39;</span>]<span class="op">,</span> [<span class="st">&#39;taluk&#39;</span><span class="op">,</span> <span class="st">&#39;average_rainfall&#39;</span>])</span>
<span id="cb46-41"><a href="#cb46-41" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(exportCol)</span>
<span id="cb46-42"><a href="#cb46-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-43"><a href="#cb46-43" aria-hidden="true" tabindex="-1"></a><span class="co">// Export the exportCol as a CSV</span></span>
<span id="cb46-44"><a href="#cb46-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-45"><a href="#cb46-45" aria-hidden="true" tabindex="-1"></a><span class="co">// Hint: Even though you have only 2 properties for each feature, </span></span>
<span id="cb46-46"><a href="#cb46-46" aria-hidden="true" tabindex="-1"></a><span class="co">// the CSV will include internal properties system:index and .geo (the geometry)</span></span>
<span id="cb46-47"><a href="#cb46-47" aria-hidden="true" tabindex="-1"></a><span class="co">// To only get the data columns in your CSV, specify the list of properties</span></span>
<span id="cb46-48"><a href="#cb46-48" aria-hidden="true" tabindex="-1"></a><span class="co">// using the &#39;selectors&#39; argument in Export.table.toDrive() function</span></span></code></pre></div>
<p><a href="https://code.earthengine.google.co.in/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3A03-Time_Series_Analysis%2F07c_Zonal_Statistics_(exercise)" target="_blank">Try in Code Editor ↗</a></p>
</div>
</div>
<div id="trend-analysis" class="section level2">
<h2>08. Trend Analysis</h2>
<p>Trend Analysis is a technique that is used to find the pattern. Let us do a Non-Parametric Trend Analysis using the <a href="https://en.wikipedia.org/wiki/Theil%E2%80%93Sen_estimator">Sen Slope</a> technique to find the pattern of rainfall over time.</p>
<p>The sens slope is a reduction operation that expects two-band X and Y. The X is the constant band with value year, and the Y is the total precipitation of that pixel in that year. After creating the image collection in this format we can use the <code>ee.Reducer.sensSlope()</code> with the collection to compute the slope at each year.</p>
<p>This function returns an image with a positive pixel value representing the increase in precipitation and vice-versa.</p>
<blockquote>
<p>An advantage of doing trend analysis in earth engine is computing pre-pixel calculation other wise which would be computation intestiive task to perform.</p>
</blockquote>
<div class="sourceCode" id="cb47"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> taluks <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">&quot;users/ujavalgandhi/gee-water-resources/kgis_taluks&quot;</span>)<span class="op">;</span></span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> chirps <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&#39;UCSB-CHG/CHIRPS/PENTAD&#39;</span>)</span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a><span class="co">// We will compute the trend of total seasonal rainfall</span></span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a><span class="co">// Rainy season is June - September</span></span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> createSeasonalImage <span class="op">=</span> <span class="kw">function</span>(year) {</span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> startDate <span class="op">=</span> ee<span class="op">.</span><span class="at">Date</span><span class="op">.</span><span class="fu">fromYMD</span>(year<span class="op">,</span> <span class="dv">6</span><span class="op">,</span> <span class="dv">1</span>)</span>
<span id="cb47-9"><a href="#cb47-9" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> endDate <span class="op">=</span> ee<span class="op">.</span><span class="at">Date</span><span class="op">.</span><span class="fu">fromYMD</span>(year<span class="op">,</span> <span class="dv">9</span><span class="op">,</span> <span class="dv">30</span>)</span>
<span id="cb47-10"><a href="#cb47-10" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> seasonFiltered <span class="op">=</span> chirps</span>
<span id="cb47-11"><a href="#cb47-11" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(startDate<span class="op">,</span> endDate))</span>
<span id="cb47-12"><a href="#cb47-12" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Calculate total precipitation</span></span>
<span id="cb47-13"><a href="#cb47-13" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> total <span class="op">=</span> seasonFiltered<span class="op">.</span><span class="fu">reduce</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">sum</span>())</span>
<span id="cb47-14"><a href="#cb47-14" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> total<span class="op">.</span><span class="fu">set</span>({</span>
<span id="cb47-15"><a href="#cb47-15" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;system:time_start&#39;</span><span class="op">:</span> startDate<span class="op">.</span><span class="fu">millis</span>()<span class="op">,</span></span>
<span id="cb47-16"><a href="#cb47-16" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;system:time_end&#39;</span><span class="op">:</span> endDate<span class="op">.</span><span class="fu">millis</span>()<span class="op">,</span></span>
<span id="cb47-17"><a href="#cb47-17" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;year&#39;</span><span class="op">:</span> year<span class="op">,</span></span>
<span id="cb47-18"><a href="#cb47-18" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb47-19"><a href="#cb47-19" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb47-20"><a href="#cb47-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-21"><a href="#cb47-21" aria-hidden="true" tabindex="-1"></a><span class="co">// Aggregate Precipitation Data to Yearly Time-Series</span></span>
<span id="cb47-22"><a href="#cb47-22" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> years <span class="op">=</span> ee<span class="op">.</span><span class="at">List</span><span class="op">.</span><span class="fu">sequence</span>(<span class="dv">1981</span><span class="op">,</span> <span class="dv">2013</span>)</span>
<span id="cb47-23"><a href="#cb47-23" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> yearlyImages <span class="op">=</span> years<span class="op">.</span><span class="fu">map</span>(createSeasonalImage)</span>
<span id="cb47-24"><a href="#cb47-24" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(yearlyImages)</span>
<span id="cb47-25"><a href="#cb47-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-26"><a href="#cb47-26" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> yearlyCol <span class="op">=</span> ee<span class="op">.</span><span class="at">ImageCollection</span><span class="op">.</span><span class="fu">fromImages</span>(yearlyImages)</span>
<span id="cb47-27"><a href="#cb47-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-28"><a href="#cb47-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-29"><a href="#cb47-29" aria-hidden="true" tabindex="-1"></a><span class="co">// Prepare data for Sen&#39;s Slope Estimation</span></span>
<span id="cb47-30"><a href="#cb47-30" aria-hidden="true" tabindex="-1"></a><span class="co">// We need an image with 2 bands for X and Y varibles</span></span>
<span id="cb47-31"><a href="#cb47-31" aria-hidden="true" tabindex="-1"></a><span class="co">// X = year</span></span>
<span id="cb47-32"><a href="#cb47-32" aria-hidden="true" tabindex="-1"></a><span class="co">// Y = total precipitation</span></span>
<span id="cb47-33"><a href="#cb47-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-34"><a href="#cb47-34" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> processImage <span class="op">=</span> <span class="kw">function</span>(image) {</span>
<span id="cb47-35"><a href="#cb47-35" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> year <span class="op">=</span> image<span class="op">.</span><span class="fu">get</span>(<span class="st">&#39;year&#39;</span>)<span class="op">;</span></span>
<span id="cb47-36"><a href="#cb47-36" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> yearImage <span class="op">=</span> ee<span class="op">.</span><span class="at">Image</span><span class="op">.</span><span class="fu">constant</span>(ee<span class="op">.</span><span class="fu">Number</span>(year))<span class="op">.</span><span class="fu">toShort</span>()<span class="op">;</span></span>
<span id="cb47-37"><a href="#cb47-37" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> ee<span class="op">.</span><span class="at">Image</span><span class="op">.</span><span class="fu">cat</span>(yearImage<span class="op">,</span> image)<span class="op">.</span><span class="fu">rename</span>([<span class="st">&#39;year&#39;</span><span class="op">,</span> <span class="st">&#39;prcp&#39;</span>])<span class="op">.</span><span class="fu">set</span>(<span class="st">&#39;year&#39;</span><span class="op">,</span> year)<span class="op">;</span></span>
<span id="cb47-38"><a href="#cb47-38" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb47-39"><a href="#cb47-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-40"><a href="#cb47-40" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> processedCol <span class="op">=</span> yearlyCol<span class="op">.</span><span class="fu">map</span>(processImage)</span>
<span id="cb47-41"><a href="#cb47-41" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(processedCol)</span>
<span id="cb47-42"><a href="#cb47-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-43"><a href="#cb47-43" aria-hidden="true" tabindex="-1"></a><span class="co">// Calculate time series slope using sensSlope().</span></span>
<span id="cb47-44"><a href="#cb47-44" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> sens <span class="op">=</span> processedCol<span class="op">.</span><span class="fu">reduce</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">sensSlope</span>())<span class="op">;</span></span>
<span id="cb47-45"><a href="#cb47-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-46"><a href="#cb47-46" aria-hidden="true" tabindex="-1"></a><span class="co">// The resulting image has 2 bands: slope and intercept</span></span>
<span id="cb47-47"><a href="#cb47-47" aria-hidden="true" tabindex="-1"></a><span class="co">// We select the &#39;slope&#39; band</span></span>
<span id="cb47-48"><a href="#cb47-48" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> slope <span class="op">=</span> sens<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;slope&#39;</span>)</span>
<span id="cb47-49"><a href="#cb47-49" aria-hidden="true" tabindex="-1"></a><span class="co">// Set visualisation parameters</span></span>
<span id="cb47-50"><a href="#cb47-50" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> visParams <span class="op">=</span> {<span class="dt">min</span><span class="op">:</span> <span class="op">-</span><span class="dv">10</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span> <span class="dv">10</span><span class="op">,</span> <span class="dt">palette</span><span class="op">:</span> [<span class="st">&#39;brown&#39;</span><span class="op">,</span> <span class="st">&#39;white&#39;</span><span class="op">,</span> <span class="st">&#39;blue&#39;</span>]}<span class="op">;</span></span>
<span id="cb47-51"><a href="#cb47-51" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(slope<span class="op">,</span> visParams<span class="op">,</span> <span class="st">&#39;Trend&#39;</span>)<span class="op">;</span></span></code></pre></div>
<p><a href="https://code.earthengine.google.co.in/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3A03-Time_Series_Analysis%2F08b_Trend_Analysis_(complete)" target="_blank">Open in Code Editor ↗</a></p>
<div id="exercise-23" class="section level3">
<h3>Exercise</h3>
<p>The trend analysis is done for a particular season. Change the filter dates to compute the annual precipitation trend.</p>
<div class="sourceCode" id="cb48"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> taluks <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">&quot;users/ujavalgandhi/gee-water-resources/kgis_taluks&quot;</span>)<span class="op">;</span></span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> chirps <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&#39;UCSB-CHG/CHIRPS/PENTAD&#39;</span>)</span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a><span class="co">// We will compute the trend of total seasonal rainfall</span></span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a><span class="co">// Rainy season is June - September</span></span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> createSeasonalImage <span class="op">=</span> <span class="kw">function</span>(year) {</span>
<span id="cb48-8"><a href="#cb48-8" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> startDate <span class="op">=</span> ee<span class="op">.</span><span class="at">Date</span><span class="op">.</span><span class="fu">fromYMD</span>(year<span class="op">,</span> <span class="dv">6</span><span class="op">,</span> <span class="dv">1</span>)</span>
<span id="cb48-9"><a href="#cb48-9" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> endDate <span class="op">=</span> ee<span class="op">.</span><span class="at">Date</span><span class="op">.</span><span class="fu">fromYMD</span>(year<span class="op">,</span> <span class="dv">9</span><span class="op">,</span> <span class="dv">30</span>)</span>
<span id="cb48-10"><a href="#cb48-10" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> seasonFiltered <span class="op">=</span> chirps</span>
<span id="cb48-11"><a href="#cb48-11" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(startDate<span class="op">,</span> endDate))</span>
<span id="cb48-12"><a href="#cb48-12" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Calculate total precipitation</span></span>
<span id="cb48-13"><a href="#cb48-13" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> total <span class="op">=</span> seasonFiltered<span class="op">.</span><span class="fu">reduce</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">sum</span>())</span>
<span id="cb48-14"><a href="#cb48-14" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> total<span class="op">.</span><span class="fu">set</span>({</span>
<span id="cb48-15"><a href="#cb48-15" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;system:time_start&#39;</span><span class="op">:</span> startDate<span class="op">.</span><span class="fu">millis</span>()<span class="op">,</span></span>
<span id="cb48-16"><a href="#cb48-16" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;system:time_end&#39;</span><span class="op">:</span> endDate<span class="op">.</span><span class="fu">millis</span>()<span class="op">,</span></span>
<span id="cb48-17"><a href="#cb48-17" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;year&#39;</span><span class="op">:</span> year<span class="op">,</span></span>
<span id="cb48-18"><a href="#cb48-18" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb48-19"><a href="#cb48-19" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb48-20"><a href="#cb48-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-21"><a href="#cb48-21" aria-hidden="true" tabindex="-1"></a><span class="co">// Aggregate Precipitation Data </span></span>
<span id="cb48-22"><a href="#cb48-22" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> years <span class="op">=</span> ee<span class="op">.</span><span class="at">List</span><span class="op">.</span><span class="fu">sequence</span>(<span class="dv">1981</span><span class="op">,</span> <span class="dv">2013</span>)</span>
<span id="cb48-23"><a href="#cb48-23" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> yearlyImages <span class="op">=</span> years<span class="op">.</span><span class="fu">map</span>(createSeasonalImage)</span>
<span id="cb48-24"><a href="#cb48-24" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(yearlyImages)</span>
<span id="cb48-25"><a href="#cb48-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-26"><a href="#cb48-26" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> yearlyCol <span class="op">=</span> ee<span class="op">.</span><span class="at">ImageCollection</span><span class="op">.</span><span class="fu">fromImages</span>(yearlyImages)</span>
<span id="cb48-27"><a href="#cb48-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-28"><a href="#cb48-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-29"><a href="#cb48-29" aria-hidden="true" tabindex="-1"></a><span class="co">// Prepare data for Sen&#39;s Slope Estimation</span></span>
<span id="cb48-30"><a href="#cb48-30" aria-hidden="true" tabindex="-1"></a><span class="co">// We need an image with 2 bands for X and Y varibles</span></span>
<span id="cb48-31"><a href="#cb48-31" aria-hidden="true" tabindex="-1"></a><span class="co">// X = year</span></span>
<span id="cb48-32"><a href="#cb48-32" aria-hidden="true" tabindex="-1"></a><span class="co">// Y = total precipitation</span></span>
<span id="cb48-33"><a href="#cb48-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-34"><a href="#cb48-34" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> processImage <span class="op">=</span> <span class="kw">function</span>(image) {</span>
<span id="cb48-35"><a href="#cb48-35" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> year <span class="op">=</span> image<span class="op">.</span><span class="fu">get</span>(<span class="st">&#39;year&#39;</span>)<span class="op">;</span></span>
<span id="cb48-36"><a href="#cb48-36" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> yearImage <span class="op">=</span> ee<span class="op">.</span><span class="at">Image</span><span class="op">.</span><span class="fu">constant</span>(ee<span class="op">.</span><span class="fu">Number</span>(year))<span class="op">.</span><span class="fu">toShort</span>()<span class="op">;</span></span>
<span id="cb48-37"><a href="#cb48-37" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> ee<span class="op">.</span><span class="at">Image</span><span class="op">.</span><span class="fu">cat</span>(yearImage<span class="op">,</span> image)<span class="op">.</span><span class="fu">rename</span>([<span class="st">&#39;year&#39;</span><span class="op">,</span> <span class="st">&#39;prcp&#39;</span>])<span class="op">.</span><span class="fu">set</span>(<span class="st">&#39;year&#39;</span><span class="op">,</span> year)<span class="op">;</span></span>
<span id="cb48-38"><a href="#cb48-38" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb48-39"><a href="#cb48-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-40"><a href="#cb48-40" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> processedCol <span class="op">=</span> yearlyCol<span class="op">.</span><span class="fu">map</span>(processImage)</span>
<span id="cb48-41"><a href="#cb48-41" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(processedCol)</span>
<span id="cb48-42"><a href="#cb48-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-43"><a href="#cb48-43" aria-hidden="true" tabindex="-1"></a><span class="co">// Calculate time series slope using sensSlope().</span></span>
<span id="cb48-44"><a href="#cb48-44" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> sens <span class="op">=</span> processedCol<span class="op">.</span><span class="fu">reduce</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">sensSlope</span>())<span class="op">;</span></span>
<span id="cb48-45"><a href="#cb48-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-46"><a href="#cb48-46" aria-hidden="true" tabindex="-1"></a><span class="co">// The resulting image has 2 bands: slope and intercept</span></span>
<span id="cb48-47"><a href="#cb48-47" aria-hidden="true" tabindex="-1"></a><span class="co">// We select the &#39;slope&#39; band</span></span>
<span id="cb48-48"><a href="#cb48-48" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> slope <span class="op">=</span> sens<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;slope&#39;</span>)</span>
<span id="cb48-49"><a href="#cb48-49" aria-hidden="true" tabindex="-1"></a><span class="co">// Set visualisation parameters</span></span>
<span id="cb48-50"><a href="#cb48-50" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> visParams <span class="op">=</span> {<span class="dt">min</span><span class="op">:</span> <span class="op">-</span><span class="dv">10</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span> <span class="dv">10</span><span class="op">,</span> <span class="dt">palette</span><span class="op">:</span> [<span class="st">&#39;brown&#39;</span><span class="op">,</span> <span class="st">&#39;white&#39;</span><span class="op">,</span> <span class="st">&#39;blue&#39;</span>]}<span class="op">;</span></span>
<span id="cb48-51"><a href="#cb48-51" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(slope<span class="op">,</span> visParams<span class="op">,</span> <span class="st">&#39;Trend&#39;</span>)<span class="op">;</span> </span>
<span id="cb48-52"><a href="#cb48-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-53"><a href="#cb48-53" aria-hidden="true" tabindex="-1"></a><span class="co">// Exercise</span></span>
<span id="cb48-54"><a href="#cb48-54" aria-hidden="true" tabindex="-1"></a><span class="co">// Change the code above to compute annual precipitation trend</span></span></code></pre></div>
<p><a href="https://code.earthengine.google.co.in/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3A03-Time_Series_Analysis%2F08c_Trend_Analysis_(exercise)" target="_blank">Try in Code Editor ↗</a></p>
</div>
</div>
</div>
<div id="module-4-land-use-land-coverclassification" class="section level1">
<h1>Module 4: Land Use Land CoverClassification</h1>
<div id="introduction-to-machine-learning-and-supervised-classification" class="section level2">
<h2>Introduction to Machine Learning and Supervised Classification</h2>
<p>Supervised classification is a classical machine learning technique in remote sensing. There is a variety of applications that can be performed using this technique. Google Earth Engine is uniquely suited for supervised classification at a large scale, and it has all the resources pre-loaded for convenience. The interactive nature of Earth Engine development allows for iterative development of supervised classification workflows by combining many different datasets into the model. This module covers basic supervised classification workflow, accuracy assessment, hyperparameter tuning, and using the ESA world cover data.</p>
<p><a href="https://docs.google.com/presentation/d/16jsxRrYG9RddvlUfa6Myt3_mc-ye4GgDcvYK6n7IgkU/edit?usp=sharing" target="_blank"><img src="images/gee_water_resources_management/supervised_classification.png" width="400" alt="View Presentation" /></a></p>
<p><a href="https://docs.google.com/presentation/d/16jsxRrYG9RddvlUfa6Myt3_mc-ye4GgDcvYK6n7IgkU/edit?usp=sharing" target="_blank">View the Presentation ↗</a></p>
</div>
<div id="basic-supervised-classification" class="section level2">
<h2>01. Basic Supervised Classification</h2>
<p>We will learn the technique to do a basic land cover classification using training points collected using the Code Editor with the help of the High-Resolution base map imagery provided by Google Maps. Even if no field data is available for training the model, this method is very effective in generating high-quality classification samples anywhere in the world. The goal is to classify Sentinel 2A pixel into one of the following classes - <em>urban, bare, water,</em> or <em>vegetation</em>. Using the drawing tools in the code editor lets us create 4 new feature collections with points representing pixels of each class. Each feature collection will be created with a property <code>landcover</code> where each collection has values of 0, 1, 2, or 3, representing urban, bare, water, or vegetation, respectively. We use these collected samples to train a <em>Random Forest</em> classifier and apply it to all the image pixels to create a land cover image with 4 classes.</p>
<blockquote>
<p>Fun fact: The classifiers in Earth Engine API have names starting with <strong>smile</strong> - such as <code>ee.Classifier.smileRandomForest()</code>. The <em>smile</em> part refers to the <a href="https://haifengl.github.io/index.html">Statistical Machine Intelligence and Learning Engine (SMILE)</a> JAVA library which is used by Google Earth Engine to implement these algorithms.</p>
</blockquote>
<div class="sourceCode" id="cb49"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> bangalore <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">&quot;users/ujavalgandhi/public/bangalore_boundary&quot;</span>)</span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> s2 <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&quot;COPERNICUS/S2_SR&quot;</span>)</span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a><span class="co">// The following collections were created using the </span></span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a><span class="co">// Drawing Tools in the code editor </span></span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> urban <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">&quot;users/ujavalgandhi/e2e/urban_gcps&quot;</span>)</span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> bare <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">&quot;users/ujavalgandhi/e2e/bare_gcps&quot;</span>)</span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> water <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">&quot;users/ujavalgandhi/e2e/water_gcps&quot;</span>)</span>
<span id="cb49-8"><a href="#cb49-8" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> vegetation <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">&quot;users/ujavalgandhi/e2e/vegetation_gcps&quot;</span>)</span>
<span id="cb49-9"><a href="#cb49-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-10"><a href="#cb49-10" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb49-11"><a href="#cb49-11" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> filtered <span class="op">=</span> s2</span>
<span id="cb49-12"><a href="#cb49-12" aria-hidden="true" tabindex="-1"></a><span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">lt</span>(<span class="st">&#39;CLOUDY_PIXEL_PERCENTAGE&#39;</span><span class="op">,</span> <span class="dv">30</span>))</span>
<span id="cb49-13"><a href="#cb49-13" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(<span class="st">&#39;2019-01-01&#39;</span><span class="op">,</span> <span class="st">&#39;2019-12-31&#39;</span>))</span>
<span id="cb49-14"><a href="#cb49-14" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">bounds</span>(bangalore))</span>
<span id="cb49-15"><a href="#cb49-15" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;B.*&#39;</span>)</span>
<span id="cb49-16"><a href="#cb49-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-17"><a href="#cb49-17" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> composite <span class="op">=</span> filtered<span class="op">.</span><span class="fu">median</span>()<span class="op">.</span><span class="fu">clip</span>(bangalore) </span>
<span id="cb49-18"><a href="#cb49-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-19"><a href="#cb49-19" aria-hidden="true" tabindex="-1"></a><span class="co">// Display the input composite.</span></span>
<span id="cb49-20"><a href="#cb49-20" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> rgbVis <span class="op">=</span> {</span>
<span id="cb49-21"><a href="#cb49-21" aria-hidden="true" tabindex="-1"></a>  <span class="dt">min</span><span class="op">:</span> <span class="fl">0.0</span><span class="op">,</span></span>
<span id="cb49-22"><a href="#cb49-22" aria-hidden="true" tabindex="-1"></a>  <span class="dt">max</span><span class="op">:</span> <span class="dv">3000</span><span class="op">,</span></span>
<span id="cb49-23"><a href="#cb49-23" aria-hidden="true" tabindex="-1"></a>  <span class="dt">bands</span><span class="op">:</span> [<span class="st">&#39;B4&#39;</span><span class="op">,</span> <span class="st">&#39;B3&#39;</span><span class="op">,</span> <span class="st">&#39;B2&#39;</span>]<span class="op">,</span></span>
<span id="cb49-24"><a href="#cb49-24" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb49-25"><a href="#cb49-25" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(composite<span class="op">,</span> rgbVis<span class="op">,</span> <span class="st">&#39;image&#39;</span>)<span class="op">;</span></span>
<span id="cb49-26"><a href="#cb49-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-27"><a href="#cb49-27" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> gcps <span class="op">=</span> urban<span class="op">.</span><span class="fu">merge</span>(bare)<span class="op">.</span><span class="fu">merge</span>(water)<span class="op">.</span><span class="fu">merge</span>(vegetation)</span>
<span id="cb49-28"><a href="#cb49-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-29"><a href="#cb49-29" aria-hidden="true" tabindex="-1"></a><span class="co">// Overlay the point on the image to get training data.</span></span>
<span id="cb49-30"><a href="#cb49-30" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> training <span class="op">=</span> composite<span class="op">.</span><span class="fu">sampleRegions</span>({</span>
<span id="cb49-31"><a href="#cb49-31" aria-hidden="true" tabindex="-1"></a>  <span class="dt">collection</span><span class="op">:</span> gcps<span class="op">,</span> </span>
<span id="cb49-32"><a href="#cb49-32" aria-hidden="true" tabindex="-1"></a>  <span class="dt">properties</span><span class="op">:</span> [<span class="st">&#39;landcover&#39;</span>]<span class="op">,</span> </span>
<span id="cb49-33"><a href="#cb49-33" aria-hidden="true" tabindex="-1"></a>  <span class="dt">scale</span><span class="op">:</span> <span class="dv">10</span></span>
<span id="cb49-34"><a href="#cb49-34" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb49-35"><a href="#cb49-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-36"><a href="#cb49-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-37"><a href="#cb49-37" aria-hidden="true" tabindex="-1"></a><span class="co">// Train a classifier.</span></span>
<span id="cb49-38"><a href="#cb49-38" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> classifier <span class="op">=</span> ee<span class="op">.</span><span class="at">Classifier</span><span class="op">.</span><span class="fu">smileRandomForest</span>(<span class="dv">50</span>)<span class="op">.</span><span class="fu">train</span>({</span>
<span id="cb49-39"><a href="#cb49-39" aria-hidden="true" tabindex="-1"></a>  <span class="dt">features</span><span class="op">:</span> training<span class="op">,</span>  </span>
<span id="cb49-40"><a href="#cb49-40" aria-hidden="true" tabindex="-1"></a>  <span class="dt">classProperty</span><span class="op">:</span> <span class="st">&#39;landcover&#39;</span><span class="op">,</span> </span>
<span id="cb49-41"><a href="#cb49-41" aria-hidden="true" tabindex="-1"></a>  <span class="dt">inputProperties</span><span class="op">:</span> composite<span class="op">.</span><span class="fu">bandNames</span>()</span>
<span id="cb49-42"><a href="#cb49-42" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb49-43"><a href="#cb49-43" aria-hidden="true" tabindex="-1"></a><span class="co">// // Classify the image.</span></span>
<span id="cb49-44"><a href="#cb49-44" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> classified <span class="op">=</span> composite<span class="op">.</span><span class="fu">classify</span>(classifier)<span class="op">;</span></span>
<span id="cb49-45"><a href="#cb49-45" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(classified<span class="op">,</span> {<span class="dt">min</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span> <span class="dv">3</span><span class="op">,</span> <span class="dt">palette</span><span class="op">:</span> [<span class="st">&#39;gray&#39;</span><span class="op">,</span> <span class="st">&#39;brown&#39;</span><span class="op">,</span> <span class="st">&#39;blue&#39;</span><span class="op">,</span> <span class="st">&#39;green&#39;</span>]}<span class="op">,</span> <span class="st">&#39;2019&#39;</span>)<span class="op">;</span> </span>
<span id="cb49-46"><a href="#cb49-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-47"><a href="#cb49-47" aria-hidden="true" tabindex="-1"></a><span class="co">// Display the GCPs</span></span>
<span id="cb49-48"><a href="#cb49-48" aria-hidden="true" tabindex="-1"></a><span class="co">// We use the style() function to style the GCPs</span></span>
<span id="cb49-49"><a href="#cb49-49" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> palette <span class="op">=</span> ee<span class="op">.</span><span class="fu">List</span>([<span class="st">&#39;gray&#39;</span><span class="op">,</span><span class="st">&#39;brown&#39;</span><span class="op">,</span><span class="st">&#39;blue&#39;</span><span class="op">,</span><span class="st">&#39;green&#39;</span>])</span>
<span id="cb49-50"><a href="#cb49-50" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> landcover <span class="op">=</span> ee<span class="op">.</span><span class="fu">List</span>([<span class="dv">0</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">3</span>])</span>
<span id="cb49-51"><a href="#cb49-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-52"><a href="#cb49-52" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> gcpsStyled <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(</span>
<span id="cb49-53"><a href="#cb49-53" aria-hidden="true" tabindex="-1"></a>  landcover<span class="op">.</span><span class="fu">map</span>(<span class="kw">function</span>(lc){</span>
<span id="cb49-54"><a href="#cb49-54" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> color <span class="op">=</span> palette<span class="op">.</span><span class="fu">get</span>(landcover<span class="op">.</span><span class="fu">indexOf</span>(lc))<span class="op">;</span></span>
<span id="cb49-55"><a href="#cb49-55" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> markerStyle <span class="op">=</span> { <span class="dt">color</span><span class="op">:</span> <span class="st">&#39;white&#39;</span><span class="op">,</span> <span class="dt">pointShape</span><span class="op">:</span> <span class="st">&#39;diamond&#39;</span><span class="op">,</span> </span>
<span id="cb49-56"><a href="#cb49-56" aria-hidden="true" tabindex="-1"></a>      <span class="dt">pointSize</span><span class="op">:</span> <span class="dv">4</span><span class="op">,</span> <span class="dt">width</span><span class="op">:</span> <span class="dv">1</span><span class="op">,</span> <span class="dt">fillColor</span><span class="op">:</span> color}</span>
<span id="cb49-57"><a href="#cb49-57" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> gcps<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;landcover&#39;</span><span class="op">,</span> lc))</span>
<span id="cb49-58"><a href="#cb49-58" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">map</span>(<span class="kw">function</span>(point){</span>
<span id="cb49-59"><a href="#cb49-59" aria-hidden="true" tabindex="-1"></a>                  <span class="cf">return</span> point<span class="op">.</span><span class="fu">set</span>(<span class="st">&#39;style&#39;</span><span class="op">,</span> markerStyle)</span>
<span id="cb49-60"><a href="#cb49-60" aria-hidden="true" tabindex="-1"></a>                })</span>
<span id="cb49-61"><a href="#cb49-61" aria-hidden="true" tabindex="-1"></a>      }))<span class="op">.</span><span class="fu">flatten</span>()<span class="op">;</span></span>
<span id="cb49-62"><a href="#cb49-62" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb49-63"><a href="#cb49-63" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(gcpsStyled<span class="op">.</span><span class="fu">style</span>({<span class="dt">styleProperty</span><span class="op">:</span><span class="st">&quot;style&quot;</span>})<span class="op">,</span> {}<span class="op">,</span> <span class="st">&#39;GCPs&#39;</span>)</span>
<span id="cb49-64"><a href="#cb49-64" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">centerObject</span>(gcpsStyled)</span>
<span id="cb49-65"><a href="#cb49-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-66"><a href="#cb49-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-67"><a href="#cb49-67" aria-hidden="true" tabindex="-1"></a><span class="co">// landcover=2 is water</span></span>
<span id="cb49-68"><a href="#cb49-68" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> waterClass <span class="op">=</span> classified<span class="op">.</span><span class="fu">eq</span>(<span class="dv">2</span>)</span>
<span id="cb49-69"><a href="#cb49-69" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(waterClass<span class="op">,</span> {<span class="dt">min</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span> <span class="dv">1</span><span class="op">,</span> <span class="dt">palette</span><span class="op">:</span> [<span class="st">&#39;white&#39;</span><span class="op">,</span> <span class="st">&#39;blue&#39;</span>]}<span class="op">,</span> <span class="st">&#39;Water&#39;</span>)<span class="op">;</span></span></code></pre></div>
<p><a href="https://code.earthengine.google.com/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3A04-Land_Use_Land_Cover_Classification%2F01d_Basic_Supervised_Classification_(noimport)" target="_blank">Open in Code Editor ↗</a></p>
<div class="figure" style="text-align: center">
<img src="images/gee_water_resources_management/classified.png" alt="Supervised Classification Output" width="100%" />
<p class="caption">
Supervised Classification Output
</p>
</div>
<div id="exercise-24" class="section level3">
<h3>Exercise</h3>
<p>Select and city of your choice from <code>urbanAreas</code> data. Create Feature collection with property <code>landcover</code> and collect training points for every four classes <em>urban, bare, water</em>, and <em>vegetation</em>. Then use the code to classify and create a land cover of the city.</p>
<div class="sourceCode" id="cb50"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> s2 <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&quot;COPERNICUS/S2_SR&quot;</span>)</span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> urbanAreas <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">&quot;users/ujavalgandhi/e2e/ne_10m_urban_areas&quot;</span>)</span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a><span class="co">// Perform supervised classification for your city</span></span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a><span class="co">// Find the feature id by adding the layer to the map and using Inspector.</span></span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> city <span class="op">=</span> urbanAreas<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;system:index&#39;</span><span class="op">,</span> <span class="st">&#39;00000000000000002bf8&#39;</span>))</span>
<span id="cb50-7"><a href="#cb50-7" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> geometry <span class="op">=</span> city<span class="op">.</span><span class="fu">geometry</span>()</span>
<span id="cb50-8"><a href="#cb50-8" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">centerObject</span>(geometry)</span>
<span id="cb50-9"><a href="#cb50-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-10"><a href="#cb50-10" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> filtered <span class="op">=</span> s2</span>
<span id="cb50-11"><a href="#cb50-11" aria-hidden="true" tabindex="-1"></a><span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">lt</span>(<span class="st">&#39;CLOUDY_PIXEL_PERCENTAGE&#39;</span><span class="op">,</span> <span class="dv">30</span>))</span>
<span id="cb50-12"><a href="#cb50-12" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(<span class="st">&#39;2019-01-01&#39;</span><span class="op">,</span> <span class="st">&#39;2019-12-31&#39;</span>))</span>
<span id="cb50-13"><a href="#cb50-13" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">bounds</span>(geometry))</span>
<span id="cb50-14"><a href="#cb50-14" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;B.*&#39;</span>)</span>
<span id="cb50-15"><a href="#cb50-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-16"><a href="#cb50-16" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> composite <span class="op">=</span> filtered<span class="op">.</span><span class="fu">median</span>()<span class="op">.</span><span class="fu">clip</span>(geometry) </span>
<span id="cb50-17"><a href="#cb50-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-18"><a href="#cb50-18" aria-hidden="true" tabindex="-1"></a><span class="co">// Display the input composite.</span></span>
<span id="cb50-19"><a href="#cb50-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-20"><a href="#cb50-20" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> rgbVis <span class="op">=</span> {<span class="dt">min</span><span class="op">:</span> <span class="fl">0.0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span> <span class="dv">3000</span><span class="op">,</span> <span class="dt">bands</span><span class="op">:</span> [<span class="st">&#39;B4&#39;</span><span class="op">,</span> <span class="st">&#39;B3&#39;</span><span class="op">,</span> <span class="st">&#39;B2&#39;</span>]}<span class="op">;</span></span>
<span id="cb50-21"><a href="#cb50-21" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(composite<span class="op">,</span> rgbVis<span class="op">,</span> <span class="st">&#39;image&#39;</span>)<span class="op">;</span></span>
<span id="cb50-22"><a href="#cb50-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-23"><a href="#cb50-23" aria-hidden="true" tabindex="-1"></a><span class="co">// Exercise</span></span>
<span id="cb50-24"><a href="#cb50-24" aria-hidden="true" tabindex="-1"></a><span class="co">// Add training points for 4 classes</span></span>
<span id="cb50-25"><a href="#cb50-25" aria-hidden="true" tabindex="-1"></a><span class="co">// Assign the &#39;landcover&#39; property as follows</span></span>
<span id="cb50-26"><a href="#cb50-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-27"><a href="#cb50-27" aria-hidden="true" tabindex="-1"></a><span class="co">// urban: 0</span></span>
<span id="cb50-28"><a href="#cb50-28" aria-hidden="true" tabindex="-1"></a><span class="co">// bare: 1</span></span>
<span id="cb50-29"><a href="#cb50-29" aria-hidden="true" tabindex="-1"></a><span class="co">// water: 2</span></span>
<span id="cb50-30"><a href="#cb50-30" aria-hidden="true" tabindex="-1"></a><span class="co">// vegetation: 3</span></span>
<span id="cb50-31"><a href="#cb50-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-32"><a href="#cb50-32" aria-hidden="true" tabindex="-1"></a><span class="co">// After adding points, uncomments lines below</span></span>
<span id="cb50-33"><a href="#cb50-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-34"><a href="#cb50-34" aria-hidden="true" tabindex="-1"></a><span class="co">// var gcps = urban.merge(bare).merge(water).merge(vegetation)</span></span>
<span id="cb50-35"><a href="#cb50-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-36"><a href="#cb50-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-37"><a href="#cb50-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-38"><a href="#cb50-38" aria-hidden="true" tabindex="-1"></a><span class="co">// // Overlay the point on the image to get training data.</span></span>
<span id="cb50-39"><a href="#cb50-39" aria-hidden="true" tabindex="-1"></a><span class="co">// var training = composite.sampleRegions({</span></span>
<span id="cb50-40"><a href="#cb50-40" aria-hidden="true" tabindex="-1"></a><span class="co">//   collection: gcps, </span></span>
<span id="cb50-41"><a href="#cb50-41" aria-hidden="true" tabindex="-1"></a><span class="co">//   properties: [&#39;landcover&#39;], </span></span>
<span id="cb50-42"><a href="#cb50-42" aria-hidden="true" tabindex="-1"></a><span class="co">//   scale: 200,</span></span>
<span id="cb50-43"><a href="#cb50-43" aria-hidden="true" tabindex="-1"></a><span class="co">//   tileScale: 16</span></span>
<span id="cb50-44"><a href="#cb50-44" aria-hidden="true" tabindex="-1"></a><span class="co">// });</span></span>
<span id="cb50-45"><a href="#cb50-45" aria-hidden="true" tabindex="-1"></a><span class="co">// print(training)</span></span>
<span id="cb50-46"><a href="#cb50-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-47"><a href="#cb50-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-48"><a href="#cb50-48" aria-hidden="true" tabindex="-1"></a><span class="co">// // Train a classifier.</span></span>
<span id="cb50-49"><a href="#cb50-49" aria-hidden="true" tabindex="-1"></a><span class="co">// var classifier = ee.Classifier.smileRandomForest(50).train({</span></span>
<span id="cb50-50"><a href="#cb50-50" aria-hidden="true" tabindex="-1"></a><span class="co">//   features: training,  </span></span>
<span id="cb50-51"><a href="#cb50-51" aria-hidden="true" tabindex="-1"></a><span class="co">//   classProperty: &#39;landcover&#39;, </span></span>
<span id="cb50-52"><a href="#cb50-52" aria-hidden="true" tabindex="-1"></a><span class="co">//   inputProperties: composite.bandNames()</span></span>
<span id="cb50-53"><a href="#cb50-53" aria-hidden="true" tabindex="-1"></a><span class="co">// });</span></span>
<span id="cb50-54"><a href="#cb50-54" aria-hidden="true" tabindex="-1"></a><span class="co">// // // Classify the image.</span></span>
<span id="cb50-55"><a href="#cb50-55" aria-hidden="true" tabindex="-1"></a><span class="co">// var classified = composite.classify(classifier);</span></span>
<span id="cb50-56"><a href="#cb50-56" aria-hidden="true" tabindex="-1"></a><span class="co">// Map.addLayer(classified, {min: 0, max: 3, palette: [&#39;gray&#39;, &#39;brown&#39;, &#39;blue&#39;, &#39;green&#39;]}, &#39;2019&#39;); </span></span>
<span id="cb50-57"><a href="#cb50-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-58"><a href="#cb50-58" aria-hidden="true" tabindex="-1"></a><span class="co">// // Extract water</span></span>
<span id="cb50-59"><a href="#cb50-59" aria-hidden="true" tabindex="-1"></a><span class="co">// var waterClass = classified.eq(2)</span></span>
<span id="cb50-60"><a href="#cb50-60" aria-hidden="true" tabindex="-1"></a><span class="co">// Map.addLayer(waterClass, {min: 0, max: 1, palette: [&#39;white&#39;, &#39;blue&#39;]}, &#39;Water&#39;);</span></span></code></pre></div>
<p><a href="https://code.earthengine.google.com/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3A04-Land_Use_Land_Cover_Classification%2F01c_Basic_Supervised_Classification_(exercise)" target="_blank">Try in Code Editor ↗</a></p>
</div>
</div>
<div id="accuracy-assessment" class="section level2">
<h2>02. Accuracy Assessment</h2>
<p>It is important to get a quantitative estimate of the accuracy of the classification. To do this, a common strategy is to divide your training samples into 2 random fractions - one used for <em>training</em> the model and the other for <em>validation</em> of the predictions. Once a classifier is trained, it can be used to classify the entire image. We can then compare the classified values with the ones in the validation fraction. We can use the <code>ee.Classifier.confusionMatrix()</code> method to calculate a <em>Confusion Matrix</em> representing expected accuracy.</p>
<blockquote>
<p>Don’t get carried away tweaking your model to give you the highest validation accuracy. You must use both qualitative measures (such as visual inspection of results) along with quantitative measures to assess the results.</p>
</blockquote>
<div class="sourceCode" id="cb51"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> s2 <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&quot;COPERNICUS/S2_SR&quot;</span>)<span class="op">;</span></span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> basin <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">&quot;WWF/HydroSHEDS/v1/Basins/hybas_7&quot;</span>)<span class="op">;</span></span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> gcp <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">&quot;users/ujavalgandhi/e2e/arkavathy_gcps&quot;</span>)<span class="op">;</span></span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> arkavathy <span class="op">=</span> basin<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;HYBAS_ID&#39;</span><span class="op">,</span> <span class="dv">4071139640</span>))</span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> boundary <span class="op">=</span> arkavathy<span class="op">.</span><span class="fu">geometry</span>()</span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> rgbVis <span class="op">=</span> {</span>
<span id="cb51-8"><a href="#cb51-8" aria-hidden="true" tabindex="-1"></a>  <span class="dt">min</span><span class="op">:</span> <span class="fl">0.0</span><span class="op">,</span></span>
<span id="cb51-9"><a href="#cb51-9" aria-hidden="true" tabindex="-1"></a>  <span class="dt">max</span><span class="op">:</span> <span class="dv">3000</span><span class="op">,</span></span>
<span id="cb51-10"><a href="#cb51-10" aria-hidden="true" tabindex="-1"></a>  <span class="dt">bands</span><span class="op">:</span> [<span class="st">&#39;B4&#39;</span><span class="op">,</span> <span class="st">&#39;B3&#39;</span><span class="op">,</span> <span class="st">&#39;B2&#39;</span>]<span class="op">,</span></span>
<span id="cb51-11"><a href="#cb51-11" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb51-12"><a href="#cb51-12" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb51-13"><a href="#cb51-13" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> filtered <span class="op">=</span> s2</span>
<span id="cb51-14"><a href="#cb51-14" aria-hidden="true" tabindex="-1"></a><span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">lt</span>(<span class="st">&#39;CLOUDY_PIXEL_PERCENTAGE&#39;</span><span class="op">,</span> <span class="dv">30</span>))</span>
<span id="cb51-15"><a href="#cb51-15" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(<span class="st">&#39;2019-01-01&#39;</span><span class="op">,</span> <span class="st">&#39;2019-12-31&#39;</span>))</span>
<span id="cb51-16"><a href="#cb51-16" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">bounds</span>(boundary))</span>
<span id="cb51-17"><a href="#cb51-17" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;B.*&#39;</span>)</span>
<span id="cb51-18"><a href="#cb51-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-19"><a href="#cb51-19" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> composite <span class="op">=</span> filtered<span class="op">.</span><span class="fu">median</span>()<span class="op">.</span><span class="fu">clip</span>(boundary) </span>
<span id="cb51-20"><a href="#cb51-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-21"><a href="#cb51-21" aria-hidden="true" tabindex="-1"></a><span class="co">// Display the input composite.</span></span>
<span id="cb51-22"><a href="#cb51-22" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(composite<span class="op">,</span> rgbVis<span class="op">,</span> <span class="st">&#39;image&#39;</span>)<span class="op">;</span></span>
<span id="cb51-23"><a href="#cb51-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-24"><a href="#cb51-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-25"><a href="#cb51-25" aria-hidden="true" tabindex="-1"></a><span class="co">// Add a random column and split the GCPs into training and validation set</span></span>
<span id="cb51-26"><a href="#cb51-26" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> gcp <span class="op">=</span> gcp<span class="op">.</span><span class="fu">randomColumn</span>()</span>
<span id="cb51-27"><a href="#cb51-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-28"><a href="#cb51-28" aria-hidden="true" tabindex="-1"></a><span class="co">// This being a simpler classification, we take 60% points</span></span>
<span id="cb51-29"><a href="#cb51-29" aria-hidden="true" tabindex="-1"></a><span class="co">// for validation. Normal recommended ratio is</span></span>
<span id="cb51-30"><a href="#cb51-30" aria-hidden="true" tabindex="-1"></a><span class="co">// 70% training, 30% validation</span></span>
<span id="cb51-31"><a href="#cb51-31" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> trainingGcp <span class="op">=</span> gcp<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">lt</span>(<span class="st">&#39;random&#39;</span><span class="op">,</span> <span class="fl">0.6</span>))<span class="op">;</span></span>
<span id="cb51-32"><a href="#cb51-32" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> validationGcp <span class="op">=</span> gcp<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">gte</span>(<span class="st">&#39;random&#39;</span><span class="op">,</span> <span class="fl">0.6</span>))<span class="op">;</span></span>
<span id="cb51-33"><a href="#cb51-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-34"><a href="#cb51-34" aria-hidden="true" tabindex="-1"></a><span class="co">// Overlay the point on the image to get training data.</span></span>
<span id="cb51-35"><a href="#cb51-35" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> training <span class="op">=</span> composite<span class="op">.</span><span class="fu">sampleRegions</span>({</span>
<span id="cb51-36"><a href="#cb51-36" aria-hidden="true" tabindex="-1"></a>  <span class="dt">collection</span><span class="op">:</span> trainingGcp<span class="op">,</span></span>
<span id="cb51-37"><a href="#cb51-37" aria-hidden="true" tabindex="-1"></a>  <span class="dt">properties</span><span class="op">:</span> [<span class="st">&#39;landcover&#39;</span>]<span class="op">,</span></span>
<span id="cb51-38"><a href="#cb51-38" aria-hidden="true" tabindex="-1"></a>  <span class="dt">scale</span><span class="op">:</span> <span class="dv">10</span><span class="op">,</span></span>
<span id="cb51-39"><a href="#cb51-39" aria-hidden="true" tabindex="-1"></a>  <span class="dt">tileScale</span><span class="op">:</span> <span class="dv">16</span></span>
<span id="cb51-40"><a href="#cb51-40" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb51-41"><a href="#cb51-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-42"><a href="#cb51-42" aria-hidden="true" tabindex="-1"></a><span class="co">// Train a classifier.</span></span>
<span id="cb51-43"><a href="#cb51-43" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> classifier <span class="op">=</span> ee<span class="op">.</span><span class="at">Classifier</span><span class="op">.</span><span class="fu">smileRandomForest</span>(<span class="dv">50</span>)</span>
<span id="cb51-44"><a href="#cb51-44" aria-hidden="true" tabindex="-1"></a><span class="op">.</span><span class="fu">train</span>({</span>
<span id="cb51-45"><a href="#cb51-45" aria-hidden="true" tabindex="-1"></a>  <span class="dt">features</span><span class="op">:</span> training<span class="op">,</span>  </span>
<span id="cb51-46"><a href="#cb51-46" aria-hidden="true" tabindex="-1"></a>  <span class="dt">classProperty</span><span class="op">:</span> <span class="st">&#39;landcover&#39;</span><span class="op">,</span></span>
<span id="cb51-47"><a href="#cb51-47" aria-hidden="true" tabindex="-1"></a>  <span class="dt">inputProperties</span><span class="op">:</span> composite<span class="op">.</span><span class="fu">bandNames</span>()</span>
<span id="cb51-48"><a href="#cb51-48" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb51-49"><a href="#cb51-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-50"><a href="#cb51-50" aria-hidden="true" tabindex="-1"></a><span class="co">// Classify the image.</span></span>
<span id="cb51-51"><a href="#cb51-51" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> classified <span class="op">=</span> composite<span class="op">.</span><span class="fu">classify</span>(classifier)<span class="op">;</span></span>
<span id="cb51-52"><a href="#cb51-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-53"><a href="#cb51-53" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(classified<span class="op">,</span> {<span class="dt">min</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span> <span class="dv">3</span><span class="op">,</span> <span class="dt">palette</span><span class="op">:</span> [<span class="st">&#39;gray&#39;</span><span class="op">,</span> <span class="st">&#39;brown&#39;</span><span class="op">,</span> <span class="st">&#39;blue&#39;</span><span class="op">,</span> <span class="st">&#39;green&#39;</span>]}<span class="op">,</span> <span class="st">&#39;2019&#39;</span>)<span class="op">;</span></span>
<span id="cb51-54"><a href="#cb51-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-55"><a href="#cb51-55" aria-hidden="true" tabindex="-1"></a><span class="co">//************************************************************************** </span></span>
<span id="cb51-56"><a href="#cb51-56" aria-hidden="true" tabindex="-1"></a><span class="co">// Accuracy Assessment</span></span>
<span id="cb51-57"><a href="#cb51-57" aria-hidden="true" tabindex="-1"></a><span class="co">//************************************************************************** </span></span>
<span id="cb51-58"><a href="#cb51-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-59"><a href="#cb51-59" aria-hidden="true" tabindex="-1"></a><span class="co">// Use classification map to assess accuracy using the validation fraction</span></span>
<span id="cb51-60"><a href="#cb51-60" aria-hidden="true" tabindex="-1"></a><span class="co">// of the overall training set created above.</span></span>
<span id="cb51-61"><a href="#cb51-61" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> test <span class="op">=</span> classified<span class="op">.</span><span class="fu">sampleRegions</span>({</span>
<span id="cb51-62"><a href="#cb51-62" aria-hidden="true" tabindex="-1"></a>  <span class="dt">collection</span><span class="op">:</span> validationGcp<span class="op">,</span></span>
<span id="cb51-63"><a href="#cb51-63" aria-hidden="true" tabindex="-1"></a>  <span class="dt">properties</span><span class="op">:</span> [<span class="st">&#39;landcover&#39;</span>]<span class="op">,</span></span>
<span id="cb51-64"><a href="#cb51-64" aria-hidden="true" tabindex="-1"></a>  <span class="dt">tileScale</span><span class="op">:</span> <span class="dv">16</span><span class="op">,</span></span>
<span id="cb51-65"><a href="#cb51-65" aria-hidden="true" tabindex="-1"></a>  <span class="dt">scale</span><span class="op">:</span> <span class="dv">10</span><span class="op">,</span></span>
<span id="cb51-66"><a href="#cb51-66" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb51-67"><a href="#cb51-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-68"><a href="#cb51-68" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> testConfusionMatrix <span class="op">=</span> test<span class="op">.</span><span class="fu">errorMatrix</span>(<span class="st">&#39;landcover&#39;</span><span class="op">,</span> <span class="st">&#39;classification&#39;</span>)</span>
<span id="cb51-69"><a href="#cb51-69" aria-hidden="true" tabindex="-1"></a><span class="co">// Printing of confusion matrix may time out. Alternatively, you can export it as CSV</span></span>
<span id="cb51-70"><a href="#cb51-70" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="st">&#39;Confusion Matrix&#39;</span><span class="op">,</span> testConfusionMatrix)<span class="op">;</span></span>
<span id="cb51-71"><a href="#cb51-71" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="st">&#39;Test Accuracy&#39;</span><span class="op">,</span> testConfusionMatrix<span class="op">.</span><span class="fu">accuracy</span>())<span class="op">;</span></span></code></pre></div>
<p><a href="https://code.earthengine.google.com/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3A04-Land_Use_Land_Cover_Classification%2F02b_Accuracy_Assessment_(complete)" target="_blank">Open in Code Editor ↗</a></p>
<p>Output</p>
<pre><code>Confusion Matrix
0: [41,4,0,0]
1: [3,43,0,0]
2: [0,0,48,3]
3: [0,0,0,37]

Test Accuracy
0.9441340782122905</code></pre>
</div>
<div id="improving-the-classification" class="section level2">
<h2>03. Improving the Classification</h2>
<p>The Earth Engine data-model is especially well suited for machine learning tasks because of its ability to easily incorporate data sources of different spatial resolutions, projections and data types together By giving additional information to the classifier, it is able to separate different classes easily. Here we take the same example and augment it with the following techniques</p>
<ul>
<li><em>Apply Cloud Masking</em></li>
<li><em>Add Spectral Indices</em>: We add bands for different spectral indices such as - NDVI, NDBI, MNDWI and BSI.</li>
<li><em>Add Elevation and Slope</em>: We also add slope and elevation bands from the ALOS DEM.</li>
<li><em>Normalize the Inputs</em>: Machine learning models work best when all the inputs have the same scale. We will divide each band with the maximum value. This method ensures that all input values are between 0-1.</li>
</ul>
<p>Our training features have more parameters and contain values of the same scale. The result is a much improved classification.</p>
<div class="sourceCode" id="cb53"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> s2 <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&quot;COPERNICUS/S2_SR&quot;</span>)<span class="op">;</span></span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> basin <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">&quot;WWF/HydroSHEDS/v1/Basins/hybas_7&quot;</span>)<span class="op">;</span></span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> gcp <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">&quot;users/ujavalgandhi/e2e/arkavathy_gcps&quot;</span>)<span class="op">;</span></span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> alos <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(<span class="st">&quot;JAXA/ALOS/AW3D30/V2_2&quot;</span>)<span class="op">;</span></span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> arkavathy <span class="op">=</span> basin<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;HYBAS_ID&#39;</span><span class="op">,</span> <span class="dv">4071139640</span>))</span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> boundary <span class="op">=</span> arkavathy<span class="op">.</span><span class="fu">geometry</span>()</span>
<span id="cb53-8"><a href="#cb53-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-9"><a href="#cb53-9" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> s2 <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&quot;COPERNICUS/S2_SR&quot;</span>)</span>
<span id="cb53-10"><a href="#cb53-10" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> rgbVis <span class="op">=</span> {</span>
<span id="cb53-11"><a href="#cb53-11" aria-hidden="true" tabindex="-1"></a>  <span class="dt">min</span><span class="op">:</span> <span class="fl">0.0</span><span class="op">,</span></span>
<span id="cb53-12"><a href="#cb53-12" aria-hidden="true" tabindex="-1"></a>  <span class="dt">max</span><span class="op">:</span> <span class="fl">0.3</span><span class="op">,</span></span>
<span id="cb53-13"><a href="#cb53-13" aria-hidden="true" tabindex="-1"></a>  <span class="dt">bands</span><span class="op">:</span> [<span class="st">&#39;B4&#39;</span><span class="op">,</span> <span class="st">&#39;B3&#39;</span><span class="op">,</span> <span class="st">&#39;B2&#39;</span>]<span class="op">,</span></span>
<span id="cb53-14"><a href="#cb53-14" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb53-15"><a href="#cb53-15" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb53-16"><a href="#cb53-16" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">maskCloudAndShadowsSR</span>(image) {</span>
<span id="cb53-17"><a href="#cb53-17" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> cloudProb <span class="op">=</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;MSK_CLDPRB&#39;</span>)<span class="op">;</span></span>
<span id="cb53-18"><a href="#cb53-18" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> snowProb <span class="op">=</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;MSK_SNWPRB&#39;</span>)<span class="op">;</span></span>
<span id="cb53-19"><a href="#cb53-19" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> cloud <span class="op">=</span> cloudProb<span class="op">.</span><span class="fu">lt</span>(<span class="dv">10</span>)<span class="op">;</span></span>
<span id="cb53-20"><a href="#cb53-20" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> scl <span class="op">=</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;SCL&#39;</span>)<span class="op">;</span> </span>
<span id="cb53-21"><a href="#cb53-21" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> shadow <span class="op">=</span> scl<span class="op">.</span><span class="fu">eq</span>(<span class="dv">3</span>)<span class="op">;</span> <span class="co">// 3 = cloud shadow</span></span>
<span id="cb53-22"><a href="#cb53-22" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> cirrus <span class="op">=</span> scl<span class="op">.</span><span class="fu">eq</span>(<span class="dv">10</span>)<span class="op">;</span> <span class="co">// 10 = cirrus</span></span>
<span id="cb53-23"><a href="#cb53-23" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Cloud probability less than 10% or cloud shadow classification</span></span>
<span id="cb53-24"><a href="#cb53-24" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> mask <span class="op">=</span> cloud<span class="op">.</span><span class="fu">and</span>(cirrus<span class="op">.</span><span class="fu">neq</span>(<span class="dv">1</span>))<span class="op">.</span><span class="fu">and</span>(shadow<span class="op">.</span><span class="fu">neq</span>(<span class="dv">1</span>))<span class="op">;</span></span>
<span id="cb53-25"><a href="#cb53-25" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> image<span class="op">.</span><span class="fu">updateMask</span>(mask)<span class="op">.</span><span class="fu">divide</span>(<span class="dv">10000</span>)<span class="op">;</span></span>
<span id="cb53-26"><a href="#cb53-26" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb53-27"><a href="#cb53-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-28"><a href="#cb53-28" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> filtered <span class="op">=</span> s2</span>
<span id="cb53-29"><a href="#cb53-29" aria-hidden="true" tabindex="-1"></a><span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">lt</span>(<span class="st">&#39;CLOUDY_PIXEL_PERCENTAGE&#39;</span><span class="op">,</span> <span class="dv">30</span>))</span>
<span id="cb53-30"><a href="#cb53-30" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(<span class="st">&#39;2019-01-01&#39;</span><span class="op">,</span> <span class="st">&#39;2019-12-31&#39;</span>))</span>
<span id="cb53-31"><a href="#cb53-31" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">bounds</span>(boundary))</span>
<span id="cb53-32"><a href="#cb53-32" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">map</span>(maskCloudAndShadowsSR)</span>
<span id="cb53-33"><a href="#cb53-33" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;B.*&#39;</span>)</span>
<span id="cb53-34"><a href="#cb53-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-35"><a href="#cb53-35" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> composite <span class="op">=</span> filtered<span class="op">.</span><span class="fu">median</span>()<span class="op">.</span><span class="fu">clip</span>(boundary) </span>
<span id="cb53-36"><a href="#cb53-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-37"><a href="#cb53-37" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> addIndices <span class="op">=</span> <span class="kw">function</span>(image) {</span>
<span id="cb53-38"><a href="#cb53-38" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> ndvi <span class="op">=</span> image<span class="op">.</span><span class="fu">normalizedDifference</span>([<span class="st">&#39;B8&#39;</span><span class="op">,</span> <span class="st">&#39;B4&#39;</span>])<span class="op">.</span><span class="fu">rename</span>([<span class="st">&#39;ndvi&#39;</span>])<span class="op">;</span></span>
<span id="cb53-39"><a href="#cb53-39" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> ndbi <span class="op">=</span> image<span class="op">.</span><span class="fu">normalizedDifference</span>([<span class="st">&#39;B11&#39;</span><span class="op">,</span> <span class="st">&#39;B8&#39;</span>])<span class="op">.</span><span class="fu">rename</span>([<span class="st">&#39;ndbi&#39;</span>])<span class="op">;</span></span>
<span id="cb53-40"><a href="#cb53-40" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> mndwi <span class="op">=</span> image<span class="op">.</span><span class="fu">normalizedDifference</span>([<span class="st">&#39;B3&#39;</span><span class="op">,</span> <span class="st">&#39;B11&#39;</span>])<span class="op">.</span><span class="fu">rename</span>([<span class="st">&#39;mndwi&#39;</span>])<span class="op">;</span> </span>
<span id="cb53-41"><a href="#cb53-41" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> bsi <span class="op">=</span> image<span class="op">.</span><span class="fu">expression</span>(</span>
<span id="cb53-42"><a href="#cb53-42" aria-hidden="true" tabindex="-1"></a>      <span class="st">&#39;(( X + Y ) - (A + B)) /(( X + Y ) + (A + B)) &#39;</span><span class="op">,</span> {</span>
<span id="cb53-43"><a href="#cb53-43" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;X&#39;</span><span class="op">:</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;B11&#39;</span>)<span class="op">,</span> <span class="co">//swir1</span></span>
<span id="cb53-44"><a href="#cb53-44" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;Y&#39;</span><span class="op">:</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;B4&#39;</span>)<span class="op">,</span>  <span class="co">//red</span></span>
<span id="cb53-45"><a href="#cb53-45" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;A&#39;</span><span class="op">:</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;B8&#39;</span>)<span class="op">,</span> <span class="co">// nir</span></span>
<span id="cb53-46"><a href="#cb53-46" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;B&#39;</span><span class="op">:</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;B2&#39;</span>)<span class="op">,</span> <span class="co">// blue</span></span>
<span id="cb53-47"><a href="#cb53-47" aria-hidden="true" tabindex="-1"></a>  })<span class="op">.</span><span class="fu">rename</span>(<span class="st">&#39;bsi&#39;</span>)<span class="op">;</span></span>
<span id="cb53-48"><a href="#cb53-48" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> image<span class="op">.</span><span class="fu">addBands</span>(ndvi)<span class="op">.</span><span class="fu">addBands</span>(ndbi)<span class="op">.</span><span class="fu">addBands</span>(mndwi)<span class="op">.</span><span class="fu">addBands</span>(bsi)</span>
<span id="cb53-49"><a href="#cb53-49" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb53-50"><a href="#cb53-50" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> composite <span class="op">=</span> <span class="fu">addIndices</span>(composite)<span class="op">;</span></span>
<span id="cb53-51"><a href="#cb53-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-52"><a href="#cb53-52" aria-hidden="true" tabindex="-1"></a><span class="co">// Elevation and Slope</span></span>
<span id="cb53-53"><a href="#cb53-53" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> alos <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(<span class="st">&quot;JAXA/ALOS/AW3D30/V2_2&quot;</span>)<span class="op">;</span></span>
<span id="cb53-54"><a href="#cb53-54" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> elev <span class="op">=</span> alos<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;AVE_DSM&#39;</span>)<span class="op">.</span><span class="fu">rename</span>(<span class="st">&#39;elev&#39;</span>)<span class="op">;</span></span>
<span id="cb53-55"><a href="#cb53-55" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> slope <span class="op">=</span> ee<span class="op">.</span><span class="at">Terrain</span><span class="op">.</span><span class="fu">slope</span>(alos<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;AVE_DSM&#39;</span>))<span class="op">.</span><span class="fu">rename</span>(<span class="st">&#39;slope&#39;</span>)<span class="op">;</span></span>
<span id="cb53-56"><a href="#cb53-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-57"><a href="#cb53-57" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> composite <span class="op">=</span> composite<span class="op">.</span><span class="fu">addBands</span>(elev)<span class="op">.</span><span class="fu">addBands</span>(slope)</span>
<span id="cb53-58"><a href="#cb53-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-59"><a href="#cb53-59" aria-hidden="true" tabindex="-1"></a><span class="co">// Normalize the values so all values have the same range</span></span>
<span id="cb53-60"><a href="#cb53-60" aria-hidden="true" tabindex="-1"></a><span class="co">// This will make all bands between 0 and 1</span></span>
<span id="cb53-61"><a href="#cb53-61" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">normalize</span>(image){</span>
<span id="cb53-62"><a href="#cb53-62" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> bandNames <span class="op">=</span> image<span class="op">.</span><span class="fu">bandNames</span>()<span class="op">;</span></span>
<span id="cb53-63"><a href="#cb53-63" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Compute min and max of the image</span></span>
<span id="cb53-64"><a href="#cb53-64" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> minDict <span class="op">=</span> image<span class="op">.</span><span class="fu">reduceRegion</span>({</span>
<span id="cb53-65"><a href="#cb53-65" aria-hidden="true" tabindex="-1"></a>    <span class="dt">reducer</span><span class="op">:</span> ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">min</span>()<span class="op">,</span></span>
<span id="cb53-66"><a href="#cb53-66" aria-hidden="true" tabindex="-1"></a>    <span class="dt">geometry</span><span class="op">:</span> boundary<span class="op">,</span></span>
<span id="cb53-67"><a href="#cb53-67" aria-hidden="true" tabindex="-1"></a>    <span class="dt">scale</span><span class="op">:</span> <span class="dv">20</span><span class="op">,</span></span>
<span id="cb53-68"><a href="#cb53-68" aria-hidden="true" tabindex="-1"></a>    <span class="dt">maxPixels</span><span class="op">:</span> <span class="fl">1e9</span><span class="op">,</span></span>
<span id="cb53-69"><a href="#cb53-69" aria-hidden="true" tabindex="-1"></a>    <span class="dt">bestEffort</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb53-70"><a href="#cb53-70" aria-hidden="true" tabindex="-1"></a>    <span class="dt">tileScale</span><span class="op">:</span> <span class="dv">16</span></span>
<span id="cb53-71"><a href="#cb53-71" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb53-72"><a href="#cb53-72" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> maxDict <span class="op">=</span> image<span class="op">.</span><span class="fu">reduceRegion</span>({</span>
<span id="cb53-73"><a href="#cb53-73" aria-hidden="true" tabindex="-1"></a>    <span class="dt">reducer</span><span class="op">:</span> ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">max</span>()<span class="op">,</span></span>
<span id="cb53-74"><a href="#cb53-74" aria-hidden="true" tabindex="-1"></a>    <span class="dt">geometry</span><span class="op">:</span> boundary<span class="op">,</span></span>
<span id="cb53-75"><a href="#cb53-75" aria-hidden="true" tabindex="-1"></a>    <span class="dt">scale</span><span class="op">:</span> <span class="dv">20</span><span class="op">,</span></span>
<span id="cb53-76"><a href="#cb53-76" aria-hidden="true" tabindex="-1"></a>    <span class="dt">maxPixels</span><span class="op">:</span> <span class="fl">1e9</span><span class="op">,</span></span>
<span id="cb53-77"><a href="#cb53-77" aria-hidden="true" tabindex="-1"></a>    <span class="dt">bestEffort</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb53-78"><a href="#cb53-78" aria-hidden="true" tabindex="-1"></a>    <span class="dt">tileScale</span><span class="op">:</span> <span class="dv">16</span></span>
<span id="cb53-79"><a href="#cb53-79" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb53-80"><a href="#cb53-80" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> mins <span class="op">=</span> ee<span class="op">.</span><span class="at">Image</span><span class="op">.</span><span class="fu">constant</span>(minDict<span class="op">.</span><span class="fu">values</span>(bandNames))<span class="op">;</span></span>
<span id="cb53-81"><a href="#cb53-81" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> maxs <span class="op">=</span> ee<span class="op">.</span><span class="at">Image</span><span class="op">.</span><span class="fu">constant</span>(maxDict<span class="op">.</span><span class="fu">values</span>(bandNames))<span class="op">;</span></span>
<span id="cb53-82"><a href="#cb53-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-83"><a href="#cb53-83" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> normalized <span class="op">=</span> image<span class="op">.</span><span class="fu">subtract</span>(mins)<span class="op">.</span><span class="fu">divide</span>(maxs<span class="op">.</span><span class="fu">subtract</span>(mins))</span>
<span id="cb53-84"><a href="#cb53-84" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> normalized</span>
<span id="cb53-85"><a href="#cb53-85" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb53-86"><a href="#cb53-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-87"><a href="#cb53-87" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> composite <span class="op">=</span> <span class="fu">normalize</span>(composite)<span class="op">;</span></span>
<span id="cb53-88"><a href="#cb53-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-89"><a href="#cb53-89" aria-hidden="true" tabindex="-1"></a><span class="co">// Display the input composite.</span></span>
<span id="cb53-90"><a href="#cb53-90" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(composite<span class="op">,</span> rgbVis<span class="op">,</span> <span class="st">&#39;image&#39;</span>)<span class="op">;</span></span>
<span id="cb53-91"><a href="#cb53-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-92"><a href="#cb53-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-93"><a href="#cb53-93" aria-hidden="true" tabindex="-1"></a><span class="co">// Add a random column and split the GCPs into training and validation set</span></span>
<span id="cb53-94"><a href="#cb53-94" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> gcp <span class="op">=</span> gcp<span class="op">.</span><span class="fu">randomColumn</span>()</span>
<span id="cb53-95"><a href="#cb53-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-96"><a href="#cb53-96" aria-hidden="true" tabindex="-1"></a><span class="co">// This being a simpler classification, we take 60% points</span></span>
<span id="cb53-97"><a href="#cb53-97" aria-hidden="true" tabindex="-1"></a><span class="co">// for validation. Normal recommended ratio is</span></span>
<span id="cb53-98"><a href="#cb53-98" aria-hidden="true" tabindex="-1"></a><span class="co">// 70% training, 30% validation</span></span>
<span id="cb53-99"><a href="#cb53-99" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> trainingGcp <span class="op">=</span> gcp<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">lt</span>(<span class="st">&#39;random&#39;</span><span class="op">,</span> <span class="fl">0.6</span>))<span class="op">;</span></span>
<span id="cb53-100"><a href="#cb53-100" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> validationGcp <span class="op">=</span> gcp<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">gte</span>(<span class="st">&#39;random&#39;</span><span class="op">,</span> <span class="fl">0.6</span>))<span class="op">;</span></span>
<span id="cb53-101"><a href="#cb53-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-102"><a href="#cb53-102" aria-hidden="true" tabindex="-1"></a><span class="co">// Overlay the point on the image to get training data.</span></span>
<span id="cb53-103"><a href="#cb53-103" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> training <span class="op">=</span> composite<span class="op">.</span><span class="fu">sampleRegions</span>({</span>
<span id="cb53-104"><a href="#cb53-104" aria-hidden="true" tabindex="-1"></a>  <span class="dt">collection</span><span class="op">:</span> trainingGcp<span class="op">,</span></span>
<span id="cb53-105"><a href="#cb53-105" aria-hidden="true" tabindex="-1"></a>  <span class="dt">properties</span><span class="op">:</span> [<span class="st">&#39;landcover&#39;</span>]<span class="op">,</span></span>
<span id="cb53-106"><a href="#cb53-106" aria-hidden="true" tabindex="-1"></a>  <span class="dt">scale</span><span class="op">:</span> <span class="dv">10</span><span class="op">,</span></span>
<span id="cb53-107"><a href="#cb53-107" aria-hidden="true" tabindex="-1"></a>  <span class="dt">tileScale</span><span class="op">:</span> <span class="dv">16</span></span>
<span id="cb53-108"><a href="#cb53-108" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb53-109"><a href="#cb53-109" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(training)</span>
<span id="cb53-110"><a href="#cb53-110" aria-hidden="true" tabindex="-1"></a><span class="co">// Train a classifier.</span></span>
<span id="cb53-111"><a href="#cb53-111" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> classifier <span class="op">=</span> ee<span class="op">.</span><span class="at">Classifier</span><span class="op">.</span><span class="fu">smileRandomForest</span>(<span class="dv">50</span>)</span>
<span id="cb53-112"><a href="#cb53-112" aria-hidden="true" tabindex="-1"></a><span class="op">.</span><span class="fu">train</span>({</span>
<span id="cb53-113"><a href="#cb53-113" aria-hidden="true" tabindex="-1"></a>  <span class="dt">features</span><span class="op">:</span> training<span class="op">,</span>  </span>
<span id="cb53-114"><a href="#cb53-114" aria-hidden="true" tabindex="-1"></a>  <span class="dt">classProperty</span><span class="op">:</span> <span class="st">&#39;landcover&#39;</span><span class="op">,</span></span>
<span id="cb53-115"><a href="#cb53-115" aria-hidden="true" tabindex="-1"></a>  <span class="dt">inputProperties</span><span class="op">:</span> composite<span class="op">.</span><span class="fu">bandNames</span>()</span>
<span id="cb53-116"><a href="#cb53-116" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb53-117"><a href="#cb53-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-118"><a href="#cb53-118" aria-hidden="true" tabindex="-1"></a><span class="co">// Classify the image.</span></span>
<span id="cb53-119"><a href="#cb53-119" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> classified <span class="op">=</span> composite<span class="op">.</span><span class="fu">classify</span>(classifier)<span class="op">;</span></span>
<span id="cb53-120"><a href="#cb53-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-121"><a href="#cb53-121" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(classified<span class="op">,</span> {<span class="dt">min</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span> <span class="dv">3</span><span class="op">,</span> <span class="dt">palette</span><span class="op">:</span> [<span class="st">&#39;gray&#39;</span><span class="op">,</span> <span class="st">&#39;brown&#39;</span><span class="op">,</span> <span class="st">&#39;blue&#39;</span><span class="op">,</span> <span class="st">&#39;green&#39;</span>]}<span class="op">,</span> <span class="st">&#39;2019&#39;</span>)<span class="op">;</span></span>
<span id="cb53-122"><a href="#cb53-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-123"><a href="#cb53-123" aria-hidden="true" tabindex="-1"></a><span class="co">//************************************************************************** </span></span>
<span id="cb53-124"><a href="#cb53-124" aria-hidden="true" tabindex="-1"></a><span class="co">// Accuracy Assessment</span></span>
<span id="cb53-125"><a href="#cb53-125" aria-hidden="true" tabindex="-1"></a><span class="co">//************************************************************************** </span></span>
<span id="cb53-126"><a href="#cb53-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-127"><a href="#cb53-127" aria-hidden="true" tabindex="-1"></a><span class="co">// Use classification map to assess accuracy using the validation fraction</span></span>
<span id="cb53-128"><a href="#cb53-128" aria-hidden="true" tabindex="-1"></a><span class="co">// of the overall training set created above.</span></span>
<span id="cb53-129"><a href="#cb53-129" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> test <span class="op">=</span> classified<span class="op">.</span><span class="fu">sampleRegions</span>({</span>
<span id="cb53-130"><a href="#cb53-130" aria-hidden="true" tabindex="-1"></a>  <span class="dt">collection</span><span class="op">:</span> validationGcp<span class="op">,</span></span>
<span id="cb53-131"><a href="#cb53-131" aria-hidden="true" tabindex="-1"></a>  <span class="dt">properties</span><span class="op">:</span> [<span class="st">&#39;landcover&#39;</span>]<span class="op">,</span></span>
<span id="cb53-132"><a href="#cb53-132" aria-hidden="true" tabindex="-1"></a>  <span class="dt">scale</span><span class="op">:</span> <span class="dv">10</span><span class="op">,</span></span>
<span id="cb53-133"><a href="#cb53-133" aria-hidden="true" tabindex="-1"></a>  <span class="dt">tileScale</span><span class="op">:</span> <span class="dv">16</span></span>
<span id="cb53-134"><a href="#cb53-134" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb53-135"><a href="#cb53-135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-136"><a href="#cb53-136" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> testConfusionMatrix <span class="op">=</span> test<span class="op">.</span><span class="fu">errorMatrix</span>(<span class="st">&#39;landcover&#39;</span><span class="op">,</span> <span class="st">&#39;classification&#39;</span>)</span>
<span id="cb53-137"><a href="#cb53-137" aria-hidden="true" tabindex="-1"></a><span class="co">// Printing of confusion matrix may time out. Alternatively, you can export it as CSV</span></span>
<span id="cb53-138"><a href="#cb53-138" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="st">&#39;Confusion Matrix&#39;</span><span class="op">,</span> testConfusionMatrix)<span class="op">;</span></span>
<span id="cb53-139"><a href="#cb53-139" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="st">&#39;Test Accuracy&#39;</span><span class="op">,</span> testConfusionMatrix<span class="op">.</span><span class="fu">accuracy</span>())<span class="op">;</span></span></code></pre></div>
<p><a href="https://code.earthengine.google.com/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3A04-Land_Use_Land_Cover_Classification%2F03b_Improving_the_Classification_(complete)" target="_blank">Open in Code Editor ↗</a></p>
<p>Output</p>
<pre><code>Confusion Matrix
0: [41,3,0,0]
1: [3,43,0,0]
2: [0,0,49,2]
3: [0,0,0,37]

Test Accuracy
0.9550561797752809</code></pre>
</div>
<div id="exporting-classification-results" class="section level2">
<h2>04. Exporting Classification Results</h2>
<p>When working with complex classifiers over large regions, you may get a <em>User memory limit exceeded</em> or <em>Computation timed out</em> error in the Code Editor. The reason for this is that there is a fixed time limit and smaller memory allocated for code that is run with the <em>On-Demand Computation</em> mode. For larger computations, you can use the <em>Batch</em> mode with the <code>Export</code> functions. Exports run in the background and can run longer than 5-minutes time allocated to the computation code run from the Code Editor. This allows you to process very large and complex datasets. Here’s an example showing how to export your classification results to Google Drive.</p>
<blockquote>
<p>We can only export Images or FeatureCollections. What if you wanted to export a number that is the result of a long computation? A useful <em>hack</em> is to create a FeatureCollection with just 1 feature containing <code>null</code> geometry and a property containing the number you want to export.</p>
</blockquote>
<div class="sourceCode" id="cb55"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> s2 <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&quot;COPERNICUS/S2_SR&quot;</span>)<span class="op">;</span></span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> basin <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">&quot;WWF/HydroSHEDS/v1/Basins/hybas_7&quot;</span>)<span class="op">;</span></span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> gcp <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">&quot;users/ujavalgandhi/e2e/arkavathy_gcps&quot;</span>)<span class="op">;</span></span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> alos <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(<span class="st">&quot;JAXA/ALOS/AW3D30/V2_2&quot;</span>)<span class="op">;</span></span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-6"><a href="#cb55-6" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> arkavathy <span class="op">=</span> basin<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;HYBAS_ID&#39;</span><span class="op">,</span> <span class="dv">4071139640</span>))</span>
<span id="cb55-7"><a href="#cb55-7" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> boundary <span class="op">=</span> arkavathy<span class="op">.</span><span class="fu">geometry</span>()</span>
<span id="cb55-8"><a href="#cb55-8" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> s2 <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&quot;COPERNICUS/S2_SR&quot;</span>)</span>
<span id="cb55-9"><a href="#cb55-9" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> rgbVis <span class="op">=</span> {</span>
<span id="cb55-10"><a href="#cb55-10" aria-hidden="true" tabindex="-1"></a>  <span class="dt">min</span><span class="op">:</span> <span class="fl">0.0</span><span class="op">,</span></span>
<span id="cb55-11"><a href="#cb55-11" aria-hidden="true" tabindex="-1"></a>  <span class="dt">max</span><span class="op">:</span> <span class="dv">3000</span><span class="op">,</span></span>
<span id="cb55-12"><a href="#cb55-12" aria-hidden="true" tabindex="-1"></a>  <span class="dt">bands</span><span class="op">:</span> [<span class="st">&#39;B4&#39;</span><span class="op">,</span> <span class="st">&#39;B3&#39;</span><span class="op">,</span> <span class="st">&#39;B2&#39;</span>]<span class="op">,</span></span>
<span id="cb55-13"><a href="#cb55-13" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb55-14"><a href="#cb55-14" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">maskCloudAndShadowsSR</span>(image) {</span>
<span id="cb55-15"><a href="#cb55-15" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> cloudProb <span class="op">=</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;MSK_CLDPRB&#39;</span>)<span class="op">;</span></span>
<span id="cb55-16"><a href="#cb55-16" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> snowProb <span class="op">=</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;MSK_SNWPRB&#39;</span>)<span class="op">;</span></span>
<span id="cb55-17"><a href="#cb55-17" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> cloud <span class="op">=</span> cloudProb<span class="op">.</span><span class="fu">lt</span>(<span class="dv">10</span>)<span class="op">;</span></span>
<span id="cb55-18"><a href="#cb55-18" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> scl <span class="op">=</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;SCL&#39;</span>)<span class="op">;</span> </span>
<span id="cb55-19"><a href="#cb55-19" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> shadow <span class="op">=</span> scl<span class="op">.</span><span class="fu">eq</span>(<span class="dv">3</span>)<span class="op">;</span> <span class="co">// 3 = cloud shadow</span></span>
<span id="cb55-20"><a href="#cb55-20" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> cirrus <span class="op">=</span> scl<span class="op">.</span><span class="fu">eq</span>(<span class="dv">10</span>)<span class="op">;</span> <span class="co">// 10 = cirrus</span></span>
<span id="cb55-21"><a href="#cb55-21" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Cloud probability less than 10% or cloud shadow classification</span></span>
<span id="cb55-22"><a href="#cb55-22" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> mask <span class="op">=</span> cloud<span class="op">.</span><span class="fu">and</span>(cirrus<span class="op">.</span><span class="fu">neq</span>(<span class="dv">1</span>))<span class="op">.</span><span class="fu">and</span>(shadow<span class="op">.</span><span class="fu">neq</span>(<span class="dv">1</span>))<span class="op">;</span></span>
<span id="cb55-23"><a href="#cb55-23" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> image<span class="op">.</span><span class="fu">updateMask</span>(mask)<span class="op">.</span><span class="fu">divide</span>(<span class="dv">10000</span>)<span class="op">;</span></span>
<span id="cb55-24"><a href="#cb55-24" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb55-25"><a href="#cb55-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-26"><a href="#cb55-26" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> filtered <span class="op">=</span> s2</span>
<span id="cb55-27"><a href="#cb55-27" aria-hidden="true" tabindex="-1"></a><span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">lt</span>(<span class="st">&#39;CLOUDY_PIXEL_PERCENTAGE&#39;</span><span class="op">,</span> <span class="dv">30</span>))</span>
<span id="cb55-28"><a href="#cb55-28" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(<span class="st">&#39;2019-01-01&#39;</span><span class="op">,</span> <span class="st">&#39;2019-12-31&#39;</span>))</span>
<span id="cb55-29"><a href="#cb55-29" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">bounds</span>(boundary))</span>
<span id="cb55-30"><a href="#cb55-30" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">map</span>(maskCloudAndShadowsSR)</span>
<span id="cb55-31"><a href="#cb55-31" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;B.*&#39;</span>)</span>
<span id="cb55-32"><a href="#cb55-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-33"><a href="#cb55-33" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> composite <span class="op">=</span> filtered<span class="op">.</span><span class="fu">median</span>()<span class="op">.</span><span class="fu">clip</span>(boundary) </span>
<span id="cb55-34"><a href="#cb55-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-35"><a href="#cb55-35" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> addIndices <span class="op">=</span> <span class="kw">function</span>(image) {</span>
<span id="cb55-36"><a href="#cb55-36" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> ndvi <span class="op">=</span> image<span class="op">.</span><span class="fu">normalizedDifference</span>([<span class="st">&#39;B8&#39;</span><span class="op">,</span> <span class="st">&#39;B4&#39;</span>])<span class="op">.</span><span class="fu">rename</span>([<span class="st">&#39;ndvi&#39;</span>])<span class="op">;</span></span>
<span id="cb55-37"><a href="#cb55-37" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> ndbi <span class="op">=</span> image<span class="op">.</span><span class="fu">normalizedDifference</span>([<span class="st">&#39;B11&#39;</span><span class="op">,</span> <span class="st">&#39;B8&#39;</span>])<span class="op">.</span><span class="fu">rename</span>([<span class="st">&#39;ndbi&#39;</span>])<span class="op">;</span></span>
<span id="cb55-38"><a href="#cb55-38" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> mndwi <span class="op">=</span> image<span class="op">.</span><span class="fu">normalizedDifference</span>([<span class="st">&#39;B3&#39;</span><span class="op">,</span> <span class="st">&#39;B11&#39;</span>])<span class="op">.</span><span class="fu">rename</span>([<span class="st">&#39;mndwi&#39;</span>])<span class="op">;</span> </span>
<span id="cb55-39"><a href="#cb55-39" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> bsi <span class="op">=</span> image<span class="op">.</span><span class="fu">expression</span>(</span>
<span id="cb55-40"><a href="#cb55-40" aria-hidden="true" tabindex="-1"></a>      <span class="st">&#39;(( X + Y ) - (A + B)) /(( X + Y ) + (A + B)) &#39;</span><span class="op">,</span> {</span>
<span id="cb55-41"><a href="#cb55-41" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;X&#39;</span><span class="op">:</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;B11&#39;</span>)<span class="op">,</span> <span class="co">//swir1</span></span>
<span id="cb55-42"><a href="#cb55-42" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;Y&#39;</span><span class="op">:</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;B4&#39;</span>)<span class="op">,</span>  <span class="co">//red</span></span>
<span id="cb55-43"><a href="#cb55-43" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;A&#39;</span><span class="op">:</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;B8&#39;</span>)<span class="op">,</span> <span class="co">// nir</span></span>
<span id="cb55-44"><a href="#cb55-44" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;B&#39;</span><span class="op">:</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;B2&#39;</span>)<span class="op">,</span> <span class="co">// blue</span></span>
<span id="cb55-45"><a href="#cb55-45" aria-hidden="true" tabindex="-1"></a>  })<span class="op">.</span><span class="fu">rename</span>(<span class="st">&#39;bsi&#39;</span>)<span class="op">;</span></span>
<span id="cb55-46"><a href="#cb55-46" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> image<span class="op">.</span><span class="fu">addBands</span>(ndvi)<span class="op">.</span><span class="fu">addBands</span>(ndbi)<span class="op">.</span><span class="fu">addBands</span>(mndwi)<span class="op">.</span><span class="fu">addBands</span>(bsi)</span>
<span id="cb55-47"><a href="#cb55-47" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb55-48"><a href="#cb55-48" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> composite <span class="op">=</span> <span class="fu">addIndices</span>(composite)<span class="op">;</span></span>
<span id="cb55-49"><a href="#cb55-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-50"><a href="#cb55-50" aria-hidden="true" tabindex="-1"></a><span class="co">// Elevation and Slope</span></span>
<span id="cb55-51"><a href="#cb55-51" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> alos <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(<span class="st">&quot;JAXA/ALOS/AW3D30/V2_2&quot;</span>)<span class="op">;</span></span>
<span id="cb55-52"><a href="#cb55-52" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> elev <span class="op">=</span> alos<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;AVE_DSM&#39;</span>)<span class="op">.</span><span class="fu">rename</span>(<span class="st">&#39;elev&#39;</span>)<span class="op">;</span></span>
<span id="cb55-53"><a href="#cb55-53" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> slope <span class="op">=</span> ee<span class="op">.</span><span class="at">Terrain</span><span class="op">.</span><span class="fu">slope</span>(alos<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;AVE_DSM&#39;</span>))<span class="op">.</span><span class="fu">rename</span>(<span class="st">&#39;slope&#39;</span>)<span class="op">;</span></span>
<span id="cb55-54"><a href="#cb55-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-55"><a href="#cb55-55" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> composite <span class="op">=</span> composite<span class="op">.</span><span class="fu">addBands</span>(elev)<span class="op">.</span><span class="fu">addBands</span>(slope)</span>
<span id="cb55-56"><a href="#cb55-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-57"><a href="#cb55-57" aria-hidden="true" tabindex="-1"></a><span class="co">// Normalize the values so all values have the same range</span></span>
<span id="cb55-58"><a href="#cb55-58" aria-hidden="true" tabindex="-1"></a><span class="co">// This will make all bands between 0 and 1</span></span>
<span id="cb55-59"><a href="#cb55-59" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">normalize</span>(image){</span>
<span id="cb55-60"><a href="#cb55-60" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> bandNames <span class="op">=</span> image<span class="op">.</span><span class="fu">bandNames</span>()<span class="op">;</span></span>
<span id="cb55-61"><a href="#cb55-61" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Compute min and max of the image</span></span>
<span id="cb55-62"><a href="#cb55-62" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> minDict <span class="op">=</span> image<span class="op">.</span><span class="fu">reduceRegion</span>({</span>
<span id="cb55-63"><a href="#cb55-63" aria-hidden="true" tabindex="-1"></a>    <span class="dt">reducer</span><span class="op">:</span> ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">min</span>()<span class="op">,</span></span>
<span id="cb55-64"><a href="#cb55-64" aria-hidden="true" tabindex="-1"></a>    <span class="dt">geometry</span><span class="op">:</span> boundary<span class="op">,</span></span>
<span id="cb55-65"><a href="#cb55-65" aria-hidden="true" tabindex="-1"></a>    <span class="dt">scale</span><span class="op">:</span> <span class="dv">20</span><span class="op">,</span></span>
<span id="cb55-66"><a href="#cb55-66" aria-hidden="true" tabindex="-1"></a>    <span class="dt">maxPixels</span><span class="op">:</span> <span class="fl">1e9</span><span class="op">,</span></span>
<span id="cb55-67"><a href="#cb55-67" aria-hidden="true" tabindex="-1"></a>    <span class="dt">bestEffort</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb55-68"><a href="#cb55-68" aria-hidden="true" tabindex="-1"></a>    <span class="dt">tileScale</span><span class="op">:</span> <span class="dv">16</span></span>
<span id="cb55-69"><a href="#cb55-69" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb55-70"><a href="#cb55-70" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> maxDict <span class="op">=</span> image<span class="op">.</span><span class="fu">reduceRegion</span>({</span>
<span id="cb55-71"><a href="#cb55-71" aria-hidden="true" tabindex="-1"></a>    <span class="dt">reducer</span><span class="op">:</span> ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">max</span>()<span class="op">,</span></span>
<span id="cb55-72"><a href="#cb55-72" aria-hidden="true" tabindex="-1"></a>    <span class="dt">geometry</span><span class="op">:</span> boundary<span class="op">,</span></span>
<span id="cb55-73"><a href="#cb55-73" aria-hidden="true" tabindex="-1"></a>    <span class="dt">scale</span><span class="op">:</span> <span class="dv">20</span><span class="op">,</span></span>
<span id="cb55-74"><a href="#cb55-74" aria-hidden="true" tabindex="-1"></a>    <span class="dt">maxPixels</span><span class="op">:</span> <span class="fl">1e9</span><span class="op">,</span></span>
<span id="cb55-75"><a href="#cb55-75" aria-hidden="true" tabindex="-1"></a>    <span class="dt">bestEffort</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb55-76"><a href="#cb55-76" aria-hidden="true" tabindex="-1"></a>    <span class="dt">tileScale</span><span class="op">:</span> <span class="dv">16</span></span>
<span id="cb55-77"><a href="#cb55-77" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb55-78"><a href="#cb55-78" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> mins <span class="op">=</span> ee<span class="op">.</span><span class="at">Image</span><span class="op">.</span><span class="fu">constant</span>(minDict<span class="op">.</span><span class="fu">values</span>(bandNames))<span class="op">;</span></span>
<span id="cb55-79"><a href="#cb55-79" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> maxs <span class="op">=</span> ee<span class="op">.</span><span class="at">Image</span><span class="op">.</span><span class="fu">constant</span>(maxDict<span class="op">.</span><span class="fu">values</span>(bandNames))<span class="op">;</span></span>
<span id="cb55-80"><a href="#cb55-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-81"><a href="#cb55-81" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> normalized <span class="op">=</span> image<span class="op">.</span><span class="fu">subtract</span>(mins)<span class="op">.</span><span class="fu">divide</span>(maxs<span class="op">.</span><span class="fu">subtract</span>(mins))</span>
<span id="cb55-82"><a href="#cb55-82" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> normalized</span>
<span id="cb55-83"><a href="#cb55-83" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb55-84"><a href="#cb55-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-85"><a href="#cb55-85" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> composite <span class="op">=</span> <span class="fu">normalize</span>(composite)<span class="op">;</span></span>
<span id="cb55-86"><a href="#cb55-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-87"><a href="#cb55-87" aria-hidden="true" tabindex="-1"></a><span class="co">// Display the input composite.</span></span>
<span id="cb55-88"><a href="#cb55-88" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(composite<span class="op">,</span> rgbVis<span class="op">,</span> <span class="st">&#39;image&#39;</span>)<span class="op">;</span></span>
<span id="cb55-89"><a href="#cb55-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-90"><a href="#cb55-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-91"><a href="#cb55-91" aria-hidden="true" tabindex="-1"></a><span class="co">// Add a random column and split the GCPs into training and validation set</span></span>
<span id="cb55-92"><a href="#cb55-92" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> gcp <span class="op">=</span> gcp<span class="op">.</span><span class="fu">randomColumn</span>()</span>
<span id="cb55-93"><a href="#cb55-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-94"><a href="#cb55-94" aria-hidden="true" tabindex="-1"></a><span class="co">// This being a simpler classification, we take 60% points</span></span>
<span id="cb55-95"><a href="#cb55-95" aria-hidden="true" tabindex="-1"></a><span class="co">// for validation. Normal recommended ratio is</span></span>
<span id="cb55-96"><a href="#cb55-96" aria-hidden="true" tabindex="-1"></a><span class="co">// 70% training, 30% validation</span></span>
<span id="cb55-97"><a href="#cb55-97" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> trainingGcp <span class="op">=</span> gcp<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">lt</span>(<span class="st">&#39;random&#39;</span><span class="op">,</span> <span class="fl">0.6</span>))<span class="op">;</span></span>
<span id="cb55-98"><a href="#cb55-98" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> validationGcp <span class="op">=</span> gcp<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">gte</span>(<span class="st">&#39;random&#39;</span><span class="op">,</span> <span class="fl">0.6</span>))<span class="op">;</span></span>
<span id="cb55-99"><a href="#cb55-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-100"><a href="#cb55-100" aria-hidden="true" tabindex="-1"></a><span class="co">// Overlay the point on the image to get training data.</span></span>
<span id="cb55-101"><a href="#cb55-101" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> training <span class="op">=</span> composite<span class="op">.</span><span class="fu">sampleRegions</span>({</span>
<span id="cb55-102"><a href="#cb55-102" aria-hidden="true" tabindex="-1"></a>  <span class="dt">collection</span><span class="op">:</span> trainingGcp<span class="op">,</span></span>
<span id="cb55-103"><a href="#cb55-103" aria-hidden="true" tabindex="-1"></a>  <span class="dt">properties</span><span class="op">:</span> [<span class="st">&#39;landcover&#39;</span>]<span class="op">,</span></span>
<span id="cb55-104"><a href="#cb55-104" aria-hidden="true" tabindex="-1"></a>  <span class="dt">scale</span><span class="op">:</span> <span class="dv">10</span><span class="op">,</span></span>
<span id="cb55-105"><a href="#cb55-105" aria-hidden="true" tabindex="-1"></a>  <span class="dt">tileScale</span><span class="op">:</span> <span class="dv">16</span></span>
<span id="cb55-106"><a href="#cb55-106" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb55-107"><a href="#cb55-107" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(training)</span>
<span id="cb55-108"><a href="#cb55-108" aria-hidden="true" tabindex="-1"></a><span class="co">// Train a classifier.</span></span>
<span id="cb55-109"><a href="#cb55-109" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> classifier <span class="op">=</span> ee<span class="op">.</span><span class="at">Classifier</span><span class="op">.</span><span class="fu">smileRandomForest</span>(<span class="dv">50</span>)</span>
<span id="cb55-110"><a href="#cb55-110" aria-hidden="true" tabindex="-1"></a><span class="op">.</span><span class="fu">train</span>({</span>
<span id="cb55-111"><a href="#cb55-111" aria-hidden="true" tabindex="-1"></a>  <span class="dt">features</span><span class="op">:</span> training<span class="op">,</span>  </span>
<span id="cb55-112"><a href="#cb55-112" aria-hidden="true" tabindex="-1"></a>  <span class="dt">classProperty</span><span class="op">:</span> <span class="st">&#39;landcover&#39;</span><span class="op">,</span></span>
<span id="cb55-113"><a href="#cb55-113" aria-hidden="true" tabindex="-1"></a>  <span class="dt">inputProperties</span><span class="op">:</span> composite<span class="op">.</span><span class="fu">bandNames</span>()</span>
<span id="cb55-114"><a href="#cb55-114" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb55-115"><a href="#cb55-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-116"><a href="#cb55-116" aria-hidden="true" tabindex="-1"></a><span class="co">// Classify the image.</span></span>
<span id="cb55-117"><a href="#cb55-117" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> classified <span class="op">=</span> composite<span class="op">.</span><span class="fu">classify</span>(classifier)<span class="op">;</span></span>
<span id="cb55-118"><a href="#cb55-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-119"><a href="#cb55-119" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(classified<span class="op">,</span> {<span class="dt">min</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span> <span class="dv">3</span><span class="op">,</span> <span class="dt">palette</span><span class="op">:</span> [<span class="st">&#39;gray&#39;</span><span class="op">,</span> <span class="st">&#39;brown&#39;</span><span class="op">,</span> <span class="st">&#39;blue&#39;</span><span class="op">,</span> <span class="st">&#39;green&#39;</span>]}<span class="op">,</span> <span class="st">&#39;2019&#39;</span>)<span class="op">;</span></span>
<span id="cb55-120"><a href="#cb55-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-121"><a href="#cb55-121" aria-hidden="true" tabindex="-1"></a><span class="co">//************************************************************************** </span></span>
<span id="cb55-122"><a href="#cb55-122" aria-hidden="true" tabindex="-1"></a><span class="co">// Accuracy Assessment</span></span>
<span id="cb55-123"><a href="#cb55-123" aria-hidden="true" tabindex="-1"></a><span class="co">//************************************************************************** </span></span>
<span id="cb55-124"><a href="#cb55-124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-125"><a href="#cb55-125" aria-hidden="true" tabindex="-1"></a><span class="co">// Use classification map to assess accuracy using the validation fraction</span></span>
<span id="cb55-126"><a href="#cb55-126" aria-hidden="true" tabindex="-1"></a><span class="co">// of the overall training set created above.</span></span>
<span id="cb55-127"><a href="#cb55-127" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> test <span class="op">=</span> classified<span class="op">.</span><span class="fu">sampleRegions</span>({</span>
<span id="cb55-128"><a href="#cb55-128" aria-hidden="true" tabindex="-1"></a>  <span class="dt">collection</span><span class="op">:</span> validationGcp<span class="op">,</span></span>
<span id="cb55-129"><a href="#cb55-129" aria-hidden="true" tabindex="-1"></a>  <span class="dt">properties</span><span class="op">:</span> [<span class="st">&#39;landcover&#39;</span>]<span class="op">,</span></span>
<span id="cb55-130"><a href="#cb55-130" aria-hidden="true" tabindex="-1"></a>  <span class="dt">scale</span><span class="op">:</span> <span class="dv">10</span><span class="op">,</span></span>
<span id="cb55-131"><a href="#cb55-131" aria-hidden="true" tabindex="-1"></a>  <span class="dt">tileScale</span><span class="op">:</span> <span class="dv">16</span></span>
<span id="cb55-132"><a href="#cb55-132" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb55-133"><a href="#cb55-133" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-134"><a href="#cb55-134" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> testConfusionMatrix <span class="op">=</span> test<span class="op">.</span><span class="fu">errorMatrix</span>(<span class="st">&#39;landcover&#39;</span><span class="op">,</span> <span class="st">&#39;classification&#39;</span>)</span>
<span id="cb55-135"><a href="#cb55-135" aria-hidden="true" tabindex="-1"></a><span class="co">// Printing of confusion matrix may time out. Alternatively, you can export it as CSV</span></span>
<span id="cb55-136"><a href="#cb55-136" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="st">&#39;Confusion Matrix&#39;</span><span class="op">,</span> testConfusionMatrix)<span class="op">;</span></span>
<span id="cb55-137"><a href="#cb55-137" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="st">&#39;Test Accuracy&#39;</span><span class="op">,</span> testConfusionMatrix<span class="op">.</span><span class="fu">accuracy</span>())<span class="op">;</span></span>
<span id="cb55-138"><a href="#cb55-138" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-139"><a href="#cb55-139" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-140"><a href="#cb55-140" aria-hidden="true" tabindex="-1"></a><span class="co">//************************************************************************** </span></span>
<span id="cb55-141"><a href="#cb55-141" aria-hidden="true" tabindex="-1"></a><span class="co">// Exporting Results</span></span>
<span id="cb55-142"><a href="#cb55-142" aria-hidden="true" tabindex="-1"></a><span class="co">//************************************************************************** </span></span>
<span id="cb55-143"><a href="#cb55-143" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-144"><a href="#cb55-144" aria-hidden="true" tabindex="-1"></a><span class="co">// Create a Feature with null geometry and the value we want to export.</span></span>
<span id="cb55-145"><a href="#cb55-145" aria-hidden="true" tabindex="-1"></a><span class="co">// Use .array() to convert Confusion Matrix to an Array so it can be</span></span>
<span id="cb55-146"><a href="#cb55-146" aria-hidden="true" tabindex="-1"></a><span class="co">// exported in a CSV file</span></span>
<span id="cb55-147"><a href="#cb55-147" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> fc <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>([</span>
<span id="cb55-148"><a href="#cb55-148" aria-hidden="true" tabindex="-1"></a>  ee<span class="op">.</span><span class="fu">Feature</span>(<span class="kw">null</span><span class="op">,</span> {</span>
<span id="cb55-149"><a href="#cb55-149" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;accuracy&#39;</span><span class="op">:</span> testConfusionMatrix<span class="op">.</span><span class="fu">accuracy</span>()<span class="op">,</span></span>
<span id="cb55-150"><a href="#cb55-150" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;matrix&#39;</span><span class="op">:</span> testConfusionMatrix<span class="op">.</span><span class="fu">array</span>()</span>
<span id="cb55-151"><a href="#cb55-151" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb55-152"><a href="#cb55-152" aria-hidden="true" tabindex="-1"></a>  ])</span>
<span id="cb55-153"><a href="#cb55-153" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(fc)  </span>
<span id="cb55-154"><a href="#cb55-154" aria-hidden="true" tabindex="-1"></a>Export<span class="op">.</span><span class="at">table</span><span class="op">.</span><span class="fu">toDrive</span>({</span>
<span id="cb55-155"><a href="#cb55-155" aria-hidden="true" tabindex="-1"></a>  <span class="dt">collection</span><span class="op">:</span> fc<span class="op">,</span></span>
<span id="cb55-156"><a href="#cb55-156" aria-hidden="true" tabindex="-1"></a>  <span class="dt">description</span><span class="op">:</span> <span class="st">&#39;Accuracy_Export&#39;</span><span class="op">,</span></span>
<span id="cb55-157"><a href="#cb55-157" aria-hidden="true" tabindex="-1"></a>  <span class="dt">folder</span><span class="op">:</span> <span class="st">&#39;earthengine&#39;</span><span class="op">,</span></span>
<span id="cb55-158"><a href="#cb55-158" aria-hidden="true" tabindex="-1"></a>  <span class="dt">fileNamePrefix</span><span class="op">:</span> <span class="st">&#39;accuracy&#39;</span><span class="op">,</span></span>
<span id="cb55-159"><a href="#cb55-159" aria-hidden="true" tabindex="-1"></a>  <span class="dt">fileFormat</span><span class="op">:</span> <span class="st">&#39;CSV&#39;</span></span>
<span id="cb55-160"><a href="#cb55-160" aria-hidden="true" tabindex="-1"></a>})</span></code></pre></div>
<p><a href="https://code.earthengine.google.com/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3A04-Land_Use_Land_Cover_Classification%2F04b_Exporting_Classification_Results_(complete)" target="_blank">Open in Code Editor ↗</a></p>
<div class="figure" style="text-align: center">
<img src="images/gee_water_resources_management/export_accuracy.png" alt="Exported Classification Accuracy" width="50%" />
<p class="caption">
Exported Classification Accuracy
</p>
</div>
<div id="exercise-25" class="section level3">
<h3>Exercise</h3>
<p>It is also a good idea to export the classified image as an Asset. This will allows you to import the classified image in another script without running the whole classification workflow. Use the <code>Export.image.toAsset()</code> function to export the classified image as an asset.</p>
<div class="sourceCode" id="cb56"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> s2 <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&quot;COPERNICUS/S2_SR&quot;</span>)<span class="op">;</span></span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> basin <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">&quot;WWF/HydroSHEDS/v1/Basins/hybas_7&quot;</span>)<span class="op">;</span></span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> gcp <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">&quot;users/ujavalgandhi/e2e/arkavathy_gcps&quot;</span>)<span class="op">;</span></span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> alos <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(<span class="st">&quot;JAXA/ALOS/AW3D30/V2_2&quot;</span>)<span class="op">;</span></span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> arkavathy <span class="op">=</span> basin<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;HYBAS_ID&#39;</span><span class="op">,</span> <span class="dv">4071139640</span>))</span>
<span id="cb56-7"><a href="#cb56-7" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> boundary <span class="op">=</span> arkavathy<span class="op">.</span><span class="fu">geometry</span>()</span>
<span id="cb56-8"><a href="#cb56-8" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> s2 <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&quot;COPERNICUS/S2_SR&quot;</span>)</span>
<span id="cb56-9"><a href="#cb56-9" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> rgbVis <span class="op">=</span> {</span>
<span id="cb56-10"><a href="#cb56-10" aria-hidden="true" tabindex="-1"></a>  <span class="dt">min</span><span class="op">:</span> <span class="fl">0.0</span><span class="op">,</span></span>
<span id="cb56-11"><a href="#cb56-11" aria-hidden="true" tabindex="-1"></a>  <span class="dt">max</span><span class="op">:</span> <span class="dv">3000</span><span class="op">,</span></span>
<span id="cb56-12"><a href="#cb56-12" aria-hidden="true" tabindex="-1"></a>  <span class="dt">bands</span><span class="op">:</span> [<span class="st">&#39;B4&#39;</span><span class="op">,</span> <span class="st">&#39;B3&#39;</span><span class="op">,</span> <span class="st">&#39;B2&#39;</span>]<span class="op">,</span></span>
<span id="cb56-13"><a href="#cb56-13" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb56-14"><a href="#cb56-14" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">maskCloudAndShadowsSR</span>(image) {</span>
<span id="cb56-15"><a href="#cb56-15" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> cloudProb <span class="op">=</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;MSK_CLDPRB&#39;</span>)<span class="op">;</span></span>
<span id="cb56-16"><a href="#cb56-16" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> snowProb <span class="op">=</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;MSK_SNWPRB&#39;</span>)<span class="op">;</span></span>
<span id="cb56-17"><a href="#cb56-17" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> cloud <span class="op">=</span> cloudProb<span class="op">.</span><span class="fu">lt</span>(<span class="dv">10</span>)<span class="op">;</span></span>
<span id="cb56-18"><a href="#cb56-18" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> scl <span class="op">=</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;SCL&#39;</span>)<span class="op">;</span> </span>
<span id="cb56-19"><a href="#cb56-19" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> shadow <span class="op">=</span> scl<span class="op">.</span><span class="fu">eq</span>(<span class="dv">3</span>)<span class="op">;</span> <span class="co">// 3 = cloud shadow</span></span>
<span id="cb56-20"><a href="#cb56-20" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> cirrus <span class="op">=</span> scl<span class="op">.</span><span class="fu">eq</span>(<span class="dv">10</span>)<span class="op">;</span> <span class="co">// 10 = cirrus</span></span>
<span id="cb56-21"><a href="#cb56-21" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Cloud probability less than 10% or cloud shadow classification</span></span>
<span id="cb56-22"><a href="#cb56-22" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> mask <span class="op">=</span> cloud<span class="op">.</span><span class="fu">and</span>(cirrus<span class="op">.</span><span class="fu">neq</span>(<span class="dv">1</span>))<span class="op">.</span><span class="fu">and</span>(shadow<span class="op">.</span><span class="fu">neq</span>(<span class="dv">1</span>))<span class="op">;</span></span>
<span id="cb56-23"><a href="#cb56-23" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> image<span class="op">.</span><span class="fu">updateMask</span>(mask)<span class="op">.</span><span class="fu">divide</span>(<span class="dv">10000</span>)<span class="op">;</span></span>
<span id="cb56-24"><a href="#cb56-24" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb56-25"><a href="#cb56-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-26"><a href="#cb56-26" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> filtered <span class="op">=</span> s2</span>
<span id="cb56-27"><a href="#cb56-27" aria-hidden="true" tabindex="-1"></a><span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">lt</span>(<span class="st">&#39;CLOUDY_PIXEL_PERCENTAGE&#39;</span><span class="op">,</span> <span class="dv">30</span>))</span>
<span id="cb56-28"><a href="#cb56-28" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(<span class="st">&#39;2019-01-01&#39;</span><span class="op">,</span> <span class="st">&#39;2019-12-31&#39;</span>))</span>
<span id="cb56-29"><a href="#cb56-29" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">bounds</span>(boundary))</span>
<span id="cb56-30"><a href="#cb56-30" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">map</span>(maskCloudAndShadowsSR)</span>
<span id="cb56-31"><a href="#cb56-31" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;B.*&#39;</span>)</span>
<span id="cb56-32"><a href="#cb56-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-33"><a href="#cb56-33" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> composite <span class="op">=</span> filtered<span class="op">.</span><span class="fu">median</span>()<span class="op">.</span><span class="fu">clip</span>(boundary) </span>
<span id="cb56-34"><a href="#cb56-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-35"><a href="#cb56-35" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> addIndices <span class="op">=</span> <span class="kw">function</span>(image) {</span>
<span id="cb56-36"><a href="#cb56-36" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> ndvi <span class="op">=</span> image<span class="op">.</span><span class="fu">normalizedDifference</span>([<span class="st">&#39;B8&#39;</span><span class="op">,</span> <span class="st">&#39;B4&#39;</span>])<span class="op">.</span><span class="fu">rename</span>([<span class="st">&#39;ndvi&#39;</span>])<span class="op">;</span></span>
<span id="cb56-37"><a href="#cb56-37" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> ndbi <span class="op">=</span> image<span class="op">.</span><span class="fu">normalizedDifference</span>([<span class="st">&#39;B11&#39;</span><span class="op">,</span> <span class="st">&#39;B8&#39;</span>])<span class="op">.</span><span class="fu">rename</span>([<span class="st">&#39;ndbi&#39;</span>])<span class="op">;</span></span>
<span id="cb56-38"><a href="#cb56-38" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> mndwi <span class="op">=</span> image<span class="op">.</span><span class="fu">normalizedDifference</span>([<span class="st">&#39;B3&#39;</span><span class="op">,</span> <span class="st">&#39;B11&#39;</span>])<span class="op">.</span><span class="fu">rename</span>([<span class="st">&#39;mndwi&#39;</span>])<span class="op">;</span> </span>
<span id="cb56-39"><a href="#cb56-39" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> bsi <span class="op">=</span> image<span class="op">.</span><span class="fu">expression</span>(</span>
<span id="cb56-40"><a href="#cb56-40" aria-hidden="true" tabindex="-1"></a>      <span class="st">&#39;(( X + Y ) - (A + B)) /(( X + Y ) + (A + B)) &#39;</span><span class="op">,</span> {</span>
<span id="cb56-41"><a href="#cb56-41" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;X&#39;</span><span class="op">:</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;B11&#39;</span>)<span class="op">,</span> <span class="co">//swir1</span></span>
<span id="cb56-42"><a href="#cb56-42" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;Y&#39;</span><span class="op">:</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;B4&#39;</span>)<span class="op">,</span>  <span class="co">//red</span></span>
<span id="cb56-43"><a href="#cb56-43" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;A&#39;</span><span class="op">:</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;B8&#39;</span>)<span class="op">,</span> <span class="co">// nir</span></span>
<span id="cb56-44"><a href="#cb56-44" aria-hidden="true" tabindex="-1"></a>        <span class="st">&#39;B&#39;</span><span class="op">:</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;B2&#39;</span>)<span class="op">,</span> <span class="co">// blue</span></span>
<span id="cb56-45"><a href="#cb56-45" aria-hidden="true" tabindex="-1"></a>  })<span class="op">.</span><span class="fu">rename</span>(<span class="st">&#39;bsi&#39;</span>)<span class="op">;</span></span>
<span id="cb56-46"><a href="#cb56-46" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> image<span class="op">.</span><span class="fu">addBands</span>(ndvi)<span class="op">.</span><span class="fu">addBands</span>(ndbi)<span class="op">.</span><span class="fu">addBands</span>(mndwi)<span class="op">.</span><span class="fu">addBands</span>(bsi)</span>
<span id="cb56-47"><a href="#cb56-47" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb56-48"><a href="#cb56-48" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> composite <span class="op">=</span> <span class="fu">addIndices</span>(composite)<span class="op">;</span></span>
<span id="cb56-49"><a href="#cb56-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-50"><a href="#cb56-50" aria-hidden="true" tabindex="-1"></a><span class="co">// Elevation and Slope</span></span>
<span id="cb56-51"><a href="#cb56-51" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> alos <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(<span class="st">&quot;JAXA/ALOS/AW3D30/V2_2&quot;</span>)<span class="op">;</span></span>
<span id="cb56-52"><a href="#cb56-52" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> elev <span class="op">=</span> alos<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;AVE_DSM&#39;</span>)<span class="op">.</span><span class="fu">rename</span>(<span class="st">&#39;elev&#39;</span>)<span class="op">;</span></span>
<span id="cb56-53"><a href="#cb56-53" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> slope <span class="op">=</span> ee<span class="op">.</span><span class="at">Terrain</span><span class="op">.</span><span class="fu">slope</span>(alos<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;AVE_DSM&#39;</span>))<span class="op">.</span><span class="fu">rename</span>(<span class="st">&#39;slope&#39;</span>)<span class="op">;</span></span>
<span id="cb56-54"><a href="#cb56-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-55"><a href="#cb56-55" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> composite <span class="op">=</span> composite<span class="op">.</span><span class="fu">addBands</span>(elev)<span class="op">.</span><span class="fu">addBands</span>(slope)</span>
<span id="cb56-56"><a href="#cb56-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-57"><a href="#cb56-57" aria-hidden="true" tabindex="-1"></a><span class="co">// Normalize the values so all values have the same range</span></span>
<span id="cb56-58"><a href="#cb56-58" aria-hidden="true" tabindex="-1"></a><span class="co">// This will make all bands between 0 and 1</span></span>
<span id="cb56-59"><a href="#cb56-59" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">normalize</span>(image){</span>
<span id="cb56-60"><a href="#cb56-60" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> bandNames <span class="op">=</span> image<span class="op">.</span><span class="fu">bandNames</span>()<span class="op">;</span></span>
<span id="cb56-61"><a href="#cb56-61" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Compute min and max of the image</span></span>
<span id="cb56-62"><a href="#cb56-62" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> minDict <span class="op">=</span> image<span class="op">.</span><span class="fu">reduceRegion</span>({</span>
<span id="cb56-63"><a href="#cb56-63" aria-hidden="true" tabindex="-1"></a>    <span class="dt">reducer</span><span class="op">:</span> ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">min</span>()<span class="op">,</span></span>
<span id="cb56-64"><a href="#cb56-64" aria-hidden="true" tabindex="-1"></a>    <span class="dt">geometry</span><span class="op">:</span> boundary<span class="op">,</span></span>
<span id="cb56-65"><a href="#cb56-65" aria-hidden="true" tabindex="-1"></a>    <span class="dt">scale</span><span class="op">:</span> <span class="dv">20</span><span class="op">,</span></span>
<span id="cb56-66"><a href="#cb56-66" aria-hidden="true" tabindex="-1"></a>    <span class="dt">maxPixels</span><span class="op">:</span> <span class="fl">1e9</span><span class="op">,</span></span>
<span id="cb56-67"><a href="#cb56-67" aria-hidden="true" tabindex="-1"></a>    <span class="dt">bestEffort</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb56-68"><a href="#cb56-68" aria-hidden="true" tabindex="-1"></a>    <span class="dt">tileScale</span><span class="op">:</span> <span class="dv">16</span></span>
<span id="cb56-69"><a href="#cb56-69" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb56-70"><a href="#cb56-70" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> maxDict <span class="op">=</span> image<span class="op">.</span><span class="fu">reduceRegion</span>({</span>
<span id="cb56-71"><a href="#cb56-71" aria-hidden="true" tabindex="-1"></a>    <span class="dt">reducer</span><span class="op">:</span> ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">max</span>()<span class="op">,</span></span>
<span id="cb56-72"><a href="#cb56-72" aria-hidden="true" tabindex="-1"></a>    <span class="dt">geometry</span><span class="op">:</span> boundary<span class="op">,</span></span>
<span id="cb56-73"><a href="#cb56-73" aria-hidden="true" tabindex="-1"></a>    <span class="dt">scale</span><span class="op">:</span> <span class="dv">20</span><span class="op">,</span></span>
<span id="cb56-74"><a href="#cb56-74" aria-hidden="true" tabindex="-1"></a>    <span class="dt">maxPixels</span><span class="op">:</span> <span class="fl">1e9</span><span class="op">,</span></span>
<span id="cb56-75"><a href="#cb56-75" aria-hidden="true" tabindex="-1"></a>    <span class="dt">bestEffort</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb56-76"><a href="#cb56-76" aria-hidden="true" tabindex="-1"></a>    <span class="dt">tileScale</span><span class="op">:</span> <span class="dv">16</span></span>
<span id="cb56-77"><a href="#cb56-77" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb56-78"><a href="#cb56-78" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> mins <span class="op">=</span> ee<span class="op">.</span><span class="at">Image</span><span class="op">.</span><span class="fu">constant</span>(minDict<span class="op">.</span><span class="fu">values</span>(bandNames))<span class="op">;</span></span>
<span id="cb56-79"><a href="#cb56-79" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> maxs <span class="op">=</span> ee<span class="op">.</span><span class="at">Image</span><span class="op">.</span><span class="fu">constant</span>(maxDict<span class="op">.</span><span class="fu">values</span>(bandNames))<span class="op">;</span></span>
<span id="cb56-80"><a href="#cb56-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-81"><a href="#cb56-81" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> normalized <span class="op">=</span> image<span class="op">.</span><span class="fu">subtract</span>(mins)<span class="op">.</span><span class="fu">divide</span>(maxs<span class="op">.</span><span class="fu">subtract</span>(mins))</span>
<span id="cb56-82"><a href="#cb56-82" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> normalized</span>
<span id="cb56-83"><a href="#cb56-83" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb56-84"><a href="#cb56-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-85"><a href="#cb56-85" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> composite <span class="op">=</span> <span class="fu">normalize</span>(composite)<span class="op">;</span></span>
<span id="cb56-86"><a href="#cb56-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-87"><a href="#cb56-87" aria-hidden="true" tabindex="-1"></a><span class="co">// Display the input composite.</span></span>
<span id="cb56-88"><a href="#cb56-88" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(composite<span class="op">,</span> rgbVis<span class="op">,</span> <span class="st">&#39;image&#39;</span>)<span class="op">;</span></span>
<span id="cb56-89"><a href="#cb56-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-90"><a href="#cb56-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-91"><a href="#cb56-91" aria-hidden="true" tabindex="-1"></a><span class="co">// Add a random column and split the GCPs into training and validation set</span></span>
<span id="cb56-92"><a href="#cb56-92" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> gcp <span class="op">=</span> gcp<span class="op">.</span><span class="fu">randomColumn</span>()</span>
<span id="cb56-93"><a href="#cb56-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-94"><a href="#cb56-94" aria-hidden="true" tabindex="-1"></a><span class="co">// This being a simpler classification, we take 60% points</span></span>
<span id="cb56-95"><a href="#cb56-95" aria-hidden="true" tabindex="-1"></a><span class="co">// for validation. Normal recommended ratio is</span></span>
<span id="cb56-96"><a href="#cb56-96" aria-hidden="true" tabindex="-1"></a><span class="co">// 70% training, 30% validation</span></span>
<span id="cb56-97"><a href="#cb56-97" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> trainingGcp <span class="op">=</span> gcp<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">lt</span>(<span class="st">&#39;random&#39;</span><span class="op">,</span> <span class="fl">0.6</span>))<span class="op">;</span></span>
<span id="cb56-98"><a href="#cb56-98" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> validationGcp <span class="op">=</span> gcp<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">gte</span>(<span class="st">&#39;random&#39;</span><span class="op">,</span> <span class="fl">0.6</span>))<span class="op">;</span></span>
<span id="cb56-99"><a href="#cb56-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-100"><a href="#cb56-100" aria-hidden="true" tabindex="-1"></a><span class="co">// Overlay the point on the image to get training data.</span></span>
<span id="cb56-101"><a href="#cb56-101" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> training <span class="op">=</span> composite<span class="op">.</span><span class="fu">sampleRegions</span>({</span>
<span id="cb56-102"><a href="#cb56-102" aria-hidden="true" tabindex="-1"></a>  <span class="dt">collection</span><span class="op">:</span> trainingGcp<span class="op">,</span></span>
<span id="cb56-103"><a href="#cb56-103" aria-hidden="true" tabindex="-1"></a>  <span class="dt">properties</span><span class="op">:</span> [<span class="st">&#39;landcover&#39;</span>]<span class="op">,</span></span>
<span id="cb56-104"><a href="#cb56-104" aria-hidden="true" tabindex="-1"></a>  <span class="dt">scale</span><span class="op">:</span> <span class="dv">10</span><span class="op">,</span></span>
<span id="cb56-105"><a href="#cb56-105" aria-hidden="true" tabindex="-1"></a>  <span class="dt">tileScale</span><span class="op">:</span> <span class="dv">16</span></span>
<span id="cb56-106"><a href="#cb56-106" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb56-107"><a href="#cb56-107" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(training)</span>
<span id="cb56-108"><a href="#cb56-108" aria-hidden="true" tabindex="-1"></a><span class="co">// Train a classifier.</span></span>
<span id="cb56-109"><a href="#cb56-109" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> classifier <span class="op">=</span> ee<span class="op">.</span><span class="at">Classifier</span><span class="op">.</span><span class="fu">smileRandomForest</span>(<span class="dv">50</span>)</span>
<span id="cb56-110"><a href="#cb56-110" aria-hidden="true" tabindex="-1"></a><span class="op">.</span><span class="fu">train</span>({</span>
<span id="cb56-111"><a href="#cb56-111" aria-hidden="true" tabindex="-1"></a>  <span class="dt">features</span><span class="op">:</span> training<span class="op">,</span>  </span>
<span id="cb56-112"><a href="#cb56-112" aria-hidden="true" tabindex="-1"></a>  <span class="dt">classProperty</span><span class="op">:</span> <span class="st">&#39;landcover&#39;</span><span class="op">,</span></span>
<span id="cb56-113"><a href="#cb56-113" aria-hidden="true" tabindex="-1"></a>  <span class="dt">inputProperties</span><span class="op">:</span> composite<span class="op">.</span><span class="fu">bandNames</span>()</span>
<span id="cb56-114"><a href="#cb56-114" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb56-115"><a href="#cb56-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-116"><a href="#cb56-116" aria-hidden="true" tabindex="-1"></a><span class="co">// Classify the image.</span></span>
<span id="cb56-117"><a href="#cb56-117" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> classified <span class="op">=</span> composite<span class="op">.</span><span class="fu">classify</span>(classifier)<span class="op">;</span></span>
<span id="cb56-118"><a href="#cb56-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-119"><a href="#cb56-119" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(classified<span class="op">,</span> {<span class="dt">min</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span> <span class="dv">3</span><span class="op">,</span> <span class="dt">palette</span><span class="op">:</span> [<span class="st">&#39;gray&#39;</span><span class="op">,</span> <span class="st">&#39;brown&#39;</span><span class="op">,</span> <span class="st">&#39;blue&#39;</span><span class="op">,</span> <span class="st">&#39;green&#39;</span>]}<span class="op">,</span> <span class="st">&#39;2019&#39;</span>)<span class="op">;</span></span>
<span id="cb56-120"><a href="#cb56-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-121"><a href="#cb56-121" aria-hidden="true" tabindex="-1"></a><span class="co">// Exercise </span></span>
<span id="cb56-122"><a href="#cb56-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-123"><a href="#cb56-123" aria-hidden="true" tabindex="-1"></a><span class="co">// Use the Export.image.toAsset() function to export the </span></span>
<span id="cb56-124"><a href="#cb56-124" aria-hidden="true" tabindex="-1"></a><span class="co">// classified image as a Earth Engine Asset.</span></span>
<span id="cb56-125"><a href="#cb56-125" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-126"><a href="#cb56-126" aria-hidden="true" tabindex="-1"></a><span class="co">// This will allows you to import the classified image in another script</span></span>
<span id="cb56-127"><a href="#cb56-127" aria-hidden="true" tabindex="-1"></a><span class="co">// without running the whole classification workflow.</span></span>
<span id="cb56-128"><a href="#cb56-128" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-129"><a href="#cb56-129" aria-hidden="true" tabindex="-1"></a><span class="co">// Hint: For images with discrete pixel values, we must set the</span></span>
<span id="cb56-130"><a href="#cb56-130" aria-hidden="true" tabindex="-1"></a><span class="co">// pyramidingPolicy to &#39;mode&#39;.</span></span>
<span id="cb56-131"><a href="#cb56-131" aria-hidden="true" tabindex="-1"></a><span class="co">// The pyramidingPolicy parameter should a dictionary specifying</span></span>
<span id="cb56-132"><a href="#cb56-132" aria-hidden="true" tabindex="-1"></a><span class="co">// the policy for each band. A simpler way to specify it for all</span></span>
<span id="cb56-133"><a href="#cb56-133" aria-hidden="true" tabindex="-1"></a><span class="co">// bands is to use {&#39;.default&#39;: &#39;mode&#39;}</span></span>
<span id="cb56-134"><a href="#cb56-134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-135"><a href="#cb56-135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-136"><a href="#cb56-136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-137"><a href="#cb56-137" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-138"><a href="#cb56-138" aria-hidden="true" tabindex="-1"></a><span class="co">// Change the assetId parameter with the path to your asset folder.</span></span>
<span id="cb56-139"><a href="#cb56-139" aria-hidden="true" tabindex="-1"></a>Export<span class="op">.</span><span class="at">image</span><span class="op">.</span><span class="fu">toAsset</span>({</span>
<span id="cb56-140"><a href="#cb56-140" aria-hidden="true" tabindex="-1"></a>  <span class="dt">image</span><span class="op">:</span> classified<span class="op">,</span></span>
<span id="cb56-141"><a href="#cb56-141" aria-hidden="true" tabindex="-1"></a>  <span class="dt">description</span><span class="op">:</span> <span class="st">&#39;Classified_Image_Asset_Export&#39;</span><span class="op">,</span></span>
<span id="cb56-142"><a href="#cb56-142" aria-hidden="true" tabindex="-1"></a>  <span class="dt">assetId</span><span class="op">:</span> <span class="st">&#39;users/ujavalgandhi/classified&#39;</span><span class="op">,</span></span>
<span id="cb56-143"><a href="#cb56-143" aria-hidden="true" tabindex="-1"></a>  <span class="dt">region</span><span class="op">:</span> boundary<span class="op">,</span></span>
<span id="cb56-144"><a href="#cb56-144" aria-hidden="true" tabindex="-1"></a>  <span class="dt">scale</span><span class="op">:</span> <span class="dv">10</span><span class="op">,</span></span>
<span id="cb56-145"><a href="#cb56-145" aria-hidden="true" tabindex="-1"></a>  <span class="dt">maxPixels</span><span class="op">:</span> <span class="fl">1e10</span><span class="op">,</span></span>
<span id="cb56-146"><a href="#cb56-146" aria-hidden="true" tabindex="-1"></a>  <span class="dt">pyramidingPolicy</span><span class="op">:</span> {<span class="st">&#39;.default&#39;</span><span class="op">:</span> <span class="st">&#39;mode&#39;</span>}</span>
<span id="cb56-147"><a href="#cb56-147" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb56-148"><a href="#cb56-148" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb56-149"><a href="#cb56-149" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-150"><a href="#cb56-150" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb56-151"><a href="#cb56-151" aria-hidden="true" tabindex="-1"></a> </span></code></pre></div>
<p><a href="https://code.earthengine.google.co.in/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3A04-Land_Use_Land_Cover_Classification%2F04c_Exporting_Classification_Results_(exercise)" target="_blank">Try in Code Editor ↗</a></p>
<div class="figure" style="text-align: center">
<img src="images/gee_water_resources_management/export_classification.png" alt="Exported Classified Asset" width="100%" />
<p class="caption">
Exported Classified Asset
</p>
</div>
</div>
</div>
<div id="using-existing-landcover-datasets" class="section level2">
<h2>05. Using Existing Landcover Datasets</h2>
<p>One of the ambitious projects was creating a global landcover data with many classes for many years. This type of data is essential as in expect few countries, the landcover data of terrain is not available / not shared publically by the local governments. Hence creating a global land cover has been attempted by a few organizations One among them is <em>European Space Agency</em>. The ESA has created the 10m global landcover called <a href="https://esa-worldcover.org/en">WorldCover</a> with 10 classes. At present, this data is available for the year 2020 and, ESA has promised to develop and release this data every year following 2020. <a href="https://vimeo.com/637205140">Watch the launch event</a> to know more about this data and the methodology used to create this.</p>
<p>We can use the <code>eq</code> operator to extract a particular class, extract the water class, and create a surface water map for the Arkavathy region.</p>
<div class="sourceCode" id="cb57"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> dataset <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&quot;ESA/WorldCover/v100&quot;</span>)<span class="op">.</span><span class="fu">first</span>()<span class="op">;</span></span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a><span class="co">// Select a Basin</span></span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> basin <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">&quot;WWF/HydroSHEDS/v1/Basins/hybas_7&quot;</span>)<span class="op">;</span></span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> selected <span class="op">=</span> basin<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;HYBAS_ID&#39;</span><span class="op">,</span> <span class="dv">4071139640</span>))</span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> geometry <span class="op">=</span> selected<span class="op">.</span><span class="fu">geometry</span>()</span>
<span id="cb57-7"><a href="#cb57-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-8"><a href="#cb57-8" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">centerObject</span>(geometry)<span class="op">;</span></span>
<span id="cb57-9"><a href="#cb57-9" aria-hidden="true" tabindex="-1"></a><span class="co">// Add the classified image</span></span>
<span id="cb57-10"><a href="#cb57-10" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> classification <span class="op">=</span> dataset<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;Map&#39;</span>)<span class="op">.</span><span class="fu">clip</span>(geometry)</span>
<span id="cb57-11"><a href="#cb57-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-12"><a href="#cb57-12" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(classification<span class="op">,</span> {}<span class="op">,</span> <span class="st">&#39;WorldCover Classification&#39;</span>)</span>
<span id="cb57-13"><a href="#cb57-13" aria-hidden="true" tabindex="-1"></a><span class="co">// Select water class</span></span>
<span id="cb57-14"><a href="#cb57-14" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> water <span class="op">=</span> classification<span class="op">.</span><span class="fu">eq</span>(<span class="dv">80</span>)</span>
<span id="cb57-15"><a href="#cb57-15" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(water<span class="op">,</span> {<span class="dt">min</span><span class="op">:</span><span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span><span class="dv">1</span><span class="op">,</span> <span class="dt">palette</span><span class="op">:</span> [<span class="st">&#39;white&#39;</span><span class="op">,</span> <span class="st">&#39;blue&#39;</span>]}<span class="op">,</span> <span class="st">&#39;Water&#39;</span>)</span></code></pre></div>
<p><a href="https://code.earthengine.google.com/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3A04-Land_Use_Land_Cover_Classification%2F05b_Using_Existing_Landcover_Datasets_(complete)" target="_blank">Open in Code Editor ↗</a></p>
<div class="figure" style="text-align: center">
<img src="images/gee_water_resources_management/esa_worldcover.png" alt="WorldView" width="75%" />
<p class="caption">
WorldView
</p>
</div>
<div id="exercise-26" class="section level3">
<h3>Exercise</h3>
<p>Use the WorldView data and extract the <code>Cropland</code> class for Arkavathy region. Then add it to map with <em>green</em> palette.</p>
<div class="sourceCode" id="cb58"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> dataset <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&quot;ESA/WorldCover/v100&quot;</span>)<span class="op">.</span><span class="fu">first</span>()<span class="op">;</span></span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a><span class="co">// Select a Basin</span></span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> basin <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">&quot;WWF/HydroSHEDS/v1/Basins/hybas_7&quot;</span>)<span class="op">;</span></span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> selected <span class="op">=</span> basin<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;HYBAS_ID&#39;</span><span class="op">,</span> <span class="dv">4071139640</span>))</span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> geometry <span class="op">=</span> selected<span class="op">.</span><span class="fu">geometry</span>()</span>
<span id="cb58-7"><a href="#cb58-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-8"><a href="#cb58-8" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">centerObject</span>(geometry)<span class="op">;</span></span>
<span id="cb58-9"><a href="#cb58-9" aria-hidden="true" tabindex="-1"></a><span class="co">// Add the classified image</span></span>
<span id="cb58-10"><a href="#cb58-10" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> classification <span class="op">=</span> dataset<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;Map&#39;</span>)<span class="op">.</span><span class="fu">clip</span>(geometry)</span>
<span id="cb58-11"><a href="#cb58-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-12"><a href="#cb58-12" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(classification<span class="op">,</span> {}<span class="op">,</span> <span class="st">&#39;WorldCover Classification&#39;</span>)</span>
<span id="cb58-13"><a href="#cb58-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-14"><a href="#cb58-14" aria-hidden="true" tabindex="-1"></a><span class="co">// Extract the &#39;Cropland&#39; class</span></span>
<span id="cb58-15"><a href="#cb58-15" aria-hidden="true" tabindex="-1"></a><span class="co">// Apply a selfMask()</span></span>
<span id="cb58-16"><a href="#cb58-16" aria-hidden="true" tabindex="-1"></a><span class="co">// Add it to the map with the &#39;green&#39; palette</span></span></code></pre></div>
<p><a href="https://code.earthengine.google.com/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3A04-Land_Use_Land_Cover_Classification%2F05c_Using_Existing_Landcover_Datasets_(exercise)" target="_blank">Open in Code Editor ↗</a></p>
</div>
</div>
<div id="calculating-area" class="section level2">
<h2>06. Calculating Area</h2>
<p>Now that we have extracted the open water from WorldView, we will learn how to calculate the area for pixels in each class. Calculating area for features is done using the <code>area()</code> function and for images using the <code>ee.Image.pixelArea()</code> function. The <code>ee.Image.pixelArea()</code> function creates an image where each pixel’s value is the area of the pixel. We multiply this pixel area image with our image and sum up the area using the <code>reduceRegion()</code> function.</p>
<blockquote>
<p>The <code>ee.Image.pixelArea()</code> function uses a custom equal-area projection for area calculation. The result is area in square meters regardless of the projection of the input image. <a href="https://groups.google.com/g/google-earth-engine-developers/c/Ccaorx-obVw/m/_ZQdP2wVAgAJ">Learn more</a></p>
</blockquote>
<div class="sourceCode" id="cb59"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> dataset <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&quot;ESA/WorldCover/v100&quot;</span>)<span class="op">.</span><span class="fu">first</span>()<span class="op">;</span></span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a><span class="co">// Select a Basin</span></span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> basin <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">&quot;WWF/HydroSHEDS/v1/Basins/hybas_7&quot;</span>)<span class="op">;</span></span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> selected <span class="op">=</span> basin<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;HYBAS_ID&#39;</span><span class="op">,</span> <span class="dv">4071139640</span>))</span>
<span id="cb59-6"><a href="#cb59-6" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> geometry <span class="op">=</span> selected<span class="op">.</span><span class="fu">geometry</span>()</span>
<span id="cb59-7"><a href="#cb59-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-8"><a href="#cb59-8" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">centerObject</span>(geometry)<span class="op">;</span></span>
<span id="cb59-9"><a href="#cb59-9" aria-hidden="true" tabindex="-1"></a><span class="co">// Add the classified image</span></span>
<span id="cb59-10"><a href="#cb59-10" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> classification <span class="op">=</span> dataset<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;Map&#39;</span>)<span class="op">.</span><span class="fu">clip</span>(geometry)</span>
<span id="cb59-11"><a href="#cb59-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-12"><a href="#cb59-12" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(classification<span class="op">,</span> {}<span class="op">,</span> <span class="st">&#39;WorldCover Classification&#39;</span>)</span>
<span id="cb59-13"><a href="#cb59-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-14"><a href="#cb59-14" aria-hidden="true" tabindex="-1"></a><span class="co">// .area() function calculates the area in square meters</span></span>
<span id="cb59-15"><a href="#cb59-15" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> basinArea <span class="op">=</span> geometry<span class="op">.</span><span class="fu">area</span>()</span>
<span id="cb59-16"><a href="#cb59-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-17"><a href="#cb59-17" aria-hidden="true" tabindex="-1"></a><span class="co">// We can cast the result to a ee.Number() and calculate the</span></span>
<span id="cb59-18"><a href="#cb59-18" aria-hidden="true" tabindex="-1"></a><span class="co">// area in square kilometers</span></span>
<span id="cb59-19"><a href="#cb59-19" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> basinAreaSqKm <span class="op">=</span> ee<span class="op">.</span><span class="fu">Number</span>(basinArea)<span class="op">.</span><span class="fu">divide</span>(<span class="fl">1e6</span>)<span class="op">.</span><span class="fu">round</span>()</span>
<span id="cb59-20"><a href="#cb59-20" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(basinAreaSqKm)</span>
<span id="cb59-21"><a href="#cb59-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-22"><a href="#cb59-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-23"><a href="#cb59-23" aria-hidden="true" tabindex="-1"></a><span class="co">// Area Calculation for Images</span></span>
<span id="cb59-24"><a href="#cb59-24" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> water <span class="op">=</span> classification<span class="op">.</span><span class="fu">eq</span>(<span class="dv">80</span>)</span>
<span id="cb59-25"><a href="#cb59-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-26"><a href="#cb59-26" aria-hidden="true" tabindex="-1"></a><span class="co">// If the image contains values 0 or 1, we can calculate the</span></span>
<span id="cb59-27"><a href="#cb59-27" aria-hidden="true" tabindex="-1"></a><span class="co">// total area using reduceRegion() function</span></span>
<span id="cb59-28"><a href="#cb59-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-29"><a href="#cb59-29" aria-hidden="true" tabindex="-1"></a><span class="co">// The result of .eq() operation is a binary image with pixels</span></span>
<span id="cb59-30"><a href="#cb59-30" aria-hidden="true" tabindex="-1"></a><span class="co">// values of 1 where the condition matched and 0 where it didn&#39;t</span></span>
<span id="cb59-31"><a href="#cb59-31" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(water<span class="op">,</span> {<span class="dt">min</span><span class="op">:</span><span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span><span class="dv">1</span><span class="op">,</span> <span class="dt">palette</span><span class="op">:</span> [<span class="st">&#39;white&#39;</span><span class="op">,</span> <span class="st">&#39;blue&#39;</span>]}<span class="op">,</span> <span class="st">&#39;Surface Water&#39;</span>)</span>
<span id="cb59-32"><a href="#cb59-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-33"><a href="#cb59-33" aria-hidden="true" tabindex="-1"></a><span class="co">// Since our image has only 0 and 1 pixel values, the vegetation</span></span>
<span id="cb59-34"><a href="#cb59-34" aria-hidden="true" tabindex="-1"></a><span class="co">// pixels will have values equal to their area</span></span>
<span id="cb59-35"><a href="#cb59-35" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> areaImage <span class="op">=</span> water<span class="op">.</span><span class="fu">multiply</span>(ee<span class="op">.</span><span class="at">Image</span><span class="op">.</span><span class="fu">pixelArea</span>())</span>
<span id="cb59-36"><a href="#cb59-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-37"><a href="#cb59-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-38"><a href="#cb59-38" aria-hidden="true" tabindex="-1"></a><span class="co">// Now that each pixel for vegetation class in the image has the value</span></span>
<span id="cb59-39"><a href="#cb59-39" aria-hidden="true" tabindex="-1"></a><span class="co">// equal to its area, we can sum up all the values in the region</span></span>
<span id="cb59-40"><a href="#cb59-40" aria-hidden="true" tabindex="-1"></a><span class="co">// to get the total green cover.</span></span>
<span id="cb59-41"><a href="#cb59-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-42"><a href="#cb59-42" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> area <span class="op">=</span> areaImage<span class="op">.</span><span class="fu">reduceRegion</span>({</span>
<span id="cb59-43"><a href="#cb59-43" aria-hidden="true" tabindex="-1"></a>  <span class="dt">reducer</span><span class="op">:</span> ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">sum</span>()<span class="op">,</span></span>
<span id="cb59-44"><a href="#cb59-44" aria-hidden="true" tabindex="-1"></a>  <span class="dt">geometry</span><span class="op">:</span> geometry<span class="op">,</span></span>
<span id="cb59-45"><a href="#cb59-45" aria-hidden="true" tabindex="-1"></a>  <span class="dt">scale</span><span class="op">:</span> <span class="dv">10</span><span class="op">,</span></span>
<span id="cb59-46"><a href="#cb59-46" aria-hidden="true" tabindex="-1"></a>  <span class="dt">maxPixels</span><span class="op">:</span> <span class="fl">1e10</span></span>
<span id="cb59-47"><a href="#cb59-47" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb59-48"><a href="#cb59-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-49"><a href="#cb59-49" aria-hidden="true" tabindex="-1"></a><span class="co">// The result of the reduceRegion() function is a dictionary with the key</span></span>
<span id="cb59-50"><a href="#cb59-50" aria-hidden="true" tabindex="-1"></a><span class="co">// being the band name. We can extract the area number and convert it to</span></span>
<span id="cb59-51"><a href="#cb59-51" aria-hidden="true" tabindex="-1"></a><span class="co">// square kilometers</span></span>
<span id="cb59-52"><a href="#cb59-52" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> waterAreaSqKm <span class="op">=</span> ee<span class="op">.</span><span class="fu">Number</span>(area<span class="op">.</span><span class="fu">get</span>(<span class="st">&#39;Map&#39;</span>))<span class="op">.</span><span class="fu">divide</span>(<span class="fl">1e6</span>)<span class="op">.</span><span class="fu">round</span>()</span>
<span id="cb59-53"><a href="#cb59-53" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(waterAreaSqKm) </span></code></pre></div>
<p><a href="https://code.earthengine.google.com/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3A04-Land_Use_Land_Cover_Classification%2F06b_Calculating_Area_(complete)" target="_blank">Open in Code Editor ↗</a></p>
<p>Output</p>
<pre><code>Total basin Area(sqkm)
4178

Total water area in the basin(sqkm)
19</code></pre>
<div id="exercise-27" class="section level3">
<h3>Exercise</h3>
<p>Extract the area value as a number and convert it as hectares.</p>
<div class="sourceCode" id="cb61"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> dataset <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&quot;ESA/WorldCover/v100&quot;</span>)<span class="op">.</span><span class="fu">first</span>()<span class="op">;</span></span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a><span class="co">// Select a Basin</span></span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> basin <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">&quot;WWF/HydroSHEDS/v1/Basins/hybas_7&quot;</span>)<span class="op">;</span></span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> selected <span class="op">=</span> basin<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;HYBAS_ID&#39;</span><span class="op">,</span> <span class="dv">4071139640</span>))</span>
<span id="cb61-6"><a href="#cb61-6" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> geometry <span class="op">=</span> selected<span class="op">.</span><span class="fu">geometry</span>()</span>
<span id="cb61-7"><a href="#cb61-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-8"><a href="#cb61-8" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">centerObject</span>(geometry)<span class="op">;</span></span>
<span id="cb61-9"><a href="#cb61-9" aria-hidden="true" tabindex="-1"></a><span class="co">// Add the classified image</span></span>
<span id="cb61-10"><a href="#cb61-10" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> classification <span class="op">=</span> dataset<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;Map&#39;</span>)<span class="op">.</span><span class="fu">clip</span>(geometry)</span>
<span id="cb61-11"><a href="#cb61-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-12"><a href="#cb61-12" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(classification<span class="op">,</span> {}<span class="op">,</span> <span class="st">&#39;WorldCover Classification&#39;</span>)</span>
<span id="cb61-13"><a href="#cb61-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-14"><a href="#cb61-14" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> basinArea <span class="op">=</span> geometry<span class="op">.</span><span class="fu">area</span>()</span>
<span id="cb61-15"><a href="#cb61-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-16"><a href="#cb61-16" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> cropland <span class="op">=</span> classification<span class="op">.</span><span class="fu">eq</span>(<span class="dv">40</span>)</span>
<span id="cb61-17"><a href="#cb61-17" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(cropland<span class="op">,</span> {<span class="dt">min</span><span class="op">:</span><span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span><span class="dv">1</span><span class="op">,</span> <span class="dt">palette</span><span class="op">:</span> [<span class="st">&#39;white&#39;</span><span class="op">,</span> <span class="st">&#39;green&#39;</span>]}<span class="op">,</span> <span class="st">&#39;Cropland&#39;</span>)</span>
<span id="cb61-18"><a href="#cb61-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-19"><a href="#cb61-19" aria-hidden="true" tabindex="-1"></a><span class="co">// Since our image has only 0 and 1 pixel values, the vegetation</span></span>
<span id="cb61-20"><a href="#cb61-20" aria-hidden="true" tabindex="-1"></a><span class="co">// pixels will have values equal to their area</span></span>
<span id="cb61-21"><a href="#cb61-21" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> areaImage <span class="op">=</span> cropland<span class="op">.</span><span class="fu">multiply</span>(ee<span class="op">.</span><span class="at">Image</span><span class="op">.</span><span class="fu">pixelArea</span>())</span>
<span id="cb61-22"><a href="#cb61-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-23"><a href="#cb61-23" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> area <span class="op">=</span> areaImage<span class="op">.</span><span class="fu">reduceRegion</span>({</span>
<span id="cb61-24"><a href="#cb61-24" aria-hidden="true" tabindex="-1"></a>  <span class="dt">reducer</span><span class="op">:</span> ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">sum</span>()<span class="op">,</span></span>
<span id="cb61-25"><a href="#cb61-25" aria-hidden="true" tabindex="-1"></a>  <span class="dt">geometry</span><span class="op">:</span> geometry<span class="op">,</span></span>
<span id="cb61-26"><a href="#cb61-26" aria-hidden="true" tabindex="-1"></a>  <span class="dt">scale</span><span class="op">:</span> <span class="dv">10</span><span class="op">,</span></span>
<span id="cb61-27"><a href="#cb61-27" aria-hidden="true" tabindex="-1"></a>  <span class="dt">maxPixels</span><span class="op">:</span> <span class="fl">1e10</span></span>
<span id="cb61-28"><a href="#cb61-28" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb61-29"><a href="#cb61-29" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="st">&#39;Cropland Area Sq Meters&#39;</span><span class="op">,</span> area)</span>
<span id="cb61-30"><a href="#cb61-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-31"><a href="#cb61-31" aria-hidden="true" tabindex="-1"></a><span class="co">// Extract the area value from the dictionaty</span></span>
<span id="cb61-32"><a href="#cb61-32" aria-hidden="true" tabindex="-1"></a><span class="co">// Print the cropland area in hectares</span></span>
<span id="cb61-33"><a href="#cb61-33" aria-hidden="true" tabindex="-1"></a><span class="co">// Hint: 1 Hectare = 10000 sq. meters</span></span></code></pre></div>
<p><a href="https://code.earthengine.google.com/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3A04-Land_Use_Land_Cover_Classification%2F06c_Calculating_Area_(exercise)" target="_blank">Try in Code Editor ↗</a></p>
</div>
</div>
</div>
<div id="module-5-flood-mapping" class="section level1">
<h1>Module 5: Flood Mapping</h1>
<p>This module lets us map the flooded regions and calculate the flooded area during the <a href="https://en.wikipedia.org/wiki/2018_Kerala_floods">2018 Kerala Floods</a> in Ernakulam district.</p>
<p>We will use the Sentinel 1 GRD (Ground Range Detected) data. This satellite is an active remote sensing platform that uses the microwave C-band to collect data. The main advantage of using microwave data is that it can penetrate through clouds and capture reflectance value both day and night since it is not dependent on Sunlight for reflectance. The spatial resolution of this data is 10m, and the temporal resolution varies between 6-12 days, depending on the location.</p>
<p>The Google Earth Engine provides an Analysis Ready Data (ARD) in which all the required pre-processing is done. To know more about microwave remote sensing data application and usage, visit <a href="https://www.nrcan.gc.ca/maps-tools-and-publications/satellite-imagery-and-air-photos/tutorial-fundamentals-remote-sensing/9309">Remote Sensing Tutorials</a> by Canada Centre for Mapping and Earth Observation.</p>
<p><a href="https://docs.google.com/presentation/d/1w1bTP49jI4LbHYTtQzEg4yytGGbCx_l5bhTisITXxKY/edit?usp=sharing" target="_blank"><img src="images/gee_water_resources_management/flood_mapping.png" width="400" alt="View Presentation" /></a></p>
<p><a href="https://docs.google.com/presentation/d/1w1bTP49jI4LbHYTtQzEg4yytGGbCx_l5bhTisITXxKY/edit?usp=sharing" target="_blank">View the Presentation ↗</a></p>
<div id="load-and-filter-sentinel-1-data" class="section level2">
<h2>01. Load and Filter Sentinel-1 Data</h2>
<p>We have learned basic skills to search for a dataset and filter it to a date range and location. Let us load the <a href="https://developers.google.com/earth-engine/datasets/catalog/COPERNICUS_S1_GRD">Sentinel-1 C-band SAR log scaling</a> dataset and filter the collection to flooding event time period. Filter the collection to the Ernakulam region.</p>
<p>Each image will have 3 bands <em>VV</em>, <em>VH</em>, and <em>angle</em>. Most research results say <em>VH - (vertical transmit and horizontal receive)</em> is best for detecting floods as water has low reflectance in the VH band and is easy to detect. Lets us select the VH band, clip it to the ROI and display it in Map with the appropriate visualization parameter.</p>
<div class="sourceCode" id="cb62"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="co">// On 16 August 2018, severe floods affected the south Indian state Kerala</span></span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a><span class="co">// due to unusually high rainfall during the monsoon season.</span></span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a><span class="co">// It was the worst flood in Kerala in nearly a century.</span></span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a><span class="co">// https://en.wikipedia.org/wiki/2018_Kerala_floods</span></span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-6"><a href="#cb62-6" aria-hidden="true" tabindex="-1"></a><span class="co">// Select images by predefined dates</span></span>
<span id="cb62-7"><a href="#cb62-7" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> beforeStart <span class="op">=</span> <span class="st">&#39;2018-07-15&#39;</span></span>
<span id="cb62-8"><a href="#cb62-8" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> beforeEnd <span class="op">=</span> <span class="st">&#39;2018-08-10&#39;</span></span>
<span id="cb62-9"><a href="#cb62-9" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> afterStart <span class="op">=</span> <span class="st">&#39;2018-08-10&#39;</span></span>
<span id="cb62-10"><a href="#cb62-10" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> afterEnd <span class="op">=</span> <span class="st">&#39;2018-08-23&#39;</span></span>
<span id="cb62-11"><a href="#cb62-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-12"><a href="#cb62-12" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> admin2 <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">&quot;FAO/GAUL_SIMPLIFIED_500m/2015/level2&quot;</span>)<span class="op">;</span></span>
<span id="cb62-13"><a href="#cb62-13" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> ernakulam <span class="op">=</span> admin2<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;ADM2_NAME&#39;</span><span class="op">,</span> <span class="st">&#39;Ernakulam&#39;</span>))</span>
<span id="cb62-14"><a href="#cb62-14" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> geometry <span class="op">=</span> ernakulam<span class="op">.</span><span class="fu">geometry</span>()</span>
<span id="cb62-15"><a href="#cb62-15" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">centerObject</span>(geometry)</span>
<span id="cb62-16"><a href="#cb62-16" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(geometry<span class="op">,</span> {<span class="dt">color</span><span class="op">:</span> <span class="st">&#39;grey&#39;</span>}<span class="op">,</span> <span class="st">&#39;Ernakulam District&#39;</span>)</span>
<span id="cb62-17"><a href="#cb62-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-18"><a href="#cb62-18" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> collection<span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&#39;COPERNICUS/S1_GRD&#39;</span>)</span>
<span id="cb62-19"><a href="#cb62-19" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(beforeStart<span class="op">,</span> beforeEnd))</span>
<span id="cb62-20"><a href="#cb62-20" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">bounds</span>(geometry))</span>
<span id="cb62-21"><a href="#cb62-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-22"><a href="#cb62-22" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> image <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(collection<span class="op">.</span><span class="fu">first</span>())</span>
<span id="cb62-23"><a href="#cb62-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-24"><a href="#cb62-24" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> imageVh <span class="op">=</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;VH&#39;</span>)<span class="op">.</span><span class="fu">clip</span>(geometry)</span>
<span id="cb62-25"><a href="#cb62-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-26"><a href="#cb62-26" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(imageVh<span class="op">,</span> {<span class="dt">min</span><span class="op">:-</span><span class="dv">30</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span> <span class="dv">0</span>}<span class="op">,</span> <span class="st">&#39;VH (dB)&#39;</span>)</span></code></pre></div>
<p><a href="https://code.earthengine.google.com/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3A05-Flood_Mapping%2F01b_Load_and_Filter_Sentinel-1_Data_(complete)" target="_blank">Open in Code Editor ↗</a></p>
<div id="exercise-28" class="section level3">
<h3>Exercise</h3>
<p>To detect the flooded regions, we need 2 collections, one before and another after flood occurrence. A before image and an after image has been created. Select the <em>VH</em> band from the images and add both images to the map canvas.</p>
<div class="figure" style="text-align: center">
<img src="images/gee_water_resources_management/flood_vh.png" alt="VH single band visualization" width="100%" />
<p class="caption">
VH single band visualization
</p>
</div>
<div class="sourceCode" id="cb63"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="co">// On 16 August 2018, severe floods affected the south Indian state Kerala</span></span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a><span class="co">// due to unusually high rainfall during the monsoon season.</span></span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a><span class="co">// It was the worst flood in Kerala in nearly a century.</span></span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a><span class="co">// https://en.wikipedia.org/wiki/2018_Kerala_floods</span></span>
<span id="cb63-5"><a href="#cb63-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-6"><a href="#cb63-6" aria-hidden="true" tabindex="-1"></a><span class="co">// Select images by predefined dates</span></span>
<span id="cb63-7"><a href="#cb63-7" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> beforeStart <span class="op">=</span> <span class="st">&#39;2018-07-15&#39;</span></span>
<span id="cb63-8"><a href="#cb63-8" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> beforeEnd <span class="op">=</span> <span class="st">&#39;2018-08-10&#39;</span></span>
<span id="cb63-9"><a href="#cb63-9" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> afterStart <span class="op">=</span> <span class="st">&#39;2018-08-10&#39;</span></span>
<span id="cb63-10"><a href="#cb63-10" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> afterEnd <span class="op">=</span> <span class="st">&#39;2018-08-23&#39;</span></span>
<span id="cb63-11"><a href="#cb63-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-12"><a href="#cb63-12" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> admin2 <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">&quot;FAO/GAUL_SIMPLIFIED_500m/2015/level2&quot;</span>)<span class="op">;</span></span>
<span id="cb63-13"><a href="#cb63-13" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> ernakulam <span class="op">=</span> admin2<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;ADM2_NAME&#39;</span><span class="op">,</span> <span class="st">&#39;Ernakulam&#39;</span>))</span>
<span id="cb63-14"><a href="#cb63-14" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> geometry <span class="op">=</span> ernakulam<span class="op">.</span><span class="fu">geometry</span>()</span>
<span id="cb63-15"><a href="#cb63-15" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">centerObject</span>(geometry)</span>
<span id="cb63-16"><a href="#cb63-16" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(geometry<span class="op">,</span> {<span class="dt">color</span><span class="op">:</span> <span class="st">&#39;grey&#39;</span>}<span class="op">,</span> <span class="st">&#39;Ernakulam District&#39;</span>)</span>
<span id="cb63-17"><a href="#cb63-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-18"><a href="#cb63-18" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> collection<span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&#39;COPERNICUS/S1_GRD&#39;</span>)</span>
<span id="cb63-19"><a href="#cb63-19" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">bounds</span>(geometry))</span>
<span id="cb63-20"><a href="#cb63-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-21"><a href="#cb63-21" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> beforeCollection <span class="op">=</span> collection<span class="op">.</span><span class="fu">filterDate</span>(beforeStart<span class="op">,</span> beforeEnd)</span>
<span id="cb63-22"><a href="#cb63-22" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> afterCollection <span class="op">=</span> collection<span class="op">.</span><span class="fu">filterDate</span>(afterStart<span class="op">,</span>afterEnd)</span>
<span id="cb63-23"><a href="#cb63-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-24"><a href="#cb63-24" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> beforeImage <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(beforeCollection<span class="op">.</span><span class="fu">first</span>())</span>
<span id="cb63-25"><a href="#cb63-25" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> afterImage <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(afterCollection<span class="op">.</span><span class="fu">first</span>())</span>
<span id="cb63-26"><a href="#cb63-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-27"><a href="#cb63-27" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(beforeImage)</span>
<span id="cb63-28"><a href="#cb63-28" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(afterImage)</span>
<span id="cb63-29"><a href="#cb63-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-30"><a href="#cb63-30" aria-hidden="true" tabindex="-1"></a><span class="co">// Exercise</span></span>
<span id="cb63-31"><a href="#cb63-31" aria-hidden="true" tabindex="-1"></a><span class="co">// Select the &#39;VH&#39; band of before and after images</span></span>
<span id="cb63-32"><a href="#cb63-32" aria-hidden="true" tabindex="-1"></a><span class="co">// Add them to the map.</span></span>
<span id="cb63-33"><a href="#cb63-33" aria-hidden="true" tabindex="-1"></a><span class="co">// Inspect the images and find suitable values for visualization parameters</span></span>
<span id="cb63-34"><a href="#cb63-34" aria-hidden="true" tabindex="-1"></a> </span></code></pre></div>
<p><a href="https://code.earthengine.google.com/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3A05-Flood_Mapping%2F01c_Load_and_Filter_Sentinel-1_Data_(exercise)" target="_blank">Try in Code Editor ↗</a></p>
</div>
</div>
<div id="visualize-rgb-composites" class="section level2">
<h2>02. Visualize RGB Composites</h2>
<p>We visualized the VH band as a single band image in the previous exercise. We can also visualize a SAR image as a multi-band RGB image. The usual practice is using the <em>VV</em> band in the red channel, the <em>VH</em> band in the green channel, and the <em>VV/VH</em> in the blue channel.</p>
<p>Three bands have different min-max values, but a single number for min-max value in visualization will not be correct. So we can pass a list of numbers, each representing each band’s min-max value in Red Green Blue order, respectively.</p>
<div class="figure" style="text-align: center">
<img src="images/gee_water_resources_management/flood_rgb.png" alt="RGB multi band visualization" width="100%" />
<p class="caption">
RGB multi band visualization
</p>
</div>
<div class="sourceCode" id="cb64"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="co">// On 16 August 2018, severe floods affected the south Indian state Kerala</span></span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a><span class="co">// due to unusually high rainfall during the monsoon season.</span></span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a><span class="co">// It was the worst flood in Kerala in nearly a century.</span></span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a><span class="co">// https://en.wikipedia.org/wiki/2018_Kerala_floods</span></span>
<span id="cb64-5"><a href="#cb64-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-6"><a href="#cb64-6" aria-hidden="true" tabindex="-1"></a><span class="co">// Select images by predefined dates</span></span>
<span id="cb64-7"><a href="#cb64-7" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> beforeStart <span class="op">=</span> <span class="st">&#39;2018-07-15&#39;</span></span>
<span id="cb64-8"><a href="#cb64-8" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> beforeEnd <span class="op">=</span> <span class="st">&#39;2018-08-10&#39;</span></span>
<span id="cb64-9"><a href="#cb64-9" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> afterStart <span class="op">=</span> <span class="st">&#39;2018-08-10&#39;</span></span>
<span id="cb64-10"><a href="#cb64-10" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> afterEnd <span class="op">=</span> <span class="st">&#39;2018-08-23&#39;</span></span>
<span id="cb64-11"><a href="#cb64-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-12"><a href="#cb64-12" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> admin2 <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">&quot;FAO/GAUL_SIMPLIFIED_500m/2015/level2&quot;</span>)<span class="op">;</span></span>
<span id="cb64-13"><a href="#cb64-13" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> ernakulam <span class="op">=</span> admin2<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;ADM2_NAME&#39;</span><span class="op">,</span> <span class="st">&#39;Ernakulam&#39;</span>))</span>
<span id="cb64-14"><a href="#cb64-14" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> geometry <span class="op">=</span> ernakulam<span class="op">.</span><span class="fu">geometry</span>()</span>
<span id="cb64-15"><a href="#cb64-15" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(geometry<span class="op">,</span> {<span class="dt">color</span><span class="op">:</span> <span class="st">&#39;grey&#39;</span>}<span class="op">,</span> <span class="st">&#39;Ernakulam District&#39;</span>)</span>
<span id="cb64-16"><a href="#cb64-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-17"><a href="#cb64-17" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> collection<span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&#39;COPERNICUS/S1_GRD&#39;</span>)</span>
<span id="cb64-18"><a href="#cb64-18" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;instrumentMode&#39;</span><span class="op">,</span><span class="st">&#39;IW&#39;</span>))</span>
<span id="cb64-19"><a href="#cb64-19" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">listContains</span>(<span class="st">&#39;transmitterReceiverPolarisation&#39;</span><span class="op">,</span> <span class="st">&#39;VH&#39;</span>))</span>
<span id="cb64-20"><a href="#cb64-20" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">listContains</span>(<span class="st">&#39;transmitterReceiverPolarisation&#39;</span><span class="op">,</span> <span class="st">&#39;VV&#39;</span>))</span>
<span id="cb64-21"><a href="#cb64-21" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;orbitProperties_pass&#39;</span><span class="op">,</span> <span class="st">&#39;DESCENDING&#39;</span>)) </span>
<span id="cb64-22"><a href="#cb64-22" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;resolution_meters&#39;</span><span class="op">,</span><span class="dv">10</span>))</span>
<span id="cb64-23"><a href="#cb64-23" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">bounds</span>(geometry))</span>
<span id="cb64-24"><a href="#cb64-24" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">select</span>([<span class="st">&#39;VV&#39;</span><span class="op">,</span> <span class="st">&#39;VH&#39;</span>])</span>
<span id="cb64-25"><a href="#cb64-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-26"><a href="#cb64-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-27"><a href="#cb64-27" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> beforeCollection <span class="op">=</span> collection</span>
<span id="cb64-28"><a href="#cb64-28" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(beforeStart<span class="op">,</span> beforeEnd))</span>
<span id="cb64-29"><a href="#cb64-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-30"><a href="#cb64-30" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> afterCollection <span class="op">=</span> collection</span>
<span id="cb64-31"><a href="#cb64-31" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(afterStart<span class="op">,</span> afterEnd))</span>
<span id="cb64-32"><a href="#cb64-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-33"><a href="#cb64-33" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> before <span class="op">=</span> beforeCollection<span class="op">.</span><span class="fu">mosaic</span>()<span class="op">.</span><span class="fu">clip</span>(geometry)<span class="op">;</span></span>
<span id="cb64-34"><a href="#cb64-34" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> after <span class="op">=</span> afterCollection<span class="op">.</span><span class="fu">mosaic</span>()<span class="op">.</span><span class="fu">clip</span>(geometry)<span class="op">;</span></span>
<span id="cb64-35"><a href="#cb64-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-36"><a href="#cb64-36" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> addRatioBand <span class="op">=</span> <span class="kw">function</span>(image) {</span>
<span id="cb64-37"><a href="#cb64-37" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> ratioBand <span class="op">=</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;VV&#39;</span>)<span class="op">.</span><span class="fu">divide</span>(image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;VH&#39;</span>))<span class="op">.</span><span class="fu">rename</span>(<span class="st">&#39;VV/VH&#39;</span>)</span>
<span id="cb64-38"><a href="#cb64-38" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> image<span class="op">.</span><span class="fu">addBands</span>(ratioBand)</span>
<span id="cb64-39"><a href="#cb64-39" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb64-40"><a href="#cb64-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-41"><a href="#cb64-41" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> beforeRgb <span class="op">=</span> <span class="fu">addRatioBand</span>(before)</span>
<span id="cb64-42"><a href="#cb64-42" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> afterRgb <span class="op">=</span> <span class="fu">addRatioBand</span>(after)</span>
<span id="cb64-43"><a href="#cb64-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-44"><a href="#cb64-44" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> visParams <span class="op">=</span> {<span class="dt">min</span><span class="op">:</span>[<span class="op">-</span><span class="dv">25</span><span class="op">,</span> <span class="op">-</span><span class="dv">25</span><span class="op">,</span> <span class="dv">0</span>] <span class="op">,</span><span class="dt">max</span><span class="op">:</span>[<span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">2</span>]}</span>
<span id="cb64-45"><a href="#cb64-45" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">centerObject</span>(geometry<span class="op">,</span> <span class="dv">10</span>)</span>
<span id="cb64-46"><a href="#cb64-46" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(beforeRgb<span class="op">,</span> visParams<span class="op">,</span> <span class="st">&#39;Before Floods&#39;</span>)<span class="op">;</span></span>
<span id="cb64-47"><a href="#cb64-47" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(afterRgb<span class="op">,</span> visParams<span class="op">,</span> <span class="st">&#39;After Floods&#39;</span>)<span class="op">;</span> </span></code></pre></div>
<p><a href="https://code.earthengine.google.com/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3A05-Flood_Mapping%2F02b_Visualize_RGB_Composites_(complete)" target="_blank">Open in Code Editor ↗</a></p>
<div id="exercise-29" class="section level3">
<h3>Exercise</h3>
<p>We have learned to visualize a multi-band image using <em>VV</em>, <em>VH</em>, and <em>VV/VH</em> bands. Let us visualize the change by creating a composite image with <em>VH - before image</em>, <em>VH - after image</em>, and <em>VH - before image</em>. This visualization can effectively identify the before and after images’ changes.</p>
<p>To create this visualization, select the particular bands from each image and concatenate the three bands in the same order using <code>ee.Image.cat</code> function, use the visualization parameter as min: -25 and max: -8 and add it to the canvas.</p>
<div class="figure" style="text-align: center">
<img src="images/gee_water_resources_management/flood_composite.png" alt="Change visualization" width="75%" />
<p class="caption">
Change visualization
</p>
</div>
<div class="sourceCode" id="cb65"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="co">// On 16 August 2018, severe floods affected the south Indian state Kerala</span></span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a><span class="co">// due to unusually high rainfall during the monsoon season.</span></span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a><span class="co">// It was the worst flood in Kerala in nearly a century.</span></span>
<span id="cb65-4"><a href="#cb65-4" aria-hidden="true" tabindex="-1"></a><span class="co">// https://en.wikipedia.org/wiki/2018_Kerala_floods</span></span>
<span id="cb65-5"><a href="#cb65-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-6"><a href="#cb65-6" aria-hidden="true" tabindex="-1"></a><span class="co">// Select images by predefined dates</span></span>
<span id="cb65-7"><a href="#cb65-7" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> beforeStart <span class="op">=</span> <span class="st">&#39;2018-07-15&#39;</span></span>
<span id="cb65-8"><a href="#cb65-8" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> beforeEnd <span class="op">=</span> <span class="st">&#39;2018-08-10&#39;</span></span>
<span id="cb65-9"><a href="#cb65-9" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> afterStart <span class="op">=</span> <span class="st">&#39;2018-08-10&#39;</span></span>
<span id="cb65-10"><a href="#cb65-10" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> afterEnd <span class="op">=</span> <span class="st">&#39;2018-08-23&#39;</span></span>
<span id="cb65-11"><a href="#cb65-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-12"><a href="#cb65-12" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> admin2 <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">&quot;FAO/GAUL_SIMPLIFIED_500m/2015/level2&quot;</span>)<span class="op">;</span></span>
<span id="cb65-13"><a href="#cb65-13" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> ernakulam <span class="op">=</span> admin2<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;ADM2_NAME&#39;</span><span class="op">,</span> <span class="st">&#39;Ernakulam&#39;</span>))</span>
<span id="cb65-14"><a href="#cb65-14" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> geometry <span class="op">=</span> ernakulam<span class="op">.</span><span class="fu">geometry</span>()</span>
<span id="cb65-15"><a href="#cb65-15" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(geometry<span class="op">,</span> {<span class="dt">color</span><span class="op">:</span> <span class="st">&#39;grey&#39;</span>}<span class="op">,</span> <span class="st">&#39;Ernakulam District&#39;</span>)</span>
<span id="cb65-16"><a href="#cb65-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-17"><a href="#cb65-17" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> collection<span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&#39;COPERNICUS/S1_GRD&#39;</span>)</span>
<span id="cb65-18"><a href="#cb65-18" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;instrumentMode&#39;</span><span class="op">,</span><span class="st">&#39;IW&#39;</span>))</span>
<span id="cb65-19"><a href="#cb65-19" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">listContains</span>(<span class="st">&#39;transmitterReceiverPolarisation&#39;</span><span class="op">,</span> <span class="st">&#39;VH&#39;</span>))</span>
<span id="cb65-20"><a href="#cb65-20" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">listContains</span>(<span class="st">&#39;transmitterReceiverPolarisation&#39;</span><span class="op">,</span> <span class="st">&#39;VV&#39;</span>))</span>
<span id="cb65-21"><a href="#cb65-21" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;orbitProperties_pass&#39;</span><span class="op">,</span> <span class="st">&#39;DESCENDING&#39;</span>)) </span>
<span id="cb65-22"><a href="#cb65-22" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;resolution_meters&#39;</span><span class="op">,</span><span class="dv">10</span>))</span>
<span id="cb65-23"><a href="#cb65-23" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">bounds</span>(geometry))</span>
<span id="cb65-24"><a href="#cb65-24" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">select</span>([<span class="st">&#39;VV&#39;</span><span class="op">,</span> <span class="st">&#39;VH&#39;</span>])</span>
<span id="cb65-25"><a href="#cb65-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-26"><a href="#cb65-26" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> beforeCollection <span class="op">=</span> collection</span>
<span id="cb65-27"><a href="#cb65-27" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(beforeStart<span class="op">,</span> beforeEnd))</span>
<span id="cb65-28"><a href="#cb65-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-29"><a href="#cb65-29" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> afterCollection <span class="op">=</span> collection</span>
<span id="cb65-30"><a href="#cb65-30" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(afterStart<span class="op">,</span> afterEnd))</span>
<span id="cb65-31"><a href="#cb65-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-32"><a href="#cb65-32" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> before <span class="op">=</span> beforeCollection<span class="op">.</span><span class="fu">mosaic</span>()<span class="op">.</span><span class="fu">clip</span>(geometry)<span class="op">;</span></span>
<span id="cb65-33"><a href="#cb65-33" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> after <span class="op">=</span> afterCollection<span class="op">.</span><span class="fu">mosaic</span>()<span class="op">.</span><span class="fu">clip</span>(geometry)<span class="op">;</span></span>
<span id="cb65-34"><a href="#cb65-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-35"><a href="#cb65-35" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> visParams <span class="op">=</span> {<span class="dt">min</span><span class="op">:</span> <span class="op">-</span><span class="dv">30</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span> <span class="dv">0</span>}</span>
<span id="cb65-36"><a href="#cb65-36" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">centerObject</span>(geometry<span class="op">,</span> <span class="dv">10</span>)</span>
<span id="cb65-37"><a href="#cb65-37" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(before<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;VH&#39;</span>)<span class="op">,</span> visParams<span class="op">,</span> <span class="st">&#39;Before Floods&#39;</span>)<span class="op">;</span></span>
<span id="cb65-38"><a href="#cb65-38" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(after<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;VH&#39;</span>)<span class="op">,</span> visParams<span class="op">,</span> <span class="st">&#39;After Floods&#39;</span>)<span class="op">;</span> </span>
<span id="cb65-39"><a href="#cb65-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-40"><a href="#cb65-40" aria-hidden="true" tabindex="-1"></a><span class="co">// Change Detection  RGB Visualization</span></span>
<span id="cb65-41"><a href="#cb65-41" aria-hidden="true" tabindex="-1"></a><span class="co">// Create a RGB composite with following Band Combination</span></span>
<span id="cb65-42"><a href="#cb65-42" aria-hidden="true" tabindex="-1"></a><span class="co">// Before VH, After VH, Before VH</span></span>
<span id="cb65-43"><a href="#cb65-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-44"><a href="#cb65-44" aria-hidden="true" tabindex="-1"></a><span class="co">// Hint: Use ee.Image.cat() to create a 3-band image</span></span>
<span id="cb65-45"><a href="#cb65-45" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb65-46"><a href="#cb65-46" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb65-47"><a href="#cb65-47" aria-hidden="true" tabindex="-1"></a><span class="co">// Display the image with a min/max range of -25 to -8</span></span></code></pre></div>
<p><a href="https://code.earthengine.google.com/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3A05-Flood_Mapping%2F02c_Visualize_RGB_Composites_(exercise)" target="_blank">Try in Code Editor ↗</a></p>
</div>
</div>
<div id="apply-speckle-filter" class="section level2">
<h2>03. Apply Speckle Filter</h2>
<p>Any SAR image will be with noise. Speckle is like salt and pepper noise in the image. Before performing any operation, a filter is applied over the image to smooth it and reduce the noise. There are many types of filters. <em>RefinedLee</em> filter is a more scientific approach in filtering the noise.</p>
<p>The raw image should be passed into the <code>RefinedLee</code> function. Hence, the log image is converted to raw using the <code>toNatural</code> function. The resulting image from RefinedLee is again converted to log scale by passing it <code>toDB</code> function.</p>
<blockquote>
<p>Guido Lemoine implemented the RefinedLee filter in GEE. Keeping the Speckle filtering function at the end of any SAR processing script can be very handy for conversions and save time.</p>
</blockquote>
<div class="figure" style="text-align: center">
<img src="images/gee_water_resources_management/flood_speckle.png" alt="Speckle Filter" width="100%" />
<p class="caption">
Speckle Filter
</p>
</div>
<div class="sourceCode" id="cb66"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="co">/**** Start of imports. If edited, may not auto-convert in the playground. ****/</span></span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> roi <span class="op">=</span> </span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">/* color: #d63000 */</span></span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">/* displayProperties: [</span></span>
<span id="cb66-5"><a href="#cb66-5" aria-hidden="true" tabindex="-1"></a><span class="co">      {</span></span>
<span id="cb66-6"><a href="#cb66-6" aria-hidden="true" tabindex="-1"></a><span class="co">        &quot;type&quot;: &quot;rectangle&quot;</span></span>
<span id="cb66-7"><a href="#cb66-7" aria-hidden="true" tabindex="-1"></a><span class="co">      }</span></span>
<span id="cb66-8"><a href="#cb66-8" aria-hidden="true" tabindex="-1"></a><span class="co">    ] */</span></span>
<span id="cb66-9"><a href="#cb66-9" aria-hidden="true" tabindex="-1"></a>    ee<span class="op">.</span><span class="at">Geometry</span><span class="op">.</span><span class="fu">Polygon</span>(</span>
<span id="cb66-10"><a href="#cb66-10" aria-hidden="true" tabindex="-1"></a>        [[[<span class="fl">76.34799403033244</span><span class="op">,</span> <span class="fl">10.196640319195554</span>]<span class="op">,</span></span>
<span id="cb66-11"><a href="#cb66-11" aria-hidden="true" tabindex="-1"></a>          [<span class="fl">76.34799403033244</span><span class="op">,</span> <span class="fl">10.112323064791251</span>]<span class="op">,</span></span>
<span id="cb66-12"><a href="#cb66-12" aria-hidden="true" tabindex="-1"></a>          [<span class="fl">76.43124979815471</span><span class="op">,</span> <span class="fl">10.112323064791251</span>]<span class="op">,</span></span>
<span id="cb66-13"><a href="#cb66-13" aria-hidden="true" tabindex="-1"></a>          [<span class="fl">76.43124979815471</span><span class="op">,</span> <span class="fl">10.196640319195554</span>]]]<span class="op">,</span> <span class="kw">null</span><span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span></span>
<span id="cb66-14"><a href="#cb66-14" aria-hidden="true" tabindex="-1"></a><span class="co">/***** End of imports. If edited, may not auto-convert in the playground. *****/</span></span>
<span id="cb66-15"><a href="#cb66-15" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> gsw <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(<span class="st">&quot;JRC/GSW1_2/GlobalSurfaceWater&quot;</span>)<span class="op">,</span></span>
<span id="cb66-16"><a href="#cb66-16" aria-hidden="true" tabindex="-1"></a>    admin2 <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">&quot;FAO/GAUL_SIMPLIFIED_500m/2015/level2&quot;</span>)<span class="op">,</span></span>
<span id="cb66-17"><a href="#cb66-17" aria-hidden="true" tabindex="-1"></a>    hydrosheds <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(<span class="st">&quot;WWF/HydroSHEDS/03VFDEM&quot;</span>)<span class="op">;</span></span>
<span id="cb66-18"><a href="#cb66-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb66-19"><a href="#cb66-19" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> beforeStart <span class="op">=</span> <span class="st">&#39;2018-07-15&#39;</span></span>
<span id="cb66-20"><a href="#cb66-20" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> beforeEnd <span class="op">=</span> <span class="st">&#39;2018-08-10&#39;</span></span>
<span id="cb66-21"><a href="#cb66-21" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> afterStart <span class="op">=</span> <span class="st">&#39;2018-08-10&#39;</span></span>
<span id="cb66-22"><a href="#cb66-22" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> afterEnd <span class="op">=</span> <span class="st">&#39;2018-08-23&#39;</span></span>
<span id="cb66-23"><a href="#cb66-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-24"><a href="#cb66-24" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> ernakulam <span class="op">=</span> admin2<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;ADM2_NAME&#39;</span><span class="op">,</span> <span class="st">&#39;Ernakulam&#39;</span>))</span>
<span id="cb66-25"><a href="#cb66-25" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> geometry <span class="op">=</span> ernakulam<span class="op">.</span><span class="fu">geometry</span>()</span>
<span id="cb66-26"><a href="#cb66-26" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(geometry<span class="op">,</span> {<span class="dt">color</span><span class="op">:</span> <span class="st">&#39;grey&#39;</span>}<span class="op">,</span> <span class="st">&#39;Ernakulam District&#39;</span>)</span>
<span id="cb66-27"><a href="#cb66-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-28"><a href="#cb66-28" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> collection<span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&#39;COPERNICUS/S1_GRD&#39;</span>)</span>
<span id="cb66-29"><a href="#cb66-29" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;instrumentMode&#39;</span><span class="op">,</span><span class="st">&#39;IW&#39;</span>))</span>
<span id="cb66-30"><a href="#cb66-30" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">listContains</span>(<span class="st">&#39;transmitterReceiverPolarisation&#39;</span><span class="op">,</span> <span class="st">&#39;VH&#39;</span>))</span>
<span id="cb66-31"><a href="#cb66-31" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;orbitProperties_pass&#39;</span><span class="op">,</span> <span class="st">&#39;DESCENDING&#39;</span>)) </span>
<span id="cb66-32"><a href="#cb66-32" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;resolution_meters&#39;</span><span class="op">,</span><span class="dv">10</span>))</span>
<span id="cb66-33"><a href="#cb66-33" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">bounds</span>(geometry))</span>
<span id="cb66-34"><a href="#cb66-34" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;VH&#39;</span>)<span class="op">;</span></span>
<span id="cb66-35"><a href="#cb66-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-36"><a href="#cb66-36" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> beforeCollection <span class="op">=</span> collection</span>
<span id="cb66-37"><a href="#cb66-37" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(beforeStart<span class="op">,</span> beforeEnd))</span>
<span id="cb66-38"><a href="#cb66-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-39"><a href="#cb66-39" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> afterCollection <span class="op">=</span> collection</span>
<span id="cb66-40"><a href="#cb66-40" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(afterStart<span class="op">,</span> afterEnd))</span>
<span id="cb66-41"><a href="#cb66-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-42"><a href="#cb66-42" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> before <span class="op">=</span> beforeCollection<span class="op">.</span><span class="fu">mosaic</span>()<span class="op">.</span><span class="fu">clip</span>(geometry)<span class="op">;</span></span>
<span id="cb66-43"><a href="#cb66-43" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> after <span class="op">=</span> afterCollection<span class="op">.</span><span class="fu">mosaic</span>()<span class="op">.</span><span class="fu">clip</span>(geometry)<span class="op">;</span></span>
<span id="cb66-44"><a href="#cb66-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-45"><a href="#cb66-45" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> beforeFiltered <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(<span class="fu">toDB</span>(<span class="fu">RefinedLee</span>(<span class="fu">toNatural</span>(before))))</span>
<span id="cb66-46"><a href="#cb66-46" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> afterFiltered <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(<span class="fu">toDB</span>(<span class="fu">RefinedLee</span>(<span class="fu">toNatural</span>(after))))</span>
<span id="cb66-47"><a href="#cb66-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-48"><a href="#cb66-48" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">centerObject</span>(geometry<span class="op">,</span> <span class="dv">10</span>)</span>
<span id="cb66-49"><a href="#cb66-49" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(before<span class="op">,</span> {<span class="dt">min</span><span class="op">:-</span><span class="dv">25</span><span class="op">,</span><span class="dt">max</span><span class="op">:</span><span class="dv">0</span>}<span class="op">,</span> <span class="st">&#39;Before Floods&#39;</span><span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span></span>
<span id="cb66-50"><a href="#cb66-50" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(after<span class="op">,</span> {<span class="dt">min</span><span class="op">:-</span><span class="dv">25</span><span class="op">,</span><span class="dt">max</span><span class="op">:</span><span class="dv">0</span>}<span class="op">,</span> <span class="st">&#39;After Floods&#39;</span><span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span> </span>
<span id="cb66-51"><a href="#cb66-51" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(beforeFiltered<span class="op">,</span> {<span class="dt">min</span><span class="op">:-</span><span class="dv">25</span><span class="op">,</span><span class="dt">max</span><span class="op">:</span><span class="dv">0</span>}<span class="op">,</span> <span class="st">&#39;Before Filtered&#39;</span><span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span></span>
<span id="cb66-52"><a href="#cb66-52" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(afterFiltered<span class="op">,</span> {<span class="dt">min</span><span class="op">:-</span><span class="dv">25</span><span class="op">,</span><span class="dt">max</span><span class="op">:</span><span class="dv">0</span>}<span class="op">,</span> <span class="st">&#39;After Filtered&#39;</span><span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span> </span>
<span id="cb66-53"><a href="#cb66-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-54"><a href="#cb66-54" aria-hidden="true" tabindex="-1"></a><span class="co">//############################</span></span>
<span id="cb66-55"><a href="#cb66-55" aria-hidden="true" tabindex="-1"></a><span class="co">// Speckle Filtering Functions</span></span>
<span id="cb66-56"><a href="#cb66-56" aria-hidden="true" tabindex="-1"></a><span class="co">//############################</span></span>
<span id="cb66-57"><a href="#cb66-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-58"><a href="#cb66-58" aria-hidden="true" tabindex="-1"></a><span class="co">// Function to convert from dB</span></span>
<span id="cb66-59"><a href="#cb66-59" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">toNatural</span>(img) {</span>
<span id="cb66-60"><a href="#cb66-60" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> ee<span class="op">.</span><span class="fu">Image</span>(<span class="fl">10.0</span>)<span class="op">.</span><span class="fu">pow</span>(img<span class="op">.</span><span class="fu">select</span>(<span class="dv">0</span>)<span class="op">.</span><span class="fu">divide</span>(<span class="fl">10.0</span>))<span class="op">;</span></span>
<span id="cb66-61"><a href="#cb66-61" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb66-62"><a href="#cb66-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-63"><a href="#cb66-63" aria-hidden="true" tabindex="-1"></a><span class="co">//Function to convert to dB</span></span>
<span id="cb66-64"><a href="#cb66-64" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">toDB</span>(img) {</span>
<span id="cb66-65"><a href="#cb66-65" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> ee<span class="op">.</span><span class="fu">Image</span>(img)<span class="op">.</span><span class="fu">log10</span>()<span class="op">.</span><span class="fu">multiply</span>(<span class="fl">10.0</span>)<span class="op">;</span></span>
<span id="cb66-66"><a href="#cb66-66" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb66-67"><a href="#cb66-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-68"><a href="#cb66-68" aria-hidden="true" tabindex="-1"></a><span class="co">//Apllying a Refined Lee Speckle filter as coded in the SNAP 3.0 S1TBX:</span></span>
<span id="cb66-69"><a href="#cb66-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-70"><a href="#cb66-70" aria-hidden="true" tabindex="-1"></a><span class="co">//https://github.com/senbox-org/s1tbx/blob/master/s1tbx-op-sar-processing/src/main/java/org/esa/s1tbx/sar/gpf/filtering/SpeckleFilters/RefinedLee.java</span></span>
<span id="cb66-71"><a href="#cb66-71" aria-hidden="true" tabindex="-1"></a><span class="co">//Adapted by Guido Lemoine</span></span>
<span id="cb66-72"><a href="#cb66-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-73"><a href="#cb66-73" aria-hidden="true" tabindex="-1"></a><span class="co">// by Guido Lemoine</span></span>
<span id="cb66-74"><a href="#cb66-74" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">RefinedLee</span>(img) {</span>
<span id="cb66-75"><a href="#cb66-75" aria-hidden="true" tabindex="-1"></a>  <span class="co">// img must be in natural units, i.e. not in dB!</span></span>
<span id="cb66-76"><a href="#cb66-76" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Set up 3x3 kernels </span></span>
<span id="cb66-77"><a href="#cb66-77" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> weights3 <span class="op">=</span> ee<span class="op">.</span><span class="at">List</span><span class="op">.</span><span class="fu">repeat</span>(ee<span class="op">.</span><span class="at">List</span><span class="op">.</span><span class="fu">repeat</span>(<span class="dv">1</span><span class="op">,</span><span class="dv">3</span>)<span class="op">,</span><span class="dv">3</span>)<span class="op">;</span></span>
<span id="cb66-78"><a href="#cb66-78" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> kernel3 <span class="op">=</span> ee<span class="op">.</span><span class="at">Kernel</span><span class="op">.</span><span class="fu">fixed</span>(<span class="dv">3</span><span class="op">,</span><span class="dv">3</span><span class="op">,</span> weights3<span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span></span>
<span id="cb66-79"><a href="#cb66-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-80"><a href="#cb66-80" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> mean3 <span class="op">=</span> img<span class="op">.</span><span class="fu">reduceNeighborhood</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">mean</span>()<span class="op">,</span> kernel3)<span class="op">;</span></span>
<span id="cb66-81"><a href="#cb66-81" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> variance3 <span class="op">=</span> img<span class="op">.</span><span class="fu">reduceNeighborhood</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">variance</span>()<span class="op">,</span> kernel3)<span class="op">;</span></span>
<span id="cb66-82"><a href="#cb66-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-83"><a href="#cb66-83" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Use a sample of the 3x3 windows inside a 7x7 windows to determine gradients and directions</span></span>
<span id="cb66-84"><a href="#cb66-84" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> sample_weights <span class="op">=</span> ee<span class="op">.</span><span class="fu">List</span>([[<span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span>]<span class="op">,</span> [<span class="dv">0</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span>]<span class="op">,</span>[<span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span>]<span class="op">,</span> [<span class="dv">0</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span>]<span class="op">,</span> [<span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span>]<span class="op">,</span> [<span class="dv">0</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span>]<span class="op">,</span>[<span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span>]])<span class="op">;</span></span>
<span id="cb66-85"><a href="#cb66-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-86"><a href="#cb66-86" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> sample_kernel <span class="op">=</span> ee<span class="op">.</span><span class="at">Kernel</span><span class="op">.</span><span class="fu">fixed</span>(<span class="dv">7</span><span class="op">,</span><span class="dv">7</span><span class="op">,</span> sample_weights<span class="op">,</span> <span class="dv">3</span><span class="op">,</span><span class="dv">3</span><span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span></span>
<span id="cb66-87"><a href="#cb66-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-88"><a href="#cb66-88" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Calculate mean and variance for the sampled windows and store as 9 bands</span></span>
<span id="cb66-89"><a href="#cb66-89" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> sample_mean <span class="op">=</span> mean3<span class="op">.</span><span class="fu">neighborhoodToBands</span>(sample_kernel)<span class="op">;</span> </span>
<span id="cb66-90"><a href="#cb66-90" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> sample_var <span class="op">=</span> variance3<span class="op">.</span><span class="fu">neighborhoodToBands</span>(sample_kernel)<span class="op">;</span></span>
<span id="cb66-91"><a href="#cb66-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-92"><a href="#cb66-92" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Determine the 4 gradients for the sampled windows</span></span>
<span id="cb66-93"><a href="#cb66-93" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> gradients <span class="op">=</span> sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">1</span>)<span class="op">.</span><span class="fu">subtract</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">7</span>))<span class="op">.</span><span class="fu">abs</span>()<span class="op">;</span></span>
<span id="cb66-94"><a href="#cb66-94" aria-hidden="true" tabindex="-1"></a>  gradients <span class="op">=</span> gradients<span class="op">.</span><span class="fu">addBands</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">6</span>)<span class="op">.</span><span class="fu">subtract</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">2</span>))<span class="op">.</span><span class="fu">abs</span>())<span class="op">;</span></span>
<span id="cb66-95"><a href="#cb66-95" aria-hidden="true" tabindex="-1"></a>  gradients <span class="op">=</span> gradients<span class="op">.</span><span class="fu">addBands</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">3</span>)<span class="op">.</span><span class="fu">subtract</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">5</span>))<span class="op">.</span><span class="fu">abs</span>())<span class="op">;</span></span>
<span id="cb66-96"><a href="#cb66-96" aria-hidden="true" tabindex="-1"></a>  gradients <span class="op">=</span> gradients<span class="op">.</span><span class="fu">addBands</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">0</span>)<span class="op">.</span><span class="fu">subtract</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">8</span>))<span class="op">.</span><span class="fu">abs</span>())<span class="op">;</span></span>
<span id="cb66-97"><a href="#cb66-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-98"><a href="#cb66-98" aria-hidden="true" tabindex="-1"></a>  <span class="co">// And find the maximum gradient amongst gradient bands</span></span>
<span id="cb66-99"><a href="#cb66-99" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> max_gradient <span class="op">=</span> gradients<span class="op">.</span><span class="fu">reduce</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">max</span>())<span class="op">;</span></span>
<span id="cb66-100"><a href="#cb66-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-101"><a href="#cb66-101" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Create a mask for band pixels that are the maximum gradient</span></span>
<span id="cb66-102"><a href="#cb66-102" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> gradmask <span class="op">=</span> gradients<span class="op">.</span><span class="fu">eq</span>(max_gradient)<span class="op">;</span></span>
<span id="cb66-103"><a href="#cb66-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-104"><a href="#cb66-104" aria-hidden="true" tabindex="-1"></a>  <span class="co">// duplicate gradmask bands: each gradient represents 2 directions</span></span>
<span id="cb66-105"><a href="#cb66-105" aria-hidden="true" tabindex="-1"></a>  gradmask <span class="op">=</span> gradmask<span class="op">.</span><span class="fu">addBands</span>(gradmask)<span class="op">;</span></span>
<span id="cb66-106"><a href="#cb66-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-107"><a href="#cb66-107" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Determine the 8 directions</span></span>
<span id="cb66-108"><a href="#cb66-108" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> directions <span class="op">=</span> sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">1</span>)<span class="op">.</span><span class="fu">subtract</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">4</span>))<span class="op">.</span><span class="fu">gt</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">4</span>)<span class="op">.</span><span class="fu">subtract</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">7</span>)))<span class="op">.</span><span class="fu">multiply</span>(<span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb66-109"><a href="#cb66-109" aria-hidden="true" tabindex="-1"></a>  directions <span class="op">=</span> directions<span class="op">.</span><span class="fu">addBands</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">6</span>)<span class="op">.</span><span class="fu">subtract</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">4</span>))<span class="op">.</span><span class="fu">gt</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">4</span>)<span class="op">.</span><span class="fu">subtract</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">2</span>)))<span class="op">.</span><span class="fu">multiply</span>(<span class="dv">2</span>))<span class="op">;</span></span>
<span id="cb66-110"><a href="#cb66-110" aria-hidden="true" tabindex="-1"></a>  directions <span class="op">=</span> directions<span class="op">.</span><span class="fu">addBands</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">3</span>)<span class="op">.</span><span class="fu">subtract</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">4</span>))<span class="op">.</span><span class="fu">gt</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">4</span>)<span class="op">.</span><span class="fu">subtract</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">5</span>)))<span class="op">.</span><span class="fu">multiply</span>(<span class="dv">3</span>))<span class="op">;</span></span>
<span id="cb66-111"><a href="#cb66-111" aria-hidden="true" tabindex="-1"></a>  directions <span class="op">=</span> directions<span class="op">.</span><span class="fu">addBands</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">0</span>)<span class="op">.</span><span class="fu">subtract</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">4</span>))<span class="op">.</span><span class="fu">gt</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">4</span>)<span class="op">.</span><span class="fu">subtract</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">8</span>)))<span class="op">.</span><span class="fu">multiply</span>(<span class="dv">4</span>))<span class="op">;</span></span>
<span id="cb66-112"><a href="#cb66-112" aria-hidden="true" tabindex="-1"></a>  <span class="co">// The next 4 are the not() of the previous 4</span></span>
<span id="cb66-113"><a href="#cb66-113" aria-hidden="true" tabindex="-1"></a>  directions <span class="op">=</span> directions<span class="op">.</span><span class="fu">addBands</span>(directions<span class="op">.</span><span class="fu">select</span>(<span class="dv">0</span>)<span class="op">.</span><span class="fu">not</span>()<span class="op">.</span><span class="fu">multiply</span>(<span class="dv">5</span>))<span class="op">;</span></span>
<span id="cb66-114"><a href="#cb66-114" aria-hidden="true" tabindex="-1"></a>  directions <span class="op">=</span> directions<span class="op">.</span><span class="fu">addBands</span>(directions<span class="op">.</span><span class="fu">select</span>(<span class="dv">1</span>)<span class="op">.</span><span class="fu">not</span>()<span class="op">.</span><span class="fu">multiply</span>(<span class="dv">6</span>))<span class="op">;</span></span>
<span id="cb66-115"><a href="#cb66-115" aria-hidden="true" tabindex="-1"></a>  directions <span class="op">=</span> directions<span class="op">.</span><span class="fu">addBands</span>(directions<span class="op">.</span><span class="fu">select</span>(<span class="dv">2</span>)<span class="op">.</span><span class="fu">not</span>()<span class="op">.</span><span class="fu">multiply</span>(<span class="dv">7</span>))<span class="op">;</span></span>
<span id="cb66-116"><a href="#cb66-116" aria-hidden="true" tabindex="-1"></a>  directions <span class="op">=</span> directions<span class="op">.</span><span class="fu">addBands</span>(directions<span class="op">.</span><span class="fu">select</span>(<span class="dv">3</span>)<span class="op">.</span><span class="fu">not</span>()<span class="op">.</span><span class="fu">multiply</span>(<span class="dv">8</span>))<span class="op">;</span></span>
<span id="cb66-117"><a href="#cb66-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-118"><a href="#cb66-118" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Mask all values that are not 1-8</span></span>
<span id="cb66-119"><a href="#cb66-119" aria-hidden="true" tabindex="-1"></a>  directions <span class="op">=</span> directions<span class="op">.</span><span class="fu">updateMask</span>(gradmask)<span class="op">;</span></span>
<span id="cb66-120"><a href="#cb66-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-121"><a href="#cb66-121" aria-hidden="true" tabindex="-1"></a>  <span class="co">// &quot;collapse&quot; the stack into a singe band image (due to masking, each pixel has just one value (1-8) in it&#39;s directional band, and is otherwise masked)</span></span>
<span id="cb66-122"><a href="#cb66-122" aria-hidden="true" tabindex="-1"></a>  directions <span class="op">=</span> directions<span class="op">.</span><span class="fu">reduce</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">sum</span>())<span class="op">;</span>  </span>
<span id="cb66-123"><a href="#cb66-123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-124"><a href="#cb66-124" aria-hidden="true" tabindex="-1"></a>  <span class="co">//var pal = [&#39;ffffff&#39;,&#39;ff0000&#39;,&#39;ffff00&#39;, &#39;00ff00&#39;, &#39;00ffff&#39;, &#39;0000ff&#39;, &#39;ff00ff&#39;, &#39;000000&#39;];</span></span>
<span id="cb66-125"><a href="#cb66-125" aria-hidden="true" tabindex="-1"></a>  <span class="co">//Map.addLayer(directions.reduce(ee.Reducer.sum()), {min:1, max:8, palette: pal}, &#39;Directions&#39;, false);</span></span>
<span id="cb66-126"><a href="#cb66-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-127"><a href="#cb66-127" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> sample_stats <span class="op">=</span> sample_var<span class="op">.</span><span class="fu">divide</span>(sample_mean<span class="op">.</span><span class="fu">multiply</span>(sample_mean))<span class="op">;</span></span>
<span id="cb66-128"><a href="#cb66-128" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-129"><a href="#cb66-129" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Calculate localNoiseVariance</span></span>
<span id="cb66-130"><a href="#cb66-130" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> sigmaV <span class="op">=</span> sample_stats<span class="op">.</span><span class="fu">toArray</span>()<span class="op">.</span><span class="fu">arraySort</span>()<span class="op">.</span><span class="fu">arraySlice</span>(<span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">5</span>)<span class="op">.</span><span class="fu">arrayReduce</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">mean</span>()<span class="op">,</span> [<span class="dv">0</span>])<span class="op">;</span></span>
<span id="cb66-131"><a href="#cb66-131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-132"><a href="#cb66-132" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Set up the 7*7 kernels for directional statistics</span></span>
<span id="cb66-133"><a href="#cb66-133" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> rect_weights <span class="op">=</span> ee<span class="op">.</span><span class="at">List</span><span class="op">.</span><span class="fu">repeat</span>(ee<span class="op">.</span><span class="at">List</span><span class="op">.</span><span class="fu">repeat</span>(<span class="dv">0</span><span class="op">,</span><span class="dv">7</span>)<span class="op">,</span><span class="dv">3</span>)<span class="op">.</span><span class="fu">cat</span>(ee<span class="op">.</span><span class="at">List</span><span class="op">.</span><span class="fu">repeat</span>(ee<span class="op">.</span><span class="at">List</span><span class="op">.</span><span class="fu">repeat</span>(<span class="dv">1</span><span class="op">,</span><span class="dv">7</span>)<span class="op">,</span><span class="dv">4</span>))<span class="op">;</span></span>
<span id="cb66-134"><a href="#cb66-134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-135"><a href="#cb66-135" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> diag_weights <span class="op">=</span> ee<span class="op">.</span><span class="fu">List</span>([[<span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span>]<span class="op">,</span> [<span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span>]<span class="op">,</span> [<span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span>]<span class="op">,</span> </span>
<span id="cb66-136"><a href="#cb66-136" aria-hidden="true" tabindex="-1"></a>    [<span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span>]<span class="op">,</span> [<span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span>]<span class="op">,</span> [<span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span>]<span class="op">,</span> [<span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span>]])<span class="op">;</span></span>
<span id="cb66-137"><a href="#cb66-137" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-138"><a href="#cb66-138" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> rect_kernel <span class="op">=</span> ee<span class="op">.</span><span class="at">Kernel</span><span class="op">.</span><span class="fu">fixed</span>(<span class="dv">7</span><span class="op">,</span><span class="dv">7</span><span class="op">,</span> rect_weights<span class="op">,</span> <span class="dv">3</span><span class="op">,</span> <span class="dv">3</span><span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span></span>
<span id="cb66-139"><a href="#cb66-139" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> diag_kernel <span class="op">=</span> ee<span class="op">.</span><span class="at">Kernel</span><span class="op">.</span><span class="fu">fixed</span>(<span class="dv">7</span><span class="op">,</span><span class="dv">7</span><span class="op">,</span> diag_weights<span class="op">,</span> <span class="dv">3</span><span class="op">,</span> <span class="dv">3</span><span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span></span>
<span id="cb66-140"><a href="#cb66-140" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-141"><a href="#cb66-141" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Create stacks for mean and variance using the original kernels. Mask with relevant direction.</span></span>
<span id="cb66-142"><a href="#cb66-142" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> dir_mean <span class="op">=</span> img<span class="op">.</span><span class="fu">reduceNeighborhood</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">mean</span>()<span class="op">,</span> rect_kernel)<span class="op">.</span><span class="fu">updateMask</span>(directions<span class="op">.</span><span class="fu">eq</span>(<span class="dv">1</span>))<span class="op">;</span></span>
<span id="cb66-143"><a href="#cb66-143" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> dir_var <span class="op">=</span> img<span class="op">.</span><span class="fu">reduceNeighborhood</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">variance</span>()<span class="op">,</span> rect_kernel)<span class="op">.</span><span class="fu">updateMask</span>(directions<span class="op">.</span><span class="fu">eq</span>(<span class="dv">1</span>))<span class="op">;</span></span>
<span id="cb66-144"><a href="#cb66-144" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-145"><a href="#cb66-145" aria-hidden="true" tabindex="-1"></a>  dir_mean <span class="op">=</span> dir_mean<span class="op">.</span><span class="fu">addBands</span>(img<span class="op">.</span><span class="fu">reduceNeighborhood</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">mean</span>()<span class="op">,</span> diag_kernel)<span class="op">.</span><span class="fu">updateMask</span>(directions<span class="op">.</span><span class="fu">eq</span>(<span class="dv">2</span>)))<span class="op">;</span></span>
<span id="cb66-146"><a href="#cb66-146" aria-hidden="true" tabindex="-1"></a>  dir_var <span class="op">=</span> dir_var<span class="op">.</span><span class="fu">addBands</span>(img<span class="op">.</span><span class="fu">reduceNeighborhood</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">variance</span>()<span class="op">,</span> diag_kernel)<span class="op">.</span><span class="fu">updateMask</span>(directions<span class="op">.</span><span class="fu">eq</span>(<span class="dv">2</span>)))<span class="op">;</span></span>
<span id="cb66-147"><a href="#cb66-147" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-148"><a href="#cb66-148" aria-hidden="true" tabindex="-1"></a>  <span class="co">// and add the bands for rotated kernels</span></span>
<span id="cb66-149"><a href="#cb66-149" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (<span class="kw">var</span> i<span class="op">=</span><span class="dv">1</span><span class="op">;</span> i<span class="op">&lt;</span><span class="dv">4</span><span class="op">;</span> i<span class="op">++</span>) {</span>
<span id="cb66-150"><a href="#cb66-150" aria-hidden="true" tabindex="-1"></a>    dir_mean <span class="op">=</span> dir_mean<span class="op">.</span><span class="fu">addBands</span>(img<span class="op">.</span><span class="fu">reduceNeighborhood</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">mean</span>()<span class="op">,</span> rect_kernel<span class="op">.</span><span class="fu">rotate</span>(i))<span class="op">.</span><span class="fu">updateMask</span>(directions<span class="op">.</span><span class="fu">eq</span>(<span class="dv">2</span><span class="op">*</span>i<span class="op">+</span><span class="dv">1</span>)))<span class="op">;</span></span>
<span id="cb66-151"><a href="#cb66-151" aria-hidden="true" tabindex="-1"></a>    dir_var <span class="op">=</span> dir_var<span class="op">.</span><span class="fu">addBands</span>(img<span class="op">.</span><span class="fu">reduceNeighborhood</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">variance</span>()<span class="op">,</span> rect_kernel<span class="op">.</span><span class="fu">rotate</span>(i))<span class="op">.</span><span class="fu">updateMask</span>(directions<span class="op">.</span><span class="fu">eq</span>(<span class="dv">2</span><span class="op">*</span>i<span class="op">+</span><span class="dv">1</span>)))<span class="op">;</span></span>
<span id="cb66-152"><a href="#cb66-152" aria-hidden="true" tabindex="-1"></a>    dir_mean <span class="op">=</span> dir_mean<span class="op">.</span><span class="fu">addBands</span>(img<span class="op">.</span><span class="fu">reduceNeighborhood</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">mean</span>()<span class="op">,</span> diag_kernel<span class="op">.</span><span class="fu">rotate</span>(i))<span class="op">.</span><span class="fu">updateMask</span>(directions<span class="op">.</span><span class="fu">eq</span>(<span class="dv">2</span><span class="op">*</span>i<span class="op">+</span><span class="dv">2</span>)))<span class="op">;</span></span>
<span id="cb66-153"><a href="#cb66-153" aria-hidden="true" tabindex="-1"></a>    dir_var <span class="op">=</span> dir_var<span class="op">.</span><span class="fu">addBands</span>(img<span class="op">.</span><span class="fu">reduceNeighborhood</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">variance</span>()<span class="op">,</span> diag_kernel<span class="op">.</span><span class="fu">rotate</span>(i))<span class="op">.</span><span class="fu">updateMask</span>(directions<span class="op">.</span><span class="fu">eq</span>(<span class="dv">2</span><span class="op">*</span>i<span class="op">+</span><span class="dv">2</span>)))<span class="op">;</span></span>
<span id="cb66-154"><a href="#cb66-154" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb66-155"><a href="#cb66-155" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-156"><a href="#cb66-156" aria-hidden="true" tabindex="-1"></a>  <span class="co">// &quot;collapse&quot; the stack into a single band image (due to masking, each pixel has just one value in it&#39;s directional band, and is otherwise masked)</span></span>
<span id="cb66-157"><a href="#cb66-157" aria-hidden="true" tabindex="-1"></a>  dir_mean <span class="op">=</span> dir_mean<span class="op">.</span><span class="fu">reduce</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">sum</span>())<span class="op">;</span></span>
<span id="cb66-158"><a href="#cb66-158" aria-hidden="true" tabindex="-1"></a>  dir_var <span class="op">=</span> dir_var<span class="op">.</span><span class="fu">reduce</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">sum</span>())<span class="op">;</span></span>
<span id="cb66-159"><a href="#cb66-159" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-160"><a href="#cb66-160" aria-hidden="true" tabindex="-1"></a>  <span class="co">// A finally generate the filtered value</span></span>
<span id="cb66-161"><a href="#cb66-161" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> varX <span class="op">=</span> dir_var<span class="op">.</span><span class="fu">subtract</span>(dir_mean<span class="op">.</span><span class="fu">multiply</span>(dir_mean)<span class="op">.</span><span class="fu">multiply</span>(sigmaV))<span class="op">.</span><span class="fu">divide</span>(sigmaV<span class="op">.</span><span class="fu">add</span>(<span class="fl">1.0</span>))<span class="op">;</span></span>
<span id="cb66-162"><a href="#cb66-162" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-163"><a href="#cb66-163" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> b <span class="op">=</span> varX<span class="op">.</span><span class="fu">divide</span>(dir_var)<span class="op">;</span></span>
<span id="cb66-164"><a href="#cb66-164" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-165"><a href="#cb66-165" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> result <span class="op">=</span> dir_mean<span class="op">.</span><span class="fu">add</span>(b<span class="op">.</span><span class="fu">multiply</span>(img<span class="op">.</span><span class="fu">subtract</span>(dir_mean)))<span class="op">;</span></span>
<span id="cb66-166"><a href="#cb66-166" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span>(result<span class="op">.</span><span class="fu">arrayFlatten</span>([[<span class="st">&#39;sum&#39;</span>]]))<span class="op">;</span></span>
<span id="cb66-167"><a href="#cb66-167" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p><a href="https://code.earthengine.google.com/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3A05-Flood_Mapping%2F03b_Apply_Speckle_Filter_(complete)" target="_blank">Open in Code Editor ↗</a></p>
</div>
<div id="apply-a-threshold" class="section level2">
<h2>04. Apply a Threshold</h2>
<p>A <em>difference</em> image can be created by dividing the <em>after image</em> by the <em>before image</em>. Then by considering a 25% change, we can select all the pixel values greater than 1.25. This 1.25 threshold is arbitrary, and it can be updated by trial and error for any region. In general, considering a 25% change as the initial assumption is common.</p>
<p>This threshold can be applied using the boolean function <code>gt()</code>. The resultant will be a binary image where a pixel value with <em>1</em> represents the flooded region.</p>
<div class="figure" style="text-align: center">
<img src="images/gee_water_resources_management/flood_initialArea.png" alt="Flooded Area" width="75%" />
<p class="caption">
Flooded Area
</p>
</div>
<div class="sourceCode" id="cb67"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> gsw <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(<span class="st">&quot;JRC/GSW1_2/GlobalSurfaceWater&quot;</span>)<span class="op">,</span></span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a>    admin2 <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">&quot;FAO/GAUL_SIMPLIFIED_500m/2015/level2&quot;</span>)<span class="op">,</span></span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a>    hydrosheds <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(<span class="st">&quot;WWF/HydroSHEDS/03VFDEM&quot;</span>)<span class="op">;</span></span>
<span id="cb67-4"><a href="#cb67-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-5"><a href="#cb67-5" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> beforeStart <span class="op">=</span> <span class="st">&#39;2018-07-15&#39;</span></span>
<span id="cb67-6"><a href="#cb67-6" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> beforeEnd <span class="op">=</span> <span class="st">&#39;2018-08-10&#39;</span></span>
<span id="cb67-7"><a href="#cb67-7" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> afterStart <span class="op">=</span> <span class="st">&#39;2018-08-10&#39;</span></span>
<span id="cb67-8"><a href="#cb67-8" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> afterEnd <span class="op">=</span> <span class="st">&#39;2018-08-23&#39;</span></span>
<span id="cb67-9"><a href="#cb67-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-10"><a href="#cb67-10" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> ernakulam <span class="op">=</span> admin2<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;ADM2_NAME&#39;</span><span class="op">,</span> <span class="st">&#39;Ernakulam&#39;</span>))</span>
<span id="cb67-11"><a href="#cb67-11" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> geometry <span class="op">=</span> ernakulam<span class="op">.</span><span class="fu">geometry</span>()</span>
<span id="cb67-12"><a href="#cb67-12" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(geometry<span class="op">,</span> {<span class="dt">color</span><span class="op">:</span> <span class="st">&#39;grey&#39;</span>}<span class="op">,</span> <span class="st">&#39;Ernakulam District&#39;</span>)</span>
<span id="cb67-13"><a href="#cb67-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-14"><a href="#cb67-14" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> collection<span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&#39;COPERNICUS/S1_GRD&#39;</span>)</span>
<span id="cb67-15"><a href="#cb67-15" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;instrumentMode&#39;</span><span class="op">,</span><span class="st">&#39;IW&#39;</span>))</span>
<span id="cb67-16"><a href="#cb67-16" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">listContains</span>(<span class="st">&#39;transmitterReceiverPolarisation&#39;</span><span class="op">,</span> <span class="st">&#39;VH&#39;</span>))</span>
<span id="cb67-17"><a href="#cb67-17" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;orbitProperties_pass&#39;</span><span class="op">,</span> <span class="st">&#39;DESCENDING&#39;</span>)) </span>
<span id="cb67-18"><a href="#cb67-18" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;resolution_meters&#39;</span><span class="op">,</span><span class="dv">10</span>))</span>
<span id="cb67-19"><a href="#cb67-19" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">bounds</span>(geometry))</span>
<span id="cb67-20"><a href="#cb67-20" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;VH&#39;</span>)<span class="op">;</span></span>
<span id="cb67-21"><a href="#cb67-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-22"><a href="#cb67-22" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> beforeCollection <span class="op">=</span> collection</span>
<span id="cb67-23"><a href="#cb67-23" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(beforeStart<span class="op">,</span> beforeEnd))</span>
<span id="cb67-24"><a href="#cb67-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-25"><a href="#cb67-25" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> afterCollection <span class="op">=</span> collection</span>
<span id="cb67-26"><a href="#cb67-26" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(afterStart<span class="op">,</span> afterEnd))</span>
<span id="cb67-27"><a href="#cb67-27" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb67-28"><a href="#cb67-28" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> before <span class="op">=</span> beforeCollection<span class="op">.</span><span class="fu">mosaic</span>()<span class="op">.</span><span class="fu">clip</span>(geometry)<span class="op">;</span></span>
<span id="cb67-29"><a href="#cb67-29" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> after <span class="op">=</span> afterCollection<span class="op">.</span><span class="fu">mosaic</span>()<span class="op">.</span><span class="fu">clip</span>(geometry)<span class="op">;</span></span>
<span id="cb67-30"><a href="#cb67-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-31"><a href="#cb67-31" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> beforeFiltered <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(<span class="fu">toDB</span>(<span class="fu">RefinedLee</span>(<span class="fu">toNatural</span>(before))))</span>
<span id="cb67-32"><a href="#cb67-32" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> afterFiltered <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(<span class="fu">toDB</span>(<span class="fu">RefinedLee</span>(<span class="fu">toNatural</span>(after))))</span>
<span id="cb67-33"><a href="#cb67-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-34"><a href="#cb67-34" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">centerObject</span>(geometry<span class="op">,</span> <span class="dv">10</span>)</span>
<span id="cb67-35"><a href="#cb67-35" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(before<span class="op">,</span> {<span class="dt">min</span><span class="op">:-</span><span class="dv">25</span><span class="op">,</span><span class="dt">max</span><span class="op">:</span><span class="dv">0</span>}<span class="op">,</span> <span class="st">&#39;Before Floods&#39;</span><span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span></span>
<span id="cb67-36"><a href="#cb67-36" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(after<span class="op">,</span> {<span class="dt">min</span><span class="op">:-</span><span class="dv">25</span><span class="op">,</span><span class="dt">max</span><span class="op">:</span><span class="dv">0</span>}<span class="op">,</span> <span class="st">&#39;After Floods&#39;</span><span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span> </span>
<span id="cb67-37"><a href="#cb67-37" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(beforeFiltered<span class="op">,</span> {<span class="dt">min</span><span class="op">:-</span><span class="dv">25</span><span class="op">,</span><span class="dt">max</span><span class="op">:</span><span class="dv">0</span>}<span class="op">,</span> <span class="st">&#39;Before Filtered&#39;</span><span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span></span>
<span id="cb67-38"><a href="#cb67-38" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(afterFiltered<span class="op">,</span> {<span class="dt">min</span><span class="op">:-</span><span class="dv">25</span><span class="op">,</span><span class="dt">max</span><span class="op">:</span><span class="dv">0</span>}<span class="op">,</span> <span class="st">&#39;After Filtered&#39;</span><span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span> </span>
<span id="cb67-39"><a href="#cb67-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-40"><a href="#cb67-40" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> difference <span class="op">=</span> afterFiltered<span class="op">.</span><span class="fu">divide</span>(beforeFiltered)<span class="op">;</span></span>
<span id="cb67-41"><a href="#cb67-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-42"><a href="#cb67-42" aria-hidden="true" tabindex="-1"></a><span class="co">// Define a threshold</span></span>
<span id="cb67-43"><a href="#cb67-43" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> diffThreshold <span class="op">=</span> <span class="fl">1.25</span><span class="op">;</span></span>
<span id="cb67-44"><a href="#cb67-44" aria-hidden="true" tabindex="-1"></a><span class="co">// Initial estimate of flooded pixels</span></span>
<span id="cb67-45"><a href="#cb67-45" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> flooded <span class="op">=</span> difference<span class="op">.</span><span class="fu">gt</span>(diffThreshold)<span class="op">.</span><span class="fu">rename</span>(<span class="st">&#39;water&#39;</span>)<span class="op">.</span><span class="fu">selfMask</span>()<span class="op">;</span></span>
<span id="cb67-46"><a href="#cb67-46" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(flooded<span class="op">,</span> {<span class="dt">min</span><span class="op">:</span><span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span><span class="dv">1</span><span class="op">,</span> <span class="dt">palette</span><span class="op">:</span> [<span class="st">&#39;orange&#39;</span>]}<span class="op">,</span> <span class="st">&#39;Initial Flood Area&#39;</span><span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span></span>
<span id="cb67-47"><a href="#cb67-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-48"><a href="#cb67-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-49"><a href="#cb67-49" aria-hidden="true" tabindex="-1"></a><span class="co">//############################</span></span>
<span id="cb67-50"><a href="#cb67-50" aria-hidden="true" tabindex="-1"></a><span class="co">// Speckle Filtering Functions</span></span>
<span id="cb67-51"><a href="#cb67-51" aria-hidden="true" tabindex="-1"></a><span class="co">//############################</span></span>
<span id="cb67-52"><a href="#cb67-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-53"><a href="#cb67-53" aria-hidden="true" tabindex="-1"></a><span class="co">// Function to convert from dB</span></span>
<span id="cb67-54"><a href="#cb67-54" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">toNatural</span>(img) {</span>
<span id="cb67-55"><a href="#cb67-55" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> ee<span class="op">.</span><span class="fu">Image</span>(<span class="fl">10.0</span>)<span class="op">.</span><span class="fu">pow</span>(img<span class="op">.</span><span class="fu">select</span>(<span class="dv">0</span>)<span class="op">.</span><span class="fu">divide</span>(<span class="fl">10.0</span>))<span class="op">;</span></span>
<span id="cb67-56"><a href="#cb67-56" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb67-57"><a href="#cb67-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-58"><a href="#cb67-58" aria-hidden="true" tabindex="-1"></a><span class="co">//Function to convert to dB</span></span>
<span id="cb67-59"><a href="#cb67-59" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">toDB</span>(img) {</span>
<span id="cb67-60"><a href="#cb67-60" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> ee<span class="op">.</span><span class="fu">Image</span>(img)<span class="op">.</span><span class="fu">log10</span>()<span class="op">.</span><span class="fu">multiply</span>(<span class="fl">10.0</span>)<span class="op">;</span></span>
<span id="cb67-61"><a href="#cb67-61" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb67-62"><a href="#cb67-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-63"><a href="#cb67-63" aria-hidden="true" tabindex="-1"></a><span class="co">//Apllying a Refined Lee Speckle filter as coded in the SNAP 3.0 S1TBX:</span></span>
<span id="cb67-64"><a href="#cb67-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-65"><a href="#cb67-65" aria-hidden="true" tabindex="-1"></a><span class="co">//https://github.com/senbox-org/s1tbx/blob/master/s1tbx-op-sar-processing/src/main/java/org/esa/s1tbx/sar/gpf/filtering/SpeckleFilters/RefinedLee.java</span></span>
<span id="cb67-66"><a href="#cb67-66" aria-hidden="true" tabindex="-1"></a><span class="co">//Adapted by Guido Lemoine</span></span>
<span id="cb67-67"><a href="#cb67-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-68"><a href="#cb67-68" aria-hidden="true" tabindex="-1"></a><span class="co">// by Guido Lemoine</span></span>
<span id="cb67-69"><a href="#cb67-69" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">RefinedLee</span>(img) {</span>
<span id="cb67-70"><a href="#cb67-70" aria-hidden="true" tabindex="-1"></a>  <span class="co">// img must be in natural units, i.e. not in dB!</span></span>
<span id="cb67-71"><a href="#cb67-71" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Set up 3x3 kernels </span></span>
<span id="cb67-72"><a href="#cb67-72" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> weights3 <span class="op">=</span> ee<span class="op">.</span><span class="at">List</span><span class="op">.</span><span class="fu">repeat</span>(ee<span class="op">.</span><span class="at">List</span><span class="op">.</span><span class="fu">repeat</span>(<span class="dv">1</span><span class="op">,</span><span class="dv">3</span>)<span class="op">,</span><span class="dv">3</span>)<span class="op">;</span></span>
<span id="cb67-73"><a href="#cb67-73" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> kernel3 <span class="op">=</span> ee<span class="op">.</span><span class="at">Kernel</span><span class="op">.</span><span class="fu">fixed</span>(<span class="dv">3</span><span class="op">,</span><span class="dv">3</span><span class="op">,</span> weights3<span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span></span>
<span id="cb67-74"><a href="#cb67-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-75"><a href="#cb67-75" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> mean3 <span class="op">=</span> img<span class="op">.</span><span class="fu">reduceNeighborhood</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">mean</span>()<span class="op">,</span> kernel3)<span class="op">;</span></span>
<span id="cb67-76"><a href="#cb67-76" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> variance3 <span class="op">=</span> img<span class="op">.</span><span class="fu">reduceNeighborhood</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">variance</span>()<span class="op">,</span> kernel3)<span class="op">;</span></span>
<span id="cb67-77"><a href="#cb67-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-78"><a href="#cb67-78" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Use a sample of the 3x3 windows inside a 7x7 windows to determine gradients and directions</span></span>
<span id="cb67-79"><a href="#cb67-79" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> sample_weights <span class="op">=</span> ee<span class="op">.</span><span class="fu">List</span>([[<span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span>]<span class="op">,</span> [<span class="dv">0</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span>]<span class="op">,</span>[<span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span>]<span class="op">,</span> [<span class="dv">0</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span>]<span class="op">,</span> [<span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span>]<span class="op">,</span> [<span class="dv">0</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span>]<span class="op">,</span>[<span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span>]])<span class="op">;</span></span>
<span id="cb67-80"><a href="#cb67-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-81"><a href="#cb67-81" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> sample_kernel <span class="op">=</span> ee<span class="op">.</span><span class="at">Kernel</span><span class="op">.</span><span class="fu">fixed</span>(<span class="dv">7</span><span class="op">,</span><span class="dv">7</span><span class="op">,</span> sample_weights<span class="op">,</span> <span class="dv">3</span><span class="op">,</span><span class="dv">3</span><span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span></span>
<span id="cb67-82"><a href="#cb67-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-83"><a href="#cb67-83" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Calculate mean and variance for the sampled windows and store as 9 bands</span></span>
<span id="cb67-84"><a href="#cb67-84" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> sample_mean <span class="op">=</span> mean3<span class="op">.</span><span class="fu">neighborhoodToBands</span>(sample_kernel)<span class="op">;</span> </span>
<span id="cb67-85"><a href="#cb67-85" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> sample_var <span class="op">=</span> variance3<span class="op">.</span><span class="fu">neighborhoodToBands</span>(sample_kernel)<span class="op">;</span></span>
<span id="cb67-86"><a href="#cb67-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-87"><a href="#cb67-87" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Determine the 4 gradients for the sampled windows</span></span>
<span id="cb67-88"><a href="#cb67-88" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> gradients <span class="op">=</span> sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">1</span>)<span class="op">.</span><span class="fu">subtract</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">7</span>))<span class="op">.</span><span class="fu">abs</span>()<span class="op">;</span></span>
<span id="cb67-89"><a href="#cb67-89" aria-hidden="true" tabindex="-1"></a>  gradients <span class="op">=</span> gradients<span class="op">.</span><span class="fu">addBands</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">6</span>)<span class="op">.</span><span class="fu">subtract</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">2</span>))<span class="op">.</span><span class="fu">abs</span>())<span class="op">;</span></span>
<span id="cb67-90"><a href="#cb67-90" aria-hidden="true" tabindex="-1"></a>  gradients <span class="op">=</span> gradients<span class="op">.</span><span class="fu">addBands</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">3</span>)<span class="op">.</span><span class="fu">subtract</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">5</span>))<span class="op">.</span><span class="fu">abs</span>())<span class="op">;</span></span>
<span id="cb67-91"><a href="#cb67-91" aria-hidden="true" tabindex="-1"></a>  gradients <span class="op">=</span> gradients<span class="op">.</span><span class="fu">addBands</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">0</span>)<span class="op">.</span><span class="fu">subtract</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">8</span>))<span class="op">.</span><span class="fu">abs</span>())<span class="op">;</span></span>
<span id="cb67-92"><a href="#cb67-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-93"><a href="#cb67-93" aria-hidden="true" tabindex="-1"></a>  <span class="co">// And find the maximum gradient amongst gradient bands</span></span>
<span id="cb67-94"><a href="#cb67-94" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> max_gradient <span class="op">=</span> gradients<span class="op">.</span><span class="fu">reduce</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">max</span>())<span class="op">;</span></span>
<span id="cb67-95"><a href="#cb67-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-96"><a href="#cb67-96" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Create a mask for band pixels that are the maximum gradient</span></span>
<span id="cb67-97"><a href="#cb67-97" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> gradmask <span class="op">=</span> gradients<span class="op">.</span><span class="fu">eq</span>(max_gradient)<span class="op">;</span></span>
<span id="cb67-98"><a href="#cb67-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-99"><a href="#cb67-99" aria-hidden="true" tabindex="-1"></a>  <span class="co">// duplicate gradmask bands: each gradient represents 2 directions</span></span>
<span id="cb67-100"><a href="#cb67-100" aria-hidden="true" tabindex="-1"></a>  gradmask <span class="op">=</span> gradmask<span class="op">.</span><span class="fu">addBands</span>(gradmask)<span class="op">;</span></span>
<span id="cb67-101"><a href="#cb67-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-102"><a href="#cb67-102" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Determine the 8 directions</span></span>
<span id="cb67-103"><a href="#cb67-103" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> directions <span class="op">=</span> sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">1</span>)<span class="op">.</span><span class="fu">subtract</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">4</span>))<span class="op">.</span><span class="fu">gt</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">4</span>)<span class="op">.</span><span class="fu">subtract</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">7</span>)))<span class="op">.</span><span class="fu">multiply</span>(<span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb67-104"><a href="#cb67-104" aria-hidden="true" tabindex="-1"></a>  directions <span class="op">=</span> directions<span class="op">.</span><span class="fu">addBands</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">6</span>)<span class="op">.</span><span class="fu">subtract</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">4</span>))<span class="op">.</span><span class="fu">gt</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">4</span>)<span class="op">.</span><span class="fu">subtract</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">2</span>)))<span class="op">.</span><span class="fu">multiply</span>(<span class="dv">2</span>))<span class="op">;</span></span>
<span id="cb67-105"><a href="#cb67-105" aria-hidden="true" tabindex="-1"></a>  directions <span class="op">=</span> directions<span class="op">.</span><span class="fu">addBands</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">3</span>)<span class="op">.</span><span class="fu">subtract</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">4</span>))<span class="op">.</span><span class="fu">gt</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">4</span>)<span class="op">.</span><span class="fu">subtract</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">5</span>)))<span class="op">.</span><span class="fu">multiply</span>(<span class="dv">3</span>))<span class="op">;</span></span>
<span id="cb67-106"><a href="#cb67-106" aria-hidden="true" tabindex="-1"></a>  directions <span class="op">=</span> directions<span class="op">.</span><span class="fu">addBands</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">0</span>)<span class="op">.</span><span class="fu">subtract</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">4</span>))<span class="op">.</span><span class="fu">gt</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">4</span>)<span class="op">.</span><span class="fu">subtract</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">8</span>)))<span class="op">.</span><span class="fu">multiply</span>(<span class="dv">4</span>))<span class="op">;</span></span>
<span id="cb67-107"><a href="#cb67-107" aria-hidden="true" tabindex="-1"></a>  <span class="co">// The next 4 are the not() of the previous 4</span></span>
<span id="cb67-108"><a href="#cb67-108" aria-hidden="true" tabindex="-1"></a>  directions <span class="op">=</span> directions<span class="op">.</span><span class="fu">addBands</span>(directions<span class="op">.</span><span class="fu">select</span>(<span class="dv">0</span>)<span class="op">.</span><span class="fu">not</span>()<span class="op">.</span><span class="fu">multiply</span>(<span class="dv">5</span>))<span class="op">;</span></span>
<span id="cb67-109"><a href="#cb67-109" aria-hidden="true" tabindex="-1"></a>  directions <span class="op">=</span> directions<span class="op">.</span><span class="fu">addBands</span>(directions<span class="op">.</span><span class="fu">select</span>(<span class="dv">1</span>)<span class="op">.</span><span class="fu">not</span>()<span class="op">.</span><span class="fu">multiply</span>(<span class="dv">6</span>))<span class="op">;</span></span>
<span id="cb67-110"><a href="#cb67-110" aria-hidden="true" tabindex="-1"></a>  directions <span class="op">=</span> directions<span class="op">.</span><span class="fu">addBands</span>(directions<span class="op">.</span><span class="fu">select</span>(<span class="dv">2</span>)<span class="op">.</span><span class="fu">not</span>()<span class="op">.</span><span class="fu">multiply</span>(<span class="dv">7</span>))<span class="op">;</span></span>
<span id="cb67-111"><a href="#cb67-111" aria-hidden="true" tabindex="-1"></a>  directions <span class="op">=</span> directions<span class="op">.</span><span class="fu">addBands</span>(directions<span class="op">.</span><span class="fu">select</span>(<span class="dv">3</span>)<span class="op">.</span><span class="fu">not</span>()<span class="op">.</span><span class="fu">multiply</span>(<span class="dv">8</span>))<span class="op">;</span></span>
<span id="cb67-112"><a href="#cb67-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-113"><a href="#cb67-113" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Mask all values that are not 1-8</span></span>
<span id="cb67-114"><a href="#cb67-114" aria-hidden="true" tabindex="-1"></a>  directions <span class="op">=</span> directions<span class="op">.</span><span class="fu">updateMask</span>(gradmask)<span class="op">;</span></span>
<span id="cb67-115"><a href="#cb67-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-116"><a href="#cb67-116" aria-hidden="true" tabindex="-1"></a>  <span class="co">// &quot;collapse&quot; the stack into a singe band image (due to masking, each pixel has just one value (1-8) in it&#39;s directional band, and is otherwise masked)</span></span>
<span id="cb67-117"><a href="#cb67-117" aria-hidden="true" tabindex="-1"></a>  directions <span class="op">=</span> directions<span class="op">.</span><span class="fu">reduce</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">sum</span>())<span class="op">;</span>  </span>
<span id="cb67-118"><a href="#cb67-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-119"><a href="#cb67-119" aria-hidden="true" tabindex="-1"></a>  <span class="co">//var pal = [&#39;ffffff&#39;,&#39;ff0000&#39;,&#39;ffff00&#39;, &#39;00ff00&#39;, &#39;00ffff&#39;, &#39;0000ff&#39;, &#39;ff00ff&#39;, &#39;000000&#39;];</span></span>
<span id="cb67-120"><a href="#cb67-120" aria-hidden="true" tabindex="-1"></a>  <span class="co">//Map.addLayer(directions.reduce(ee.Reducer.sum()), {min:1, max:8, palette: pal}, &#39;Directions&#39;, false);</span></span>
<span id="cb67-121"><a href="#cb67-121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-122"><a href="#cb67-122" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> sample_stats <span class="op">=</span> sample_var<span class="op">.</span><span class="fu">divide</span>(sample_mean<span class="op">.</span><span class="fu">multiply</span>(sample_mean))<span class="op">;</span></span>
<span id="cb67-123"><a href="#cb67-123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-124"><a href="#cb67-124" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Calculate localNoiseVariance</span></span>
<span id="cb67-125"><a href="#cb67-125" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> sigmaV <span class="op">=</span> sample_stats<span class="op">.</span><span class="fu">toArray</span>()<span class="op">.</span><span class="fu">arraySort</span>()<span class="op">.</span><span class="fu">arraySlice</span>(<span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">5</span>)<span class="op">.</span><span class="fu">arrayReduce</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">mean</span>()<span class="op">,</span> [<span class="dv">0</span>])<span class="op">;</span></span>
<span id="cb67-126"><a href="#cb67-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-127"><a href="#cb67-127" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Set up the 7*7 kernels for directional statistics</span></span>
<span id="cb67-128"><a href="#cb67-128" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> rect_weights <span class="op">=</span> ee<span class="op">.</span><span class="at">List</span><span class="op">.</span><span class="fu">repeat</span>(ee<span class="op">.</span><span class="at">List</span><span class="op">.</span><span class="fu">repeat</span>(<span class="dv">0</span><span class="op">,</span><span class="dv">7</span>)<span class="op">,</span><span class="dv">3</span>)<span class="op">.</span><span class="fu">cat</span>(ee<span class="op">.</span><span class="at">List</span><span class="op">.</span><span class="fu">repeat</span>(ee<span class="op">.</span><span class="at">List</span><span class="op">.</span><span class="fu">repeat</span>(<span class="dv">1</span><span class="op">,</span><span class="dv">7</span>)<span class="op">,</span><span class="dv">4</span>))<span class="op">;</span></span>
<span id="cb67-129"><a href="#cb67-129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-130"><a href="#cb67-130" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> diag_weights <span class="op">=</span> ee<span class="op">.</span><span class="fu">List</span>([[<span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span>]<span class="op">,</span> [<span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span>]<span class="op">,</span> [<span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span>]<span class="op">,</span> </span>
<span id="cb67-131"><a href="#cb67-131" aria-hidden="true" tabindex="-1"></a>    [<span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span>]<span class="op">,</span> [<span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span>]<span class="op">,</span> [<span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span>]<span class="op">,</span> [<span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span>]])<span class="op">;</span></span>
<span id="cb67-132"><a href="#cb67-132" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-133"><a href="#cb67-133" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> rect_kernel <span class="op">=</span> ee<span class="op">.</span><span class="at">Kernel</span><span class="op">.</span><span class="fu">fixed</span>(<span class="dv">7</span><span class="op">,</span><span class="dv">7</span><span class="op">,</span> rect_weights<span class="op">,</span> <span class="dv">3</span><span class="op">,</span> <span class="dv">3</span><span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span></span>
<span id="cb67-134"><a href="#cb67-134" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> diag_kernel <span class="op">=</span> ee<span class="op">.</span><span class="at">Kernel</span><span class="op">.</span><span class="fu">fixed</span>(<span class="dv">7</span><span class="op">,</span><span class="dv">7</span><span class="op">,</span> diag_weights<span class="op">,</span> <span class="dv">3</span><span class="op">,</span> <span class="dv">3</span><span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span></span>
<span id="cb67-135"><a href="#cb67-135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-136"><a href="#cb67-136" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Create stacks for mean and variance using the original kernels. Mask with relevant direction.</span></span>
<span id="cb67-137"><a href="#cb67-137" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> dir_mean <span class="op">=</span> img<span class="op">.</span><span class="fu">reduceNeighborhood</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">mean</span>()<span class="op">,</span> rect_kernel)<span class="op">.</span><span class="fu">updateMask</span>(directions<span class="op">.</span><span class="fu">eq</span>(<span class="dv">1</span>))<span class="op">;</span></span>
<span id="cb67-138"><a href="#cb67-138" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> dir_var <span class="op">=</span> img<span class="op">.</span><span class="fu">reduceNeighborhood</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">variance</span>()<span class="op">,</span> rect_kernel)<span class="op">.</span><span class="fu">updateMask</span>(directions<span class="op">.</span><span class="fu">eq</span>(<span class="dv">1</span>))<span class="op">;</span></span>
<span id="cb67-139"><a href="#cb67-139" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-140"><a href="#cb67-140" aria-hidden="true" tabindex="-1"></a>  dir_mean <span class="op">=</span> dir_mean<span class="op">.</span><span class="fu">addBands</span>(img<span class="op">.</span><span class="fu">reduceNeighborhood</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">mean</span>()<span class="op">,</span> diag_kernel)<span class="op">.</span><span class="fu">updateMask</span>(directions<span class="op">.</span><span class="fu">eq</span>(<span class="dv">2</span>)))<span class="op">;</span></span>
<span id="cb67-141"><a href="#cb67-141" aria-hidden="true" tabindex="-1"></a>  dir_var <span class="op">=</span> dir_var<span class="op">.</span><span class="fu">addBands</span>(img<span class="op">.</span><span class="fu">reduceNeighborhood</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">variance</span>()<span class="op">,</span> diag_kernel)<span class="op">.</span><span class="fu">updateMask</span>(directions<span class="op">.</span><span class="fu">eq</span>(<span class="dv">2</span>)))<span class="op">;</span></span>
<span id="cb67-142"><a href="#cb67-142" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-143"><a href="#cb67-143" aria-hidden="true" tabindex="-1"></a>  <span class="co">// and add the bands for rotated kernels</span></span>
<span id="cb67-144"><a href="#cb67-144" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (<span class="kw">var</span> i<span class="op">=</span><span class="dv">1</span><span class="op">;</span> i<span class="op">&lt;</span><span class="dv">4</span><span class="op">;</span> i<span class="op">++</span>) {</span>
<span id="cb67-145"><a href="#cb67-145" aria-hidden="true" tabindex="-1"></a>    dir_mean <span class="op">=</span> dir_mean<span class="op">.</span><span class="fu">addBands</span>(img<span class="op">.</span><span class="fu">reduceNeighborhood</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">mean</span>()<span class="op">,</span> rect_kernel<span class="op">.</span><span class="fu">rotate</span>(i))<span class="op">.</span><span class="fu">updateMask</span>(directions<span class="op">.</span><span class="fu">eq</span>(<span class="dv">2</span><span class="op">*</span>i<span class="op">+</span><span class="dv">1</span>)))<span class="op">;</span></span>
<span id="cb67-146"><a href="#cb67-146" aria-hidden="true" tabindex="-1"></a>    dir_var <span class="op">=</span> dir_var<span class="op">.</span><span class="fu">addBands</span>(img<span class="op">.</span><span class="fu">reduceNeighborhood</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">variance</span>()<span class="op">,</span> rect_kernel<span class="op">.</span><span class="fu">rotate</span>(i))<span class="op">.</span><span class="fu">updateMask</span>(directions<span class="op">.</span><span class="fu">eq</span>(<span class="dv">2</span><span class="op">*</span>i<span class="op">+</span><span class="dv">1</span>)))<span class="op">;</span></span>
<span id="cb67-147"><a href="#cb67-147" aria-hidden="true" tabindex="-1"></a>    dir_mean <span class="op">=</span> dir_mean<span class="op">.</span><span class="fu">addBands</span>(img<span class="op">.</span><span class="fu">reduceNeighborhood</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">mean</span>()<span class="op">,</span> diag_kernel<span class="op">.</span><span class="fu">rotate</span>(i))<span class="op">.</span><span class="fu">updateMask</span>(directions<span class="op">.</span><span class="fu">eq</span>(<span class="dv">2</span><span class="op">*</span>i<span class="op">+</span><span class="dv">2</span>)))<span class="op">;</span></span>
<span id="cb67-148"><a href="#cb67-148" aria-hidden="true" tabindex="-1"></a>    dir_var <span class="op">=</span> dir_var<span class="op">.</span><span class="fu">addBands</span>(img<span class="op">.</span><span class="fu">reduceNeighborhood</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">variance</span>()<span class="op">,</span> diag_kernel<span class="op">.</span><span class="fu">rotate</span>(i))<span class="op">.</span><span class="fu">updateMask</span>(directions<span class="op">.</span><span class="fu">eq</span>(<span class="dv">2</span><span class="op">*</span>i<span class="op">+</span><span class="dv">2</span>)))<span class="op">;</span></span>
<span id="cb67-149"><a href="#cb67-149" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb67-150"><a href="#cb67-150" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-151"><a href="#cb67-151" aria-hidden="true" tabindex="-1"></a>  <span class="co">// &quot;collapse&quot; the stack into a single band image (due to masking, each pixel has just one value in it&#39;s directional band, and is otherwise masked)</span></span>
<span id="cb67-152"><a href="#cb67-152" aria-hidden="true" tabindex="-1"></a>  dir_mean <span class="op">=</span> dir_mean<span class="op">.</span><span class="fu">reduce</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">sum</span>())<span class="op">;</span></span>
<span id="cb67-153"><a href="#cb67-153" aria-hidden="true" tabindex="-1"></a>  dir_var <span class="op">=</span> dir_var<span class="op">.</span><span class="fu">reduce</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">sum</span>())<span class="op">;</span></span>
<span id="cb67-154"><a href="#cb67-154" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-155"><a href="#cb67-155" aria-hidden="true" tabindex="-1"></a>  <span class="co">// A finally generate the filtered value</span></span>
<span id="cb67-156"><a href="#cb67-156" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> varX <span class="op">=</span> dir_var<span class="op">.</span><span class="fu">subtract</span>(dir_mean<span class="op">.</span><span class="fu">multiply</span>(dir_mean)<span class="op">.</span><span class="fu">multiply</span>(sigmaV))<span class="op">.</span><span class="fu">divide</span>(sigmaV<span class="op">.</span><span class="fu">add</span>(<span class="fl">1.0</span>))<span class="op">;</span></span>
<span id="cb67-157"><a href="#cb67-157" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-158"><a href="#cb67-158" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> b <span class="op">=</span> varX<span class="op">.</span><span class="fu">divide</span>(dir_var)<span class="op">;</span></span>
<span id="cb67-159"><a href="#cb67-159" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-160"><a href="#cb67-160" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> result <span class="op">=</span> dir_mean<span class="op">.</span><span class="fu">add</span>(b<span class="op">.</span><span class="fu">multiply</span>(img<span class="op">.</span><span class="fu">subtract</span>(dir_mean)))<span class="op">;</span></span>
<span id="cb67-161"><a href="#cb67-161" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span>(result<span class="op">.</span><span class="fu">arrayFlatten</span>([[<span class="st">&#39;sum&#39;</span>]]))<span class="op">;</span></span>
<span id="cb67-162"><a href="#cb67-162" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p><a href="https://code.earthengine.google.com/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3A05-Flood_Mapping%2F04b_Apply_a_Threshold_(complete)" target="_blank">Open in Code Editor ↗</a></p>
<div id="exercise-30" class="section level3">
<h3>Exercise</h3>
<p>This exercise script is adopted from UN-SPIDER’s recommended approach to computing the flooded region.</p>
<p>Compute the <em>difference</em> image by finding the difference between the after and before images. Use a threshold od -3 (arbitrary value) to identify the initial flooded regions. Click <em>Try in Code Editor</em> to view the complete script.</p>
<div class="sourceCode" id="cb68"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a><span class="co">// There is an alternate way to detect change</span></span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a><span class="co">// Since the S1_GRD collection has log-scaled DB values, subtract is more appropriate</span></span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a><span class="co">// If you use subtract(), the threshold value also changes.</span></span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-5"><a href="#cb68-5" aria-hidden="true" tabindex="-1"></a><span class="co">// Calculate afterFiltered - beforeFiltered</span></span>
<span id="cb68-6"><a href="#cb68-6" aria-hidden="true" tabindex="-1"></a><span class="co">// Create a flood imagge using a threshold of -3</span></span>
<span id="cb68-7"><a href="#cb68-7" aria-hidden="true" tabindex="-1"></a><span class="co">// Display the results with a &#39;purple&#39; palette</span></span></code></pre></div>
<p><a href="https://code.earthengine.google.com/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3A05-Flood_Mapping%2F04c_Apply_a_Threshold_(exercise)" target="_blank">Try in Code Editor ↗</a></p>
</div>
</div>
<div id="apply-masks" class="section level2">
<h2>05. Apply Masks</h2>
<p>The Initial flooded map shows all the areas where the possibility of water is logged. But this contains both noise and permanent water. We can mask out the other pixels based on our need to get the exact flooded area. In this exercise, we will mask</p>
<ol style="list-style-type: decimal">
<li><p>Permanent water.</p></li>
<li><p>High degree slope area.</p></li>
<li><p>Isolated pixels.</p></li>
</ol>
<p>The <em>permanent water</em> is detected using the GSW water dataset. The pixel with a <a href="#exercise-10">seasonality band</a> greater than 5 is considered permanent water for this computation. Based on the ground information, this value can be changed. Using the <code>updateMask</code> function, we can mask out all the permanent water pixels.</p>
<p>The <em>slope</em> mask is created using the hydroSheds DEM dataset. The terrain slope can be calculated from the DEM using <code>ee.Algorithms.Terrain</code>. The areas with a slope greater than 5 degrees are selected and masked out. Mostly the water detected in this area is due to noise in the imagery.</p>
<p>The <em>isolated</em> pixel mask is done to reduce the noise. A single pixel detected as flood in the middle of nowhere must probably be a noise. Hence, all the pixels with less than 8 connected neighbors can be considered noise and masked out. To identify the connected pixels, we can use the <code>connectedPixelCount</code> function to check the connectedness for a pixel in all possible directions. This function will return an image where each pixel has the number of connected pixel counts of the image passed to it. Then, using the boolean function <code>gt()</code>, select all the connected pixel count greater than 8.</p>
<p>After applying all the filters to the initial flooded area image, the remaining pixels can be considered an original flooded region.</p>
<blockquote>
<p>Although the computation for the mask is done between images with different resolutions, GEE will convert all the images to the images added in map canvas or resolution mentioned during export. In our case, all the images will be resampled and projected to Sentinel 1 GRD projection.</p>
</blockquote>
<div class="figure" style="text-align: center">
<img src="images/gee_water_resources_management/flood_allMask.png" alt="Flood mask" width="100%" />
<p class="caption">
Flood mask
</p>
</div>
<div class="figure" style="text-align: center">
<img src="images/gee_water_resources_management/flood_mask.png" alt="Flooded region" width="100%" />
<p class="caption">
Flooded region
</p>
</div>
<div class="sourceCode" id="cb69"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> admin2 <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">&#39;FAO/GAUL_SIMPLIFIED_500m/2015/level2&#39;</span>)</span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> hydrosheds <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(<span class="st">&#39;WWF/HydroSHEDS/03VFDEM&#39;</span>)</span>
<span id="cb69-3"><a href="#cb69-3" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> gsw <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(<span class="st">&#39;JRC/GSW1_3/GlobalSurfaceWater&#39;</span>)</span>
<span id="cb69-4"><a href="#cb69-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb69-5"><a href="#cb69-5" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> beforeStart <span class="op">=</span> <span class="st">&#39;2018-07-15&#39;</span></span>
<span id="cb69-6"><a href="#cb69-6" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> beforeEnd <span class="op">=</span> <span class="st">&#39;2018-08-10&#39;</span></span>
<span id="cb69-7"><a href="#cb69-7" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> afterStart <span class="op">=</span> <span class="st">&#39;2018-08-10&#39;</span></span>
<span id="cb69-8"><a href="#cb69-8" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> afterEnd <span class="op">=</span> <span class="st">&#39;2018-08-23&#39;</span></span>
<span id="cb69-9"><a href="#cb69-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-10"><a href="#cb69-10" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> ernakulam <span class="op">=</span> admin2<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;ADM2_NAME&#39;</span><span class="op">,</span> <span class="st">&#39;Ernakulam&#39;</span>))</span>
<span id="cb69-11"><a href="#cb69-11" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> geometry <span class="op">=</span> ernakulam<span class="op">.</span><span class="fu">geometry</span>()</span>
<span id="cb69-12"><a href="#cb69-12" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(geometry<span class="op">,</span> {<span class="dt">color</span><span class="op">:</span> <span class="st">&#39;grey&#39;</span>}<span class="op">,</span> <span class="st">&#39;Ernakulam District&#39;</span>)</span>
<span id="cb69-13"><a href="#cb69-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-14"><a href="#cb69-14" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> collection<span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&#39;COPERNICUS/S1_GRD&#39;</span>)</span>
<span id="cb69-15"><a href="#cb69-15" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;instrumentMode&#39;</span><span class="op">,</span><span class="st">&#39;IW&#39;</span>))</span>
<span id="cb69-16"><a href="#cb69-16" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">listContains</span>(<span class="st">&#39;transmitterReceiverPolarisation&#39;</span><span class="op">,</span> <span class="st">&#39;VH&#39;</span>))</span>
<span id="cb69-17"><a href="#cb69-17" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;orbitProperties_pass&#39;</span><span class="op">,</span> <span class="st">&#39;DESCENDING&#39;</span>)) </span>
<span id="cb69-18"><a href="#cb69-18" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;resolution_meters&#39;</span><span class="op">,</span><span class="dv">10</span>))</span>
<span id="cb69-19"><a href="#cb69-19" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">bounds</span>(geometry))</span>
<span id="cb69-20"><a href="#cb69-20" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;VH&#39;</span>)<span class="op">;</span></span>
<span id="cb69-21"><a href="#cb69-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-22"><a href="#cb69-22" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> beforeCollection <span class="op">=</span> collection</span>
<span id="cb69-23"><a href="#cb69-23" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(beforeStart<span class="op">,</span> beforeEnd))</span>
<span id="cb69-24"><a href="#cb69-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-25"><a href="#cb69-25" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> afterCollection <span class="op">=</span> collection</span>
<span id="cb69-26"><a href="#cb69-26" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(afterStart<span class="op">,</span> afterEnd))</span>
<span id="cb69-27"><a href="#cb69-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-28"><a href="#cb69-28" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> before <span class="op">=</span> beforeCollection<span class="op">.</span><span class="fu">mosaic</span>()<span class="op">.</span><span class="fu">clip</span>(geometry)<span class="op">;</span></span>
<span id="cb69-29"><a href="#cb69-29" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> after <span class="op">=</span> afterCollection<span class="op">.</span><span class="fu">mosaic</span>()<span class="op">.</span><span class="fu">clip</span>(geometry)<span class="op">;</span></span>
<span id="cb69-30"><a href="#cb69-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-31"><a href="#cb69-31" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> beforeFiltered <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(<span class="fu">toDB</span>(<span class="fu">RefinedLee</span>(<span class="fu">toNatural</span>(before))))</span>
<span id="cb69-32"><a href="#cb69-32" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> afterFiltered <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(<span class="fu">toDB</span>(<span class="fu">RefinedLee</span>(<span class="fu">toNatural</span>(after))))</span>
<span id="cb69-33"><a href="#cb69-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-34"><a href="#cb69-34" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> difference <span class="op">=</span> afterFiltered<span class="op">.</span><span class="fu">divide</span>(beforeFiltered)<span class="op">;</span></span>
<span id="cb69-35"><a href="#cb69-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-36"><a href="#cb69-36" aria-hidden="true" tabindex="-1"></a><span class="co">// Define a threshold</span></span>
<span id="cb69-37"><a href="#cb69-37" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> diffThreshold <span class="op">=</span> <span class="fl">1.25</span><span class="op">;</span></span>
<span id="cb69-38"><a href="#cb69-38" aria-hidden="true" tabindex="-1"></a><span class="co">// Initial estimate of flooded pixels</span></span>
<span id="cb69-39"><a href="#cb69-39" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> flooded <span class="op">=</span> difference<span class="op">.</span><span class="fu">gt</span>(diffThreshold)<span class="op">.</span><span class="fu">rename</span>(<span class="st">&#39;water&#39;</span>)<span class="op">.</span><span class="fu">selfMask</span>()<span class="op">;</span></span>
<span id="cb69-40"><a href="#cb69-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-41"><a href="#cb69-41" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">centerObject</span>(geometry<span class="op">,</span> <span class="dv">10</span>)</span>
<span id="cb69-42"><a href="#cb69-42" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(before<span class="op">,</span> {<span class="dt">min</span><span class="op">:-</span><span class="dv">25</span><span class="op">,</span><span class="dt">max</span><span class="op">:</span><span class="dv">0</span>}<span class="op">,</span> <span class="st">&#39;Before Floods&#39;</span><span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span></span>
<span id="cb69-43"><a href="#cb69-43" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(after<span class="op">,</span> {<span class="dt">min</span><span class="op">:-</span><span class="dv">25</span><span class="op">,</span><span class="dt">max</span><span class="op">:</span><span class="dv">0</span>}<span class="op">,</span> <span class="st">&#39;After Floods&#39;</span><span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span> </span>
<span id="cb69-44"><a href="#cb69-44" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(beforeFiltered<span class="op">,</span> {<span class="dt">min</span><span class="op">:-</span><span class="dv">25</span><span class="op">,</span><span class="dt">max</span><span class="op">:</span><span class="dv">0</span>}<span class="op">,</span> <span class="st">&#39;Before Filtered&#39;</span><span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span></span>
<span id="cb69-45"><a href="#cb69-45" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(afterFiltered<span class="op">,</span> {<span class="dt">min</span><span class="op">:-</span><span class="dv">25</span><span class="op">,</span><span class="dt">max</span><span class="op">:</span><span class="dv">0</span>}<span class="op">,</span> <span class="st">&#39;After Filtered&#39;</span><span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span> </span>
<span id="cb69-46"><a href="#cb69-46" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(flooded<span class="op">,</span> {<span class="dt">min</span><span class="op">:</span><span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span><span class="dv">1</span><span class="op">,</span> <span class="dt">palette</span><span class="op">:</span> [<span class="st">&#39;orange&#39;</span>]}<span class="op">,</span> <span class="st">&#39;Initial Flood Area&#39;</span><span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span></span>
<span id="cb69-47"><a href="#cb69-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-48"><a href="#cb69-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-49"><a href="#cb69-49" aria-hidden="true" tabindex="-1"></a><span class="co">// Mask out area with permanent/semi-permanent water</span></span>
<span id="cb69-50"><a href="#cb69-50" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> permanentWater <span class="op">=</span> gsw<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;seasonality&#39;</span>)<span class="op">.</span><span class="fu">gte</span>(<span class="dv">5</span>)<span class="op">.</span><span class="fu">clip</span>(geometry)</span>
<span id="cb69-51"><a href="#cb69-51" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(permanentWater<span class="op">.</span><span class="fu">selfMask</span>()<span class="op">,</span> {<span class="dt">min</span><span class="op">:</span><span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span><span class="dv">1</span><span class="op">,</span> <span class="dt">palette</span><span class="op">:</span> [<span class="st">&#39;blue&#39;</span>]}<span class="op">,</span> <span class="st">&#39;Permanent Water&#39;</span><span class="op">,</span> <span class="kw">false</span>)</span>
<span id="cb69-52"><a href="#cb69-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-53"><a href="#cb69-53" aria-hidden="true" tabindex="-1"></a><span class="co">// GSW data is masked in non-water areas. Set it to 0 using unmask()</span></span>
<span id="cb69-54"><a href="#cb69-54" aria-hidden="true" tabindex="-1"></a><span class="co">// Invert the image to set all non-permanent regions to 1</span></span>
<span id="cb69-55"><a href="#cb69-55" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> permanentWaterMask <span class="op">=</span> permanentWater<span class="op">.</span><span class="fu">unmask</span>(<span class="dv">0</span>)<span class="op">.</span><span class="fu">not</span>()</span>
<span id="cb69-56"><a href="#cb69-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-57"><a href="#cb69-57" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> flooded <span class="op">=</span> flooded<span class="op">.</span><span class="fu">updateMask</span>(permanentWaterMask)</span>
<span id="cb69-58"><a href="#cb69-58" aria-hidden="true" tabindex="-1"></a><span class="co">// Mask out areas with more than 5 percent slope using the HydroSHEDS DEM</span></span>
<span id="cb69-59"><a href="#cb69-59" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> slopeThreshold <span class="op">=</span> <span class="dv">5</span><span class="op">;</span></span>
<span id="cb69-60"><a href="#cb69-60" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> terrain <span class="op">=</span> ee<span class="op">.</span><span class="at">Algorithms</span><span class="op">.</span><span class="fu">Terrain</span>(hydrosheds)<span class="op">;</span></span>
<span id="cb69-61"><a href="#cb69-61" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> slope <span class="op">=</span> terrain<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;slope&#39;</span>)<span class="op">;</span></span>
<span id="cb69-62"><a href="#cb69-62" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> steepAreas <span class="op">=</span> slope<span class="op">.</span><span class="fu">gt</span>(slopeThreshold)</span>
<span id="cb69-63"><a href="#cb69-63" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> slopeMask <span class="op">=</span> steepAreas<span class="op">.</span><span class="fu">not</span>()</span>
<span id="cb69-64"><a href="#cb69-64" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(steepAreas<span class="op">.</span><span class="fu">selfMask</span>()<span class="op">,</span> {<span class="dt">min</span><span class="op">:</span><span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span><span class="dv">1</span><span class="op">,</span> <span class="dt">palette</span><span class="op">:</span> [<span class="st">&#39;cyan&#39;</span>]}<span class="op">,</span> <span class="st">&#39;Steep Areas&#39;</span><span class="op">,</span> <span class="kw">false</span>)</span>
<span id="cb69-65"><a href="#cb69-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-66"><a href="#cb69-66" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> flooded <span class="op">=</span> flooded<span class="op">.</span><span class="fu">updateMask</span>(slopeMask)</span>
<span id="cb69-67"><a href="#cb69-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-68"><a href="#cb69-68" aria-hidden="true" tabindex="-1"></a><span class="co">// Remove isolated pixels</span></span>
<span id="cb69-69"><a href="#cb69-69" aria-hidden="true" tabindex="-1"></a><span class="co">// connectedPixelCount is Zoom dependent, so visual result will vary</span></span>
<span id="cb69-70"><a href="#cb69-70" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> connectedPixelThreshold <span class="op">=</span> <span class="dv">8</span><span class="op">;</span></span>
<span id="cb69-71"><a href="#cb69-71" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> connections <span class="op">=</span> flooded<span class="op">.</span><span class="fu">connectedPixelCount</span>(<span class="dv">25</span>)</span>
<span id="cb69-72"><a href="#cb69-72" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> disconnectedAreas <span class="op">=</span> connections<span class="op">.</span><span class="fu">lt</span>(connectedPixelThreshold)</span>
<span id="cb69-73"><a href="#cb69-73" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> disconnectedAreasMask <span class="op">=</span> disconnectedAreas<span class="op">.</span><span class="fu">not</span>()</span>
<span id="cb69-74"><a href="#cb69-74" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(disconnectedAreas<span class="op">.</span><span class="fu">selfMask</span>()<span class="op">,</span> {<span class="dt">min</span><span class="op">:</span><span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span><span class="dv">1</span><span class="op">,</span> <span class="dt">palette</span><span class="op">:</span> [<span class="st">&#39;yellow&#39;</span>]}<span class="op">,</span> <span class="st">&#39;Disconnected Areas&#39;</span><span class="op">,</span> <span class="kw">false</span>)</span>
<span id="cb69-75"><a href="#cb69-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-76"><a href="#cb69-76" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> flooded <span class="op">=</span> flooded<span class="op">.</span><span class="fu">updateMask</span>(disconnectedAreasMask)</span>
<span id="cb69-77"><a href="#cb69-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-78"><a href="#cb69-78" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(flooded<span class="op">,</span> {<span class="dt">min</span><span class="op">:</span><span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span><span class="dv">1</span><span class="op">,</span> <span class="dt">palette</span><span class="op">:</span> [<span class="st">&#39;red&#39;</span>]}<span class="op">,</span> <span class="st">&#39;Flooded Areas&#39;</span>)<span class="op">;</span></span>
<span id="cb69-79"><a href="#cb69-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-80"><a href="#cb69-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-81"><a href="#cb69-81" aria-hidden="true" tabindex="-1"></a><span class="co">//############################</span></span>
<span id="cb69-82"><a href="#cb69-82" aria-hidden="true" tabindex="-1"></a><span class="co">// Speckle Filtering Functions</span></span>
<span id="cb69-83"><a href="#cb69-83" aria-hidden="true" tabindex="-1"></a><span class="co">//############################</span></span>
<span id="cb69-84"><a href="#cb69-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-85"><a href="#cb69-85" aria-hidden="true" tabindex="-1"></a><span class="co">// Function to convert from dB</span></span>
<span id="cb69-86"><a href="#cb69-86" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">toNatural</span>(img) {</span>
<span id="cb69-87"><a href="#cb69-87" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> ee<span class="op">.</span><span class="fu">Image</span>(<span class="fl">10.0</span>)<span class="op">.</span><span class="fu">pow</span>(img<span class="op">.</span><span class="fu">select</span>(<span class="dv">0</span>)<span class="op">.</span><span class="fu">divide</span>(<span class="fl">10.0</span>))<span class="op">;</span></span>
<span id="cb69-88"><a href="#cb69-88" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb69-89"><a href="#cb69-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-90"><a href="#cb69-90" aria-hidden="true" tabindex="-1"></a><span class="co">//Function to convert to dB</span></span>
<span id="cb69-91"><a href="#cb69-91" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">toDB</span>(img) {</span>
<span id="cb69-92"><a href="#cb69-92" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> ee<span class="op">.</span><span class="fu">Image</span>(img)<span class="op">.</span><span class="fu">log10</span>()<span class="op">.</span><span class="fu">multiply</span>(<span class="fl">10.0</span>)<span class="op">;</span></span>
<span id="cb69-93"><a href="#cb69-93" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb69-94"><a href="#cb69-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-95"><a href="#cb69-95" aria-hidden="true" tabindex="-1"></a><span class="co">//Apllying a Refined Lee Speckle filter as coded in the SNAP 3.0 S1TBX:</span></span>
<span id="cb69-96"><a href="#cb69-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-97"><a href="#cb69-97" aria-hidden="true" tabindex="-1"></a><span class="co">//https://github.com/senbox-org/s1tbx/blob/master/s1tbx-op-sar-processing/src/main/java/org/esa/s1tbx/sar/gpf/filtering/SpeckleFilters/RefinedLee.java</span></span>
<span id="cb69-98"><a href="#cb69-98" aria-hidden="true" tabindex="-1"></a><span class="co">//Adapted by Guido Lemoine</span></span>
<span id="cb69-99"><a href="#cb69-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-100"><a href="#cb69-100" aria-hidden="true" tabindex="-1"></a><span class="co">// by Guido Lemoine</span></span>
<span id="cb69-101"><a href="#cb69-101" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">RefinedLee</span>(img) {</span>
<span id="cb69-102"><a href="#cb69-102" aria-hidden="true" tabindex="-1"></a>  <span class="co">// img must be in natural units, i.e. not in dB!</span></span>
<span id="cb69-103"><a href="#cb69-103" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Set up 3x3 kernels </span></span>
<span id="cb69-104"><a href="#cb69-104" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> weights3 <span class="op">=</span> ee<span class="op">.</span><span class="at">List</span><span class="op">.</span><span class="fu">repeat</span>(ee<span class="op">.</span><span class="at">List</span><span class="op">.</span><span class="fu">repeat</span>(<span class="dv">1</span><span class="op">,</span><span class="dv">3</span>)<span class="op">,</span><span class="dv">3</span>)<span class="op">;</span></span>
<span id="cb69-105"><a href="#cb69-105" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> kernel3 <span class="op">=</span> ee<span class="op">.</span><span class="at">Kernel</span><span class="op">.</span><span class="fu">fixed</span>(<span class="dv">3</span><span class="op">,</span><span class="dv">3</span><span class="op">,</span> weights3<span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span></span>
<span id="cb69-106"><a href="#cb69-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-107"><a href="#cb69-107" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> mean3 <span class="op">=</span> img<span class="op">.</span><span class="fu">reduceNeighborhood</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">mean</span>()<span class="op">,</span> kernel3)<span class="op">;</span></span>
<span id="cb69-108"><a href="#cb69-108" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> variance3 <span class="op">=</span> img<span class="op">.</span><span class="fu">reduceNeighborhood</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">variance</span>()<span class="op">,</span> kernel3)<span class="op">;</span></span>
<span id="cb69-109"><a href="#cb69-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-110"><a href="#cb69-110" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Use a sample of the 3x3 windows inside a 7x7 windows to determine gradients and directions</span></span>
<span id="cb69-111"><a href="#cb69-111" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> sample_weights <span class="op">=</span> ee<span class="op">.</span><span class="fu">List</span>([[<span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span>]<span class="op">,</span> [<span class="dv">0</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span>]<span class="op">,</span>[<span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span>]<span class="op">,</span> [<span class="dv">0</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span>]<span class="op">,</span> [<span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span>]<span class="op">,</span> [<span class="dv">0</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span>]<span class="op">,</span>[<span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span>]])<span class="op">;</span></span>
<span id="cb69-112"><a href="#cb69-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-113"><a href="#cb69-113" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> sample_kernel <span class="op">=</span> ee<span class="op">.</span><span class="at">Kernel</span><span class="op">.</span><span class="fu">fixed</span>(<span class="dv">7</span><span class="op">,</span><span class="dv">7</span><span class="op">,</span> sample_weights<span class="op">,</span> <span class="dv">3</span><span class="op">,</span><span class="dv">3</span><span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span></span>
<span id="cb69-114"><a href="#cb69-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-115"><a href="#cb69-115" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Calculate mean and variance for the sampled windows and store as 9 bands</span></span>
<span id="cb69-116"><a href="#cb69-116" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> sample_mean <span class="op">=</span> mean3<span class="op">.</span><span class="fu">neighborhoodToBands</span>(sample_kernel)<span class="op">;</span> </span>
<span id="cb69-117"><a href="#cb69-117" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> sample_var <span class="op">=</span> variance3<span class="op">.</span><span class="fu">neighborhoodToBands</span>(sample_kernel)<span class="op">;</span></span>
<span id="cb69-118"><a href="#cb69-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-119"><a href="#cb69-119" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Determine the 4 gradients for the sampled windows</span></span>
<span id="cb69-120"><a href="#cb69-120" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> gradients <span class="op">=</span> sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">1</span>)<span class="op">.</span><span class="fu">subtract</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">7</span>))<span class="op">.</span><span class="fu">abs</span>()<span class="op">;</span></span>
<span id="cb69-121"><a href="#cb69-121" aria-hidden="true" tabindex="-1"></a>  gradients <span class="op">=</span> gradients<span class="op">.</span><span class="fu">addBands</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">6</span>)<span class="op">.</span><span class="fu">subtract</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">2</span>))<span class="op">.</span><span class="fu">abs</span>())<span class="op">;</span></span>
<span id="cb69-122"><a href="#cb69-122" aria-hidden="true" tabindex="-1"></a>  gradients <span class="op">=</span> gradients<span class="op">.</span><span class="fu">addBands</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">3</span>)<span class="op">.</span><span class="fu">subtract</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">5</span>))<span class="op">.</span><span class="fu">abs</span>())<span class="op">;</span></span>
<span id="cb69-123"><a href="#cb69-123" aria-hidden="true" tabindex="-1"></a>  gradients <span class="op">=</span> gradients<span class="op">.</span><span class="fu">addBands</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">0</span>)<span class="op">.</span><span class="fu">subtract</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">8</span>))<span class="op">.</span><span class="fu">abs</span>())<span class="op">;</span></span>
<span id="cb69-124"><a href="#cb69-124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-125"><a href="#cb69-125" aria-hidden="true" tabindex="-1"></a>  <span class="co">// And find the maximum gradient amongst gradient bands</span></span>
<span id="cb69-126"><a href="#cb69-126" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> max_gradient <span class="op">=</span> gradients<span class="op">.</span><span class="fu">reduce</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">max</span>())<span class="op">;</span></span>
<span id="cb69-127"><a href="#cb69-127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-128"><a href="#cb69-128" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Create a mask for band pixels that are the maximum gradient</span></span>
<span id="cb69-129"><a href="#cb69-129" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> gradmask <span class="op">=</span> gradients<span class="op">.</span><span class="fu">eq</span>(max_gradient)<span class="op">;</span></span>
<span id="cb69-130"><a href="#cb69-130" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-131"><a href="#cb69-131" aria-hidden="true" tabindex="-1"></a>  <span class="co">// duplicate gradmask bands: each gradient represents 2 directions</span></span>
<span id="cb69-132"><a href="#cb69-132" aria-hidden="true" tabindex="-1"></a>  gradmask <span class="op">=</span> gradmask<span class="op">.</span><span class="fu">addBands</span>(gradmask)<span class="op">;</span></span>
<span id="cb69-133"><a href="#cb69-133" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-134"><a href="#cb69-134" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Determine the 8 directions</span></span>
<span id="cb69-135"><a href="#cb69-135" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> directions <span class="op">=</span> sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">1</span>)<span class="op">.</span><span class="fu">subtract</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">4</span>))<span class="op">.</span><span class="fu">gt</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">4</span>)<span class="op">.</span><span class="fu">subtract</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">7</span>)))<span class="op">.</span><span class="fu">multiply</span>(<span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb69-136"><a href="#cb69-136" aria-hidden="true" tabindex="-1"></a>  directions <span class="op">=</span> directions<span class="op">.</span><span class="fu">addBands</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">6</span>)<span class="op">.</span><span class="fu">subtract</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">4</span>))<span class="op">.</span><span class="fu">gt</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">4</span>)<span class="op">.</span><span class="fu">subtract</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">2</span>)))<span class="op">.</span><span class="fu">multiply</span>(<span class="dv">2</span>))<span class="op">;</span></span>
<span id="cb69-137"><a href="#cb69-137" aria-hidden="true" tabindex="-1"></a>  directions <span class="op">=</span> directions<span class="op">.</span><span class="fu">addBands</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">3</span>)<span class="op">.</span><span class="fu">subtract</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">4</span>))<span class="op">.</span><span class="fu">gt</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">4</span>)<span class="op">.</span><span class="fu">subtract</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">5</span>)))<span class="op">.</span><span class="fu">multiply</span>(<span class="dv">3</span>))<span class="op">;</span></span>
<span id="cb69-138"><a href="#cb69-138" aria-hidden="true" tabindex="-1"></a>  directions <span class="op">=</span> directions<span class="op">.</span><span class="fu">addBands</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">0</span>)<span class="op">.</span><span class="fu">subtract</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">4</span>))<span class="op">.</span><span class="fu">gt</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">4</span>)<span class="op">.</span><span class="fu">subtract</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">8</span>)))<span class="op">.</span><span class="fu">multiply</span>(<span class="dv">4</span>))<span class="op">;</span></span>
<span id="cb69-139"><a href="#cb69-139" aria-hidden="true" tabindex="-1"></a>  <span class="co">// The next 4 are the not() of the previous 4</span></span>
<span id="cb69-140"><a href="#cb69-140" aria-hidden="true" tabindex="-1"></a>  directions <span class="op">=</span> directions<span class="op">.</span><span class="fu">addBands</span>(directions<span class="op">.</span><span class="fu">select</span>(<span class="dv">0</span>)<span class="op">.</span><span class="fu">not</span>()<span class="op">.</span><span class="fu">multiply</span>(<span class="dv">5</span>))<span class="op">;</span></span>
<span id="cb69-141"><a href="#cb69-141" aria-hidden="true" tabindex="-1"></a>  directions <span class="op">=</span> directions<span class="op">.</span><span class="fu">addBands</span>(directions<span class="op">.</span><span class="fu">select</span>(<span class="dv">1</span>)<span class="op">.</span><span class="fu">not</span>()<span class="op">.</span><span class="fu">multiply</span>(<span class="dv">6</span>))<span class="op">;</span></span>
<span id="cb69-142"><a href="#cb69-142" aria-hidden="true" tabindex="-1"></a>  directions <span class="op">=</span> directions<span class="op">.</span><span class="fu">addBands</span>(directions<span class="op">.</span><span class="fu">select</span>(<span class="dv">2</span>)<span class="op">.</span><span class="fu">not</span>()<span class="op">.</span><span class="fu">multiply</span>(<span class="dv">7</span>))<span class="op">;</span></span>
<span id="cb69-143"><a href="#cb69-143" aria-hidden="true" tabindex="-1"></a>  directions <span class="op">=</span> directions<span class="op">.</span><span class="fu">addBands</span>(directions<span class="op">.</span><span class="fu">select</span>(<span class="dv">3</span>)<span class="op">.</span><span class="fu">not</span>()<span class="op">.</span><span class="fu">multiply</span>(<span class="dv">8</span>))<span class="op">;</span></span>
<span id="cb69-144"><a href="#cb69-144" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-145"><a href="#cb69-145" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Mask all values that are not 1-8</span></span>
<span id="cb69-146"><a href="#cb69-146" aria-hidden="true" tabindex="-1"></a>  directions <span class="op">=</span> directions<span class="op">.</span><span class="fu">updateMask</span>(gradmask)<span class="op">;</span></span>
<span id="cb69-147"><a href="#cb69-147" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-148"><a href="#cb69-148" aria-hidden="true" tabindex="-1"></a>  <span class="co">// &quot;collapse&quot; the stack into a singe band image (due to masking, each pixel has just one value (1-8) in it&#39;s directional band, and is otherwise masked)</span></span>
<span id="cb69-149"><a href="#cb69-149" aria-hidden="true" tabindex="-1"></a>  directions <span class="op">=</span> directions<span class="op">.</span><span class="fu">reduce</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">sum</span>())<span class="op">;</span>  </span>
<span id="cb69-150"><a href="#cb69-150" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-151"><a href="#cb69-151" aria-hidden="true" tabindex="-1"></a>  <span class="co">//var pal = [&#39;ffffff&#39;,&#39;ff0000&#39;,&#39;ffff00&#39;, &#39;00ff00&#39;, &#39;00ffff&#39;, &#39;0000ff&#39;, &#39;ff00ff&#39;, &#39;000000&#39;];</span></span>
<span id="cb69-152"><a href="#cb69-152" aria-hidden="true" tabindex="-1"></a>  <span class="co">//Map.addLayer(directions.reduce(ee.Reducer.sum()), {min:1, max:8, palette: pal}, &#39;Directions&#39;, false);</span></span>
<span id="cb69-153"><a href="#cb69-153" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-154"><a href="#cb69-154" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> sample_stats <span class="op">=</span> sample_var<span class="op">.</span><span class="fu">divide</span>(sample_mean<span class="op">.</span><span class="fu">multiply</span>(sample_mean))<span class="op">;</span></span>
<span id="cb69-155"><a href="#cb69-155" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-156"><a href="#cb69-156" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Calculate localNoiseVariance</span></span>
<span id="cb69-157"><a href="#cb69-157" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> sigmaV <span class="op">=</span> sample_stats<span class="op">.</span><span class="fu">toArray</span>()<span class="op">.</span><span class="fu">arraySort</span>()<span class="op">.</span><span class="fu">arraySlice</span>(<span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">5</span>)<span class="op">.</span><span class="fu">arrayReduce</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">mean</span>()<span class="op">,</span> [<span class="dv">0</span>])<span class="op">;</span></span>
<span id="cb69-158"><a href="#cb69-158" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-159"><a href="#cb69-159" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Set up the 7*7 kernels for directional statistics</span></span>
<span id="cb69-160"><a href="#cb69-160" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> rect_weights <span class="op">=</span> ee<span class="op">.</span><span class="at">List</span><span class="op">.</span><span class="fu">repeat</span>(ee<span class="op">.</span><span class="at">List</span><span class="op">.</span><span class="fu">repeat</span>(<span class="dv">0</span><span class="op">,</span><span class="dv">7</span>)<span class="op">,</span><span class="dv">3</span>)<span class="op">.</span><span class="fu">cat</span>(ee<span class="op">.</span><span class="at">List</span><span class="op">.</span><span class="fu">repeat</span>(ee<span class="op">.</span><span class="at">List</span><span class="op">.</span><span class="fu">repeat</span>(<span class="dv">1</span><span class="op">,</span><span class="dv">7</span>)<span class="op">,</span><span class="dv">4</span>))<span class="op">;</span></span>
<span id="cb69-161"><a href="#cb69-161" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-162"><a href="#cb69-162" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> diag_weights <span class="op">=</span> ee<span class="op">.</span><span class="fu">List</span>([[<span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span>]<span class="op">,</span> [<span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span>]<span class="op">,</span> [<span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span>]<span class="op">,</span> </span>
<span id="cb69-163"><a href="#cb69-163" aria-hidden="true" tabindex="-1"></a>    [<span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span>]<span class="op">,</span> [<span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span>]<span class="op">,</span> [<span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span>]<span class="op">,</span> [<span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span>]])<span class="op">;</span></span>
<span id="cb69-164"><a href="#cb69-164" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-165"><a href="#cb69-165" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> rect_kernel <span class="op">=</span> ee<span class="op">.</span><span class="at">Kernel</span><span class="op">.</span><span class="fu">fixed</span>(<span class="dv">7</span><span class="op">,</span><span class="dv">7</span><span class="op">,</span> rect_weights<span class="op">,</span> <span class="dv">3</span><span class="op">,</span> <span class="dv">3</span><span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span></span>
<span id="cb69-166"><a href="#cb69-166" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> diag_kernel <span class="op">=</span> ee<span class="op">.</span><span class="at">Kernel</span><span class="op">.</span><span class="fu">fixed</span>(<span class="dv">7</span><span class="op">,</span><span class="dv">7</span><span class="op">,</span> diag_weights<span class="op">,</span> <span class="dv">3</span><span class="op">,</span> <span class="dv">3</span><span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span></span>
<span id="cb69-167"><a href="#cb69-167" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-168"><a href="#cb69-168" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Create stacks for mean and variance using the original kernels. Mask with relevant direction.</span></span>
<span id="cb69-169"><a href="#cb69-169" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> dir_mean <span class="op">=</span> img<span class="op">.</span><span class="fu">reduceNeighborhood</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">mean</span>()<span class="op">,</span> rect_kernel)<span class="op">.</span><span class="fu">updateMask</span>(directions<span class="op">.</span><span class="fu">eq</span>(<span class="dv">1</span>))<span class="op">;</span></span>
<span id="cb69-170"><a href="#cb69-170" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> dir_var <span class="op">=</span> img<span class="op">.</span><span class="fu">reduceNeighborhood</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">variance</span>()<span class="op">,</span> rect_kernel)<span class="op">.</span><span class="fu">updateMask</span>(directions<span class="op">.</span><span class="fu">eq</span>(<span class="dv">1</span>))<span class="op">;</span></span>
<span id="cb69-171"><a href="#cb69-171" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-172"><a href="#cb69-172" aria-hidden="true" tabindex="-1"></a>  dir_mean <span class="op">=</span> dir_mean<span class="op">.</span><span class="fu">addBands</span>(img<span class="op">.</span><span class="fu">reduceNeighborhood</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">mean</span>()<span class="op">,</span> diag_kernel)<span class="op">.</span><span class="fu">updateMask</span>(directions<span class="op">.</span><span class="fu">eq</span>(<span class="dv">2</span>)))<span class="op">;</span></span>
<span id="cb69-173"><a href="#cb69-173" aria-hidden="true" tabindex="-1"></a>  dir_var <span class="op">=</span> dir_var<span class="op">.</span><span class="fu">addBands</span>(img<span class="op">.</span><span class="fu">reduceNeighborhood</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">variance</span>()<span class="op">,</span> diag_kernel)<span class="op">.</span><span class="fu">updateMask</span>(directions<span class="op">.</span><span class="fu">eq</span>(<span class="dv">2</span>)))<span class="op">;</span></span>
<span id="cb69-174"><a href="#cb69-174" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-175"><a href="#cb69-175" aria-hidden="true" tabindex="-1"></a>  <span class="co">// and add the bands for rotated kernels</span></span>
<span id="cb69-176"><a href="#cb69-176" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (<span class="kw">var</span> i<span class="op">=</span><span class="dv">1</span><span class="op">;</span> i<span class="op">&lt;</span><span class="dv">4</span><span class="op">;</span> i<span class="op">++</span>) {</span>
<span id="cb69-177"><a href="#cb69-177" aria-hidden="true" tabindex="-1"></a>    dir_mean <span class="op">=</span> dir_mean<span class="op">.</span><span class="fu">addBands</span>(img<span class="op">.</span><span class="fu">reduceNeighborhood</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">mean</span>()<span class="op">,</span> rect_kernel<span class="op">.</span><span class="fu">rotate</span>(i))<span class="op">.</span><span class="fu">updateMask</span>(directions<span class="op">.</span><span class="fu">eq</span>(<span class="dv">2</span><span class="op">*</span>i<span class="op">+</span><span class="dv">1</span>)))<span class="op">;</span></span>
<span id="cb69-178"><a href="#cb69-178" aria-hidden="true" tabindex="-1"></a>    dir_var <span class="op">=</span> dir_var<span class="op">.</span><span class="fu">addBands</span>(img<span class="op">.</span><span class="fu">reduceNeighborhood</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">variance</span>()<span class="op">,</span> rect_kernel<span class="op">.</span><span class="fu">rotate</span>(i))<span class="op">.</span><span class="fu">updateMask</span>(directions<span class="op">.</span><span class="fu">eq</span>(<span class="dv">2</span><span class="op">*</span>i<span class="op">+</span><span class="dv">1</span>)))<span class="op">;</span></span>
<span id="cb69-179"><a href="#cb69-179" aria-hidden="true" tabindex="-1"></a>    dir_mean <span class="op">=</span> dir_mean<span class="op">.</span><span class="fu">addBands</span>(img<span class="op">.</span><span class="fu">reduceNeighborhood</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">mean</span>()<span class="op">,</span> diag_kernel<span class="op">.</span><span class="fu">rotate</span>(i))<span class="op">.</span><span class="fu">updateMask</span>(directions<span class="op">.</span><span class="fu">eq</span>(<span class="dv">2</span><span class="op">*</span>i<span class="op">+</span><span class="dv">2</span>)))<span class="op">;</span></span>
<span id="cb69-180"><a href="#cb69-180" aria-hidden="true" tabindex="-1"></a>    dir_var <span class="op">=</span> dir_var<span class="op">.</span><span class="fu">addBands</span>(img<span class="op">.</span><span class="fu">reduceNeighborhood</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">variance</span>()<span class="op">,</span> diag_kernel<span class="op">.</span><span class="fu">rotate</span>(i))<span class="op">.</span><span class="fu">updateMask</span>(directions<span class="op">.</span><span class="fu">eq</span>(<span class="dv">2</span><span class="op">*</span>i<span class="op">+</span><span class="dv">2</span>)))<span class="op">;</span></span>
<span id="cb69-181"><a href="#cb69-181" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb69-182"><a href="#cb69-182" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-183"><a href="#cb69-183" aria-hidden="true" tabindex="-1"></a>  <span class="co">// &quot;collapse&quot; the stack into a single band image (due to masking, each pixel has just one value in it&#39;s directional band, and is otherwise masked)</span></span>
<span id="cb69-184"><a href="#cb69-184" aria-hidden="true" tabindex="-1"></a>  dir_mean <span class="op">=</span> dir_mean<span class="op">.</span><span class="fu">reduce</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">sum</span>())<span class="op">;</span></span>
<span id="cb69-185"><a href="#cb69-185" aria-hidden="true" tabindex="-1"></a>  dir_var <span class="op">=</span> dir_var<span class="op">.</span><span class="fu">reduce</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">sum</span>())<span class="op">;</span></span>
<span id="cb69-186"><a href="#cb69-186" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-187"><a href="#cb69-187" aria-hidden="true" tabindex="-1"></a>  <span class="co">// A finally generate the filtered value</span></span>
<span id="cb69-188"><a href="#cb69-188" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> varX <span class="op">=</span> dir_var<span class="op">.</span><span class="fu">subtract</span>(dir_mean<span class="op">.</span><span class="fu">multiply</span>(dir_mean)<span class="op">.</span><span class="fu">multiply</span>(sigmaV))<span class="op">.</span><span class="fu">divide</span>(sigmaV<span class="op">.</span><span class="fu">add</span>(<span class="fl">1.0</span>))<span class="op">;</span></span>
<span id="cb69-189"><a href="#cb69-189" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-190"><a href="#cb69-190" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> b <span class="op">=</span> varX<span class="op">.</span><span class="fu">divide</span>(dir_var)<span class="op">;</span></span>
<span id="cb69-191"><a href="#cb69-191" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-192"><a href="#cb69-192" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> result <span class="op">=</span> dir_mean<span class="op">.</span><span class="fu">add</span>(b<span class="op">.</span><span class="fu">multiply</span>(img<span class="op">.</span><span class="fu">subtract</span>(dir_mean)))<span class="op">;</span></span>
<span id="cb69-193"><a href="#cb69-193" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span>(result<span class="op">.</span><span class="fu">arrayFlatten</span>([[<span class="st">&#39;sum&#39;</span>]]))<span class="op">;</span></span>
<span id="cb69-194"><a href="#cb69-194" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p><a href="https://code.earthengine.google.com/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3A05-Flood_Mapping%2F05b_Apply_Masks_(complete)" target="_blank">Open in Code Editor ↗</a></p>
<div id="exercise-31" class="section level3">
<h3>Exercise</h3>
<p>We just learned to mask permanent water using the GSW water dataset. Now mask the cropland pixels extracted from the ESA worldview dataset and add the layer to canvas.</p>
<div class="sourceCode" id="cb70"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> admin2 <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">&#39;FAO/GAUL_SIMPLIFIED_500m/2015/level2&#39;</span>)</span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> hydrosheds <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(<span class="st">&#39;WWF/HydroSHEDS/03VFDEM&#39;</span>)</span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> gsw <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(<span class="st">&#39;JRC/GSW1_3/GlobalSurfaceWater&#39;</span>)</span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-5"><a href="#cb70-5" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> beforeStart <span class="op">=</span> <span class="st">&#39;2018-07-15&#39;</span></span>
<span id="cb70-6"><a href="#cb70-6" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> beforeEnd <span class="op">=</span> <span class="st">&#39;2018-08-10&#39;</span></span>
<span id="cb70-7"><a href="#cb70-7" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> afterStart <span class="op">=</span> <span class="st">&#39;2018-08-10&#39;</span></span>
<span id="cb70-8"><a href="#cb70-8" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> afterEnd <span class="op">=</span> <span class="st">&#39;2018-08-23&#39;</span></span>
<span id="cb70-9"><a href="#cb70-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-10"><a href="#cb70-10" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> ernakulam <span class="op">=</span> admin2<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;ADM2_NAME&#39;</span><span class="op">,</span> <span class="st">&#39;Ernakulam&#39;</span>))</span>
<span id="cb70-11"><a href="#cb70-11" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> geometry <span class="op">=</span> ernakulam<span class="op">.</span><span class="fu">geometry</span>()</span>
<span id="cb70-12"><a href="#cb70-12" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(geometry<span class="op">,</span> {<span class="dt">color</span><span class="op">:</span> <span class="st">&#39;grey&#39;</span>}<span class="op">,</span> <span class="st">&#39;Ernakulam District&#39;</span>)</span>
<span id="cb70-13"><a href="#cb70-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-14"><a href="#cb70-14" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> collection<span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&#39;COPERNICUS/S1_GRD&#39;</span>)</span>
<span id="cb70-15"><a href="#cb70-15" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;instrumentMode&#39;</span><span class="op">,</span><span class="st">&#39;IW&#39;</span>))</span>
<span id="cb70-16"><a href="#cb70-16" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">listContains</span>(<span class="st">&#39;transmitterReceiverPolarisation&#39;</span><span class="op">,</span> <span class="st">&#39;VH&#39;</span>))</span>
<span id="cb70-17"><a href="#cb70-17" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;orbitProperties_pass&#39;</span><span class="op">,</span> <span class="st">&#39;DESCENDING&#39;</span>)) </span>
<span id="cb70-18"><a href="#cb70-18" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;resolution_meters&#39;</span><span class="op">,</span><span class="dv">10</span>))</span>
<span id="cb70-19"><a href="#cb70-19" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">bounds</span>(geometry))</span>
<span id="cb70-20"><a href="#cb70-20" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;VH&#39;</span>)<span class="op">;</span></span>
<span id="cb70-21"><a href="#cb70-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-22"><a href="#cb70-22" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> beforeCollection <span class="op">=</span> collection</span>
<span id="cb70-23"><a href="#cb70-23" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(beforeStart<span class="op">,</span> beforeEnd))</span>
<span id="cb70-24"><a href="#cb70-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-25"><a href="#cb70-25" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> afterCollection <span class="op">=</span> collection</span>
<span id="cb70-26"><a href="#cb70-26" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(afterStart<span class="op">,</span> afterEnd))</span>
<span id="cb70-27"><a href="#cb70-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-28"><a href="#cb70-28" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> before <span class="op">=</span> beforeCollection<span class="op">.</span><span class="fu">mosaic</span>()<span class="op">.</span><span class="fu">clip</span>(geometry)<span class="op">;</span></span>
<span id="cb70-29"><a href="#cb70-29" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> after <span class="op">=</span> afterCollection<span class="op">.</span><span class="fu">mosaic</span>()<span class="op">.</span><span class="fu">clip</span>(geometry)<span class="op">;</span></span>
<span id="cb70-30"><a href="#cb70-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-31"><a href="#cb70-31" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> beforeFiltered <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(<span class="fu">toDB</span>(<span class="fu">RefinedLee</span>(<span class="fu">toNatural</span>(before))))</span>
<span id="cb70-32"><a href="#cb70-32" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> afterFiltered <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(<span class="fu">toDB</span>(<span class="fu">RefinedLee</span>(<span class="fu">toNatural</span>(after))))</span>
<span id="cb70-33"><a href="#cb70-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-34"><a href="#cb70-34" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> difference <span class="op">=</span> afterFiltered<span class="op">.</span><span class="fu">divide</span>(beforeFiltered)<span class="op">;</span></span>
<span id="cb70-35"><a href="#cb70-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-36"><a href="#cb70-36" aria-hidden="true" tabindex="-1"></a><span class="co">// Define a threshold</span></span>
<span id="cb70-37"><a href="#cb70-37" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> diffThreshold <span class="op">=</span> <span class="fl">1.25</span><span class="op">;</span></span>
<span id="cb70-38"><a href="#cb70-38" aria-hidden="true" tabindex="-1"></a><span class="co">// Initial estimate of flooded pixels</span></span>
<span id="cb70-39"><a href="#cb70-39" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> flooded <span class="op">=</span> difference<span class="op">.</span><span class="fu">gt</span>(diffThreshold)<span class="op">.</span><span class="fu">rename</span>(<span class="st">&#39;water&#39;</span>)<span class="op">.</span><span class="fu">selfMask</span>()<span class="op">;</span></span>
<span id="cb70-40"><a href="#cb70-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-41"><a href="#cb70-41" aria-hidden="true" tabindex="-1"></a><span class="co">//Map.centerObject(geometry, 10)</span></span>
<span id="cb70-42"><a href="#cb70-42" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(before<span class="op">,</span> {<span class="dt">min</span><span class="op">:-</span><span class="dv">25</span><span class="op">,</span><span class="dt">max</span><span class="op">:</span><span class="dv">0</span>}<span class="op">,</span> <span class="st">&#39;Before Floods&#39;</span><span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span></span>
<span id="cb70-43"><a href="#cb70-43" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(after<span class="op">,</span> {<span class="dt">min</span><span class="op">:-</span><span class="dv">25</span><span class="op">,</span><span class="dt">max</span><span class="op">:</span><span class="dv">0</span>}<span class="op">,</span> <span class="st">&#39;After Floods&#39;</span><span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span> </span>
<span id="cb70-44"><a href="#cb70-44" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(beforeFiltered<span class="op">,</span> {<span class="dt">min</span><span class="op">:-</span><span class="dv">25</span><span class="op">,</span><span class="dt">max</span><span class="op">:</span><span class="dv">0</span>}<span class="op">,</span> <span class="st">&#39;Before Filtered&#39;</span><span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span></span>
<span id="cb70-45"><a href="#cb70-45" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(afterFiltered<span class="op">,</span> {<span class="dt">min</span><span class="op">:-</span><span class="dv">25</span><span class="op">,</span><span class="dt">max</span><span class="op">:</span><span class="dv">0</span>}<span class="op">,</span> <span class="st">&#39;After Filtered&#39;</span><span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span> </span>
<span id="cb70-46"><a href="#cb70-46" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(flooded<span class="op">,</span> {<span class="dt">min</span><span class="op">:</span><span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span><span class="dv">1</span><span class="op">,</span> <span class="dt">palette</span><span class="op">:</span> [<span class="st">&#39;orange&#39;</span>]}<span class="op">,</span> <span class="st">&#39;Initial Flood Area&#39;</span><span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span></span>
<span id="cb70-47"><a href="#cb70-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-48"><a href="#cb70-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-49"><a href="#cb70-49" aria-hidden="true" tabindex="-1"></a><span class="co">// Mask out area with permanent/semi-permanent water</span></span>
<span id="cb70-50"><a href="#cb70-50" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> permanentWater <span class="op">=</span> gsw<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;seasonality&#39;</span>)<span class="op">.</span><span class="fu">gte</span>(<span class="dv">5</span>)<span class="op">.</span><span class="fu">clip</span>(geometry)</span>
<span id="cb70-51"><a href="#cb70-51" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(permanentWater<span class="op">.</span><span class="fu">selfMask</span>()<span class="op">,</span> {<span class="dt">min</span><span class="op">:</span><span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span><span class="dv">1</span><span class="op">,</span> <span class="dt">palette</span><span class="op">:</span> [<span class="st">&#39;blue&#39;</span>]}<span class="op">,</span> <span class="st">&#39;Permanent Water&#39;</span><span class="op">,</span> <span class="kw">false</span>)</span>
<span id="cb70-52"><a href="#cb70-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-53"><a href="#cb70-53" aria-hidden="true" tabindex="-1"></a><span class="co">// GSW data is masked in non-water areas. Set it to 0 using unmask()</span></span>
<span id="cb70-54"><a href="#cb70-54" aria-hidden="true" tabindex="-1"></a><span class="co">// Invert the image to set all non-permanent regions to 1</span></span>
<span id="cb70-55"><a href="#cb70-55" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> permanentWaterMask <span class="op">=</span> permanentWater<span class="op">.</span><span class="fu">unmask</span>(<span class="dv">0</span>)<span class="op">.</span><span class="fu">not</span>()</span>
<span id="cb70-56"><a href="#cb70-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-57"><a href="#cb70-57" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> flooded <span class="op">=</span> flooded<span class="op">.</span><span class="fu">updateMask</span>(permanentWaterMask)</span>
<span id="cb70-58"><a href="#cb70-58" aria-hidden="true" tabindex="-1"></a><span class="co">// Mask out areas with more than 5 percent slope using the HydroSHEDS DEM</span></span>
<span id="cb70-59"><a href="#cb70-59" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> slopeThreshold <span class="op">=</span> <span class="dv">5</span><span class="op">;</span></span>
<span id="cb70-60"><a href="#cb70-60" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> terrain <span class="op">=</span> ee<span class="op">.</span><span class="at">Algorithms</span><span class="op">.</span><span class="fu">Terrain</span>(hydrosheds)<span class="op">;</span></span>
<span id="cb70-61"><a href="#cb70-61" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> slope <span class="op">=</span> terrain<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;slope&#39;</span>)<span class="op">;</span></span>
<span id="cb70-62"><a href="#cb70-62" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> steepAreas <span class="op">=</span> slope<span class="op">.</span><span class="fu">gt</span>(slopeThreshold)</span>
<span id="cb70-63"><a href="#cb70-63" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> slopeMask <span class="op">=</span> steepAreas<span class="op">.</span><span class="fu">not</span>()</span>
<span id="cb70-64"><a href="#cb70-64" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(steepAreas<span class="op">.</span><span class="fu">selfMask</span>()<span class="op">,</span> {<span class="dt">min</span><span class="op">:</span><span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span><span class="dv">1</span><span class="op">,</span> <span class="dt">palette</span><span class="op">:</span> [<span class="st">&#39;cyan&#39;</span>]}<span class="op">,</span> <span class="st">&#39;Steep Areas&#39;</span><span class="op">,</span> <span class="kw">false</span>)</span>
<span id="cb70-65"><a href="#cb70-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-66"><a href="#cb70-66" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> flooded <span class="op">=</span> flooded<span class="op">.</span><span class="fu">updateMask</span>(slopeMask)</span>
<span id="cb70-67"><a href="#cb70-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-68"><a href="#cb70-68" aria-hidden="true" tabindex="-1"></a><span class="co">// Remove isolated pixels</span></span>
<span id="cb70-69"><a href="#cb70-69" aria-hidden="true" tabindex="-1"></a><span class="co">// connectedPixelCount is Zoom dependent, so visual result will vary</span></span>
<span id="cb70-70"><a href="#cb70-70" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> connectedPixelThreshold <span class="op">=</span> <span class="dv">8</span><span class="op">;</span></span>
<span id="cb70-71"><a href="#cb70-71" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> connections <span class="op">=</span> flooded<span class="op">.</span><span class="fu">connectedPixelCount</span>(<span class="dv">25</span>)</span>
<span id="cb70-72"><a href="#cb70-72" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> disconnectedAreas <span class="op">=</span> connections<span class="op">.</span><span class="fu">lt</span>(connectedPixelThreshold)</span>
<span id="cb70-73"><a href="#cb70-73" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> disconnectedAreasMask <span class="op">=</span> disconnectedAreas<span class="op">.</span><span class="fu">not</span>()</span>
<span id="cb70-74"><a href="#cb70-74" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(disconnectedAreas<span class="op">.</span><span class="fu">selfMask</span>()<span class="op">,</span> {<span class="dt">min</span><span class="op">:</span><span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span><span class="dv">1</span><span class="op">,</span> <span class="dt">palette</span><span class="op">:</span> [<span class="st">&#39;yellow&#39;</span>]}<span class="op">,</span> <span class="st">&#39;Disconnected Areas&#39;</span><span class="op">,</span> <span class="kw">false</span>)</span>
<span id="cb70-75"><a href="#cb70-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-76"><a href="#cb70-76" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> flooded <span class="op">=</span> flooded<span class="op">.</span><span class="fu">updateMask</span>(disconnectedAreasMask)</span>
<span id="cb70-77"><a href="#cb70-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-78"><a href="#cb70-78" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(flooded<span class="op">,</span> {<span class="dt">min</span><span class="op">:</span><span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span><span class="dv">1</span><span class="op">,</span> <span class="dt">palette</span><span class="op">:</span> [<span class="st">&#39;red&#39;</span>]}<span class="op">,</span> <span class="st">&#39;Flooded Areas&#39;</span>)<span class="op">;</span></span>
<span id="cb70-79"><a href="#cb70-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-80"><a href="#cb70-80" aria-hidden="true" tabindex="-1"></a><span class="co">// Exercise</span></span>
<span id="cb70-81"><a href="#cb70-81" aria-hidden="true" tabindex="-1"></a><span class="co">// Apply a Crop Mask to asses flood damage to crops</span></span>
<span id="cb70-82"><a href="#cb70-82" aria-hidden="true" tabindex="-1"></a><span class="co">// Use the ESA WorldCover data to extract cropland</span></span>
<span id="cb70-83"><a href="#cb70-83" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> dataset <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&quot;ESA/WorldCover/v100&quot;</span>)<span class="op">.</span><span class="fu">first</span>()<span class="op">;</span></span>
<span id="cb70-84"><a href="#cb70-84" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> classification <span class="op">=</span> dataset<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;Map&#39;</span>)<span class="op">.</span><span class="fu">clip</span>(geometry)</span>
<span id="cb70-85"><a href="#cb70-85" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> cropland <span class="op">=</span> classification<span class="op">.</span><span class="fu">eq</span>(<span class="dv">40</span>)</span>
<span id="cb70-86"><a href="#cb70-86" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(cropland<span class="op">.</span><span class="fu">selfMask</span>()<span class="op">,</span> {<span class="dt">min</span><span class="op">:</span><span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span><span class="dv">1</span><span class="op">,</span> <span class="dt">palette</span><span class="op">:</span> [<span class="st">&#39;white&#39;</span><span class="op">,</span> <span class="st">&#39;green&#39;</span>]}<span class="op">,</span> <span class="st">&#39;Cropland&#39;</span>)</span>
<span id="cb70-87"><a href="#cb70-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-88"><a href="#cb70-88" aria-hidden="true" tabindex="-1"></a><span class="co">// Mask all non-cropland and display flooded regions</span></span>
<span id="cb70-89"><a href="#cb70-89" aria-hidden="true" tabindex="-1"></a><span class="co">// Display the result on the map.</span></span>
<span id="cb70-90"><a href="#cb70-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-91"><a href="#cb70-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-92"><a href="#cb70-92" aria-hidden="true" tabindex="-1"></a><span class="co">//############################</span></span>
<span id="cb70-93"><a href="#cb70-93" aria-hidden="true" tabindex="-1"></a><span class="co">// Speckle Filtering Functions</span></span>
<span id="cb70-94"><a href="#cb70-94" aria-hidden="true" tabindex="-1"></a><span class="co">//############################</span></span>
<span id="cb70-95"><a href="#cb70-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-96"><a href="#cb70-96" aria-hidden="true" tabindex="-1"></a><span class="co">// Function to convert from dB</span></span>
<span id="cb70-97"><a href="#cb70-97" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">toNatural</span>(img) {</span>
<span id="cb70-98"><a href="#cb70-98" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> ee<span class="op">.</span><span class="fu">Image</span>(<span class="fl">10.0</span>)<span class="op">.</span><span class="fu">pow</span>(img<span class="op">.</span><span class="fu">select</span>(<span class="dv">0</span>)<span class="op">.</span><span class="fu">divide</span>(<span class="fl">10.0</span>))<span class="op">;</span></span>
<span id="cb70-99"><a href="#cb70-99" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb70-100"><a href="#cb70-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-101"><a href="#cb70-101" aria-hidden="true" tabindex="-1"></a><span class="co">//Function to convert to dB</span></span>
<span id="cb70-102"><a href="#cb70-102" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">toDB</span>(img) {</span>
<span id="cb70-103"><a href="#cb70-103" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> ee<span class="op">.</span><span class="fu">Image</span>(img)<span class="op">.</span><span class="fu">log10</span>()<span class="op">.</span><span class="fu">multiply</span>(<span class="fl">10.0</span>)<span class="op">;</span></span>
<span id="cb70-104"><a href="#cb70-104" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb70-105"><a href="#cb70-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-106"><a href="#cb70-106" aria-hidden="true" tabindex="-1"></a><span class="co">//Apllying a Refined Lee Speckle filter as coded in the SNAP 3.0 S1TBX:</span></span>
<span id="cb70-107"><a href="#cb70-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-108"><a href="#cb70-108" aria-hidden="true" tabindex="-1"></a><span class="co">//https://github.com/senbox-org/s1tbx/blob/master/s1tbx-op-sar-processing/src/main/java/org/esa/s1tbx/sar/gpf/filtering/SpeckleFilters/RefinedLee.java</span></span>
<span id="cb70-109"><a href="#cb70-109" aria-hidden="true" tabindex="-1"></a><span class="co">//Adapted by Guido Lemoine</span></span>
<span id="cb70-110"><a href="#cb70-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-111"><a href="#cb70-111" aria-hidden="true" tabindex="-1"></a><span class="co">// by Guido Lemoine</span></span>
<span id="cb70-112"><a href="#cb70-112" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">RefinedLee</span>(img) {</span>
<span id="cb70-113"><a href="#cb70-113" aria-hidden="true" tabindex="-1"></a>  <span class="co">// img must be in natural units, i.e. not in dB!</span></span>
<span id="cb70-114"><a href="#cb70-114" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Set up 3x3 kernels </span></span>
<span id="cb70-115"><a href="#cb70-115" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> weights3 <span class="op">=</span> ee<span class="op">.</span><span class="at">List</span><span class="op">.</span><span class="fu">repeat</span>(ee<span class="op">.</span><span class="at">List</span><span class="op">.</span><span class="fu">repeat</span>(<span class="dv">1</span><span class="op">,</span><span class="dv">3</span>)<span class="op">,</span><span class="dv">3</span>)<span class="op">;</span></span>
<span id="cb70-116"><a href="#cb70-116" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> kernel3 <span class="op">=</span> ee<span class="op">.</span><span class="at">Kernel</span><span class="op">.</span><span class="fu">fixed</span>(<span class="dv">3</span><span class="op">,</span><span class="dv">3</span><span class="op">,</span> weights3<span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span></span>
<span id="cb70-117"><a href="#cb70-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-118"><a href="#cb70-118" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> mean3 <span class="op">=</span> img<span class="op">.</span><span class="fu">reduceNeighborhood</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">mean</span>()<span class="op">,</span> kernel3)<span class="op">;</span></span>
<span id="cb70-119"><a href="#cb70-119" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> variance3 <span class="op">=</span> img<span class="op">.</span><span class="fu">reduceNeighborhood</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">variance</span>()<span class="op">,</span> kernel3)<span class="op">;</span></span>
<span id="cb70-120"><a href="#cb70-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-121"><a href="#cb70-121" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Use a sample of the 3x3 windows inside a 7x7 windows to determine gradients and directions</span></span>
<span id="cb70-122"><a href="#cb70-122" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> sample_weights <span class="op">=</span> ee<span class="op">.</span><span class="fu">List</span>([[<span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span>]<span class="op">,</span> [<span class="dv">0</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span>]<span class="op">,</span>[<span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span>]<span class="op">,</span> [<span class="dv">0</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span>]<span class="op">,</span> [<span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span>]<span class="op">,</span> [<span class="dv">0</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span>]<span class="op">,</span>[<span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span>]])<span class="op">;</span></span>
<span id="cb70-123"><a href="#cb70-123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-124"><a href="#cb70-124" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> sample_kernel <span class="op">=</span> ee<span class="op">.</span><span class="at">Kernel</span><span class="op">.</span><span class="fu">fixed</span>(<span class="dv">7</span><span class="op">,</span><span class="dv">7</span><span class="op">,</span> sample_weights<span class="op">,</span> <span class="dv">3</span><span class="op">,</span><span class="dv">3</span><span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span></span>
<span id="cb70-125"><a href="#cb70-125" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-126"><a href="#cb70-126" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Calculate mean and variance for the sampled windows and store as 9 bands</span></span>
<span id="cb70-127"><a href="#cb70-127" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> sample_mean <span class="op">=</span> mean3<span class="op">.</span><span class="fu">neighborhoodToBands</span>(sample_kernel)<span class="op">;</span> </span>
<span id="cb70-128"><a href="#cb70-128" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> sample_var <span class="op">=</span> variance3<span class="op">.</span><span class="fu">neighborhoodToBands</span>(sample_kernel)<span class="op">;</span></span>
<span id="cb70-129"><a href="#cb70-129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-130"><a href="#cb70-130" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Determine the 4 gradients for the sampled windows</span></span>
<span id="cb70-131"><a href="#cb70-131" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> gradients <span class="op">=</span> sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">1</span>)<span class="op">.</span><span class="fu">subtract</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">7</span>))<span class="op">.</span><span class="fu">abs</span>()<span class="op">;</span></span>
<span id="cb70-132"><a href="#cb70-132" aria-hidden="true" tabindex="-1"></a>  gradients <span class="op">=</span> gradients<span class="op">.</span><span class="fu">addBands</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">6</span>)<span class="op">.</span><span class="fu">subtract</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">2</span>))<span class="op">.</span><span class="fu">abs</span>())<span class="op">;</span></span>
<span id="cb70-133"><a href="#cb70-133" aria-hidden="true" tabindex="-1"></a>  gradients <span class="op">=</span> gradients<span class="op">.</span><span class="fu">addBands</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">3</span>)<span class="op">.</span><span class="fu">subtract</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">5</span>))<span class="op">.</span><span class="fu">abs</span>())<span class="op">;</span></span>
<span id="cb70-134"><a href="#cb70-134" aria-hidden="true" tabindex="-1"></a>  gradients <span class="op">=</span> gradients<span class="op">.</span><span class="fu">addBands</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">0</span>)<span class="op">.</span><span class="fu">subtract</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">8</span>))<span class="op">.</span><span class="fu">abs</span>())<span class="op">;</span></span>
<span id="cb70-135"><a href="#cb70-135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-136"><a href="#cb70-136" aria-hidden="true" tabindex="-1"></a>  <span class="co">// And find the maximum gradient amongst gradient bands</span></span>
<span id="cb70-137"><a href="#cb70-137" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> max_gradient <span class="op">=</span> gradients<span class="op">.</span><span class="fu">reduce</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">max</span>())<span class="op">;</span></span>
<span id="cb70-138"><a href="#cb70-138" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-139"><a href="#cb70-139" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Create a mask for band pixels that are the maximum gradient</span></span>
<span id="cb70-140"><a href="#cb70-140" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> gradmask <span class="op">=</span> gradients<span class="op">.</span><span class="fu">eq</span>(max_gradient)<span class="op">;</span></span>
<span id="cb70-141"><a href="#cb70-141" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-142"><a href="#cb70-142" aria-hidden="true" tabindex="-1"></a>  <span class="co">// duplicate gradmask bands: each gradient represents 2 directions</span></span>
<span id="cb70-143"><a href="#cb70-143" aria-hidden="true" tabindex="-1"></a>  gradmask <span class="op">=</span> gradmask<span class="op">.</span><span class="fu">addBands</span>(gradmask)<span class="op">;</span></span>
<span id="cb70-144"><a href="#cb70-144" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-145"><a href="#cb70-145" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Determine the 8 directions</span></span>
<span id="cb70-146"><a href="#cb70-146" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> directions <span class="op">=</span> sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">1</span>)<span class="op">.</span><span class="fu">subtract</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">4</span>))<span class="op">.</span><span class="fu">gt</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">4</span>)<span class="op">.</span><span class="fu">subtract</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">7</span>)))<span class="op">.</span><span class="fu">multiply</span>(<span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb70-147"><a href="#cb70-147" aria-hidden="true" tabindex="-1"></a>  directions <span class="op">=</span> directions<span class="op">.</span><span class="fu">addBands</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">6</span>)<span class="op">.</span><span class="fu">subtract</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">4</span>))<span class="op">.</span><span class="fu">gt</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">4</span>)<span class="op">.</span><span class="fu">subtract</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">2</span>)))<span class="op">.</span><span class="fu">multiply</span>(<span class="dv">2</span>))<span class="op">;</span></span>
<span id="cb70-148"><a href="#cb70-148" aria-hidden="true" tabindex="-1"></a>  directions <span class="op">=</span> directions<span class="op">.</span><span class="fu">addBands</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">3</span>)<span class="op">.</span><span class="fu">subtract</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">4</span>))<span class="op">.</span><span class="fu">gt</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">4</span>)<span class="op">.</span><span class="fu">subtract</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">5</span>)))<span class="op">.</span><span class="fu">multiply</span>(<span class="dv">3</span>))<span class="op">;</span></span>
<span id="cb70-149"><a href="#cb70-149" aria-hidden="true" tabindex="-1"></a>  directions <span class="op">=</span> directions<span class="op">.</span><span class="fu">addBands</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">0</span>)<span class="op">.</span><span class="fu">subtract</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">4</span>))<span class="op">.</span><span class="fu">gt</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">4</span>)<span class="op">.</span><span class="fu">subtract</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">8</span>)))<span class="op">.</span><span class="fu">multiply</span>(<span class="dv">4</span>))<span class="op">;</span></span>
<span id="cb70-150"><a href="#cb70-150" aria-hidden="true" tabindex="-1"></a>  <span class="co">// The next 4 are the not() of the previous 4</span></span>
<span id="cb70-151"><a href="#cb70-151" aria-hidden="true" tabindex="-1"></a>  directions <span class="op">=</span> directions<span class="op">.</span><span class="fu">addBands</span>(directions<span class="op">.</span><span class="fu">select</span>(<span class="dv">0</span>)<span class="op">.</span><span class="fu">not</span>()<span class="op">.</span><span class="fu">multiply</span>(<span class="dv">5</span>))<span class="op">;</span></span>
<span id="cb70-152"><a href="#cb70-152" aria-hidden="true" tabindex="-1"></a>  directions <span class="op">=</span> directions<span class="op">.</span><span class="fu">addBands</span>(directions<span class="op">.</span><span class="fu">select</span>(<span class="dv">1</span>)<span class="op">.</span><span class="fu">not</span>()<span class="op">.</span><span class="fu">multiply</span>(<span class="dv">6</span>))<span class="op">;</span></span>
<span id="cb70-153"><a href="#cb70-153" aria-hidden="true" tabindex="-1"></a>  directions <span class="op">=</span> directions<span class="op">.</span><span class="fu">addBands</span>(directions<span class="op">.</span><span class="fu">select</span>(<span class="dv">2</span>)<span class="op">.</span><span class="fu">not</span>()<span class="op">.</span><span class="fu">multiply</span>(<span class="dv">7</span>))<span class="op">;</span></span>
<span id="cb70-154"><a href="#cb70-154" aria-hidden="true" tabindex="-1"></a>  directions <span class="op">=</span> directions<span class="op">.</span><span class="fu">addBands</span>(directions<span class="op">.</span><span class="fu">select</span>(<span class="dv">3</span>)<span class="op">.</span><span class="fu">not</span>()<span class="op">.</span><span class="fu">multiply</span>(<span class="dv">8</span>))<span class="op">;</span></span>
<span id="cb70-155"><a href="#cb70-155" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-156"><a href="#cb70-156" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Mask all values that are not 1-8</span></span>
<span id="cb70-157"><a href="#cb70-157" aria-hidden="true" tabindex="-1"></a>  directions <span class="op">=</span> directions<span class="op">.</span><span class="fu">updateMask</span>(gradmask)<span class="op">;</span></span>
<span id="cb70-158"><a href="#cb70-158" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-159"><a href="#cb70-159" aria-hidden="true" tabindex="-1"></a>  <span class="co">// &quot;collapse&quot; the stack into a singe band image (due to masking, each pixel has just one value (1-8) in it&#39;s directional band, and is otherwise masked)</span></span>
<span id="cb70-160"><a href="#cb70-160" aria-hidden="true" tabindex="-1"></a>  directions <span class="op">=</span> directions<span class="op">.</span><span class="fu">reduce</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">sum</span>())<span class="op">;</span>  </span>
<span id="cb70-161"><a href="#cb70-161" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-162"><a href="#cb70-162" aria-hidden="true" tabindex="-1"></a>  <span class="co">//var pal = [&#39;ffffff&#39;,&#39;ff0000&#39;,&#39;ffff00&#39;, &#39;00ff00&#39;, &#39;00ffff&#39;, &#39;0000ff&#39;, &#39;ff00ff&#39;, &#39;000000&#39;];</span></span>
<span id="cb70-163"><a href="#cb70-163" aria-hidden="true" tabindex="-1"></a>  <span class="co">//Map.addLayer(directions.reduce(ee.Reducer.sum()), {min:1, max:8, palette: pal}, &#39;Directions&#39;, false);</span></span>
<span id="cb70-164"><a href="#cb70-164" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-165"><a href="#cb70-165" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> sample_stats <span class="op">=</span> sample_var<span class="op">.</span><span class="fu">divide</span>(sample_mean<span class="op">.</span><span class="fu">multiply</span>(sample_mean))<span class="op">;</span></span>
<span id="cb70-166"><a href="#cb70-166" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-167"><a href="#cb70-167" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Calculate localNoiseVariance</span></span>
<span id="cb70-168"><a href="#cb70-168" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> sigmaV <span class="op">=</span> sample_stats<span class="op">.</span><span class="fu">toArray</span>()<span class="op">.</span><span class="fu">arraySort</span>()<span class="op">.</span><span class="fu">arraySlice</span>(<span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">5</span>)<span class="op">.</span><span class="fu">arrayReduce</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">mean</span>()<span class="op">,</span> [<span class="dv">0</span>])<span class="op">;</span></span>
<span id="cb70-169"><a href="#cb70-169" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-170"><a href="#cb70-170" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Set up the 7*7 kernels for directional statistics</span></span>
<span id="cb70-171"><a href="#cb70-171" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> rect_weights <span class="op">=</span> ee<span class="op">.</span><span class="at">List</span><span class="op">.</span><span class="fu">repeat</span>(ee<span class="op">.</span><span class="at">List</span><span class="op">.</span><span class="fu">repeat</span>(<span class="dv">0</span><span class="op">,</span><span class="dv">7</span>)<span class="op">,</span><span class="dv">3</span>)<span class="op">.</span><span class="fu">cat</span>(ee<span class="op">.</span><span class="at">List</span><span class="op">.</span><span class="fu">repeat</span>(ee<span class="op">.</span><span class="at">List</span><span class="op">.</span><span class="fu">repeat</span>(<span class="dv">1</span><span class="op">,</span><span class="dv">7</span>)<span class="op">,</span><span class="dv">4</span>))<span class="op">;</span></span>
<span id="cb70-172"><a href="#cb70-172" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-173"><a href="#cb70-173" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> diag_weights <span class="op">=</span> ee<span class="op">.</span><span class="fu">List</span>([[<span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span>]<span class="op">,</span> [<span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span>]<span class="op">,</span> [<span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span>]<span class="op">,</span> </span>
<span id="cb70-174"><a href="#cb70-174" aria-hidden="true" tabindex="-1"></a>    [<span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span>]<span class="op">,</span> [<span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span>]<span class="op">,</span> [<span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span>]<span class="op">,</span> [<span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span>]])<span class="op">;</span></span>
<span id="cb70-175"><a href="#cb70-175" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-176"><a href="#cb70-176" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> rect_kernel <span class="op">=</span> ee<span class="op">.</span><span class="at">Kernel</span><span class="op">.</span><span class="fu">fixed</span>(<span class="dv">7</span><span class="op">,</span><span class="dv">7</span><span class="op">,</span> rect_weights<span class="op">,</span> <span class="dv">3</span><span class="op">,</span> <span class="dv">3</span><span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span></span>
<span id="cb70-177"><a href="#cb70-177" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> diag_kernel <span class="op">=</span> ee<span class="op">.</span><span class="at">Kernel</span><span class="op">.</span><span class="fu">fixed</span>(<span class="dv">7</span><span class="op">,</span><span class="dv">7</span><span class="op">,</span> diag_weights<span class="op">,</span> <span class="dv">3</span><span class="op">,</span> <span class="dv">3</span><span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span></span>
<span id="cb70-178"><a href="#cb70-178" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-179"><a href="#cb70-179" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Create stacks for mean and variance using the original kernels. Mask with relevant direction.</span></span>
<span id="cb70-180"><a href="#cb70-180" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> dir_mean <span class="op">=</span> img<span class="op">.</span><span class="fu">reduceNeighborhood</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">mean</span>()<span class="op">,</span> rect_kernel)<span class="op">.</span><span class="fu">updateMask</span>(directions<span class="op">.</span><span class="fu">eq</span>(<span class="dv">1</span>))<span class="op">;</span></span>
<span id="cb70-181"><a href="#cb70-181" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> dir_var <span class="op">=</span> img<span class="op">.</span><span class="fu">reduceNeighborhood</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">variance</span>()<span class="op">,</span> rect_kernel)<span class="op">.</span><span class="fu">updateMask</span>(directions<span class="op">.</span><span class="fu">eq</span>(<span class="dv">1</span>))<span class="op">;</span></span>
<span id="cb70-182"><a href="#cb70-182" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-183"><a href="#cb70-183" aria-hidden="true" tabindex="-1"></a>  dir_mean <span class="op">=</span> dir_mean<span class="op">.</span><span class="fu">addBands</span>(img<span class="op">.</span><span class="fu">reduceNeighborhood</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">mean</span>()<span class="op">,</span> diag_kernel)<span class="op">.</span><span class="fu">updateMask</span>(directions<span class="op">.</span><span class="fu">eq</span>(<span class="dv">2</span>)))<span class="op">;</span></span>
<span id="cb70-184"><a href="#cb70-184" aria-hidden="true" tabindex="-1"></a>  dir_var <span class="op">=</span> dir_var<span class="op">.</span><span class="fu">addBands</span>(img<span class="op">.</span><span class="fu">reduceNeighborhood</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">variance</span>()<span class="op">,</span> diag_kernel)<span class="op">.</span><span class="fu">updateMask</span>(directions<span class="op">.</span><span class="fu">eq</span>(<span class="dv">2</span>)))<span class="op">;</span></span>
<span id="cb70-185"><a href="#cb70-185" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-186"><a href="#cb70-186" aria-hidden="true" tabindex="-1"></a>  <span class="co">// and add the bands for rotated kernels</span></span>
<span id="cb70-187"><a href="#cb70-187" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (<span class="kw">var</span> i<span class="op">=</span><span class="dv">1</span><span class="op">;</span> i<span class="op">&lt;</span><span class="dv">4</span><span class="op">;</span> i<span class="op">++</span>) {</span>
<span id="cb70-188"><a href="#cb70-188" aria-hidden="true" tabindex="-1"></a>    dir_mean <span class="op">=</span> dir_mean<span class="op">.</span><span class="fu">addBands</span>(img<span class="op">.</span><span class="fu">reduceNeighborhood</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">mean</span>()<span class="op">,</span> rect_kernel<span class="op">.</span><span class="fu">rotate</span>(i))<span class="op">.</span><span class="fu">updateMask</span>(directions<span class="op">.</span><span class="fu">eq</span>(<span class="dv">2</span><span class="op">*</span>i<span class="op">+</span><span class="dv">1</span>)))<span class="op">;</span></span>
<span id="cb70-189"><a href="#cb70-189" aria-hidden="true" tabindex="-1"></a>    dir_var <span class="op">=</span> dir_var<span class="op">.</span><span class="fu">addBands</span>(img<span class="op">.</span><span class="fu">reduceNeighborhood</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">variance</span>()<span class="op">,</span> rect_kernel<span class="op">.</span><span class="fu">rotate</span>(i))<span class="op">.</span><span class="fu">updateMask</span>(directions<span class="op">.</span><span class="fu">eq</span>(<span class="dv">2</span><span class="op">*</span>i<span class="op">+</span><span class="dv">1</span>)))<span class="op">;</span></span>
<span id="cb70-190"><a href="#cb70-190" aria-hidden="true" tabindex="-1"></a>    dir_mean <span class="op">=</span> dir_mean<span class="op">.</span><span class="fu">addBands</span>(img<span class="op">.</span><span class="fu">reduceNeighborhood</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">mean</span>()<span class="op">,</span> diag_kernel<span class="op">.</span><span class="fu">rotate</span>(i))<span class="op">.</span><span class="fu">updateMask</span>(directions<span class="op">.</span><span class="fu">eq</span>(<span class="dv">2</span><span class="op">*</span>i<span class="op">+</span><span class="dv">2</span>)))<span class="op">;</span></span>
<span id="cb70-191"><a href="#cb70-191" aria-hidden="true" tabindex="-1"></a>    dir_var <span class="op">=</span> dir_var<span class="op">.</span><span class="fu">addBands</span>(img<span class="op">.</span><span class="fu">reduceNeighborhood</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">variance</span>()<span class="op">,</span> diag_kernel<span class="op">.</span><span class="fu">rotate</span>(i))<span class="op">.</span><span class="fu">updateMask</span>(directions<span class="op">.</span><span class="fu">eq</span>(<span class="dv">2</span><span class="op">*</span>i<span class="op">+</span><span class="dv">2</span>)))<span class="op">;</span></span>
<span id="cb70-192"><a href="#cb70-192" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb70-193"><a href="#cb70-193" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-194"><a href="#cb70-194" aria-hidden="true" tabindex="-1"></a>  <span class="co">// &quot;collapse&quot; the stack into a single band image (due to masking, each pixel has just one value in it&#39;s directional band, and is otherwise masked)</span></span>
<span id="cb70-195"><a href="#cb70-195" aria-hidden="true" tabindex="-1"></a>  dir_mean <span class="op">=</span> dir_mean<span class="op">.</span><span class="fu">reduce</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">sum</span>())<span class="op">;</span></span>
<span id="cb70-196"><a href="#cb70-196" aria-hidden="true" tabindex="-1"></a>  dir_var <span class="op">=</span> dir_var<span class="op">.</span><span class="fu">reduce</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">sum</span>())<span class="op">;</span></span>
<span id="cb70-197"><a href="#cb70-197" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-198"><a href="#cb70-198" aria-hidden="true" tabindex="-1"></a>  <span class="co">// A finally generate the filtered value</span></span>
<span id="cb70-199"><a href="#cb70-199" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> varX <span class="op">=</span> dir_var<span class="op">.</span><span class="fu">subtract</span>(dir_mean<span class="op">.</span><span class="fu">multiply</span>(dir_mean)<span class="op">.</span><span class="fu">multiply</span>(sigmaV))<span class="op">.</span><span class="fu">divide</span>(sigmaV<span class="op">.</span><span class="fu">add</span>(<span class="fl">1.0</span>))<span class="op">;</span></span>
<span id="cb70-200"><a href="#cb70-200" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-201"><a href="#cb70-201" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> b <span class="op">=</span> varX<span class="op">.</span><span class="fu">divide</span>(dir_var)<span class="op">;</span></span>
<span id="cb70-202"><a href="#cb70-202" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-203"><a href="#cb70-203" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> result <span class="op">=</span> dir_mean<span class="op">.</span><span class="fu">add</span>(b<span class="op">.</span><span class="fu">multiply</span>(img<span class="op">.</span><span class="fu">subtract</span>(dir_mean)))<span class="op">;</span></span>
<span id="cb70-204"><a href="#cb70-204" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span>(result<span class="op">.</span><span class="fu">arrayFlatten</span>([[<span class="st">&#39;sum&#39;</span>]]))<span class="op">;</span></span>
<span id="cb70-205"><a href="#cb70-205" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p><a href="https://code.earthengine.google.com/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3A05-Flood_Mapping%2F05c_Apply_Masks_(exercise)" target="_blank">Try in Code Editor ↗</a></p>
</div>
</div>
<div id="calculate-flooded-area" class="section level2">
<h2>06. Calculate Flooded Area</h2>
<p>We visually inspected the flooded regions in the previous exercise, now lets us calculate the total flooded area in hectares and compute the percentage of the area flooded. We have already discussed the technique for <a href="(#calculating-area)">calculating area</a> in the earth engine.</p>
<div class="figure" style="text-align: center">
<img src="images/gee_water_resources_management/flood_area.png" alt="Flooded area" width="50%" />
<p class="caption">
Flooded area
</p>
</div>
<div class="sourceCode" id="cb71"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> admin2 <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">&#39;FAO/GAUL_SIMPLIFIED_500m/2015/level2&#39;</span>)</span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> hydrosheds <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(<span class="st">&#39;WWF/HydroSHEDS/03VFDEM&#39;</span>)</span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> gsw <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(<span class="st">&#39;JRC/GSW1_3/GlobalSurfaceWater&#39;</span>)</span>
<span id="cb71-4"><a href="#cb71-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-5"><a href="#cb71-5" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> beforeStart <span class="op">=</span> <span class="st">&#39;2018-07-15&#39;</span></span>
<span id="cb71-6"><a href="#cb71-6" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> beforeEnd <span class="op">=</span> <span class="st">&#39;2018-08-10&#39;</span></span>
<span id="cb71-7"><a href="#cb71-7" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> afterStart <span class="op">=</span> <span class="st">&#39;2018-08-10&#39;</span></span>
<span id="cb71-8"><a href="#cb71-8" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> afterEnd <span class="op">=</span> <span class="st">&#39;2018-08-23&#39;</span></span>
<span id="cb71-9"><a href="#cb71-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-10"><a href="#cb71-10" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> ernakulam <span class="op">=</span> admin2<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;ADM2_NAME&#39;</span><span class="op">,</span> <span class="st">&#39;Ernakulam&#39;</span>))</span>
<span id="cb71-11"><a href="#cb71-11" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> geometry <span class="op">=</span> ernakulam<span class="op">.</span><span class="fu">geometry</span>()</span>
<span id="cb71-12"><a href="#cb71-12" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(geometry<span class="op">,</span> {<span class="dt">color</span><span class="op">:</span> <span class="st">&#39;grey&#39;</span>}<span class="op">,</span> <span class="st">&#39;Ernakulam District&#39;</span>)</span>
<span id="cb71-13"><a href="#cb71-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-14"><a href="#cb71-14" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> collection<span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&#39;COPERNICUS/S1_GRD&#39;</span>)</span>
<span id="cb71-15"><a href="#cb71-15" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;instrumentMode&#39;</span><span class="op">,</span><span class="st">&#39;IW&#39;</span>))</span>
<span id="cb71-16"><a href="#cb71-16" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">listContains</span>(<span class="st">&#39;transmitterReceiverPolarisation&#39;</span><span class="op">,</span> <span class="st">&#39;VH&#39;</span>))</span>
<span id="cb71-17"><a href="#cb71-17" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;orbitProperties_pass&#39;</span><span class="op">,</span> <span class="st">&#39;DESCENDING&#39;</span>)) </span>
<span id="cb71-18"><a href="#cb71-18" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;resolution_meters&#39;</span><span class="op">,</span><span class="dv">10</span>))</span>
<span id="cb71-19"><a href="#cb71-19" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">bounds</span>(geometry))</span>
<span id="cb71-20"><a href="#cb71-20" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;VH&#39;</span>)<span class="op">;</span></span>
<span id="cb71-21"><a href="#cb71-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-22"><a href="#cb71-22" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> beforeCollection <span class="op">=</span> collection</span>
<span id="cb71-23"><a href="#cb71-23" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(beforeStart<span class="op">,</span> beforeEnd))</span>
<span id="cb71-24"><a href="#cb71-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-25"><a href="#cb71-25" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> afterCollection <span class="op">=</span> collection</span>
<span id="cb71-26"><a href="#cb71-26" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(afterStart<span class="op">,</span> afterEnd))</span>
<span id="cb71-27"><a href="#cb71-27" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb71-28"><a href="#cb71-28" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> before <span class="op">=</span> beforeCollection<span class="op">.</span><span class="fu">mosaic</span>()<span class="op">.</span><span class="fu">clip</span>(geometry)<span class="op">;</span></span>
<span id="cb71-29"><a href="#cb71-29" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> after <span class="op">=</span> afterCollection<span class="op">.</span><span class="fu">mosaic</span>()<span class="op">.</span><span class="fu">clip</span>(geometry)<span class="op">;</span></span>
<span id="cb71-30"><a href="#cb71-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-31"><a href="#cb71-31" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> beforeFiltered <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(<span class="fu">toDB</span>(<span class="fu">RefinedLee</span>(<span class="fu">toNatural</span>(before))))</span>
<span id="cb71-32"><a href="#cb71-32" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> afterFiltered <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(<span class="fu">toDB</span>(<span class="fu">RefinedLee</span>(<span class="fu">toNatural</span>(after))))</span>
<span id="cb71-33"><a href="#cb71-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-34"><a href="#cb71-34" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> difference <span class="op">=</span> afterFiltered<span class="op">.</span><span class="fu">divide</span>(beforeFiltered)<span class="op">;</span></span>
<span id="cb71-35"><a href="#cb71-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-36"><a href="#cb71-36" aria-hidden="true" tabindex="-1"></a><span class="co">// Define a threshold</span></span>
<span id="cb71-37"><a href="#cb71-37" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> diffThreshold <span class="op">=</span> <span class="fl">1.25</span><span class="op">;</span></span>
<span id="cb71-38"><a href="#cb71-38" aria-hidden="true" tabindex="-1"></a><span class="co">// Initial estimate of flooded pixels</span></span>
<span id="cb71-39"><a href="#cb71-39" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> flooded <span class="op">=</span> difference<span class="op">.</span><span class="fu">gt</span>(diffThreshold)<span class="op">.</span><span class="fu">rename</span>(<span class="st">&#39;water&#39;</span>)<span class="op">.</span><span class="fu">selfMask</span>()<span class="op">;</span></span>
<span id="cb71-40"><a href="#cb71-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-41"><a href="#cb71-41" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">centerObject</span>(geometry<span class="op">,</span> <span class="dv">10</span>)</span>
<span id="cb71-42"><a href="#cb71-42" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(before<span class="op">,</span> {<span class="dt">min</span><span class="op">:-</span><span class="dv">25</span><span class="op">,</span><span class="dt">max</span><span class="op">:</span><span class="dv">0</span>}<span class="op">,</span> <span class="st">&#39;Before Floods&#39;</span><span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span></span>
<span id="cb71-43"><a href="#cb71-43" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(after<span class="op">,</span> {<span class="dt">min</span><span class="op">:-</span><span class="dv">25</span><span class="op">,</span><span class="dt">max</span><span class="op">:</span><span class="dv">0</span>}<span class="op">,</span> <span class="st">&#39;After Floods&#39;</span><span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span> </span>
<span id="cb71-44"><a href="#cb71-44" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(beforeFiltered<span class="op">,</span> {<span class="dt">min</span><span class="op">:-</span><span class="dv">25</span><span class="op">,</span><span class="dt">max</span><span class="op">:</span><span class="dv">0</span>}<span class="op">,</span> <span class="st">&#39;Before Filtered&#39;</span><span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span></span>
<span id="cb71-45"><a href="#cb71-45" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(afterFiltered<span class="op">,</span> {<span class="dt">min</span><span class="op">:-</span><span class="dv">25</span><span class="op">,</span><span class="dt">max</span><span class="op">:</span><span class="dv">0</span>}<span class="op">,</span> <span class="st">&#39;After Filtered&#39;</span><span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span> </span>
<span id="cb71-46"><a href="#cb71-46" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(flooded<span class="op">,</span> {<span class="dt">min</span><span class="op">:</span><span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span><span class="dv">1</span><span class="op">,</span> <span class="dt">palette</span><span class="op">:</span> [<span class="st">&#39;orange&#39;</span>]}<span class="op">,</span> <span class="st">&#39;Initial Flood Area&#39;</span><span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span></span>
<span id="cb71-47"><a href="#cb71-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-48"><a href="#cb71-48" aria-hidden="true" tabindex="-1"></a><span class="co">// Mask out area with permanent/semi-permanent water</span></span>
<span id="cb71-49"><a href="#cb71-49" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> permanentWater <span class="op">=</span> gsw<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;seasonality&#39;</span>)<span class="op">.</span><span class="fu">gte</span>(<span class="dv">5</span>)<span class="op">.</span><span class="fu">clip</span>(geometry)</span>
<span id="cb71-50"><a href="#cb71-50" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> permanentWaterMask <span class="op">=</span> permanentWater<span class="op">.</span><span class="fu">unmask</span>(<span class="dv">0</span>)<span class="op">.</span><span class="fu">not</span>()</span>
<span id="cb71-51"><a href="#cb71-51" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> flooded <span class="op">=</span> flooded<span class="op">.</span><span class="fu">updateMask</span>(permanentWaterMask)</span>
<span id="cb71-52"><a href="#cb71-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-53"><a href="#cb71-53" aria-hidden="true" tabindex="-1"></a><span class="co">// Mask out areas with more than 5 percent slope using the HydroSHEDS DEM</span></span>
<span id="cb71-54"><a href="#cb71-54" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> slopeThreshold <span class="op">=</span> <span class="dv">5</span><span class="op">;</span></span>
<span id="cb71-55"><a href="#cb71-55" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> terrain <span class="op">=</span> ee<span class="op">.</span><span class="at">Algorithms</span><span class="op">.</span><span class="fu">Terrain</span>(hydrosheds)<span class="op">;</span></span>
<span id="cb71-56"><a href="#cb71-56" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> slope <span class="op">=</span> terrain<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;slope&#39;</span>)<span class="op">;</span></span>
<span id="cb71-57"><a href="#cb71-57" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> steepAreas <span class="op">=</span> slope<span class="op">.</span><span class="fu">gt</span>(slopeThreshold)</span>
<span id="cb71-58"><a href="#cb71-58" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> slopeMask <span class="op">=</span> steepAreas<span class="op">.</span><span class="fu">not</span>()</span>
<span id="cb71-59"><a href="#cb71-59" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> flooded <span class="op">=</span> flooded<span class="op">.</span><span class="fu">updateMask</span>(slopeMask)</span>
<span id="cb71-60"><a href="#cb71-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-61"><a href="#cb71-61" aria-hidden="true" tabindex="-1"></a><span class="co">// Remove isolated pixels</span></span>
<span id="cb71-62"><a href="#cb71-62" aria-hidden="true" tabindex="-1"></a><span class="co">// connectedPixelCount is Zoom dependent, so visual result will vary</span></span>
<span id="cb71-63"><a href="#cb71-63" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> connectedPixelThreshold <span class="op">=</span> <span class="dv">8</span><span class="op">;</span></span>
<span id="cb71-64"><a href="#cb71-64" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> connections <span class="op">=</span> flooded<span class="op">.</span><span class="fu">connectedPixelCount</span>(<span class="dv">25</span>)</span>
<span id="cb71-65"><a href="#cb71-65" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> disconnectedAreas <span class="op">=</span> connections<span class="op">.</span><span class="fu">lt</span>(connectedPixelThreshold)</span>
<span id="cb71-66"><a href="#cb71-66" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> disconnectedAreasMask <span class="op">=</span> disconnectedAreas<span class="op">.</span><span class="fu">not</span>()</span>
<span id="cb71-67"><a href="#cb71-67" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> flooded <span class="op">=</span> flooded<span class="op">.</span><span class="fu">updateMask</span>(disconnectedAreasMask)</span>
<span id="cb71-68"><a href="#cb71-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-69"><a href="#cb71-69" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(flooded<span class="op">,</span> {<span class="dt">min</span><span class="op">:</span><span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span><span class="dv">1</span><span class="op">,</span> <span class="dt">palette</span><span class="op">:</span> [<span class="st">&#39;red&#39;</span>]}<span class="op">,</span> <span class="st">&#39;Flooded Areas&#39;</span>)<span class="op">;</span></span>
<span id="cb71-70"><a href="#cb71-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-71"><a href="#cb71-71" aria-hidden="true" tabindex="-1"></a><span class="co">// Calculate Affected Area</span></span>
<span id="cb71-72"><a href="#cb71-72" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="st">&#39;Total District Area (Ha)&#39;</span><span class="op">,</span> geometry<span class="op">.</span><span class="fu">area</span>()<span class="op">.</span><span class="fu">divide</span>(<span class="dv">10000</span>))</span>
<span id="cb71-73"><a href="#cb71-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-74"><a href="#cb71-74" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> stats <span class="op">=</span> flooded<span class="op">.</span><span class="fu">multiply</span>(ee<span class="op">.</span><span class="at">Image</span><span class="op">.</span><span class="fu">pixelArea</span>())<span class="op">.</span><span class="fu">reduceRegion</span>({</span>
<span id="cb71-75"><a href="#cb71-75" aria-hidden="true" tabindex="-1"></a>  <span class="dt">reducer</span><span class="op">:</span> ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">sum</span>()<span class="op">,</span></span>
<span id="cb71-76"><a href="#cb71-76" aria-hidden="true" tabindex="-1"></a>  <span class="dt">geometry</span><span class="op">:</span> geometry<span class="op">,</span></span>
<span id="cb71-77"><a href="#cb71-77" aria-hidden="true" tabindex="-1"></a>  <span class="dt">scale</span><span class="op">:</span> <span class="dv">10</span><span class="op">,</span></span>
<span id="cb71-78"><a href="#cb71-78" aria-hidden="true" tabindex="-1"></a>  <span class="dt">maxPixels</span><span class="op">:</span> <span class="fl">1e10</span><span class="op">,</span></span>
<span id="cb71-79"><a href="#cb71-79" aria-hidden="true" tabindex="-1"></a>  <span class="dt">tileScale</span><span class="op">:</span> <span class="dv">16</span></span>
<span id="cb71-80"><a href="#cb71-80" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb71-81"><a href="#cb71-81" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="st">&#39;Flooded Area (Ha)&#39;</span><span class="op">,</span> ee<span class="op">.</span><span class="fu">Number</span>(stats<span class="op">.</span><span class="fu">get</span>(<span class="st">&#39;water&#39;</span>))<span class="op">.</span><span class="fu">divide</span>(<span class="dv">10000</span>))</span>
<span id="cb71-82"><a href="#cb71-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-83"><a href="#cb71-83" aria-hidden="true" tabindex="-1"></a><span class="co">//############################</span></span>
<span id="cb71-84"><a href="#cb71-84" aria-hidden="true" tabindex="-1"></a><span class="co">// Speckle Filtering Functions</span></span>
<span id="cb71-85"><a href="#cb71-85" aria-hidden="true" tabindex="-1"></a><span class="co">//############################</span></span>
<span id="cb71-86"><a href="#cb71-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-87"><a href="#cb71-87" aria-hidden="true" tabindex="-1"></a><span class="co">// Function to convert from dB</span></span>
<span id="cb71-88"><a href="#cb71-88" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">toNatural</span>(img) {</span>
<span id="cb71-89"><a href="#cb71-89" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> ee<span class="op">.</span><span class="fu">Image</span>(<span class="fl">10.0</span>)<span class="op">.</span><span class="fu">pow</span>(img<span class="op">.</span><span class="fu">select</span>(<span class="dv">0</span>)<span class="op">.</span><span class="fu">divide</span>(<span class="fl">10.0</span>))<span class="op">;</span></span>
<span id="cb71-90"><a href="#cb71-90" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb71-91"><a href="#cb71-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-92"><a href="#cb71-92" aria-hidden="true" tabindex="-1"></a><span class="co">//Function to convert to dB</span></span>
<span id="cb71-93"><a href="#cb71-93" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">toDB</span>(img) {</span>
<span id="cb71-94"><a href="#cb71-94" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> ee<span class="op">.</span><span class="fu">Image</span>(img)<span class="op">.</span><span class="fu">log10</span>()<span class="op">.</span><span class="fu">multiply</span>(<span class="fl">10.0</span>)<span class="op">;</span></span>
<span id="cb71-95"><a href="#cb71-95" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb71-96"><a href="#cb71-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-97"><a href="#cb71-97" aria-hidden="true" tabindex="-1"></a><span class="co">//Apllying a Refined Lee Speckle filter as coded in the SNAP 3.0 S1TBX:</span></span>
<span id="cb71-98"><a href="#cb71-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-99"><a href="#cb71-99" aria-hidden="true" tabindex="-1"></a><span class="co">//https://github.com/senbox-org/s1tbx/blob/master/s1tbx-op-sar-processing/src/main/java/org/esa/s1tbx/sar/gpf/filtering/SpeckleFilters/RefinedLee.java</span></span>
<span id="cb71-100"><a href="#cb71-100" aria-hidden="true" tabindex="-1"></a><span class="co">//Adapted by Guido Lemoine</span></span>
<span id="cb71-101"><a href="#cb71-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-102"><a href="#cb71-102" aria-hidden="true" tabindex="-1"></a><span class="co">// by Guido Lemoine</span></span>
<span id="cb71-103"><a href="#cb71-103" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">RefinedLee</span>(img) {</span>
<span id="cb71-104"><a href="#cb71-104" aria-hidden="true" tabindex="-1"></a>  <span class="co">// img must be in natural units, i.e. not in dB!</span></span>
<span id="cb71-105"><a href="#cb71-105" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Set up 3x3 kernels </span></span>
<span id="cb71-106"><a href="#cb71-106" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> weights3 <span class="op">=</span> ee<span class="op">.</span><span class="at">List</span><span class="op">.</span><span class="fu">repeat</span>(ee<span class="op">.</span><span class="at">List</span><span class="op">.</span><span class="fu">repeat</span>(<span class="dv">1</span><span class="op">,</span><span class="dv">3</span>)<span class="op">,</span><span class="dv">3</span>)<span class="op">;</span></span>
<span id="cb71-107"><a href="#cb71-107" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> kernel3 <span class="op">=</span> ee<span class="op">.</span><span class="at">Kernel</span><span class="op">.</span><span class="fu">fixed</span>(<span class="dv">3</span><span class="op">,</span><span class="dv">3</span><span class="op">,</span> weights3<span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span></span>
<span id="cb71-108"><a href="#cb71-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-109"><a href="#cb71-109" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> mean3 <span class="op">=</span> img<span class="op">.</span><span class="fu">reduceNeighborhood</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">mean</span>()<span class="op">,</span> kernel3)<span class="op">;</span></span>
<span id="cb71-110"><a href="#cb71-110" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> variance3 <span class="op">=</span> img<span class="op">.</span><span class="fu">reduceNeighborhood</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">variance</span>()<span class="op">,</span> kernel3)<span class="op">;</span></span>
<span id="cb71-111"><a href="#cb71-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-112"><a href="#cb71-112" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Use a sample of the 3x3 windows inside a 7x7 windows to determine gradients and directions</span></span>
<span id="cb71-113"><a href="#cb71-113" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> sample_weights <span class="op">=</span> ee<span class="op">.</span><span class="fu">List</span>([[<span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span>]<span class="op">,</span> [<span class="dv">0</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span>]<span class="op">,</span>[<span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span>]<span class="op">,</span> [<span class="dv">0</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span>]<span class="op">,</span> [<span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span>]<span class="op">,</span> [<span class="dv">0</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span>]<span class="op">,</span>[<span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span>]])<span class="op">;</span></span>
<span id="cb71-114"><a href="#cb71-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-115"><a href="#cb71-115" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> sample_kernel <span class="op">=</span> ee<span class="op">.</span><span class="at">Kernel</span><span class="op">.</span><span class="fu">fixed</span>(<span class="dv">7</span><span class="op">,</span><span class="dv">7</span><span class="op">,</span> sample_weights<span class="op">,</span> <span class="dv">3</span><span class="op">,</span><span class="dv">3</span><span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span></span>
<span id="cb71-116"><a href="#cb71-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-117"><a href="#cb71-117" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Calculate mean and variance for the sampled windows and store as 9 bands</span></span>
<span id="cb71-118"><a href="#cb71-118" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> sample_mean <span class="op">=</span> mean3<span class="op">.</span><span class="fu">neighborhoodToBands</span>(sample_kernel)<span class="op">;</span> </span>
<span id="cb71-119"><a href="#cb71-119" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> sample_var <span class="op">=</span> variance3<span class="op">.</span><span class="fu">neighborhoodToBands</span>(sample_kernel)<span class="op">;</span></span>
<span id="cb71-120"><a href="#cb71-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-121"><a href="#cb71-121" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Determine the 4 gradients for the sampled windows</span></span>
<span id="cb71-122"><a href="#cb71-122" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> gradients <span class="op">=</span> sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">1</span>)<span class="op">.</span><span class="fu">subtract</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">7</span>))<span class="op">.</span><span class="fu">abs</span>()<span class="op">;</span></span>
<span id="cb71-123"><a href="#cb71-123" aria-hidden="true" tabindex="-1"></a>  gradients <span class="op">=</span> gradients<span class="op">.</span><span class="fu">addBands</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">6</span>)<span class="op">.</span><span class="fu">subtract</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">2</span>))<span class="op">.</span><span class="fu">abs</span>())<span class="op">;</span></span>
<span id="cb71-124"><a href="#cb71-124" aria-hidden="true" tabindex="-1"></a>  gradients <span class="op">=</span> gradients<span class="op">.</span><span class="fu">addBands</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">3</span>)<span class="op">.</span><span class="fu">subtract</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">5</span>))<span class="op">.</span><span class="fu">abs</span>())<span class="op">;</span></span>
<span id="cb71-125"><a href="#cb71-125" aria-hidden="true" tabindex="-1"></a>  gradients <span class="op">=</span> gradients<span class="op">.</span><span class="fu">addBands</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">0</span>)<span class="op">.</span><span class="fu">subtract</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">8</span>))<span class="op">.</span><span class="fu">abs</span>())<span class="op">;</span></span>
<span id="cb71-126"><a href="#cb71-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-127"><a href="#cb71-127" aria-hidden="true" tabindex="-1"></a>  <span class="co">// And find the maximum gradient amongst gradient bands</span></span>
<span id="cb71-128"><a href="#cb71-128" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> max_gradient <span class="op">=</span> gradients<span class="op">.</span><span class="fu">reduce</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">max</span>())<span class="op">;</span></span>
<span id="cb71-129"><a href="#cb71-129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-130"><a href="#cb71-130" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Create a mask for band pixels that are the maximum gradient</span></span>
<span id="cb71-131"><a href="#cb71-131" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> gradmask <span class="op">=</span> gradients<span class="op">.</span><span class="fu">eq</span>(max_gradient)<span class="op">;</span></span>
<span id="cb71-132"><a href="#cb71-132" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-133"><a href="#cb71-133" aria-hidden="true" tabindex="-1"></a>  <span class="co">// duplicate gradmask bands: each gradient represents 2 directions</span></span>
<span id="cb71-134"><a href="#cb71-134" aria-hidden="true" tabindex="-1"></a>  gradmask <span class="op">=</span> gradmask<span class="op">.</span><span class="fu">addBands</span>(gradmask)<span class="op">;</span></span>
<span id="cb71-135"><a href="#cb71-135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-136"><a href="#cb71-136" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Determine the 8 directions</span></span>
<span id="cb71-137"><a href="#cb71-137" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> directions <span class="op">=</span> sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">1</span>)<span class="op">.</span><span class="fu">subtract</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">4</span>))<span class="op">.</span><span class="fu">gt</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">4</span>)<span class="op">.</span><span class="fu">subtract</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">7</span>)))<span class="op">.</span><span class="fu">multiply</span>(<span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb71-138"><a href="#cb71-138" aria-hidden="true" tabindex="-1"></a>  directions <span class="op">=</span> directions<span class="op">.</span><span class="fu">addBands</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">6</span>)<span class="op">.</span><span class="fu">subtract</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">4</span>))<span class="op">.</span><span class="fu">gt</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">4</span>)<span class="op">.</span><span class="fu">subtract</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">2</span>)))<span class="op">.</span><span class="fu">multiply</span>(<span class="dv">2</span>))<span class="op">;</span></span>
<span id="cb71-139"><a href="#cb71-139" aria-hidden="true" tabindex="-1"></a>  directions <span class="op">=</span> directions<span class="op">.</span><span class="fu">addBands</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">3</span>)<span class="op">.</span><span class="fu">subtract</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">4</span>))<span class="op">.</span><span class="fu">gt</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">4</span>)<span class="op">.</span><span class="fu">subtract</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">5</span>)))<span class="op">.</span><span class="fu">multiply</span>(<span class="dv">3</span>))<span class="op">;</span></span>
<span id="cb71-140"><a href="#cb71-140" aria-hidden="true" tabindex="-1"></a>  directions <span class="op">=</span> directions<span class="op">.</span><span class="fu">addBands</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">0</span>)<span class="op">.</span><span class="fu">subtract</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">4</span>))<span class="op">.</span><span class="fu">gt</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">4</span>)<span class="op">.</span><span class="fu">subtract</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">8</span>)))<span class="op">.</span><span class="fu">multiply</span>(<span class="dv">4</span>))<span class="op">;</span></span>
<span id="cb71-141"><a href="#cb71-141" aria-hidden="true" tabindex="-1"></a>  <span class="co">// The next 4 are the not() of the previous 4</span></span>
<span id="cb71-142"><a href="#cb71-142" aria-hidden="true" tabindex="-1"></a>  directions <span class="op">=</span> directions<span class="op">.</span><span class="fu">addBands</span>(directions<span class="op">.</span><span class="fu">select</span>(<span class="dv">0</span>)<span class="op">.</span><span class="fu">not</span>()<span class="op">.</span><span class="fu">multiply</span>(<span class="dv">5</span>))<span class="op">;</span></span>
<span id="cb71-143"><a href="#cb71-143" aria-hidden="true" tabindex="-1"></a>  directions <span class="op">=</span> directions<span class="op">.</span><span class="fu">addBands</span>(directions<span class="op">.</span><span class="fu">select</span>(<span class="dv">1</span>)<span class="op">.</span><span class="fu">not</span>()<span class="op">.</span><span class="fu">multiply</span>(<span class="dv">6</span>))<span class="op">;</span></span>
<span id="cb71-144"><a href="#cb71-144" aria-hidden="true" tabindex="-1"></a>  directions <span class="op">=</span> directions<span class="op">.</span><span class="fu">addBands</span>(directions<span class="op">.</span><span class="fu">select</span>(<span class="dv">2</span>)<span class="op">.</span><span class="fu">not</span>()<span class="op">.</span><span class="fu">multiply</span>(<span class="dv">7</span>))<span class="op">;</span></span>
<span id="cb71-145"><a href="#cb71-145" aria-hidden="true" tabindex="-1"></a>  directions <span class="op">=</span> directions<span class="op">.</span><span class="fu">addBands</span>(directions<span class="op">.</span><span class="fu">select</span>(<span class="dv">3</span>)<span class="op">.</span><span class="fu">not</span>()<span class="op">.</span><span class="fu">multiply</span>(<span class="dv">8</span>))<span class="op">;</span></span>
<span id="cb71-146"><a href="#cb71-146" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-147"><a href="#cb71-147" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Mask all values that are not 1-8</span></span>
<span id="cb71-148"><a href="#cb71-148" aria-hidden="true" tabindex="-1"></a>  directions <span class="op">=</span> directions<span class="op">.</span><span class="fu">updateMask</span>(gradmask)<span class="op">;</span></span>
<span id="cb71-149"><a href="#cb71-149" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-150"><a href="#cb71-150" aria-hidden="true" tabindex="-1"></a>  <span class="co">// &quot;collapse&quot; the stack into a singe band image (due to masking, each pixel has just one value (1-8) in it&#39;s directional band, and is otherwise masked)</span></span>
<span id="cb71-151"><a href="#cb71-151" aria-hidden="true" tabindex="-1"></a>  directions <span class="op">=</span> directions<span class="op">.</span><span class="fu">reduce</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">sum</span>())<span class="op">;</span>  </span>
<span id="cb71-152"><a href="#cb71-152" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-153"><a href="#cb71-153" aria-hidden="true" tabindex="-1"></a>  <span class="co">//var pal = [&#39;ffffff&#39;,&#39;ff0000&#39;,&#39;ffff00&#39;, &#39;00ff00&#39;, &#39;00ffff&#39;, &#39;0000ff&#39;, &#39;ff00ff&#39;, &#39;000000&#39;];</span></span>
<span id="cb71-154"><a href="#cb71-154" aria-hidden="true" tabindex="-1"></a>  <span class="co">//Map.addLayer(directions.reduce(ee.Reducer.sum()), {min:1, max:8, palette: pal}, &#39;Directions&#39;, false);</span></span>
<span id="cb71-155"><a href="#cb71-155" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-156"><a href="#cb71-156" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> sample_stats <span class="op">=</span> sample_var<span class="op">.</span><span class="fu">divide</span>(sample_mean<span class="op">.</span><span class="fu">multiply</span>(sample_mean))<span class="op">;</span></span>
<span id="cb71-157"><a href="#cb71-157" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-158"><a href="#cb71-158" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Calculate localNoiseVariance</span></span>
<span id="cb71-159"><a href="#cb71-159" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> sigmaV <span class="op">=</span> sample_stats<span class="op">.</span><span class="fu">toArray</span>()<span class="op">.</span><span class="fu">arraySort</span>()<span class="op">.</span><span class="fu">arraySlice</span>(<span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">5</span>)<span class="op">.</span><span class="fu">arrayReduce</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">mean</span>()<span class="op">,</span> [<span class="dv">0</span>])<span class="op">;</span></span>
<span id="cb71-160"><a href="#cb71-160" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-161"><a href="#cb71-161" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Set up the 7*7 kernels for directional statistics</span></span>
<span id="cb71-162"><a href="#cb71-162" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> rect_weights <span class="op">=</span> ee<span class="op">.</span><span class="at">List</span><span class="op">.</span><span class="fu">repeat</span>(ee<span class="op">.</span><span class="at">List</span><span class="op">.</span><span class="fu">repeat</span>(<span class="dv">0</span><span class="op">,</span><span class="dv">7</span>)<span class="op">,</span><span class="dv">3</span>)<span class="op">.</span><span class="fu">cat</span>(ee<span class="op">.</span><span class="at">List</span><span class="op">.</span><span class="fu">repeat</span>(ee<span class="op">.</span><span class="at">List</span><span class="op">.</span><span class="fu">repeat</span>(<span class="dv">1</span><span class="op">,</span><span class="dv">7</span>)<span class="op">,</span><span class="dv">4</span>))<span class="op">;</span></span>
<span id="cb71-163"><a href="#cb71-163" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-164"><a href="#cb71-164" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> diag_weights <span class="op">=</span> ee<span class="op">.</span><span class="fu">List</span>([[<span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span>]<span class="op">,</span> [<span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span>]<span class="op">,</span> [<span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span>]<span class="op">,</span> </span>
<span id="cb71-165"><a href="#cb71-165" aria-hidden="true" tabindex="-1"></a>    [<span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span>]<span class="op">,</span> [<span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span>]<span class="op">,</span> [<span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span>]<span class="op">,</span> [<span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span>]])<span class="op">;</span></span>
<span id="cb71-166"><a href="#cb71-166" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-167"><a href="#cb71-167" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> rect_kernel <span class="op">=</span> ee<span class="op">.</span><span class="at">Kernel</span><span class="op">.</span><span class="fu">fixed</span>(<span class="dv">7</span><span class="op">,</span><span class="dv">7</span><span class="op">,</span> rect_weights<span class="op">,</span> <span class="dv">3</span><span class="op">,</span> <span class="dv">3</span><span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span></span>
<span id="cb71-168"><a href="#cb71-168" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> diag_kernel <span class="op">=</span> ee<span class="op">.</span><span class="at">Kernel</span><span class="op">.</span><span class="fu">fixed</span>(<span class="dv">7</span><span class="op">,</span><span class="dv">7</span><span class="op">,</span> diag_weights<span class="op">,</span> <span class="dv">3</span><span class="op">,</span> <span class="dv">3</span><span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span></span>
<span id="cb71-169"><a href="#cb71-169" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-170"><a href="#cb71-170" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Create stacks for mean and variance using the original kernels. Mask with relevant direction.</span></span>
<span id="cb71-171"><a href="#cb71-171" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> dir_mean <span class="op">=</span> img<span class="op">.</span><span class="fu">reduceNeighborhood</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">mean</span>()<span class="op">,</span> rect_kernel)<span class="op">.</span><span class="fu">updateMask</span>(directions<span class="op">.</span><span class="fu">eq</span>(<span class="dv">1</span>))<span class="op">;</span></span>
<span id="cb71-172"><a href="#cb71-172" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> dir_var <span class="op">=</span> img<span class="op">.</span><span class="fu">reduceNeighborhood</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">variance</span>()<span class="op">,</span> rect_kernel)<span class="op">.</span><span class="fu">updateMask</span>(directions<span class="op">.</span><span class="fu">eq</span>(<span class="dv">1</span>))<span class="op">;</span></span>
<span id="cb71-173"><a href="#cb71-173" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-174"><a href="#cb71-174" aria-hidden="true" tabindex="-1"></a>  dir_mean <span class="op">=</span> dir_mean<span class="op">.</span><span class="fu">addBands</span>(img<span class="op">.</span><span class="fu">reduceNeighborhood</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">mean</span>()<span class="op">,</span> diag_kernel)<span class="op">.</span><span class="fu">updateMask</span>(directions<span class="op">.</span><span class="fu">eq</span>(<span class="dv">2</span>)))<span class="op">;</span></span>
<span id="cb71-175"><a href="#cb71-175" aria-hidden="true" tabindex="-1"></a>  dir_var <span class="op">=</span> dir_var<span class="op">.</span><span class="fu">addBands</span>(img<span class="op">.</span><span class="fu">reduceNeighborhood</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">variance</span>()<span class="op">,</span> diag_kernel)<span class="op">.</span><span class="fu">updateMask</span>(directions<span class="op">.</span><span class="fu">eq</span>(<span class="dv">2</span>)))<span class="op">;</span></span>
<span id="cb71-176"><a href="#cb71-176" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-177"><a href="#cb71-177" aria-hidden="true" tabindex="-1"></a>  <span class="co">// and add the bands for rotated kernels</span></span>
<span id="cb71-178"><a href="#cb71-178" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (<span class="kw">var</span> i<span class="op">=</span><span class="dv">1</span><span class="op">;</span> i<span class="op">&lt;</span><span class="dv">4</span><span class="op">;</span> i<span class="op">++</span>) {</span>
<span id="cb71-179"><a href="#cb71-179" aria-hidden="true" tabindex="-1"></a>    dir_mean <span class="op">=</span> dir_mean<span class="op">.</span><span class="fu">addBands</span>(img<span class="op">.</span><span class="fu">reduceNeighborhood</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">mean</span>()<span class="op">,</span> rect_kernel<span class="op">.</span><span class="fu">rotate</span>(i))<span class="op">.</span><span class="fu">updateMask</span>(directions<span class="op">.</span><span class="fu">eq</span>(<span class="dv">2</span><span class="op">*</span>i<span class="op">+</span><span class="dv">1</span>)))<span class="op">;</span></span>
<span id="cb71-180"><a href="#cb71-180" aria-hidden="true" tabindex="-1"></a>    dir_var <span class="op">=</span> dir_var<span class="op">.</span><span class="fu">addBands</span>(img<span class="op">.</span><span class="fu">reduceNeighborhood</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">variance</span>()<span class="op">,</span> rect_kernel<span class="op">.</span><span class="fu">rotate</span>(i))<span class="op">.</span><span class="fu">updateMask</span>(directions<span class="op">.</span><span class="fu">eq</span>(<span class="dv">2</span><span class="op">*</span>i<span class="op">+</span><span class="dv">1</span>)))<span class="op">;</span></span>
<span id="cb71-181"><a href="#cb71-181" aria-hidden="true" tabindex="-1"></a>    dir_mean <span class="op">=</span> dir_mean<span class="op">.</span><span class="fu">addBands</span>(img<span class="op">.</span><span class="fu">reduceNeighborhood</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">mean</span>()<span class="op">,</span> diag_kernel<span class="op">.</span><span class="fu">rotate</span>(i))<span class="op">.</span><span class="fu">updateMask</span>(directions<span class="op">.</span><span class="fu">eq</span>(<span class="dv">2</span><span class="op">*</span>i<span class="op">+</span><span class="dv">2</span>)))<span class="op">;</span></span>
<span id="cb71-182"><a href="#cb71-182" aria-hidden="true" tabindex="-1"></a>    dir_var <span class="op">=</span> dir_var<span class="op">.</span><span class="fu">addBands</span>(img<span class="op">.</span><span class="fu">reduceNeighborhood</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">variance</span>()<span class="op">,</span> diag_kernel<span class="op">.</span><span class="fu">rotate</span>(i))<span class="op">.</span><span class="fu">updateMask</span>(directions<span class="op">.</span><span class="fu">eq</span>(<span class="dv">2</span><span class="op">*</span>i<span class="op">+</span><span class="dv">2</span>)))<span class="op">;</span></span>
<span id="cb71-183"><a href="#cb71-183" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb71-184"><a href="#cb71-184" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-185"><a href="#cb71-185" aria-hidden="true" tabindex="-1"></a>  <span class="co">// &quot;collapse&quot; the stack into a single band image (due to masking, each pixel has just one value in it&#39;s directional band, and is otherwise masked)</span></span>
<span id="cb71-186"><a href="#cb71-186" aria-hidden="true" tabindex="-1"></a>  dir_mean <span class="op">=</span> dir_mean<span class="op">.</span><span class="fu">reduce</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">sum</span>())<span class="op">;</span></span>
<span id="cb71-187"><a href="#cb71-187" aria-hidden="true" tabindex="-1"></a>  dir_var <span class="op">=</span> dir_var<span class="op">.</span><span class="fu">reduce</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">sum</span>())<span class="op">;</span></span>
<span id="cb71-188"><a href="#cb71-188" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-189"><a href="#cb71-189" aria-hidden="true" tabindex="-1"></a>  <span class="co">// A finally generate the filtered value</span></span>
<span id="cb71-190"><a href="#cb71-190" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> varX <span class="op">=</span> dir_var<span class="op">.</span><span class="fu">subtract</span>(dir_mean<span class="op">.</span><span class="fu">multiply</span>(dir_mean)<span class="op">.</span><span class="fu">multiply</span>(sigmaV))<span class="op">.</span><span class="fu">divide</span>(sigmaV<span class="op">.</span><span class="fu">add</span>(<span class="fl">1.0</span>))<span class="op">;</span></span>
<span id="cb71-191"><a href="#cb71-191" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-192"><a href="#cb71-192" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> b <span class="op">=</span> varX<span class="op">.</span><span class="fu">divide</span>(dir_var)<span class="op">;</span></span>
<span id="cb71-193"><a href="#cb71-193" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb71-194"><a href="#cb71-194" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> result <span class="op">=</span> dir_mean<span class="op">.</span><span class="fu">add</span>(b<span class="op">.</span><span class="fu">multiply</span>(img<span class="op">.</span><span class="fu">subtract</span>(dir_mean)))<span class="op">;</span></span>
<span id="cb71-195"><a href="#cb71-195" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span>(result<span class="op">.</span><span class="fu">arrayFlatten</span>([[<span class="st">&#39;sum&#39;</span>]]))<span class="op">;</span></span>
<span id="cb71-196"><a href="#cb71-196" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p><a href="https://code.earthengine.google.com/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3A05-Flood_Mapping%2F06b_Calculate_Flooded_Area_(complete)" target="_blank">Open in Code Editor ↗</a></p>
<div id="exercise-32" class="section level3">
<h3>Exercise</h3>
<p>Printing the results in the console may timeout for more extensive computations. Convert the flood area numeric value as Feature Collection and export the area as a CSV file. The technique to export numeric values is discussed in <a href="#exporting-classification-results">Exporting Classified Result.</a></p>
<div class="sourceCode" id="cb72"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Export the result as a CSV</span></span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a><span class="co">// Export the fc as a CSV</span></span></code></pre></div>
<p><a href="https://code.earthengine.google.com/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3A05-Flood_Mapping%2F06c_Calculate_Flooded_Area_(exercise)" target="_blank">Try in Code Editor ↗</a></p>
</div>
</div>
</div>
<div id="drought-monitoring" class="section level1">
<h1>06 Drought Monitoring</h1>
<p>There are many definitions for drought, depending on the context used. Monitoring and calculating the impact of drought in large sales is quite tedious without remote sensing data. In this module, we will learn to calculate the <em>Impact of Hydrological drought</em> using the MODIS data product.</p>
<p><a href="https://docs.google.com/presentation/d/1xdq172hcxkcjlHNexxankLRx6q60Py6VepNB3M9nepM/edit?usp=sharing" target="_blank"><img src="images/gee_water_resources_management/drought_monitoring_mapping.png" width="400" alt="View Presentation" /></a></p>
<p><a href="https://docs.google.com/presentation/d/1xdq172hcxkcjlHNexxankLRx6q60Py6VepNB3M9nepM/edit?usp=sharing" target="_blank">View the Presentation ↗</a></p>
<blockquote>
<p>Apart from <em>Hydrological drought</em>, another common drought is the <em>Metrological drought</em>. To track the meteorological drought, rainfall deviation should be calculated. To know more about it, visit <a href="https://www.youtube.com/playlist?list=PLppGmFLhQ1HJ5VhW6BZfhPX6spUcTY7SR">Spatial Thought YouTube.</a></p>
</blockquote>
<div id="load-modis-ndvi" class="section level2">
<h2>01. Load MODIS NDVI</h2>
<p><a href="https://modis.gsfc.nasa.gov/about/">MODIS Moderate Resolution Imaging Spectroradiometer</a> has many derived products apart from the raw imagery captured every day. There are 2 satellite sensors, Terra and Aqua. The raw images from these satellites are used to produce different data products categorized as <em>Atmospheric products, Land products, Cryosphere products,</em> and <em>Ocean Products</em>. We will use the 16-day composite NDVI data at 250m resolution for this exercise. Also, MODIS follows a unique naming pattern, which helps identify the data.</p>
<p>The product which we use in this exercise is <code>MOD13Q1.006</code>.</p>
<table>
<colgroup>
<col width="9%" />
<col width="90%" />
</colgroup>
<thead>
<tr class="header">
<th align="left">Name</th>
<th align="left">Meaning</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">MOD</td>
<td align="left">Terra sensor</td>
</tr>
<tr class="even">
<td align="left">13Q1</td>
<td align="left">Vegetation Index at 250m</td>
</tr>
<tr class="odd">
<td align="left">.006</td>
<td align="left">Version number (<em>use the latest version available at the time of computation</em>)</td>
</tr>
</tbody>
</table>
<p>Load the <em>Terra Vegetation Indices</em> at 250m resolution and filter the collection from <em>2010</em> to <em>2020</em>. Each image has 12 bands, in which <code>NDVI</code> and <code>EVI</code> are the two vegetation indices bands, other bands contain additional information about the data at pixel level. NDVI is used to monitor vegetation, but for very thick vegetation like dense forest, NDVI value will saturate, and no helpful information can be derived. EVI is used to track and monitor thick vegetation cover.</p>
<div class="sourceCode" id="cb73"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> modis <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&quot;MODIS/006/MOD13Q1&quot;</span>)<span class="op">;</span></span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> startYear <span class="op">=</span> <span class="dv">2010</span></span>
<span id="cb73-4"><a href="#cb73-4" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> endYear <span class="op">=</span> <span class="dv">2020</span></span>
<span id="cb73-5"><a href="#cb73-5" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> startDate <span class="op">=</span> ee<span class="op">.</span><span class="at">Date</span><span class="op">.</span><span class="fu">fromYMD</span>(startYear<span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">1</span>)</span>
<span id="cb73-6"><a href="#cb73-6" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> endDate <span class="op">=</span> ee<span class="op">.</span><span class="at">Date</span><span class="op">.</span><span class="fu">fromYMD</span>(endYear<span class="op">,</span> <span class="dv">12</span><span class="op">,</span> <span class="dv">31</span>)</span>
<span id="cb73-7"><a href="#cb73-7" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> filtered <span class="op">=</span> modis</span>
<span id="cb73-8"><a href="#cb73-8" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(startDate<span class="op">,</span> endDate))</span>
<span id="cb73-9"><a href="#cb73-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-10"><a href="#cb73-10" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> modisNDVI <span class="op">=</span> filtered<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;NDVI&#39;</span>)</span>
<span id="cb73-11"><a href="#cb73-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-12"><a href="#cb73-12" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(modisNDVI)</span></code></pre></div>
<p><a href="https://code.earthengine.google.co.in/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3A06-Drought_Monitoring%2F01b_Load_MODIS_NDVI_(complete)" target="_blank">Open in Code Editor ↗</a></p>
<div id="exercise-33" class="section level3">
<h3>Exercise</h3>
<p>Add the first image to the map be visualizing it using a suitable color palette.</p>
<div class="figure" style="text-align: center">
<img src="images/gee_water_resources_management/vci_ndvi.png" alt="Visualized MODIS NDVI Image over Australia" width="50%" />
<p class="caption">
Visualized MODIS NDVI Image over Australia
</p>
</div>
<div class="sourceCode" id="cb74"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> modis <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&quot;MODIS/006/MOD13Q1&quot;</span>)<span class="op">;</span></span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-3"><a href="#cb74-3" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> startYear <span class="op">=</span> <span class="dv">2010</span></span>
<span id="cb74-4"><a href="#cb74-4" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> endYear <span class="op">=</span> <span class="dv">2020</span></span>
<span id="cb74-5"><a href="#cb74-5" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> startDate <span class="op">=</span> ee<span class="op">.</span><span class="at">Date</span><span class="op">.</span><span class="fu">fromYMD</span>(startYear<span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">1</span>)</span>
<span id="cb74-6"><a href="#cb74-6" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> endDate <span class="op">=</span> ee<span class="op">.</span><span class="at">Date</span><span class="op">.</span><span class="fu">fromYMD</span>(endYear<span class="op">,</span> <span class="dv">12</span><span class="op">,</span> <span class="dv">31</span>)</span>
<span id="cb74-7"><a href="#cb74-7" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> filtered <span class="op">=</span> modis</span>
<span id="cb74-8"><a href="#cb74-8" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(startDate<span class="op">,</span> endDate))</span>
<span id="cb74-9"><a href="#cb74-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-10"><a href="#cb74-10" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> modisNDVI <span class="op">=</span> filtered<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;NDVI&#39;</span>)</span>
<span id="cb74-11"><a href="#cb74-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-12"><a href="#cb74-12" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(modisNDVI)</span>
<span id="cb74-13"><a href="#cb74-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-14"><a href="#cb74-14" aria-hidden="true" tabindex="-1"></a><span class="co">// Exercise</span></span>
<span id="cb74-15"><a href="#cb74-15" aria-hidden="true" tabindex="-1"></a><span class="co">// Extract 1 image from the collection using the .first() function</span></span>
<span id="cb74-16"><a href="#cb74-16" aria-hidden="true" tabindex="-1"></a><span class="co">// Visualize and add it to the Map</span></span>
<span id="cb74-17"><a href="#cb74-17" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> image <span class="op">=</span> modisNDVI<span class="op">.</span><span class="fu">first</span>()</span>
<span id="cb74-18"><a href="#cb74-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb74-19"><a href="#cb74-19" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(image<span class="op">,</span> {}<span class="op">,</span> <span class="st">&#39;MODIS NDVI&#39;</span>) </span></code></pre></div>
<p><a href="https://code.earthengine.google.co.in/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3A06-Drought_Monitoring%2F01c_Load_MODIS_NDVI_(exercise)" target="_blank">Try in Code Editor ↗</a></p>
</div>
</div>
<div id="apply-cloud-mask" class="section level2">
<h2>02. Apply Cloud Mask</h2>
<p>Every image has another band <code>Summary QA</code>, and this band contains pixel-level information about the quality of data. We want to keep only the pixels with bit values 0 or 1. We will use the <code>.leftShift()</code> to create the bitmask for selecting good quality data.</p>
<blockquote>
<p>Bitmasking itself is a complex topic of discussion. Read the blog on <a href="https://spatialthoughts.com/2021/08/19/qa-bands-bitmasks-gee/">Working with QA Bands and Bitmasks</a> to know more about it.</p>
</blockquote>
<p><img src="images/gee_water_resources_management/drought_summaryQA.png" width="50%" style="display: block; margin: auto;" /></p>
<div class="sourceCode" id="cb75"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a><span class="co">/**** Start of imports. If edited, may not auto-convert in the playground. ****/</span></span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> modis <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&quot;MODIS/006/MOD13Q1&quot;</span>)<span class="op">;</span></span>
<span id="cb75-3"><a href="#cb75-3" aria-hidden="true" tabindex="-1"></a><span class="co">/***** End of imports. If edited, may not auto-convert in the playground. *****/</span></span>
<span id="cb75-4"><a href="#cb75-4" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> startYear <span class="op">=</span> <span class="dv">2010</span></span>
<span id="cb75-5"><a href="#cb75-5" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> endYear <span class="op">=</span> <span class="dv">2020</span></span>
<span id="cb75-6"><a href="#cb75-6" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> startDate <span class="op">=</span> ee<span class="op">.</span><span class="at">Date</span><span class="op">.</span><span class="fu">fromYMD</span>(startYear<span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">1</span>)</span>
<span id="cb75-7"><a href="#cb75-7" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> endDate <span class="op">=</span> ee<span class="op">.</span><span class="at">Date</span><span class="op">.</span><span class="fu">fromYMD</span>(endYear<span class="op">,</span> <span class="dv">12</span><span class="op">,</span> <span class="dv">31</span>)</span>
<span id="cb75-8"><a href="#cb75-8" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> filtered <span class="op">=</span> modis</span>
<span id="cb75-9"><a href="#cb75-9" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(startDate<span class="op">,</span> endDate))</span>
<span id="cb75-10"><a href="#cb75-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-11"><a href="#cb75-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-12"><a href="#cb75-12" aria-hidden="true" tabindex="-1"></a><span class="co">// Apply mask to remove low-quality or cloudy pixels</span></span>
<span id="cb75-13"><a href="#cb75-13" aria-hidden="true" tabindex="-1"></a><span class="co">// The data comes with a SummaryQA band</span></span>
<span id="cb75-14"><a href="#cb75-14" aria-hidden="true" tabindex="-1"></a><span class="co">// The values are stored in 2 bits - resulting in 4 possible values</span></span>
<span id="cb75-15"><a href="#cb75-15" aria-hidden="true" tabindex="-1"></a><span class="co">// 0: Good data, use with confidence</span></span>
<span id="cb75-16"><a href="#cb75-16" aria-hidden="true" tabindex="-1"></a><span class="co">// 1: Marginal data, useful but look at detailed QA for more information</span></span>
<span id="cb75-17"><a href="#cb75-17" aria-hidden="true" tabindex="-1"></a><span class="co">// 2: Pixel covered with snow/ice</span></span>
<span id="cb75-18"><a href="#cb75-18" aria-hidden="true" tabindex="-1"></a><span class="co">// 3: Pixel is cloudy</span></span>
<span id="cb75-19"><a href="#cb75-19" aria-hidden="true" tabindex="-1"></a><span class="co">// We want to keep only the pixels with bit values 0 or 1</span></span>
<span id="cb75-20"><a href="#cb75-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-21"><a href="#cb75-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-22"><a href="#cb75-22" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> bitwiseExtract <span class="op">=</span> <span class="kw">function</span>(input<span class="op">,</span> fromBit<span class="op">,</span> toBit) {</span>
<span id="cb75-23"><a href="#cb75-23" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> maskSize <span class="op">=</span> ee<span class="op">.</span><span class="fu">Number</span>(<span class="dv">1</span>)<span class="op">.</span><span class="fu">add</span>(toBit)<span class="op">.</span><span class="fu">subtract</span>(fromBit)</span>
<span id="cb75-24"><a href="#cb75-24" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> mask <span class="op">=</span> ee<span class="op">.</span><span class="fu">Number</span>(<span class="dv">1</span>)<span class="op">.</span><span class="fu">leftShift</span>(maskSize)<span class="op">.</span><span class="fu">subtract</span>(<span class="dv">1</span>)</span>
<span id="cb75-25"><a href="#cb75-25" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> input<span class="op">.</span><span class="fu">rightShift</span>(fromBit)<span class="op">.</span><span class="fu">bitwiseAnd</span>(mask)</span>
<span id="cb75-26"><a href="#cb75-26" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb75-27"><a href="#cb75-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-28"><a href="#cb75-28" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> maskSnowAndClouds <span class="op">=</span> <span class="kw">function</span>(image) {</span>
<span id="cb75-29"><a href="#cb75-29" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> summaryQa <span class="op">=</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;SummaryQA&#39;</span>)</span>
<span id="cb75-30"><a href="#cb75-30" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Select pixels which are less than or equals to 1 (0 or 1)</span></span>
<span id="cb75-31"><a href="#cb75-31" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> qaMask <span class="op">=</span> <span class="fu">bitwiseExtract</span>(summaryQa<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">1</span>)<span class="op">.</span><span class="fu">lte</span>(<span class="dv">1</span>)</span>
<span id="cb75-32"><a href="#cb75-32" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> maskedImage <span class="op">=</span> image<span class="op">.</span><span class="fu">updateMask</span>(qaMask)</span>
<span id="cb75-33"><a href="#cb75-33" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> maskedImage<span class="op">.</span><span class="fu">copyProperties</span>(image<span class="op">,</span> [<span class="st">&#39;system:index&#39;</span><span class="op">,</span> <span class="st">&#39;system:time_start&#39;</span>])</span>
<span id="cb75-34"><a href="#cb75-34" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb75-35"><a href="#cb75-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-36"><a href="#cb75-36" aria-hidden="true" tabindex="-1"></a><span class="co">// Test the function</span></span>
<span id="cb75-37"><a href="#cb75-37" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> image <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(filtered<span class="op">.</span><span class="fu">first</span>())</span>
<span id="cb75-38"><a href="#cb75-38" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> imageMasked <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(<span class="fu">maskSnowAndClouds</span>(image))</span>
<span id="cb75-39"><a href="#cb75-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-40"><a href="#cb75-40" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(image<span class="op">,</span> {}<span class="op">,</span> <span class="st">&#39;MODIS NDVI&#39;</span>) </span>
<span id="cb75-41"><a href="#cb75-41" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(imageMasked<span class="op">,</span> {}<span class="op">,</span> <span class="st">&#39;MODIS NDVI (Masked)&#39;</span>) </span></code></pre></div>
<p><a href="https://code.earthengine.google.co.in/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3A06-Drought_Monitoring%2F02b_Apply_Cloud_Mask_(complete)" target="_blank">Open in Code Editor ↗</a></p>
<div class="figure" style="text-align: center">
<img src="images/gee_water_resources_management/vci_cloudmask.png" alt="Snow/Cloud Masked MODIS NDVI" width="50%" />
<p class="caption">
Snow/Cloud Masked MODIS NDVI
</p>
</div>
<div id="exercise-34" class="section level3">
<h3>Exercise</h3>
<p>Use the cloud masking function, pass the filtered collection to get good quality data.</p>
<div class="sourceCode" id="cb76"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Apply cloud mask to all images in the filtered collection</span></span></code></pre></div>
<p><a href="https://code.earthengine.google.co.in/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3A06-Drought_Monitoring%2F02c_Apply_Cloud_Mask_(exercise)" target="_blank">Try in Code Editor ↗</a></p>
</div>
</div>
<div id="extract-and-scale-ndvi-band" class="section level2">
<h2>03. Extract and Scale NDVI Band</h2>
<p>The <em>NDVI</em> value will be a decimal number ranging between <code>-2</code> to <code>1</code>. But in GEE, each NDVI pixel value ranges between <code>-20000</code> to <code>10000</code>. This is done to use the storage effectively because an integer number will take less storage when compared to a floating-point number. Hence, each pixel value is multiplied by <code>10,000</code> and stored as int. Before using these pixel values for analysis, we can divide each pixel with the same scale factor as down-scaling to get the original pixel value. We can find this scale factor information in the data catalog under the band’s section.</p>
<p>To down-scale each image, we need to pass the image collection into a function and compute the value for each image. Any computation on the image will result in a new image with no metadata like <em>system:timestart</em> of the original image without which timeseries charting is impossible. So, before returning the image from the function, we can carry over the required properties using the <code>.copyProperties()</code> function.</p>
<div class="sourceCode" id="cb77"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> modis <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&quot;MODIS/006/MOD13Q1&quot;</span>)<span class="op">;</span></span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-3"><a href="#cb77-3" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> startYear <span class="op">=</span> <span class="dv">2010</span></span>
<span id="cb77-4"><a href="#cb77-4" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> endYear <span class="op">=</span> <span class="dv">2020</span></span>
<span id="cb77-5"><a href="#cb77-5" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> startDate <span class="op">=</span> ee<span class="op">.</span><span class="at">Date</span><span class="op">.</span><span class="fu">fromYMD</span>(startYear<span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">1</span>)</span>
<span id="cb77-6"><a href="#cb77-6" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> endDate <span class="op">=</span> ee<span class="op">.</span><span class="at">Date</span><span class="op">.</span><span class="fu">fromYMD</span>(endYear<span class="op">,</span> <span class="dv">12</span><span class="op">,</span> <span class="dv">31</span>)</span>
<span id="cb77-7"><a href="#cb77-7" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> filtered <span class="op">=</span> modis</span>
<span id="cb77-8"><a href="#cb77-8" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(startDate<span class="op">,</span> endDate))</span>
<span id="cb77-9"><a href="#cb77-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-10"><a href="#cb77-10" aria-hidden="true" tabindex="-1"></a><span class="co">// Cloud Masking</span></span>
<span id="cb77-11"><a href="#cb77-11" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> bitwiseExtract <span class="op">=</span> <span class="kw">function</span>(input<span class="op">,</span> fromBit<span class="op">,</span> toBit) {</span>
<span id="cb77-12"><a href="#cb77-12" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> maskSize <span class="op">=</span> ee<span class="op">.</span><span class="fu">Number</span>(<span class="dv">1</span>)<span class="op">.</span><span class="fu">add</span>(toBit)<span class="op">.</span><span class="fu">subtract</span>(fromBit)</span>
<span id="cb77-13"><a href="#cb77-13" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> mask <span class="op">=</span> ee<span class="op">.</span><span class="fu">Number</span>(<span class="dv">1</span>)<span class="op">.</span><span class="fu">leftShift</span>(maskSize)<span class="op">.</span><span class="fu">subtract</span>(<span class="dv">1</span>)</span>
<span id="cb77-14"><a href="#cb77-14" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> input<span class="op">.</span><span class="fu">rightShift</span>(fromBit)<span class="op">.</span><span class="fu">bitwiseAnd</span>(mask)</span>
<span id="cb77-15"><a href="#cb77-15" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb77-16"><a href="#cb77-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-17"><a href="#cb77-17" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> maskSnowAndClouds <span class="op">=</span> <span class="kw">function</span>(image) {</span>
<span id="cb77-18"><a href="#cb77-18" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> summaryQa <span class="op">=</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;SummaryQA&#39;</span>)</span>
<span id="cb77-19"><a href="#cb77-19" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Select pixels which are less than or equals to 1 (0 or 1)</span></span>
<span id="cb77-20"><a href="#cb77-20" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> qaMask <span class="op">=</span> <span class="fu">bitwiseExtract</span>(summaryQa<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">1</span>)<span class="op">.</span><span class="fu">lte</span>(<span class="dv">1</span>)</span>
<span id="cb77-21"><a href="#cb77-21" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> maskedImage <span class="op">=</span> image<span class="op">.</span><span class="fu">updateMask</span>(qaMask)</span>
<span id="cb77-22"><a href="#cb77-22" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> maskedImage<span class="op">.</span><span class="fu">copyProperties</span>(image<span class="op">,</span> [<span class="st">&#39;system:index&#39;</span><span class="op">,</span> <span class="st">&#39;system:time_start&#39;</span>])</span>
<span id="cb77-23"><a href="#cb77-23" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb77-24"><a href="#cb77-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-25"><a href="#cb77-25" aria-hidden="true" tabindex="-1"></a><span class="co">// Apply the function to all images in the collection</span></span>
<span id="cb77-26"><a href="#cb77-26" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> maskedCol <span class="op">=</span> filtered<span class="op">.</span><span class="fu">map</span>(maskSnowAndClouds)</span>
<span id="cb77-27"><a href="#cb77-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-28"><a href="#cb77-28" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> ndviCol <span class="op">=</span> maskedCol<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;NDVI&#39;</span>)</span>
<span id="cb77-29"><a href="#cb77-29" aria-hidden="true" tabindex="-1"></a><span class="co">// MODIS NDVI values come as NDVI x 10000 that need to be scaled by 0.0001</span></span>
<span id="cb77-30"><a href="#cb77-30" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> ndviScaled <span class="op">=</span> ndviCol<span class="op">.</span><span class="fu">map</span>(<span class="kw">function</span>(image) {</span>
<span id="cb77-31"><a href="#cb77-31" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> scaled <span class="op">=</span> image<span class="op">.</span><span class="fu">divide</span>(<span class="dv">10000</span>)</span>
<span id="cb77-32"><a href="#cb77-32" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> scaled<span class="op">.</span><span class="fu">copyProperties</span>(image<span class="op">,</span> [<span class="st">&#39;system:index&#39;</span><span class="op">,</span> <span class="st">&#39;system:time_start&#39;</span>])</span>
<span id="cb77-33"><a href="#cb77-33" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb77-34"><a href="#cb77-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-35"><a href="#cb77-35" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(ndviScaled)<span class="op">;</span></span></code></pre></div>
<p><a href="https://code.earthengine.google.co.in/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3A06-Drought_Monitoring%2F03b_Extract_and_Scale_NDVI_Band_(complete)" target="_blank">Open in Code Editor ↗</a></p>
<div id="exercise-35" class="section level3">
<h3>Exercise</h3>
<p>Add the scaled image to the map canvas using a suitable visualization parameter. Inspect any pixel and check the NDVI value.</p>
<div class="figure" style="text-align: center">
<img src="images/gee_water_resources_management/vci_ndviscaled.png" alt="Masked and Scaled MODIS NDVI" width="50%" />
<p class="caption">
Masked and Scaled MODIS NDVI
</p>
</div>
<div class="sourceCode" id="cb78"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Extract 1 image from the ndviScaled collection</span></span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a><span class="co">// Visualize it and add it to the map</span></span></code></pre></div>
<p><a href="https://code.earthengine.google.co.in/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3A06-Drought_Monitoring%2F03c_Extract_and_Scale_NDVI_Band_(exercise)" target="_blank">Try in Code Editor ↗</a></p>
</div>
</div>
<div id="create-monthly-images" class="section level2">
<h2>04. Create Monthly Images</h2>
<p>The MODIS Vegetation Indices is a 16-day composite, and it cannot be standardized in a calendar unit. So let’s create one image per month by aggregating all the images in the month as a <em>mean</em> composite. To filter the collection for with <em>year, month, day</em> level <code>ee.Filter.calenderRange()</code> function should be use.</p>
<p>We should use a nested map function to map the years first then the months in the inner map function. The inner months map will return a Feature Collection, which results in a <em>Feature collection of Feature Collection</em> when returned by the outer years function. A Feature collection can contain only Features but not Feature Collection. Hence we can use the <code>.flatten()</code> algorithm with the outer years map function to convert <em>Feature collection of Feature Collection</em> to <em>Feature Collection with List of Features</em>.</p>
<p>For an 11-year time series, we will create a final output of 132 (11 x 12) images.</p>
<p><img src="images/gee_water_resources_management/drought_monthlyImages.png" width="50%" style="display: block; margin: auto;" /></p>
<div class="sourceCode" id="cb79"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> modis <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&quot;MODIS/006/MOD13Q1&quot;</span>)<span class="op">;</span></span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-3"><a href="#cb79-3" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> startYear <span class="op">=</span> <span class="dv">2010</span></span>
<span id="cb79-4"><a href="#cb79-4" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> endYear <span class="op">=</span> <span class="dv">2020</span></span>
<span id="cb79-5"><a href="#cb79-5" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> startDate <span class="op">=</span> ee<span class="op">.</span><span class="at">Date</span><span class="op">.</span><span class="fu">fromYMD</span>(startYear<span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">1</span>)</span>
<span id="cb79-6"><a href="#cb79-6" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> endDate <span class="op">=</span> ee<span class="op">.</span><span class="at">Date</span><span class="op">.</span><span class="fu">fromYMD</span>(endYear<span class="op">,</span> <span class="dv">12</span><span class="op">,</span> <span class="dv">31</span>)</span>
<span id="cb79-7"><a href="#cb79-7" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> filtered <span class="op">=</span> modis</span>
<span id="cb79-8"><a href="#cb79-8" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(startDate<span class="op">,</span> endDate))</span>
<span id="cb79-9"><a href="#cb79-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-10"><a href="#cb79-10" aria-hidden="true" tabindex="-1"></a><span class="co">// Cloud Masking</span></span>
<span id="cb79-11"><a href="#cb79-11" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> bitwiseExtract <span class="op">=</span> <span class="kw">function</span>(input<span class="op">,</span> fromBit<span class="op">,</span> toBit) {</span>
<span id="cb79-12"><a href="#cb79-12" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> maskSize <span class="op">=</span> ee<span class="op">.</span><span class="fu">Number</span>(<span class="dv">1</span>)<span class="op">.</span><span class="fu">add</span>(toBit)<span class="op">.</span><span class="fu">subtract</span>(fromBit)</span>
<span id="cb79-13"><a href="#cb79-13" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> mask <span class="op">=</span> ee<span class="op">.</span><span class="fu">Number</span>(<span class="dv">1</span>)<span class="op">.</span><span class="fu">leftShift</span>(maskSize)<span class="op">.</span><span class="fu">subtract</span>(<span class="dv">1</span>)</span>
<span id="cb79-14"><a href="#cb79-14" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> input<span class="op">.</span><span class="fu">rightShift</span>(fromBit)<span class="op">.</span><span class="fu">bitwiseAnd</span>(mask)</span>
<span id="cb79-15"><a href="#cb79-15" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb79-16"><a href="#cb79-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-17"><a href="#cb79-17" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> maskSnowAndClouds <span class="op">=</span> <span class="kw">function</span>(image) {</span>
<span id="cb79-18"><a href="#cb79-18" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> summaryQa <span class="op">=</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;SummaryQA&#39;</span>)</span>
<span id="cb79-19"><a href="#cb79-19" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Select pixels which are less than or equals to 1 (0 or 1)</span></span>
<span id="cb79-20"><a href="#cb79-20" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> qaMask <span class="op">=</span> <span class="fu">bitwiseExtract</span>(summaryQa<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">1</span>)<span class="op">.</span><span class="fu">lte</span>(<span class="dv">1</span>)</span>
<span id="cb79-21"><a href="#cb79-21" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> maskedImage <span class="op">=</span> image<span class="op">.</span><span class="fu">updateMask</span>(qaMask)</span>
<span id="cb79-22"><a href="#cb79-22" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> maskedImage<span class="op">.</span><span class="fu">copyProperties</span>(image<span class="op">,</span> [<span class="st">&#39;system:index&#39;</span><span class="op">,</span> <span class="st">&#39;system:time_start&#39;</span>])</span>
<span id="cb79-23"><a href="#cb79-23" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb79-24"><a href="#cb79-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-25"><a href="#cb79-25" aria-hidden="true" tabindex="-1"></a><span class="co">// Apply the function to all images in the collection</span></span>
<span id="cb79-26"><a href="#cb79-26" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> maskedCol <span class="op">=</span> filtered<span class="op">.</span><span class="fu">map</span>(maskSnowAndClouds)</span>
<span id="cb79-27"><a href="#cb79-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-28"><a href="#cb79-28" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> ndviCol <span class="op">=</span> maskedCol<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;NDVI&#39;</span>)</span>
<span id="cb79-29"><a href="#cb79-29" aria-hidden="true" tabindex="-1"></a><span class="co">// MODIS NDVI values come as NDVI x 10000 that need to be scaled by 0.0001</span></span>
<span id="cb79-30"><a href="#cb79-30" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> ndviScaled <span class="op">=</span> ndviCol<span class="op">.</span><span class="fu">map</span>(<span class="kw">function</span>(image) {</span>
<span id="cb79-31"><a href="#cb79-31" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> scaled <span class="op">=</span> image<span class="op">.</span><span class="fu">divide</span>(<span class="dv">10000</span>)</span>
<span id="cb79-32"><a href="#cb79-32" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> scaled<span class="op">.</span><span class="fu">copyProperties</span>(image<span class="op">,</span> [<span class="st">&#39;system:index&#39;</span><span class="op">,</span> <span class="st">&#39;system:time_start&#39;</span>])</span>
<span id="cb79-33"><a href="#cb79-33" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb79-34"><a href="#cb79-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-35"><a href="#cb79-35" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(ndviScaled)<span class="op">;</span></span>
<span id="cb79-36"><a href="#cb79-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-37"><a href="#cb79-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-38"><a href="#cb79-38" aria-hidden="true" tabindex="-1"></a><span class="co">// Introducting calendarRange()</span></span>
<span id="cb79-39"><a href="#cb79-39" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> mayImages <span class="op">=</span> ndviScaled</span>
<span id="cb79-40"><a href="#cb79-40" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">calendarRange</span>(<span class="dv">5</span><span class="op">,</span> <span class="dv">5</span><span class="op">,</span> <span class="st">&#39;month&#39;</span>))</span>
<span id="cb79-41"><a href="#cb79-41" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(mayImages)</span>
<span id="cb79-42"><a href="#cb79-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-43"><a href="#cb79-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-44"><a href="#cb79-44" aria-hidden="true" tabindex="-1"></a><span class="co">// Introducting flatten()</span></span>
<span id="cb79-45"><a href="#cb79-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-46"><a href="#cb79-46" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> nestedList <span class="op">=</span> ee<span class="op">.</span><span class="fu">List</span>([[<span class="st">&#39;a&#39;</span><span class="op">,</span> <span class="st">&#39;b&#39;</span>]<span class="op">,</span> [<span class="st">&#39;c&#39;</span><span class="op">,</span> <span class="st">&#39;d&#39;</span>]<span class="op">,</span> [<span class="st">&#39;e&#39;</span><span class="op">,</span> <span class="st">&#39;f&#39;</span>]])</span>
<span id="cb79-47"><a href="#cb79-47" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(nestedList)</span>
<span id="cb79-48"><a href="#cb79-48" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(nestedList<span class="op">.</span><span class="fu">flatten</span>())</span>
<span id="cb79-49"><a href="#cb79-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-50"><a href="#cb79-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-51"><a href="#cb79-51" aria-hidden="true" tabindex="-1"></a><span class="co">// Create NDVI composite for every month</span></span>
<span id="cb79-52"><a href="#cb79-52" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> years <span class="op">=</span> ee<span class="op">.</span><span class="at">List</span><span class="op">.</span><span class="fu">sequence</span>(startYear<span class="op">,</span>endYear)<span class="op">;</span></span>
<span id="cb79-53"><a href="#cb79-53" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> months <span class="op">=</span> ee<span class="op">.</span><span class="at">List</span><span class="op">.</span><span class="fu">sequence</span>(<span class="dv">1</span><span class="op">,</span> <span class="dv">12</span>)<span class="op">;</span></span>
<span id="cb79-54"><a href="#cb79-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-55"><a href="#cb79-55" aria-hidden="true" tabindex="-1"></a><span class="co">// Map over the years and create a monthly average collection</span></span>
<span id="cb79-56"><a href="#cb79-56" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> monthlyImages <span class="op">=</span> years<span class="op">.</span><span class="fu">map</span>(<span class="kw">function</span>(year) {</span>
<span id="cb79-57"><a href="#cb79-57" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> months<span class="op">.</span><span class="fu">map</span>(<span class="kw">function</span>(month) {</span>
<span id="cb79-58"><a href="#cb79-58" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> filtered <span class="op">=</span> ndviScaled</span>
<span id="cb79-59"><a href="#cb79-59" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">calendarRange</span>(year<span class="op">,</span> year<span class="op">,</span> <span class="st">&#39;year&#39;</span>))</span>
<span id="cb79-60"><a href="#cb79-60" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">calendarRange</span>(month<span class="op">,</span> month<span class="op">,</span> <span class="st">&#39;month&#39;</span>))</span>
<span id="cb79-61"><a href="#cb79-61" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> monthly <span class="op">=</span> filtered<span class="op">.</span><span class="fu">mean</span>()</span>
<span id="cb79-62"><a href="#cb79-62" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> monthly<span class="op">.</span><span class="fu">set</span>({<span class="st">&#39;month&#39;</span><span class="op">:</span> month<span class="op">,</span> <span class="st">&#39;year&#39;</span><span class="op">:</span> year})</span>
<span id="cb79-63"><a href="#cb79-63" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb79-64"><a href="#cb79-64" aria-hidden="true" tabindex="-1"></a>})<span class="op">.</span><span class="fu">flatten</span>()</span>
<span id="cb79-65"><a href="#cb79-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-66"><a href="#cb79-66" aria-hidden="true" tabindex="-1"></a><span class="co">// We now have 1 image per month for entire duratioon</span></span>
<span id="cb79-67"><a href="#cb79-67" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(monthlyImages)</span></code></pre></div>
<p><a href="https://code.earthengine.google.co.in/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3A06-Drought_Monitoring%2F04b_Create_Monthly_Images_(complete)" target="_blank">Open in Code Editor ↗</a></p>
<div id="exercise-36" class="section level3">
<h3>Exercise</h3>
<p>The final output will be a list of images, convert this into an ImageCollection.</p>
<p><a href="https://code.earthengine.google.co.in/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3A06-Drought_Monitoring%2F04c_Create_Monthly_Images_(exercise)" target="_blank">Try in Code Editor ↗</a></p>
</div>
</div>
<div id="calculate-min-max-composites" class="section level2">
<h2>05. Calculate Min Max Composites</h2>
<p>To compute the VCI, we need to calculate each month’s minimum NDVI and maximum NDVI values. The <code>min()</code> and <code>max()</code> reducers are used to compute image collections for the creation of minimum and maximum NDVI values.</p>
<div class="sourceCode" id="cb80"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> modis <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&quot;MODIS/006/MOD13Q1&quot;</span>)<span class="op">;</span></span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-3"><a href="#cb80-3" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> startYear <span class="op">=</span> <span class="dv">2010</span></span>
<span id="cb80-4"><a href="#cb80-4" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> endYear <span class="op">=</span> <span class="dv">2020</span></span>
<span id="cb80-5"><a href="#cb80-5" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> startDate <span class="op">=</span> ee<span class="op">.</span><span class="at">Date</span><span class="op">.</span><span class="fu">fromYMD</span>(startYear<span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">1</span>)</span>
<span id="cb80-6"><a href="#cb80-6" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> endDate <span class="op">=</span> ee<span class="op">.</span><span class="at">Date</span><span class="op">.</span><span class="fu">fromYMD</span>(endYear<span class="op">,</span> <span class="dv">12</span><span class="op">,</span> <span class="dv">31</span>)</span>
<span id="cb80-7"><a href="#cb80-7" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> filtered <span class="op">=</span> modis</span>
<span id="cb80-8"><a href="#cb80-8" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(startDate<span class="op">,</span> endDate))</span>
<span id="cb80-9"><a href="#cb80-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-10"><a href="#cb80-10" aria-hidden="true" tabindex="-1"></a><span class="co">// Cloud Masking</span></span>
<span id="cb80-11"><a href="#cb80-11" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> bitwiseExtract <span class="op">=</span> <span class="kw">function</span>(input<span class="op">,</span> fromBit<span class="op">,</span> toBit) {</span>
<span id="cb80-12"><a href="#cb80-12" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> maskSize <span class="op">=</span> ee<span class="op">.</span><span class="fu">Number</span>(<span class="dv">1</span>)<span class="op">.</span><span class="fu">add</span>(toBit)<span class="op">.</span><span class="fu">subtract</span>(fromBit)</span>
<span id="cb80-13"><a href="#cb80-13" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> mask <span class="op">=</span> ee<span class="op">.</span><span class="fu">Number</span>(<span class="dv">1</span>)<span class="op">.</span><span class="fu">leftShift</span>(maskSize)<span class="op">.</span><span class="fu">subtract</span>(<span class="dv">1</span>)</span>
<span id="cb80-14"><a href="#cb80-14" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> input<span class="op">.</span><span class="fu">rightShift</span>(fromBit)<span class="op">.</span><span class="fu">bitwiseAnd</span>(mask)</span>
<span id="cb80-15"><a href="#cb80-15" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb80-16"><a href="#cb80-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-17"><a href="#cb80-17" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> maskSnowAndClouds <span class="op">=</span> <span class="kw">function</span>(image) {</span>
<span id="cb80-18"><a href="#cb80-18" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> summaryQa <span class="op">=</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;SummaryQA&#39;</span>)</span>
<span id="cb80-19"><a href="#cb80-19" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Select pixels which are less than or equals to 1 (0 or 1)</span></span>
<span id="cb80-20"><a href="#cb80-20" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> qaMask <span class="op">=</span> <span class="fu">bitwiseExtract</span>(summaryQa<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">1</span>)<span class="op">.</span><span class="fu">lte</span>(<span class="dv">1</span>)</span>
<span id="cb80-21"><a href="#cb80-21" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> maskedImage <span class="op">=</span> image<span class="op">.</span><span class="fu">updateMask</span>(qaMask)</span>
<span id="cb80-22"><a href="#cb80-22" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> maskedImage<span class="op">.</span><span class="fu">copyProperties</span>(image<span class="op">,</span> [<span class="st">&#39;system:index&#39;</span><span class="op">,</span> <span class="st">&#39;system:time_start&#39;</span>])</span>
<span id="cb80-23"><a href="#cb80-23" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb80-24"><a href="#cb80-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-25"><a href="#cb80-25" aria-hidden="true" tabindex="-1"></a><span class="co">// Apply the function to all images in the collection</span></span>
<span id="cb80-26"><a href="#cb80-26" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> maskedCol <span class="op">=</span> filtered<span class="op">.</span><span class="fu">map</span>(maskSnowAndClouds)</span>
<span id="cb80-27"><a href="#cb80-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-28"><a href="#cb80-28" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> ndviCol <span class="op">=</span> maskedCol<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;NDVI&#39;</span>)</span>
<span id="cb80-29"><a href="#cb80-29" aria-hidden="true" tabindex="-1"></a><span class="co">// MODIS NDVI values come as NDVI x 10000 that need to be scaled by 0.0001</span></span>
<span id="cb80-30"><a href="#cb80-30" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> ndviScaled <span class="op">=</span> ndviCol<span class="op">.</span><span class="fu">map</span>(<span class="kw">function</span>(image) {</span>
<span id="cb80-31"><a href="#cb80-31" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> scaled <span class="op">=</span> image<span class="op">.</span><span class="fu">divide</span>(<span class="dv">10000</span>)</span>
<span id="cb80-32"><a href="#cb80-32" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> scaled<span class="op">.</span><span class="fu">copyProperties</span>(image<span class="op">,</span> [<span class="st">&#39;system:index&#39;</span><span class="op">,</span> <span class="st">&#39;system:time_start&#39;</span>])</span>
<span id="cb80-33"><a href="#cb80-33" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb80-34"><a href="#cb80-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-35"><a href="#cb80-35" aria-hidden="true" tabindex="-1"></a><span class="co">// Create NDVI composite for every month</span></span>
<span id="cb80-36"><a href="#cb80-36" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> years <span class="op">=</span> ee<span class="op">.</span><span class="at">List</span><span class="op">.</span><span class="fu">sequence</span>(startYear<span class="op">,</span>endYear)<span class="op">;</span></span>
<span id="cb80-37"><a href="#cb80-37" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> months <span class="op">=</span> ee<span class="op">.</span><span class="at">List</span><span class="op">.</span><span class="fu">sequence</span>(<span class="dv">1</span><span class="op">,</span> <span class="dv">12</span>)<span class="op">;</span></span>
<span id="cb80-38"><a href="#cb80-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-39"><a href="#cb80-39" aria-hidden="true" tabindex="-1"></a><span class="co">// Map over the years and create a monthly average collection</span></span>
<span id="cb80-40"><a href="#cb80-40" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> monthlyImages <span class="op">=</span> years<span class="op">.</span><span class="fu">map</span>(<span class="kw">function</span>(year) {</span>
<span id="cb80-41"><a href="#cb80-41" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> months<span class="op">.</span><span class="fu">map</span>(<span class="kw">function</span>(month) {</span>
<span id="cb80-42"><a href="#cb80-42" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> filtered <span class="op">=</span> ndviScaled</span>
<span id="cb80-43"><a href="#cb80-43" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">calendarRange</span>(year<span class="op">,</span> year<span class="op">,</span> <span class="st">&#39;year&#39;</span>))</span>
<span id="cb80-44"><a href="#cb80-44" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">calendarRange</span>(month<span class="op">,</span> month<span class="op">,</span> <span class="st">&#39;month&#39;</span>))</span>
<span id="cb80-45"><a href="#cb80-45" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> monthly <span class="op">=</span> filtered<span class="op">.</span><span class="fu">mean</span>()</span>
<span id="cb80-46"><a href="#cb80-46" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> monthly<span class="op">.</span><span class="fu">set</span>({<span class="st">&#39;month&#39;</span><span class="op">:</span> month<span class="op">,</span> <span class="st">&#39;year&#39;</span><span class="op">:</span> year})</span>
<span id="cb80-47"><a href="#cb80-47" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb80-48"><a href="#cb80-48" aria-hidden="true" tabindex="-1"></a>})<span class="op">.</span><span class="fu">flatten</span>()</span>
<span id="cb80-49"><a href="#cb80-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-50"><a href="#cb80-50" aria-hidden="true" tabindex="-1"></a><span class="co">// We now have 1 image per month for entire duratioon</span></span>
<span id="cb80-51"><a href="#cb80-51" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> monthlyCol <span class="op">=</span> ee<span class="op">.</span><span class="at">ImageCollection</span><span class="op">.</span><span class="fu">fromImages</span>(monthlyImages)</span>
<span id="cb80-52"><a href="#cb80-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-53"><a href="#cb80-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-54"><a href="#cb80-54" aria-hidden="true" tabindex="-1"></a><span class="co">// We can compute Minimum NDVI for each month across all years</span></span>
<span id="cb80-55"><a href="#cb80-55" aria-hidden="true" tabindex="-1"></a><span class="co">// i.e. Minimum NDVI for all May months in the collection</span></span>
<span id="cb80-56"><a href="#cb80-56" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> monthlyMinImages <span class="op">=</span> months<span class="op">.</span><span class="fu">map</span>(<span class="kw">function</span>(month) {</span>
<span id="cb80-57"><a href="#cb80-57" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> filtered <span class="op">=</span> monthlyCol<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;month&#39;</span><span class="op">,</span> month))</span>
<span id="cb80-58"><a href="#cb80-58" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> monthlyMin <span class="op">=</span> filtered<span class="op">.</span><span class="fu">min</span>()</span>
<span id="cb80-59"><a href="#cb80-59" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> monthlyMin<span class="op">.</span><span class="fu">set</span>(<span class="st">&#39;month&#39;</span><span class="op">,</span> month)</span>
<span id="cb80-60"><a href="#cb80-60" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb80-61"><a href="#cb80-61" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> monthlyMin <span class="op">=</span> ee<span class="op">.</span><span class="at">ImageCollection</span><span class="op">.</span><span class="fu">fromImages</span>(monthlyMinImages)</span>
<span id="cb80-62"><a href="#cb80-62" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(monthlyMin)</span>
<span id="cb80-63"><a href="#cb80-63" aria-hidden="true" tabindex="-1"></a><span class="co">// We can compute Maximum NDVI for each month across all years</span></span>
<span id="cb80-64"><a href="#cb80-64" aria-hidden="true" tabindex="-1"></a><span class="co">// i.e. Maximum NDVI for all May months in the collection</span></span>
<span id="cb80-65"><a href="#cb80-65" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> monthlyMaxImages <span class="op">=</span> months<span class="op">.</span><span class="fu">map</span>(<span class="kw">function</span>(month) {</span>
<span id="cb80-66"><a href="#cb80-66" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> filtered <span class="op">=</span> monthlyCol<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;month&#39;</span><span class="op">,</span> month))</span>
<span id="cb80-67"><a href="#cb80-67" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> monthlyMax <span class="op">=</span> filtered<span class="op">.</span><span class="fu">max</span>()</span>
<span id="cb80-68"><a href="#cb80-68" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> monthlyMax<span class="op">.</span><span class="fu">set</span>(<span class="st">&#39;month&#39;</span><span class="op">,</span> month)</span>
<span id="cb80-69"><a href="#cb80-69" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb80-70"><a href="#cb80-70" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> monthlyMax <span class="op">=</span> ee<span class="op">.</span><span class="at">ImageCollection</span><span class="op">.</span><span class="fu">fromImages</span>(monthlyMaxImages)</span>
<span id="cb80-71"><a href="#cb80-71" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(monthlyMax)</span></code></pre></div>
<p><a href="https://code.earthengine.google.co.in/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3A06-Drought_Monitoring%2F05b_Calculate_Min_Max_Composites_(complete)" target="_blank">Open in Code Editor ↗</a></p>
<div id="exercise-37" class="section level3">
<h3>Exercise</h3>
<p>Add the min and max NDVI images to map canvas using a suitable visualization parameter for the month of <strong>May</strong>.</p>
<div class="figure" style="text-align: center">
<img src="images/gee_water_resources_management/vci_ndviminmax.png" alt="Historic Minimum and Maximum NDVI for the Month of May" width="100%" />
<p class="caption">
Historic Minimum and Maximum NDVI for the Month of May
</p>
</div>
<div class="sourceCode" id="cb81"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Extract 1 image from the ndviScaled collection</span></span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a><span class="co">// Visualize it and add it to the map</span></span></code></pre></div>
<p><a href="https://code.earthengine.google.co.in/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3A06-Drought_Monitoring%2F05c_Calculate_Min_Max_Composites_(exercise)" target="_blank">Try in Code Editor ↗</a></p>
</div>
</div>
<div id="calculate-vci" class="section level2">
<h2>06. Calculate VCI</h2>
<p>Vegetation Condition Index (VCI) is a drought monitoring index that takes the previous year’s minimum and maximum NDVI values at a particular area and compares it against the current NDVI value to identify if the area is experiencing drought. As recommended by <a href="https://un-spider.org/book/export/html/9206">Un-Spider - Drought Monitoring Recommended Practice</a> VCI value of less than 40 % can be considered as drought.</p>
<div class="figure" style="text-align: center">
<img src="images/gee_water_resources_management/vci_equation.png" alt="VCI Formula" width="50%" />
<p class="caption">
VCI Formula
</p>
</div>
<div class="sourceCode" id="cb82"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> modis <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&quot;MODIS/006/MOD13Q1&quot;</span>)<span class="op">;</span></span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-3"><a href="#cb82-3" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> startYear <span class="op">=</span> <span class="dv">2010</span></span>
<span id="cb82-4"><a href="#cb82-4" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> endYear <span class="op">=</span> <span class="dv">2020</span></span>
<span id="cb82-5"><a href="#cb82-5" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> startDate <span class="op">=</span> ee<span class="op">.</span><span class="at">Date</span><span class="op">.</span><span class="fu">fromYMD</span>(startYear<span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">1</span>)</span>
<span id="cb82-6"><a href="#cb82-6" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> endDate <span class="op">=</span> ee<span class="op">.</span><span class="at">Date</span><span class="op">.</span><span class="fu">fromYMD</span>(endYear<span class="op">,</span> <span class="dv">12</span><span class="op">,</span> <span class="dv">31</span>)</span>
<span id="cb82-7"><a href="#cb82-7" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> filtered <span class="op">=</span> modis</span>
<span id="cb82-8"><a href="#cb82-8" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(startDate<span class="op">,</span> endDate))</span>
<span id="cb82-9"><a href="#cb82-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-10"><a href="#cb82-10" aria-hidden="true" tabindex="-1"></a><span class="co">// Cloud Masking</span></span>
<span id="cb82-11"><a href="#cb82-11" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> bitwiseExtract <span class="op">=</span> <span class="kw">function</span>(input<span class="op">,</span> fromBit<span class="op">,</span> toBit) {</span>
<span id="cb82-12"><a href="#cb82-12" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> maskSize <span class="op">=</span> ee<span class="op">.</span><span class="fu">Number</span>(<span class="dv">1</span>)<span class="op">.</span><span class="fu">add</span>(toBit)<span class="op">.</span><span class="fu">subtract</span>(fromBit)</span>
<span id="cb82-13"><a href="#cb82-13" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> mask <span class="op">=</span> ee<span class="op">.</span><span class="fu">Number</span>(<span class="dv">1</span>)<span class="op">.</span><span class="fu">leftShift</span>(maskSize)<span class="op">.</span><span class="fu">subtract</span>(<span class="dv">1</span>)</span>
<span id="cb82-14"><a href="#cb82-14" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> input<span class="op">.</span><span class="fu">rightShift</span>(fromBit)<span class="op">.</span><span class="fu">bitwiseAnd</span>(mask)</span>
<span id="cb82-15"><a href="#cb82-15" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb82-16"><a href="#cb82-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-17"><a href="#cb82-17" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> maskSnowAndClouds <span class="op">=</span> <span class="kw">function</span>(image) {</span>
<span id="cb82-18"><a href="#cb82-18" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> summaryQa <span class="op">=</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;SummaryQA&#39;</span>)</span>
<span id="cb82-19"><a href="#cb82-19" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Select pixels which are less than or equals to 1 (0 or 1)</span></span>
<span id="cb82-20"><a href="#cb82-20" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> qaMask <span class="op">=</span> <span class="fu">bitwiseExtract</span>(summaryQa<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">1</span>)<span class="op">.</span><span class="fu">lte</span>(<span class="dv">1</span>)</span>
<span id="cb82-21"><a href="#cb82-21" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> maskedImage <span class="op">=</span> image<span class="op">.</span><span class="fu">updateMask</span>(qaMask)</span>
<span id="cb82-22"><a href="#cb82-22" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> maskedImage<span class="op">.</span><span class="fu">copyProperties</span>(image<span class="op">,</span> [<span class="st">&#39;system:index&#39;</span><span class="op">,</span> <span class="st">&#39;system:time_start&#39;</span>])</span>
<span id="cb82-23"><a href="#cb82-23" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb82-24"><a href="#cb82-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-25"><a href="#cb82-25" aria-hidden="true" tabindex="-1"></a><span class="co">// Apply the function to all images in the collection</span></span>
<span id="cb82-26"><a href="#cb82-26" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> maskedCol <span class="op">=</span> filtered<span class="op">.</span><span class="fu">map</span>(maskSnowAndClouds)</span>
<span id="cb82-27"><a href="#cb82-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-28"><a href="#cb82-28" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> ndviCol <span class="op">=</span> maskedCol<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;NDVI&#39;</span>)</span>
<span id="cb82-29"><a href="#cb82-29" aria-hidden="true" tabindex="-1"></a><span class="co">// MODIS NDVI values come as NDVI x 10000 that need to be scaled by 0.0001</span></span>
<span id="cb82-30"><a href="#cb82-30" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> scaleNdvi <span class="op">=</span> <span class="kw">function</span>(image) {</span>
<span id="cb82-31"><a href="#cb82-31" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> scaled <span class="op">=</span> image<span class="op">.</span><span class="fu">divide</span>(<span class="dv">10000</span>)</span>
<span id="cb82-32"><a href="#cb82-32" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> scaled<span class="op">.</span><span class="fu">copyProperties</span>(image<span class="op">,</span> [<span class="st">&#39;system:index&#39;</span><span class="op">,</span> <span class="st">&#39;system:time_start&#39;</span>])</span>
<span id="cb82-33"><a href="#cb82-33" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb82-34"><a href="#cb82-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-35"><a href="#cb82-35" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> ndviScaled <span class="op">=</span> ndviCol<span class="op">.</span><span class="fu">map</span>(scaleNdvi)</span>
<span id="cb82-36"><a href="#cb82-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-37"><a href="#cb82-37" aria-hidden="true" tabindex="-1"></a><span class="co">// Create NDVI composite for every month</span></span>
<span id="cb82-38"><a href="#cb82-38" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> years <span class="op">=</span> ee<span class="op">.</span><span class="at">List</span><span class="op">.</span><span class="fu">sequence</span>(startYear<span class="op">,</span>endYear)<span class="op">;</span></span>
<span id="cb82-39"><a href="#cb82-39" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> months <span class="op">=</span> ee<span class="op">.</span><span class="at">List</span><span class="op">.</span><span class="fu">sequence</span>(<span class="dv">1</span><span class="op">,</span> <span class="dv">12</span>)<span class="op">;</span></span>
<span id="cb82-40"><a href="#cb82-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-41"><a href="#cb82-41" aria-hidden="true" tabindex="-1"></a><span class="co">// Map over the years and create a monthly average collection</span></span>
<span id="cb82-42"><a href="#cb82-42" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> monthlyImages <span class="op">=</span> years<span class="op">.</span><span class="fu">map</span>(<span class="kw">function</span>(year) {</span>
<span id="cb82-43"><a href="#cb82-43" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> months<span class="op">.</span><span class="fu">map</span>(<span class="kw">function</span>(month) {</span>
<span id="cb82-44"><a href="#cb82-44" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> filtered <span class="op">=</span> ndviScaled</span>
<span id="cb82-45"><a href="#cb82-45" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">calendarRange</span>(year<span class="op">,</span> year<span class="op">,</span> <span class="st">&#39;year&#39;</span>))</span>
<span id="cb82-46"><a href="#cb82-46" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">calendarRange</span>(month<span class="op">,</span> month<span class="op">,</span> <span class="st">&#39;month&#39;</span>))</span>
<span id="cb82-47"><a href="#cb82-47" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> monthly <span class="op">=</span> filtered<span class="op">.</span><span class="fu">mean</span>()</span>
<span id="cb82-48"><a href="#cb82-48" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> monthly<span class="op">.</span><span class="fu">set</span>({<span class="st">&#39;month&#39;</span><span class="op">:</span> month<span class="op">,</span> <span class="st">&#39;year&#39;</span><span class="op">:</span> year})</span>
<span id="cb82-49"><a href="#cb82-49" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb82-50"><a href="#cb82-50" aria-hidden="true" tabindex="-1"></a>})<span class="op">.</span><span class="fu">flatten</span>()</span>
<span id="cb82-51"><a href="#cb82-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-52"><a href="#cb82-52" aria-hidden="true" tabindex="-1"></a><span class="co">// We now have 1 image per month for entire duratioon</span></span>
<span id="cb82-53"><a href="#cb82-53" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> monthlyCol <span class="op">=</span> ee<span class="op">.</span><span class="at">ImageCollection</span><span class="op">.</span><span class="fu">fromImages</span>(monthlyImages)</span>
<span id="cb82-54"><a href="#cb82-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-55"><a href="#cb82-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-56"><a href="#cb82-56" aria-hidden="true" tabindex="-1"></a><span class="co">// We can compute Minimum NDVI for each month across all years</span></span>
<span id="cb82-57"><a href="#cb82-57" aria-hidden="true" tabindex="-1"></a><span class="co">// i.e. Minimum NDVI for all May months in the collection</span></span>
<span id="cb82-58"><a href="#cb82-58" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> monthlyMinImages <span class="op">=</span> months<span class="op">.</span><span class="fu">map</span>(<span class="kw">function</span>(month) {</span>
<span id="cb82-59"><a href="#cb82-59" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> filtered <span class="op">=</span> monthlyCol<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;month&#39;</span><span class="op">,</span> month))</span>
<span id="cb82-60"><a href="#cb82-60" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> monthlyMin <span class="op">=</span> filtered<span class="op">.</span><span class="fu">min</span>()</span>
<span id="cb82-61"><a href="#cb82-61" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> monthlyMin<span class="op">.</span><span class="fu">set</span>(<span class="st">&#39;month&#39;</span><span class="op">,</span> month)</span>
<span id="cb82-62"><a href="#cb82-62" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb82-63"><a href="#cb82-63" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> monthlyMin <span class="op">=</span> ee<span class="op">.</span><span class="at">ImageCollection</span><span class="op">.</span><span class="fu">fromImages</span>(monthlyMinImages)</span>
<span id="cb82-64"><a href="#cb82-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-65"><a href="#cb82-65" aria-hidden="true" tabindex="-1"></a><span class="co">// We can compute Maximum NDVI for each month across all years</span></span>
<span id="cb82-66"><a href="#cb82-66" aria-hidden="true" tabindex="-1"></a><span class="co">// i.e. Maximum NDVI for all May months in the collection</span></span>
<span id="cb82-67"><a href="#cb82-67" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> monthlyMaxImages <span class="op">=</span> months<span class="op">.</span><span class="fu">map</span>(<span class="kw">function</span>(month) {</span>
<span id="cb82-68"><a href="#cb82-68" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> filtered <span class="op">=</span> monthlyCol<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;month&#39;</span><span class="op">,</span> month))</span>
<span id="cb82-69"><a href="#cb82-69" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> monthlyMax <span class="op">=</span> filtered<span class="op">.</span><span class="fu">max</span>()</span>
<span id="cb82-70"><a href="#cb82-70" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> monthlyMax<span class="op">.</span><span class="fu">set</span>(<span class="st">&#39;month&#39;</span><span class="op">,</span> month)</span>
<span id="cb82-71"><a href="#cb82-71" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb82-72"><a href="#cb82-72" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> monthlyMax <span class="op">=</span> ee<span class="op">.</span><span class="at">ImageCollection</span><span class="op">.</span><span class="fu">fromImages</span>(monthlyMaxImages)</span>
<span id="cb82-73"><a href="#cb82-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-74"><a href="#cb82-74" aria-hidden="true" tabindex="-1"></a><span class="co">// Calculate VCI for 2020</span></span>
<span id="cb82-75"><a href="#cb82-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-76"><a href="#cb82-76" aria-hidden="true" tabindex="-1"></a><span class="co">// We are interested in calculating VCI for a particular month</span></span>
<span id="cb82-77"><a href="#cb82-77" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> currentYear <span class="op">=</span> <span class="dv">2020</span></span>
<span id="cb82-78"><a href="#cb82-78" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> currentMonth <span class="op">=</span> <span class="dv">5</span></span>
<span id="cb82-79"><a href="#cb82-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-80"><a href="#cb82-80" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> filtered <span class="op">=</span> monthlyCol</span>
<span id="cb82-81"><a href="#cb82-81" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;year&#39;</span><span class="op">,</span> currentYear))</span>
<span id="cb82-82"><a href="#cb82-82" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;month&#39;</span><span class="op">,</span> currentMonth))</span>
<span id="cb82-83"><a href="#cb82-83" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> currentMonthNdvi <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(filtered<span class="op">.</span><span class="fu">first</span>())</span>
<span id="cb82-84"><a href="#cb82-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-85"><a href="#cb82-85" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> minNdvi <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(monthlyMin<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;month&#39;</span><span class="op">,</span> currentMonth))<span class="op">.</span><span class="fu">first</span>())</span>
<span id="cb82-86"><a href="#cb82-86" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> maxNdvi <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(monthlyMax<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;month&#39;</span><span class="op">,</span> currentMonth))<span class="op">.</span><span class="fu">first</span>())</span>
<span id="cb82-87"><a href="#cb82-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-88"><a href="#cb82-88" aria-hidden="true" tabindex="-1"></a><span class="co">// VCI = (NDVI - min) / (max - min)</span></span>
<span id="cb82-89"><a href="#cb82-89" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> image <span class="op">=</span> ee<span class="op">.</span><span class="at">Image</span><span class="op">.</span><span class="fu">cat</span>([currentMonthNdvi<span class="op">,</span> minNdvi<span class="op">,</span> maxNdvi])<span class="op">.</span><span class="fu">rename</span>([<span class="st">&#39;ndvi&#39;</span><span class="op">,</span> <span class="st">&#39;min&#39;</span><span class="op">,</span> <span class="st">&#39;max&#39;</span>])</span>
<span id="cb82-90"><a href="#cb82-90" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> vci <span class="op">=</span> image<span class="op">.</span><span class="fu">expression</span>(<span class="st">&#39;100* (ndvi - min) / (max - min)&#39;</span><span class="op">,</span></span>
<span id="cb82-91"><a href="#cb82-91" aria-hidden="true" tabindex="-1"></a>    {<span class="st">&#39;ndvi&#39;</span><span class="op">:</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;ndvi&#39;</span>)<span class="op">,</span></span>
<span id="cb82-92"><a href="#cb82-92" aria-hidden="true" tabindex="-1"></a>      <span class="st">&#39;min&#39;</span><span class="op">:</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;min&#39;</span>)<span class="op">,</span></span>
<span id="cb82-93"><a href="#cb82-93" aria-hidden="true" tabindex="-1"></a>      <span class="st">&#39;max&#39;</span><span class="op">:</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;max&#39;</span>)</span>
<span id="cb82-94"><a href="#cb82-94" aria-hidden="true" tabindex="-1"></a>    })<span class="op">.</span><span class="fu">rename</span>(<span class="st">&#39;vci&#39;</span>)</span>
<span id="cb82-95"><a href="#cb82-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-96"><a href="#cb82-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb82-97"><a href="#cb82-97" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> visParams <span class="op">=</span> {<span class="dt">min</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span> <span class="dv">1</span><span class="op">,</span> <span class="dt">palette</span><span class="op">:</span> [<span class="st">&#39;white&#39;</span><span class="op">,</span> <span class="st">&#39;green&#39;</span>]}</span>
<span id="cb82-98"><a href="#cb82-98" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> vciPalette <span class="op">=</span> [<span class="st">&#39;#a50026&#39;</span><span class="op">,</span><span class="st">&#39;#d73027&#39;</span><span class="op">,</span><span class="st">&#39;#f46d43&#39;</span><span class="op">,</span><span class="st">&#39;#fdae61&#39;</span><span class="op">,</span></span>
<span id="cb82-99"><a href="#cb82-99" aria-hidden="true" tabindex="-1"></a>  <span class="st">&#39;#fee08b&#39;</span><span class="op">,</span><span class="st">&#39;#d9ef8b&#39;</span><span class="op">,</span><span class="st">&#39;#a6d96a&#39;</span><span class="op">,</span><span class="st">&#39;#66bd63&#39;</span><span class="op">,</span><span class="st">&#39;#1a9850&#39;</span><span class="op">,</span><span class="st">&#39;#006837&#39;</span>]<span class="op">;</span></span>
<span id="cb82-100"><a href="#cb82-100" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> vciVisParams <span class="op">=</span> {<span class="dt">min</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span> <span class="dv">100</span><span class="op">,</span> <span class="dt">palette</span><span class="op">:</span> vciPalette}</span>
<span id="cb82-101"><a href="#cb82-101" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(minNdvi<span class="op">,</span> visParams<span class="op">,</span> <span class="st">&#39;Minimum May NDVI&#39;</span><span class="op">,</span> <span class="kw">false</span>)  </span>
<span id="cb82-102"><a href="#cb82-102" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(maxNdvi<span class="op">,</span> visParams<span class="op">,</span> <span class="st">&#39;Maximum May NDVI&#39;</span><span class="op">,</span> <span class="kw">false</span>)</span>
<span id="cb82-103"><a href="#cb82-103" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(currentMonthNdvi<span class="op">,</span> visParams<span class="op">,</span> <span class="st">&#39;Current May NDVI&#39;</span><span class="op">,</span> <span class="kw">false</span>)</span>
<span id="cb82-104"><a href="#cb82-104" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(vci<span class="op">,</span> vciVisParams<span class="op">,</span> <span class="st">&#39;VCI&#39;</span>)</span></code></pre></div>
<p><a href="https://code.earthengine.google.co.in/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3A06-Drought_Monitoring%2F06b_Calculate_VCI_(complete)" target="_blank">Open in Code Editor ↗</a></p>
<div class="figure" style="text-align: center">
<img src="images/gee_water_resources_management/vci_vci.png" alt="VCI for the Month of May" width="50%" />
<p class="caption">
VCI for the Month of May
</p>
</div>
<div id="exercise-38" class="section level3">
<h3>Exercise</h3>
<p>As VCI uses the NDVI index to compute the impact on agriculture. NDVI over non-croplands do not make sense and should be excluded from VCI calculation. Use the <a href="https://developers.google.com/earth-engine/datasets/catalog/USGS_GFSAD1000_V1">Global Food-Support Analysis Data</a> and mask all non-cropland areas.</p>
<p><a href="https://code.earthengine.google.co.in/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3A06-Drought_Monitoring%2F06c_Calculate_VCI_(exercise)" target="_blank">Try in Code Editor ↗</a></p>
</div>
</div>
<div id="classify-vci-image" class="section level2">
<h2>07. Classify VCI Image</h2>
<p>Let us classify the VCI image into 3 categories: Good, Fair, and Poor. To select a range of values, we can use the <a href="https://courses.spatialthoughts.com/gee-water-resources-management.html#computation-on-images">boolean operators</a>. We can use the <code>.where()</code> function to perform this over an image.</p>
<div class="sourceCode" id="cb83"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> modis <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&quot;MODIS/006/MOD13Q1&quot;</span>)<span class="op">;</span></span>
<span id="cb83-2"><a href="#cb83-2" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> gfsad <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(<span class="st">&quot;USGS/GFSAD1000_V1&quot;</span>)<span class="op">;</span></span>
<span id="cb83-3"><a href="#cb83-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-4"><a href="#cb83-4" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> startYear <span class="op">=</span> <span class="dv">2010</span></span>
<span id="cb83-5"><a href="#cb83-5" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> endYear <span class="op">=</span> <span class="dv">2020</span></span>
<span id="cb83-6"><a href="#cb83-6" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> startDate <span class="op">=</span> ee<span class="op">.</span><span class="at">Date</span><span class="op">.</span><span class="fu">fromYMD</span>(startYear<span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">1</span>)</span>
<span id="cb83-7"><a href="#cb83-7" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> endDate <span class="op">=</span> ee<span class="op">.</span><span class="at">Date</span><span class="op">.</span><span class="fu">fromYMD</span>(endYear<span class="op">,</span> <span class="dv">12</span><span class="op">,</span> <span class="dv">31</span>)</span>
<span id="cb83-8"><a href="#cb83-8" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> filtered <span class="op">=</span> modis</span>
<span id="cb83-9"><a href="#cb83-9" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(startDate<span class="op">,</span> endDate))</span>
<span id="cb83-10"><a href="#cb83-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-11"><a href="#cb83-11" aria-hidden="true" tabindex="-1"></a><span class="co">// Cloud Masking</span></span>
<span id="cb83-12"><a href="#cb83-12" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> bitwiseExtract <span class="op">=</span> <span class="kw">function</span>(input<span class="op">,</span> fromBit<span class="op">,</span> toBit) {</span>
<span id="cb83-13"><a href="#cb83-13" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> maskSize <span class="op">=</span> ee<span class="op">.</span><span class="fu">Number</span>(<span class="dv">1</span>)<span class="op">.</span><span class="fu">add</span>(toBit)<span class="op">.</span><span class="fu">subtract</span>(fromBit)</span>
<span id="cb83-14"><a href="#cb83-14" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> mask <span class="op">=</span> ee<span class="op">.</span><span class="fu">Number</span>(<span class="dv">1</span>)<span class="op">.</span><span class="fu">leftShift</span>(maskSize)<span class="op">.</span><span class="fu">subtract</span>(<span class="dv">1</span>)</span>
<span id="cb83-15"><a href="#cb83-15" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> input<span class="op">.</span><span class="fu">rightShift</span>(fromBit)<span class="op">.</span><span class="fu">bitwiseAnd</span>(mask)</span>
<span id="cb83-16"><a href="#cb83-16" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb83-17"><a href="#cb83-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-18"><a href="#cb83-18" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> maskSnowAndClouds <span class="op">=</span> <span class="kw">function</span>(image) {</span>
<span id="cb83-19"><a href="#cb83-19" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> summaryQa <span class="op">=</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;SummaryQA&#39;</span>)</span>
<span id="cb83-20"><a href="#cb83-20" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Select pixels which are less than or equals to 1 (0 or 1)</span></span>
<span id="cb83-21"><a href="#cb83-21" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> qaMask <span class="op">=</span> <span class="fu">bitwiseExtract</span>(summaryQa<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">1</span>)<span class="op">.</span><span class="fu">lte</span>(<span class="dv">1</span>)</span>
<span id="cb83-22"><a href="#cb83-22" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> maskedImage <span class="op">=</span> image<span class="op">.</span><span class="fu">updateMask</span>(qaMask)</span>
<span id="cb83-23"><a href="#cb83-23" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> maskedImage<span class="op">.</span><span class="fu">copyProperties</span>(image<span class="op">,</span> [<span class="st">&#39;system:index&#39;</span><span class="op">,</span> <span class="st">&#39;system:time_start&#39;</span>])</span>
<span id="cb83-24"><a href="#cb83-24" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb83-25"><a href="#cb83-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-26"><a href="#cb83-26" aria-hidden="true" tabindex="-1"></a><span class="co">// Apply the function to all images in the collection</span></span>
<span id="cb83-27"><a href="#cb83-27" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> maskedCol <span class="op">=</span> filtered<span class="op">.</span><span class="fu">map</span>(maskSnowAndClouds)</span>
<span id="cb83-28"><a href="#cb83-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-29"><a href="#cb83-29" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> ndviCol <span class="op">=</span> maskedCol<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;NDVI&#39;</span>)</span>
<span id="cb83-30"><a href="#cb83-30" aria-hidden="true" tabindex="-1"></a><span class="co">// MODIS NDVI values come as NDVI x 10000 that need to be scaled by 0.0001</span></span>
<span id="cb83-31"><a href="#cb83-31" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> scaleNdvi <span class="op">=</span> <span class="kw">function</span>(image) {</span>
<span id="cb83-32"><a href="#cb83-32" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> scaled <span class="op">=</span> image<span class="op">.</span><span class="fu">divide</span>(<span class="dv">10000</span>)</span>
<span id="cb83-33"><a href="#cb83-33" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> scaled<span class="op">.</span><span class="fu">copyProperties</span>(image<span class="op">,</span> [<span class="st">&#39;system:index&#39;</span><span class="op">,</span> <span class="st">&#39;system:time_start&#39;</span>])</span>
<span id="cb83-34"><a href="#cb83-34" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb83-35"><a href="#cb83-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-36"><a href="#cb83-36" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> ndviScaled <span class="op">=</span> ndviCol<span class="op">.</span><span class="fu">map</span>(scaleNdvi)</span>
<span id="cb83-37"><a href="#cb83-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-38"><a href="#cb83-38" aria-hidden="true" tabindex="-1"></a><span class="co">// Create NDVI composite for every month</span></span>
<span id="cb83-39"><a href="#cb83-39" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> years <span class="op">=</span> ee<span class="op">.</span><span class="at">List</span><span class="op">.</span><span class="fu">sequence</span>(startYear<span class="op">,</span>endYear)<span class="op">;</span></span>
<span id="cb83-40"><a href="#cb83-40" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> months <span class="op">=</span> ee<span class="op">.</span><span class="at">List</span><span class="op">.</span><span class="fu">sequence</span>(<span class="dv">1</span><span class="op">,</span> <span class="dv">12</span>)<span class="op">;</span></span>
<span id="cb83-41"><a href="#cb83-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-42"><a href="#cb83-42" aria-hidden="true" tabindex="-1"></a><span class="co">// Map over the years and create a monthly average collection</span></span>
<span id="cb83-43"><a href="#cb83-43" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> monthlyImages <span class="op">=</span> years<span class="op">.</span><span class="fu">map</span>(<span class="kw">function</span>(year) {</span>
<span id="cb83-44"><a href="#cb83-44" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> months<span class="op">.</span><span class="fu">map</span>(<span class="kw">function</span>(month) {</span>
<span id="cb83-45"><a href="#cb83-45" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> filtered <span class="op">=</span> ndviScaled</span>
<span id="cb83-46"><a href="#cb83-46" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">calendarRange</span>(year<span class="op">,</span> year<span class="op">,</span> <span class="st">&#39;year&#39;</span>))</span>
<span id="cb83-47"><a href="#cb83-47" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">calendarRange</span>(month<span class="op">,</span> month<span class="op">,</span> <span class="st">&#39;month&#39;</span>))</span>
<span id="cb83-48"><a href="#cb83-48" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> monthly <span class="op">=</span> filtered<span class="op">.</span><span class="fu">mean</span>()</span>
<span id="cb83-49"><a href="#cb83-49" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> monthly<span class="op">.</span><span class="fu">set</span>({<span class="st">&#39;month&#39;</span><span class="op">:</span> month<span class="op">,</span> <span class="st">&#39;year&#39;</span><span class="op">:</span> year})</span>
<span id="cb83-50"><a href="#cb83-50" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb83-51"><a href="#cb83-51" aria-hidden="true" tabindex="-1"></a>})<span class="op">.</span><span class="fu">flatten</span>()</span>
<span id="cb83-52"><a href="#cb83-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-53"><a href="#cb83-53" aria-hidden="true" tabindex="-1"></a><span class="co">// We now have 1 image per month for entire duratioon</span></span>
<span id="cb83-54"><a href="#cb83-54" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> monthlyCol <span class="op">=</span> ee<span class="op">.</span><span class="at">ImageCollection</span><span class="op">.</span><span class="fu">fromImages</span>(monthlyImages)</span>
<span id="cb83-55"><a href="#cb83-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-56"><a href="#cb83-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-57"><a href="#cb83-57" aria-hidden="true" tabindex="-1"></a><span class="co">// We can compute Minimum NDVI for each month across all years</span></span>
<span id="cb83-58"><a href="#cb83-58" aria-hidden="true" tabindex="-1"></a><span class="co">// i.e. Minimum NDVI for all May months in the collection</span></span>
<span id="cb83-59"><a href="#cb83-59" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> monthlyMinImages <span class="op">=</span> months<span class="op">.</span><span class="fu">map</span>(<span class="kw">function</span>(month) {</span>
<span id="cb83-60"><a href="#cb83-60" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> filtered <span class="op">=</span> monthlyCol<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;month&#39;</span><span class="op">,</span> month))</span>
<span id="cb83-61"><a href="#cb83-61" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> monthlyMin <span class="op">=</span> filtered<span class="op">.</span><span class="fu">min</span>()</span>
<span id="cb83-62"><a href="#cb83-62" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> monthlyMin<span class="op">.</span><span class="fu">set</span>(<span class="st">&#39;month&#39;</span><span class="op">,</span> month)</span>
<span id="cb83-63"><a href="#cb83-63" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb83-64"><a href="#cb83-64" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> monthlyMin <span class="op">=</span> ee<span class="op">.</span><span class="at">ImageCollection</span><span class="op">.</span><span class="fu">fromImages</span>(monthlyMinImages)</span>
<span id="cb83-65"><a href="#cb83-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-66"><a href="#cb83-66" aria-hidden="true" tabindex="-1"></a><span class="co">// We can compute Maximum NDVI for each month across all years</span></span>
<span id="cb83-67"><a href="#cb83-67" aria-hidden="true" tabindex="-1"></a><span class="co">// i.e. Maximum NDVI for all May months in the collection</span></span>
<span id="cb83-68"><a href="#cb83-68" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> monthlyMaxImages <span class="op">=</span> months<span class="op">.</span><span class="fu">map</span>(<span class="kw">function</span>(month) {</span>
<span id="cb83-69"><a href="#cb83-69" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> filtered <span class="op">=</span> monthlyCol<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;month&#39;</span><span class="op">,</span> month))</span>
<span id="cb83-70"><a href="#cb83-70" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> monthlyMax <span class="op">=</span> filtered<span class="op">.</span><span class="fu">max</span>()</span>
<span id="cb83-71"><a href="#cb83-71" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> monthlyMax<span class="op">.</span><span class="fu">set</span>(<span class="st">&#39;month&#39;</span><span class="op">,</span> month)</span>
<span id="cb83-72"><a href="#cb83-72" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb83-73"><a href="#cb83-73" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> monthlyMax <span class="op">=</span> ee<span class="op">.</span><span class="at">ImageCollection</span><span class="op">.</span><span class="fu">fromImages</span>(monthlyMaxImages)</span>
<span id="cb83-74"><a href="#cb83-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-75"><a href="#cb83-75" aria-hidden="true" tabindex="-1"></a><span class="co">// Calculate VCI for 2020</span></span>
<span id="cb83-76"><a href="#cb83-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-77"><a href="#cb83-77" aria-hidden="true" tabindex="-1"></a><span class="co">// We are interested in calculating VCI for a particular month</span></span>
<span id="cb83-78"><a href="#cb83-78" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> currentYear <span class="op">=</span> <span class="dv">2020</span></span>
<span id="cb83-79"><a href="#cb83-79" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> currentMonth <span class="op">=</span> <span class="dv">5</span></span>
<span id="cb83-80"><a href="#cb83-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-81"><a href="#cb83-81" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> filtered <span class="op">=</span> monthlyCol</span>
<span id="cb83-82"><a href="#cb83-82" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;year&#39;</span><span class="op">,</span> currentYear))</span>
<span id="cb83-83"><a href="#cb83-83" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;month&#39;</span><span class="op">,</span> currentMonth))</span>
<span id="cb83-84"><a href="#cb83-84" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> currentMonthNdvi <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(filtered<span class="op">.</span><span class="fu">first</span>())</span>
<span id="cb83-85"><a href="#cb83-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-86"><a href="#cb83-86" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> minNdvi <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(monthlyMin<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;month&#39;</span><span class="op">,</span> currentMonth))<span class="op">.</span><span class="fu">first</span>())</span>
<span id="cb83-87"><a href="#cb83-87" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> maxNdvi <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(monthlyMax<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;month&#39;</span><span class="op">,</span> currentMonth))<span class="op">.</span><span class="fu">first</span>())</span>
<span id="cb83-88"><a href="#cb83-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-89"><a href="#cb83-89" aria-hidden="true" tabindex="-1"></a><span class="co">// VCI = (NDVI - min) / (max - min)</span></span>
<span id="cb83-90"><a href="#cb83-90" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> image <span class="op">=</span> ee<span class="op">.</span><span class="at">Image</span><span class="op">.</span><span class="fu">cat</span>([currentMonthNdvi<span class="op">,</span> minNdvi<span class="op">,</span> maxNdvi])<span class="op">.</span><span class="fu">rename</span>([<span class="st">&#39;ndvi&#39;</span><span class="op">,</span> <span class="st">&#39;min&#39;</span><span class="op">,</span> <span class="st">&#39;max&#39;</span>])</span>
<span id="cb83-91"><a href="#cb83-91" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> vci <span class="op">=</span> image<span class="op">.</span><span class="fu">expression</span>(<span class="st">&#39;100* (ndvi - min) / (max - min)&#39;</span><span class="op">,</span></span>
<span id="cb83-92"><a href="#cb83-92" aria-hidden="true" tabindex="-1"></a>    {<span class="st">&#39;ndvi&#39;</span><span class="op">:</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;ndvi&#39;</span>)<span class="op">,</span></span>
<span id="cb83-93"><a href="#cb83-93" aria-hidden="true" tabindex="-1"></a>      <span class="st">&#39;min&#39;</span><span class="op">:</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;min&#39;</span>)<span class="op">,</span></span>
<span id="cb83-94"><a href="#cb83-94" aria-hidden="true" tabindex="-1"></a>      <span class="st">&#39;max&#39;</span><span class="op">:</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;max&#39;</span>)</span>
<span id="cb83-95"><a href="#cb83-95" aria-hidden="true" tabindex="-1"></a>    })<span class="op">.</span><span class="fu">rename</span>(<span class="st">&#39;vci&#39;</span>)</span>
<span id="cb83-96"><a href="#cb83-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-97"><a href="#cb83-97" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> cropLand <span class="op">=</span> gfsad<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;landcover&#39;</span>)<span class="op">.</span><span class="fu">neq</span>(<span class="dv">0</span>)</span>
<span id="cb83-98"><a href="#cb83-98" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> vciMasked <span class="op">=</span> vci<span class="op">.</span><span class="fu">updateMask</span>(cropLand)</span>
<span id="cb83-99"><a href="#cb83-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-100"><a href="#cb83-100" aria-hidden="true" tabindex="-1"></a><span class="co">// Vegetation Condition Classification</span></span>
<span id="cb83-101"><a href="#cb83-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-102"><a href="#cb83-102" aria-hidden="true" tabindex="-1"></a><span class="co">// | VCI    | Condition |</span></span>
<span id="cb83-103"><a href="#cb83-103" aria-hidden="true" tabindex="-1"></a><span class="co">// | 60-100 | Good      |</span></span>
<span id="cb83-104"><a href="#cb83-104" aria-hidden="true" tabindex="-1"></a><span class="co">// | 40-60  | Fair      |</span></span>
<span id="cb83-105"><a href="#cb83-105" aria-hidden="true" tabindex="-1"></a><span class="co">// | 0-40   | Poor      |</span></span>
<span id="cb83-106"><a href="#cb83-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-107"><a href="#cb83-107" aria-hidden="true" tabindex="-1"></a><span class="co">// Use .where() function to classify continuous images to</span></span>
<span id="cb83-108"><a href="#cb83-108" aria-hidden="true" tabindex="-1"></a><span class="co">// discrete values</span></span>
<span id="cb83-109"><a href="#cb83-109" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> condition <span class="op">=</span> vciMasked</span>
<span id="cb83-110"><a href="#cb83-110" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">where</span>(vciMasked<span class="op">.</span><span class="fu">lt</span>(<span class="dv">40</span>)<span class="op">,</span> <span class="dv">1</span>)</span>
<span id="cb83-111"><a href="#cb83-111" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">where</span>(vciMasked<span class="op">.</span><span class="fu">gte</span>(<span class="dv">40</span>)<span class="op">.</span><span class="fu">and</span>(vciMasked<span class="op">.</span><span class="fu">lt</span>(<span class="dv">60</span>))<span class="op">,</span> <span class="dv">2</span>)</span>
<span id="cb83-112"><a href="#cb83-112" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">where</span>(vciMasked<span class="op">.</span><span class="fu">gte</span>(<span class="dv">60</span>)<span class="op">,</span> <span class="dv">3</span>)</span>
<span id="cb83-113"><a href="#cb83-113" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb83-114"><a href="#cb83-114" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> vciPalette <span class="op">=</span> [<span class="st">&#39;#a50026&#39;</span><span class="op">,</span><span class="st">&#39;#d73027&#39;</span><span class="op">,</span><span class="st">&#39;#f46d43&#39;</span><span class="op">,</span><span class="st">&#39;#fdae61&#39;</span><span class="op">,</span></span>
<span id="cb83-115"><a href="#cb83-115" aria-hidden="true" tabindex="-1"></a>  <span class="st">&#39;#fee08b&#39;</span><span class="op">,</span><span class="st">&#39;#d9ef8b&#39;</span><span class="op">,</span><span class="st">&#39;#a6d96a&#39;</span><span class="op">,</span><span class="st">&#39;#66bd63&#39;</span><span class="op">,</span><span class="st">&#39;#1a9850&#39;</span><span class="op">,</span><span class="st">&#39;#006837&#39;</span>]<span class="op">;</span></span>
<span id="cb83-116"><a href="#cb83-116" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> vciVisParams <span class="op">=</span> {<span class="dt">min</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span> <span class="dv">100</span><span class="op">,</span> <span class="dt">palette</span><span class="op">:</span> vciPalette}</span>
<span id="cb83-117"><a href="#cb83-117" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> conditionParams <span class="op">=</span> {<span class="dt">min</span><span class="op">:</span><span class="dv">1</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span><span class="dv">3</span><span class="op">,</span> <span class="dt">palette</span><span class="op">:</span> [<span class="st">&#39;#d7191c&#39;</span><span class="op">,</span><span class="st">&#39;#fdae61&#39;</span><span class="op">,</span><span class="st">&#39;#91cf60&#39;</span>]}</span>
<span id="cb83-118"><a href="#cb83-118" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(vciMasked<span class="op">,</span> vciVisParams<span class="op">,</span> <span class="st">&#39;VCI&#39;</span><span class="op">,</span> <span class="kw">false</span>)</span>
<span id="cb83-119"><a href="#cb83-119" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(condition<span class="op">,</span> conditionParams<span class="op">,</span> <span class="st">&#39;Vegetation Condition&#39;</span>)</span>
<span id="cb83-120"><a href="#cb83-120" aria-hidden="true" tabindex="-1"></a>  </span></code></pre></div>
<p><a href="https://code.earthengine.google.co.in/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3A06-Drought_Monitoring%2F07b_Classify_VCI_Image_(complete)" target="_blank">Open in Code Editor ↗</a></p>
<div class="figure" style="text-align: center">
<img src="images/gee_water_resources_management/vci_classified.png" alt="Masked and Classified VCI Image" width="50%" />
<p class="caption">
Masked and Classified VCI Image
</p>
</div>
<div id="exercise-39" class="section level3">
<h3>Exercise</h3>
<p>Extract all pixels representing Poor VCI (Value = 1) from the classified VCI image. Apply a Mask and display the regions in ‘red’ color.</p>
<p><a href="https://code.earthengine.google.co.in/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3A06-Drought_Monitoring%2F07c_Classify_VCI_Image_(exercise)" target="_blank">Try in Code Editor ↗</a></p>
</div>
</div>
</div>
<div id="earth-engine-apps" class="section level1">
<h1>07 Earth Engine Apps</h1>
<p>A simple yet powerful application of GEE is the building App. We can build these apps to share the work with others as a working model instead of a static report. Earth Engine Apps uses JavaScript internally. This module will introduce you to GEE Apps by creating Surface Water Explorer App.</p>
<blockquote>
<p>Visit this <a href="https://www.earthengine.app/">Earth Engine Apps</a> to exlpore more examples.</p>
</blockquote>
<div id="client-vs-server" class="section level2">
<h2>01. Client vs Server</h2>
<p>The User Interface elements in your Code Editor - Map View, Drawing Tools etc. are ‘client-side’ elements. They run in YOUR browser. Image Collections, feature collections, calculations on Earth Engine objects etc. are ‘server-side’ elements. They run in Google’s data center. You cannot mix both these objects. To learn more, visit the <a href="https://developers.google.com/earth-engine/guides/client_server">Client vs. Server</a> section of the Earth Engine User Guide.</p>
<ul>
<li>To convert client-side objects to server-side objects, you can use the appropriate API function. Server-side functions start with <code>ee.</code>, such <code>ee.Date()</code>, <code>ee.Image()</code> etc.</li>
<li>To convert server-side objects to client-side objects, you can call <code>.getInfo()</code> on am Earth Engine object. For the Python API, this is the only way to extract information from a server-side object, but the Javascript API provides a better (and preferred) - method for bring server-side objects to client-side using the <code>evaluate()</code> method. This method asynchronously retrieves the value of the object, without blocking the user interface - meaning it will let your code continue to execute while it fetches the value.</li>
</ul>
<div class="sourceCode" id="cb84"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Client vs. Server</span></span>
<span id="cb84-2"><a href="#cb84-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-3"><a href="#cb84-3" aria-hidden="true" tabindex="-1"></a><span class="co">// User Interface elements - Map View, Drawing Tools, Buttons, Sliders etc.</span></span>
<span id="cb84-4"><a href="#cb84-4" aria-hidden="true" tabindex="-1"></a><span class="co">// are &#39;client-side&#39;. They run in YOUR browser</span></span>
<span id="cb84-5"><a href="#cb84-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-6"><a href="#cb84-6" aria-hidden="true" tabindex="-1"></a><span class="co">// Image Collections, feature collections, calculations on Earth Engine objects</span></span>
<span id="cb84-7"><a href="#cb84-7" aria-hidden="true" tabindex="-1"></a><span class="co">// etc. are &#39;server-side&#39;. They run in Google&#39;s data center.</span></span>
<span id="cb84-8"><a href="#cb84-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-9"><a href="#cb84-9" aria-hidden="true" tabindex="-1"></a><span class="co">// You cannot mix both these objects.</span></span>
<span id="cb84-10"><a href="#cb84-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-11"><a href="#cb84-11" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> date <span class="op">=</span> <span class="st">&#39;2020-01-01&#39;</span> <span class="co">// This is client-side</span></span>
<span id="cb84-12"><a href="#cb84-12" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="kw">typeof</span>(date))</span>
<span id="cb84-13"><a href="#cb84-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-14"><a href="#cb84-14" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> eedate <span class="op">=</span> ee<span class="op">.</span><span class="fu">Date</span>(<span class="st">&#39;2020-01-01&#39;</span>)<span class="op">.</span><span class="fu">format</span>() <span class="co">// This is server-side</span></span>
<span id="cb84-15"><a href="#cb84-15" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="kw">typeof</span>(eedate)) </span>
<span id="cb84-16"><a href="#cb84-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-17"><a href="#cb84-17" aria-hidden="true" tabindex="-1"></a><span class="co">// To bring server-side objects to client-side, you can call .getInfo()</span></span>
<span id="cb84-18"><a href="#cb84-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-19"><a href="#cb84-19" aria-hidden="true" tabindex="-1"></a><span class="co">// var clientdate = eedate.getInfo()</span></span>
<span id="cb84-20"><a href="#cb84-20" aria-hidden="true" tabindex="-1"></a><span class="co">// print(clientdate)</span></span>
<span id="cb84-21"><a href="#cb84-21" aria-hidden="true" tabindex="-1"></a><span class="co">// print(typeof(clientdate)) </span></span>
<span id="cb84-22"><a href="#cb84-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-23"><a href="#cb84-23" aria-hidden="true" tabindex="-1"></a><span class="co">// getInfo() blocks the execution of your code till the value is fetched</span></span>
<span id="cb84-24"><a href="#cb84-24" aria-hidden="true" tabindex="-1"></a><span class="co">// If the value takes time to compute, your code editor will freeze</span></span>
<span id="cb84-25"><a href="#cb84-25" aria-hidden="true" tabindex="-1"></a><span class="co">// This is not a good user experience</span></span>
<span id="cb84-26"><a href="#cb84-26" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> s2 <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&quot;COPERNICUS/S2_SR&quot;</span>)</span>
<span id="cb84-27"><a href="#cb84-27" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> filtered <span class="op">=</span> s2<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(<span class="st">&#39;2020-01-01&#39;</span><span class="op">,</span> <span class="st">&#39;2020-01-31&#39;</span>))</span>
<span id="cb84-28"><a href="#cb84-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-29"><a href="#cb84-29" aria-hidden="true" tabindex="-1"></a><span class="co">//var numImages = filtered.size().getInfo()</span></span>
<span id="cb84-30"><a href="#cb84-30" aria-hidden="true" tabindex="-1"></a><span class="co">//print(numImages)</span></span>
<span id="cb84-31"><a href="#cb84-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-32"><a href="#cb84-32" aria-hidden="true" tabindex="-1"></a><span class="co">// A better approach is to use evaluate() function</span></span>
<span id="cb84-33"><a href="#cb84-33" aria-hidden="true" tabindex="-1"></a><span class="co">// This is an &#39;ascynshronous&#39; function - meaning it will let your code</span></span>
<span id="cb84-34"><a href="#cb84-34" aria-hidden="true" tabindex="-1"></a><span class="co">// continue to execute while it fetches the value</span></span>
<span id="cb84-35"><a href="#cb84-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-36"><a href="#cb84-36" aria-hidden="true" tabindex="-1"></a><span class="co">// You need to define a &#39;callback&#39; function which will be called once the </span></span>
<span id="cb84-37"><a href="#cb84-37" aria-hidden="true" tabindex="-1"></a><span class="co">// value has been computed and ready to be used.</span></span>
<span id="cb84-38"><a href="#cb84-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-39"><a href="#cb84-39" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> myCallback <span class="op">=</span> <span class="kw">function</span>(object) {</span>
<span id="cb84-40"><a href="#cb84-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">print</span>(object)</span>
<span id="cb84-41"><a href="#cb84-41" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb84-42"><a href="#cb84-42" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="st">&#39;Computing the size of the collection&#39;</span>)</span>
<span id="cb84-43"><a href="#cb84-43" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> numImages <span class="op">=</span> filtered<span class="op">.</span><span class="fu">size</span>()<span class="op">.</span><span class="fu">evaluate</span>(myCallback)</span></code></pre></div>
<p><a href="https://code.earthengine.google.co.in/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3A07-Earth_Engine_Apps%2F01b_Client_vs_Server_(complete)" target="_blank">Open in Code Editor ↗</a></p>
</div>
<div id="building-an-app-with-ui-widgets" class="section level2">
<h2>02. Building an App with UI Widgets</h2>
<p>Earth Engine comes with a User Interface API that allows you to build an interactive web application powered by Earth Engine. Building a web mapping application typically requires the skills of a full stack developer and are out of reach for most analysts and scientists. But the Earth Engine User Interface API makes this process much more accessible by providing ready-to-use widgets, such as Buttons, Drop-down Menus, Sliders etc. - and free cloud hosting to allow anyone to publish an app with just a few lines of code.</p>
<p>The apps run in your browser, so they need to use <em>client-side</em> functions. All the user interface functions are contained in the <code>ui.</code> package - such as <code>ui.Select()</code>, <code>ui.Button()</code>. You can create those elements by calling these functions with appropriate parameters. The main container object is the <code>ui.Panel()</code> which can contain different types of widgets. Learn more in the <a href="https://developers.google.com/earth-engine/guides/ui">Earth Engine User Interface API</a> section of the Earth Engine User Guide.</p>
<p>The code below shows how to build an app called Surface Water Explorer that allows anyone to pick a district in Karnataka, India then load the <em>JRC Yearly Water Classification History</em> of the district. .</p>
<div id="publishing-the-app." class="section level3">
<h3>Publishing the App.</h3>
<p>We can publish the app to be viewed by anyone regardless of having an account in the earth engine. Click the <em>Apps</em> button in the top left of the script panel and click <em>New apps</em> in the <em>Manage Apps</em> dialog. In the <em>Publish New App</em> dialog, give an app’s name, a public URL will be generated by which we can access the app. Then if you do not have a GCP account, create one and select a project in which you should publish the app. Then with the default settings, click <em>Publish.</em> It will take a few minutes for the earth engine to process your request. After that, your Geo APP will be up and running on the GCP server.</p>
<p><img src="images/gee_water_resources_management/apps_creation.png" width="75%" style="display: block; margin: auto;" /></p>
<div class="sourceCode" id="cb85"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a><span class="co">/**** Start of imports. If edited, may not auto-convert in the playground. ****/</span></span>
<span id="cb85-2"><a href="#cb85-2" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> gswYearly <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&quot;JRC/GSW1_3/YearlyHistory&quot;</span>)<span class="op">,</span></span>
<span id="cb85-3"><a href="#cb85-3" aria-hidden="true" tabindex="-1"></a>    admin2 <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">&quot;FAO/GAUL_SIMPLIFIED_500m/2015/level2&quot;</span>)<span class="op">;</span></span>
<span id="cb85-4"><a href="#cb85-4" aria-hidden="true" tabindex="-1"></a><span class="co">/***** End of imports. If edited, may not auto-convert in the playground. *****/</span></span>
<span id="cb85-5"><a href="#cb85-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-6"><a href="#cb85-6" aria-hidden="true" tabindex="-1"></a><span class="co">// Panels are the main container widgets</span></span>
<span id="cb85-7"><a href="#cb85-7" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> mainPanel <span class="op">=</span> ui<span class="op">.</span><span class="fu">Panel</span>({</span>
<span id="cb85-8"><a href="#cb85-8" aria-hidden="true" tabindex="-1"></a>  <span class="dt">style</span><span class="op">:</span> {<span class="dt">width</span><span class="op">:</span> <span class="st">&#39;300px&#39;</span>}</span>
<span id="cb85-9"><a href="#cb85-9" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb85-10"><a href="#cb85-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-11"><a href="#cb85-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-12"><a href="#cb85-12" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> title <span class="op">=</span> ui<span class="op">.</span><span class="fu">Label</span>({</span>
<span id="cb85-13"><a href="#cb85-13" aria-hidden="true" tabindex="-1"></a>  <span class="dt">value</span><span class="op">:</span> <span class="st">&#39;Surface Water Explorer&#39;</span><span class="op">,</span></span>
<span id="cb85-14"><a href="#cb85-14" aria-hidden="true" tabindex="-1"></a>  <span class="dt">style</span><span class="op">:</span> {<span class="st">&#39;fontSize&#39;</span><span class="op">:</span> <span class="st">&#39;24px&#39;</span>}</span>
<span id="cb85-15"><a href="#cb85-15" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb85-16"><a href="#cb85-16" aria-hidden="true" tabindex="-1"></a><span class="co">// You can add widgets to the panel</span></span>
<span id="cb85-17"><a href="#cb85-17" aria-hidden="true" tabindex="-1"></a>mainPanel<span class="op">.</span><span class="fu">add</span>(title)</span>
<span id="cb85-18"><a href="#cb85-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-19"><a href="#cb85-19" aria-hidden="true" tabindex="-1"></a><span class="co">// You can even add panels to other panels</span></span>
<span id="cb85-20"><a href="#cb85-20" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> admin2Panel <span class="op">=</span> ui<span class="op">.</span><span class="fu">Panel</span>()</span>
<span id="cb85-21"><a href="#cb85-21" aria-hidden="true" tabindex="-1"></a>mainPanel<span class="op">.</span><span class="fu">add</span>(admin2Panel)<span class="op">;</span></span>
<span id="cb85-22"><a href="#cb85-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-23"><a href="#cb85-23" aria-hidden="true" tabindex="-1"></a><span class="co">// Let&#39;s add a dropdown with the names of admin2 regions</span></span>
<span id="cb85-24"><a href="#cb85-24" aria-hidden="true" tabindex="-1"></a><span class="co">// We need to get all admin2 names and creat a ui.Select object</span></span>
<span id="cb85-25"><a href="#cb85-25" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> filtered <span class="op">=</span> admin2<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;ADM1_NAME&#39;</span><span class="op">,</span> <span class="st">&#39;Karnataka&#39;</span>))</span>
<span id="cb85-26"><a href="#cb85-26" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> admin2Names <span class="op">=</span> filtered<span class="op">.</span><span class="fu">aggregate_array</span>(<span class="st">&#39;ADM2_NAME&#39;</span>)</span>
<span id="cb85-27"><a href="#cb85-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-28"><a href="#cb85-28" aria-hidden="true" tabindex="-1"></a><span class="co">// We define a function that will be called when the user selects a value</span></span>
<span id="cb85-29"><a href="#cb85-29" aria-hidden="true" tabindex="-1"></a>admin2Names<span class="op">.</span><span class="fu">evaluate</span>(<span class="kw">function</span>(names){</span>
<span id="cb85-30"><a href="#cb85-30" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> dropDown <span class="op">=</span> ui<span class="op">.</span><span class="fu">Select</span>({</span>
<span id="cb85-31"><a href="#cb85-31" aria-hidden="true" tabindex="-1"></a>    <span class="dt">placeholder</span><span class="op">:</span> <span class="st">&#39;select a region&#39;</span><span class="op">,</span></span>
<span id="cb85-32"><a href="#cb85-32" aria-hidden="true" tabindex="-1"></a>    <span class="dt">items</span><span class="op">:</span> names<span class="op">,</span></span>
<span id="cb85-33"><a href="#cb85-33" aria-hidden="true" tabindex="-1"></a>    <span class="dt">onChange</span><span class="op">:</span> display</span>
<span id="cb85-34"><a href="#cb85-34" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb85-35"><a href="#cb85-35" aria-hidden="true" tabindex="-1"></a>  admin2Panel<span class="op">.</span><span class="fu">add</span>(dropDown)</span>
<span id="cb85-36"><a href="#cb85-36" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb85-37"><a href="#cb85-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-38"><a href="#cb85-38" aria-hidden="true" tabindex="-1"></a><span class="co">// This function will be called when the user changes the value in the dropdown</span></span>
<span id="cb85-39"><a href="#cb85-39" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> display <span class="op">=</span> <span class="kw">function</span>(admin2Name) {</span>
<span id="cb85-40"><a href="#cb85-40" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> selected <span class="op">=</span> ee<span class="op">.</span><span class="fu">Feature</span>(</span>
<span id="cb85-41"><a href="#cb85-41" aria-hidden="true" tabindex="-1"></a>    filtered<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;ADM2_NAME&#39;</span><span class="op">,</span> admin2Name))<span class="op">.</span><span class="fu">first</span>())</span>
<span id="cb85-42"><a href="#cb85-42" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> geometry <span class="op">=</span> selected<span class="op">.</span><span class="fu">geometry</span>()</span>
<span id="cb85-43"><a href="#cb85-43" aria-hidden="true" tabindex="-1"></a>  <span class="bu">Map</span><span class="op">.</span><span class="fu">clear</span>()</span>
<span id="cb85-44"><a href="#cb85-44" aria-hidden="true" tabindex="-1"></a>  <span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(geometry<span class="op">,</span> {<span class="dt">color</span><span class="op">:</span> <span class="st">&#39;grey&#39;</span>}<span class="op">,</span> admin2Name)</span>
<span id="cb85-45"><a href="#cb85-45" aria-hidden="true" tabindex="-1"></a>  <span class="bu">Map</span><span class="op">.</span><span class="fu">centerObject</span>(geometry<span class="op">,</span> <span class="dv">10</span>)</span>
<span id="cb85-46"><a href="#cb85-46" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb85-47"><a href="#cb85-47" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> gswYearFiltered <span class="op">=</span> gswYearly<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;year&#39;</span><span class="op">,</span> <span class="dv">2020</span>))</span>
<span id="cb85-48"><a href="#cb85-48" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> gsw2020 <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(gswYearFiltered<span class="op">.</span><span class="fu">first</span>())<span class="op">.</span><span class="fu">clip</span>(geometry)</span>
<span id="cb85-49"><a href="#cb85-49" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> water2020 <span class="op">=</span> gsw2020<span class="op">.</span><span class="fu">eq</span>(<span class="dv">2</span>)<span class="op">.</span><span class="fu">or</span>(gsw2020<span class="op">.</span><span class="fu">eq</span>(<span class="dv">3</span>))<span class="op">.</span><span class="fu">rename</span>(<span class="st">&#39;water&#39;</span>)<span class="op">.</span><span class="fu">selfMask</span>()</span>
<span id="cb85-50"><a href="#cb85-50" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb85-51"><a href="#cb85-51" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> visParams <span class="op">=</span> {<span class="dt">min</span><span class="op">:</span><span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span><span class="dv">1</span><span class="op">,</span> <span class="dt">palette</span><span class="op">:</span> [<span class="st">&#39;white&#39;</span><span class="op">,</span><span class="st">&#39;blue&#39;</span>]}</span>
<span id="cb85-52"><a href="#cb85-52" aria-hidden="true" tabindex="-1"></a>  <span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(water2020<span class="op">,</span> visParams<span class="op">,</span> <span class="st">&#39;2020 Water&#39;</span>)</span>
<span id="cb85-53"><a href="#cb85-53" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb85-54"><a href="#cb85-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb85-55"><a href="#cb85-55" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">setCenter</span>(<span class="fl">76.43</span><span class="op">,</span> <span class="fl">12.41</span><span class="op">,</span> <span class="dv">8</span>)</span>
<span id="cb85-56"><a href="#cb85-56" aria-hidden="true" tabindex="-1"></a>ui<span class="op">.</span><span class="at">root</span><span class="op">.</span><span class="fu">add</span>(mainPanel)<span class="op">;</span></span></code></pre></div>
<p><a href="https://code.earthengine.google.co.in/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3A07-Earth_Engine_Apps%2F02b_Building_an_App_with_UI_Widgets_(complete)" target="_blank">Open in Code Editor ↗</a></p>
</div>
<div id="exercise-40" class="section level3">
<h3>Exercise</h3>
<p>Create the app for your location.</p>
<div class="sourceCode" id="cb86"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Change the ADM2_NAME to a State/Provice in your region</span></span>
<span id="cb86-2"><a href="#cb86-2" aria-hidden="true" tabindex="-1"></a><span class="co">// Change the Map.setCenter to center the map on the chosen region</span></span>
<span id="cb86-3"><a href="#cb86-3" aria-hidden="true" tabindex="-1"></a><span class="co">// Test the App</span></span></code></pre></div>
<p><a href="https://code.earthengine.google.co.in/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3A07-Earth_Engine_Apps%2F02c_Building_an_App_with_UI_Widgets_(exercise)" target="_blank">Try in Code Editor ↗</a></p>
</div>
</div>
<div id="performing-calculations" class="section level2">
<h2>03. Performing Calculations</h2>
<p>We can also perform calculations based on user input, and we can do this by using the <em>onChange</em> and <code>evaluate()</code> function. Any UI algorithm that accepts user information will have an option called <em>onChange</em>, and this will initiate a function if the user changes the value. We need to perform calculations only after the data is retrieved for user inputs, and this can be done using the <em>evaluate</em> function, which works asynchronously without affecting other computations.</p>
<p><img src="images/gee_water_resources_management/apps_calculation.png" width="70%" style="display: block; margin: auto auto auto 0;" /></p>
<p><a href="https://santhosh-m.users.earthengine.app/view/surface-water-app" target="_blank">Explore App ↗</a></p>
<div class="sourceCode" id="cb87"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a><span class="co">/**** Start of imports. If edited, may not auto-convert in the playground. ****/</span></span>
<span id="cb87-2"><a href="#cb87-2" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> admin2 <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">&quot;FAO/GAUL_SIMPLIFIED_500m/2015/level2&quot;</span>)<span class="op">,</span></span>
<span id="cb87-3"><a href="#cb87-3" aria-hidden="true" tabindex="-1"></a>    gswYearly <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&quot;JRC/GSW1_3/YearlyHistory&quot;</span>)<span class="op">;</span></span>
<span id="cb87-4"><a href="#cb87-4" aria-hidden="true" tabindex="-1"></a><span class="co">/***** End of imports. If edited, may not auto-convert in the playground. *****/</span></span>
<span id="cb87-5"><a href="#cb87-5" aria-hidden="true" tabindex="-1"></a><span class="co">// Panels are the main container widgets</span></span>
<span id="cb87-6"><a href="#cb87-6" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> mainPanel <span class="op">=</span> ui<span class="op">.</span><span class="fu">Panel</span>({</span>
<span id="cb87-7"><a href="#cb87-7" aria-hidden="true" tabindex="-1"></a>  <span class="dt">style</span><span class="op">:</span> {<span class="dt">width</span><span class="op">:</span> <span class="st">&#39;300px&#39;</span>}</span>
<span id="cb87-8"><a href="#cb87-8" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb87-9"><a href="#cb87-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-10"><a href="#cb87-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-11"><a href="#cb87-11" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> title <span class="op">=</span> ui<span class="op">.</span><span class="fu">Label</span>({</span>
<span id="cb87-12"><a href="#cb87-12" aria-hidden="true" tabindex="-1"></a>  <span class="dt">value</span><span class="op">:</span> <span class="st">&#39;Surface Water Explorer&#39;</span><span class="op">,</span></span>
<span id="cb87-13"><a href="#cb87-13" aria-hidden="true" tabindex="-1"></a>  <span class="dt">style</span><span class="op">:</span> {<span class="st">&#39;fontSize&#39;</span><span class="op">:</span> <span class="st">&#39;24px&#39;</span>}</span>
<span id="cb87-14"><a href="#cb87-14" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb87-15"><a href="#cb87-15" aria-hidden="true" tabindex="-1"></a><span class="co">// You can add widgets to the panel</span></span>
<span id="cb87-16"><a href="#cb87-16" aria-hidden="true" tabindex="-1"></a>mainPanel<span class="op">.</span><span class="fu">add</span>(title)</span>
<span id="cb87-17"><a href="#cb87-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-18"><a href="#cb87-18" aria-hidden="true" tabindex="-1"></a><span class="co">// You can even add panels to other panels</span></span>
<span id="cb87-19"><a href="#cb87-19" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> admin2Panel <span class="op">=</span> ui<span class="op">.</span><span class="fu">Panel</span>()</span>
<span id="cb87-20"><a href="#cb87-20" aria-hidden="true" tabindex="-1"></a>mainPanel<span class="op">.</span><span class="fu">add</span>(admin2Panel)<span class="op">;</span></span>
<span id="cb87-21"><a href="#cb87-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-22"><a href="#cb87-22" aria-hidden="true" tabindex="-1"></a><span class="co">// Let&#39;s add a dropdown with the names of admin2 regions</span></span>
<span id="cb87-23"><a href="#cb87-23" aria-hidden="true" tabindex="-1"></a><span class="co">// We need to get all admin2 names and creat a ui.Select object</span></span>
<span id="cb87-24"><a href="#cb87-24" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> filtered <span class="op">=</span> admin2<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;ADM1_NAME&#39;</span><span class="op">,</span> <span class="st">&#39;Karnataka&#39;</span>))</span>
<span id="cb87-25"><a href="#cb87-25" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> admin2Names <span class="op">=</span> filtered<span class="op">.</span><span class="fu">aggregate_array</span>(<span class="st">&#39;ADM2_NAME&#39;</span>)</span>
<span id="cb87-26"><a href="#cb87-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-27"><a href="#cb87-27" aria-hidden="true" tabindex="-1"></a><span class="co">// We define a function that will be called when the user selects a value</span></span>
<span id="cb87-28"><a href="#cb87-28" aria-hidden="true" tabindex="-1"></a>admin2Names<span class="op">.</span><span class="fu">evaluate</span>(<span class="kw">function</span>(names){</span>
<span id="cb87-29"><a href="#cb87-29" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> dropDown <span class="op">=</span> ui<span class="op">.</span><span class="fu">Select</span>({</span>
<span id="cb87-30"><a href="#cb87-30" aria-hidden="true" tabindex="-1"></a>    <span class="dt">placeholder</span><span class="op">:</span> <span class="st">&#39;select a region&#39;</span><span class="op">,</span></span>
<span id="cb87-31"><a href="#cb87-31" aria-hidden="true" tabindex="-1"></a>    <span class="dt">items</span><span class="op">:</span> names<span class="op">,</span></span>
<span id="cb87-32"><a href="#cb87-32" aria-hidden="true" tabindex="-1"></a>    <span class="dt">onChange</span><span class="op">:</span> display</span>
<span id="cb87-33"><a href="#cb87-33" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb87-34"><a href="#cb87-34" aria-hidden="true" tabindex="-1"></a>  admin2Panel<span class="op">.</span><span class="fu">add</span>(dropDown)</span>
<span id="cb87-35"><a href="#cb87-35" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb87-36"><a href="#cb87-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-37"><a href="#cb87-37" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> resultPanel <span class="op">=</span> ui<span class="op">.</span><span class="fu">Panel</span>()<span class="op">;</span></span>
<span id="cb87-38"><a href="#cb87-38" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> areaLabel <span class="op">=</span> ui<span class="op">.</span><span class="fu">Label</span>()</span>
<span id="cb87-39"><a href="#cb87-39" aria-hidden="true" tabindex="-1"></a>resultPanel<span class="op">.</span><span class="fu">add</span>(areaLabel)</span>
<span id="cb87-40"><a href="#cb87-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-41"><a href="#cb87-41" aria-hidden="true" tabindex="-1"></a>mainPanel<span class="op">.</span><span class="fu">add</span>(resultPanel)<span class="op">;</span></span>
<span id="cb87-42"><a href="#cb87-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-43"><a href="#cb87-43" aria-hidden="true" tabindex="-1"></a><span class="co">// This function will be called when the user changes the value in the dropdown</span></span>
<span id="cb87-44"><a href="#cb87-44" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> display <span class="op">=</span> <span class="kw">function</span>(admin2Name) {</span>
<span id="cb87-45"><a href="#cb87-45" aria-hidden="true" tabindex="-1"></a>  areaLabel<span class="op">.</span><span class="fu">setValue</span>(<span class="st">&#39;&#39;</span>)</span>
<span id="cb87-46"><a href="#cb87-46" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> selected <span class="op">=</span> ee<span class="op">.</span><span class="fu">Feature</span>(</span>
<span id="cb87-47"><a href="#cb87-47" aria-hidden="true" tabindex="-1"></a>    filtered<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;ADM2_NAME&#39;</span><span class="op">,</span> admin2Name))<span class="op">.</span><span class="fu">first</span>())</span>
<span id="cb87-48"><a href="#cb87-48" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> geometry <span class="op">=</span> selected<span class="op">.</span><span class="fu">geometry</span>()</span>
<span id="cb87-49"><a href="#cb87-49" aria-hidden="true" tabindex="-1"></a>  <span class="bu">Map</span><span class="op">.</span><span class="fu">clear</span>()</span>
<span id="cb87-50"><a href="#cb87-50" aria-hidden="true" tabindex="-1"></a>  <span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(geometry<span class="op">,</span> {<span class="dt">color</span><span class="op">:</span> <span class="st">&#39;grey&#39;</span>}<span class="op">,</span> admin2Name)</span>
<span id="cb87-51"><a href="#cb87-51" aria-hidden="true" tabindex="-1"></a>  <span class="bu">Map</span><span class="op">.</span><span class="fu">centerObject</span>(geometry<span class="op">,</span> <span class="dv">10</span>)</span>
<span id="cb87-52"><a href="#cb87-52" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb87-53"><a href="#cb87-53" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> gswYearFiltered <span class="op">=</span> gswYearly<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;year&#39;</span><span class="op">,</span> <span class="dv">2020</span>))</span>
<span id="cb87-54"><a href="#cb87-54" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> gsw2020 <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(gswYearFiltered<span class="op">.</span><span class="fu">first</span>())<span class="op">.</span><span class="fu">clip</span>(geometry)</span>
<span id="cb87-55"><a href="#cb87-55" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> water2020 <span class="op">=</span> gsw2020<span class="op">.</span><span class="fu">eq</span>(<span class="dv">2</span>)<span class="op">.</span><span class="fu">or</span>(gsw2020<span class="op">.</span><span class="fu">eq</span>(<span class="dv">3</span>))<span class="op">.</span><span class="fu">rename</span>(<span class="st">&#39;water&#39;</span>)<span class="op">.</span><span class="fu">selfMask</span>()</span>
<span id="cb87-56"><a href="#cb87-56" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb87-57"><a href="#cb87-57" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> visParams <span class="op">=</span> {<span class="dt">min</span><span class="op">:</span><span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span><span class="dv">1</span><span class="op">,</span> <span class="dt">palette</span><span class="op">:</span> [<span class="st">&#39;white&#39;</span><span class="op">,</span><span class="st">&#39;blue&#39;</span>]}</span>
<span id="cb87-58"><a href="#cb87-58" aria-hidden="true" tabindex="-1"></a>  <span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(water2020<span class="op">,</span> visParams<span class="op">,</span> <span class="st">&#39;2020 Water&#39;</span>)</span>
<span id="cb87-59"><a href="#cb87-59" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb87-60"><a href="#cb87-60" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> area <span class="op">=</span> water2020<span class="op">.</span><span class="fu">multiply</span>(ee<span class="op">.</span><span class="at">Image</span><span class="op">.</span><span class="fu">pixelArea</span>())<span class="op">.</span><span class="fu">reduceRegion</span>({</span>
<span id="cb87-61"><a href="#cb87-61" aria-hidden="true" tabindex="-1"></a>    <span class="dt">reducer</span><span class="op">:</span> ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">sum</span>()<span class="op">,</span></span>
<span id="cb87-62"><a href="#cb87-62" aria-hidden="true" tabindex="-1"></a>    <span class="dt">geometry</span><span class="op">:</span> geometry<span class="op">,</span></span>
<span id="cb87-63"><a href="#cb87-63" aria-hidden="true" tabindex="-1"></a>    <span class="dt">scale</span><span class="op">:</span> <span class="dv">30</span><span class="op">,</span></span>
<span id="cb87-64"><a href="#cb87-64" aria-hidden="true" tabindex="-1"></a>    <span class="dt">maxPixels</span><span class="op">:</span> <span class="fl">1e9</span></span>
<span id="cb87-65"><a href="#cb87-65" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb87-66"><a href="#cb87-66" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb87-67"><a href="#cb87-67" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> waterArea <span class="op">=</span> ee<span class="op">.</span><span class="fu">Number</span>(area<span class="op">.</span><span class="fu">get</span>(<span class="st">&#39;water&#39;</span>))<span class="op">.</span><span class="fu">divide</span>(<span class="dv">10000</span>)<span class="op">.</span><span class="fu">round</span>()<span class="op">;</span></span>
<span id="cb87-68"><a href="#cb87-68" aria-hidden="true" tabindex="-1"></a>  waterArea<span class="op">.</span><span class="fu">evaluate</span>(<span class="kw">function</span>(result) {</span>
<span id="cb87-69"><a href="#cb87-69" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> text <span class="op">=</span> <span class="st">&#39;Surface Water Area 2020: &#39;</span> <span class="op">+</span> result <span class="op">+</span> <span class="st">&#39; Hectares&#39;</span></span>
<span id="cb87-70"><a href="#cb87-70" aria-hidden="true" tabindex="-1"></a>    areaLabel<span class="op">.</span><span class="fu">setValue</span>(text)</span>
<span id="cb87-71"><a href="#cb87-71" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb87-72"><a href="#cb87-72" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb87-73"><a href="#cb87-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb87-74"><a href="#cb87-74" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">setCenter</span>(<span class="fl">76.43</span><span class="op">,</span> <span class="fl">12.41</span><span class="op">,</span> <span class="dv">8</span>)</span>
<span id="cb87-75"><a href="#cb87-75" aria-hidden="true" tabindex="-1"></a>ui<span class="op">.</span><span class="at">root</span><span class="op">.</span><span class="fu">add</span>(mainPanel)<span class="op">;</span></span></code></pre></div>
<p><a href="https://code.earthengine.google.co.in/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3A07-Earth_Engine_Apps%2F03b_Performing_Calculations_(complete)" target="_blank">Open in Code Editor ↗</a></p>
<div id="exercise-41" class="section level3">
<h3>Exercise</h3>
<p>Before publishing your app, add your name as Autor.</p>
<div class="sourceCode" id="cb88"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Add a new panel called authorPanel</span></span>
<span id="cb88-2"><a href="#cb88-2" aria-hidden="true" tabindex="-1"></a><span class="co">// Add a new label called authorLabel with your name</span></span>
<span id="cb88-3"><a href="#cb88-3" aria-hidden="true" tabindex="-1"></a><span class="co">// Add the authorLabel to authorPanel</span></span>
<span id="cb88-4"><a href="#cb88-4" aria-hidden="true" tabindex="-1"></a><span class="co">// Add the authorPanel to the mainPanel</span></span>
<span id="cb88-5"><a href="#cb88-5" aria-hidden="true" tabindex="-1"></a><span class="co">// Test the app</span></span></code></pre></div>
<p><a href="https://code.earthengine.google.co.in/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3A07-Earth_Engine_Apps%2F03c_Performing_Calculations_(exercise)" target="_blank">Try in Code Editor ↗</a></p>
</div>
</div>
</div>
<div id="supplement" class="section level1">
<h1>Supplement</h1>
<div id="drought-monitoring-1" class="section level2">
<h2>Drought Monitoring</h2>
<div id="pie-chart-group-statistics" class="section level3">
<h3>Pie Chart Group Statistics</h3>
<div class="sourceCode" id="cb89"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> modis <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&quot;MODIS/006/MOD13Q1&quot;</span>)<span class="op">;</span></span>
<span id="cb89-2"><a href="#cb89-2" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> gfsad <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(<span class="st">&quot;USGS/GFSAD1000_V1&quot;</span>)<span class="op">;</span></span>
<span id="cb89-3"><a href="#cb89-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-4"><a href="#cb89-4" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> startYear <span class="op">=</span> <span class="dv">2010</span></span>
<span id="cb89-5"><a href="#cb89-5" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> endYear <span class="op">=</span> <span class="dv">2020</span></span>
<span id="cb89-6"><a href="#cb89-6" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> startDate <span class="op">=</span> ee<span class="op">.</span><span class="at">Date</span><span class="op">.</span><span class="fu">fromYMD</span>(startYear<span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">1</span>)</span>
<span id="cb89-7"><a href="#cb89-7" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> endDate <span class="op">=</span> ee<span class="op">.</span><span class="at">Date</span><span class="op">.</span><span class="fu">fromYMD</span>(endYear<span class="op">,</span> <span class="dv">12</span><span class="op">,</span> <span class="dv">31</span>)</span>
<span id="cb89-8"><a href="#cb89-8" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> filtered <span class="op">=</span> modis</span>
<span id="cb89-9"><a href="#cb89-9" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(startDate<span class="op">,</span> endDate))</span>
<span id="cb89-10"><a href="#cb89-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-11"><a href="#cb89-11" aria-hidden="true" tabindex="-1"></a><span class="co">// Cloud Masking</span></span>
<span id="cb89-12"><a href="#cb89-12" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> bitwiseExtract <span class="op">=</span> <span class="kw">function</span>(input<span class="op">,</span> fromBit<span class="op">,</span> toBit) {</span>
<span id="cb89-13"><a href="#cb89-13" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> maskSize <span class="op">=</span> ee<span class="op">.</span><span class="fu">Number</span>(<span class="dv">1</span>)<span class="op">.</span><span class="fu">add</span>(toBit)<span class="op">.</span><span class="fu">subtract</span>(fromBit)</span>
<span id="cb89-14"><a href="#cb89-14" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> mask <span class="op">=</span> ee<span class="op">.</span><span class="fu">Number</span>(<span class="dv">1</span>)<span class="op">.</span><span class="fu">leftShift</span>(maskSize)<span class="op">.</span><span class="fu">subtract</span>(<span class="dv">1</span>)</span>
<span id="cb89-15"><a href="#cb89-15" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> input<span class="op">.</span><span class="fu">rightShift</span>(fromBit)<span class="op">.</span><span class="fu">bitwiseAnd</span>(mask)</span>
<span id="cb89-16"><a href="#cb89-16" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb89-17"><a href="#cb89-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-18"><a href="#cb89-18" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> maskSnowAndClouds <span class="op">=</span> <span class="kw">function</span>(image) {</span>
<span id="cb89-19"><a href="#cb89-19" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> summaryQa <span class="op">=</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;SummaryQA&#39;</span>)</span>
<span id="cb89-20"><a href="#cb89-20" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Select pixels which are less than or equals to 1 (0 or 1)</span></span>
<span id="cb89-21"><a href="#cb89-21" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> qaMask <span class="op">=</span> <span class="fu">bitwiseExtract</span>(summaryQa<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">1</span>)<span class="op">.</span><span class="fu">lte</span>(<span class="dv">1</span>)</span>
<span id="cb89-22"><a href="#cb89-22" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> maskedImage <span class="op">=</span> image<span class="op">.</span><span class="fu">updateMask</span>(qaMask)</span>
<span id="cb89-23"><a href="#cb89-23" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> maskedImage<span class="op">.</span><span class="fu">copyProperties</span>(image<span class="op">,</span> [<span class="st">&#39;system:index&#39;</span><span class="op">,</span> <span class="st">&#39;system:time_start&#39;</span>])</span>
<span id="cb89-24"><a href="#cb89-24" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb89-25"><a href="#cb89-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-26"><a href="#cb89-26" aria-hidden="true" tabindex="-1"></a><span class="co">// Apply the function to all images in the collection</span></span>
<span id="cb89-27"><a href="#cb89-27" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> maskedCol <span class="op">=</span> filtered<span class="op">.</span><span class="fu">map</span>(maskSnowAndClouds)</span>
<span id="cb89-28"><a href="#cb89-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-29"><a href="#cb89-29" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> ndviCol <span class="op">=</span> maskedCol<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;NDVI&#39;</span>)</span>
<span id="cb89-30"><a href="#cb89-30" aria-hidden="true" tabindex="-1"></a><span class="co">// MODIS NDVI values come as NDVI x 10000 that need to be scaled by 0.0001</span></span>
<span id="cb89-31"><a href="#cb89-31" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> scaleNdvi <span class="op">=</span> <span class="kw">function</span>(image) {</span>
<span id="cb89-32"><a href="#cb89-32" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> scaled <span class="op">=</span> image<span class="op">.</span><span class="fu">divide</span>(<span class="dv">10000</span>)</span>
<span id="cb89-33"><a href="#cb89-33" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> scaled<span class="op">.</span><span class="fu">copyProperties</span>(image<span class="op">,</span> [<span class="st">&#39;system:index&#39;</span><span class="op">,</span> <span class="st">&#39;system:time_start&#39;</span>])</span>
<span id="cb89-34"><a href="#cb89-34" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb89-35"><a href="#cb89-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-36"><a href="#cb89-36" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> ndviScaled <span class="op">=</span> ndviCol<span class="op">.</span><span class="fu">map</span>(scaleNdvi)</span>
<span id="cb89-37"><a href="#cb89-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-38"><a href="#cb89-38" aria-hidden="true" tabindex="-1"></a><span class="co">// Create NDVI composite for every month</span></span>
<span id="cb89-39"><a href="#cb89-39" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> years <span class="op">=</span> ee<span class="op">.</span><span class="at">List</span><span class="op">.</span><span class="fu">sequence</span>(startYear<span class="op">,</span>endYear)<span class="op">;</span></span>
<span id="cb89-40"><a href="#cb89-40" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> months <span class="op">=</span> ee<span class="op">.</span><span class="at">List</span><span class="op">.</span><span class="fu">sequence</span>(<span class="dv">1</span><span class="op">,</span> <span class="dv">12</span>)<span class="op">;</span></span>
<span id="cb89-41"><a href="#cb89-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-42"><a href="#cb89-42" aria-hidden="true" tabindex="-1"></a><span class="co">// Map over the years and create a monthly average collection</span></span>
<span id="cb89-43"><a href="#cb89-43" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> monthlyImages <span class="op">=</span> years<span class="op">.</span><span class="fu">map</span>(<span class="kw">function</span>(year) {</span>
<span id="cb89-44"><a href="#cb89-44" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> months<span class="op">.</span><span class="fu">map</span>(<span class="kw">function</span>(month) {</span>
<span id="cb89-45"><a href="#cb89-45" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> filtered <span class="op">=</span> ndviScaled</span>
<span id="cb89-46"><a href="#cb89-46" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">calendarRange</span>(year<span class="op">,</span> year<span class="op">,</span> <span class="st">&#39;year&#39;</span>))</span>
<span id="cb89-47"><a href="#cb89-47" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">calendarRange</span>(month<span class="op">,</span> month<span class="op">,</span> <span class="st">&#39;month&#39;</span>))</span>
<span id="cb89-48"><a href="#cb89-48" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> monthly <span class="op">=</span> filtered<span class="op">.</span><span class="fu">mean</span>()</span>
<span id="cb89-49"><a href="#cb89-49" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> monthly<span class="op">.</span><span class="fu">set</span>({<span class="st">&#39;month&#39;</span><span class="op">:</span> month<span class="op">,</span> <span class="st">&#39;year&#39;</span><span class="op">:</span> year})</span>
<span id="cb89-50"><a href="#cb89-50" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb89-51"><a href="#cb89-51" aria-hidden="true" tabindex="-1"></a>})<span class="op">.</span><span class="fu">flatten</span>()</span>
<span id="cb89-52"><a href="#cb89-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-53"><a href="#cb89-53" aria-hidden="true" tabindex="-1"></a><span class="co">// We now have 1 image per month for entire duratioon</span></span>
<span id="cb89-54"><a href="#cb89-54" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> monthlyCol <span class="op">=</span> ee<span class="op">.</span><span class="at">ImageCollection</span><span class="op">.</span><span class="fu">fromImages</span>(monthlyImages)</span>
<span id="cb89-55"><a href="#cb89-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-56"><a href="#cb89-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-57"><a href="#cb89-57" aria-hidden="true" tabindex="-1"></a><span class="co">// We can compute Minimum NDVI for each month across all years</span></span>
<span id="cb89-58"><a href="#cb89-58" aria-hidden="true" tabindex="-1"></a><span class="co">// i.e. Minimum NDVI for all May months in the collection</span></span>
<span id="cb89-59"><a href="#cb89-59" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> monthlyMinImages <span class="op">=</span> months<span class="op">.</span><span class="fu">map</span>(<span class="kw">function</span>(month) {</span>
<span id="cb89-60"><a href="#cb89-60" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> filtered <span class="op">=</span> monthlyCol<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;month&#39;</span><span class="op">,</span> month))</span>
<span id="cb89-61"><a href="#cb89-61" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> monthlyMin <span class="op">=</span> filtered<span class="op">.</span><span class="fu">min</span>()</span>
<span id="cb89-62"><a href="#cb89-62" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> monthlyMin<span class="op">.</span><span class="fu">set</span>(<span class="st">&#39;month&#39;</span><span class="op">,</span> month)</span>
<span id="cb89-63"><a href="#cb89-63" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb89-64"><a href="#cb89-64" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> monthlyMin <span class="op">=</span> ee<span class="op">.</span><span class="at">ImageCollection</span><span class="op">.</span><span class="fu">fromImages</span>(monthlyMinImages)</span>
<span id="cb89-65"><a href="#cb89-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-66"><a href="#cb89-66" aria-hidden="true" tabindex="-1"></a><span class="co">// We can compute Maximum NDVI for each month across all years</span></span>
<span id="cb89-67"><a href="#cb89-67" aria-hidden="true" tabindex="-1"></a><span class="co">// i.e. Maximum NDVI for all May months in the collection</span></span>
<span id="cb89-68"><a href="#cb89-68" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> monthlyMaxImages <span class="op">=</span> months<span class="op">.</span><span class="fu">map</span>(<span class="kw">function</span>(month) {</span>
<span id="cb89-69"><a href="#cb89-69" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> filtered <span class="op">=</span> monthlyCol<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;month&#39;</span><span class="op">,</span> month))</span>
<span id="cb89-70"><a href="#cb89-70" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> monthlyMax <span class="op">=</span> filtered<span class="op">.</span><span class="fu">max</span>()</span>
<span id="cb89-71"><a href="#cb89-71" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> monthlyMax<span class="op">.</span><span class="fu">set</span>(<span class="st">&#39;month&#39;</span><span class="op">,</span> month)</span>
<span id="cb89-72"><a href="#cb89-72" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb89-73"><a href="#cb89-73" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> monthlyMax <span class="op">=</span> ee<span class="op">.</span><span class="at">ImageCollection</span><span class="op">.</span><span class="fu">fromImages</span>(monthlyMaxImages)</span>
<span id="cb89-74"><a href="#cb89-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-75"><a href="#cb89-75" aria-hidden="true" tabindex="-1"></a><span class="co">// Calculate VCI for 2020</span></span>
<span id="cb89-76"><a href="#cb89-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-77"><a href="#cb89-77" aria-hidden="true" tabindex="-1"></a><span class="co">// We are interested in calculating VCI for a particular month</span></span>
<span id="cb89-78"><a href="#cb89-78" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> currentYear <span class="op">=</span> <span class="dv">2020</span></span>
<span id="cb89-79"><a href="#cb89-79" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> currentMonth <span class="op">=</span> <span class="dv">5</span></span>
<span id="cb89-80"><a href="#cb89-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-81"><a href="#cb89-81" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> filtered <span class="op">=</span> monthlyCol</span>
<span id="cb89-82"><a href="#cb89-82" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;year&#39;</span><span class="op">,</span> currentYear))</span>
<span id="cb89-83"><a href="#cb89-83" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;month&#39;</span><span class="op">,</span> currentMonth))</span>
<span id="cb89-84"><a href="#cb89-84" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> currentMonthNdvi <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(filtered<span class="op">.</span><span class="fu">first</span>())</span>
<span id="cb89-85"><a href="#cb89-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-86"><a href="#cb89-86" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> minNdvi <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(monthlyMin<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;month&#39;</span><span class="op">,</span> currentMonth))<span class="op">.</span><span class="fu">first</span>())</span>
<span id="cb89-87"><a href="#cb89-87" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> maxNdvi <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(monthlyMax<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;month&#39;</span><span class="op">,</span> currentMonth))<span class="op">.</span><span class="fu">first</span>())</span>
<span id="cb89-88"><a href="#cb89-88" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-89"><a href="#cb89-89" aria-hidden="true" tabindex="-1"></a><span class="co">// VCI = (NDVI - min) / (max - min)</span></span>
<span id="cb89-90"><a href="#cb89-90" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> image <span class="op">=</span> ee<span class="op">.</span><span class="at">Image</span><span class="op">.</span><span class="fu">cat</span>([currentMonthNdvi<span class="op">,</span> minNdvi<span class="op">,</span> maxNdvi])<span class="op">.</span><span class="fu">rename</span>([<span class="st">&#39;ndvi&#39;</span><span class="op">,</span> <span class="st">&#39;min&#39;</span><span class="op">,</span> <span class="st">&#39;max&#39;</span>])</span>
<span id="cb89-91"><a href="#cb89-91" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> vci <span class="op">=</span> image<span class="op">.</span><span class="fu">expression</span>(<span class="st">&#39;100* (ndvi - min) / (max - min)&#39;</span><span class="op">,</span></span>
<span id="cb89-92"><a href="#cb89-92" aria-hidden="true" tabindex="-1"></a>    {<span class="st">&#39;ndvi&#39;</span><span class="op">:</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;ndvi&#39;</span>)<span class="op">,</span></span>
<span id="cb89-93"><a href="#cb89-93" aria-hidden="true" tabindex="-1"></a>      <span class="st">&#39;min&#39;</span><span class="op">:</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;min&#39;</span>)<span class="op">,</span></span>
<span id="cb89-94"><a href="#cb89-94" aria-hidden="true" tabindex="-1"></a>      <span class="st">&#39;max&#39;</span><span class="op">:</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;max&#39;</span>)</span>
<span id="cb89-95"><a href="#cb89-95" aria-hidden="true" tabindex="-1"></a>    })<span class="op">.</span><span class="fu">rename</span>(<span class="st">&#39;vci&#39;</span>)</span>
<span id="cb89-96"><a href="#cb89-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-97"><a href="#cb89-97" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> cropLand <span class="op">=</span> gfsad<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;landcover&#39;</span>)<span class="op">.</span><span class="fu">neq</span>(<span class="dv">0</span>)</span>
<span id="cb89-98"><a href="#cb89-98" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> vciMasked <span class="op">=</span> vci<span class="op">.</span><span class="fu">updateMask</span>(cropLand)</span>
<span id="cb89-99"><a href="#cb89-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-100"><a href="#cb89-100" aria-hidden="true" tabindex="-1"></a><span class="co">// Vegetation Condition Classification</span></span>
<span id="cb89-101"><a href="#cb89-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-102"><a href="#cb89-102" aria-hidden="true" tabindex="-1"></a><span class="co">// | VCI    | Condition |</span></span>
<span id="cb89-103"><a href="#cb89-103" aria-hidden="true" tabindex="-1"></a><span class="co">// | 60-100 | Good      |</span></span>
<span id="cb89-104"><a href="#cb89-104" aria-hidden="true" tabindex="-1"></a><span class="co">// | 40-60  | Fair      |</span></span>
<span id="cb89-105"><a href="#cb89-105" aria-hidden="true" tabindex="-1"></a><span class="co">// | 0-40   | Poor      |</span></span>
<span id="cb89-106"><a href="#cb89-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-107"><a href="#cb89-107" aria-hidden="true" tabindex="-1"></a><span class="co">// Use .where() function to classify continuous images to</span></span>
<span id="cb89-108"><a href="#cb89-108" aria-hidden="true" tabindex="-1"></a><span class="co">// discrete values</span></span>
<span id="cb89-109"><a href="#cb89-109" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> condition <span class="op">=</span> vciMasked</span>
<span id="cb89-110"><a href="#cb89-110" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">where</span>(vciMasked<span class="op">.</span><span class="fu">lt</span>(<span class="dv">40</span>)<span class="op">,</span> <span class="dv">1</span>)</span>
<span id="cb89-111"><a href="#cb89-111" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">where</span>(vciMasked<span class="op">.</span><span class="fu">gte</span>(<span class="dv">40</span>)<span class="op">.</span><span class="fu">and</span>(vciMasked<span class="op">.</span><span class="fu">lt</span>(<span class="dv">60</span>))<span class="op">,</span> <span class="dv">2</span>)</span>
<span id="cb89-112"><a href="#cb89-112" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">where</span>(vciMasked<span class="op">.</span><span class="fu">gte</span>(<span class="dv">60</span>)<span class="op">,</span> <span class="dv">3</span>)</span>
<span id="cb89-113"><a href="#cb89-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-114"><a href="#cb89-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-115"><a href="#cb89-115" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> admin1 <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">&quot;FAO/GAUL_SIMPLIFIED_500m/2015/level1&quot;</span>)<span class="op">;</span></span>
<span id="cb89-116"><a href="#cb89-116" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> karnataka <span class="op">=</span> admin1<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;ADM1_NAME&#39;</span><span class="op">,</span> <span class="st">&#39;Karnataka&#39;</span>))</span>
<span id="cb89-117"><a href="#cb89-117" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> geometry <span class="op">=</span> karnataka<span class="op">.</span><span class="fu">geometry</span>()</span>
<span id="cb89-118"><a href="#cb89-118" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">centerObject</span>(geometry)</span>
<span id="cb89-119"><a href="#cb89-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-120"><a href="#cb89-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-121"><a href="#cb89-121" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> conditionParams <span class="op">=</span> {<span class="dt">min</span><span class="op">:</span><span class="dv">1</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span><span class="dv">3</span><span class="op">,</span> <span class="dt">palette</span><span class="op">:</span> [<span class="st">&#39;#d7191c&#39;</span><span class="op">,</span><span class="st">&#39;#fdae61&#39;</span><span class="op">,</span><span class="st">&#39;#91cf60&#39;</span>]}</span>
<span id="cb89-122"><a href="#cb89-122" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(condition<span class="op">.</span><span class="fu">clip</span>(geometry)<span class="op">,</span> conditionParams<span class="op">,</span> <span class="st">&#39;Vegetation Condition&#39;</span>)</span>
<span id="cb89-123"><a href="#cb89-123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-124"><a href="#cb89-124" aria-hidden="true" tabindex="-1"></a><span class="co">// Create a Pie-Chart of Vegetation Condition for the State</span></span>
<span id="cb89-125"><a href="#cb89-125" aria-hidden="true" tabindex="-1"></a><span class="co">// Code adapted from </span></span>
<span id="cb89-126"><a href="#cb89-126" aria-hidden="true" tabindex="-1"></a><span class="co">// https://developers.google.com/earth-engine/tutorials/tutorial_global_surface_water_04</span></span>
<span id="cb89-127"><a href="#cb89-127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-128"><a href="#cb89-128" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> areaImage <span class="op">=</span>  ee<span class="op">.</span><span class="at">Image</span><span class="op">.</span><span class="fu">pixelArea</span>()<span class="op">.</span><span class="fu">divide</span>(<span class="fl">1e5</span>)<span class="op">.</span><span class="fu">addBands</span>(condition)<span class="op">;</span></span>
<span id="cb89-129"><a href="#cb89-129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-130"><a href="#cb89-130" aria-hidden="true" tabindex="-1"></a><span class="co">// Run a Grouped Reducer to get area by class</span></span>
<span id="cb89-131"><a href="#cb89-131" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> stats <span class="op">=</span> areaImage<span class="op">.</span><span class="fu">reduceRegion</span>({</span>
<span id="cb89-132"><a href="#cb89-132" aria-hidden="true" tabindex="-1"></a>  <span class="dt">reducer</span><span class="op">:</span> ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">sum</span>()<span class="op">.</span><span class="fu">group</span>({</span>
<span id="cb89-133"><a href="#cb89-133" aria-hidden="true" tabindex="-1"></a>    <span class="dt">groupField</span><span class="op">:</span> <span class="dv">1</span><span class="op">,</span></span>
<span id="cb89-134"><a href="#cb89-134" aria-hidden="true" tabindex="-1"></a>    <span class="dt">groupName</span><span class="op">:</span> <span class="st">&#39;class&#39;</span><span class="op">,</span></span>
<span id="cb89-135"><a href="#cb89-135" aria-hidden="true" tabindex="-1"></a>  })<span class="op">,</span></span>
<span id="cb89-136"><a href="#cb89-136" aria-hidden="true" tabindex="-1"></a>  <span class="dt">geometry</span><span class="op">:</span> geometry<span class="op">,</span></span>
<span id="cb89-137"><a href="#cb89-137" aria-hidden="true" tabindex="-1"></a>  <span class="dt">scale</span><span class="op">:</span> <span class="dv">500</span><span class="op">,</span></span>
<span id="cb89-138"><a href="#cb89-138" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb89-139"><a href="#cb89-139" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-140"><a href="#cb89-140" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> areaStatsList <span class="op">=</span> ee<span class="op">.</span><span class="fu">List</span>(stats<span class="op">.</span><span class="fu">get</span>(<span class="st">&#39;groups&#39;</span>))<span class="op">;</span></span>
<span id="cb89-141"><a href="#cb89-141" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-142"><a href="#cb89-142" aria-hidden="true" tabindex="-1"></a><span class="co">// Define Dictionaries for chart labels and colors</span></span>
<span id="cb89-143"><a href="#cb89-143" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> classNames <span class="op">=</span> ee<span class="op">.</span><span class="fu">Dictionary</span>({</span>
<span id="cb89-144"><a href="#cb89-144" aria-hidden="true" tabindex="-1"></a>  <span class="st">&#39;1&#39;</span><span class="op">:</span> <span class="st">&#39;Poor&#39;</span><span class="op">,</span></span>
<span id="cb89-145"><a href="#cb89-145" aria-hidden="true" tabindex="-1"></a>  <span class="st">&#39;2&#39;</span><span class="op">:</span> <span class="st">&#39;Fair&#39;</span><span class="op">,</span></span>
<span id="cb89-146"><a href="#cb89-146" aria-hidden="true" tabindex="-1"></a>  <span class="st">&#39;3&#39;</span><span class="op">:</span> <span class="st">&#39;Good&#39;</span></span>
<span id="cb89-147"><a href="#cb89-147" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb89-148"><a href="#cb89-148" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> classPalette <span class="op">=</span> ee<span class="op">.</span><span class="fu">Dictionary</span>({</span>
<span id="cb89-149"><a href="#cb89-149" aria-hidden="true" tabindex="-1"></a>  <span class="st">&#39;1&#39;</span><span class="op">:</span> <span class="st">&#39;#d7191c&#39;</span><span class="op">,</span></span>
<span id="cb89-150"><a href="#cb89-150" aria-hidden="true" tabindex="-1"></a>  <span class="st">&#39;2&#39;</span><span class="op">:</span> <span class="st">&#39;#fdae61&#39;</span><span class="op">,</span></span>
<span id="cb89-151"><a href="#cb89-151" aria-hidden="true" tabindex="-1"></a>  <span class="st">&#39;3&#39;</span><span class="op">:</span> <span class="st">&#39;#91cf60&#39;</span></span>
<span id="cb89-152"><a href="#cb89-152" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb89-153"><a href="#cb89-153" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-154"><a href="#cb89-154" aria-hidden="true" tabindex="-1"></a><span class="co">// Convert the group stats results to a feature collection</span></span>
<span id="cb89-155"><a href="#cb89-155" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">createFeature</span>(areaStats) {</span>
<span id="cb89-156"><a href="#cb89-156" aria-hidden="true" tabindex="-1"></a>  areaStats <span class="op">=</span> ee<span class="op">.</span><span class="fu">Dictionary</span>(areaStats)<span class="op">;</span></span>
<span id="cb89-157"><a href="#cb89-157" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> classNumber <span class="op">=</span> ee<span class="op">.</span><span class="fu">Number</span>(areaStats<span class="op">.</span><span class="fu">get</span>(<span class="st">&#39;class&#39;</span>))<span class="op">.</span><span class="fu">format</span>(<span class="st">&#39;%d&#39;</span>)<span class="op">;</span></span>
<span id="cb89-158"><a href="#cb89-158" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> result <span class="op">=</span> {</span>
<span id="cb89-159"><a href="#cb89-159" aria-hidden="true" tabindex="-1"></a>      <span class="st">&#39;class&#39;</span><span class="op">:</span> classNumber<span class="op">,</span></span>
<span id="cb89-160"><a href="#cb89-160" aria-hidden="true" tabindex="-1"></a>      <span class="st">&#39;class_name&#39;</span><span class="op">:</span> classNames<span class="op">.</span><span class="fu">get</span>(classNumber)<span class="op">,</span></span>
<span id="cb89-161"><a href="#cb89-161" aria-hidden="true" tabindex="-1"></a>      <span class="st">&#39;palette&#39;</span><span class="op">:</span> classPalette<span class="op">.</span><span class="fu">get</span>(classNumber)<span class="op">,</span></span>
<span id="cb89-162"><a href="#cb89-162" aria-hidden="true" tabindex="-1"></a>      <span class="st">&#39;area_hectares&#39;</span><span class="op">:</span> areaStats<span class="op">.</span><span class="fu">get</span>(<span class="st">&#39;sum&#39;</span>)</span>
<span id="cb89-163"><a href="#cb89-163" aria-hidden="true" tabindex="-1"></a>  }<span class="op">;</span></span>
<span id="cb89-164"><a href="#cb89-164" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> ee<span class="op">.</span><span class="fu">Feature</span>(<span class="kw">null</span><span class="op">,</span> result)<span class="op">;</span>   <span class="co">// Creates a feature without a geometry.</span></span>
<span id="cb89-165"><a href="#cb89-165" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb89-166"><a href="#cb89-166" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> fc <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(areaStatsList<span class="op">.</span><span class="fu">map</span>(createFeature))</span>
<span id="cb89-167"><a href="#cb89-167" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-168"><a href="#cb89-168" aria-hidden="true" tabindex="-1"></a><span class="co">// Create a JSON dictionary that defines piechart colors based on the</span></span>
<span id="cb89-169"><a href="#cb89-169" aria-hidden="true" tabindex="-1"></a><span class="co">// transition class palette.</span></span>
<span id="cb89-170"><a href="#cb89-170" aria-hidden="true" tabindex="-1"></a><span class="co">// https://developers.google.com/chart/interactive/docs/gallery/piechart</span></span>
<span id="cb89-171"><a href="#cb89-171" aria-hidden="true" tabindex="-1"></a><span class="co">// .getInfo() is need to convert server object to JSON</span></span>
<span id="cb89-172"><a href="#cb89-172" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">createPieChartSliceDictionary</span>(fc) {</span>
<span id="cb89-173"><a href="#cb89-173" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> ee<span class="op">.</span><span class="fu">List</span>(fc<span class="op">.</span><span class="fu">aggregate_array</span>(<span class="st">&#39;palette&#39;</span>))</span>
<span id="cb89-174"><a href="#cb89-174" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">map</span>(<span class="kw">function</span>(p) { <span class="cf">return</span> {<span class="st">&#39;color&#39;</span><span class="op">:</span> p}<span class="op">;</span> })<span class="op">.</span><span class="fu">getInfo</span>()<span class="op">;</span></span>
<span id="cb89-175"><a href="#cb89-175" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb89-176"><a href="#cb89-176" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> chart <span class="op">=</span> ui<span class="op">.</span><span class="at">Chart</span><span class="op">.</span><span class="at">feature</span><span class="op">.</span><span class="fu">byFeature</span>({</span>
<span id="cb89-177"><a href="#cb89-177" aria-hidden="true" tabindex="-1"></a>    <span class="dt">features</span><span class="op">:</span> fc<span class="op">,</span></span>
<span id="cb89-178"><a href="#cb89-178" aria-hidden="true" tabindex="-1"></a>    <span class="dt">xProperty</span><span class="op">:</span> <span class="st">&#39;class_name&#39;</span><span class="op">,</span></span>
<span id="cb89-179"><a href="#cb89-179" aria-hidden="true" tabindex="-1"></a>    <span class="dt">yProperties</span><span class="op">:</span> [<span class="st">&#39;area_hectares&#39;</span><span class="op">,</span> <span class="st">&#39;class&#39;</span>]</span>
<span id="cb89-180"><a href="#cb89-180" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb89-181"><a href="#cb89-181" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">setChartType</span>(<span class="st">&#39;PieChart&#39;</span>)</span>
<span id="cb89-182"><a href="#cb89-182" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">setOptions</span>({</span>
<span id="cb89-183"><a href="#cb89-183" aria-hidden="true" tabindex="-1"></a>    <span class="dt">title</span><span class="op">:</span> <span class="st">&#39;Summary of Vegetation Condition&#39;</span><span class="op">,</span></span>
<span id="cb89-184"><a href="#cb89-184" aria-hidden="true" tabindex="-1"></a>    <span class="dt">slices</span><span class="op">:</span> <span class="fu">createPieChartSliceDictionary</span>(fc)<span class="op">,</span></span>
<span id="cb89-185"><a href="#cb89-185" aria-hidden="true" tabindex="-1"></a>    <span class="dt">sliceVisibilityThreshold</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span> <span class="co">// don&#39;t group small slices</span></span>
<span id="cb89-186"><a href="#cb89-186" aria-hidden="true" tabindex="-1"></a>    <span class="dt">is3D</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb89-187"><a href="#cb89-187" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-188"><a href="#cb89-188" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb89-189"><a href="#cb89-189" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(chart)<span class="op">;</span></span></code></pre></div>
</div>
</div>
<div id="hydrology" class="section level2">
<h2>Hydrology</h2>
<div id="chart-cumulative-rainfall" class="section level3">
<h3>Chart Cumulative Rainfall</h3>
<div class="sourceCode" id="cb90"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> chirpsDaily <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&quot;UCSB-CHG/CHIRPS/DAILY&quot;</span>)<span class="op">;</span></span>
<span id="cb90-2"><a href="#cb90-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-3"><a href="#cb90-3" aria-hidden="true" tabindex="-1"></a><span class="co">// Define a water year</span></span>
<span id="cb90-4"><a href="#cb90-4" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> startDate <span class="op">=</span> ee<span class="op">.</span><span class="fu">Date</span>(<span class="st">&#39;2020-06-01&#39;</span>)</span>
<span id="cb90-5"><a href="#cb90-5" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> endDate <span class="op">=</span> ee<span class="op">.</span><span class="fu">Date</span>(<span class="st">&#39;2020-09-30&#39;</span>)</span>
<span id="cb90-6"><a href="#cb90-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-7"><a href="#cb90-7" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> days <span class="op">=</span> endDate<span class="op">.</span><span class="fu">difference</span>(startDate<span class="op">,</span> <span class="st">&#39;day&#39;</span>)</span>
<span id="cb90-8"><a href="#cb90-8" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> daysList <span class="op">=</span> ee<span class="op">.</span><span class="at">List</span><span class="op">.</span><span class="fu">sequence</span>(<span class="dv">1</span><span class="op">,</span> days)</span>
<span id="cb90-9"><a href="#cb90-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-10"><a href="#cb90-10" aria-hidden="true" tabindex="-1"></a><span class="co">// map() a function over the list of days</span></span>
<span id="cb90-11"><a href="#cb90-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-12"><a href="#cb90-12" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> cumulativeImages <span class="op">=</span> daysList<span class="op">.</span><span class="fu">map</span>(<span class="kw">function</span>(day) {</span>
<span id="cb90-13"><a href="#cb90-13" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Filter the collection from start date till the day of computatiton</span></span>
<span id="cb90-14"><a href="#cb90-14" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> begin <span class="op">=</span> startDate</span>
<span id="cb90-15"><a href="#cb90-15" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> current <span class="op">=</span> startDate<span class="op">.</span><span class="fu">advance</span>(day<span class="op">,</span> <span class="st">&#39;day&#39;</span>)</span>
<span id="cb90-16"><a href="#cb90-16" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> filtered <span class="op">=</span> chirpsDaily<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(begin<span class="op">,</span> current))</span>
<span id="cb90-17"><a href="#cb90-17" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Use sum() to calculate total rainfall in the period</span></span>
<span id="cb90-18"><a href="#cb90-18" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Make sure to set the start_time for the image</span></span>
<span id="cb90-19"><a href="#cb90-19" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> cumulativeImage <span class="op">=</span> filtered<span class="op">.</span><span class="fu">reduce</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">sum</span>())</span>
<span id="cb90-20"><a href="#cb90-20" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">set</span>(<span class="st">&#39;system:time_start&#39;</span><span class="op">,</span> current<span class="op">.</span><span class="fu">millis</span>())</span>
<span id="cb90-21"><a href="#cb90-21" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> cumulativeImage</span>
<span id="cb90-22"><a href="#cb90-22" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb90-23"><a href="#cb90-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-24"><a href="#cb90-24" aria-hidden="true" tabindex="-1"></a><span class="co">// We have list of images containing cumulative rainfall</span></span>
<span id="cb90-25"><a href="#cb90-25" aria-hidden="true" tabindex="-1"></a><span class="co">// Put them in a collection</span></span>
<span id="cb90-26"><a href="#cb90-26" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> cumulativeCol <span class="op">=</span> ee<span class="op">.</span><span class="at">ImageCollection</span><span class="op">.</span><span class="fu">fromImages</span>(cumulativeImages)</span>
<span id="cb90-27"><a href="#cb90-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-28"><a href="#cb90-28" aria-hidden="true" tabindex="-1"></a><span class="co">// Create a point with coordinates for the city of Bengaluru, India</span></span>
<span id="cb90-29"><a href="#cb90-29" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> point <span class="op">=</span> ee<span class="op">.</span><span class="at">Geometry</span><span class="op">.</span><span class="fu">Point</span>(<span class="fl">77.5946</span><span class="op">,</span> <span class="fl">12.9716</span>)</span>
<span id="cb90-30"><a href="#cb90-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-31"><a href="#cb90-31" aria-hidden="true" tabindex="-1"></a><span class="co">// Chart cumulative rainfall</span></span>
<span id="cb90-32"><a href="#cb90-32" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> chart <span class="op">=</span> ui<span class="op">.</span><span class="at">Chart</span><span class="op">.</span><span class="at">image</span><span class="op">.</span><span class="fu">series</span>({</span>
<span id="cb90-33"><a href="#cb90-33" aria-hidden="true" tabindex="-1"></a>  <span class="dt">imageCollection</span><span class="op">:</span> cumulativeCol<span class="op">,</span> </span>
<span id="cb90-34"><a href="#cb90-34" aria-hidden="true" tabindex="-1"></a>  <span class="dt">region</span><span class="op">:</span> point<span class="op">,</span> </span>
<span id="cb90-35"><a href="#cb90-35" aria-hidden="true" tabindex="-1"></a>  <span class="dt">reducer</span><span class="op">:</span> ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">mean</span>()<span class="op">,</span> </span>
<span id="cb90-36"><a href="#cb90-36" aria-hidden="true" tabindex="-1"></a>  <span class="dt">scale</span><span class="op">:</span> <span class="dv">5566</span><span class="op">,</span></span>
<span id="cb90-37"><a href="#cb90-37" aria-hidden="true" tabindex="-1"></a>})<span class="op">.</span><span class="fu">setOptions</span>({</span>
<span id="cb90-38"><a href="#cb90-38" aria-hidden="true" tabindex="-1"></a>      <span class="dt">interpolateNulls</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb90-39"><a href="#cb90-39" aria-hidden="true" tabindex="-1"></a>      <span class="dt">lineWidth</span><span class="op">:</span> <span class="dv">1</span><span class="op">,</span></span>
<span id="cb90-40"><a href="#cb90-40" aria-hidden="true" tabindex="-1"></a>      <span class="dt">pointSize</span><span class="op">:</span> <span class="dv">3</span><span class="op">,</span></span>
<span id="cb90-41"><a href="#cb90-41" aria-hidden="true" tabindex="-1"></a>      <span class="dt">title</span><span class="op">:</span> <span class="st">&#39;Cumulative Monsoon Rainfall at Bengaluru (2020)&#39;</span><span class="op">,</span></span>
<span id="cb90-42"><a href="#cb90-42" aria-hidden="true" tabindex="-1"></a>      <span class="dt">vAxis</span><span class="op">:</span> {<span class="dt">title</span><span class="op">:</span> <span class="st">&#39;Cumulative Rainfall (mm)&#39;</span>}<span class="op">,</span></span>
<span id="cb90-43"><a href="#cb90-43" aria-hidden="true" tabindex="-1"></a>      <span class="dt">hAxis</span><span class="op">:</span> {<span class="dt">title</span><span class="op">:</span> <span class="st">&#39;Month&#39;</span><span class="op">,</span> <span class="dt">format</span><span class="op">:</span> <span class="st">&#39;YYYY-MMM&#39;</span>}</span>
<span id="cb90-44"><a href="#cb90-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb90-45"><a href="#cb90-45" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb90-46"><a href="#cb90-46" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(chart)<span class="op">;</span></span></code></pre></div>
</div>
<div id="exporting-precipitation-data" class="section level3">
<h3>Exporting Precipitation Data</h3>
<div class="sourceCode" id="cb91"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a><span class="co">// This script demonstrates how to create and export</span></span>
<span id="cb91-2"><a href="#cb91-2" aria-hidden="true" tabindex="-1"></a><span class="co">// country/continent-wide precipitation data from CHIRPS</span></span>
<span id="cb91-3"><a href="#cb91-3" aria-hidden="true" tabindex="-1"></a><span class="co">// The goal is to create 1 yearly image with 12 bands -</span></span>
<span id="cb91-4"><a href="#cb91-4" aria-hidden="true" tabindex="-1"></a><span class="co">// with each band having the monthly total precipitation</span></span>
<span id="cb91-5"><a href="#cb91-5" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> chirps <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&quot;UCSB-CHG/CHIRPS/PENTAD&quot;</span>)<span class="op">;</span></span>
<span id="cb91-6"><a href="#cb91-6" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> lsib <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">&quot;USDOS/LSIB_SIMPLE/2017&quot;</span>)<span class="op">;</span></span>
<span id="cb91-7"><a href="#cb91-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-8"><a href="#cb91-8" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> region <span class="op">=</span> lsib<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;wld_rgn&#39;</span><span class="op">,</span> <span class="st">&#39;South America&#39;</span>))</span>
<span id="cb91-9"><a href="#cb91-9" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> geometry <span class="op">=</span> region<span class="op">.</span><span class="fu">geometry</span>()</span>
<span id="cb91-10"><a href="#cb91-10" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">centerObject</span>(geometry)</span>
<span id="cb91-11"><a href="#cb91-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-12"><a href="#cb91-12" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> year <span class="op">=</span> <span class="dv">2020</span></span>
<span id="cb91-13"><a href="#cb91-13" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> months <span class="op">=</span> ee<span class="op">.</span><span class="at">List</span><span class="op">.</span><span class="fu">sequence</span>(<span class="dv">1</span><span class="op">,</span> <span class="dv">12</span>)</span>
<span id="cb91-14"><a href="#cb91-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-15"><a href="#cb91-15" aria-hidden="true" tabindex="-1"></a><span class="co">// Map over the years and create a monthly totals collection</span></span>
<span id="cb91-16"><a href="#cb91-16" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> monthlyImages <span class="op">=</span> months<span class="op">.</span><span class="fu">map</span>(<span class="kw">function</span>(month) {</span>
<span id="cb91-17"><a href="#cb91-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> filtered <span class="op">=</span> chirps</span>
<span id="cb91-18"><a href="#cb91-18" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">calendarRange</span>(year<span class="op">,</span> year<span class="op">,</span> <span class="st">&#39;year&#39;</span>))</span>
<span id="cb91-19"><a href="#cb91-19" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">calendarRange</span>(month<span class="op">,</span> month<span class="op">,</span> <span class="st">&#39;month&#39;</span>))</span>
<span id="cb91-20"><a href="#cb91-20" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> monthly <span class="op">=</span> filtered<span class="op">.</span><span class="fu">sum</span>()</span>
<span id="cb91-21"><a href="#cb91-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> monthly<span class="op">.</span><span class="fu">set</span>({<span class="st">&#39;month&#39;</span><span class="op">:</span> month<span class="op">,</span> <span class="st">&#39;year&#39;</span><span class="op">:</span> year})</span>
<span id="cb91-22"><a href="#cb91-22" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb91-23"><a href="#cb91-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-24"><a href="#cb91-24" aria-hidden="true" tabindex="-1"></a><span class="co">// We now have 1 image per month for the chosen year</span></span>
<span id="cb91-25"><a href="#cb91-25" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> monthlyCol <span class="op">=</span> ee<span class="op">.</span><span class="at">ImageCollection</span><span class="op">.</span><span class="fu">fromImages</span>(monthlyImages)</span>
<span id="cb91-26"><a href="#cb91-26" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="st">&#39;Image Collection:&#39;</span><span class="op">,</span> monthlyCol)</span>
<span id="cb91-27"><a href="#cb91-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-28"><a href="#cb91-28" aria-hidden="true" tabindex="-1"></a><span class="co">// Use the toBands() function to create a multi-band image</span></span>
<span id="cb91-29"><a href="#cb91-29" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> yearImage <span class="op">=</span> monthlyCol<span class="op">.</span><span class="fu">toBands</span>()</span>
<span id="cb91-30"><a href="#cb91-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-31"><a href="#cb91-31" aria-hidden="true" tabindex="-1"></a><span class="co">// Rename the bands so they have names &#39;1&#39;, &#39;2&#39; ... &#39;12&#39;</span></span>
<span id="cb91-32"><a href="#cb91-32" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> bandNames <span class="op">=</span> months<span class="op">.</span><span class="fu">map</span>(<span class="kw">function</span>(month) {</span>
<span id="cb91-33"><a href="#cb91-33" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> ee<span class="op">.</span><span class="fu">Number</span>(month)<span class="op">.</span><span class="fu">format</span>(<span class="st">&#39;%d&#39;</span>)</span>
<span id="cb91-34"><a href="#cb91-34" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb91-35"><a href="#cb91-35" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> yearImage <span class="op">=</span> yearImage<span class="op">.</span><span class="fu">rename</span>(bandNames)</span>
<span id="cb91-36"><a href="#cb91-36" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="st">&#39;Multi-band Image&#39;</span><span class="op">,</span> yearImage)</span>
<span id="cb91-37"><a href="#cb91-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-38"><a href="#cb91-38" aria-hidden="true" tabindex="-1"></a><span class="co">// Export to GeoTiff</span></span>
<span id="cb91-39"><a href="#cb91-39" aria-hidden="true" tabindex="-1"></a><span class="co">// The resulting region is large and geometry is complex/</span></span>
<span id="cb91-40"><a href="#cb91-40" aria-hidden="true" tabindex="-1"></a><span class="co">// Extract the bounding-box to be used in the export.</span></span>
<span id="cb91-41"><a href="#cb91-41" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> exportGeometry <span class="op">=</span> geometry<span class="op">.</span><span class="fu">bounds</span>()</span>
<span id="cb91-42"><a href="#cb91-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-43"><a href="#cb91-43" aria-hidden="true" tabindex="-1"></a>Export<span class="op">.</span><span class="at">image</span><span class="op">.</span><span class="fu">toDrive</span>({</span>
<span id="cb91-44"><a href="#cb91-44" aria-hidden="true" tabindex="-1"></a>  <span class="dt">image</span><span class="op">:</span> yearImage<span class="op">,</span></span>
<span id="cb91-45"><a href="#cb91-45" aria-hidden="true" tabindex="-1"></a>  <span class="dt">description</span><span class="op">:</span> <span class="st">&#39;multi_band_image_export&#39;</span><span class="op">,</span></span>
<span id="cb91-46"><a href="#cb91-46" aria-hidden="true" tabindex="-1"></a>  <span class="dt">folder</span><span class="op">:</span> <span class="st">&#39;earthengine&#39;</span><span class="op">,</span></span>
<span id="cb91-47"><a href="#cb91-47" aria-hidden="true" tabindex="-1"></a>  <span class="dt">fileNamePrefix</span><span class="op">:</span> <span class="st">&#39;precipitation&#39;</span><span class="op">,</span></span>
<span id="cb91-48"><a href="#cb91-48" aria-hidden="true" tabindex="-1"></a>  <span class="dt">region</span><span class="op">:</span> exportGeometry<span class="op">,</span></span>
<span id="cb91-49"><a href="#cb91-49" aria-hidden="true" tabindex="-1"></a>  <span class="dt">scale</span><span class="op">:</span> <span class="dv">5566</span><span class="op">,</span></span>
<span id="cb91-50"><a href="#cb91-50" aria-hidden="true" tabindex="-1"></a>  <span class="dt">crs</span><span class="op">:</span> <span class="st">&#39;EPSG:4326&#39;</span><span class="op">,</span></span>
<span id="cb91-51"><a href="#cb91-51" aria-hidden="true" tabindex="-1"></a>  <span class="dt">maxPixels</span><span class="op">:</span> <span class="fl">1e10</span></span>
<span id="cb91-52"><a href="#cb91-52" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb91-53"><a href="#cb91-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-54"><a href="#cb91-54" aria-hidden="true" tabindex="-1"></a><span class="co">// Visualize the collection by creating a yearly total image</span></span>
<span id="cb91-55"><a href="#cb91-55" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> visParams <span class="op">=</span> {</span>
<span id="cb91-56"><a href="#cb91-56" aria-hidden="true" tabindex="-1"></a>  <span class="dt">min</span><span class="op">:</span><span class="dv">0</span><span class="op">,</span></span>
<span id="cb91-57"><a href="#cb91-57" aria-hidden="true" tabindex="-1"></a>  <span class="dt">max</span><span class="op">:</span> <span class="dv">2500</span><span class="op">,</span></span>
<span id="cb91-58"><a href="#cb91-58" aria-hidden="true" tabindex="-1"></a>  <span class="dt">palette</span><span class="op">:</span> [<span class="st">&#39;#f1eef6&#39;</span><span class="op">,</span><span class="st">&#39;#bdc9e1&#39;</span><span class="op">,</span><span class="st">&#39;#74a9cf&#39;</span><span class="op">,</span><span class="st">&#39;#2b8cbe&#39;</span><span class="op">,</span><span class="st">&#39;#045a8d&#39;</span>]</span>
<span id="cb91-59"><a href="#cb91-59" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb91-60"><a href="#cb91-60" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(monthlyCol<span class="op">.</span><span class="fu">sum</span>()<span class="op">.</span><span class="fu">clip</span>(geometry)<span class="op">,</span> visParams<span class="op">,</span> <span class="st">&#39;Yearly Precipitation&#39;</span>)</span></code></pre></div>
</div>
<div id="gpm-precipitation-time-series" class="section level3">
<h3>GPM Precipitation Time Series</h3>
<div class="sourceCode" id="cb92"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a><span class="co">/**** Start of imports. If edited, may not auto-convert in the playground. ****/</span></span>
<span id="cb92-2"><a href="#cb92-2" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> gpm <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&quot;NASA/GPM_L3/IMERG_V06&quot;</span>)<span class="op">;</span></span>
<span id="cb92-3"><a href="#cb92-3" aria-hidden="true" tabindex="-1"></a><span class="co">/***** End of imports. If edited, may not auto-convert in the playground. *****/</span></span>
<span id="cb92-4"><a href="#cb92-4" aria-hidden="true" tabindex="-1"></a><span class="co">// Display GPM Precipitation Time Series</span></span>
<span id="cb92-5"><a href="#cb92-5" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> startDate <span class="op">=</span> ee<span class="op">.</span><span class="at">Date</span><span class="op">.</span><span class="fu">fromYMD</span>(<span class="dv">2021</span><span class="op">,</span> <span class="dv">8</span><span class="op">,</span> <span class="dv">4</span>)</span>
<span id="cb92-6"><a href="#cb92-6" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> endDate <span class="op">=</span> startDate<span class="op">.</span><span class="fu">advance</span>(<span class="dv">1</span><span class="op">,</span> <span class="st">&#39;day&#39;</span>)</span>
<span id="cb92-7"><a href="#cb92-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-8"><a href="#cb92-8" aria-hidden="true" tabindex="-1"></a><span class="co">// Select the Calibrated Precipitation Band</span></span>
<span id="cb92-9"><a href="#cb92-9" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> collection <span class="op">=</span> gpm<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;precipitationCal&#39;</span>)<span class="op">;</span></span>
<span id="cb92-10"><a href="#cb92-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-11"><a href="#cb92-11" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> filtered <span class="op">=</span> collection<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(startDate<span class="op">,</span> endDate))</span>
<span id="cb92-12"><a href="#cb92-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-13"><a href="#cb92-13" aria-hidden="true" tabindex="-1"></a><span class="co">// GPM units are mm/hour but image represents 30 mins</span></span>
<span id="cb92-14"><a href="#cb92-14" aria-hidden="true" tabindex="-1"></a><span class="co">// Divide by 2 to get the total precipitation within 30 mins</span></span>
<span id="cb92-15"><a href="#cb92-15" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> filtered <span class="op">=</span> filtered<span class="op">.</span><span class="fu">map</span>(<span class="kw">function</span>(image) {</span>
<span id="cb92-16"><a href="#cb92-16" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> image<span class="op">.</span><span class="fu">divide</span>(<span class="dv">2</span>)<span class="op">.</span><span class="fu">copyProperties</span>(image<span class="op">,</span> [<span class="st">&#39;system:time_start&#39;</span>])</span>
<span id="cb92-17"><a href="#cb92-17" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb92-18"><a href="#cb92-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-19"><a href="#cb92-19" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> geometry <span class="op">=</span> ee<span class="op">.</span><span class="at">Geometry</span><span class="op">.</span><span class="fu">Point</span>([<span class="fl">77.60412933051538</span><span class="op">,</span> <span class="fl">12.952912912328241</span>])</span>
<span id="cb92-20"><a href="#cb92-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-21"><a href="#cb92-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-22"><a href="#cb92-22" aria-hidden="true" tabindex="-1"></a><span class="co">// Display a time-series chart</span></span>
<span id="cb92-23"><a href="#cb92-23" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> chart <span class="op">=</span> ui<span class="op">.</span><span class="at">Chart</span><span class="op">.</span><span class="at">image</span><span class="op">.</span><span class="fu">series</span>({</span>
<span id="cb92-24"><a href="#cb92-24" aria-hidden="true" tabindex="-1"></a>  <span class="dt">imageCollection</span><span class="op">:</span> filtered<span class="op">,</span></span>
<span id="cb92-25"><a href="#cb92-25" aria-hidden="true" tabindex="-1"></a>  <span class="dt">region</span><span class="op">:</span> geometry<span class="op">,</span></span>
<span id="cb92-26"><a href="#cb92-26" aria-hidden="true" tabindex="-1"></a>  <span class="dt">reducer</span><span class="op">:</span> ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">mean</span>()<span class="op">,</span></span>
<span id="cb92-27"><a href="#cb92-27" aria-hidden="true" tabindex="-1"></a>  <span class="dt">scale</span><span class="op">:</span> <span class="dv">20</span></span>
<span id="cb92-28"><a href="#cb92-28" aria-hidden="true" tabindex="-1"></a>})<span class="op">.</span><span class="fu">setOptions</span>({</span>
<span id="cb92-29"><a href="#cb92-29" aria-hidden="true" tabindex="-1"></a>      <span class="dt">lineWidth</span><span class="op">:</span> <span class="dv">1</span><span class="op">,</span></span>
<span id="cb92-30"><a href="#cb92-30" aria-hidden="true" tabindex="-1"></a>      <span class="dt">title</span><span class="op">:</span> <span class="st">&#39;Precipitation Time Series&#39;</span><span class="op">,</span></span>
<span id="cb92-31"><a href="#cb92-31" aria-hidden="true" tabindex="-1"></a>      <span class="dt">interpolateNulls</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb92-32"><a href="#cb92-32" aria-hidden="true" tabindex="-1"></a>      <span class="dt">vAxis</span><span class="op">:</span> {<span class="dt">title</span><span class="op">:</span> <span class="st">&#39;30-min Precipitation (mm)&#39;</span>}<span class="op">,</span></span>
<span id="cb92-33"><a href="#cb92-33" aria-hidden="true" tabindex="-1"></a>      <span class="dt">hAxis</span><span class="op">:</span> {<span class="dt">title</span><span class="op">:</span> <span class="st">&#39;&#39;</span><span class="op">,</span> <span class="dt">format</span><span class="op">:</span> <span class="st">&#39;HH:mm&#39;</span>}</span>
<span id="cb92-34"><a href="#cb92-34" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb92-35"><a href="#cb92-35" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(chart)<span class="op">;</span></span></code></pre></div>
</div>
<div id="imd-number-of-rainy-days" class="section level3">
<h3>IMD Number of Rainy Days</h3>
<div class="sourceCode" id="cb93"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a><span class="co">/**** Start of imports. If edited, may not auto-convert in the playground. ****/</span></span>
<span id="cb93-2"><a href="#cb93-2" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> imdCol <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&quot;users/ujavalgandhi/imd/rainfall&quot;</span>)<span class="op">,</span></span>
<span id="cb93-3"><a href="#cb93-3" aria-hidden="true" tabindex="-1"></a>    india <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">&quot;users/ujavalgandhi/public/soi_india_boundary&quot;</span>)<span class="op">;</span></span>
<span id="cb93-4"><a href="#cb93-4" aria-hidden="true" tabindex="-1"></a><span class="co">/***** End of imports. If edited, may not auto-convert in the playground. *****/</span></span>
<span id="cb93-5"><a href="#cb93-5" aria-hidden="true" tabindex="-1"></a><span class="co">// IMD Collection is a processed version of raw IMD Rainfall Images</span></span>
<span id="cb93-6"><a href="#cb93-6" aria-hidden="true" tabindex="-1"></a><span class="co">// See https://github.com/spatialthoughts/projects/tree/master/imd</span></span>
<span id="cb93-7"><a href="#cb93-7" aria-hidden="true" tabindex="-1"></a><span class="co">// It has 1 image per day with a &#39;rainfall&#39; band with precipitation values in mm</span></span>
<span id="cb93-8"><a href="#cb93-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-9"><a href="#cb93-9" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> filtered <span class="op">=</span> imdCol</span>
<span id="cb93-10"><a href="#cb93-10" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(<span class="st">&#39;2017-01-01&#39;</span><span class="op">,</span> <span class="st">&#39;2017-12-31&#39;</span>))</span>
<span id="cb93-11"><a href="#cb93-11" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">bounds</span>(india))</span>
<span id="cb93-12"><a href="#cb93-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-13"><a href="#cb93-13" aria-hidden="true" tabindex="-1"></a><span class="co">// Rainy day is when the total daily rainfall is &gt; 2.5mm</span></span>
<span id="cb93-14"><a href="#cb93-14" aria-hidden="true" tabindex="-1"></a><span class="co">// Let&#39;s process the collection to find all pixels which are &#39;rainy&#39;</span></span>
<span id="cb93-15"><a href="#cb93-15" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> rainyCol <span class="op">=</span> filtered<span class="op">.</span><span class="fu">map</span>(<span class="kw">function</span>(dayImage){</span>
<span id="cb93-16"><a href="#cb93-16" aria-hidden="true" tabindex="-1"></a>  <span class="co">// selfMask() is important as it will mask all 0 values</span></span>
<span id="cb93-17"><a href="#cb93-17" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Otherwise it will still count as a valid pixel</span></span>
<span id="cb93-18"><a href="#cb93-18" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> dayImage<span class="op">.</span><span class="fu">gt</span>(<span class="fl">2.5</span>)<span class="op">.</span><span class="fu">selfMask</span>()</span>
<span id="cb93-19"><a href="#cb93-19" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb93-20"><a href="#cb93-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-21"><a href="#cb93-21" aria-hidden="true" tabindex="-1"></a><span class="co">// We can now apply a reducer to count all valid pixels from the stack of images</span></span>
<span id="cb93-22"><a href="#cb93-22" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> raindayCount <span class="op">=</span> rainyCol<span class="op">.</span><span class="fu">reduce</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">count</span>())</span>
<span id="cb93-23"><a href="#cb93-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-24"><a href="#cb93-24" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> visParams <span class="op">=</span> {</span>
<span id="cb93-25"><a href="#cb93-25" aria-hidden="true" tabindex="-1"></a>  <span class="dt">min</span><span class="op">:</span> <span class="dv">30</span><span class="op">,</span></span>
<span id="cb93-26"><a href="#cb93-26" aria-hidden="true" tabindex="-1"></a>  <span class="dt">max</span><span class="op">:</span> <span class="dv">120</span><span class="op">,</span></span>
<span id="cb93-27"><a href="#cb93-27" aria-hidden="true" tabindex="-1"></a>  <span class="dt">palette</span><span class="op">:</span> [<span class="st">&#39;#feebe2&#39;</span><span class="op">,</span><span class="st">&#39;#fbb4b9&#39;</span><span class="op">,</span><span class="st">&#39;#f768a1&#39;</span><span class="op">,</span><span class="st">&#39;#c51b8a&#39;</span><span class="op">,</span><span class="st">&#39;#7a0177&#39;</span>]</span>
<span id="cb93-28"><a href="#cb93-28" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb93-29"><a href="#cb93-29" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(raindayCount<span class="op">,</span> visParams<span class="op">,</span> <span class="st">&#39;Number of Rainy Days&#39;</span>)</span></code></pre></div>
</div>
</div>
<div id="surface-water" class="section level2">
<h2>Surface Water</h2>
<div id="detect-first-year-of-water" class="section level3">
<h3>Detect First Year of Water</h3>
<div class="sourceCode" id="cb94"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> gswYearly <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&quot;JRC/GSW1_3/YearlyHistory&quot;</span>) </span>
<span id="cb94-2"><a href="#cb94-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-3"><a href="#cb94-3" aria-hidden="true" tabindex="-1"></a><span class="co">// Filter to select the year range for analysis</span></span>
<span id="cb94-4"><a href="#cb94-4" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> startYear <span class="op">=</span> <span class="dv">1990</span></span>
<span id="cb94-5"><a href="#cb94-5" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> endYear <span class="op">=</span> <span class="dv">2019</span></span>
<span id="cb94-6"><a href="#cb94-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-7"><a href="#cb94-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-8"><a href="#cb94-8" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> filtered <span class="op">=</span> gswYearly</span>
<span id="cb94-9"><a href="#cb94-9" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">gte</span>(<span class="st">&#39;year&#39;</span><span class="op">,</span> startYear))</span>
<span id="cb94-10"><a href="#cb94-10" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">lte</span>(<span class="st">&#39;year&#39;</span><span class="op">,</span> endYear))</span>
<span id="cb94-11"><a href="#cb94-11" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(filtered<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;waterClass&#39;</span>)<span class="op">,</span> {}<span class="op">,</span> <span class="st">&#39;Water History&#39;</span><span class="op">,</span> <span class="kw">false</span>)</span>
<span id="cb94-12"><a href="#cb94-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-13"><a href="#cb94-13" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> maskNonWater <span class="op">=</span> <span class="kw">function</span>(image) {</span>
<span id="cb94-14"><a href="#cb94-14" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Mask all pixels that are not seasonal or permanent water</span></span>
<span id="cb94-15"><a href="#cb94-15" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Pixel values</span></span>
<span id="cb94-16"><a href="#cb94-16" aria-hidden="true" tabindex="-1"></a>  <span class="co">// 2 = Seasonal Water</span></span>
<span id="cb94-17"><a href="#cb94-17" aria-hidden="true" tabindex="-1"></a>  <span class="co">// 3 = Permanent Water</span></span>
<span id="cb94-18"><a href="#cb94-18" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Return a binary image with only water pixels</span></span>
<span id="cb94-19"><a href="#cb94-19" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> image<span class="op">.</span><span class="fu">gte</span>(<span class="dv">2</span>)<span class="op">.</span><span class="fu">selfMask</span>()</span>
<span id="cb94-20"><a href="#cb94-20" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">copyProperties</span>(image<span class="op">,</span> [<span class="st">&#39;year&#39;</span>])</span>
<span id="cb94-21"><a href="#cb94-21" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb94-22"><a href="#cb94-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-23"><a href="#cb94-23" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> addYearBand <span class="op">=</span> <span class="kw">function</span> (image) {</span>
<span id="cb94-24"><a href="#cb94-24" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> year <span class="op">=</span> image<span class="op">.</span><span class="fu">get</span>(<span class="st">&#39;year&#39;</span>)<span class="op">;</span></span>
<span id="cb94-25"><a href="#cb94-25" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> yearImage <span class="op">=</span> ee<span class="op">.</span><span class="at">Image</span><span class="op">.</span><span class="fu">constant</span>(year)<span class="op">.</span><span class="fu">toShort</span>()<span class="op">;</span></span>
<span id="cb94-26"><a href="#cb94-26" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> image<span class="op">.</span><span class="fu">addBands</span>(yearImage)<span class="op">.</span><span class="fu">rename</span>([<span class="st">&#39;water&#39;</span><span class="op">,</span> <span class="st">&#39;year&#39;</span>])</span>
<span id="cb94-27"><a href="#cb94-27" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb94-28"><a href="#cb94-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-29"><a href="#cb94-29" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> processed <span class="op">=</span> filtered</span>
<span id="cb94-30"><a href="#cb94-30" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">map</span>(maskNonWater)</span>
<span id="cb94-31"><a href="#cb94-31" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">map</span>(addYearBand)</span>
<span id="cb94-32"><a href="#cb94-32" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb94-33"><a href="#cb94-33" aria-hidden="true" tabindex="-1"></a><span class="co">// Understanding Multi-input reducers</span></span>
<span id="cb94-34"><a href="#cb94-34" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> myList <span class="op">=</span> ee<span class="op">.</span><span class="fu">List</span>([[<span class="dv">3</span><span class="op">,</span><span class="dv">2</span>]<span class="op">,</span> [<span class="dv">4</span><span class="op">,</span><span class="dv">5</span>]<span class="op">,</span> [<span class="dv">1</span><span class="op">,</span><span class="dv">9</span>]<span class="op">,</span> [<span class="dv">1</span><span class="op">,</span><span class="dv">6</span>]<span class="op">,</span> [<span class="dv">9</span><span class="op">,</span><span class="dv">7</span>]])</span>
<span id="cb94-35"><a href="#cb94-35" aria-hidden="true" tabindex="-1"></a><span class="co">// ee.Reducer.min(2) will sort by first element of each item</span></span>
<span id="cb94-36"><a href="#cb94-36" aria-hidden="true" tabindex="-1"></a><span class="co">// and return that item</span></span>
<span id="cb94-37"><a href="#cb94-37" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(myList<span class="op">.</span><span class="fu">reduce</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">min</span>(<span class="dv">2</span>)))</span>
<span id="cb94-38"><a href="#cb94-38" aria-hidden="true" tabindex="-1"></a><span class="co">// We now apply this to our collection</span></span>
<span id="cb94-39"><a href="#cb94-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-40"><a href="#cb94-40" aria-hidden="true" tabindex="-1"></a><span class="co">// Our collection has 40 2-band images</span></span>
<span id="cb94-41"><a href="#cb94-41" aria-hidden="true" tabindex="-1"></a><span class="co">// &#39;water&#39; and &#39;year&#39;</span></span>
<span id="cb94-42"><a href="#cb94-42" aria-hidden="true" tabindex="-1"></a><span class="co">// Applying a reducer we will get a single 2-band image</span></span>
<span id="cb94-43"><a href="#cb94-43" aria-hidden="true" tabindex="-1"></a><span class="co">// where each pixel will have the value from the first water pixel</span></span>
<span id="cb94-44"><a href="#cb94-44" aria-hidden="true" tabindex="-1"></a><span class="co">// and corresponding year</span></span>
<span id="cb94-45"><a href="#cb94-45" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> result <span class="op">=</span> processed<span class="op">.</span><span class="fu">reduce</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">min</span>(<span class="dv">2</span>))<span class="op">.</span><span class="fu">rename</span>([<span class="st">&#39;water&#39;</span><span class="op">,</span> <span class="st">&#39;year&#39;</span>])</span>
<span id="cb94-46"><a href="#cb94-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-47"><a href="#cb94-47" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> gsw <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(<span class="st">&quot;JRC/GSW1_3/GlobalSurfaceWater&quot;</span>)</span>
<span id="cb94-48"><a href="#cb94-48" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> permanentWater <span class="op">=</span> gsw<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;seasonality&#39;</span>)<span class="op">.</span><span class="fu">gte</span>(<span class="dv">5</span>)</span>
<span id="cb94-49"><a href="#cb94-49" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> newWaterYear <span class="op">=</span> result<span class="op">.</span><span class="fu">select</span>([<span class="st">&#39;year&#39;</span>])<span class="op">.</span><span class="fu">updateMask</span>(permanentWater<span class="op">.</span><span class="fu">not</span>())</span>
<span id="cb94-50"><a href="#cb94-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-51"><a href="#cb94-51" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">setCenter</span>(<span class="fl">79.899</span><span class="op">,</span> <span class="fl">12.164</span><span class="op">,</span> <span class="dv">17</span>)</span>
<span id="cb94-52"><a href="#cb94-52" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">setOptions</span>(<span class="st">&#39;SATELLITE&#39;</span>)</span>
<span id="cb94-53"><a href="#cb94-53" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(newWaterYear<span class="op">,</span> </span>
<span id="cb94-54"><a href="#cb94-54" aria-hidden="true" tabindex="-1"></a>  {<span class="dt">min</span><span class="op">:</span> startYear<span class="op">,</span> <span class="dt">max</span><span class="op">:</span> endYear<span class="op">,</span> <span class="dt">palette</span><span class="op">:</span> [<span class="st">&#39;white&#39;</span><span class="op">,</span> <span class="st">&#39;purple&#39;</span>]}<span class="op">,</span></span>
<span id="cb94-55"><a href="#cb94-55" aria-hidden="true" tabindex="-1"></a>  <span class="st">&#39;Year of First Water&#39;</span>)</span>
<span id="cb94-56"><a href="#cb94-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-57"><a href="#cb94-57" aria-hidden="true" tabindex="-1"></a><span class="co">// Convert the pixels to vectors and label them</span></span>
<span id="cb94-58"><a href="#cb94-58" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> vectors <span class="op">=</span> newWaterYear<span class="op">.</span><span class="fu">reduceToVectors</span>({</span>
<span id="cb94-59"><a href="#cb94-59" aria-hidden="true" tabindex="-1"></a>  <span class="dt">geometry</span><span class="op">:</span> <span class="bu">Map</span><span class="op">.</span><span class="fu">getBounds</span>(<span class="kw">true</span>)<span class="op">,</span></span>
<span id="cb94-60"><a href="#cb94-60" aria-hidden="true" tabindex="-1"></a>  <span class="dt">scale</span><span class="op">:</span> <span class="dv">30</span><span class="op">,</span></span>
<span id="cb94-61"><a href="#cb94-61" aria-hidden="true" tabindex="-1"></a>  <span class="dt">eightConnected</span><span class="op">:</span> <span class="kw">true</span></span>
<span id="cb94-62"><a href="#cb94-62" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb94-63"><a href="#cb94-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-64"><a href="#cb94-64" aria-hidden="true" tabindex="-1"></a><span class="co">// 3rd party package for labelling</span></span>
<span id="cb94-65"><a href="#cb94-65" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> style <span class="op">=</span> <span class="pp">require</span>(<span class="st">&#39;users/gena/packages:style&#39;</span>)</span>
<span id="cb94-66"><a href="#cb94-66" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> textProperties <span class="op">=</span> { <span class="dt">textColor</span><span class="op">:</span> <span class="st">&#39;ffffff&#39;</span><span class="op">,</span> <span class="dt">fontSize</span><span class="op">:</span> <span class="dv">12</span><span class="op">,</span> <span class="dt">outlineColor</span><span class="op">:</span> <span class="st">&#39;000000&#39;</span>}</span>
<span id="cb94-67"><a href="#cb94-67" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> labels <span class="op">=</span> style<span class="op">.</span><span class="at">Feature</span><span class="op">.</span><span class="fu">label</span>(vectors<span class="op">,</span> <span class="st">&#39;label&#39;</span><span class="op">,</span> textProperties)</span>
<span id="cb94-68"><a href="#cb94-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-69"><a href="#cb94-69" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(labels<span class="op">,</span> {}<span class="op">,</span> <span class="st">&#39;labels&#39;</span>)</span></code></pre></div>
</div>
<div id="otsu-dynamic-thresholding" class="section level3">
<h3>Otsu Dynamic Thresholding</h3>
<div class="sourceCode" id="cb95"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> admin2 <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">&quot;FAO/GAUL_SIMPLIFIED_500m/2015/level2&quot;</span>)<span class="op">;</span></span>
<span id="cb95-2"><a href="#cb95-2" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> s2 <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&quot;COPERNICUS/S2_SR&quot;</span>)<span class="op">;</span></span>
<span id="cb95-3"><a href="#cb95-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-4"><a href="#cb95-4" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> selected <span class="op">=</span> admin2<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;ADM2_NAME&#39;</span><span class="op">,</span> <span class="st">&#39;Bangalore Urban&#39;</span>))</span>
<span id="cb95-5"><a href="#cb95-5" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> geometry <span class="op">=</span> selected<span class="op">.</span><span class="fu">geometry</span>()</span>
<span id="cb95-6"><a href="#cb95-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-7"><a href="#cb95-7" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> filtered <span class="op">=</span> s2<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">lt</span>(<span class="st">&#39;CLOUDY_PIXEL_PERCENTAGE&#39;</span><span class="op">,</span> <span class="dv">30</span>))</span>
<span id="cb95-8"><a href="#cb95-8" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(<span class="st">&#39;2019-01-01&#39;</span><span class="op">,</span> <span class="st">&#39;2020-01-01&#39;</span>))</span>
<span id="cb95-9"><a href="#cb95-9" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">bounds</span>(geometry))</span>
<span id="cb95-10"><a href="#cb95-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-11"><a href="#cb95-11" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> image <span class="op">=</span> filtered<span class="op">.</span><span class="fu">median</span>()<span class="op">.</span><span class="fu">clip</span>(geometry)<span class="op">;</span> </span>
<span id="cb95-12"><a href="#cb95-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-13"><a href="#cb95-13" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> mndwi <span class="op">=</span> image<span class="op">.</span><span class="fu">normalizedDifference</span>([<span class="st">&#39;B3&#39;</span><span class="op">,</span> <span class="st">&#39;B11&#39;</span>])<span class="op">.</span><span class="fu">rename</span>([<span class="st">&#39;mndwi&#39;</span>])<span class="op">;</span></span>
<span id="cb95-14"><a href="#cb95-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-15"><a href="#cb95-15" aria-hidden="true" tabindex="-1"></a><span class="co">// Simple Thresholding</span></span>
<span id="cb95-16"><a href="#cb95-16" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> waterMndwi <span class="op">=</span> mndwi<span class="op">.</span><span class="fu">gt</span>(<span class="dv">0</span>)</span>
<span id="cb95-17"><a href="#cb95-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-18"><a href="#cb95-18" aria-hidden="true" tabindex="-1"></a><span class="co">// Otsu Thresholding</span></span>
<span id="cb95-19"><a href="#cb95-19" aria-hidden="true" tabindex="-1"></a><span class="co">// Source https://code.earthengine.google.com/e9c699d7b5ef811d0a67c02756473e9d</span></span>
<span id="cb95-20"><a href="#cb95-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-21"><a href="#cb95-21" aria-hidden="true" tabindex="-1"></a><span class="co">// Use lower scale to avoid edges from small buildings</span></span>
<span id="cb95-22"><a href="#cb95-22" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> scale <span class="op">=</span> <span class="dv">100</span></span>
<span id="cb95-23"><a href="#cb95-23" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> bounds <span class="op">=</span> geometry</span>
<span id="cb95-24"><a href="#cb95-24" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> cannyThreshold <span class="op">=</span> <span class="fl">0.7</span></span>
<span id="cb95-25"><a href="#cb95-25" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> cannySigma <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb95-26"><a href="#cb95-26" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> minValue <span class="op">=</span> <span class="op">-</span><span class="fl">0.2</span></span>
<span id="cb95-27"><a href="#cb95-27" aria-hidden="true" tabindex="-1"></a><span class="co">// Set debug=false if you do not want the charts</span></span>
<span id="cb95-28"><a href="#cb95-28" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> debug <span class="op">=</span> <span class="kw">true</span></span>
<span id="cb95-29"><a href="#cb95-29" aria-hidden="true" tabindex="-1"></a><span class="co">// Set this higher to discard smaller edges</span></span>
<span id="cb95-30"><a href="#cb95-30" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> minEdgeLength <span class="op">=</span> <span class="dv">40</span></span>
<span id="cb95-31"><a href="#cb95-31" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> th <span class="op">=</span> <span class="fu">computeThresholdUsingOtsu</span>(</span>
<span id="cb95-32"><a href="#cb95-32" aria-hidden="true" tabindex="-1"></a>  mndwi<span class="op">,</span> scale<span class="op">,</span> bounds<span class="op">,</span> cannyThreshold<span class="op">,</span> cannySigma<span class="op">,</span> minValue<span class="op">,</span> debug<span class="op">,</span> minEdgeLength)</span>
<span id="cb95-33"><a href="#cb95-33" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="st">&#39;Threshold&#39;</span><span class="op">,</span> th)</span>
<span id="cb95-34"><a href="#cb95-34" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> waterOtsu <span class="op">=</span> mndwi<span class="op">.</span><span class="fu">gt</span>(th)<span class="op">;</span></span>
<span id="cb95-35"><a href="#cb95-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-36"><a href="#cb95-36" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> rgbVis <span class="op">=</span> {<span class="dt">min</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span> <span class="dv">3000</span><span class="op">,</span> <span class="dt">bands</span><span class="op">:</span> [<span class="st">&#39;B4&#39;</span><span class="op">,</span> <span class="st">&#39;B3&#39;</span><span class="op">,</span> <span class="st">&#39;B2&#39;</span>]}<span class="op">;</span></span>
<span id="cb95-37"><a href="#cb95-37" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> waterVis <span class="op">=</span> {<span class="dt">min</span><span class="op">:</span><span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span><span class="dv">1</span><span class="op">,</span> <span class="dt">palette</span><span class="op">:</span> [<span class="st">&#39;white&#39;</span><span class="op">,</span> <span class="st">&#39;black&#39;</span>]}</span>
<span id="cb95-38"><a href="#cb95-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-39"><a href="#cb95-39" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">centerObject</span>(geometry<span class="op">,</span> <span class="dv">10</span>)</span>
<span id="cb95-40"><a href="#cb95-40" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(image<span class="op">,</span> rgbVis<span class="op">,</span> <span class="st">&#39;Image&#39;</span>)<span class="op">;</span></span>
<span id="cb95-41"><a href="#cb95-41" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(waterMndwi<span class="op">.</span><span class="fu">selfMask</span>()<span class="op">,</span> waterVis<span class="op">,</span> <span class="st">&#39;MNDWI - Simple threshold&#39;</span>)</span>
<span id="cb95-42"><a href="#cb95-42" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(waterOtsu<span class="op">.</span><span class="fu">selfMask</span>()<span class="op">,</span> waterVis<span class="op">,</span> <span class="st">&#39;MNDWI with Otsu Thresholding&#39;</span>) </span>
<span id="cb95-43"><a href="#cb95-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-44"><a href="#cb95-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-45"><a href="#cb95-45" aria-hidden="true" tabindex="-1"></a><span class="co">/***</span></span>
<span id="cb95-46"><a href="#cb95-46" aria-hidden="true" tabindex="-1"></a><span class="co"> * Compute a threshold using Otsu method (bimodal)</span></span>
<span id="cb95-47"><a href="#cb95-47" aria-hidden="true" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb95-48"><a href="#cb95-48" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">computeThresholdUsingOtsu</span>(image<span class="op">,</span> scale<span class="op">,</span> bounds<span class="op">,</span> cannyThreshold<span class="op">,</span> cannySigma<span class="op">,</span> minValue<span class="op">,</span> debug<span class="op">,</span> minEdgeLength<span class="op">,</span> minEdgeGradient<span class="op">,</span> minEdgeValue) {</span>
<span id="cb95-49"><a href="#cb95-49" aria-hidden="true" tabindex="-1"></a>    <span class="co">// clip image edges</span></span>
<span id="cb95-50"><a href="#cb95-50" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> bufferDistance <span class="op">=</span> ee<span class="op">.</span><span class="fu">Number</span>(scale)<span class="op">.</span><span class="fu">multiply</span>(<span class="dv">10</span>)<span class="op">.</span><span class="fu">multiply</span>(<span class="op">-</span><span class="dv">1</span>)</span>
<span id="cb95-51"><a href="#cb95-51" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> mask <span class="op">=</span> image<span class="op">.</span><span class="fu">mask</span>()<span class="op">.</span><span class="fu">clip</span>(bounds<span class="op">.</span><span class="fu">buffer</span>(bufferDistance))<span class="op">;</span></span>
<span id="cb95-52"><a href="#cb95-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-53"><a href="#cb95-53" aria-hidden="true" tabindex="-1"></a>    <span class="co">// detect sharp changes</span></span>
<span id="cb95-54"><a href="#cb95-54" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> edge <span class="op">=</span> ee<span class="op">.</span><span class="at">Algorithms</span><span class="op">.</span><span class="fu">CannyEdgeDetector</span>(image<span class="op">,</span> cannyThreshold<span class="op">,</span> cannySigma)<span class="op">;</span></span>
<span id="cb95-55"><a href="#cb95-55" aria-hidden="true" tabindex="-1"></a>    edge <span class="op">=</span> edge<span class="op">.</span><span class="fu">multiply</span>(mask)<span class="op">;</span></span>
<span id="cb95-56"><a href="#cb95-56" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb95-57"><a href="#cb95-57" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(minEdgeLength) {</span>
<span id="cb95-58"><a href="#cb95-58" aria-hidden="true" tabindex="-1"></a>        <span class="kw">var</span> connected <span class="op">=</span> edge<span class="op">.</span><span class="fu">mask</span>(edge)<span class="op">.</span><span class="fu">lt</span>(cannyThreshold)<span class="op">.</span><span class="fu">connectedPixelCount</span>(<span class="dv">200</span><span class="op">,</span> <span class="kw">true</span>)<span class="op">;</span></span>
<span id="cb95-59"><a href="#cb95-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-60"><a href="#cb95-60" aria-hidden="true" tabindex="-1"></a>        <span class="kw">var</span> edgeLong <span class="op">=</span> connected<span class="op">.</span><span class="fu">gte</span>(minEdgeLength)<span class="op">;</span></span>
<span id="cb95-61"><a href="#cb95-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-62"><a href="#cb95-62" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span>(debug) {</span>
<span id="cb95-63"><a href="#cb95-63" aria-hidden="true" tabindex="-1"></a>          <span class="fu">print</span>(<span class="st">&#39;Edge length: &#39;</span><span class="op">,</span> ui<span class="op">.</span><span class="at">Chart</span><span class="op">.</span><span class="at">image</span><span class="op">.</span><span class="fu">histogram</span>(connected<span class="op">,</span> bounds<span class="op">,</span> scale<span class="op">,</span> buckets))</span>
<span id="cb95-64"><a href="#cb95-64" aria-hidden="true" tabindex="-1"></a>          </span>
<span id="cb95-65"><a href="#cb95-65" aria-hidden="true" tabindex="-1"></a>          <span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(edge<span class="op">.</span><span class="fu">mask</span>(edge)<span class="op">,</span> {<span class="dt">palette</span><span class="op">:</span>[<span class="st">&#39;ff0000&#39;</span>]}<span class="op">,</span> <span class="st">&#39;edges (short)&#39;</span><span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span></span>
<span id="cb95-66"><a href="#cb95-66" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb95-67"><a href="#cb95-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-68"><a href="#cb95-68" aria-hidden="true" tabindex="-1"></a>        edge <span class="op">=</span> edgeLong<span class="op">;</span></span>
<span id="cb95-69"><a href="#cb95-69" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb95-70"><a href="#cb95-70" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb95-71"><a href="#cb95-71" aria-hidden="true" tabindex="-1"></a>    <span class="co">// buffer around NDWI edges</span></span>
<span id="cb95-72"><a href="#cb95-72" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> edgeBuffer <span class="op">=</span> edge<span class="op">.</span><span class="fu">focal_max</span>(ee<span class="op">.</span><span class="fu">Number</span>(scale)<span class="op">,</span> <span class="st">&#39;square&#39;</span><span class="op">,</span> <span class="st">&#39;meters&#39;</span>)<span class="op">;</span></span>
<span id="cb95-73"><a href="#cb95-73" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(minEdgeValue) {</span>
<span id="cb95-74"><a href="#cb95-74" aria-hidden="true" tabindex="-1"></a>      <span class="kw">var</span> edgeMin <span class="op">=</span> image<span class="op">.</span><span class="fu">reduceNeighborhood</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">min</span>()<span class="op">,</span> ee<span class="op">.</span><span class="at">Kernel</span><span class="op">.</span><span class="fu">circle</span>(ee<span class="op">.</span><span class="fu">Number</span>(scale)<span class="op">,</span> <span class="st">&#39;meters&#39;</span>))</span>
<span id="cb95-75"><a href="#cb95-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-76"><a href="#cb95-76" aria-hidden="true" tabindex="-1"></a>      edgeBuffer <span class="op">=</span> edgeBuffer<span class="op">.</span><span class="fu">updateMask</span>(edgeMin<span class="op">.</span><span class="fu">gt</span>(minEdgeValue))</span>
<span id="cb95-77"><a href="#cb95-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-78"><a href="#cb95-78" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span>(debug) {</span>
<span id="cb95-79"><a href="#cb95-79" aria-hidden="true" tabindex="-1"></a>        <span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(edge<span class="op">.</span><span class="fu">updateMask</span>(edgeBuffer)<span class="op">,</span> {<span class="dt">palette</span><span class="op">:</span>[<span class="st">&#39;ff0000&#39;</span>]}<span class="op">,</span> <span class="st">&#39;edge min&#39;</span><span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span></span>
<span id="cb95-80"><a href="#cb95-80" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb95-81"><a href="#cb95-81" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb95-82"><a href="#cb95-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-83"><a href="#cb95-83" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(minEdgeGradient) {</span>
<span id="cb95-84"><a href="#cb95-84" aria-hidden="true" tabindex="-1"></a>      <span class="kw">var</span> edgeGradient <span class="op">=</span> image<span class="op">.</span><span class="fu">gradient</span>()<span class="op">.</span><span class="fu">abs</span>()<span class="op">.</span><span class="fu">reduce</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">max</span>())<span class="op">.</span><span class="fu">updateMask</span>(edgeBuffer<span class="op">.</span><span class="fu">mask</span>())</span>
<span id="cb95-85"><a href="#cb95-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-86"><a href="#cb95-86" aria-hidden="true" tabindex="-1"></a>      <span class="kw">var</span> edgeGradientTh <span class="op">=</span> ee<span class="op">.</span><span class="fu">Number</span>(edgeGradient<span class="op">.</span><span class="fu">reduceRegion</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">percentile</span>([minEdgeGradient])<span class="op">,</span> bounds<span class="op">,</span> scale)<span class="op">.</span><span class="fu">values</span>()<span class="op">.</span><span class="fu">get</span>(<span class="dv">0</span>))</span>
<span id="cb95-87"><a href="#cb95-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-88"><a href="#cb95-88" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span>(debug) {e</span>
<span id="cb95-89"><a href="#cb95-89" aria-hidden="true" tabindex="-1"></a>        <span class="fu">print</span>(<span class="st">&#39;Edge gradient threshold: &#39;</span><span class="op">,</span> edgeGradientTh)</span>
<span id="cb95-90"><a href="#cb95-90" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb95-91"><a href="#cb95-91" aria-hidden="true" tabindex="-1"></a>        <span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(edgeGradient<span class="op">.</span><span class="fu">mask</span>(edgeGradient)<span class="op">,</span> {<span class="dt">palette</span><span class="op">:</span>[<span class="st">&#39;ff0000&#39;</span>]}<span class="op">,</span> <span class="st">&#39;edge gradient&#39;</span><span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span></span>
<span id="cb95-92"><a href="#cb95-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-93"><a href="#cb95-93" aria-hidden="true" tabindex="-1"></a>        <span class="fu">print</span>(<span class="st">&#39;Edge gradient: &#39;</span><span class="op">,</span> ui<span class="op">.</span><span class="at">Chart</span><span class="op">.</span><span class="at">image</span><span class="op">.</span><span class="fu">histogram</span>(edgeGradient<span class="op">,</span> bounds<span class="op">,</span> scale<span class="op">,</span> buckets))</span>
<span id="cb95-94"><a href="#cb95-94" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb95-95"><a href="#cb95-95" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb95-96"><a href="#cb95-96" aria-hidden="true" tabindex="-1"></a>      edgeBuffer <span class="op">=</span> edgeBuffer<span class="op">.</span><span class="fu">updateMask</span>(edgeGradient<span class="op">.</span><span class="fu">gt</span>(edgeGradientTh))</span>
<span id="cb95-97"><a href="#cb95-97" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb95-98"><a href="#cb95-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-99"><a href="#cb95-99" aria-hidden="true" tabindex="-1"></a>    edge <span class="op">=</span> edge<span class="op">.</span><span class="fu">updateMask</span>(edgeBuffer)</span>
<span id="cb95-100"><a href="#cb95-100" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> edgeBuffer <span class="op">=</span> edge<span class="op">.</span><span class="fu">focal_max</span>(ee<span class="op">.</span><span class="fu">Number</span>(scale)<span class="op">.</span><span class="fu">multiply</span>(<span class="dv">1</span>)<span class="op">,</span> <span class="st">&#39;square&#39;</span><span class="op">,</span> <span class="st">&#39;meters&#39;</span>)<span class="op">;</span></span>
<span id="cb95-101"><a href="#cb95-101" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> imageEdge <span class="op">=</span> image<span class="op">.</span><span class="fu">mask</span>(edgeBuffer)<span class="op">;</span></span>
<span id="cb95-102"><a href="#cb95-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-103"><a href="#cb95-103" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(debug) {</span>
<span id="cb95-104"><a href="#cb95-104" aria-hidden="true" tabindex="-1"></a>      <span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(imageEdge<span class="op">,</span> {<span class="dt">palette</span><span class="op">:</span>[<span class="st">&#39;222200&#39;</span><span class="op">,</span> <span class="st">&#39;ffff00&#39;</span>]}<span class="op">,</span> <span class="st">&#39;image edge buffer&#39;</span><span class="op">,</span> <span class="kw">false</span>)</span>
<span id="cb95-105"><a href="#cb95-105" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb95-106"><a href="#cb95-106" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb95-107"><a href="#cb95-107" aria-hidden="true" tabindex="-1"></a>    <span class="co">// compute threshold using Otsu thresholding</span></span>
<span id="cb95-108"><a href="#cb95-108" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> buckets <span class="op">=</span> <span class="dv">100</span><span class="op">;</span></span>
<span id="cb95-109"><a href="#cb95-109" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> hist <span class="op">=</span> ee<span class="op">.</span><span class="fu">Dictionary</span>(ee<span class="op">.</span><span class="fu">Dictionary</span>(imageEdge<span class="op">.</span><span class="fu">reduceRegion</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">histogram</span>(buckets)<span class="op">,</span> bounds<span class="op">,</span> scale))<span class="op">.</span><span class="fu">values</span>()<span class="op">.</span><span class="fu">get</span>(<span class="dv">0</span>))<span class="op">;</span></span>
<span id="cb95-110"><a href="#cb95-110" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> threshold <span class="op">=</span> ee<span class="op">.</span><span class="at">Algorithms</span><span class="op">.</span><span class="fu">If</span>(hist<span class="op">.</span><span class="fu">contains</span>(<span class="st">&#39;bucketMeans&#39;</span>)<span class="op">,</span> <span class="fu">otsu</span>(hist)<span class="op">,</span> minValue)<span class="op">;</span></span>
<span id="cb95-111"><a href="#cb95-111" aria-hidden="true" tabindex="-1"></a>    threshold <span class="op">=</span> ee<span class="op">.</span><span class="fu">Number</span>(threshold)</span>
<span id="cb95-112"><a href="#cb95-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-113"><a href="#cb95-113" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span>(debug) {</span>
<span id="cb95-114"><a href="#cb95-114" aria-hidden="true" tabindex="-1"></a>        <span class="co">// experimental</span></span>
<span id="cb95-115"><a href="#cb95-115" aria-hidden="true" tabindex="-1"></a>        <span class="co">// var jrc = ee.Image(&#39;JRC/GSW1_0/GlobalSurfaceWater&#39;).select(&#39;occurrence&#39;)</span></span>
<span id="cb95-116"><a href="#cb95-116" aria-hidden="true" tabindex="-1"></a>        <span class="co">// var jrcTh = ee.Number(ee.Dictionary(jrc.updateMask(edge).reduceRegion(ee.Reducer.mode(), bounds, scale)).values().get(0))</span></span>
<span id="cb95-117"><a href="#cb95-117" aria-hidden="true" tabindex="-1"></a>        <span class="co">// var water = jrc.gt(jrcTh)</span></span>
<span id="cb95-118"><a href="#cb95-118" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Map.addLayer(jrc, {palette: [&#39;000000&#39;, &#39;ffff00&#39;]}, &#39;JRC&#39;)</span></span>
<span id="cb95-119"><a href="#cb95-119" aria-hidden="true" tabindex="-1"></a>        <span class="co">// print(&#39;JRC occurrence (edge)&#39;, ui.Chart.image.histogram(jrc.updateMask(edge), bounds, scale, buckets))</span></span>
<span id="cb95-120"><a href="#cb95-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-121"><a href="#cb95-121" aria-hidden="true" tabindex="-1"></a>        <span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(edge<span class="op">.</span><span class="fu">mask</span>(edge)<span class="op">,</span> {<span class="dt">palette</span><span class="op">:</span>[<span class="st">&#39;ff0000&#39;</span>]}<span class="op">,</span> <span class="st">&#39;edges&#39;</span><span class="op">,</span> <span class="kw">true</span>)<span class="op">;</span></span>
<span id="cb95-122"><a href="#cb95-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-123"><a href="#cb95-123" aria-hidden="true" tabindex="-1"></a>        <span class="fu">print</span>(<span class="st">&#39;Threshold: &#39;</span><span class="op">,</span> threshold)<span class="op">;</span></span>
<span id="cb95-124"><a href="#cb95-124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-125"><a href="#cb95-125" aria-hidden="true" tabindex="-1"></a>        <span class="fu">print</span>(<span class="st">&#39;Image values:&#39;</span><span class="op">,</span> ui<span class="op">.</span><span class="at">Chart</span><span class="op">.</span><span class="at">image</span><span class="op">.</span><span class="fu">histogram</span>(image<span class="op">,</span> bounds<span class="op">,</span> scale<span class="op">,</span> buckets))<span class="op">;</span></span>
<span id="cb95-126"><a href="#cb95-126" aria-hidden="true" tabindex="-1"></a>        <span class="fu">print</span>(<span class="st">&#39;Image values (edge): &#39;</span><span class="op">,</span> ui<span class="op">.</span><span class="at">Chart</span><span class="op">.</span><span class="at">image</span><span class="op">.</span><span class="fu">histogram</span>(imageEdge<span class="op">,</span> bounds<span class="op">,</span> scale<span class="op">,</span> buckets))<span class="op">;</span></span>
<span id="cb95-127"><a href="#cb95-127" aria-hidden="true" tabindex="-1"></a>        <span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(mask<span class="op">.</span><span class="fu">mask</span>(mask)<span class="op">,</span> {<span class="dt">palette</span><span class="op">:</span>[<span class="st">&#39;000000&#39;</span>]}<span class="op">,</span> <span class="st">&#39;image mask&#39;</span><span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span></span>
<span id="cb95-128"><a href="#cb95-128" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb95-129"><a href="#cb95-129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-130"><a href="#cb95-130" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> minValue <span class="op">!==</span> <span class="st">&#39;undefined&#39;</span> <span class="op">?</span> threshold<span class="op">.</span><span class="fu">max</span>(minValue) <span class="op">:</span> threshold<span class="op">;</span></span>
<span id="cb95-131"><a href="#cb95-131" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb95-132"><a href="#cb95-132" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-133"><a href="#cb95-133" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">otsu</span>(histogram) {</span>
<span id="cb95-134"><a href="#cb95-134" aria-hidden="true" tabindex="-1"></a>    histogram <span class="op">=</span> ee<span class="op">.</span><span class="fu">Dictionary</span>(histogram)<span class="op">;</span></span>
<span id="cb95-135"><a href="#cb95-135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-136"><a href="#cb95-136" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> counts <span class="op">=</span> ee<span class="op">.</span><span class="fu">Array</span>(histogram<span class="op">.</span><span class="fu">get</span>(<span class="st">&#39;histogram&#39;</span>))<span class="op">;</span></span>
<span id="cb95-137"><a href="#cb95-137" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> means <span class="op">=</span> ee<span class="op">.</span><span class="fu">Array</span>(histogram<span class="op">.</span><span class="fu">get</span>(<span class="st">&#39;bucketMeans&#39;</span>))<span class="op">;</span></span>
<span id="cb95-138"><a href="#cb95-138" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> size <span class="op">=</span> means<span class="op">.</span><span class="fu">length</span>()<span class="op">.</span><span class="fu">get</span>([<span class="dv">0</span>])<span class="op">;</span></span>
<span id="cb95-139"><a href="#cb95-139" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> total <span class="op">=</span> counts<span class="op">.</span><span class="fu">reduce</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">sum</span>()<span class="op">,</span> [<span class="dv">0</span>])<span class="op">.</span><span class="fu">get</span>([<span class="dv">0</span>])<span class="op">;</span></span>
<span id="cb95-140"><a href="#cb95-140" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> sum <span class="op">=</span> means<span class="op">.</span><span class="fu">multiply</span>(counts)<span class="op">.</span><span class="fu">reduce</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">sum</span>()<span class="op">,</span> [<span class="dv">0</span>])<span class="op">.</span><span class="fu">get</span>([<span class="dv">0</span>])<span class="op">;</span></span>
<span id="cb95-141"><a href="#cb95-141" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> mean <span class="op">=</span> sum<span class="op">.</span><span class="fu">divide</span>(total)<span class="op">;</span></span>
<span id="cb95-142"><a href="#cb95-142" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-143"><a href="#cb95-143" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> indices <span class="op">=</span> ee<span class="op">.</span><span class="at">List</span><span class="op">.</span><span class="fu">sequence</span>(<span class="dv">1</span><span class="op">,</span> size)<span class="op">;</span></span>
<span id="cb95-144"><a href="#cb95-144" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-145"><a href="#cb95-145" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Compute between sum of squares, where each mean partitions the data.</span></span>
<span id="cb95-146"><a href="#cb95-146" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> bss <span class="op">=</span> indices<span class="op">.</span><span class="fu">map</span>(<span class="kw">function</span>(i) {</span>
<span id="cb95-147"><a href="#cb95-147" aria-hidden="true" tabindex="-1"></a>        <span class="kw">var</span> aCounts <span class="op">=</span> counts<span class="op">.</span><span class="fu">slice</span>(<span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> i)<span class="op">;</span></span>
<span id="cb95-148"><a href="#cb95-148" aria-hidden="true" tabindex="-1"></a>        <span class="kw">var</span> aCount <span class="op">=</span> aCounts<span class="op">.</span><span class="fu">reduce</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">sum</span>()<span class="op">,</span> [<span class="dv">0</span>])<span class="op">.</span><span class="fu">get</span>([<span class="dv">0</span>])<span class="op">;</span></span>
<span id="cb95-149"><a href="#cb95-149" aria-hidden="true" tabindex="-1"></a>        <span class="kw">var</span> aMeans <span class="op">=</span> means<span class="op">.</span><span class="fu">slice</span>(<span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> i)<span class="op">;</span></span>
<span id="cb95-150"><a href="#cb95-150" aria-hidden="true" tabindex="-1"></a>        <span class="kw">var</span> aMean <span class="op">=</span> aMeans<span class="op">.</span><span class="fu">multiply</span>(aCounts)</span>
<span id="cb95-151"><a href="#cb95-151" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">reduce</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">sum</span>()<span class="op">,</span> [<span class="dv">0</span>])<span class="op">.</span><span class="fu">get</span>([<span class="dv">0</span>])</span>
<span id="cb95-152"><a href="#cb95-152" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">divide</span>(aCount)<span class="op">;</span></span>
<span id="cb95-153"><a href="#cb95-153" aria-hidden="true" tabindex="-1"></a>        <span class="kw">var</span> bCount <span class="op">=</span> total<span class="op">.</span><span class="fu">subtract</span>(aCount)<span class="op">;</span></span>
<span id="cb95-154"><a href="#cb95-154" aria-hidden="true" tabindex="-1"></a>        <span class="kw">var</span> bMean <span class="op">=</span> sum<span class="op">.</span><span class="fu">subtract</span>(aCount<span class="op">.</span><span class="fu">multiply</span>(aMean))<span class="op">.</span><span class="fu">divide</span>(bCount)<span class="op">;</span></span>
<span id="cb95-155"><a href="#cb95-155" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> aCount<span class="op">.</span><span class="fu">multiply</span>(aMean<span class="op">.</span><span class="fu">subtract</span>(mean)<span class="op">.</span><span class="fu">pow</span>(<span class="dv">2</span>))<span class="op">.</span><span class="fu">add</span>(</span>
<span id="cb95-156"><a href="#cb95-156" aria-hidden="true" tabindex="-1"></a>            bCount<span class="op">.</span><span class="fu">multiply</span>(bMean<span class="op">.</span><span class="fu">subtract</span>(mean)<span class="op">.</span><span class="fu">pow</span>(<span class="dv">2</span>)))<span class="op">;</span></span>
<span id="cb95-157"><a href="#cb95-157" aria-hidden="true" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb95-158"><a href="#cb95-158" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-159"><a href="#cb95-159" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Return the mean value corresponding to the maximum BSS.</span></span>
<span id="cb95-160"><a href="#cb95-160" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> means<span class="op">.</span><span class="fu">sort</span>(bss)<span class="op">.</span><span class="fu">get</span>([<span class="op">-</span><span class="dv">1</span>])<span class="op">;</span></span>
<span id="cb95-161"><a href="#cb95-161" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span></code></pre></div>
</div>
<div id="smoothing-vectors" class="section level3">
<h3>Smoothing Vectors</h3>
<div class="sourceCode" id="cb96"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> gsw <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(<span class="st">&quot;JRC/GSW1_3/GlobalSurfaceWater&quot;</span>)<span class="op">;</span></span>
<span id="cb96-2"><a href="#cb96-2" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> hydrobasins <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">&quot;WWF/HydroSHEDS/v1/Basins/hybas_7&quot;</span>)<span class="op">;</span></span>
<span id="cb96-3"><a href="#cb96-3" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> basin <span class="op">=</span> hydrobasins<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;HYBAS_ID&#39;</span><span class="op">,</span> <span class="dv">4071139640</span>))</span>
<span id="cb96-4"><a href="#cb96-4" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> geometry <span class="op">=</span> basin<span class="op">.</span><span class="fu">geometry</span>()</span>
<span id="cb96-5"><a href="#cb96-5" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">centerObject</span>(geometry<span class="op">,</span> <span class="dv">10</span>)</span>
<span id="cb96-6"><a href="#cb96-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-7"><a href="#cb96-7" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> water <span class="op">=</span> gsw<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;max_extent&#39;</span>)<span class="op">;</span></span>
<span id="cb96-8"><a href="#cb96-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-9"><a href="#cb96-9" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> clipped <span class="op">=</span> water<span class="op">.</span><span class="fu">clip</span>(geometry)</span>
<span id="cb96-10"><a href="#cb96-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-11"><a href="#cb96-11" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> visParams <span class="op">=</span> {<span class="dt">min</span><span class="op">:</span><span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span><span class="dv">1</span><span class="op">,</span> <span class="dt">palette</span><span class="op">:</span> [<span class="st">&#39;white&#39;</span><span class="op">,</span><span class="st">&#39;blue&#39;</span>]}</span>
<span id="cb96-12"><a href="#cb96-12" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(clipped<span class="op">,</span> visParams<span class="op">,</span> <span class="st">&#39;Surface Water&#39;</span><span class="op">,</span> <span class="kw">false</span>) </span>
<span id="cb96-13"><a href="#cb96-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-14"><a href="#cb96-14" aria-hidden="true" tabindex="-1"></a><span class="co">// Do unmask() to replace masked pixels with 0</span></span>
<span id="cb96-15"><a href="#cb96-15" aria-hidden="true" tabindex="-1"></a><span class="co">// This avoids extra pixels along the edges</span></span>
<span id="cb96-16"><a href="#cb96-16" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> clipped <span class="op">=</span> clipped<span class="op">.</span><span class="fu">unmask</span>(<span class="dv">0</span>)</span>
<span id="cb96-17"><a href="#cb96-17" aria-hidden="true" tabindex="-1"></a><span class="co">// Perform a morphological closing to fill holes in waterbodies</span></span>
<span id="cb96-18"><a href="#cb96-18" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> waterProcessed <span class="op">=</span> clipped</span>
<span id="cb96-19"><a href="#cb96-19" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">focal_max</span>({</span>
<span id="cb96-20"><a href="#cb96-20" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;radius&#39;</span><span class="op">:</span><span class="dv">30</span><span class="op">,</span></span>
<span id="cb96-21"><a href="#cb96-21" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;units&#39;</span><span class="op">:</span> <span class="st">&#39;meters&#39;</span><span class="op">,</span></span>
<span id="cb96-22"><a href="#cb96-22" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;kernelType&#39;</span><span class="op">:</span> <span class="st">&#39;square&#39;</span>})</span>
<span id="cb96-23"><a href="#cb96-23" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">focal_min</span>({</span>
<span id="cb96-24"><a href="#cb96-24" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;radius&#39;</span><span class="op">:</span><span class="dv">30</span><span class="op">,</span></span>
<span id="cb96-25"><a href="#cb96-25" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;units&#39;</span><span class="op">:</span> <span class="st">&#39;meters&#39;</span><span class="op">,</span></span>
<span id="cb96-26"><a href="#cb96-26" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;kernelType&#39;</span><span class="op">:</span> <span class="st">&#39;square&#39;</span>})<span class="op">;</span></span>
<span id="cb96-27"><a href="#cb96-27" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb96-28"><a href="#cb96-28" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> waterProcessed <span class="op">=</span> waterProcessed<span class="op">.</span><span class="fu">resample</span>(<span class="st">&#39;bicubic&#39;</span>)</span>
<span id="cb96-29"><a href="#cb96-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-30"><a href="#cb96-30" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> vector <span class="op">=</span> waterProcessed<span class="op">.</span><span class="fu">reduceToVectors</span>({</span>
<span id="cb96-31"><a href="#cb96-31" aria-hidden="true" tabindex="-1"></a>  <span class="dt">reducer</span><span class="op">:</span> ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">countEvery</span>()<span class="op">,</span></span>
<span id="cb96-32"><a href="#cb96-32" aria-hidden="true" tabindex="-1"></a>  <span class="dt">geometry</span><span class="op">:</span> geometry<span class="op">,</span></span>
<span id="cb96-33"><a href="#cb96-33" aria-hidden="true" tabindex="-1"></a>  <span class="dt">scale</span><span class="op">:</span> <span class="dv">10</span><span class="op">,</span></span>
<span id="cb96-34"><a href="#cb96-34" aria-hidden="true" tabindex="-1"></a>  <span class="dt">maxPixels</span><span class="op">:</span> <span class="fl">1e10</span><span class="op">,</span></span>
<span id="cb96-35"><a href="#cb96-35" aria-hidden="true" tabindex="-1"></a>  <span class="dt">eightConnected</span><span class="op">:</span> <span class="kw">false</span></span>
<span id="cb96-36"><a href="#cb96-36" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb96-37"><a href="#cb96-37" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> filtered <span class="op">=</span> vector<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;label&#39;</span><span class="op">,</span> <span class="dv">1</span>))</span>
<span id="cb96-38"><a href="#cb96-38" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(filtered<span class="op">,</span> {<span class="dt">color</span><span class="op">:</span><span class="st">&#39;purple&#39;</span>}<span class="op">,</span> <span class="st">&#39;Surface Water Polygons&#39;</span>)</span></code></pre></div>
</div>
<div id="surface-water-explorer-split-panel-app" class="section level3">
<h3>Surface Water Explorer Split Panel App</h3>
<div class="sourceCode" id="cb97"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a><span class="co">/**** Start of imports. If edited, may not auto-convert in the playground. ****/</span></span>
<span id="cb97-2"><a href="#cb97-2" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> admin2 <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">&quot;FAO/GAUL_SIMPLIFIED_500m/2015/level2&quot;</span>)<span class="op">,</span></span>
<span id="cb97-3"><a href="#cb97-3" aria-hidden="true" tabindex="-1"></a>    gswYearly <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&quot;JRC/GSW1_3/YearlyHistory&quot;</span>)<span class="op">;</span></span>
<span id="cb97-4"><a href="#cb97-4" aria-hidden="true" tabindex="-1"></a><span class="co">/***** End of imports. If edited, may not auto-convert in the playground. *****/</span></span>
<span id="cb97-5"><a href="#cb97-5" aria-hidden="true" tabindex="-1"></a><span class="co">// Panels are the main container widgets</span></span>
<span id="cb97-6"><a href="#cb97-6" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> mainPanel <span class="op">=</span> ui<span class="op">.</span><span class="fu">Panel</span>({</span>
<span id="cb97-7"><a href="#cb97-7" aria-hidden="true" tabindex="-1"></a>  <span class="dt">style</span><span class="op">:</span> {<span class="dt">width</span><span class="op">:</span> <span class="st">&#39;300px&#39;</span>}</span>
<span id="cb97-8"><a href="#cb97-8" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb97-9"><a href="#cb97-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-10"><a href="#cb97-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-11"><a href="#cb97-11" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> title <span class="op">=</span> ui<span class="op">.</span><span class="fu">Label</span>({</span>
<span id="cb97-12"><a href="#cb97-12" aria-hidden="true" tabindex="-1"></a>  <span class="dt">value</span><span class="op">:</span> <span class="st">&#39;Surface Water Explorer&#39;</span><span class="op">,</span></span>
<span id="cb97-13"><a href="#cb97-13" aria-hidden="true" tabindex="-1"></a>  <span class="dt">style</span><span class="op">:</span> {<span class="st">&#39;fontSize&#39;</span><span class="op">:</span> <span class="st">&#39;24px&#39;</span>}</span>
<span id="cb97-14"><a href="#cb97-14" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb97-15"><a href="#cb97-15" aria-hidden="true" tabindex="-1"></a><span class="co">// You can add widgets to the panel</span></span>
<span id="cb97-16"><a href="#cb97-16" aria-hidden="true" tabindex="-1"></a>mainPanel<span class="op">.</span><span class="fu">add</span>(title)</span>
<span id="cb97-17"><a href="#cb97-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-18"><a href="#cb97-18" aria-hidden="true" tabindex="-1"></a><span class="co">// You can even add panels to other panels</span></span>
<span id="cb97-19"><a href="#cb97-19" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> admin2Panel <span class="op">=</span> ui<span class="op">.</span><span class="fu">Panel</span>()</span>
<span id="cb97-20"><a href="#cb97-20" aria-hidden="true" tabindex="-1"></a>mainPanel<span class="op">.</span><span class="fu">add</span>(admin2Panel)<span class="op">;</span></span>
<span id="cb97-21"><a href="#cb97-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-22"><a href="#cb97-22" aria-hidden="true" tabindex="-1"></a><span class="co">// Let&#39;s add a dropdown with the names of admin2 regions</span></span>
<span id="cb97-23"><a href="#cb97-23" aria-hidden="true" tabindex="-1"></a><span class="co">// We need to get all admin2 names and creat a ui.Select object</span></span>
<span id="cb97-24"><a href="#cb97-24" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> filtered <span class="op">=</span> admin2<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;ADM1_NAME&#39;</span><span class="op">,</span> <span class="st">&#39;Karnataka&#39;</span>))</span>
<span id="cb97-25"><a href="#cb97-25" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> admin2Names <span class="op">=</span> filtered<span class="op">.</span><span class="fu">aggregate_array</span>(<span class="st">&#39;ADM2_NAME&#39;</span>)</span>
<span id="cb97-26"><a href="#cb97-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-27"><a href="#cb97-27" aria-hidden="true" tabindex="-1"></a><span class="co">// We define a function that will be called when the user selects a value</span></span>
<span id="cb97-28"><a href="#cb97-28" aria-hidden="true" tabindex="-1"></a>admin2Names<span class="op">.</span><span class="fu">evaluate</span>(<span class="kw">function</span>(names){</span>
<span id="cb97-29"><a href="#cb97-29" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> dropDown <span class="op">=</span> ui<span class="op">.</span><span class="fu">Select</span>({</span>
<span id="cb97-30"><a href="#cb97-30" aria-hidden="true" tabindex="-1"></a>    <span class="dt">placeholder</span><span class="op">:</span> <span class="st">&#39;select a region&#39;</span><span class="op">,</span></span>
<span id="cb97-31"><a href="#cb97-31" aria-hidden="true" tabindex="-1"></a>    <span class="dt">items</span><span class="op">:</span> names<span class="op">,</span></span>
<span id="cb97-32"><a href="#cb97-32" aria-hidden="true" tabindex="-1"></a>    <span class="dt">onChange</span><span class="op">:</span> display</span>
<span id="cb97-33"><a href="#cb97-33" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb97-34"><a href="#cb97-34" aria-hidden="true" tabindex="-1"></a>  admin2Panel<span class="op">.</span><span class="fu">add</span>(dropDown)</span>
<span id="cb97-35"><a href="#cb97-35" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb97-36"><a href="#cb97-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-37"><a href="#cb97-37" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> resultPanel <span class="op">=</span> ui<span class="op">.</span><span class="fu">Panel</span>()<span class="op">;</span></span>
<span id="cb97-38"><a href="#cb97-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-39"><a href="#cb97-39" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> areaLabel1 <span class="op">=</span> ui<span class="op">.</span><span class="fu">Label</span>()</span>
<span id="cb97-40"><a href="#cb97-40" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> areaLabel2 <span class="op">=</span> ui<span class="op">.</span><span class="fu">Label</span>()</span>
<span id="cb97-41"><a href="#cb97-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-42"><a href="#cb97-42" aria-hidden="true" tabindex="-1"></a>resultPanel<span class="op">.</span><span class="fu">add</span>(areaLabel1)</span>
<span id="cb97-43"><a href="#cb97-43" aria-hidden="true" tabindex="-1"></a>resultPanel<span class="op">.</span><span class="fu">add</span>(areaLabel2)</span>
<span id="cb97-44"><a href="#cb97-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-45"><a href="#cb97-45" aria-hidden="true" tabindex="-1"></a>mainPanel<span class="op">.</span><span class="fu">add</span>(resultPanel)<span class="op">;</span></span>
<span id="cb97-46"><a href="#cb97-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-47"><a href="#cb97-47" aria-hidden="true" tabindex="-1"></a><span class="co">// This function will be called when the user changes the value in the dropdown</span></span>
<span id="cb97-48"><a href="#cb97-48" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> display <span class="op">=</span> <span class="kw">function</span>(admin2Name) {</span>
<span id="cb97-49"><a href="#cb97-49" aria-hidden="true" tabindex="-1"></a>  areaLabel1<span class="op">.</span><span class="fu">setValue</span>(<span class="st">&#39;&#39;</span>)</span>
<span id="cb97-50"><a href="#cb97-50" aria-hidden="true" tabindex="-1"></a>  areaLabel2<span class="op">.</span><span class="fu">setValue</span>(<span class="st">&#39;&#39;</span>)</span>
<span id="cb97-51"><a href="#cb97-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-52"><a href="#cb97-52" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> selected <span class="op">=</span> ee<span class="op">.</span><span class="fu">Feature</span>(</span>
<span id="cb97-53"><a href="#cb97-53" aria-hidden="true" tabindex="-1"></a>    filtered<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;ADM2_NAME&#39;</span><span class="op">,</span> admin2Name))<span class="op">.</span><span class="fu">first</span>())</span>
<span id="cb97-54"><a href="#cb97-54" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> geometry <span class="op">=</span> selected<span class="op">.</span><span class="fu">geometry</span>()</span>
<span id="cb97-55"><a href="#cb97-55" aria-hidden="true" tabindex="-1"></a>  leftMap<span class="op">.</span><span class="fu">layers</span>()<span class="op">.</span><span class="fu">reset</span>()</span>
<span id="cb97-56"><a href="#cb97-56" aria-hidden="true" tabindex="-1"></a>  rightMap<span class="op">.</span><span class="fu">layers</span>()<span class="op">.</span><span class="fu">reset</span>()</span>
<span id="cb97-57"><a href="#cb97-57" aria-hidden="true" tabindex="-1"></a>  leftMap<span class="op">.</span><span class="fu">addLayer</span>(geometry<span class="op">,</span> {<span class="dt">color</span><span class="op">:</span> <span class="st">&#39;grey&#39;</span>}<span class="op">,</span> admin2Name)</span>
<span id="cb97-58"><a href="#cb97-58" aria-hidden="true" tabindex="-1"></a>  rightMap<span class="op">.</span><span class="fu">addLayer</span>(geometry<span class="op">,</span> {<span class="dt">color</span><span class="op">:</span> <span class="st">&#39;grey&#39;</span>}<span class="op">,</span> admin2Name)</span>
<span id="cb97-59"><a href="#cb97-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-60"><a href="#cb97-60" aria-hidden="true" tabindex="-1"></a>  leftMap<span class="op">.</span><span class="fu">centerObject</span>(geometry<span class="op">,</span> <span class="dv">10</span>)</span>
<span id="cb97-61"><a href="#cb97-61" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> visParams <span class="op">=</span> {<span class="dt">min</span><span class="op">:</span><span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span><span class="dv">1</span><span class="op">,</span> <span class="dt">palette</span><span class="op">:</span> [<span class="st">&#39;white&#39;</span><span class="op">,</span><span class="st">&#39;blue&#39;</span>]}</span>
<span id="cb97-62"><a href="#cb97-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-63"><a href="#cb97-63" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> gswYearFiltered <span class="op">=</span> gswYearly<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;year&#39;</span><span class="op">,</span> <span class="dv">2010</span>))</span>
<span id="cb97-64"><a href="#cb97-64" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> gsw2010 <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(gswYearFiltered<span class="op">.</span><span class="fu">first</span>())<span class="op">.</span><span class="fu">clip</span>(geometry)</span>
<span id="cb97-65"><a href="#cb97-65" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> water2010 <span class="op">=</span> gsw2010<span class="op">.</span><span class="fu">eq</span>(<span class="dv">2</span>)<span class="op">.</span><span class="fu">or</span>(gsw2010<span class="op">.</span><span class="fu">eq</span>(<span class="dv">3</span>))<span class="op">.</span><span class="fu">rename</span>(<span class="st">&#39;water&#39;</span>)<span class="op">.</span><span class="fu">selfMask</span>()</span>
<span id="cb97-66"><a href="#cb97-66" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb97-67"><a href="#cb97-67" aria-hidden="true" tabindex="-1"></a>  leftMap<span class="op">.</span><span class="fu">addLayer</span>(water2010<span class="op">,</span> visParams<span class="op">,</span> <span class="st">&#39;2010 Water&#39;</span>)</span>
<span id="cb97-68"><a href="#cb97-68" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb97-69"><a href="#cb97-69" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> gswYearFiltered <span class="op">=</span> gswYearly<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;year&#39;</span><span class="op">,</span> <span class="dv">2020</span>))</span>
<span id="cb97-70"><a href="#cb97-70" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> gsw2020 <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(gswYearFiltered<span class="op">.</span><span class="fu">first</span>())<span class="op">.</span><span class="fu">clip</span>(geometry)</span>
<span id="cb97-71"><a href="#cb97-71" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> water2020 <span class="op">=</span> gsw2020<span class="op">.</span><span class="fu">eq</span>(<span class="dv">2</span>)<span class="op">.</span><span class="fu">or</span>(gsw2020<span class="op">.</span><span class="fu">eq</span>(<span class="dv">3</span>))<span class="op">.</span><span class="fu">rename</span>(<span class="st">&#39;water&#39;</span>)<span class="op">.</span><span class="fu">selfMask</span>()</span>
<span id="cb97-72"><a href="#cb97-72" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb97-73"><a href="#cb97-73" aria-hidden="true" tabindex="-1"></a>  rightMap<span class="op">.</span><span class="fu">addLayer</span>(water2020<span class="op">,</span> visParams<span class="op">,</span> <span class="st">&#39;2020 Water&#39;</span>)</span>
<span id="cb97-74"><a href="#cb97-74" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb97-75"><a href="#cb97-75" aria-hidden="true" tabindex="-1"></a>   <span class="kw">var</span> area2010 <span class="op">=</span> water2010<span class="op">.</span><span class="fu">multiply</span>(ee<span class="op">.</span><span class="at">Image</span><span class="op">.</span><span class="fu">pixelArea</span>())<span class="op">.</span><span class="fu">reduceRegion</span>({</span>
<span id="cb97-76"><a href="#cb97-76" aria-hidden="true" tabindex="-1"></a>    <span class="dt">reducer</span><span class="op">:</span> ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">sum</span>()<span class="op">,</span></span>
<span id="cb97-77"><a href="#cb97-77" aria-hidden="true" tabindex="-1"></a>    <span class="dt">geometry</span><span class="op">:</span> geometry<span class="op">,</span></span>
<span id="cb97-78"><a href="#cb97-78" aria-hidden="true" tabindex="-1"></a>    <span class="dt">scale</span><span class="op">:</span> <span class="dv">30</span><span class="op">,</span></span>
<span id="cb97-79"><a href="#cb97-79" aria-hidden="true" tabindex="-1"></a>    <span class="dt">maxPixels</span><span class="op">:</span> <span class="fl">1e9</span></span>
<span id="cb97-80"><a href="#cb97-80" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb97-81"><a href="#cb97-81" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb97-82"><a href="#cb97-82" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> waterArea2010 <span class="op">=</span> ee<span class="op">.</span><span class="fu">Number</span>(area2010<span class="op">.</span><span class="fu">get</span>(<span class="st">&#39;water&#39;</span>))<span class="op">.</span><span class="fu">divide</span>(<span class="dv">10000</span>)<span class="op">.</span><span class="fu">round</span>()<span class="op">;</span></span>
<span id="cb97-83"><a href="#cb97-83" aria-hidden="true" tabindex="-1"></a>  waterArea2010<span class="op">.</span><span class="fu">evaluate</span>(<span class="kw">function</span>(result) {</span>
<span id="cb97-84"><a href="#cb97-84" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> text <span class="op">=</span> <span class="st">&#39;Surface Water Area 2010: &#39;</span> <span class="op">+</span> result <span class="op">+</span> <span class="st">&#39; Hectares&#39;</span></span>
<span id="cb97-85"><a href="#cb97-85" aria-hidden="true" tabindex="-1"></a>    areaLabel1<span class="op">.</span><span class="fu">setValue</span>(text)</span>
<span id="cb97-86"><a href="#cb97-86" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb97-87"><a href="#cb97-87" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb97-88"><a href="#cb97-88" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> area2020 <span class="op">=</span> water2020<span class="op">.</span><span class="fu">multiply</span>(ee<span class="op">.</span><span class="at">Image</span><span class="op">.</span><span class="fu">pixelArea</span>())<span class="op">.</span><span class="fu">reduceRegion</span>({</span>
<span id="cb97-89"><a href="#cb97-89" aria-hidden="true" tabindex="-1"></a>    <span class="dt">reducer</span><span class="op">:</span> ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">sum</span>()<span class="op">,</span></span>
<span id="cb97-90"><a href="#cb97-90" aria-hidden="true" tabindex="-1"></a>    <span class="dt">geometry</span><span class="op">:</span> geometry<span class="op">,</span></span>
<span id="cb97-91"><a href="#cb97-91" aria-hidden="true" tabindex="-1"></a>    <span class="dt">scale</span><span class="op">:</span> <span class="dv">30</span><span class="op">,</span></span>
<span id="cb97-92"><a href="#cb97-92" aria-hidden="true" tabindex="-1"></a>    <span class="dt">maxPixels</span><span class="op">:</span> <span class="fl">1e9</span></span>
<span id="cb97-93"><a href="#cb97-93" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb97-94"><a href="#cb97-94" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb97-95"><a href="#cb97-95" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> waterArea2020 <span class="op">=</span> ee<span class="op">.</span><span class="fu">Number</span>(area2020<span class="op">.</span><span class="fu">get</span>(<span class="st">&#39;water&#39;</span>))<span class="op">.</span><span class="fu">divide</span>(<span class="dv">10000</span>)<span class="op">.</span><span class="fu">round</span>()<span class="op">;</span></span>
<span id="cb97-96"><a href="#cb97-96" aria-hidden="true" tabindex="-1"></a>  waterArea2020<span class="op">.</span><span class="fu">evaluate</span>(<span class="kw">function</span>(result) {</span>
<span id="cb97-97"><a href="#cb97-97" aria-hidden="true" tabindex="-1"></a>    <span class="kw">var</span> text <span class="op">=</span> <span class="st">&#39;Surface Water Area 2020: &#39;</span> <span class="op">+</span> result <span class="op">+</span> <span class="st">&#39; Hectares&#39;</span></span>
<span id="cb97-98"><a href="#cb97-98" aria-hidden="true" tabindex="-1"></a>    areaLabel2<span class="op">.</span><span class="fu">setValue</span>(text)</span>
<span id="cb97-99"><a href="#cb97-99" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb97-100"><a href="#cb97-100" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb97-101"><a href="#cb97-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-102"><a href="#cb97-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-103"><a href="#cb97-103" aria-hidden="true" tabindex="-1"></a><span class="co">// Create two maps.</span></span>
<span id="cb97-104"><a href="#cb97-104" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> center <span class="op">=</span> {<span class="dt">lon</span><span class="op">:</span> <span class="fl">76.43</span><span class="op">,</span> <span class="dt">lat</span><span class="op">:</span> <span class="fl">12.41</span><span class="op">,</span> <span class="dt">zoom</span><span class="op">:</span> <span class="dv">8</span>}<span class="op">;</span></span>
<span id="cb97-105"><a href="#cb97-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-106"><a href="#cb97-106" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> leftMap <span class="op">=</span> ui<span class="op">.</span><span class="fu">Map</span>(center)<span class="op">;</span></span>
<span id="cb97-107"><a href="#cb97-107" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> rightMap <span class="op">=</span> ui<span class="op">.</span><span class="fu">Map</span>(center)<span class="op">;</span></span>
<span id="cb97-108"><a href="#cb97-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-109"><a href="#cb97-109" aria-hidden="true" tabindex="-1"></a><span class="co">// Link them together.</span></span>
<span id="cb97-110"><a href="#cb97-110" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> linker <span class="op">=</span> <span class="kw">new</span> ui<span class="op">.</span><span class="at">Map</span><span class="op">.</span><span class="fu">Linker</span>([leftMap<span class="op">,</span> rightMap])<span class="op">;</span></span>
<span id="cb97-111"><a href="#cb97-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-112"><a href="#cb97-112" aria-hidden="true" tabindex="-1"></a><span class="co">// Create a split panel with the two maps.</span></span>
<span id="cb97-113"><a href="#cb97-113" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> splitPanel <span class="op">=</span> ui<span class="op">.</span><span class="fu">SplitPanel</span>({</span>
<span id="cb97-114"><a href="#cb97-114" aria-hidden="true" tabindex="-1"></a>  <span class="dt">firstPanel</span><span class="op">:</span> leftMap<span class="op">,</span></span>
<span id="cb97-115"><a href="#cb97-115" aria-hidden="true" tabindex="-1"></a>  <span class="dt">secondPanel</span><span class="op">:</span> rightMap<span class="op">,</span></span>
<span id="cb97-116"><a href="#cb97-116" aria-hidden="true" tabindex="-1"></a>  <span class="dt">orientation</span><span class="op">:</span> <span class="st">&#39;horizontal&#39;</span><span class="op">,</span></span>
<span id="cb97-117"><a href="#cb97-117" aria-hidden="true" tabindex="-1"></a>  <span class="dt">wipe</span><span class="op">:</span> <span class="kw">true</span></span>
<span id="cb97-118"><a href="#cb97-118" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb97-119"><a href="#cb97-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-120"><a href="#cb97-120" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> yearLabel1 <span class="op">=</span> ui<span class="op">.</span><span class="fu">Label</span>({<span class="dt">value</span><span class="op">:</span> <span class="st">&#39;2010&#39;</span><span class="op">,</span></span>
<span id="cb97-121"><a href="#cb97-121" aria-hidden="true" tabindex="-1"></a>  <span class="dt">style</span><span class="op">:</span> {<span class="st">&#39;fontSize&#39;</span><span class="op">:</span> <span class="st">&#39;20px&#39;</span><span class="op">,</span> <span class="dt">backgroundColor</span><span class="op">:</span> <span class="st">&#39;#f7f7f7&#39;</span><span class="op">,</span> <span class="dt">position</span><span class="op">:</span><span class="st">&#39;top-left&#39;</span>}})<span class="op">;</span></span>
<span id="cb97-122"><a href="#cb97-122" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> yearLabel2 <span class="op">=</span> ui<span class="op">.</span><span class="fu">Label</span>({<span class="dt">value</span><span class="op">:</span> <span class="st">&#39;2020&#39;</span><span class="op">,</span></span>
<span id="cb97-123"><a href="#cb97-123" aria-hidden="true" tabindex="-1"></a>  <span class="dt">style</span><span class="op">:</span> {<span class="st">&#39;fontSize&#39;</span><span class="op">:</span> <span class="st">&#39;20px&#39;</span><span class="op">,</span> <span class="dt">backgroundColor</span><span class="op">:</span> <span class="st">&#39;#f7f7f7&#39;</span><span class="op">,</span> <span class="dt">position</span><span class="op">:</span><span class="st">&#39;top-right&#39;</span>}})<span class="op">;</span></span>
<span id="cb97-124"><a href="#cb97-124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-125"><a href="#cb97-125" aria-hidden="true" tabindex="-1"></a>leftMap<span class="op">.</span><span class="fu">setControlVisibility</span>(<span class="kw">false</span>)<span class="op">;</span></span>
<span id="cb97-126"><a href="#cb97-126" aria-hidden="true" tabindex="-1"></a>rightMap<span class="op">.</span><span class="fu">setControlVisibility</span>(<span class="kw">false</span>)<span class="op">;</span></span>
<span id="cb97-127"><a href="#cb97-127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-128"><a href="#cb97-128" aria-hidden="true" tabindex="-1"></a>leftMap<span class="op">.</span><span class="fu">add</span>(yearLabel1)</span>
<span id="cb97-129"><a href="#cb97-129" aria-hidden="true" tabindex="-1"></a>rightMap<span class="op">.</span><span class="fu">add</span>(yearLabel2)</span>
<span id="cb97-130"><a href="#cb97-130" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb97-131"><a href="#cb97-131" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">setCenter</span>(<span class="fl">76.43</span><span class="op">,</span> <span class="fl">12.41</span><span class="op">,</span> <span class="dv">8</span>)</span>
<span id="cb97-132"><a href="#cb97-132" aria-hidden="true" tabindex="-1"></a>ui<span class="op">.</span><span class="at">root</span><span class="op">.</span><span class="fu">clear</span>()</span>
<span id="cb97-133"><a href="#cb97-133" aria-hidden="true" tabindex="-1"></a>ui<span class="op">.</span><span class="at">root</span><span class="op">.</span><span class="fu">add</span>(splitPanel)<span class="op">;</span></span>
<span id="cb97-134"><a href="#cb97-134" aria-hidden="true" tabindex="-1"></a>ui<span class="op">.</span><span class="at">root</span><span class="op">.</span><span class="fu">add</span>(mainPanel)<span class="op">;</span> </span></code></pre></div>
</div>
<div id="unsupervised-clustering-basic" class="section level3">
<h3>Unsupervised Clustering Basic</h3>
<div class="sourceCode" id="cb98"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Create a composite for the selected region</span></span>
<span id="cb98-2"><a href="#cb98-2" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> admin2 <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">&quot;FAO/GAUL_SIMPLIFIED_500m/2015/level2&quot;</span>)<span class="op">;</span></span>
<span id="cb98-3"><a href="#cb98-3" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> s2 <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&quot;COPERNICUS/S2_SR&quot;</span>)<span class="op">;</span></span>
<span id="cb98-4"><a href="#cb98-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-5"><a href="#cb98-5" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> selected <span class="op">=</span> admin2<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;ADM2_NAME&#39;</span><span class="op">,</span> <span class="st">&#39;Bangalore Urban&#39;</span>))</span>
<span id="cb98-6"><a href="#cb98-6" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> geometry <span class="op">=</span> selected<span class="op">.</span><span class="fu">geometry</span>()</span>
<span id="cb98-7"><a href="#cb98-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-8"><a href="#cb98-8" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> filtered <span class="op">=</span> s2<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">lt</span>(<span class="st">&#39;CLOUDY_PIXEL_PERCENTAGE&#39;</span><span class="op">,</span> <span class="dv">30</span>))</span>
<span id="cb98-9"><a href="#cb98-9" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(<span class="st">&#39;2019-01-01&#39;</span><span class="op">,</span> <span class="st">&#39;2020-01-01&#39;</span>))</span>
<span id="cb98-10"><a href="#cb98-10" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">bounds</span>(geometry))</span>
<span id="cb98-11"><a href="#cb98-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-12"><a href="#cb98-12" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> image <span class="op">=</span> filtered<span class="op">.</span><span class="fu">median</span>()<span class="op">.</span><span class="fu">clip</span>(geometry)<span class="op">;</span> </span>
<span id="cb98-13"><a href="#cb98-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-14"><a href="#cb98-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-15"><a href="#cb98-15" aria-hidden="true" tabindex="-1"></a><span class="co">// Calculate Modified Normalized Difference Water Index (MNDWI)</span></span>
<span id="cb98-16"><a href="#cb98-16" aria-hidden="true" tabindex="-1"></a><span class="co">// &#39;GREEN&#39; (B3) and &#39;SWIR1&#39; (B11)</span></span>
<span id="cb98-17"><a href="#cb98-17" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> mndwi <span class="op">=</span> image<span class="op">.</span><span class="fu">normalizedDifference</span>([<span class="st">&#39;B3&#39;</span><span class="op">,</span> <span class="st">&#39;B11&#39;</span>])<span class="op">.</span><span class="fu">rename</span>([<span class="st">&#39;mndwi&#39;</span>])<span class="op">;</span> <span class="op">;</span> </span>
<span id="cb98-18"><a href="#cb98-18" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb98-19"><a href="#cb98-19" aria-hidden="true" tabindex="-1"></a><span class="co">// Select the NIR (B8) and SWIR-2 (B12) bands</span></span>
<span id="cb98-20"><a href="#cb98-20" aria-hidden="true" tabindex="-1"></a><span class="co">// (SWIR-2 is also known as MIR-2 band)</span></span>
<span id="cb98-21"><a href="#cb98-21" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> nir <span class="op">=</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;B8&#39;</span>)<span class="op">.</span><span class="fu">multiply</span>(<span class="fl">0.0001</span>)<span class="op">.</span><span class="fu">rename</span>(<span class="st">&#39;nir&#39;</span>)</span>
<span id="cb98-22"><a href="#cb98-22" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> mir2 <span class="op">=</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;B12&#39;</span>)<span class="op">.</span><span class="fu">multiply</span>(<span class="fl">0.0001</span>)<span class="op">.</span><span class="fu">rename</span>(<span class="st">&#39;mir2&#39;</span>)</span>
<span id="cb98-23"><a href="#cb98-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-24"><a href="#cb98-24" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> stackedImage <span class="op">=</span> nir<span class="op">.</span><span class="fu">addBands</span>(mir2)</span>
<span id="cb98-25"><a href="#cb98-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-26"><a href="#cb98-26" aria-hidden="true" tabindex="-1"></a><span class="co">// Make the training dataset for unsupervised clustering</span></span>
<span id="cb98-27"><a href="#cb98-27" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> training <span class="op">=</span> stackedImage<span class="op">.</span><span class="fu">sample</span>({</span>
<span id="cb98-28"><a href="#cb98-28" aria-hidden="true" tabindex="-1"></a>  <span class="dt">region</span><span class="op">:</span> geometry<span class="op">,</span></span>
<span id="cb98-29"><a href="#cb98-29" aria-hidden="true" tabindex="-1"></a>  <span class="dt">scale</span><span class="op">:</span> <span class="dv">20</span><span class="op">,</span></span>
<span id="cb98-30"><a href="#cb98-30" aria-hidden="true" tabindex="-1"></a>  <span class="dt">numPixels</span><span class="op">:</span> <span class="dv">1000</span></span>
<span id="cb98-31"><a href="#cb98-31" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb98-32"><a href="#cb98-32" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(training<span class="op">.</span><span class="fu">first</span>())</span>
<span id="cb98-33"><a href="#cb98-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-34"><a href="#cb98-34" aria-hidden="true" tabindex="-1"></a><span class="co">// Instantiate the clusterer and train it.</span></span>
<span id="cb98-35"><a href="#cb98-35" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> clusterer <span class="op">=</span> ee<span class="op">.</span><span class="at">Clusterer</span><span class="op">.</span><span class="fu">wekaKMeans</span>(<span class="dv">5</span>)<span class="op">.</span><span class="fu">train</span>(training)<span class="op">;</span></span>
<span id="cb98-36"><a href="#cb98-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-37"><a href="#cb98-37" aria-hidden="true" tabindex="-1"></a><span class="co">// Cluster the stacked image</span></span>
<span id="cb98-38"><a href="#cb98-38" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> clustered <span class="op">=</span> stackedImage<span class="op">.</span><span class="fu">cluster</span>(clusterer)<span class="op">;</span></span>
<span id="cb98-39"><a href="#cb98-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-40"><a href="#cb98-40" aria-hidden="true" tabindex="-1"></a><span class="co">// We need to identify which of the clusters represent water</span></span>
<span id="cb98-41"><a href="#cb98-41" aria-hidden="true" tabindex="-1"></a><span class="co">// We use the MNDWI band and select the cluster with the </span></span>
<span id="cb98-42"><a href="#cb98-42" aria-hidden="true" tabindex="-1"></a><span class="co">// highest average MNDWI values of all pixels within the cluster</span></span>
<span id="cb98-43"><a href="#cb98-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-44"><a href="#cb98-44" aria-hidden="true" tabindex="-1"></a><span class="co">// Calculate the stats on MNDWI band, grouped by clusters</span></span>
<span id="cb98-45"><a href="#cb98-45" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> stats <span class="op">=</span> mndwi<span class="op">.</span><span class="fu">addBands</span>(clustered)<span class="op">.</span><span class="fu">reduceRegion</span>({</span>
<span id="cb98-46"><a href="#cb98-46" aria-hidden="true" tabindex="-1"></a>  <span class="dt">reducer</span><span class="op">:</span> ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">mean</span>()<span class="op">.</span><span class="fu">group</span>({</span>
<span id="cb98-47"><a href="#cb98-47" aria-hidden="true" tabindex="-1"></a>    <span class="dt">groupField</span><span class="op">:</span> <span class="dv">1</span><span class="op">,</span></span>
<span id="cb98-48"><a href="#cb98-48" aria-hidden="true" tabindex="-1"></a>    <span class="dt">groupName</span><span class="op">:</span> <span class="st">&#39;cluster&#39;</span><span class="op">,</span></span>
<span id="cb98-49"><a href="#cb98-49" aria-hidden="true" tabindex="-1"></a>  })<span class="op">,</span></span>
<span id="cb98-50"><a href="#cb98-50" aria-hidden="true" tabindex="-1"></a>  <span class="dt">geometry</span><span class="op">:</span> geometry<span class="op">,</span></span>
<span id="cb98-51"><a href="#cb98-51" aria-hidden="true" tabindex="-1"></a>  <span class="dt">scale</span><span class="op">:</span> <span class="dv">100</span><span class="op">,</span></span>
<span id="cb98-52"><a href="#cb98-52" aria-hidden="true" tabindex="-1"></a>  <span class="dt">maxPixels</span><span class="op">:</span> <span class="fl">1e8</span></span>
<span id="cb98-53"><a href="#cb98-53" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb98-54"><a href="#cb98-54" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(stats)</span>
<span id="cb98-55"><a href="#cb98-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-56"><a href="#cb98-56" aria-hidden="true" tabindex="-1"></a><span class="co">// Extract the cluster-wise stats as a list of lists</span></span>
<span id="cb98-57"><a href="#cb98-57" aria-hidden="true" tabindex="-1"></a><span class="co">// We get a list in the following format</span></span>
<span id="cb98-58"><a href="#cb98-58" aria-hidden="true" tabindex="-1"></a><span class="co">// [[avg_mndwi, cluster_number], [avg_mndwi, cluster_number] ...]]</span></span>
<span id="cb98-59"><a href="#cb98-59" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> groupStats <span class="op">=</span> ee<span class="op">.</span><span class="fu">List</span>(stats<span class="op">.</span><span class="fu">get</span>(<span class="st">&#39;groups&#39;</span>))</span>
<span id="cb98-60"><a href="#cb98-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-61"><a href="#cb98-61" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> groupStatsLists <span class="op">=</span> groupStats<span class="op">.</span><span class="fu">map</span>(<span class="kw">function</span>(item) {</span>
<span id="cb98-62"><a href="#cb98-62" aria-hidden="true" tabindex="-1"></a>      <span class="kw">var</span> areaDict <span class="op">=</span> ee<span class="op">.</span><span class="fu">Dictionary</span>(item)</span>
<span id="cb98-63"><a href="#cb98-63" aria-hidden="true" tabindex="-1"></a>      <span class="kw">var</span> clusterNumber <span class="op">=</span> ee<span class="op">.</span><span class="fu">Number</span>(</span>
<span id="cb98-64"><a href="#cb98-64" aria-hidden="true" tabindex="-1"></a>        areaDict<span class="op">.</span><span class="fu">get</span>(<span class="st">&#39;cluster&#39;</span>))</span>
<span id="cb98-65"><a href="#cb98-65" aria-hidden="true" tabindex="-1"></a>      <span class="kw">var</span> mndwi <span class="op">=</span> ee<span class="op">.</span><span class="fu">Number</span>(</span>
<span id="cb98-66"><a href="#cb98-66" aria-hidden="true" tabindex="-1"></a>        areaDict<span class="op">.</span><span class="fu">get</span>(<span class="st">&#39;mean&#39;</span>))</span>
<span id="cb98-67"><a href="#cb98-67" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> ee<span class="op">.</span><span class="fu">List</span>([mndwi<span class="op">,</span> clusterNumber])</span>
<span id="cb98-68"><a href="#cb98-68" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb98-69"><a href="#cb98-69" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb98-70"><a href="#cb98-70" aria-hidden="true" tabindex="-1"></a><span class="co">// Use the ee.Reducer.max() on the list of lists</span></span>
<span id="cb98-71"><a href="#cb98-71" aria-hidden="true" tabindex="-1"></a><span class="co">// It will pick the list with the highest MNDWI</span></span>
<span id="cb98-72"><a href="#cb98-72" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> waterClusterList <span class="op">=</span> ee<span class="op">.</span><span class="fu">Dictionary</span>(ee<span class="op">.</span><span class="fu">List</span>(groupStatsLists)<span class="op">.</span><span class="fu">reduce</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">max</span>(<span class="dv">2</span>)))</span>
<span id="cb98-73"><a href="#cb98-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-74"><a href="#cb98-74" aria-hidden="true" tabindex="-1"></a><span class="co">// Extract the cluster number</span></span>
<span id="cb98-75"><a href="#cb98-75" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> waterCluster <span class="op">=</span> ee<span class="op">.</span><span class="fu">Number</span>(waterClusterList<span class="op">.</span><span class="fu">get</span>(<span class="st">&#39;max1&#39;</span>))</span>
<span id="cb98-76"><a href="#cb98-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-77"><a href="#cb98-77" aria-hidden="true" tabindex="-1"></a><span class="co">// Select all pixels from the water cluster and mask everything else</span></span>
<span id="cb98-78"><a href="#cb98-78" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> water <span class="op">=</span> clustered<span class="op">.</span><span class="fu">eq</span>(waterCluster)<span class="op">.</span><span class="fu">selfMask</span>()</span>
<span id="cb98-79"><a href="#cb98-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-80"><a href="#cb98-80" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> rgbVis <span class="op">=</span> {<span class="dt">min</span><span class="op">:</span> <span class="fl">0.0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span> <span class="dv">3000</span><span class="op">,</span> <span class="dt">bands</span><span class="op">:</span> [<span class="st">&#39;B4&#39;</span><span class="op">,</span> <span class="st">&#39;B3&#39;</span><span class="op">,</span> <span class="st">&#39;B2&#39;</span>]}<span class="op">;</span></span>
<span id="cb98-81"><a href="#cb98-81" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> waterVis <span class="op">=</span> {<span class="dt">min</span><span class="op">:</span><span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span><span class="dv">1</span><span class="op">,</span> <span class="dt">palette</span><span class="op">:</span> [<span class="st">&#39;white&#39;</span><span class="op">,</span> <span class="st">&#39;blue&#39;</span>]}</span>
<span id="cb98-82"><a href="#cb98-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-83"><a href="#cb98-83" aria-hidden="true" tabindex="-1"></a><span class="co">// Visualize the results</span></span>
<span id="cb98-84"><a href="#cb98-84" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">setCenter</span>(<span class="fl">77.61</span><span class="op">,</span> <span class="fl">13.08</span><span class="op">,</span> <span class="dv">14</span>)</span>
<span id="cb98-85"><a href="#cb98-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-86"><a href="#cb98-86" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">centerObject</span>(geometry<span class="op">,</span> <span class="dv">10</span>)</span>
<span id="cb98-87"><a href="#cb98-87" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(image<span class="op">,</span> rgbVis<span class="op">,</span> <span class="st">&#39;Image&#39;</span>)<span class="op">;</span></span>
<span id="cb98-88"><a href="#cb98-88" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(clustered<span class="op">.</span><span class="fu">randomVisualizer</span>()<span class="op">,</span> {}<span class="op">,</span> <span class="st">&#39;clusters&#39;</span>)</span>
<span id="cb98-89"><a href="#cb98-89" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(water<span class="op">,</span> waterVis<span class="op">,</span> <span class="st">&#39;water&#39;</span>)</span>
<span id="cb98-90"><a href="#cb98-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb98-91"><a href="#cb98-91" aria-hidden="true" tabindex="-1"></a><span class="co">// Interactive visualization may time-out for large images</span></span>
<span id="cb98-92"><a href="#cb98-92" aria-hidden="true" tabindex="-1"></a><span class="co">// Export the image to use the batch processing mode</span></span>
<span id="cb98-93"><a href="#cb98-93" aria-hidden="true" tabindex="-1"></a>Export<span class="op">.</span><span class="at">image</span><span class="op">.</span><span class="fu">toDrive</span>({</span>
<span id="cb98-94"><a href="#cb98-94" aria-hidden="true" tabindex="-1"></a>  <span class="dt">image</span><span class="op">:</span> water<span class="op">,</span></span>
<span id="cb98-95"><a href="#cb98-95" aria-hidden="true" tabindex="-1"></a>  <span class="dt">description</span><span class="op">:</span> <span class="st">&#39;Water_Cluster&#39;</span><span class="op">,</span></span>
<span id="cb98-96"><a href="#cb98-96" aria-hidden="true" tabindex="-1"></a>  <span class="dt">folder</span><span class="op">:</span> <span class="st">&#39;earthengine&#39;</span><span class="op">,</span></span>
<span id="cb98-97"><a href="#cb98-97" aria-hidden="true" tabindex="-1"></a>  <span class="dt">fileNamePrefix</span><span class="op">:</span> <span class="st">&#39;water_cluster&#39;</span><span class="op">,</span></span>
<span id="cb98-98"><a href="#cb98-98" aria-hidden="true" tabindex="-1"></a>  <span class="dt">region</span><span class="op">:</span> geometry<span class="op">,</span></span>
<span id="cb98-99"><a href="#cb98-99" aria-hidden="true" tabindex="-1"></a>  <span class="dt">scale</span><span class="op">:</span> <span class="dv">20</span><span class="op">,</span></span>
<span id="cb98-100"><a href="#cb98-100" aria-hidden="true" tabindex="-1"></a>  <span class="dt">maxPixels</span><span class="op">:</span> <span class="fl">1e10</span>}) </span>
<span id="cb98-101"><a href="#cb98-101" aria-hidden="true" tabindex="-1"></a>  </span></code></pre></div>
</div>
<div id="unsupervised-clustering-advanced" class="section level3">
<h3>Unsupervised Clustering Advanced</h3>
<div class="sourceCode" id="cb99"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a><span class="co">/*</span></span>
<span id="cb99-2"><a href="#cb99-2" aria-hidden="true" tabindex="-1"></a><span class="co">GEE adaptation of the &#39;waterdetect&#39; algorithm</span></span>
<span id="cb99-3"><a href="#cb99-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-4"><a href="#cb99-4" aria-hidden="true" tabindex="-1"></a><span class="co">Copyright (c) 2021 Ujaval Gandhi.</span></span>
<span id="cb99-5"><a href="#cb99-5" aria-hidden="true" tabindex="-1"></a><span class="co">This work is licensed under the terms of the MIT license.  </span></span>
<span id="cb99-6"><a href="#cb99-6" aria-hidden="true" tabindex="-1"></a><span class="co">For a copy, see https://opensource.org/licenses/MIT</span></span>
<span id="cb99-7"><a href="#cb99-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-8"><a href="#cb99-8" aria-hidden="true" tabindex="-1"></a><span class="co">Reference: https://github.com/cordmaur/WaterDetect</span></span>
<span id="cb99-9"><a href="#cb99-9" aria-hidden="true" tabindex="-1"></a><span class="co">Cordeiro, M. C. R.; Martinez, J.-M.; Peña-Luque, S. </span></span>
<span id="cb99-10"><a href="#cb99-10" aria-hidden="true" tabindex="-1"></a><span class="co">Automatic Water Detection from Multidimensional Hierarchical Clustering for Sentinel-2 Images</span></span>
<span id="cb99-11"><a href="#cb99-11" aria-hidden="true" tabindex="-1"></a><span class="co">and a Comparison with Level 2A Processors. </span></span>
<span id="cb99-12"><a href="#cb99-12" aria-hidden="true" tabindex="-1"></a><span class="co">Remote Sensing of Environment 2021, 253, 112209. https://doi.org/10.1016/j.rse.2020.112209.</span></span>
<span id="cb99-13"><a href="#cb99-13" aria-hidden="true" tabindex="-1"></a><span class="co">*/</span></span>
<span id="cb99-14"><a href="#cb99-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-15"><a href="#cb99-15" aria-hidden="true" tabindex="-1"></a><span class="co">// Create a composite for the selected region</span></span>
<span id="cb99-16"><a href="#cb99-16" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> admin2 <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">&quot;FAO/GAUL_SIMPLIFIED_500m/2015/level2&quot;</span>)<span class="op">;</span></span>
<span id="cb99-17"><a href="#cb99-17" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> s2 <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&quot;COPERNICUS/S2_SR&quot;</span>)<span class="op">;</span></span>
<span id="cb99-18"><a href="#cb99-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-19"><a href="#cb99-19" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> selected <span class="op">=</span> admin2<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;ADM2_NAME&#39;</span><span class="op">,</span> <span class="st">&#39;Bangalore Urban&#39;</span>))</span>
<span id="cb99-20"><a href="#cb99-20" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> geometry <span class="op">=</span> selected<span class="op">.</span><span class="fu">geometry</span>()</span>
<span id="cb99-21"><a href="#cb99-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-22"><a href="#cb99-22" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> filtered <span class="op">=</span> s2<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">lt</span>(<span class="st">&#39;CLOUDY_PIXEL_PERCENTAGE&#39;</span><span class="op">,</span> <span class="dv">30</span>))</span>
<span id="cb99-23"><a href="#cb99-23" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(<span class="st">&#39;2019-01-01&#39;</span><span class="op">,</span> <span class="st">&#39;2020-01-01&#39;</span>))</span>
<span id="cb99-24"><a href="#cb99-24" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">bounds</span>(geometry))</span>
<span id="cb99-25"><a href="#cb99-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-26"><a href="#cb99-26" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> image <span class="op">=</span> filtered<span class="op">.</span><span class="fu">median</span>()<span class="op">.</span><span class="fu">clip</span>(geometry)<span class="op">;</span> </span>
<span id="cb99-27"><a href="#cb99-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-28"><a href="#cb99-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-29"><a href="#cb99-29" aria-hidden="true" tabindex="-1"></a><span class="co">// Calculate  Normalized Difference Vegetation Index (NDWI)</span></span>
<span id="cb99-30"><a href="#cb99-30" aria-hidden="true" tabindex="-1"></a><span class="co">// &#39;GREEN&#39; (B3) and &#39;NIR&#39; (B8)</span></span>
<span id="cb99-31"><a href="#cb99-31" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> ndwi <span class="op">=</span> image<span class="op">.</span><span class="fu">normalizedDifference</span>([<span class="st">&#39;B3&#39;</span><span class="op">,</span> <span class="st">&#39;B8&#39;</span>])<span class="op">.</span><span class="fu">rename</span>([<span class="st">&#39;ndwi&#39;</span>])<span class="op">;</span></span>
<span id="cb99-32"><a href="#cb99-32" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb99-33"><a href="#cb99-33" aria-hidden="true" tabindex="-1"></a><span class="co">// Calculate Modified Normalized Difference Water Index (MNDWI)</span></span>
<span id="cb99-34"><a href="#cb99-34" aria-hidden="true" tabindex="-1"></a><span class="co">// &#39;GREEN&#39; (B3) and &#39;SWIR1&#39; (B11)</span></span>
<span id="cb99-35"><a href="#cb99-35" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> mndwi <span class="op">=</span> image<span class="op">.</span><span class="fu">normalizedDifference</span>([<span class="st">&#39;B3&#39;</span><span class="op">,</span> <span class="st">&#39;B11&#39;</span>])<span class="op">.</span><span class="fu">rename</span>([<span class="st">&#39;mndwi&#39;</span>])<span class="op">;</span> </span>
<span id="cb99-36"><a href="#cb99-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-37"><a href="#cb99-37" aria-hidden="true" tabindex="-1"></a><span class="co">// Select the MIR (SWIR2) band (B12)</span></span>
<span id="cb99-38"><a href="#cb99-38" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> mir2 <span class="op">=</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;B12&#39;</span>)<span class="op">.</span><span class="fu">multiply</span>(<span class="fl">0.0001</span>)<span class="op">.</span><span class="fu">rename</span>(<span class="st">&#39;mir2&#39;</span>)</span>
<span id="cb99-39"><a href="#cb99-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-40"><a href="#cb99-40" aria-hidden="true" tabindex="-1"></a><span class="co">// Use [NDWI, MNDWI, Mir2] combination</span></span>
<span id="cb99-41"><a href="#cb99-41" aria-hidden="true" tabindex="-1"></a><span class="co">// If these do not work well for your region, try other</span></span>
<span id="cb99-42"><a href="#cb99-42" aria-hidden="true" tabindex="-1"></a><span class="co">// band combinations given at</span></span>
<span id="cb99-43"><a href="#cb99-43" aria-hidden="true" tabindex="-1"></a><span class="co">// https://github.com/cordmaur/WaterDetect/blob/master/WaterDetect.ini</span></span>
<span id="cb99-44"><a href="#cb99-44" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> stackedImage <span class="op">=</span> ndwi<span class="op">.</span><span class="fu">addBands</span>(mndwi)<span class="op">.</span><span class="fu">addBands</span>(mir2)</span>
<span id="cb99-45"><a href="#cb99-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-46"><a href="#cb99-46" aria-hidden="true" tabindex="-1"></a><span class="co">// Make the training dataset for unsupervised clustering</span></span>
<span id="cb99-47"><a href="#cb99-47" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> training <span class="op">=</span> stackedImage<span class="op">.</span><span class="fu">sample</span>({</span>
<span id="cb99-48"><a href="#cb99-48" aria-hidden="true" tabindex="-1"></a>  <span class="dt">region</span><span class="op">:</span> geometry<span class="op">,</span></span>
<span id="cb99-49"><a href="#cb99-49" aria-hidden="true" tabindex="-1"></a>  <span class="dt">scale</span><span class="op">:</span> <span class="dv">20</span><span class="op">,</span></span>
<span id="cb99-50"><a href="#cb99-50" aria-hidden="true" tabindex="-1"></a>  <span class="dt">numPixels</span><span class="op">:</span> <span class="dv">1000</span></span>
<span id="cb99-51"><a href="#cb99-51" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb99-52"><a href="#cb99-52" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(training<span class="op">.</span><span class="fu">first</span>())</span>
<span id="cb99-53"><a href="#cb99-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-54"><a href="#cb99-54" aria-hidden="true" tabindex="-1"></a><span class="co">// Instantiate the clusterer and train it.</span></span>
<span id="cb99-55"><a href="#cb99-55" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> clusterer <span class="op">=</span> ee<span class="op">.</span><span class="at">Clusterer</span><span class="op">.</span><span class="fu">wekaCascadeKMeans</span>({</span>
<span id="cb99-56"><a href="#cb99-56" aria-hidden="true" tabindex="-1"></a>  <span class="dt">minClusters</span><span class="op">:</span> <span class="dv">2</span><span class="op">,</span></span>
<span id="cb99-57"><a href="#cb99-57" aria-hidden="true" tabindex="-1"></a>  <span class="dt">maxClusters</span><span class="op">:</span> <span class="dv">10</span>})<span class="op">.</span><span class="fu">train</span>(training)<span class="op">;</span></span>
<span id="cb99-58"><a href="#cb99-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-59"><a href="#cb99-59" aria-hidden="true" tabindex="-1"></a><span class="co">// Cluster the stacked image</span></span>
<span id="cb99-60"><a href="#cb99-60" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> clustered <span class="op">=</span> stackedImage<span class="op">.</span><span class="fu">cluster</span>(clusterer)<span class="op">;</span></span>
<span id="cb99-61"><a href="#cb99-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-62"><a href="#cb99-62" aria-hidden="true" tabindex="-1"></a><span class="co">// We need to identify which of the clusters represent water</span></span>
<span id="cb99-63"><a href="#cb99-63" aria-hidden="true" tabindex="-1"></a><span class="co">// We use the MNDWI band and select the cluster with the </span></span>
<span id="cb99-64"><a href="#cb99-64" aria-hidden="true" tabindex="-1"></a><span class="co">// highest average MNDWI values of all pixels within the cluster</span></span>
<span id="cb99-65"><a href="#cb99-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-66"><a href="#cb99-66" aria-hidden="true" tabindex="-1"></a><span class="co">// Calculate the stats on MNDWI band, grouped by clusters</span></span>
<span id="cb99-67"><a href="#cb99-67" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> stats <span class="op">=</span> mndwi<span class="op">.</span><span class="fu">addBands</span>(clustered)<span class="op">.</span><span class="fu">reduceRegion</span>({</span>
<span id="cb99-68"><a href="#cb99-68" aria-hidden="true" tabindex="-1"></a>  <span class="dt">reducer</span><span class="op">:</span> ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">mean</span>()<span class="op">.</span><span class="fu">group</span>({</span>
<span id="cb99-69"><a href="#cb99-69" aria-hidden="true" tabindex="-1"></a>    <span class="dt">groupField</span><span class="op">:</span> <span class="dv">1</span><span class="op">,</span></span>
<span id="cb99-70"><a href="#cb99-70" aria-hidden="true" tabindex="-1"></a>    <span class="dt">groupName</span><span class="op">:</span> <span class="st">&#39;cluster&#39;</span><span class="op">,</span></span>
<span id="cb99-71"><a href="#cb99-71" aria-hidden="true" tabindex="-1"></a>  })<span class="op">,</span></span>
<span id="cb99-72"><a href="#cb99-72" aria-hidden="true" tabindex="-1"></a>  <span class="dt">geometry</span><span class="op">:</span> geometry<span class="op">,</span></span>
<span id="cb99-73"><a href="#cb99-73" aria-hidden="true" tabindex="-1"></a>  <span class="dt">scale</span><span class="op">:</span> <span class="dv">100</span><span class="op">,</span></span>
<span id="cb99-74"><a href="#cb99-74" aria-hidden="true" tabindex="-1"></a>  <span class="dt">maxPixels</span><span class="op">:</span> <span class="fl">1e8</span></span>
<span id="cb99-75"><a href="#cb99-75" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb99-76"><a href="#cb99-76" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(stats)</span>
<span id="cb99-77"><a href="#cb99-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-78"><a href="#cb99-78" aria-hidden="true" tabindex="-1"></a><span class="co">// Extract the cluster-wise stats as a list of lists</span></span>
<span id="cb99-79"><a href="#cb99-79" aria-hidden="true" tabindex="-1"></a><span class="co">// We get a list in the following format</span></span>
<span id="cb99-80"><a href="#cb99-80" aria-hidden="true" tabindex="-1"></a><span class="co">// [[avg_mndwi, cluster_number], [avg_mndwi, cluster_number] ...]]</span></span>
<span id="cb99-81"><a href="#cb99-81" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> groupStats <span class="op">=</span> ee<span class="op">.</span><span class="fu">List</span>(stats<span class="op">.</span><span class="fu">get</span>(<span class="st">&#39;groups&#39;</span>))</span>
<span id="cb99-82"><a href="#cb99-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-83"><a href="#cb99-83" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> groupStatsLists <span class="op">=</span> groupStats<span class="op">.</span><span class="fu">map</span>(<span class="kw">function</span>(item) {</span>
<span id="cb99-84"><a href="#cb99-84" aria-hidden="true" tabindex="-1"></a>      <span class="kw">var</span> areaDict <span class="op">=</span> ee<span class="op">.</span><span class="fu">Dictionary</span>(item)</span>
<span id="cb99-85"><a href="#cb99-85" aria-hidden="true" tabindex="-1"></a>      <span class="kw">var</span> clusterNumber <span class="op">=</span> ee<span class="op">.</span><span class="fu">Number</span>(</span>
<span id="cb99-86"><a href="#cb99-86" aria-hidden="true" tabindex="-1"></a>        areaDict<span class="op">.</span><span class="fu">get</span>(<span class="st">&#39;cluster&#39;</span>))</span>
<span id="cb99-87"><a href="#cb99-87" aria-hidden="true" tabindex="-1"></a>      <span class="kw">var</span> mndwi <span class="op">=</span> ee<span class="op">.</span><span class="fu">Number</span>(</span>
<span id="cb99-88"><a href="#cb99-88" aria-hidden="true" tabindex="-1"></a>        areaDict<span class="op">.</span><span class="fu">get</span>(<span class="st">&#39;mean&#39;</span>))</span>
<span id="cb99-89"><a href="#cb99-89" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> ee<span class="op">.</span><span class="fu">List</span>([mndwi<span class="op">,</span> clusterNumber])</span>
<span id="cb99-90"><a href="#cb99-90" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb99-91"><a href="#cb99-91" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb99-92"><a href="#cb99-92" aria-hidden="true" tabindex="-1"></a><span class="co">// Use the ee.Reducer.max() on the list of lists</span></span>
<span id="cb99-93"><a href="#cb99-93" aria-hidden="true" tabindex="-1"></a><span class="co">// It will pick the list with the highest MNDWI</span></span>
<span id="cb99-94"><a href="#cb99-94" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> waterClusterList <span class="op">=</span> ee<span class="op">.</span><span class="fu">Dictionary</span>(ee<span class="op">.</span><span class="fu">List</span>(groupStatsLists)<span class="op">.</span><span class="fu">reduce</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">max</span>(<span class="dv">2</span>)))</span>
<span id="cb99-95"><a href="#cb99-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-96"><a href="#cb99-96" aria-hidden="true" tabindex="-1"></a><span class="co">// Extract the cluster number</span></span>
<span id="cb99-97"><a href="#cb99-97" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> waterCluster <span class="op">=</span> ee<span class="op">.</span><span class="fu">Number</span>(waterClusterList<span class="op">.</span><span class="fu">get</span>(<span class="st">&#39;max1&#39;</span>))</span>
<span id="cb99-98"><a href="#cb99-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-99"><a href="#cb99-99" aria-hidden="true" tabindex="-1"></a><span class="co">// Select all pixels from the water cluster and mask everything else</span></span>
<span id="cb99-100"><a href="#cb99-100" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> water <span class="op">=</span> clustered<span class="op">.</span><span class="fu">eq</span>(waterCluster)<span class="op">.</span><span class="fu">selfMask</span>()</span>
<span id="cb99-101"><a href="#cb99-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-102"><a href="#cb99-102" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> rgbVis <span class="op">=</span> {<span class="dt">min</span><span class="op">:</span> <span class="fl">0.0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span> <span class="dv">3000</span><span class="op">,</span> <span class="dt">bands</span><span class="op">:</span> [<span class="st">&#39;B4&#39;</span><span class="op">,</span> <span class="st">&#39;B3&#39;</span><span class="op">,</span> <span class="st">&#39;B2&#39;</span>]}<span class="op">;</span></span>
<span id="cb99-103"><a href="#cb99-103" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> waterVis <span class="op">=</span> {<span class="dt">min</span><span class="op">:</span><span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span><span class="dv">1</span><span class="op">,</span> <span class="dt">palette</span><span class="op">:</span> [<span class="st">&#39;white&#39;</span><span class="op">,</span> <span class="st">&#39;blue&#39;</span>]}</span>
<span id="cb99-104"><a href="#cb99-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-105"><a href="#cb99-105" aria-hidden="true" tabindex="-1"></a><span class="co">// Visualize the results</span></span>
<span id="cb99-106"><a href="#cb99-106" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">setCenter</span>(<span class="fl">77.61</span><span class="op">,</span> <span class="fl">13.08</span><span class="op">,</span> <span class="dv">14</span>)</span>
<span id="cb99-107"><a href="#cb99-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-108"><a href="#cb99-108" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">centerObject</span>(geometry<span class="op">,</span> <span class="dv">10</span>)</span>
<span id="cb99-109"><a href="#cb99-109" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(image<span class="op">,</span> rgbVis<span class="op">,</span> <span class="st">&#39;Image&#39;</span>)<span class="op">;</span></span>
<span id="cb99-110"><a href="#cb99-110" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(clustered<span class="op">.</span><span class="fu">randomVisualizer</span>()<span class="op">,</span> {}<span class="op">,</span> <span class="st">&#39;clusters&#39;</span>)</span>
<span id="cb99-111"><a href="#cb99-111" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(water<span class="op">,</span> waterVis<span class="op">,</span> <span class="st">&#39;water&#39;</span>)</span>
<span id="cb99-112"><a href="#cb99-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb99-113"><a href="#cb99-113" aria-hidden="true" tabindex="-1"></a><span class="co">// Interactive visualization may time-out for large images</span></span>
<span id="cb99-114"><a href="#cb99-114" aria-hidden="true" tabindex="-1"></a><span class="co">// Export the image to use the batch processing mode</span></span>
<span id="cb99-115"><a href="#cb99-115" aria-hidden="true" tabindex="-1"></a>Export<span class="op">.</span><span class="at">image</span><span class="op">.</span><span class="fu">toDrive</span>({</span>
<span id="cb99-116"><a href="#cb99-116" aria-hidden="true" tabindex="-1"></a>  <span class="dt">image</span><span class="op">:</span> water<span class="op">,</span></span>
<span id="cb99-117"><a href="#cb99-117" aria-hidden="true" tabindex="-1"></a>  <span class="dt">description</span><span class="op">:</span> <span class="st">&#39;Water_Cluster&#39;</span><span class="op">,</span></span>
<span id="cb99-118"><a href="#cb99-118" aria-hidden="true" tabindex="-1"></a>  <span class="dt">folder</span><span class="op">:</span> <span class="st">&#39;earthengine&#39;</span><span class="op">,</span></span>
<span id="cb99-119"><a href="#cb99-119" aria-hidden="true" tabindex="-1"></a>  <span class="dt">fileNamePrefix</span><span class="op">:</span> <span class="st">&#39;water_cluster&#39;</span><span class="op">,</span></span>
<span id="cb99-120"><a href="#cb99-120" aria-hidden="true" tabindex="-1"></a>  <span class="dt">region</span><span class="op">:</span> geometry<span class="op">,</span></span>
<span id="cb99-121"><a href="#cb99-121" aria-hidden="true" tabindex="-1"></a>  <span class="dt">scale</span><span class="op">:</span> <span class="dv">20</span><span class="op">,</span></span>
<span id="cb99-122"><a href="#cb99-122" aria-hidden="true" tabindex="-1"></a>  <span class="dt">maxPixels</span><span class="op">:</span> <span class="fl">1e10</span>})</span>
<span id="cb99-123"><a href="#cb99-123" aria-hidden="true" tabindex="-1"></a>  </span></code></pre></div>
</div>
</div>
<div id="time-series-analysis" class="section level2">
<h2>Time Series Analysis</h2>
<div id="mann-kendall-test" class="section level3">
<h3>Mann Kendall Test</h3>
<div class="sourceCode" id="cb100"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> taluks <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">&quot;users/ujavalgandhi/gee-water-resources/kgis_taluks&quot;</span>)<span class="op">;</span></span>
<span id="cb100-2"><a href="#cb100-2" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> chirps <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&#39;UCSB-CHG/CHIRPS/PENTAD&#39;</span>)</span>
<span id="cb100-3"><a href="#cb100-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-4"><a href="#cb100-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-5"><a href="#cb100-5" aria-hidden="true" tabindex="-1"></a><span class="co">// We will compute the trend of total seasonal rainfall</span></span>
<span id="cb100-6"><a href="#cb100-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-7"><a href="#cb100-7" aria-hidden="true" tabindex="-1"></a><span class="co">// Introducting calendarRange()</span></span>
<span id="cb100-8"><a href="#cb100-8" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> julyImages <span class="op">=</span> chirps</span>
<span id="cb100-9"><a href="#cb100-9" aria-hidden="true" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">calendarRange</span>(<span class="dv">7</span><span class="op">,</span> <span class="dv">7</span><span class="op">,</span> <span class="st">&#39;month&#39;</span>))</span>
<span id="cb100-10"><a href="#cb100-10" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(julyImages)</span>
<span id="cb100-11"><a href="#cb100-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-12"><a href="#cb100-12" aria-hidden="true" tabindex="-1"></a><span class="co">// Rainy season is June - September</span></span>
<span id="cb100-13"><a href="#cb100-13" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> createSeasonalImage <span class="op">=</span> <span class="kw">function</span>(year) {</span>
<span id="cb100-14"><a href="#cb100-14" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> startDate <span class="op">=</span> ee<span class="op">.</span><span class="at">Date</span><span class="op">.</span><span class="fu">fromYMD</span>(year<span class="op">,</span> <span class="dv">6</span><span class="op">,</span> <span class="dv">1</span>)</span>
<span id="cb100-15"><a href="#cb100-15" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> endDate <span class="op">=</span> ee<span class="op">.</span><span class="at">Date</span><span class="op">.</span><span class="fu">fromYMD</span>(year<span class="op">,</span> <span class="dv">9</span><span class="op">,</span> <span class="dv">30</span>)</span>
<span id="cb100-16"><a href="#cb100-16" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> seasonFiltered <span class="op">=</span> chirps</span>
<span id="cb100-17"><a href="#cb100-17" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(startDate<span class="op">,</span> endDate))</span>
<span id="cb100-18"><a href="#cb100-18" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Calculate total precipitation</span></span>
<span id="cb100-19"><a href="#cb100-19" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> total <span class="op">=</span> seasonFiltered<span class="op">.</span><span class="fu">reduce</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">sum</span>())</span>
<span id="cb100-20"><a href="#cb100-20" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> total<span class="op">.</span><span class="fu">set</span>({</span>
<span id="cb100-21"><a href="#cb100-21" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;system:time_start&#39;</span><span class="op">:</span> startDate<span class="op">.</span><span class="fu">millis</span>()<span class="op">,</span></span>
<span id="cb100-22"><a href="#cb100-22" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;system:time_end&#39;</span><span class="op">:</span> endDate<span class="op">.</span><span class="fu">millis</span>()<span class="op">,</span></span>
<span id="cb100-23"><a href="#cb100-23" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;year&#39;</span><span class="op">:</span> year<span class="op">,</span></span>
<span id="cb100-24"><a href="#cb100-24" aria-hidden="true" tabindex="-1"></a>  })</span>
<span id="cb100-25"><a href="#cb100-25" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb100-26"><a href="#cb100-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-27"><a href="#cb100-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-28"><a href="#cb100-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-29"><a href="#cb100-29" aria-hidden="true" tabindex="-1"></a><span class="co">// Aggregate Precipitation Data to get Annual Time-Series</span></span>
<span id="cb100-30"><a href="#cb100-30" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> years <span class="op">=</span> ee<span class="op">.</span><span class="at">List</span><span class="op">.</span><span class="fu">sequence</span>(<span class="dv">1981</span><span class="op">,</span> <span class="dv">2013</span>)</span>
<span id="cb100-31"><a href="#cb100-31" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> yearlyImages <span class="op">=</span> years<span class="op">.</span><span class="fu">map</span>(createSeasonalImage)</span>
<span id="cb100-32"><a href="#cb100-32" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(yearlyImages)</span>
<span id="cb100-33"><a href="#cb100-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-34"><a href="#cb100-34" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> yearlyCol <span class="op">=</span> ee<span class="op">.</span><span class="at">ImageCollection</span><span class="op">.</span><span class="fu">fromImages</span>(yearlyImages)</span>
<span id="cb100-35"><a href="#cb100-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-36"><a href="#cb100-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-37"><a href="#cb100-37" aria-hidden="true" tabindex="-1"></a><span class="co">// Join the time series to itself</span></span>
<span id="cb100-38"><a href="#cb100-38" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> afterFilter <span class="op">=</span> ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">lessThan</span>({</span>
<span id="cb100-39"><a href="#cb100-39" aria-hidden="true" tabindex="-1"></a>  <span class="dt">leftField</span><span class="op">:</span> <span class="st">&#39;system:time_start&#39;</span><span class="op">,</span></span>
<span id="cb100-40"><a href="#cb100-40" aria-hidden="true" tabindex="-1"></a>  <span class="dt">rightField</span><span class="op">:</span> <span class="st">&#39;system:time_start&#39;</span></span>
<span id="cb100-41"><a href="#cb100-41" aria-hidden="true" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb100-42"><a href="#cb100-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-43"><a href="#cb100-43" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> joined <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(ee<span class="op">.</span><span class="at">Join</span><span class="op">.</span><span class="fu">saveAll</span>(<span class="st">&#39;after&#39;</span>)<span class="op">.</span><span class="fu">apply</span>({</span>
<span id="cb100-44"><a href="#cb100-44" aria-hidden="true" tabindex="-1"></a>  <span class="dt">primary</span><span class="op">:</span> yearlyCol<span class="op">,</span></span>
<span id="cb100-45"><a href="#cb100-45" aria-hidden="true" tabindex="-1"></a>  <span class="dt">secondary</span><span class="op">:</span> yearlyCol<span class="op">,</span></span>
<span id="cb100-46"><a href="#cb100-46" aria-hidden="true" tabindex="-1"></a>  <span class="dt">condition</span><span class="op">:</span> afterFilter</span>
<span id="cb100-47"><a href="#cb100-47" aria-hidden="true" tabindex="-1"></a>}))<span class="op">;</span></span>
<span id="cb100-48"><a href="#cb100-48" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(joined)</span>
<span id="cb100-49"><a href="#cb100-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-50"><a href="#cb100-50" aria-hidden="true" tabindex="-1"></a><span class="co">// Mann-Kendall trend test</span></span>
<span id="cb100-51"><a href="#cb100-51" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> sign <span class="op">=</span> <span class="kw">function</span>(i<span class="op">,</span> j) { <span class="co">// i and j are images</span></span>
<span id="cb100-52"><a href="#cb100-52" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> ee<span class="op">.</span><span class="fu">Image</span>(j)<span class="op">.</span><span class="fu">neq</span>(i) <span class="co">// Zero case</span></span>
<span id="cb100-53"><a href="#cb100-53" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span><span class="fu">multiply</span>(ee<span class="op">.</span><span class="fu">Image</span>(j)<span class="op">.</span><span class="fu">subtract</span>(i)<span class="op">.</span><span class="fu">clamp</span>(<span class="op">-</span><span class="dv">1</span><span class="op">,</span> <span class="dv">1</span>))<span class="op">.</span><span class="fu">int</span>()<span class="op">;</span></span>
<span id="cb100-54"><a href="#cb100-54" aria-hidden="true" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb100-55"><a href="#cb100-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-56"><a href="#cb100-56" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> kendall <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(joined<span class="op">.</span><span class="fu">map</span>(<span class="kw">function</span>(current) {</span>
<span id="cb100-57"><a href="#cb100-57" aria-hidden="true" tabindex="-1"></a>  <span class="kw">var</span> afterCollection <span class="op">=</span> ee<span class="op">.</span><span class="at">ImageCollection</span><span class="op">.</span><span class="fu">fromImages</span>(current<span class="op">.</span><span class="fu">get</span>(<span class="st">&#39;after&#39;</span>))<span class="op">;</span></span>
<span id="cb100-58"><a href="#cb100-58" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> afterCollection<span class="op">.</span><span class="fu">map</span>(<span class="kw">function</span>(image) {</span>
<span id="cb100-59"><a href="#cb100-59" aria-hidden="true" tabindex="-1"></a>    <span class="co">// The unmask is to prevent accumulation of masked pixels that</span></span>
<span id="cb100-60"><a href="#cb100-60" aria-hidden="true" tabindex="-1"></a>    <span class="co">// result from the undefined case of when either current or image</span></span>
<span id="cb100-61"><a href="#cb100-61" aria-hidden="true" tabindex="-1"></a>    <span class="co">// is masked.  It won&#39;t affect the sum, since it&#39;s unmasked to zero.</span></span>
<span id="cb100-62"><a href="#cb100-62" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> ee<span class="op">.</span><span class="fu">Image</span>(<span class="fu">sign</span>(current<span class="op">,</span> image))<span class="op">.</span><span class="fu">unmask</span>(<span class="dv">0</span>)<span class="op">;</span></span>
<span id="cb100-63"><a href="#cb100-63" aria-hidden="true" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb100-64"><a href="#cb100-64" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Set parallelScale to avoid User memory limit exceeded.</span></span>
<span id="cb100-65"><a href="#cb100-65" aria-hidden="true" tabindex="-1"></a>})<span class="op">.</span><span class="fu">flatten</span>())<span class="op">.</span><span class="fu">reduce</span>(<span class="st">&#39;sum&#39;</span><span class="op">,</span> <span class="dv">2</span>)<span class="op">;</span></span>
<span id="cb100-66"><a href="#cb100-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-67"><a href="#cb100-67" aria-hidden="true" tabindex="-1"></a><span class="kw">var</span> palette <span class="op">=</span> [<span class="st">&#39;red&#39;</span><span class="op">,</span> <span class="st">&#39;white&#39;</span><span class="op">,</span> <span class="st">&#39;green&#39;</span>]<span class="op">;</span></span>
<span id="cb100-68"><a href="#cb100-68" aria-hidden="true" tabindex="-1"></a><span class="co">// Stretch this as necessary.</span></span>
<span id="cb100-69"><a href="#cb100-69" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(kendall<span class="op">,</span> {<span class="dt">min</span><span class="op">:-</span><span class="dv">30</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span> <span class="dv">30</span><span class="op">,</span> <span class="dt">palette</span><span class="op">:</span> palette}<span class="op">,</span> <span class="st">&#39;kendall&#39;</span>)<span class="op">;</span> </span></code></pre></div>
</div>
</div>
</div>
<div id="data-credits" class="section level1">
<h1>Data Credits</h1>
<ul>
<li><p><strong>Sentinel-2 Level-1C, Level-2A</strong> and <strong>Sentinel-1 SAR GRD</strong>: Contains Copernicus Sentinel data.</p></li>
<li><p><strong>TerraClimate: Monthly Climate and Climatic Water Balance for Global Terrestrial Surfaces, University of Idaho</strong>: Abatzoglou, J.T., S.Z. Dobrowski, S.A. Parks, K.C. Hegewisch, 2018, Terraclimate, a high-resolution global dataset of monthly climate and climatic water balance from 1958-2015, Scientific Data 5:170191, <a href="doi:10.1038/sdata.2017.191" class="uri">doi:10.1038/sdata.2017.191</a></p></li>
<li><p><strong>FAO GAUL 500m: Global Administrative Unit Layers 2015, Second-Level Administrative Units</strong>: Source of Administrative boundaries: The Global Administrative Unit Layers (GAUL) dataset, implemented by FAO within the CountrySTAT and Agricultural Market Information System (AMIS) projects.</p></li>
<li><p><strong>CHIRPS Pentad: Climate Hazards Group InfraRed Precipitation with Station Data (version 2.0 final)</strong>: Funk, Chris, Pete Peterson, Martin Landsfeld, Diego Pedreros, James Verdin, Shraddhanand Shukla, Gregory Husak, James Rowland, Laura Harrison, Andrew Hoell &amp; Joel Michaelsen. “The climate hazards infrared precipitation with stations—a new environmental record for monitoring extremes”. Scientific Data 2, 150066. <a href="doi:10.1038/sdata.2015.66" class="uri">doi:10.1038/sdata.2015.66</a> 2015.</p></li>
<li><p><strong>MOD13Q1.006 Terra Vegetation Indices 16-Day Global 250m</strong>: Didan, K. (2015). <i>MOD13Q1 MODIS/Terra Vegetation Indices 16-Day L3 Global 250m SIN Grid V006</i> [Data set]. NASA EOSDIS Land Processes DAAC. Accessed 2021-05-06 from <a href="https://doi.org/10.5067/MODIS/MOD13Q1.006" class="uri">https://doi.org/10.5067/MODIS/MOD13Q1.006</a></p></li>
</ul>
</div>
<div id="license" class="section level1">
<h1>License</h1>
<p>The course material (text, images, presentation, videos) is licensed under a <a href="https://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution 4.0 International License</a>.</p>
<p>The code (scripts, Jupyter notebooks) is licensed under the MIT License. For a copy, see <a href="https://opensource.org/licenses/MIT" class="uri">https://opensource.org/licenses/MIT</a></p>
<p>Kindly give appropriate credit to the original author as below:</p>
<p>Copyright © 2021 Ujaval Gandhi <a href="https://spatialthoughts.com">www.spatialthoughts.com</a></p>
<p>If you would like to white-label these materials as part of a commercial offering, you can purchase a <em>Trainer License</em> for a small fee.</p>
<p>Please <a href="https://spatialthoughts.com/contact/">contact us</a> for pricing and terms.</p>
<hr />
<p><strong>This course is offered as an instructor-led online class. Visit <a href="https://spatialthoughts.com/events/">Spatial Thoughts</a> to know details of upcoming sessions.</strong></p>
</div>




</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.odd').parent('tbody').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open');
  });
});
</script>

<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
