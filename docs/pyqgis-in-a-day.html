<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />


<meta name="author" content="Ujaval Gandhi" />


<title>Customizing QGIS with Python (Full Course Material)</title>

<script src="site_libs/header-attrs-2.10/header-attrs.js"></script>
<script src="site_libs/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/flatly.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<style>h1 {font-size: 34px;}
       h1.title {font-size: 38px;}
       h2 {font-size: 30px;}
       h3 {font-size: 24px;}
       h4 {font-size: 18px;}
       h5 {font-size: 16px;}
       h6 {font-size: 12px;}
       code {color: inherit; background-color: rgba(0, 0, 0, 0.04);}
       pre:not([class]) { background-color: white }</style>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<link href="site_libs/pagedtable-1.1/css/pagedtable.css" rel="stylesheet" />
<script src="site_libs/pagedtable-1.1/js/pagedtable.js"></script>
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-172372432-3"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-172372432-3');
</script>

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>


<style type="text/css">
  code {
    white-space: pre;
  }
  .sourceCode {
    overflow: visible;
  }
</style>
<style type="text/css" data-origin="pandoc">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */

</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    for (var j = 0; j < rules.length; j++) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") continue;
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') continue;
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>







<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
pre code {
  padding: 0;
}
</style>


<style type="text/css">
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #adb5bd;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script type="text/javascript">
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.tab('show');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');

  // Navbar adjustments
  var navHeight = $(".navbar").first().height() + 15;
  var style = document.createElement('style');
  var pt = "padding-top: " + navHeight + "px; ";
  var mt = "margin-top: -" + navHeight + "px; ";
  var css = "";
  // offset scroll position for anchor links (for fixed navbar)
  for (var i = 1; i <= 6; i++) {
    css += ".section h" + i + "{ " + pt + mt + "}\n";
  }
  style.innerHTML = "body {" + pt + "padding-bottom: 40px; }\n" + css;
  document.head.appendChild(style);
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "&#xe258;";
  border: none;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->




</head>

<body>


<div class="container-fluid main-container">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">Courses</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="http://spatialthoughts.com">Back to Main Site</a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div id="header">



<h1 class="title toc-ignore">Customizing QGIS with Python (Full Course Material)</h1>
<h3 class="subtitle">Learn the QGIS Python API from the ground up</h3>
<h4 class="author">Ujaval Gandhi</h4>

</div>

<div id="TOC">
<ul>
<li><a href="#introduction">Introduction</a></li>
<li><a href="#software">Software</a></li>
<li><a href="#get-the-data-package">Get the Data Package</a></li>
<li><a href="#where-can-you-use-python-in-qgis">Where can you use Python in QGIS?</a></li>
<li><a href="#hello-world">1. Hello World!</a></li>
<li><a href="#hello-pyqgis">2. Hello PyQGIS!</a></li>
<li><a href="#understanding-classes">3. Understanding Classes</a></li>
<li><a href="#using-pyqgis-classes">4. Using PyQGIS Classes</a>
<ul>
<li><a href="#calculating-distance-using-pyqgis">4.1 Calculating distance using PyQGIS</a></li>
<li><a href="#exercise-1">Exercise 1</a></li>
<li><a href="#distance-conversion">4.2 Distance Conversion</a></li>
</ul></li>
<li><a href="#graphical-user-interface-gui-programming-basics">5. Graphical User Interface (GUI) Programming Basics</a>
<ul>
<li><a href="#qt-and-pyqt">5.1 Qt and PyQt</a></li>
<li><a href="#building-a-dialog-box">5.2 Building a Dialog Box</a></li>
</ul></li>
<li><a href="#deep-dive-into-pyqgis">6. Deep Dive into PyQGIS</a>
<ul>
<li><a href="#qgis-interface-api-qgisinterface">6.1 QGIS Interface API (QgisInterface)</a>
<ul>
<li><a href="#change-title-of-qgis-main-window">6.1.1 Change Title of QGIS Main Window</a></li>
<li><a href="#change-icon-of-qgis-main-window">6.1.2 Change Icon of QGIS Main Window</a></li>
<li><a href="#remove-raster-and-vector-menus">6.1.3 Remove Raster and Vector Menus</a></li>
<li><a href="#understanding-signals-and-slots">6.1.4 Understanding Signals and Slots</a></li>
<li><a href="#add-a-new-menu-item">6.1.5 Add A New Menu Item</a></li>
<li><a href="#change-visibility-of-a-toolbar">6.1.6 Change Visibility of a Toolbar</a></li>
<li><a href="#add-a-button-to-a-toolbar">6.1.7 Add a button to a toolbar</a></li>
<li><a href="#exercise-2">Exercise 2</a></li>
<li><a href="#add-new-layers">6.1.8 Add New Layers</a></li>
<li><a href="#change-name-of-a-layer">6.1.9 Change name of a Layer</a></li>
</ul></li>
<li><a href="#qgis-project-api-qgsproject">6.2 QGIS Project API (QgsProject)</a>
<ul>
<li><a href="#load-a-project">6.2.1 Load a project</a></li>
<li><a href="#search-for-a-layer">6.2.2 Search for a layer</a></li>
<li><a href="#turn-a-layer-onoff">6.2.3 Turn a layer on/off</a></li>
<li><a href="#exercise-3">Exercise 3</a></li>
</ul></li>
</ul></li>
<li><a href="#running-python-code-at-qgis-launch">7. Running Python Code at QGIS Launch</a>
<ul>
<li><a href="#exercise-4">Exercise 4</a></li>
</ul></li>
<li><a href="#creating-custom-python-actions">8. Creating Custom Python Actions</a>
<ul>
<li><a href="#actions-deep-dive">8.1 Actions Deep Dive</a></li>
</ul></li>
<li><a href="#learn-more">Learn more</a></li>
<li><a href="#running-processing-algorithms">9. Running Processing Algorithms</a>
<ul>
<li><a href="#creating-hillshade-from-a-dem">9.1 Creating Hillshade from a DEM</a></li>
<li><a href="#running-multiple-processing-algorithms">9.2 Running Multiple Processing Algorithms</a></li>
<li><a href="#exercise-5">Exercise 5</a></li>
</ul></li>
<li><a href="#advanced-python-concepts">10. Advanced Python Concepts</a>
<ul>
<li><a href="#understanding-python-iterators">10.1 Understanding Python Iterators</a></li>
<li><a href="#list-compresensions">10.2 List Compresensions</a></li>
</ul></li>
<li><a href="#writing-python-console-scripts">11. Writing Python Console Scripts</a></li>
<li><a href="#writing-standalone-python-scripts">12. Writing Standalone Python Scripts</a>
<ul>
<li><a href="#windows">Windows</a></li>
<li><a href="#macos">MacOS</a></li>
</ul></li>
<li><a href="#processing-scripts">13. Processing Scripts</a>
<ul>
<li><a href="#writing-a-python-class">13.1 Writing a Python Class</a></li>
<li><a href="#writing-a-processing-script">13.2 Writing a Processing Script</a></li>
<li><a href="#simplifying-processing-scripts">13.3 Simplifying Processing Scripts</a></li>
</ul></li>
<li><a href="#writing-plugins">14. Writing Plugins</a>
<ul>
<li><a href="#a-minimal-plugin">14.1 A Minimal Plugin</a></li>
<li><a href="#exercise-6">Exercise 6</a></li>
<li><a href="#processing-plugin">14.2 Processing Plugin</a></li>
</ul></li>
<li><a href="#supplement">15. Supplement</a>
<ul>
<li><a href="#save-map-rendering-as-an-image">Save Map Rendering as an Image</a></li>
<li><a href="#get-all-layers">Get all Layers</a></li>
<li><a href="#get-only-checked-visible-layers">Get only checked (visible) Layers</a></li>
<li><a href="#get-only-selected-layers">Get only selected Layers</a></li>
<li><a href="#set-canvas-extent-to-a-layer-extent">Set Canvas Extent to a Layer Extent</a></li>
<li><a href="#get-layers-with-hierarchy">Get Layers with Hierarchy</a></li>
<li><a href="#remove-a-specific-button-from-a-toolbar">Remove a Specific Button from a Toolbar</a></li>
<li><a href="#add-a-drop-down-menu-to-toolbar">Add a Drop-down Menu to Toolbar</a></li>
<li><a href="#adding-csv-layers">Adding CSV Layers</a></li>
<li><a href="#inserting-layers-in-the-layer-tree">Inserting Layers in the Layer Tree</a></li>
<li><a href="#create-a-new-vector-layer">Create a New Vector Layer</a></li>
<li><a href="#saving-layers-to-disk">Saving Layers to Disk</a></li>
<li><a href="#displaying-a-label-with-a-background-color">Displaying a label with a background color</a></li>
<li><a href="#edit-attribute-table-of-a-vector-layer">Edit Attribute Table of a Vector Layer</a></li>
<li><a href="#creating-a-pdf-with-title">Creating a PDF with Title</a></li>
</ul></li>
<li><a href="#resources">Resources</a></li>
<li><a href="#data-credits">Data Credits</a></li>
<li><a href="#license">License</a></li>
</ul>
</div>

<div style="page-break-after: always;"></div>
<hr />
<p><img src="images/spatial_thoughts_logo.png" width="250pt" style="display: block; margin: auto;" /></p>
<hr />
<div style="page-break-after: always;"></div>
<div id="introduction" class="section level1">
<h1>Introduction</h1>
<p>This class introduces the concepts of Python programming within the QGIS environment. We will cover the full breadth of topics that involve everything from using the Python Console to building a fully functional plugin. We will also explore GUI programming techniques for customizing the QGIS interface using Qt widgets.</p>
<p>This course requires basic knowledge of Python. If you are not familiar with Python, it is strongly recommended you complete our <a href="https://spatialthoughts.com/training/python-foundation-for-spatial-analysis/">Python Foundation for Spatial Analysis</a> course. We will build upon the exercises covered in that course.</p>
<p><a href="https://docs.google.com/presentation/d/1GT0c6jG3WmOZgsLuiIniEE9T1H8NJ5G6oemWX43VIUA/edit?usp=sharing" target="_blank"><img src="images/pyqgis/introduction.png" width="400" alt="View Presentation" /></a></p>
<p><a href="https://docs.google.com/presentation/d/1GT0c6jG3WmOZgsLuiIniEE9T1H8NJ5G6oemWX43VIUA/edit?usp=sharing" target="_blank">View the Presentation</a></p>
</div>
<div id="software" class="section level1">
<h1>Software</h1>
<p>This course requires QGIS LTR version 3.16. Please review <a href="install-qgis-ltr.html">QGIS-LTR Installation Guide</a> for step-by-step instructions.</p>
</div>
<div id="get-the-data-package" class="section level1">
<h1>Get the Data Package</h1>
<p>The code examples in this class use a variety of datasets. All the required layers, project files, icons etc. are supplied to you in the <code>pyqgis_in_a_day.zip</code> file. Unzip this file to the <code>Downloads</code> directory. All scripts assume the data is available in the <code>&lt;home folder&gt;/Downloads/pyqgis_in_a_day/</code> directory.</p>
<p><em>Not enrolled in our instrctor-led class but want to work through the material on your own?</em> <a href="https://docs.google.com/forms/d/e/1FAIpQLScr7UrXTwrP1Ec1M-EEIWVcgsXxMewv5uCdM_HaEk3YvUd0Uw/viewform" target="_blank">Get free access to the data package</a></p>
</div>
<div id="where-can-you-use-python-in-qgis" class="section level1">
<h1>Where can you use Python in QGIS?</h1>
<ul>
<li>Issue commands from Python Console</li>
<li>Automatically run python code when QGIS starts</li>
<li>Write custom expressions</li>
<li>Write custom actions</li>
<li>Create new processing algorithms</li>
<li>Create plugins</li>
<li>Create custom standalone applications</li>
</ul>
</div>
<div id="hello-world" class="section level1">
<h1>1. Hello World!</h1>
<p>QGIS Comes with a built-in <strong>Python Console</strong> and a code editor where you can write and run Python code.</p>
<p>Go to <strong>Plugins → Python Console</strong> to open the console.</p>
<p><img src="images/pyqgis/console.png" width="75%" style="display: block; margin: auto;" /></p>
<p>At the <code>&gt;&gt;&gt;</code> prompt, type in the following command and press Enter.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&#39;Hello World!&#39;</span>)</span></code></pre></div>
<p>Here you are running Python’s <em>print()</em> function with the text ‘Hello World’. The output of the statement will be printed below.</p>
<p><img src="images/pyqgis/helloworld.png" width="75%" style="display: block; margin: auto;" /></p>
<p>While console is useful for typing 1-2 lines of code or printing information contained in a variable, you should use the built-in editor for typing longer scripts or code snippets. Click the <em>Show Editor</em> button to open the editor panel. Enter the code and click the <em>Run Script</em> button to execute it. The results will appear in the console as before. If you are working on a longer script, you can also click the <em>Save</em> button in the editor to save the script for future use.</p>
<p><img src="images/pyqgis/editor.png" width="75%" style="display: block; margin: auto;" /></p>
<p>All code snippets below should be run from the Editor.</p>
</div>
<div id="hello-pyqgis" class="section level1">
<h1>2. Hello PyQGIS!</h1>
<p>QGIS provides a Python API (Application Programming Interface), commonly known as PyQGIS. The API is vast and very capable. Almost every operation that you can do using QGIS - can be done using the API. This allows developers to write code to build new tools, customize the interface and automate workflows.</p>
<p>Let’s try out the API to perform some GIS data management tasks.</p>
<p>Browse to the data directory and load the <code>shoreline.shp</code> layer. Open the <em>Attribute Table</em>. This layer has 6 attribute columns. Let’s say we want to delete the 2nd column (<code>SDE_SFGIS_</code>) from the layer.</p>
<p><img src="images/pyqgis/hellopyqgis1.png" width="75%" style="display: block; margin: auto;" /></p>
<p>This can be done using the QGIS GUI as follows</p>
<ol style="list-style-type: decimal">
<li>Right-click the <code>shoreline</code> layer and click <em>Open Attribute Table</em>.</li>
<li>In the Attribute Table, click the <em>Toggle Editing mode</em> button.</li>
<li>Click the <em>Delete field</em> button. Select the <code>SDE_SFGIS_</code> column and click <em>OK</em>.</li>
<li>Click the <em>Save edits</em> button and click the <em>Toggle Editing mode</em> to stop editing.</li>
</ol>
<p>QGIS Provides an API to accomplish all of this using Python code. We will now do this task - but using only Python code. Open the <em>Editor</em> and enter the following code. Click the <em>Run Script</em> button to execute it.</p>
<blockquote>
<p>Make sure you have selected the <code>shoreline</code> layer in the <em>Layers</em> panel before running the code.</p>
</blockquote>
<div class="sourceCode" id="cb2"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>layer <span class="op">=</span> iface.activeLayer()</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>layer.startEditing()</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>layer.deleteAttribute(<span class="dv">1</span>)</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>layer.commitChanges()</span></code></pre></div>
<p>You will see that the 2nd column is now deleted from the attribute table.</p>
<p><img src="images/pyqgis/hellopyqgis2.png" width="75%" style="display: block; margin: auto;" /></p>
<p>Let’s understand the code step-by-step</p>
<ol style="list-style-type: decimal">
<li><code>layer = iface.activeLayer()</code>: This line uses the <code>iface</code> object and runs the <code>activeLayer()</code> method which returns the currently selected layer in QGIS. We will learn more about <code>iface</code> in the <a href="#qgis-interface-api-qgisinterface">QGIS Interface API</a> section. The method returns the reference to the layer which is saved in the <code>layer</code> variable.</li>
<li><code>layer.startEditing()</code>: This is equivalent to putting the layer in the editing mode.</li>
<li><code>layer.deleteAttribute(1)</code>: The <code>deleteAttribute()</code> is a method from <code>QgsVectorLayer</code> class. It takes the index of the attribute to be deleted. Here we pass on index <code>1</code> for the second attribute. (index 0 is the first attribute)</li>
<li><code>layer.commitChanges()</code>: This method saves the edit buffer and also disables the editing mode.</li>
</ol>
<p>This gives you a preview of the power of the API. To harness the full power of the PyQGIS API, we must first understand how classes work.</p>
</div>
<div id="understanding-classes" class="section level1">
<h1>3. Understanding Classes</h1>
<p>Before we dive it to PyQGIS, it is important to understand certain concepts related to C++ and Python Classes. Qt as well as QGIS is written in C++ language. Functionality of each Qt/QGIS Widget is implemented as a class - having certain properties and functions. When we use PyQt or PyQGIS classes, it is executing the code in the C++ classes via the python bindings.</p>
<p><a href="https://docs.google.com/presentation/d/1b4i1nEDR_uKJVu0IIqjoqrxeFD2a-tnj88JRXQW0JiA/edit?usp=sharing" target="_blank"><img src="images/pyqgis/classes.png" width="400" alt="View Presentation" /></a></p>
<p><a href="https://docs.google.com/presentation/d/1b4i1nEDR_uKJVu0IIqjoqrxeFD2a-tnj88JRXQW0JiA/edit?usp=sharing" target="_blank">View the Presentation</a></p>
</div>
<div id="using-pyqgis-classes" class="section level1">
<h1>4. Using PyQGIS Classes</h1>
<p>Let’s start working with PyQGIS classes now. QGIS has classes for the whole range of operations - from building the user interface to doing geoprocessing. We will see how to access these classes via the PyQGIS API.</p>
<div id="calculating-distance-using-pyqgis" class="section level2">
<h2>4.1 Calculating distance using PyQGIS</h2>
<p>A basic but important operation in a GIS is the calculation of distance and areas. We will see how you can use PyQGIS APIs to compute distances.</p>
<p>We will compute distance between the following 2 coordinates</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>san_francisco <span class="op">=</span> (<span class="fl">37.7749</span>, <span class="op">-</span><span class="fl">122.4194</span>)</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>new_york <span class="op">=</span> (<span class="fl">40.661</span>, <span class="op">-</span><span class="fl">73.944</span>)</span></code></pre></div>
<p>QGIS provides the class <code>QgsDistanceArea</code> that has methods to compute distances and areas.</p>
<p>To use this class, we must create an object by instantiating it. Looking at the <a href="https://qgis.org/pyqgis/master/core/QgsDistanceArea.html">class documentation</a>, the class constructor doesn’t take any arguments. We can use the default constructor to create an object and assign it to the <code>d</code> variable.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>d <span class="op">=</span> QgsDistanceArea()</span></code></pre></div>
<p>The documentation mentions that if a valid ellipsoid has been set for the QgsDistanceArea, all calculations will be performed using ellipsoidal algorithms (e.g. using Vincenty’s formulas). As we want to compute the distance between a pair of latitude/longitudes, we need to use the ellipsoidal algorithms. Let’s set the ellipsoid <code>WGS84</code> for our calculation. We can use the method <code>setEllipsoid()</code>. Remember, methods should be applied on objects, and not classes directly.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>d.setEllipsoid(<span class="st">&#39;WGS84&#39;</span>)</span></code></pre></div>
<blockquote>
<p>Tip: All valid ellipsoids can be found by calling <code>QgsEllipsoidUtils.acronyms()</code></p>
</blockquote>
<p>Now our object <code>d</code> is capable of performing ellipsoidal distance computations. Browsing through the available methods in the <code>QgsDistanceArea</code> class, we can see a <code>measureLine()</code> method. This method takes a list <a href="https://qgis.org/pyqgis/master/core/QgsPointXY.html">QgsPointXY</a> objects. We can create these objects from our coordinate pairs and pass them on to the <code>measureLine()</code> method to get the distance. The output will be in meters. We divide it by 1000 to convert it to kilometers.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>lat1, lon1 <span class="op">=</span> san_francisco</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>lat2, lon2 <span class="op">=</span> new_york</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Remember the order is X,Y</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>point1 <span class="op">=</span> QgsPointXY(lon1, lat1)</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>point2 <span class="op">=</span> QgsPointXY(lon2, lat2)</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>distance <span class="op">=</span> d.measureLine([point1, point2])</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(distance<span class="op">/</span><span class="dv">1000</span>)</span></code></pre></div>
<p>Putting it all together, below is the complete code to calculate the distance between a pair of coordinates using PyQGIS. When you run the code in the Python Console of QGIS, all the PyQGIS classes are already imported. If you are running this code from a script or a plugin, you must explicitly import the <code>QgsDistanceArea</code> class.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> qgis.core <span class="im">import</span> QgsDistanceArea</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>san_francisco <span class="op">=</span> (<span class="fl">37.7749</span>, <span class="op">-</span><span class="fl">122.4194</span>)</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>new_york <span class="op">=</span> (<span class="fl">40.661</span>, <span class="op">-</span><span class="fl">73.944</span>)</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>d <span class="op">=</span> QgsDistanceArea()</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>d.setEllipsoid(<span class="st">&#39;WGS84&#39;</span>)</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>lat1, lon1 <span class="op">=</span> san_francisco</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>lat2, lon2 <span class="op">=</span> new_york</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Remember the order is X,Y</span></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>point1 <span class="op">=</span> QgsPointXY(lon1, lat1)</span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>point2 <span class="op">=</span> QgsPointXY(lon2, lat2)</span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>distance <span class="op">=</span> d.measureLine([point1, point2])</span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(distance<span class="op">/</span><span class="dv">1000</span>)</span></code></pre></div>
</div>
<div id="exercise-1" class="section level2">
<h2>Exercise 1</h2>
<p>Let’s say you want to make a stop at Las Vegas on the way from San Francisco to New York.</p>
<p>Calculate the total ellipsoidal distance considering a stop at Las Vegas.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>san_francisco <span class="op">=</span> (<span class="fl">37.7749</span>, <span class="op">-</span><span class="fl">122.4194</span>)</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>new_york <span class="op">=</span> (<span class="fl">40.661</span>, <span class="op">-</span><span class="fl">73.944</span>)</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>las_vegas <span class="op">=</span> (<span class="fl">36.1699</span>, <span class="op">-</span><span class="fl">115.1398</span>)</span></code></pre></div>
<p>If your code is correct, you should see the output distance to be <code>4271.02</code> kilometers.</p>
</div>
<div id="distance-conversion" class="section level2">
<h2>4.2 Distance Conversion</h2>
<p>The distance returned by the <code>measureLine()</code> method in the previous section was in meters, and we divided it by 1000 to convert it to kilometers. Rather than doing this conversion manually, we can use the PyQGIS API. The <code>QgsDistanceArea</code> class has a method <code>convertLengthMeasurement()</code> that can convert the measured distance to any supported unit. The <code>convertLengthMeasurement()</code> method takes 2 arguments - the length measured by <code>measureLine()</code> method and the unit to convert the measurement to. The unit should be a value of the type <code>QgsUnitTypes.DistanceUnit</code>. The permitted values are defined in the <a href="https://qgis.org/pyqgis/master/core/QgsUnitTypes.html#qgis.core.QgsUnitTypes.DistanceUnit">QgsUnitType documentation</a>. The code below shows how to convert the measured distance to Kilometers and Miles.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> qgis.core <span class="im">import</span> QgsDistanceArea</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> qgis.core <span class="im">import</span> QgsUnitTypes</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>san_francisco <span class="op">=</span> (<span class="fl">37.7749</span>, <span class="op">-</span><span class="fl">122.4194</span>)</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>new_york <span class="op">=</span> (<span class="fl">40.661</span>, <span class="op">-</span><span class="fl">73.944</span>)</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>d <span class="op">=</span> QgsDistanceArea()</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>d.setEllipsoid(<span class="st">&#39;WGS84&#39;</span>)</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>lat1, lon1 <span class="op">=</span> san_francisco</span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>lat2, lon2 <span class="op">=</span> new_york</span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Remember the order is X,Y</span></span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>point1 <span class="op">=</span> QgsPointXY(lon1, lat1)</span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>point2 <span class="op">=</span> QgsPointXY(lon2, lat2)</span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>distance <span class="op">=</span> d.measureLine([point1, point2])</span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&#39;Distance in meters&#39;</span>, distance)</span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a>distance_km <span class="op">=</span> d.convertLengthMeasurement(distance, QgsUnitTypes.DistanceKilometers)</span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&#39;Distance in kilometers&#39;</span>, distance_km)</span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a>distance_mi <span class="op">=</span> d.convertLengthMeasurement(distance, QgsUnitTypes.DistanceMiles)</span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&#39;Distance in miles&#39;</span>, distance_mi)</span></code></pre></div>
<p><img src="images/pyqgis/distance.png" width="75%" style="display: block; margin: auto;" /></p>
</div>
</div>
<div id="graphical-user-interface-gui-programming-basics" class="section level1">
<h1>5. Graphical User Interface (GUI) Programming Basics</h1>
<div id="qt-and-pyqt" class="section level2">
<h2>5.1 Qt and PyQt</h2>
<p><a href="https://www.qt.io/">Qt</a> is a free and open-source widget toolkit for creating graphical user interfaces as well as cross-platform applications. QGIS is built using the Qt platform. Both Qt and QGIS itself have well-documented APIs that should be used when writing Python code to be run within QGIS.</p>
<p><a href="https://wiki.python.org/moin/PyQt">PyQt</a> is the Python interface to Qt. PyQt provides classes and functions to interact with Qt widgets.</p>
</div>
<div id="building-a-dialog-box" class="section level2">
<h2>5.2 Building a Dialog Box</h2>
<p>Let’s learn how to use PyQt classes to create and interact with GUI elements. Here we will create a simple dialog box that prompts a user for confirmation. You can type the code in the <strong>Editor</strong> and click <strong>Run Script</strong>.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>mb <span class="op">=</span> QMessageBox()</span></code></pre></div>
<p>The <code>QMessageBox</code> is a PyQt class for creating a dialog with buttons. To use the class, you create object by <em>instantiating</em> the class. Here <code>mb</code> is an object, which is an instance of the <code>QMessageBox</code> class, created using the default parameters.</p>
<p><code>type()</code> tells you what is the class of the object</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="bu">type</span>(mb)</span></code></pre></div>
<p><code>dir</code> returns list of the attributes and methods of any object</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="bu">dir</span>(mb)</span></code></pre></div>
<p>Classes have methods that provide functionality. You can run the class methods on instance objects. For the <code>QMessageBox</code> class, <code>setText()</code> method will add a text to the dialog.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>mb <span class="op">=</span> QMessageBox()</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>mb.setText(<span class="st">&#39;Click OK to confirm&#39;</span>)</span></code></pre></div>
<p>Classes also have class attributes which are shared across all instances. The <code>QMessageBox</code> class has <code>Ok</code> and <code>Cancel</code> attributes, which can be referred using <code>QMessageBox.Ok</code> and <code>QMessageBox.Cancel</code>.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>mb <span class="op">=</span> QMessageBox()</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>mb.setText(<span class="st">&#39;Click OK to confirm&#39;</span>)</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>mb.setStandardButtons(QMessageBox.Ok <span class="op">|</span> QMessageBox.Cancel)</span></code></pre></div>
<p>To see the dialog, we need to use the <code>exec()</code> method. The user input is then captured and saved in the <code>return_value</code> variable.</p>
<p>The complete code snippet is as follows.Try it out and see the result of your action reflect in the Python Console.</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>mb <span class="op">=</span> QMessageBox()</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>mb.setText(<span class="st">&#39;Click OK to confirm&#39;</span>)</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>mb.setStandardButtons(QMessageBox.Ok <span class="op">|</span> QMessageBox.Cancel)</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>return_value <span class="op">=</span> mb.<span class="bu">exec</span>()</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> return_value <span class="op">==</span> QMessageBox.Ok:</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&#39;You pressed OK&#39;</span>)</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a><span class="cf">elif</span> return_value <span class="op">==</span> QMessageBox.Cancel:</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&#39;You pressed Cancel&#39;</span>)</span></code></pre></div>
<p><img src="images/pyqgis/messagebox.png" width="75%" style="display: block; margin: auto;" /></p>
</div>
</div>
<div id="deep-dive-into-pyqgis" class="section level1">
<h1>6. Deep Dive into PyQGIS</h1>
<p><a href="https://docs.qgis.org/testing/en/docs/pyqgis_developer_cookbook/">PyQGIS</a> is the Python interface to QGIS. It is created using SIP and integrates with PyQt.</p>
<blockquote>
<p><strong><em>Fun Fact:</em></strong> Most QGIS class names start with the prefix <em>Qgs</em>. <strong>Q</strong> is for Qt and <strong>gs</strong> stands for Gary Sherman - the founder of the QGIS project.</p>
</blockquote>
<p>QGIS C++ API documentation is available at <a href="https://qgis.org/api/" class="uri">https://qgis.org/api/</a></p>
<p>QGIS Python API documentation is available at <a href="https://qgis.org/pyqgis/3.0" class="uri">https://qgis.org/pyqgis/3.0</a></p>
<p>Both C++ and Python APIs are identical for most part, but certain functions are not available in the Python API. <a href="#fn1" class="footnote-ref" id="fnref1"><sup>1</sup></a></p>
<div id="qgis-interface-api-qgisinterface" class="section level2">
<h2>6.1 QGIS Interface API (QgisInterface)</h2>
<p>You are ready to dive into the PyQGIS API now. In this section, we will focus on the <code>QgisInterface</code> class - which provides methods for interaction with the QGIS environment. When QGIS is running, a variable called <code>iface</code> is set up to provide an object of the class <code>QgisInterface</code> to interact with the running QGIS environment. This interface allows access to the map canvas, menus, toolbars and other parts of the QGIS application. Python Console and Plugins can use <code>iface</code> to access various parts of the QGIS interface.</p>
<div id="change-title-of-qgis-main-window" class="section level3">
<h3>6.1.1 Change Title of QGIS Main Window</h3>
<div class="sourceCode" id="cb16"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>title <span class="op">=</span> iface.mainWindow().windowTitle()</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>new_title <span class="op">=</span> title.replace(<span class="st">&#39;QGIS&#39;</span>, <span class="st">&#39;My QGIS&#39;</span>)</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>iface.mainWindow().setWindowTitle(new_title)</span></code></pre></div>
</div>
<div id="change-icon-of-qgis-main-window" class="section level3">
<h3>6.1.2 Change Icon of QGIS Main Window</h3>
<blockquote>
<p><code>os.path.expanduser('~')</code> returns the path to the home directory of the user.</p>
</blockquote>
<div class="sourceCode" id="cb17"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>icon <span class="op">=</span> <span class="st">&#39;qgis-black.png&#39;</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>data_dir <span class="op">=</span> os.path.join(os.path.expanduser(<span class="st">&#39;~&#39;</span>), <span class="st">&#39;Downloads&#39;</span>, <span class="st">&#39;pyqgis_in_a_day&#39;</span>)</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>icon_path <span class="op">=</span> os.path.join(data_dir, icon)</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>icon <span class="op">=</span> QIcon(icon_path)</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>iface.mainWindow().setWindowIcon(icon)</span></code></pre></div>
<p><img src="images/pyqgis/mainwindow2.png" width="50%" style="display: block; margin: auto;" /></p>
</div>
<div id="remove-raster-and-vector-menus" class="section level3">
<h3>6.1.3 Remove Raster and Vector Menus</h3>
<div class="sourceCode" id="cb18"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>vector_menu <span class="op">=</span> iface.vectorMenu()</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>raster_menu <span class="op">=</span> iface.rasterMenu()</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>menubar <span class="op">=</span> vector_menu.parentWidget()</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>menubar.removeAction(vector_menu.menuAction())</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>menubar.removeAction(raster_menu.menuAction())</span></code></pre></div>
<p><img src="images/pyqgis/menu2.1.png" width="75%" style="display: block; margin: auto;" /></p>
<p><img src="images/pyqgis/menu2.2.png" width="75%" style="display: block; margin: auto;" /></p>
</div>
<div id="understanding-signals-and-slots" class="section level3">
<h3>6.1.4 Understanding Signals and Slots</h3>
<p>GUI programming requires responding to user’s actions. All objects in Qt have a mechanism where they can emit a signal when there is a change in status. i.e. when a user <em>clicks</em> a button, or a window is <em>closed</em>. As a programmer, you can connect the signal to a slot (i.e. a python function) which will be called when the signal is emitted. The general syntax for connecting the signal to a slot is as follows</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="bu">object</span>.signal.<span class="ex">connect</span>(function)</span></code></pre></div>
</div>
<div id="add-a-new-menu-item" class="section level3">
<h3>6.1.5 Add A New Menu Item</h3>
<p>A new button or menu item is created using <code>QAction()</code>. Here we create an action and then connect the <em>click</em> signal to a method that opens a website. <a href="#fn2" class="footnote-ref" id="fnref2"><sup>2</sup></a></p>
<div class="sourceCode" id="cb20"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> webbrowser</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> open_website():</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>    webbrowser.<span class="bu">open</span>(<span class="st">&#39;https://gis.stackexchange.com&#39;</span>)</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>website_action <span class="op">=</span> QAction(<span class="st">&#39;Go to gis.stackexchange&#39;</span>)</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>website_action.triggered.<span class="ex">connect</span>(open_website)</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>iface.helpMenu().addSeparator()</span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>iface.helpMenu().addAction(website_action)</span></code></pre></div>
<p><img src="images/pyqgis/menu3.png" width="50%" style="display: block; margin: auto;" /></p>
</div>
<div id="change-visibility-of-a-toolbar" class="section level3">
<h3>6.1.6 Change Visibility of a Toolbar</h3>
<div class="sourceCode" id="cb21"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>iface.pluginToolBar().setVisible(<span class="va">True</span>)</span></code></pre></div>
</div>
<div id="add-a-button-to-a-toolbar" class="section level3">
<h3>6.1.7 Add a button to a toolbar</h3>
<div class="sourceCode" id="cb22"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> datetime <span class="im">import</span> datetime</span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>icon <span class="op">=</span> <span class="st">&#39;question.svg&#39;</span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>data_dir <span class="op">=</span> os.path.join(os.path.expanduser(<span class="st">&#39;~&#39;</span>), <span class="st">&#39;Downloads&#39;</span>, <span class="st">&#39;pyqgis_in_a_day&#39;</span>)</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>icon_path <span class="op">=</span> os.path.join(data_dir, icon)</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> show_time():</span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>    now <span class="op">=</span> datetime.now()</span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a>    current_time <span class="op">=</span> now.strftime(<span class="st">&quot;%H:%M:%S&quot;</span>)</span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a>    iface.messageBar().pushInfo(<span class="st">&#39;Current Time&#39;</span>, current_time)</span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a>action <span class="op">=</span> QAction(<span class="st">&#39;Show Time&#39;</span>)</span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a>action.triggered.<span class="ex">connect</span>(show_time)</span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a>action.setIcon(QIcon(icon_path))</span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a>iface.addToolBarIcon(action)</span></code></pre></div>
<p><img src="images/pyqgis/toolbar2.png" width="75%" style="display: block; margin: auto;" /></p>
</div>
<div id="exercise-2" class="section level3">
<h3>Exercise 2</h3>
<p>In the previous example, the alert is displayed in the QGIS message bar as an <em>Info</em> message. Change the type of the message to a <em>Warning</em> message.</p>
<p>Hint: Look at the appropriate method in the <a href="https://qgis.org/pyqgis/3.0/gui/Message/QgsMessageBar.html">QgsMessageBar</a> class</p>
</div>
<div id="add-new-layers" class="section level3">
<h3>6.1.8 Add New Layers</h3>
<p><img src="images/pyqgis/addlayer.png" width="75%" style="display: block; margin: auto;" /></p>
<p>Data sources are identified by an URI (Uniform Resource Identifier) - For files on computer the URI is the file path - For databases, the URI is constructed using the <code>QgsDataSourceUri</code> class and encodes,the database path, table, username, password etc. - For web layers, such as WMF/WFS etc, the URI is the web URL</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>data_dir <span class="op">=</span> os.path.join(os.path.expanduser(<span class="st">&#39;~&#39;</span>), <span class="st">&#39;Downloads&#39;</span>, <span class="st">&#39;pyqgis_in_a_day&#39;</span>)</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>filename <span class="op">=</span> <span class="st">&#39;seismic_zones.shp&#39;</span></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>uri <span class="op">=</span> os.path.join(data_dir, filename)</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>iface.addVectorLayer(uri, <span class="st">&#39;seismic_zones&#39;</span>, <span class="st">&#39;ogr&#39;</span>)</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>filename <span class="op">=</span> <span class="st">&#39;sf.gpkg|layername=zoning&#39;</span></span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>uri <span class="op">=</span> os.path.join(data_dir, filename)</span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>iface.addVectorLayer(uri, <span class="st">&#39;zoning&#39;</span>, <span class="st">&#39;ogr&#39;</span>)</span></code></pre></div>
<p><img src="images/pyqgis/vectorlayer.png" width="50%" style="display: block; margin: auto;" /></p>
</div>
<div id="change-name-of-a-layer" class="section level3">
<h3>6.1.9 Change name of a Layer</h3>
<div class="sourceCode" id="cb24"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>layer <span class="op">=</span> iface.activeLayer()</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>name <span class="op">=</span> layer.name()</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>layer.setName(<span class="st">&#39;sf_&#39;</span> <span class="op">+</span> name)</span></code></pre></div>
</div>
</div>
<div id="qgis-project-api-qgsproject" class="section level2">
<h2>6.2 QGIS Project API (QgsProject)</h2>
<p>Another very important QGIS class is <code>QgsProject</code>. This class is used for all operations in a QGIS project - including adding/removing map layers, styling, print layouts etc. The <code>QgsProject</code> is a <strong>Singleton Class</strong> - meaning it can have only 1 instance at a time. The instance refers to the current QGIS project that is loaded. When QGIS starts, a blank project is created. When you load another project, the existing project is closed and a new project instance is created. You can get the current instance of the QgsProject class by calling the <strong><code>QgsProject.instance()</code></strong> method.</p>
<div id="load-a-project" class="section level3">
<h3>6.2.1 Load a project</h3>
<div class="sourceCode" id="cb25"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>data_dir <span class="op">=</span> os.path.join(os.path.expanduser(<span class="st">&#39;~&#39;</span>), <span class="st">&#39;Downloads&#39;</span>, <span class="st">&#39;pyqgis_in_a_day&#39;</span>)</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>project <span class="op">=</span> QgsProject.instance()</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>project_name <span class="op">=</span> <span class="st">&#39;sf.qgz&#39;</span></span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>project_path <span class="op">=</span> os.path.join(data_dir, project_name)</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>project.read(project_path)</span></code></pre></div>
<p><img src="images/pyqgis/project.png" width="75%" style="display: block; margin: auto;" /></p>
</div>
<div id="search-for-a-layer" class="section level3">
<h3>6.2.2 Search for a layer</h3>
<div class="sourceCode" id="cb26"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>blocks <span class="op">=</span> QgsProject.instance().mapLayersByName(<span class="st">&#39;blocks&#39;</span>)[<span class="dv">0</span>]</span></code></pre></div>
</div>
<div id="turn-a-layer-onoff" class="section level3">
<h3>6.2.3 Turn a layer on/off</h3>
<div class="sourceCode" id="cb27"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>QgsProject.instance().layerTreeRoot().findLayer(blocks.<span class="bu">id</span>()).setItemVisibilityChecked(<span class="va">True</span>)</span></code></pre></div>
</div>
<div id="exercise-3" class="section level3">
<h3>Exercise 3</h3>
<p>Write a code snippet that checks the active layer selected by the user. If the active layer is named <code>zoning</code>, display a success message in the message bar, else display an error message.</p>
<p><img src="images/pyqgis/success.png" width="75%" style="display: block; margin: auto;" /> <img src="images/pyqgis/error.png" width="75%" style="display: block; margin: auto;" /></p>
</div>
</div>
</div>
<div id="running-python-code-at-qgis-launch" class="section level1">
<h1>7. Running Python Code at QGIS Launch</h1>
<p>It is possible to execute some PyQGIS code every time QGIS starts. QGIS looks for a file named <code>startup.py</code> in the user’s Python home directory, and if it is found, executes it. This file is very useful in customizing QGIS interface with techniques learnt in the previous section.</p>
<p>If you are running multiple versions of QGIS, a very useful customization is to display the QGIS version number and name in the main window. The version name is stored in a global QGIS variable called <code>qgis_version</code>. We can read that variable and set the main window’s title with it. We connect this code to the signal <code>iface.initializationCompleted</code> signal when the main window is loaded.</p>
<p>Create a new file named <code>startup.py</code> with the following code. Note the imports at the top - including <code>iface</code>. When we ran the code snippets in the Python Console, we did not have to import any modules since they are done automatically when the console starts. For pyqgis scripts elsewhere, we have to explicitly import the modules (classes) that we want to use.</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> qgis.utils <span class="im">import</span> iface</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> qgis.core <span class="im">import</span> QgsExpressionContextUtils</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> customize():</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>    version <span class="op">=</span> QgsExpressionContextUtils.globalScope().variable(<span class="st">&#39;qgis_version&#39;</span>)</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>    title <span class="op">=</span> iface.mainWindow().windowTitle()</span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>    iface.mainWindow().setWindowTitle(<span class="st">&#39;</span><span class="sc">{}</span><span class="st"> | </span><span class="sc">{}</span><span class="st">&#39;</span>.<span class="bu">format</span>(title,version))</span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a>iface.initializationCompleted.<span class="ex">connect</span>(customize)</span></code></pre></div>
<p>This file needs to be copied to the appropriate directory on your system. See <a href="https://docs.qgis.org/testing/en/docs/pyqgis_developer_cookbook/intro.html#running-python-code-when-qgis-starts">QGIS documentation</a> for details on the path for your platform.</p>
<p><img src="images/pyqgis/startup.png" width="75%" style="display: block; margin: auto;" /></p>
<p>Once you copy the file at that location, restart QGIS. The title bar should now have the QGIS version name in it.</p>
<p><img src="images/pyqgis/customtitle.png" width="75%" style="display: block; margin: auto;" /></p>
<div id="exercise-4" class="section level2">
<h2>Exercise 4</h2>
<p>Trying opening a new project in QGIS after you have restarted GIS with <code>startup.py</code> file in place. You will notice that the custom title with the version name is replaced with the default title.</p>
<p>Make a change to your <code>startup.py</code> so that the customization is applied even when a new project is loaded.</p>
</div>
</div>
<div id="creating-custom-python-actions" class="section level1">
<h1>8. Creating Custom Python Actions</h1>
<p><a href="https://docs.qgis.org/testing/en/docs/user_manual/working_with_vector/vector_properties.html#actions-properties">Actions</a> in QGIS provide a quick and easy way to trigger custom behavior in response to a user’s action - such as click on a feature in the canvas or an attribute value in the attribute table.</p>
<p>Actions provide an easy way to add custom behavior to QGIS without having to write plugins. Actions are integrated into the QGIS GUI and allow you to execute PyQGIS code on vector layers.</p>
<p>Actions are defined at the layer level. We will define an action for the <code>parcels</code> layer so when a user clicks on a parcel, all parcels that belong to the same block will be selected. The parcel layer has an attribute <strong>block_num</strong> that refers to the block that parcel belongs to.</p>
<p>Load the <code>sf.qgz</code> project from your data package. Right-click the <code>parcels</code> layer, click <em>Properties</em> and switch to the <em>Actions</em> tab. Click <em>Add a new action</em> button. Select <strong>Python</strong> as the <em>Type</em>. Name the action as <strong>Select all parcels from the same block</strong>. This action is meant to be used for selecting features on the map canvas, so check the <strong>Canvas</strong> as the <em>Action Scope</em>. Enter the following code snippet in the <em>Action Text</em> and click <em>OK</em>. <a href="#fn3" class="footnote-ref" id="fnref3"><sup>3</sup></a></p>
<p><img src="images/pyqgis/action1.png" width="75%" style="display: block; margin: auto;" /></p>
<div class="sourceCode" id="cb29"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>layer <span class="op">=</span> QgsProject.instance().mapLayer(<span class="st">&#39;[% @layer_id %]&#39;</span>)</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>layer.selectByExpression(<span class="st">&#39;&quot;block_num&quot;=</span><span class="ch">\&#39;</span><span class="st">[% block_num %]</span><span class="ch">\&#39;</span><span class="st">&#39;</span>)</span></code></pre></div>
<p>Back in the main QGIS window, enable the <code>parcels</code> layer. Click the <em>Run feature action</em> button from the <em>Attributes Toolbar</em> and select <strong>Select all parcels from the same block</strong>. With the action enabled, click on any parcel and you will see all parcels from the block get selected.</p>
<p><img src="images/pyqgis/action2.png" width="75%" style="display: block; margin: auto;" /></p>
<div id="actions-deep-dive" class="section level2">
<h2>8.1 Actions Deep Dive</h2>
</div>
</div>
<div id="learn-more" class="section level1">
<h1>Learn more</h1>
<p>Learn about actions in the following video where I explain some powerful use cases.</p>
<p><a href="https://www.youtube.com/watch?v=8rOe-9A84O8" target="_blank"><img src="images/pyqgis/actions_deep_dive.png" style="width:70.0%" alt="Video" /></a></p>
<p><a href="https://docs.google.com/presentation/d/12J5XaJ8vVNvx8AfYywAk76rrxBxgn8Qyht6ouyB2_Yg/edit?usp=sharing" target="_blank">View the Presentation ↗</a></p>
</div>
<div id="running-processing-algorithms" class="section level1">
<h1>9. Running Processing Algorithms</h1>
<p>While the PyQGIS API providers many functions to work with layers, features, attributes and geometry - it is a much better practice to use the built-in processing algorithms to alter the layers or do any analysis. This will give you better performance and result in much lesser code. Here are some examples on how to use processing algorithms from Python to do vector and raster layer editing. You will find more information about various options and techniques in the article <a href="https://docs.qgis.org/testing/en/docs/user_manual/processing/console.html">Using processing algorithms from the console</a> of the QGIS User Guide</p>
<p><img src="images/pyqgis/processing.png" width="75%" style="display: block; margin: auto;" /></p>
<div id="creating-hillshade-from-a-dem" class="section level2">
<h2>9.1 Creating Hillshade from a DEM</h2>
<p>To use any Processing Algorithm via Python, you need to know how to specify all the required parameters. This is easiest to obtain by running the algorithm via the GUI first.</p>
<p>In this section we will learn how to create a hillshade raster from a DEM. We will first carry out the task using QGIS.</p>
<ol style="list-style-type: decimal">
<li>Browse to the data directory and load the <code>srtm.tif</code> layer. Search and locate the <strong>Processing Toolbox → Raster terrain analysis → Hillshade</strong> algorithm from the <em>Processing Toolbox</em>. Double-click to open it.</li>
</ol>
<p><img src="images/pyqgis/processing1.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="2" style="list-style-type: decimal">
<li>Select <code>srtm</code> as the <em>Elevation layer</em> and keep all the other parameters to their default value. Click <em>Run</em>.</li>
</ol>
<p><img src="images/pyqgis/processing2.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="3" style="list-style-type: decimal">
<li>A new <code>Hillshade</code> layer will be added to the <em>Layers</em> panel. Now we will locate the Python command for this operation from the <em>Processing History</em>. Go to **Processing → History*.</li>
</ol>
<p><img src="images/pyqgis/processing3.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="4" style="list-style-type: decimal">
<li>The first entry in the top panel will show the last algorithm that was ran from the toolbox. Click on it to select it. The full Python command will be shown at the bottom. Copy it.</li>
</ol>
<p><img src="images/pyqgis/processing4.png" width="75%" style="display: block; margin: auto;" /></p>
<p>You can now use the parameters in your Python code and replace the path of the input. Below is the code snippet that runs the same algorithm from a Python script. Note that we are using the <code>processing.runAndLoadResults()</code> method that adds the resulting layer to the canvas.</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>data_dir <span class="op">=</span> os.path.join(os.path.expanduser(<span class="st">&#39;~&#39;</span>), <span class="st">&#39;Downloads&#39;</span>, <span class="st">&#39;pyqgis_in_a_day&#39;</span>)</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>filename <span class="op">=</span> <span class="st">&#39;srtm.tif&#39;</span></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>srtm <span class="op">=</span> os.path.join(data_dir, filename)</span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>iface.addRasterLayer(srtm, <span class="st">&#39;srtm&#39;</span>, <span class="st">&#39;gdal&#39;</span>)</span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>results <span class="op">=</span> processing.runAndLoadResults(<span class="st">&quot;native:hillshade&quot;</span>, </span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>    {<span class="st">&#39;INPUT&#39;</span>: srtm, </span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;Z_FACTOR&#39;</span>:<span class="dv">2</span>,</span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;AZIMUTH&#39;</span>:<span class="dv">300</span>,</span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;V_ANGLE&#39;</span>:<span class="dv">40</span>,</span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;OUTPUT&#39;</span>: <span class="st">&#39;TEMPORARY_OUTPUT&#39;</span>})</span></code></pre></div>
</div>
<div id="running-multiple-processing-algorithms" class="section level2">
<h2>9.2 Running Multiple Processing Algorithms</h2>
<p>We can also <em>chain</em> multiple processing tools to build a script to build a data processing pipeline. In the example below, we will do 2 steps</p>
<ol style="list-style-type: decimal">
<li>Clip <code>srtm.tif</code> raster using the <code>shoreline.shp</code> layer.</li>
<li>Calculate the hillshade on the clipped raster and load it in QGIS.</li>
</ol>
<p>Note that we are using the <code>processing.run()</code> method for the first step. This method calculates the output, but does not load the result to QGIS. This allows us to carry out multiple processing steps and not load intermediate layers.</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>data_dir <span class="op">=</span> os.path.join(os.path.expanduser(<span class="st">&#39;~&#39;</span>), <span class="st">&#39;Downloads&#39;</span>, <span class="st">&#39;pyqgis_in_a_day&#39;</span>)</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>filename <span class="op">=</span> <span class="st">&#39;srtm.tif&#39;</span></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>srtm <span class="op">=</span> os.path.join(data_dir, filename)</span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>filename <span class="op">=</span> <span class="st">&#39;shoreline.shp&#39;</span></span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>shoreline <span class="op">=</span> os.path.join(data_dir, filename) </span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a>results <span class="op">=</span> processing.run(<span class="st">&quot;gdal:cliprasterbymasklayer&quot;</span>, </span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a>    {<span class="st">&#39;INPUT&#39;</span>:srtm,</span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;MASK&#39;</span>: shoreline,</span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;OUTPUT&#39;</span>:<span class="st">&#39;TEMPORARY_OUTPUT&#39;</span>})</span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-14"><a href="#cb31-14" aria-hidden="true" tabindex="-1"></a>clipped_dem <span class="op">=</span> results[<span class="st">&#39;OUTPUT&#39;</span>]</span>
<span id="cb31-15"><a href="#cb31-15" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb31-16"><a href="#cb31-16" aria-hidden="true" tabindex="-1"></a>results <span class="op">=</span> processing.runAndLoadResults(<span class="st">&quot;native:hillshade&quot;</span>, </span>
<span id="cb31-17"><a href="#cb31-17" aria-hidden="true" tabindex="-1"></a>    {<span class="st">&#39;INPUT&#39;</span>: clipped_dem, </span>
<span id="cb31-18"><a href="#cb31-18" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;Z_FACTOR&#39;</span>:<span class="dv">2</span>,</span>
<span id="cb31-19"><a href="#cb31-19" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;AZIMUTH&#39;</span>:<span class="dv">300</span>,</span>
<span id="cb31-20"><a href="#cb31-20" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;V_ANGLE&#39;</span>:<span class="dv">40</span>,</span>
<span id="cb31-21"><a href="#cb31-21" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;OUTPUT&#39;</span>: <span class="st">&#39;TEMPORARY_OUTPUT&#39;</span>})</span></code></pre></div>
<p>You can also do batch-processing by iterating through multiple layers and running the processing algorithm in a for-loop. Doing it via Python allows you greater flexibility - such as combining the results into a single layer. See <a href="https://www.qgistutorials.com/en/docs/3/processing_algorithms_pyqgis.html" target="_blank">Running Processing Algorithms via Python</a> tutorial for a complete example.</p>
</div>
<div id="exercise-5" class="section level2">
<h2>Exercise 5</h2>
<p>Let’s say we want to find the elevation of the highest point in San Francisco. We can use the DEM and QGIS Processing Algorithms to get the answer. Use the <code>qgis:rasterlayerstatistics</code> algorithm to calculate statistics on the clipped DEM and print the answer.</p>
<p>Hint: The result of the <code>qgis:rasterlayerstatistics</code> algorithm is a dictionary. Printthe result to see iit and extract relevant value.</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>data_dir <span class="op">=</span> os.path.join(os.path.expanduser(<span class="st">&#39;~&#39;</span>), <span class="st">&#39;Downloads&#39;</span>, <span class="st">&#39;pyqgis_in_a_day&#39;</span>)</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>filename <span class="op">=</span> <span class="st">&#39;srtm.tif&#39;</span></span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>srtm <span class="op">=</span> os.path.join(data_dir, filename)</span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>filename <span class="op">=</span> <span class="st">&#39;shoreline.shp&#39;</span></span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>shoreline <span class="op">=</span> os.path.join(data_dir, filename)</span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a>results <span class="op">=</span> processing.run(<span class="st">&quot;gdal:cliprasterbymasklayer&quot;</span>, </span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a>    {<span class="st">&#39;INPUT&#39;</span>:srtm,</span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;MASK&#39;</span>: shoreline,</span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;OUTPUT&#39;</span>:<span class="st">&#39;TEMPORARY_OUTPUT&#39;</span>})</span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a>clipped_dem <span class="op">=</span> results[<span class="st">&#39;OUTPUT&#39;</span>]</span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-16"><a href="#cb32-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Use the qgis:rasterlayerstatistics algorithm on clipped_dem</span></span></code></pre></div>
</div>
</div>
<div id="advanced-python-concepts" class="section level1">
<h1>10. Advanced Python Concepts</h1>
<div id="understanding-python-iterators" class="section level2">
<h2>10.1 Understanding Python Iterators</h2>
<p>An <em>Iterator</em> is a type of Python object that contains items that can be iterator upon. They are similar to other objects, like <em>lists</em> - but with a key difference. When you create an iterator, you don’t store all the items in memory. The iterator loads a single item at a time and then fetches the next item when asked for it. This makes it very efficient for reading large amounts of data without having to read the entire dataset. QGIS implements iterators for many different object types.</p>
<p>We will continue to work with the <code>sf.qgz</code> project. Open the project and select the <code>blocks</code> layer. In the example below, the result of calling <code>layer.getFeatures()</code> is an iterator. You can call the <code>next()</code> function to fetch the next item from the iterator.</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>layer <span class="op">=</span> iface.activeLayer()</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>features <span class="op">=</span> layer.getFeatures()</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>f <span class="op">=</span> <span class="bu">next</span>(features)</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(f.attributes())</span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>f <span class="op">=</span> <span class="bu">next</span>(features)</span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(f.attributes())</span></code></pre></div>
<p>You can also use for-loops to iterate through an iterator. Here we look up the <em>Feature ID</em> of each feature using the <code>id()</code> method and store it in a list.</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>layer <span class="op">=</span> iface.activeLayer()</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>features <span class="op">=</span> layer.getFeatures()</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>ids <span class="op">=</span> []</span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> f <span class="kw">in</span> features:</span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>  <span class="bu">id</span> <span class="op">=</span> f.<span class="bu">id</span>()</span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>  ids.append(<span class="bu">id</span>)</span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(ids)</span></code></pre></div>
</div>
<div id="list-compresensions" class="section level2">
<h2>10.2 List Compresensions</h2>
<p>A common data processing task in Python is to read items from a list or an iterator, doing some processing on each item and creating a new list with the results. The regular way to do this is to first create an empty list, iterate over each item of the existing list, and append the results to the new empty list. Python provides a powerful alternative to this workflow in the form of <em>List Comprehension</em>. The snippet below shows the syntax.</p>
<div class="sourceCode" id="cb35"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>my_list <span class="op">=</span> [<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">4</span>, <span class="dv">5</span>]</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a new list by adding 1 to each element</span></span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>new_list <span class="op">=</span> []</span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> x <span class="kw">in</span> my_list:</span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>    new_list.append(x<span class="op">+</span><span class="dv">1</span>)</span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(new_list)</span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Use list comprehension syntax</span></span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true" tabindex="-1"></a>new_list <span class="op">=</span> [x<span class="op">+</span><span class="dv">1</span> <span class="cf">for</span> x <span class="kw">in</span> my_list]</span>
<span id="cb35-13"><a href="#cb35-13" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(new_list)</span></code></pre></div>
</div>
</div>
<div id="writing-python-console-scripts" class="section level1">
<h1>11. Writing Python Console Scripts</h1>
<p>We will now see how can we write python scripts, save them and run them within QGIS. We will also see examples of best practices - such as validating inputs, writing files safely and communicating the status to the user.</p>
<p>A goal of the script is to read the features of a selected vector layer, and write its attributes to a CSV file.</p>
<p>Open the Python Console and click the <em>Show Editor</em> button. Copy/paste the following code. Click the <em>Save</em> button and save the file as <code>save_attributes_console.py</code>. The file can be saved anywhere.</p>
<p><img src="images/pyqgis/consolescript.png" width="75%" style="display: block; margin: auto;" /></p>
<div class="sourceCode" id="cb36"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>data_dir <span class="op">=</span> os.path.join(os.path.expanduser(<span class="st">&#39;~&#39;</span>), <span class="st">&#39;Downloads/pyqgis_in_a_day/&#39;</span>)</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>output_name <span class="op">=</span> <span class="st">&#39;output.csv&#39;</span></span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>output_path <span class="op">=</span> os.path.join(data_dir, output_name)</span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>layer <span class="op">=</span> iface.activeLayer()</span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Check if a layer is selected</span></span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> layer:</span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a>    iface.messageBar().pushMessage(<span class="st">&#39;Please select a layer&#39;</span>,  level<span class="op">=</span>Qgis.Critical) </span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Check if the selected layer is a vector layer</span></span>
<span id="cb36-12"><a href="#cb36-12" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> layer.<span class="bu">type</span>() <span class="op">!=</span> QgsMapLayer.VectorLayer:</span>
<span id="cb36-13"><a href="#cb36-13" aria-hidden="true" tabindex="-1"></a>    iface.messageBar().pushMessage(<span class="st">&#39;Please select a vector layer&#39;</span>,  level<span class="op">=</span>Qgis.Critical)</span>
<span id="cb36-14"><a href="#cb36-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb36-15"><a href="#cb36-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Using*with* statement which takes care of closing the files and handling errors</span></span>
<span id="cb36-16"><a href="#cb36-16" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(output_path, <span class="st">&#39;w&#39;</span>) <span class="im">as</span> output_file:</span>
<span id="cb36-17"><a href="#cb36-17" aria-hidden="true" tabindex="-1"></a>    fieldnames <span class="op">=</span> [field.name() <span class="cf">for</span> field <span class="kw">in</span> layer.fields()]</span>
<span id="cb36-18"><a href="#cb36-18" aria-hidden="true" tabindex="-1"></a>    <span class="co">## write header</span></span>
<span id="cb36-19"><a href="#cb36-19" aria-hidden="true" tabindex="-1"></a>    line <span class="op">=</span> <span class="st">&#39;,&#39;</span>.join(name <span class="cf">for</span> name <span class="kw">in</span> fieldnames) <span class="op">+</span> <span class="st">&#39;</span><span class="ch">\n</span><span class="st">&#39;</span></span>
<span id="cb36-20"><a href="#cb36-20" aria-hidden="true" tabindex="-1"></a>    output_file.write(line)</span>
<span id="cb36-21"><a href="#cb36-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># write feature attributes</span></span>
<span id="cb36-22"><a href="#cb36-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> f <span class="kw">in</span> layer.getFeatures():</span>
<span id="cb36-23"><a href="#cb36-23" aria-hidden="true" tabindex="-1"></a>        line <span class="op">=</span> <span class="st">&#39;,&#39;</span>.join(<span class="bu">str</span>(f[name]) <span class="cf">for</span> name <span class="kw">in</span> fieldnames) <span class="op">+</span> <span class="st">&#39;</span><span class="ch">\n</span><span class="st">&#39;</span></span>
<span id="cb36-24"><a href="#cb36-24" aria-hidden="true" tabindex="-1"></a>        output_file.write(line)</span>
<span id="cb36-25"><a href="#cb36-25" aria-hidden="true" tabindex="-1"></a>iface.messageBar().pushMessage(</span>
<span id="cb36-26"><a href="#cb36-26" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;Success:&#39;</span>, <span class="st">&#39;Output file written at &#39;</span> <span class="op">+</span> output_path, level<span class="op">=</span>Qgis.Success)</span></code></pre></div>
<p>Select the <code>blocks</code> layer and run this script by clicking the <em>Run Script</em> button. The script will process the layer and write the file at the given location.</p>
<p><img src="images/pyqgis/consolescriptrun.png" width="75%" style="display: block; margin: auto;" /></p>
</div>
<div id="writing-standalone-python-scripts" class="section level1">
<h1>12. Writing Standalone Python Scripts</h1>
<p>Having the python script run within QGIS is useful and desired most of the time. But there is a way to write python scripts that run on your system without QGIS being open. Let’s convert the script from the previous section to a standalone pyqgis script.</p>
<p>Create a new file with the code below and save it as <code>save_attributes_standalone.py</code>.</p>
<div class="sourceCode" id="cb37"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> qgis.core <span class="im">import</span> QgsApplication, QgsVectorLayer, QgsProject</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>qgs <span class="op">=</span> QgsApplication([], <span class="va">False</span>)</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>qgs.initQgis()</span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>data_dir <span class="op">=</span> os.path.join(os.path.expanduser(<span class="st">&#39;~&#39;</span>), <span class="st">&#39;Downloads/pyqgis_in_a_day/&#39;</span>)</span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a>filename <span class="op">=</span> <span class="st">&#39;sf.gpkg|layername=zoning&#39;</span></span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a>uri <span class="op">=</span> os.path.join(data_dir, filename)</span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a>layer <span class="op">=</span> QgsVectorLayer(uri, <span class="st">&#39;zoning&#39;</span>, <span class="st">&#39;ogr&#39;</span>)</span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a>output_name <span class="op">=</span> <span class="st">&#39;output.csv&#39;</span></span>
<span id="cb37-13"><a href="#cb37-13" aria-hidden="true" tabindex="-1"></a>output_path <span class="op">=</span> os.path.join(data_dir, output_name)</span>
<span id="cb37-14"><a href="#cb37-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb37-15"><a href="#cb37-15" aria-hidden="true" tabindex="-1"></a><span class="cf">with</span> <span class="bu">open</span>(output_path, <span class="st">&#39;w&#39;</span>) <span class="im">as</span> output_file:</span>
<span id="cb37-16"><a href="#cb37-16" aria-hidden="true" tabindex="-1"></a>    fieldnames <span class="op">=</span> [field.name() <span class="cf">for</span> field <span class="kw">in</span> layer.fields()]</span>
<span id="cb37-17"><a href="#cb37-17" aria-hidden="true" tabindex="-1"></a>    line <span class="op">=</span> <span class="st">&#39;,&#39;</span>.join(name <span class="cf">for</span> name <span class="kw">in</span> fieldnames) <span class="op">+</span> <span class="st">&#39;</span><span class="ch">\n</span><span class="st">&#39;</span></span>
<span id="cb37-18"><a href="#cb37-18" aria-hidden="true" tabindex="-1"></a>    output_file.write(line)</span>
<span id="cb37-19"><a href="#cb37-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> f <span class="kw">in</span> layer.getFeatures():</span>
<span id="cb37-20"><a href="#cb37-20" aria-hidden="true" tabindex="-1"></a>        line <span class="op">=</span> <span class="st">&#39;,&#39;</span>.join(<span class="bu">str</span>(f[name]) <span class="cf">for</span> name <span class="kw">in</span> fieldnames) <span class="op">+</span> <span class="st">&#39;</span><span class="ch">\n</span><span class="st">&#39;</span></span>
<span id="cb37-21"><a href="#cb37-21" aria-hidden="true" tabindex="-1"></a>        output_file.write(line)</span>
<span id="cb37-22"><a href="#cb37-22" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb37-23"><a href="#cb37-23" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&#39;Success: &#39;</span>, <span class="st">&#39;Output file written at&#39;</span> <span class="op">+</span> output_path)</span>
<span id="cb37-24"><a href="#cb37-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-25"><a href="#cb37-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Delete the layer object from memory</span></span>
<span id="cb37-26"><a href="#cb37-26" aria-hidden="true" tabindex="-1"></a><span class="co"># Without this you may get a Segmentation Fault on exit</span></span>
<span id="cb37-27"><a href="#cb37-27" aria-hidden="true" tabindex="-1"></a><span class="co"># when the exitQgis() method will try clearning the layer registry</span></span>
<span id="cb37-28"><a href="#cb37-28" aria-hidden="true" tabindex="-1"></a><span class="co"># Alternatively, you can add the layer so it is present in the registry</span></span>
<span id="cb37-29"><a href="#cb37-29" aria-hidden="true" tabindex="-1"></a><span class="co"># QgsProject.instance().addMapLayer(layer, False)</span></span>
<span id="cb37-30"><a href="#cb37-30" aria-hidden="true" tabindex="-1"></a><span class="kw">del</span>(layer)</span>
<span id="cb37-31"><a href="#cb37-31" aria-hidden="true" tabindex="-1"></a>qgs.exitQgis()</span></code></pre></div>
<p>You will notice that the script is almost exactly the same, but with a few notable changes. First there is the import statement at the top, to explicitly import the required modules. Next, we create an instance of the <code>QgsApplication</code> class and run <code>initQis()</code> method to load the QGIS data providers and layer registry. Finally we call <code>exitQgis()</code> to remove them from memory. Here we don’t have a way to take user input, so we hard-code the path to the input layer. Also we don’t have the QGIS GUI, we have no way of displaying the messages, so we remove those statements.</p>
<p>When you run the script within QGIS environment, all the paths to QGIS libraries and environment variables are already set and python is able to find and use it. But when you run the script outside of QGIS, you need to set them yourself. The way to run the script depends on the platform.</p>
<blockquote>
<p>You may need to change these paths slightly based on where QGIS is installed. The following scripts assume you are running QGIS 3.16 LTR installed at the default location.</p>
</blockquote>
<div id="windows" class="section level2">
<h2>Windows</h2>
<p>On Windows, you can do this using a batch file. Create a new file named <code>run_script.bat</code> with the following code. Make sure to save it in the same directory.</p>
<div class="sourceCode" id="cb38"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="at">@echo</span> off </span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a><span class="bu">set</span> OSGEO4W_ROOT<span class="op">=</span>C:<span class="op">\</span>OSGeo4W64</span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>call <span class="st">&quot;%OSGEO4W_ROOT%</span><span class="ch">\b</span><span class="st">in\o4w_env.bat&quot;</span> </span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>call <span class="st">&quot;%OSGEO4W_ROOT%</span><span class="ch">\b</span><span class="st">in\qt5_env.bat&quot;</span> </span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a>call <span class="st">&quot;%OSGEO4W_ROOT%</span><span class="ch">\b</span><span class="st">in\py3_env.bat&quot;</span> </span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a><span class="bu">set</span> PATH<span class="op">=%</span>OSGEO4W_ROOT<span class="op">%\</span><span class="bu">bin</span><span class="op">;%</span>OSGEO4W_ROOT<span class="op">%\</span>apps<span class="op">\</span>qgis<span class="op">-</span>ltr<span class="op">\</span><span class="bu">bin</span><span class="op">;</span>C:<span class="op">\</span>OSGeo4W64<span class="op">\</span>apps<span class="op">\</span>Qt5<span class="op">\</span><span class="bu">bin</span><span class="op">;%</span>PATH<span class="op">%</span></span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a><span class="bu">set</span> PYTHONPATH<span class="op">=%</span>OSGEO4W_ROOT<span class="op">%\</span>apps<span class="op">\</span>qgis<span class="op">-</span>ltr<span class="op">\</span>python<span class="op">;%</span>PYTHONPATH<span class="op">%</span></span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a><span class="bu">set</span> QGIS_PREFIX_PATH<span class="op">=%</span>OSGEO4W_ROOT<span class="op">%\</span>apps<span class="op">\</span>qgis<span class="op">-</span>ltr</span>
<span id="cb38-12"><a href="#cb38-12" aria-hidden="true" tabindex="-1"></a><span class="bu">set</span> QT_QPA_PLATFORM_PLUGIN_PATH<span class="op">=%</span>OSGEO4W_ROOT<span class="op">%\</span>apps<span class="op">\</span>Qt5<span class="op">\</span>plugins</span>
<span id="cb38-13"><a href="#cb38-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-14"><a href="#cb38-14" aria-hidden="true" tabindex="-1"></a>python3 save_attributes_standalone.py</span></code></pre></div>
<p>Open the command prompt, browse to the directory with the above files, type <code>run_script.bat</code> and press Enter.</p>
<blockquote>
<p>You can also just double-click the <code>run_script.bat</code> to run it, but you will not see any error or success messages. So it is always a good idea to run the script from the shell.</p>
</blockquote>
<p>The script will run and produce the output at the given path.</p>
<p><img src="images/pyqgis/standalonescript.png" width="75%" style="display: block; margin: auto;" /></p>
</div>
<div id="macos" class="section level2">
<h2>MacOS</h2>
<p>On MacOS, you can set the required environment variables and run the script using a shell script. Create a file named <code>run_script.sh</code> and save it in the same directory as the script.</p>
<div class="sourceCode" id="cb39"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>OLD_PATH<span class="op">=</span>$PATH</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>OLD_PYTHONPATH<span class="op">=</span>$PYTHONPATH</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>QGIS_VERSION<span class="op">=</span><span class="st">&quot;QGIS-LTR&quot;</span></span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a>export PATH<span class="op">=/</span>Applications<span class="op">/</span>$QGIS_VERSION.app<span class="op">/</span>Contents<span class="op">/</span>MacOS<span class="op">/</span><span class="bu">bin</span>:$PATH</span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a>export PYTHONPATH<span class="op">=/</span>Applications<span class="op">/</span>$QGIS_VERSION.app<span class="op">/</span>Contents<span class="op">/</span>Resources<span class="op">/</span>python</span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a>export QGIS_PREFIX_PATH<span class="op">=/</span>Applications<span class="op">/</span>$QGIS_VERSION.app<span class="op">/</span>Contents<span class="op">/</span>MacOS</span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a>export QT_QPA_PLATFORM_PLUGIN_PATH<span class="op">=/</span>Applications<span class="op">/</span>$QGIS_VERSION.app<span class="op">/</span>Contents<span class="op">/</span>PlugIns<span class="op">/</span>platforms<span class="op">/</span></span>
<span id="cb39-10"><a href="#cb39-10" aria-hidden="true" tabindex="-1"></a>export DYLD_INSERT_LIBRARIES<span class="op">=/</span>Applications<span class="op">/</span>$QGIS_VERSION.app<span class="op">/</span>Contents<span class="op">/</span>MacOS<span class="op">/</span>lib<span class="op">/</span>libsqlite3.dylib</span>
<span id="cb39-11"><a href="#cb39-11" aria-hidden="true" tabindex="-1"></a>echo <span class="st">&quot;Using python3 from $(which python3)&quot;</span></span>
<span id="cb39-12"><a href="#cb39-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-13"><a href="#cb39-13" aria-hidden="true" tabindex="-1"></a>python3 save_attributes_standalone.py</span>
<span id="cb39-14"><a href="#cb39-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-15"><a href="#cb39-15" aria-hidden="true" tabindex="-1"></a><span class="co"># restore and clean up</span></span>
<span id="cb39-16"><a href="#cb39-16" aria-hidden="true" tabindex="-1"></a>export PATH<span class="op">=</span>$OLD_PATH</span>
<span id="cb39-17"><a href="#cb39-17" aria-hidden="true" tabindex="-1"></a>export PYTHONPATH<span class="op">=</span>$OLD_PYTHONPATH</span>
<span id="cb39-18"><a href="#cb39-18" aria-hidden="true" tabindex="-1"></a>unset QT_QPA_PLATFORM_PLUGIN_PATH</span>
<span id="cb39-19"><a href="#cb39-19" aria-hidden="true" tabindex="-1"></a>unset DYLD_INSERT_LIBRARIES</span></code></pre></div>
<p>Open a Terminal and browse to the directory with the script. Type <code>bash run_script.sh</code> and press enter. The script will run and produce the output at the given path.</p>
</div>
</div>
<div id="processing-scripts" class="section level1">
<h1>13. Processing Scripts</h1>
<p>We already saw 2 different ways to write a Python script in QGIS. But there is another way - and it is the preferred approach to write scripts. Whenever you are writing a new script, consider using the built-in <strong>Processing Framework</strong>. This has several advantages. First, taking user input and writing output files is far easier because Processing Framework offers standardized user interface for these. Second, having your script in the Processing Toolbox also allows it to be part of any Processing Model or be run as a Batch job with multiple inputs. This tutorial will show how to write a custom python script that can be part of the Processing Framework in QGIS.</p>
<p>We will now see how the Python Console script can be converted to a Processing script. But first, a word on Python Classes.</p>
<div id="writing-a-python-class" class="section level2">
<h2>13.1 Writing a Python Class</h2>
<p>We have sen how to use a class from PyQt or PyQGIS libraries. But we have not written a new class. To write a Processing Script, we must write a new class. A new class is defined using the word <code>class</code>. All classes have a function called<code>__init__()</code>, which is always executed when a new object is being created. There is also the keyword <code>self</code> which refers to the current instance of the class. Here’s the code to create a class called <code>Car</code> demonstrating the example we covered in the <a href="https://docs.google.com/presentation/d/1b4i1nEDR_uKJVu0IIqjoqrxeFD2a-tnj88JRXQW0JiA/edit?usp=sharing">Classes and Objects</a> presentation.</p>
<div class="sourceCode" id="cb40"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Car:</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>    model <span class="op">=</span> <span class="st">&#39;Civic&#39;</span></span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, color, <span class="bu">type</span>):</span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.color <span class="op">=</span> color</span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.<span class="bu">type</span> <span class="op">=</span> <span class="bu">type</span></span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.started <span class="op">=</span> <span class="va">False</span></span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.stopped <span class="op">=</span> <span class="va">False</span></span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb40-11"><a href="#cb40-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> start(<span class="va">self</span>):</span>
<span id="cb40-12"><a href="#cb40-12" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&#39;Car Started&#39;</span>)</span>
<span id="cb40-13"><a href="#cb40-13" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.started <span class="op">=</span> <span class="va">True</span></span>
<span id="cb40-14"><a href="#cb40-14" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.stopped <span class="op">=</span> <span class="va">False</span></span>
<span id="cb40-15"><a href="#cb40-15" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb40-16"><a href="#cb40-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> stop(<span class="va">self</span>):</span>
<span id="cb40-17"><a href="#cb40-17" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&#39;Car Stopped&#39;</span>)</span>
<span id="cb40-18"><a href="#cb40-18" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.stopped <span class="op">=</span> <span class="va">True</span></span>
<span id="cb40-19"><a href="#cb40-19" aria-hidden="true" tabindex="-1"></a>        sefl.started <span class="op">=</span> <span class="va">False</span></span>
<span id="cb40-20"><a href="#cb40-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-21"><a href="#cb40-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Instantiate the class      </span></span>
<span id="cb40-22"><a href="#cb40-22" aria-hidden="true" tabindex="-1"></a>my_car <span class="op">=</span> Car(<span class="st">&#39;blue&#39;</span>, <span class="st">&#39;automatic&#39;</span>)</span>
<span id="cb40-23"><a href="#cb40-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-24"><a href="#cb40-24" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(my_car)</span>
<span id="cb40-25"><a href="#cb40-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-26"><a href="#cb40-26" aria-hidden="true" tabindex="-1"></a><span class="co"># Call a method</span></span>
<span id="cb40-27"><a href="#cb40-27" aria-hidden="true" tabindex="-1"></a>my_car.start()</span>
<span id="cb40-28"><a href="#cb40-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-29"><a href="#cb40-29" aria-hidden="true" tabindex="-1"></a><span class="co"># Check the value of an instance variable</span></span>
<span id="cb40-30"><a href="#cb40-30" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&#39;Car Started?&#39;</span>, my_car.started)</span>
<span id="cb40-31"><a href="#cb40-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-32"><a href="#cb40-32" aria-hidden="true" tabindex="-1"></a><span class="co"># Check the value of a class variable</span></span>
<span id="cb40-33"><a href="#cb40-33" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&#39;Car model&#39;</span>, Car.model)</span></code></pre></div>
<p>As we saw, all PyQGIS and PyQt inherit from other classes. Let’s see them in action.</p>
</div>
<div id="writing-a-processing-script" class="section level2">
<h2>13.2 Writing a Processing Script</h2>
<p>To create a new processing script, go to <strong>Processing → Processing Toolbox</strong>. Click the <em>Scripts</em> button and select <em>Create New Script..</em>.</p>
<p><img src="images/pyqgis/processingscriptnew.png" width="75%" style="display: block; margin: auto;" /></p>
<p>Copy/paste the following code into the <em>Processing Script Editor</em>.</p>
<p><code>save_attributes_processing.py</code></p>
<div class="sourceCode" id="cb41"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> PyQt5.QtCore <span class="im">import</span> QCoreApplication</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> qgis.core <span class="im">import</span> (QgsProcessing,</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>                       QgsProcessingAlgorithm,</span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>                       QgsProcessingParameterFeatureSource,</span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>                       QgsProcessingParameterFileDestination)</span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> SaveAttributesAlgorithm(QgsProcessingAlgorithm):</span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;Saves the attributes of a vector layer to a CSV file.&quot;&quot;&quot;</span></span>
<span id="cb41-10"><a href="#cb41-10" aria-hidden="true" tabindex="-1"></a>    OUTPUT <span class="op">=</span> <span class="st">&#39;OUTPUT&#39;</span></span>
<span id="cb41-11"><a href="#cb41-11" aria-hidden="true" tabindex="-1"></a>    INPUT <span class="op">=</span> <span class="st">&#39;INPUT&#39;</span></span>
<span id="cb41-12"><a href="#cb41-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-13"><a href="#cb41-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> initAlgorithm(<span class="va">self</span>, config<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb41-14"><a href="#cb41-14" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.addParameter(</span>
<span id="cb41-15"><a href="#cb41-15" aria-hidden="true" tabindex="-1"></a>            QgsProcessingParameterFeatureSource(</span>
<span id="cb41-16"><a href="#cb41-16" aria-hidden="true" tabindex="-1"></a>                <span class="va">self</span>.INPUT,</span>
<span id="cb41-17"><a href="#cb41-17" aria-hidden="true" tabindex="-1"></a>                <span class="va">self</span>.tr(<span class="st">&#39;Input layer&#39;</span>),</span>
<span id="cb41-18"><a href="#cb41-18" aria-hidden="true" tabindex="-1"></a>                [QgsProcessing.TypeVectorAnyGeometry]</span>
<span id="cb41-19"><a href="#cb41-19" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb41-20"><a href="#cb41-20" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb41-21"><a href="#cb41-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-22"><a href="#cb41-22" aria-hidden="true" tabindex="-1"></a>        <span class="co"># We add a file output of type CSV.</span></span>
<span id="cb41-23"><a href="#cb41-23" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.addParameter(</span>
<span id="cb41-24"><a href="#cb41-24" aria-hidden="true" tabindex="-1"></a>            QgsProcessingParameterFileDestination(</span>
<span id="cb41-25"><a href="#cb41-25" aria-hidden="true" tabindex="-1"></a>                <span class="va">self</span>.OUTPUT,</span>
<span id="cb41-26"><a href="#cb41-26" aria-hidden="true" tabindex="-1"></a>                <span class="va">self</span>.tr(<span class="st">&#39;Output File&#39;</span>),</span>
<span id="cb41-27"><a href="#cb41-27" aria-hidden="true" tabindex="-1"></a>                <span class="st">&#39;CSV files (*.csv)&#39;</span>,</span>
<span id="cb41-28"><a href="#cb41-28" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb41-29"><a href="#cb41-29" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb41-30"><a href="#cb41-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-31"><a href="#cb41-31" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> processAlgorithm(<span class="va">self</span>, parameters, context, feedback):</span>
<span id="cb41-32"><a href="#cb41-32" aria-hidden="true" tabindex="-1"></a>        source <span class="op">=</span> <span class="va">self</span>.parameterAsSource(parameters, <span class="va">self</span>.INPUT, context)</span>
<span id="cb41-33"><a href="#cb41-33" aria-hidden="true" tabindex="-1"></a>        csv <span class="op">=</span> <span class="va">self</span>.parameterAsFileOutput(parameters, <span class="va">self</span>.OUTPUT, context)</span>
<span id="cb41-34"><a href="#cb41-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-35"><a href="#cb41-35" aria-hidden="true" tabindex="-1"></a>        fieldnames <span class="op">=</span> [field.name() <span class="cf">for</span> field <span class="kw">in</span> source.fields()]</span>
<span id="cb41-36"><a href="#cb41-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-37"><a href="#cb41-37" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Compute the number of steps to display within the progress bar and</span></span>
<span id="cb41-38"><a href="#cb41-38" aria-hidden="true" tabindex="-1"></a>        <span class="co"># get features from source</span></span>
<span id="cb41-39"><a href="#cb41-39" aria-hidden="true" tabindex="-1"></a>        total <span class="op">=</span> <span class="fl">100.0</span> <span class="op">/</span> source.featureCount() <span class="cf">if</span> source.featureCount() <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb41-40"><a href="#cb41-40" aria-hidden="true" tabindex="-1"></a>        features <span class="op">=</span> source.getFeatures()</span>
<span id="cb41-41"><a href="#cb41-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-42"><a href="#cb41-42" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> <span class="bu">open</span>(csv, <span class="st">&#39;w&#39;</span>) <span class="im">as</span> output_file:</span>
<span id="cb41-43"><a href="#cb41-43" aria-hidden="true" tabindex="-1"></a>          <span class="co"># write header</span></span>
<span id="cb41-44"><a href="#cb41-44" aria-hidden="true" tabindex="-1"></a>          line <span class="op">=</span> <span class="st">&#39;,&#39;</span>.join(name <span class="cf">for</span> name <span class="kw">in</span> fieldnames) <span class="op">+</span> <span class="st">&#39;</span><span class="ch">\n</span><span class="st">&#39;</span></span>
<span id="cb41-45"><a href="#cb41-45" aria-hidden="true" tabindex="-1"></a>          output_file.write(line)</span>
<span id="cb41-46"><a href="#cb41-46" aria-hidden="true" tabindex="-1"></a>          <span class="cf">for</span> current, f <span class="kw">in</span> <span class="bu">enumerate</span>(features):</span>
<span id="cb41-47"><a href="#cb41-47" aria-hidden="true" tabindex="-1"></a>              <span class="co"># Stop the algorithm if cancel button has been clicked</span></span>
<span id="cb41-48"><a href="#cb41-48" aria-hidden="true" tabindex="-1"></a>              <span class="cf">if</span> feedback.isCanceled():</span>
<span id="cb41-49"><a href="#cb41-49" aria-hidden="true" tabindex="-1"></a>                  <span class="cf">break</span></span>
<span id="cb41-50"><a href="#cb41-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-51"><a href="#cb41-51" aria-hidden="true" tabindex="-1"></a>              <span class="co"># Add a feature in the sink</span></span>
<span id="cb41-52"><a href="#cb41-52" aria-hidden="true" tabindex="-1"></a>              line <span class="op">=</span> <span class="st">&#39;,&#39;</span>.join(<span class="bu">str</span>(f[name]) <span class="cf">for</span> name <span class="kw">in</span> fieldnames) <span class="op">+</span> <span class="st">&#39;</span><span class="ch">\n</span><span class="st">&#39;</span></span>
<span id="cb41-53"><a href="#cb41-53" aria-hidden="true" tabindex="-1"></a>              output_file.write(line)</span>
<span id="cb41-54"><a href="#cb41-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-55"><a href="#cb41-55" aria-hidden="true" tabindex="-1"></a>              <span class="co"># Update the progress bar</span></span>
<span id="cb41-56"><a href="#cb41-56" aria-hidden="true" tabindex="-1"></a>              feedback.setProgress(<span class="bu">int</span>(current <span class="op">*</span> total))</span>
<span id="cb41-57"><a href="#cb41-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-58"><a href="#cb41-58" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> {<span class="va">self</span>.OUTPUT: csv}</span>
<span id="cb41-59"><a href="#cb41-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-60"><a href="#cb41-60" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> name(<span class="va">self</span>):</span>
<span id="cb41-61"><a href="#cb41-61" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">&#39;save_attributes&#39;</span></span>
<span id="cb41-62"><a href="#cb41-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-63"><a href="#cb41-63" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> displayName(<span class="va">self</span>):</span>
<span id="cb41-64"><a href="#cb41-64" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>.tr(<span class="st">&#39;Save Attributes As CSV&#39;</span>)</span>
<span id="cb41-65"><a href="#cb41-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-66"><a href="#cb41-66" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> group(<span class="va">self</span>):</span>
<span id="cb41-67"><a href="#cb41-67" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>.tr(<span class="va">self</span>.groupId())</span>
<span id="cb41-68"><a href="#cb41-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-69"><a href="#cb41-69" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> groupId(<span class="va">self</span>):</span>
<span id="cb41-70"><a href="#cb41-70" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">&#39;&#39;</span></span>
<span id="cb41-71"><a href="#cb41-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-72"><a href="#cb41-72" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> tr(<span class="va">self</span>, string):</span>
<span id="cb41-73"><a href="#cb41-73" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> QCoreApplication.translate(<span class="st">&#39;Processing&#39;</span>, string)</span>
<span id="cb41-74"><a href="#cb41-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-75"><a href="#cb41-75" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> createInstance(<span class="va">self</span>):</span>
<span id="cb41-76"><a href="#cb41-76" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> SaveAttributesAlgorithm()</span></code></pre></div>
<p><img src="images/pyqgis/processingscriptwrite.png" width="75%" style="display: block; margin: auto;" /></p>
<p>By now, you must be familiar with the code in the <code>processAlgorithm()</code> method. This method contains the main logic of the script that gets executed when the user clicks the <em>Run</em> button. Here we are creating a new class called <code>SaveAttributesAlgorithm</code>. As this is a processing script, we must inherit from the <code>QgsProcessingAlgorithm</code> class. The <code>initAlgorithm()</code> method is called to set-up the inputs and the outputs. There are other methods that set the algorithm name and group.</p>
<p>Click the <em>Save Script</em> button and save the script as <code>save_attributes_algorithm.py</code>. This script must be saved inside the <code>{profile foler}/processing/scripts/</code> directory so it can be loaded when QGIS starts.</p>
<p>Once saved, the algorithm will appear in the <em>Processing Toolbox</em> under <strong>Scripts → Save Attributes As CSV</strong>. Double-click to launch it. You will see the standard processing algorithm dialog where the user can select inputs and outputs easily. Progress bar is shown correctly and the execution also stops if the user presses the <em>Cancel</em> button. If the large is large and the algorithm would take time to process it, the user can also close the window and the algorithm will continue to run in the background.</p>
<p>You can review additional information and tips in the <a href="https://docs.qgis.org/3.16/en/docs/user_manual/processing/scripts.html">Writing new Processing algorithms as Python scripts</a> section of the QGIS User Guide.</p>
<p><img src="images/pyqgis/processingscriptrun.png" width="75%" style="display: block; margin: auto;" /></p>
</div>
<div id="simplifying-processing-scripts" class="section level2">
<h2>13.3 Simplifying Processing Scripts</h2>
<p>The Processing Framework providers a simpler way to write processing scripts by using the <code>@alg</code> decorator. Using this approach, you are able to remove a lot of <em>boilerplate</em> code and focus on just writing the main algorithm function. There are some limitations of this approach - the main one being that scripts written using the <code>@alg</code> decorator cannot be used in plugins. But if your goal is to create a processing scripts, this is a much simpler style.</p>
<blockquote>
<p>Note: the <code>@alg</code> decorator cannot be used in plugins. If you are writing processing algorithms for a plugin, use the full script template shown in the previous section.</p>
</blockquote>
<p>Let’s modify the <code>save_attributes_algorithm.py</code> script to use the built-in <code>@alg</code> decorator. Locate the script in <em>Processing Toolbox</em> under <strong>Scripts → Save Attributes As CSV</strong>. Right-click on it and select <em>Edit Script…</em>. Replace all the code in the <em>Processing Script Editor</em> with the following and click the <em>Save Script</em> button</p>
<div class="sourceCode" id="cb42"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> qgis.processing <span class="im">import</span> alg</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a><span class="at">@alg</span>(name<span class="op">=</span><span class="st">&#39;save_attributes&#39;</span>, label<span class="op">=</span><span class="st">&#39;Save Attributes As CSV&#39;</span>,</span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>    group<span class="op">=</span><span class="st">&#39;&#39;</span>, group_label<span class="op">=</span><span class="st">&#39;&#39;</span>)</span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a><span class="at">@alg.input</span>(<span class="bu">type</span><span class="op">=</span>alg.SOURCE, name<span class="op">=</span><span class="st">&#39;INPUT&#39;</span>, label<span class="op">=</span><span class="st">&#39;Input Layer&#39;</span>)</span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a><span class="at">@alg.input</span>(<span class="bu">type</span><span class="op">=</span>alg.FILE_DEST, name<span class="op">=</span><span class="st">&#39;OUTPUT&#39;</span>, label<span class="op">=</span><span class="st">&#39;Output File&#39;</span>)</span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> processAlgorithm(instance, parameters, context, feedback, inputs):</span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;Saves the attributes of a vector layer to a CSV file.&quot;&quot;&quot;</span></span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a>    source <span class="op">=</span> instance.parameterAsSource(parameters, <span class="st">&#39;INPUT&#39;</span>, context)</span>
<span id="cb42-10"><a href="#cb42-10" aria-hidden="true" tabindex="-1"></a>    csv <span class="op">=</span> instance.parameterAsFileOutput(parameters, <span class="st">&#39;OUTPUT&#39;</span>, context)</span>
<span id="cb42-11"><a href="#cb42-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-12"><a href="#cb42-12" aria-hidden="true" tabindex="-1"></a>    fieldnames <span class="op">=</span> [field.name() <span class="cf">for</span> field <span class="kw">in</span> source.fields()]</span>
<span id="cb42-13"><a href="#cb42-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-14"><a href="#cb42-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Compute the number of steps to display within the progress bar and</span></span>
<span id="cb42-15"><a href="#cb42-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># get features from source</span></span>
<span id="cb42-16"><a href="#cb42-16" aria-hidden="true" tabindex="-1"></a>    total <span class="op">=</span> <span class="fl">100.0</span> <span class="op">/</span> source.featureCount() <span class="cf">if</span> source.featureCount() <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb42-17"><a href="#cb42-17" aria-hidden="true" tabindex="-1"></a>    features <span class="op">=</span> source.getFeatures()</span>
<span id="cb42-18"><a href="#cb42-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-19"><a href="#cb42-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> <span class="bu">open</span>(csv, <span class="st">&#39;w&#39;</span>) <span class="im">as</span> output_file:</span>
<span id="cb42-20"><a href="#cb42-20" aria-hidden="true" tabindex="-1"></a>      <span class="co"># write header</span></span>
<span id="cb42-21"><a href="#cb42-21" aria-hidden="true" tabindex="-1"></a>      line <span class="op">=</span> <span class="st">&#39;,&#39;</span>.join(name <span class="cf">for</span> name <span class="kw">in</span> fieldnames) <span class="op">+</span> <span class="st">&#39;</span><span class="ch">\n</span><span class="st">&#39;</span></span>
<span id="cb42-22"><a href="#cb42-22" aria-hidden="true" tabindex="-1"></a>      output_file.write(line)</span>
<span id="cb42-23"><a href="#cb42-23" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> current, f <span class="kw">in</span> <span class="bu">enumerate</span>(features):</span>
<span id="cb42-24"><a href="#cb42-24" aria-hidden="true" tabindex="-1"></a>          <span class="co"># Stop the algorithm if cancel button has been clicked</span></span>
<span id="cb42-25"><a href="#cb42-25" aria-hidden="true" tabindex="-1"></a>          <span class="cf">if</span> feedback.isCanceled():</span>
<span id="cb42-26"><a href="#cb42-26" aria-hidden="true" tabindex="-1"></a>              <span class="cf">break</span></span>
<span id="cb42-27"><a href="#cb42-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-28"><a href="#cb42-28" aria-hidden="true" tabindex="-1"></a>          <span class="co"># Add a feature in the sink</span></span>
<span id="cb42-29"><a href="#cb42-29" aria-hidden="true" tabindex="-1"></a>          line <span class="op">=</span> <span class="st">&#39;,&#39;</span>.join(<span class="bu">str</span>(f[name]) <span class="cf">for</span> name <span class="kw">in</span> fieldnames) <span class="op">+</span> <span class="st">&#39;</span><span class="ch">\n</span><span class="st">&#39;</span></span>
<span id="cb42-30"><a href="#cb42-30" aria-hidden="true" tabindex="-1"></a>          output_file.write(line)</span>
<span id="cb42-31"><a href="#cb42-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-32"><a href="#cb42-32" aria-hidden="true" tabindex="-1"></a>          <span class="co"># Update the progress bar</span></span>
<span id="cb42-33"><a href="#cb42-33" aria-hidden="true" tabindex="-1"></a>          feedback.setProgress(<span class="bu">int</span>(current <span class="op">*</span> total))</span>
<span id="cb42-34"><a href="#cb42-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-35"><a href="#cb42-35" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {<span class="st">&#39;OUTPUT&#39;</span>: csv}</span></code></pre></div>
<p>You can run the script and see that the behavior is almost identical but the code is much simpler. The code uses the <code>@alg</code> decorator for defining algorithm name, group, inputs and outputs in a more concise way.</p>
<p>Another important thing to note is that to create a processing algorithm, one must create a class that inherits from <code>QgsProcessingAlgorithm</code>. When you write a class, you refer to the current instance of the class with the keyword <code>self</code>. Here you are just writing a function, and the decorator will create a class for you. So we are using a parameter named <code>instance</code>. When the decorator will create a class, the reference to the instance will be passed on to our function as this parameter.</p>
</div>
</div>
<div id="writing-plugins" class="section level1">
<h1>14. Writing Plugins</h1>
<p>Plugins are a great way to extend the functionality of QGIS. You can write plugins using Python that can range from adding a simple button to sophisticated tool-kits. There are 2 broad categories of python plugins - Processing Plugins and GUI Plugins. We will cover both in this section.</p>
<p>There is a plugin named <a href="https://plugins.qgis.org/plugins/pluginbuilder/">Plugin Builder</a> that can help you generate a starter plugin. I have published step-by-step instructions for both <a href="https://www.qgistutorials.com/en/docs/3/building_a_python_plugin.html">GUI plugins</a> and <a href="https://www.qgistutorials.com/en/docs/3/processing_python_plugin.html">Processing Plugins</a> using the Plugin Builder method. While this method gives you an easy way to have a functional plugin, it is not the ideal way to learn plugin development. I prefer starting from a minimal template and adding elements as and when needed. Here we will learn the basics of plugin framework using a minimal plugin and learn how to add various element to make it a full plugin.</p>
<div id="a-minimal-plugin" class="section level2">
<h2>14.1 A Minimal Plugin</h2>
<p>Plugins are much more integrated into the QGIS system than Python Scripts. They are managed by <strong>Plugin Manager</strong> and are initialized when QGIS starts. To understand the required structure, let’s see what a minimal plugin looks like. You can learn more about this structure at <a href="https://github.com/wonder-sk/qgis-minimal-plugin">QGIS Minimalist Plugin Skeleton</a>.</p>
<p>We will be the same script for saving attributes of a vector layer and convert it to a plugin. The first requirement for plugins is a file called <code>metadata.txt</code>. This file contains general info, version, name and some other metadata used by plugins website and plugin manager.</p>
<p><code>metadata.txt</code></p>
<div class="sourceCode" id="cb43"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>[general]</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>name<span class="op">=</span>Save Attributes</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>description<span class="op">=</span>This plugin saves the attributes of the selected vector layer <span class="im">as</span> a CSV <span class="bu">file</span></span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>version<span class="op">=</span><span class="fl">1.0</span></span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>qgisMinimumVersion<span class="op">=</span><span class="fl">3.0</span></span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a>author<span class="op">=</span>Ujaval Gandhi</span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a>email<span class="op">=</span>ujaval<span class="op">@</span>spatialthoughts.com</span></code></pre></div>
<p>Second is the file that contains the main logic of the plugin. It must have <code>__init__()</code> method that gives the plugin access to the QGIS Interface (iface). The <code>initGui()</code> method is called when the plugin is loaded and <code>unload()</code> method which is called when the plugin is unloaded. For now, we are creating a minimal plugin that just add a button and a menu entry that displays message when clicked.</p>
<p><code>save_attributes.py</code></p>
<div class="sourceCode" id="cb44"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> sys</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> inspect</span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> PyQt5.QtWidgets <span class="im">import</span> QAction</span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> PyQt5.QtGui <span class="im">import</span> QIcon</span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a>cmd_folder <span class="op">=</span> os.path.split(inspect.getfile(inspect.currentframe()))[<span class="dv">0</span>]</span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> SaveAttributesPlugin:</span>
<span id="cb44-10"><a href="#cb44-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, iface):</span>
<span id="cb44-11"><a href="#cb44-11" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.iface <span class="op">=</span> iface</span>
<span id="cb44-12"><a href="#cb44-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-13"><a href="#cb44-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> initGui(<span class="va">self</span>):</span>
<span id="cb44-14"><a href="#cb44-14" aria-hidden="true" tabindex="-1"></a>      icon <span class="op">=</span> os.path.join(os.path.join(cmd_folder, <span class="st">&#39;logo.png&#39;</span>))</span>
<span id="cb44-15"><a href="#cb44-15" aria-hidden="true" tabindex="-1"></a>      <span class="va">self</span>.action <span class="op">=</span> QAction(QIcon(icon), <span class="st">&#39;Save Attributes as CSV&#39;</span>, <span class="va">self</span>.iface.mainWindow())</span>
<span id="cb44-16"><a href="#cb44-16" aria-hidden="true" tabindex="-1"></a>      <span class="va">self</span>.action.triggered.<span class="ex">connect</span>(<span class="va">self</span>.run)</span>
<span id="cb44-17"><a href="#cb44-17" aria-hidden="true" tabindex="-1"></a>      <span class="va">self</span>.iface.addPluginToMenu(<span class="st">&#39;&amp;Save Attributes&#39;</span>, <span class="va">self</span>.action)</span>
<span id="cb44-18"><a href="#cb44-18" aria-hidden="true" tabindex="-1"></a>      <span class="va">self</span>.iface.addToolBarIcon(<span class="va">self</span>.action)</span>
<span id="cb44-19"><a href="#cb44-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-20"><a href="#cb44-20" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> unload(<span class="va">self</span>):</span>
<span id="cb44-21"><a href="#cb44-21" aria-hidden="true" tabindex="-1"></a>      <span class="va">self</span>.iface.removeToolBarIcon(<span class="va">self</span>.action)</span>
<span id="cb44-22"><a href="#cb44-22" aria-hidden="true" tabindex="-1"></a>      <span class="va">self</span>.iface.removePluginMenu(<span class="st">&#39;&amp;Save Attributes&#39;</span>, <span class="va">self</span>.action)  </span>
<span id="cb44-23"><a href="#cb44-23" aria-hidden="true" tabindex="-1"></a>      <span class="kw">del</span> <span class="va">self</span>.action</span>
<span id="cb44-24"><a href="#cb44-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-25"><a href="#cb44-25" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> run(<span class="va">self</span>):</span>
<span id="cb44-26"><a href="#cb44-26" aria-hidden="true" tabindex="-1"></a>      <span class="va">self</span>.iface.messageBar().pushMessage(<span class="st">&#39;Hello from Plugin&#39;</span>)</span></code></pre></div>
<p>Third file is called <code>__init__.py</code> which is the starting point of the plugin. It imports the plugin class created in the second file and creates an instance of it.</p>
<p><code>__init__.py</code></p>
<div class="sourceCode" id="cb45"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> .save_attributes <span class="im">import</span> SaveAttributesPlugin</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> classFactory(iface):</span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> SaveAttributesPlugin(iface)</span></code></pre></div>
<p>Create these 3 files and put them in a folder named <code>save_attributes</code>. Copy the <code>logo.png</code> file from <code>&lt;home folder&gt;/Downloads/pyqgis_in_a_day/logo.png</code> to this folder. Copy the folder to the python plugins directory at <code>{profile folder}/python/plugins</code>.</p>
<p><img src="images/pyqgis/pluginminimalfiles.png" width="75%" style="display: block; margin: auto;" /></p>
<p>Restart QGIS. Go to <strong>Plugins → Manage and Install plugins… → Installed</strong> and enable the <strong>Save Attributes</strong> plugin. You will see the menu entry and the toolbar icon from the plugin.</p>
<p><img src="images/pyqgis/pluginminimalshow1.png" width="75%" style="display: block; margin: auto;" /></p>
<p>Now the <em>Hello from Plugin</em> message is displayed.</p>
<p><img src="images/pyqgis/pluginminimalshow2.png" width="75%" style="display: block; margin: auto;" /></p>
</div>
<div id="exercise-6" class="section level2">
<h2>Exercise 6</h2>
<p>Take the minimal plugin template from above and build a new plugin called <strong>Show Time</strong>. This plugin will add a button to the Plugin Toolbar which will display the current time when clicked. The code to add such a button is already covered in the <a href="#add-a-button-to-a-toolbar">Add a button to a toolbar</a> section.</p>
</div>
<div id="processing-plugin" class="section level2">
<h2>14.2 Processing Plugin</h2>
<p>The new and preferred way to write plugins in QGIS is using the Processing Framework. It removes the need for you to design the user interface. The resulting plugin integrates seamlessly in the Processing Toolbox and is inoperable with other processing algorithms.</p>
<p>Let’s take the minimal plugin and see what is required to make it a functional processing plugin. We need 2 additional files. One to define the processing algorithm and another to define a new processing provider.</p>
<p>The processing algorithm file is identical to the script we wrote earlier. Create a new file called <code>save_attributes_algorithm.py</code> with the following contents.</p>
<p><code>save_attributes_algorithm.py</code></p>
<div class="sourceCode" id="cb46"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> PyQt5.QtCore <span class="im">import</span> QCoreApplication</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> qgis.core <span class="im">import</span> (QgsProcessing,</span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>                       QgsProcessingAlgorithm,</span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>                       QgsProcessingParameterFeatureSource,</span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a>                       QgsProcessingParameterFileDestination)</span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> SaveAttributesAlgorithm(QgsProcessingAlgorithm):</span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;Saves the attributes of a vector layer to a CSV file.&quot;&quot;&quot;</span></span>
<span id="cb46-10"><a href="#cb46-10" aria-hidden="true" tabindex="-1"></a>    OUTPUT <span class="op">=</span> <span class="st">&#39;OUTPUT&#39;</span></span>
<span id="cb46-11"><a href="#cb46-11" aria-hidden="true" tabindex="-1"></a>    INPUT <span class="op">=</span> <span class="st">&#39;INPUT&#39;</span></span>
<span id="cb46-12"><a href="#cb46-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-13"><a href="#cb46-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> initAlgorithm(<span class="va">self</span>, config<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb46-14"><a href="#cb46-14" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.addParameter(</span>
<span id="cb46-15"><a href="#cb46-15" aria-hidden="true" tabindex="-1"></a>            QgsProcessingParameterFeatureSource(</span>
<span id="cb46-16"><a href="#cb46-16" aria-hidden="true" tabindex="-1"></a>                <span class="va">self</span>.INPUT,</span>
<span id="cb46-17"><a href="#cb46-17" aria-hidden="true" tabindex="-1"></a>                <span class="va">self</span>.tr(<span class="st">&#39;Input layer&#39;</span>),</span>
<span id="cb46-18"><a href="#cb46-18" aria-hidden="true" tabindex="-1"></a>                [QgsProcessing.TypeVectorAnyGeometry]</span>
<span id="cb46-19"><a href="#cb46-19" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb46-20"><a href="#cb46-20" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb46-21"><a href="#cb46-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-22"><a href="#cb46-22" aria-hidden="true" tabindex="-1"></a>        <span class="co"># We add a file output of type CSV.</span></span>
<span id="cb46-23"><a href="#cb46-23" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.addParameter(</span>
<span id="cb46-24"><a href="#cb46-24" aria-hidden="true" tabindex="-1"></a>            QgsProcessingParameterFileDestination(</span>
<span id="cb46-25"><a href="#cb46-25" aria-hidden="true" tabindex="-1"></a>                <span class="va">self</span>.OUTPUT,</span>
<span id="cb46-26"><a href="#cb46-26" aria-hidden="true" tabindex="-1"></a>                <span class="va">self</span>.tr(<span class="st">&#39;Output File&#39;</span>),</span>
<span id="cb46-27"><a href="#cb46-27" aria-hidden="true" tabindex="-1"></a>                <span class="st">&#39;CSV files (*.csv)&#39;</span>,</span>
<span id="cb46-28"><a href="#cb46-28" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb46-29"><a href="#cb46-29" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb46-30"><a href="#cb46-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-31"><a href="#cb46-31" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> processAlgorithm(<span class="va">self</span>, parameters, context, feedback):</span>
<span id="cb46-32"><a href="#cb46-32" aria-hidden="true" tabindex="-1"></a>        source <span class="op">=</span> <span class="va">self</span>.parameterAsSource(parameters, <span class="va">self</span>.INPUT, context)</span>
<span id="cb46-33"><a href="#cb46-33" aria-hidden="true" tabindex="-1"></a>        csv <span class="op">=</span> <span class="va">self</span>.parameterAsFileOutput(parameters, <span class="va">self</span>.OUTPUT, context)</span>
<span id="cb46-34"><a href="#cb46-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-35"><a href="#cb46-35" aria-hidden="true" tabindex="-1"></a>        fieldnames <span class="op">=</span> [field.name() <span class="cf">for</span> field <span class="kw">in</span> source.fields()]</span>
<span id="cb46-36"><a href="#cb46-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-37"><a href="#cb46-37" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Compute the number of steps to display within the progress bar and</span></span>
<span id="cb46-38"><a href="#cb46-38" aria-hidden="true" tabindex="-1"></a>        <span class="co"># get features from source</span></span>
<span id="cb46-39"><a href="#cb46-39" aria-hidden="true" tabindex="-1"></a>        total <span class="op">=</span> <span class="fl">100.0</span> <span class="op">/</span> source.featureCount() <span class="cf">if</span> source.featureCount() <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb46-40"><a href="#cb46-40" aria-hidden="true" tabindex="-1"></a>        features <span class="op">=</span> source.getFeatures()</span>
<span id="cb46-41"><a href="#cb46-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-42"><a href="#cb46-42" aria-hidden="true" tabindex="-1"></a>        <span class="cf">with</span> <span class="bu">open</span>(csv, <span class="st">&#39;w&#39;</span>) <span class="im">as</span> output_file:</span>
<span id="cb46-43"><a href="#cb46-43" aria-hidden="true" tabindex="-1"></a>          <span class="co"># write header</span></span>
<span id="cb46-44"><a href="#cb46-44" aria-hidden="true" tabindex="-1"></a>          line <span class="op">=</span> <span class="st">&#39;,&#39;</span>.join(name <span class="cf">for</span> name <span class="kw">in</span> fieldnames) <span class="op">+</span> <span class="st">&#39;</span><span class="ch">\n</span><span class="st">&#39;</span></span>
<span id="cb46-45"><a href="#cb46-45" aria-hidden="true" tabindex="-1"></a>          output_file.write(line)</span>
<span id="cb46-46"><a href="#cb46-46" aria-hidden="true" tabindex="-1"></a>          <span class="cf">for</span> current, f <span class="kw">in</span> <span class="bu">enumerate</span>(features):</span>
<span id="cb46-47"><a href="#cb46-47" aria-hidden="true" tabindex="-1"></a>              <span class="co"># Stop the algorithm if cancel button has been clicked</span></span>
<span id="cb46-48"><a href="#cb46-48" aria-hidden="true" tabindex="-1"></a>              <span class="cf">if</span> feedback.isCanceled():</span>
<span id="cb46-49"><a href="#cb46-49" aria-hidden="true" tabindex="-1"></a>                  <span class="cf">break</span></span>
<span id="cb46-50"><a href="#cb46-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-51"><a href="#cb46-51" aria-hidden="true" tabindex="-1"></a>              <span class="co"># Add a feature in the sink</span></span>
<span id="cb46-52"><a href="#cb46-52" aria-hidden="true" tabindex="-1"></a>              line <span class="op">=</span> <span class="st">&#39;,&#39;</span>.join(<span class="bu">str</span>(f[name]) <span class="cf">for</span> name <span class="kw">in</span> fieldnames) <span class="op">+</span> <span class="st">&#39;</span><span class="ch">\n</span><span class="st">&#39;</span></span>
<span id="cb46-53"><a href="#cb46-53" aria-hidden="true" tabindex="-1"></a>              output_file.write(line)</span>
<span id="cb46-54"><a href="#cb46-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-55"><a href="#cb46-55" aria-hidden="true" tabindex="-1"></a>              <span class="co"># Update the progress bar</span></span>
<span id="cb46-56"><a href="#cb46-56" aria-hidden="true" tabindex="-1"></a>              feedback.setProgress(<span class="bu">int</span>(current <span class="op">*</span> total))</span>
<span id="cb46-57"><a href="#cb46-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-58"><a href="#cb46-58" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> {<span class="va">self</span>.OUTPUT: csv}</span>
<span id="cb46-59"><a href="#cb46-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-60"><a href="#cb46-60" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> name(<span class="va">self</span>):</span>
<span id="cb46-61"><a href="#cb46-61" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">&#39;save_attributes&#39;</span></span>
<span id="cb46-62"><a href="#cb46-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-63"><a href="#cb46-63" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> displayName(<span class="va">self</span>):</span>
<span id="cb46-64"><a href="#cb46-64" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>.tr(<span class="st">&#39;Save Attributes As CSV&#39;</span>)</span>
<span id="cb46-65"><a href="#cb46-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-66"><a href="#cb46-66" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> group(<span class="va">self</span>):</span>
<span id="cb46-67"><a href="#cb46-67" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>.tr(<span class="va">self</span>.groupId())</span>
<span id="cb46-68"><a href="#cb46-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-69"><a href="#cb46-69" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> groupId(<span class="va">self</span>):</span>
<span id="cb46-70"><a href="#cb46-70" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">&#39;&#39;</span></span>
<span id="cb46-71"><a href="#cb46-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-72"><a href="#cb46-72" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> tr(<span class="va">self</span>, string):</span>
<span id="cb46-73"><a href="#cb46-73" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> QCoreApplication.translate(<span class="st">&#39;Processing&#39;</span>, string)</span>
<span id="cb46-74"><a href="#cb46-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-75"><a href="#cb46-75" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> createInstance(<span class="va">self</span>):</span>
<span id="cb46-76"><a href="#cb46-76" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> SaveAttributesAlgorithm()</span></code></pre></div>
<p>Next, we need to define a new processing provider. Create a new file <code>save_attributes_provider.py</code> with the following content.</p>
<p><code>save_attributes_provider.py</code></p>
<div class="sourceCode" id="cb47"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> inspect</span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> PyQt5.QtGui <span class="im">import</span> QIcon</span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> qgis.core <span class="im">import</span> QgsProcessingProvider</span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> .save_attributes_algorithm <span class="im">import</span> SaveAttributesAlgorithm</span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-9"><a href="#cb47-9" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> SaveAttributesProvider(QgsProcessingProvider):</span>
<span id="cb47-10"><a href="#cb47-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-11"><a href="#cb47-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>):</span>
<span id="cb47-12"><a href="#cb47-12" aria-hidden="true" tabindex="-1"></a>        QgsProcessingProvider.<span class="fu">__init__</span>(<span class="va">self</span>)</span>
<span id="cb47-13"><a href="#cb47-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-14"><a href="#cb47-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> unload(<span class="va">self</span>):</span>
<span id="cb47-15"><a href="#cb47-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">pass</span></span>
<span id="cb47-16"><a href="#cb47-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-17"><a href="#cb47-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> loadAlgorithms(<span class="va">self</span>):</span>
<span id="cb47-18"><a href="#cb47-18" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.addAlgorithm(SaveAttributesAlgorithm())</span>
<span id="cb47-19"><a href="#cb47-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-20"><a href="#cb47-20" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="bu">id</span>(<span class="va">self</span>):</span>
<span id="cb47-21"><a href="#cb47-21" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">&#39;save_attributes&#39;</span></span>
<span id="cb47-22"><a href="#cb47-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-23"><a href="#cb47-23" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> name(<span class="va">self</span>):</span>
<span id="cb47-24"><a href="#cb47-24" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>.tr(<span class="st">&#39;Save Attributes&#39;</span>)</span>
<span id="cb47-25"><a href="#cb47-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-26"><a href="#cb47-26" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> icon(<span class="va">self</span>):</span>
<span id="cb47-27"><a href="#cb47-27" aria-hidden="true" tabindex="-1"></a>        cmd_folder <span class="op">=</span> os.path.split(inspect.getfile(inspect.currentframe()))[<span class="dv">0</span>]</span>
<span id="cb47-28"><a href="#cb47-28" aria-hidden="true" tabindex="-1"></a>        icon <span class="op">=</span> QIcon(os.path.join(os.path.join(cmd_folder, <span class="st">&#39;logo.png&#39;</span>)))</span>
<span id="cb47-29"><a href="#cb47-29" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> icon</span>
<span id="cb47-30"><a href="#cb47-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-31"><a href="#cb47-31" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> longName(<span class="va">self</span>):</span>
<span id="cb47-32"><a href="#cb47-32" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>.name()</span></code></pre></div>
<p>We now make changes to the existing <code>save_attributes.py</code> file to import and initialize the new processing provider. Change the contents of the file to the following</p>
<p><code>save_attributes.py</code></p>
<div class="sourceCode" id="cb48"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> sys</span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> inspect</span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> PyQt5.QtWidgets <span class="im">import</span> QAction</span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> PyQt5.QtGui <span class="im">import</span> QIcon</span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> qgis.core <span class="im">import</span> QgsProcessingAlgorithm, QgsApplication</span>
<span id="cb48-8"><a href="#cb48-8" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> processing</span>
<span id="cb48-9"><a href="#cb48-9" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> .save_attributes_provider <span class="im">import</span> SaveAttributesProvider</span>
<span id="cb48-10"><a href="#cb48-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-11"><a href="#cb48-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-12"><a href="#cb48-12" aria-hidden="true" tabindex="-1"></a>cmd_folder <span class="op">=</span> os.path.split(inspect.getfile(inspect.currentframe()))[<span class="dv">0</span>]</span>
<span id="cb48-13"><a href="#cb48-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-14"><a href="#cb48-14" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> SaveAttributesPlugin:</span>
<span id="cb48-15"><a href="#cb48-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, iface):</span>
<span id="cb48-16"><a href="#cb48-16" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.iface <span class="op">=</span> iface</span>
<span id="cb48-17"><a href="#cb48-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-18"><a href="#cb48-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> initProcessing(<span class="va">self</span>):</span>
<span id="cb48-19"><a href="#cb48-19" aria-hidden="true" tabindex="-1"></a>      <span class="va">self</span>.provider <span class="op">=</span> SaveAttributesProvider()</span>
<span id="cb48-20"><a href="#cb48-20" aria-hidden="true" tabindex="-1"></a>      QgsApplication.processingRegistry().addProvider(<span class="va">self</span>.provider)</span>
<span id="cb48-21"><a href="#cb48-21" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb48-22"><a href="#cb48-22" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> initGui(<span class="va">self</span>):</span>
<span id="cb48-23"><a href="#cb48-23" aria-hidden="true" tabindex="-1"></a>      <span class="va">self</span>.initProcessing()</span>
<span id="cb48-24"><a href="#cb48-24" aria-hidden="true" tabindex="-1"></a>      icon <span class="op">=</span> os.path.join(os.path.join(cmd_folder, <span class="st">&#39;logo.png&#39;</span>))</span>
<span id="cb48-25"><a href="#cb48-25" aria-hidden="true" tabindex="-1"></a>      <span class="va">self</span>.action <span class="op">=</span> QAction(QIcon(icon), <span class="st">&#39;Save Attributes as CSV&#39;</span>, <span class="va">self</span>.iface.mainWindow())</span>
<span id="cb48-26"><a href="#cb48-26" aria-hidden="true" tabindex="-1"></a>      <span class="va">self</span>.action.triggered.<span class="ex">connect</span>(<span class="va">self</span>.run)</span>
<span id="cb48-27"><a href="#cb48-27" aria-hidden="true" tabindex="-1"></a>      <span class="va">self</span>.iface.addPluginToMenu(<span class="st">&#39;&amp;Save Attributes&#39;</span>, <span class="va">self</span>.action)</span>
<span id="cb48-28"><a href="#cb48-28" aria-hidden="true" tabindex="-1"></a>      <span class="va">self</span>.iface.addToolBarIcon(<span class="va">self</span>.action)</span>
<span id="cb48-29"><a href="#cb48-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-30"><a href="#cb48-30" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> unload(<span class="va">self</span>):</span>
<span id="cb48-31"><a href="#cb48-31" aria-hidden="true" tabindex="-1"></a>      QgsApplication.processingRegistry().removeProvider(<span class="va">self</span>.provider)</span>
<span id="cb48-32"><a href="#cb48-32" aria-hidden="true" tabindex="-1"></a>      <span class="va">self</span>.iface.removeToolBarIcon(<span class="va">self</span>.action)</span>
<span id="cb48-33"><a href="#cb48-33" aria-hidden="true" tabindex="-1"></a>      <span class="va">self</span>.iface.removePluginMenu(<span class="st">&#39;&amp;Save Attributes&#39;</span>, <span class="va">self</span>.action)  </span>
<span id="cb48-34"><a href="#cb48-34" aria-hidden="true" tabindex="-1"></a>      <span class="kw">del</span> <span class="va">self</span>.action</span>
<span id="cb48-35"><a href="#cb48-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-36"><a href="#cb48-36" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> run(<span class="va">self</span>):</span>
<span id="cb48-37"><a href="#cb48-37" aria-hidden="true" tabindex="-1"></a>      processing.execAlgorithmDialog(<span class="st">&#39;save_attributes:save_attributes&#39;</span>)</span></code></pre></div>
<p>The plugin folder should look like below.</p>
<p><img src="images/pyqgis/pluginprocessingfiles.png" width="75%" style="display: block; margin: auto;" /></p>
<p>Now let’s reload the plugin and see what it looks like. This is a helper plugin which allows iterative development of plugins. Using this plugin, you can change your plugin code and have it reflected in QGIS without having to restart QGIS every time. Find and install the <strong>Plugin Reloader</strong> plugin. Once installed, go to <strong>Plugin → Plugin Reloader → Choose a plugin to be reloaded</strong>. Select <code>save_attributes</code> in the Configure Plugin reloader dialog.</p>
<p><img src="images/pyqgis/pluginprocessingreload.png" width="75%" style="display: block; margin: auto;" /></p>
<p>Once reloaded, you can click on the toolbar button or <strong>Plugin → Save Attributes → Save Attributes As CSV</strong> to launch the processing algorithm.</p>
<p><img src="images/pyqgis/pluginprocessingrun.png" width="75%" style="display: block; margin: auto;" /></p>
</div>
</div>
<div id="supplement" class="section level1">
<h1>15. Supplement</h1>
<p>This section contains code snippets for common PyQGIS operations.</p>
<p>All code snipets assume you have loaded the <code>sf.qgz</code> project. You can load the project using the code below.</p>
<div class="sourceCode" id="cb49"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>data_dir <span class="op">=</span> os.path.join(os.path.expanduser(<span class="st">&#39;~&#39;</span>), <span class="st">&#39;Downloads&#39;</span>, <span class="st">&#39;pyqgis_in_a_day&#39;</span>)</span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>project <span class="op">=</span> QgsProject.instance()</span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a>project_name <span class="op">=</span> <span class="st">&#39;sf.qgz&#39;</span></span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a>project_path <span class="op">=</span> os.path.join(data_dir, project_name)</span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a>project.read(project_path)</span></code></pre></div>
<div id="save-map-rendering-as-an-image" class="section level2">
<h2>Save Map Rendering as an Image</h2>
<p><code>saveAsImage()</code> method is quick and easy, but you do not have much control over the resulting image. You can’t control the resolution, size or how each layer will be rendered. There is another way to achieve this. You can look at the code for exporting map as an image in QGIS and you will discover 2 classes <code>QgsMapRendererParallelJob</code> and <code>QgsMapRendererSequentialJob</code> that lets you achieve a better result. The code snippet below exports a hi-resolution image of the project. <a href="#fn4" class="footnote-ref" id="fnref4"><sup>4</sup></a></p>
<div class="sourceCode" id="cb50"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>data_dir <span class="op">=</span> os.path.join(os.path.expanduser(<span class="st">&#39;~&#39;</span>), <span class="st">&#39;Downloads&#39;</span>, <span class="st">&#39;pyqgis_in_a_day&#39;</span>)</span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>image_name <span class="op">=</span> <span class="st">&#39;sf_hires.png&#39;</span></span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a>image_path <span class="op">=</span> os.path.join(data_dir, image_name)</span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a>settings <span class="op">=</span> iface.mapCanvas().mapSettings()</span>
<span id="cb50-7"><a href="#cb50-7" aria-hidden="true" tabindex="-1"></a>settings.setOutputSize(QSize(<span class="dv">1000</span>,<span class="dv">1000</span>))</span>
<span id="cb50-8"><a href="#cb50-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-9"><a href="#cb50-9" aria-hidden="true" tabindex="-1"></a>settings.setFlag(QgsMapSettings.DrawLabeling, <span class="va">False</span>)</span>
<span id="cb50-10"><a href="#cb50-10" aria-hidden="true" tabindex="-1"></a>settings.setFlag(QgsMapSettings.Antialiasing, <span class="va">True</span>)</span>
<span id="cb50-11"><a href="#cb50-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-12"><a href="#cb50-12" aria-hidden="true" tabindex="-1"></a>job <span class="op">=</span> QgsMapRendererSequentialJob(settings)</span>
<span id="cb50-13"><a href="#cb50-13" aria-hidden="true" tabindex="-1"></a>job.start()</span>
<span id="cb50-14"><a href="#cb50-14" aria-hidden="true" tabindex="-1"></a>job.waitForFinished()</span>
<span id="cb50-15"><a href="#cb50-15" aria-hidden="true" tabindex="-1"></a>image <span class="op">=</span> job.renderedImage()</span>
<span id="cb50-16"><a href="#cb50-16" aria-hidden="true" tabindex="-1"></a>image.save(image_path)</span></code></pre></div>
<p><img src="images/pyqgis/sf_hires.png" width="75%" style="display: block; margin: auto;" /></p>
</div>
<div id="get-all-layers" class="section level2">
<h2>Get all Layers</h2>
<div class="sourceCode" id="cb51"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> layer <span class="kw">in</span> QgsProject.instance().mapLayers().values():</span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(layer.name())</span></code></pre></div>
</div>
<div id="get-only-checked-visible-layers" class="section level2">
<h2>Get only checked (visible) Layers</h2>
<div class="sourceCode" id="cb52"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> layer <span class="kw">in</span> iface.mapCanvas().layers():</span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(layer.name())</span></code></pre></div>
</div>
<div id="get-only-selected-layers" class="section level2">
<h2>Get only selected Layers</h2>
<div class="sourceCode" id="cb53"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> layer <span class="kw">in</span> iface.layerTreeView().selectedLayers():</span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>  <span class="bu">print</span>(layer.name())</span></code></pre></div>
</div>
<div id="set-canvas-extent-to-a-layer-extent" class="section level2">
<h2>Set Canvas Extent to a Layer Extent</h2>
<p>Select one of the layers in the <em>Layers</em> panel and run the following code.</p>
<div class="sourceCode" id="cb54"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>layer <span class="op">=</span> iface.activeLayer()</span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>mc <span class="op">=</span> iface.mapCanvas()</span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>mc.setExtent(layer.extent())</span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a>mc.refresh()</span></code></pre></div>
</div>
<div id="get-layers-with-hierarchy" class="section level2">
<h2>Get Layers with Hierarchy</h2>
<p>This code snippet is taken from the <a href="https://docs.qgis.org/testing/en/docs/pyqgis_developer_cookbook/cheat_sheet.html">Cheat Sheet for PyQGIS</a> , but contains an important modification. If you notice carefully, the function <code>getGroupLayers</code> is called recursively from within <code>getGroupLayers</code>. This allows one to even get layers that have sub-groups within layer groups.</p>
<div class="sourceCode" id="cb55"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> getGroupLayers(group):</span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&#39;- group:&#39;</span> <span class="op">+</span> group.name())</span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> child <span class="kw">in</span> group.children():</span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">isinstance</span>(child, QgsLayerTreeGroup):</span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a>            getGroupLayers(child)</span>
<span id="cb55-6"><a href="#cb55-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb55-7"><a href="#cb55-7" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="st">&#39;  - layer:&#39;</span> <span class="op">+</span> child.name())</span>
<span id="cb55-8"><a href="#cb55-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-9"><a href="#cb55-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb55-10"><a href="#cb55-10" aria-hidden="true" tabindex="-1"></a>root <span class="op">=</span> QgsProject.instance().layerTreeRoot()</span>
<span id="cb55-11"><a href="#cb55-11" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> child <span class="kw">in</span> root.children():</span>
<span id="cb55-12"><a href="#cb55-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">isinstance</span>(child, QgsLayerTreeGroup):</span>
<span id="cb55-13"><a href="#cb55-13" aria-hidden="true" tabindex="-1"></a>        getGroupLayers(child)</span>
<span id="cb55-14"><a href="#cb55-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> <span class="bu">isinstance</span>(child, QgsLayerTreeLayer):</span>
<span id="cb55-15"><a href="#cb55-15" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span> (<span class="st">&quot;- layer: &quot;</span> <span class="op">+</span> child.name())</span></code></pre></div>
<p><img src="images/pyqgis/layergroup.png" width="50%" style="display: block; margin: auto;" /></p>
</div>
<div id="remove-a-specific-button-from-a-toolbar" class="section level2">
<h2>Remove a Specific Button from a Toolbar</h2>
<p>The following code snippet shows how once can find names of different widget in the QGIS Application and locate specific toolbars and button. The following code will disable to <em>Deselect All Features from Layers</em> button from the <em>Selection Toolbar</em>.</p>
<div class="sourceCode" id="cb56"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Find all child objects of the mainWindow that are type QToolbar</span></span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> x <span class="kw">in</span> iface.mainWindow().findChildren(QToolBar): </span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(x.objectName())</span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a><span class="co"># In the printed list, we observe that </span></span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a><span class="co"># the selection toolbar is named mSelectionToolBar</span></span>
<span id="cb56-7"><a href="#cb56-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Get a reference to it by name</span></span>
<span id="cb56-8"><a href="#cb56-8" aria-hidden="true" tabindex="-1"></a>selectionToolbar <span class="op">=</span> iface.mainWindow().findChild(QToolBar,<span class="st">&#39;mSelectionToolBar&#39;</span>)</span>
<span id="cb56-9"><a href="#cb56-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-10"><a href="#cb56-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Find the buttons on the toolbar</span></span>
<span id="cb56-11"><a href="#cb56-11" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> x <span class="kw">in</span> selectionToolbar.findChildren(QAction):</span>
<span id="cb56-12"><a href="#cb56-12" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(x.objectName())</span>
<span id="cb56-13"><a href="#cb56-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-14"><a href="#cb56-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Alternatively, you can also use the following</span></span>
<span id="cb56-15"><a href="#cb56-15" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> x <span class="kw">in</span> selectionToolbar.actions():</span>
<span id="cb56-16"><a href="#cb56-16" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(x.objectName())</span>
<span id="cb56-17"><a href="#cb56-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-18"><a href="#cb56-18" aria-hidden="true" tabindex="-1"></a><span class="co"># If the toolbar button is not an action, you</span></span>
<span id="cb56-19"><a href="#cb56-19" aria-hidden="true" tabindex="-1"></a><span class="co"># We know the name of the deselection button </span></span>
<span id="cb56-20"><a href="#cb56-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Get a reference to it by name</span></span>
<span id="cb56-21"><a href="#cb56-21" aria-hidden="true" tabindex="-1"></a>deselection <span class="op">=</span> selectionToolbar.findChild(QAction,<span class="st">&#39;ActionDeselection&#39;</span>)</span>
<span id="cb56-22"><a href="#cb56-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-23"><a href="#cb56-23" aria-hidden="true" tabindex="-1"></a><span class="co"># We can disable a widget by calling setEnabled(False)</span></span>
<span id="cb56-24"><a href="#cb56-24" aria-hidden="true" tabindex="-1"></a>deselection.setEnabled(<span class="va">False</span>)</span>
<span id="cb56-25"><a href="#cb56-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-26"><a href="#cb56-26" aria-hidden="true" tabindex="-1"></a><span class="co"># We can remove it completely by calling removeAction()</span></span>
<span id="cb56-27"><a href="#cb56-27" aria-hidden="true" tabindex="-1"></a>selectionToolbar.removeAction(deselection)</span></code></pre></div>
</div>
<div id="add-a-drop-down-menu-to-toolbar" class="section level2">
<h2>Add a Drop-down Menu to Toolbar</h2>
<p>This example shows how to add a <code>QCombobox</code> widget to a toolbar and populate it with attribute values from a layer. On click of the button, the selection is read from the combo box and used to apply a filter to the layer</p>
<blockquote>
<p>You must have a layer with an attribute called <strong>NAME</strong> for this example to work. Tested with the <a href="https://www.naturalearthdata.com/downloads/10m-cultural-vectors/">Natural Earth Admin 0 - Countries</a> layer.</p>
</blockquote>
<div class="sourceCode" id="cb57"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>toolBar <span class="op">=</span> iface.addToolBar(<span class="st">&quot;My Toolbar&quot;</span>)</span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>toolBar.setObjectName(<span class="st">&quot;My Toolbar&quot;</span>)</span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a>countryCombo <span class="op">=</span> QComboBox(toolBar)</span>
<span id="cb57-5"><a href="#cb57-5" aria-hidden="true" tabindex="-1"></a>toolBar.addWidget(countryCombo)</span>
<span id="cb57-6"><a href="#cb57-6" aria-hidden="true" tabindex="-1"></a>countryCombo.setToolTip(<span class="st">&quot;Select a country&quot;</span>)</span>
<span id="cb57-7"><a href="#cb57-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-8"><a href="#cb57-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-9"><a href="#cb57-9" aria-hidden="true" tabindex="-1"></a>filterButton <span class="op">=</span> QPushButton(<span class="st">&#39;Filter&#39;</span>)</span>
<span id="cb57-10"><a href="#cb57-10" aria-hidden="true" tabindex="-1"></a>filterButton.setToolTip(<span class="st">&#39;Filter&#39;</span>)</span>
<span id="cb57-11"><a href="#cb57-11" aria-hidden="true" tabindex="-1"></a>toolBar.addWidget(filterButton)</span>
<span id="cb57-12"><a href="#cb57-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-13"><a href="#cb57-13" aria-hidden="true" tabindex="-1"></a>resetButton <span class="op">=</span> QPushButton(<span class="st">&#39;Reset&#39;</span>)</span>
<span id="cb57-14"><a href="#cb57-14" aria-hidden="true" tabindex="-1"></a>resetButton.setToolTip(<span class="st">&#39;Reset&#39;</span>)</span>
<span id="cb57-15"><a href="#cb57-15" aria-hidden="true" tabindex="-1"></a>toolBar.addWidget(resetButton)</span>
<span id="cb57-16"><a href="#cb57-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-17"><a href="#cb57-17" aria-hidden="true" tabindex="-1"></a><span class="co"># We want to sort the layer by country names</span></span>
<span id="cb57-18"><a href="#cb57-18" aria-hidden="true" tabindex="-1"></a><span class="co"># configure QgsFeatureRequest and use it with getFeatures()</span></span>
<span id="cb57-19"><a href="#cb57-19" aria-hidden="true" tabindex="-1"></a>request <span class="op">=</span> QgsFeatureRequest()</span>
<span id="cb57-20"><a href="#cb57-20" aria-hidden="true" tabindex="-1"></a>clause <span class="op">=</span> QgsFeatureRequest.OrderByClause(<span class="st">&#39;NAME&#39;</span>)</span>
<span id="cb57-21"><a href="#cb57-21" aria-hidden="true" tabindex="-1"></a>orderby <span class="op">=</span> QgsFeatureRequest.OrderBy([clause])</span>
<span id="cb57-22"><a href="#cb57-22" aria-hidden="true" tabindex="-1"></a>request.setOrderBy(orderby)</span>
<span id="cb57-23"><a href="#cb57-23" aria-hidden="true" tabindex="-1"></a>layer <span class="op">=</span> iface.activeLayer()</span>
<span id="cb57-24"><a href="#cb57-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-25"><a href="#cb57-25" aria-hidden="true" tabindex="-1"></a><span class="co"># Read the country names and save in a list</span></span>
<span id="cb57-26"><a href="#cb57-26" aria-hidden="true" tabindex="-1"></a>countries <span class="op">=</span> []</span>
<span id="cb57-27"><a href="#cb57-27" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> f <span class="kw">in</span> layer.getFeatures(request):</span>
<span id="cb57-28"><a href="#cb57-28" aria-hidden="true" tabindex="-1"></a>  countries.append(f[<span class="st">&#39;NAME&#39;</span>])</span>
<span id="cb57-29"><a href="#cb57-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-30"><a href="#cb57-30" aria-hidden="true" tabindex="-1"></a><span class="co"># Add items to the combobox</span></span>
<span id="cb57-31"><a href="#cb57-31" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> country <span class="kw">in</span> countries:</span>
<span id="cb57-32"><a href="#cb57-32" aria-hidden="true" tabindex="-1"></a>    countryCombo.addItem(country)</span>
<span id="cb57-33"><a href="#cb57-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-34"><a href="#cb57-34" aria-hidden="true" tabindex="-1"></a><span class="co"># Define functions to apply and reset filters</span></span>
<span id="cb57-35"><a href="#cb57-35" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> filter_layer():</span>
<span id="cb57-36"><a href="#cb57-36" aria-hidden="true" tabindex="-1"></a>    layer <span class="op">=</span> iface.activeLayer()</span>
<span id="cb57-37"><a href="#cb57-37" aria-hidden="true" tabindex="-1"></a>    country <span class="op">=</span> countryCombo.currentText()</span>
<span id="cb57-38"><a href="#cb57-38" aria-hidden="true" tabindex="-1"></a>    expression <span class="op">=</span> <span class="st">&#39;</span><span class="ch">\&quot;</span><span class="st">NAME</span><span class="ch">\&quot;</span><span class="st"> = </span><span class="ch">\&#39;</span><span class="sc">{}</span><span class="ch">\&#39;</span><span class="st">&#39;</span>.<span class="bu">format</span>(country)</span>
<span id="cb57-39"><a href="#cb57-39" aria-hidden="true" tabindex="-1"></a>    layer.setSubsetString(expression)</span>
<span id="cb57-40"><a href="#cb57-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb57-41"><a href="#cb57-41" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> reset_layer():</span>
<span id="cb57-42"><a href="#cb57-42" aria-hidden="true" tabindex="-1"></a>    layer <span class="op">=</span> iface.activeLayer()</span>
<span id="cb57-43"><a href="#cb57-43" aria-hidden="true" tabindex="-1"></a>    layer.setSubsetString(<span class="st">&#39;&#39;</span>)</span>
<span id="cb57-44"><a href="#cb57-44" aria-hidden="true" tabindex="-1"></a>    countryCombo.clear()</span>
<span id="cb57-45"><a href="#cb57-45" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> country <span class="kw">in</span> countries:</span>
<span id="cb57-46"><a href="#cb57-46" aria-hidden="true" tabindex="-1"></a>      countryCombo.addItem(country)</span>
<span id="cb57-47"><a href="#cb57-47" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb57-48"><a href="#cb57-48" aria-hidden="true" tabindex="-1"></a>filterButton.clicked.<span class="ex">connect</span>(filter_layer)</span>
<span id="cb57-49"><a href="#cb57-49" aria-hidden="true" tabindex="-1"></a>resetButton.clicked.<span class="ex">connect</span>(reset_layer)</span></code></pre></div>
</div>
<div id="adding-csv-layers" class="section level2">
<h2>Adding CSV Layers</h2>
<div class="sourceCode" id="cb58"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>data_dir <span class="op">=</span> os.path.join(os.path.expanduser(<span class="st">&#39;~&#39;</span>), <span class="st">&#39;Downloads&#39;</span>, <span class="st">&#39;pyqgis_in_a_day&#39;</span>)</span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a>filename <span class="op">=</span> <span class="st">&#39;trees.csv&#39;</span></span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a>csvpath <span class="op">=</span> <span class="st">&#39;file:///&#39;</span> <span class="op">+</span> data_dir <span class="op">+</span> filename</span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a>uri <span class="op">=</span> <span class="st">&#39;</span><span class="sc">{}</span><span class="st">?type=csv&amp;xField=</span><span class="sc">{}</span><span class="st">&amp;yField=</span><span class="sc">{}</span><span class="st">&amp;crs=</span><span class="sc">{}</span><span class="st">&#39;</span>.<span class="bu">format</span>(</span>
<span id="cb58-7"><a href="#cb58-7" aria-hidden="true" tabindex="-1"></a>  csvpath, <span class="st">&#39;Longitude&#39;</span>, <span class="st">&#39;Latitude&#39;</span>, <span class="st">&#39;EPSG:4326&#39;</span>)</span>
<span id="cb58-8"><a href="#cb58-8" aria-hidden="true" tabindex="-1"></a>iface.addVectorLayer(uri, <span class="st">&#39;trees&#39;</span>, <span class="st">&#39;delimitedtext&#39;</span>)</span></code></pre></div>
</div>
<div id="inserting-layers-in-the-layer-tree" class="section level2">
<h2>Inserting Layers in the Layer Tree</h2>
<p>We can use the <code>QgsLayerTree</code> class to insert the layer at an appropriate place.</p>
<div class="sourceCode" id="cb59"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>data_dir <span class="op">=</span> os.path.join(os.path.expanduser(<span class="st">&#39;~&#39;</span>), <span class="st">&#39;Downloads&#39;</span>, <span class="st">&#39;pyqgis_in_a_day&#39;</span>)</span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a>filename <span class="op">=</span> <span class="st">&#39;srtm.tif&#39;</span></span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a>uri <span class="op">=</span> os.path.join(data_dir, filename)</span>
<span id="cb59-6"><a href="#cb59-6" aria-hidden="true" tabindex="-1"></a>rlayer <span class="op">=</span> QgsRasterLayer(uri, <span class="st">&#39;srtm&#39;</span>, <span class="st">&#39;gdal&#39;</span>)</span>
<span id="cb59-7"><a href="#cb59-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-8"><a href="#cb59-8" aria-hidden="true" tabindex="-1"></a>rastergroup <span class="op">=</span> QgsLayerTreeGroup(<span class="st">&#39;raster layers&#39;</span>)</span>
<span id="cb59-9"><a href="#cb59-9" aria-hidden="true" tabindex="-1"></a>treelayer <span class="op">=</span> QgsLayerTreeLayer(rlayer)</span>
<span id="cb59-10"><a href="#cb59-10" aria-hidden="true" tabindex="-1"></a>rastergroup.insertChildNode(<span class="dv">0</span>, treelayer)</span>
<span id="cb59-11"><a href="#cb59-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-12"><a href="#cb59-12" aria-hidden="true" tabindex="-1"></a>root <span class="op">=</span> QgsProject.instance().layerTreeRoot()</span>
<span id="cb59-13"><a href="#cb59-13" aria-hidden="true" tabindex="-1"></a>root.insertChildNode(<span class="dv">1</span>, rastergroup)</span></code></pre></div>
<p><img src="images/pyqgis/rasterlayer.png" width="50%" style="display: block; margin: auto;" /></p>
</div>
<div id="create-a-new-vector-layer" class="section level2">
<h2>Create a New Vector Layer</h2>
<p>A simple example showing how to create a point layer with 1 feature and 1 attribute. <a href="#fn5" class="footnote-ref" id="fnref5"><sup>5</sup></a></p>
<div class="sourceCode" id="cb60"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a>vlayer <span class="op">=</span> QgsVectorLayer(<span class="st">&#39;Point?crs=EPSG:4326&#39;</span>, <span class="st">&#39;point&#39;</span>, <span class="st">&#39;memory&#39;</span>)</span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a>provider <span class="op">=</span> vlayer.dataProvider()</span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a>provider.addAttributes([QgsField(<span class="st">&#39;name&#39;</span>, QVariant.String)])</span>
<span id="cb60-5"><a href="#cb60-5" aria-hidden="true" tabindex="-1"></a>vlayer.updateFields() </span>
<span id="cb60-6"><a href="#cb60-6" aria-hidden="true" tabindex="-1"></a>f <span class="op">=</span> QgsFeature()</span>
<span id="cb60-7"><a href="#cb60-7" aria-hidden="true" tabindex="-1"></a>f.setGeometry(QgsGeometry.fromPointXY(QgsPointXY(<span class="op">-</span><span class="fl">122.41</span>, <span class="fl">37.77</span>)))</span>
<span id="cb60-8"><a href="#cb60-8" aria-hidden="true" tabindex="-1"></a>f.setAttributes([<span class="st">&#39;San Francisco&#39;</span>])</span>
<span id="cb60-9"><a href="#cb60-9" aria-hidden="true" tabindex="-1"></a>provider.addFeature(f)</span>
<span id="cb60-10"><a href="#cb60-10" aria-hidden="true" tabindex="-1"></a>vlayer.updateExtents() </span>
<span id="cb60-11"><a href="#cb60-11" aria-hidden="true" tabindex="-1"></a>QgsProject.instance().addMapLayer(vlayer)</span></code></pre></div>
</div>
<div id="saving-layers-to-disk" class="section level2">
<h2>Saving Layers to Disk</h2>
<p>Use the <code>QgsRasterFileWriter</code> or <code>QgsVectorFileWriter</code> classes for writing layers to disk. <a href="#fn6" class="footnote-ref" id="fnref6"><sup>6</sup></a></p>
<div class="sourceCode" id="cb61"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a>data_dir <span class="op">=</span> os.path.join(os.path.expanduser(<span class="st">&#39;~&#39;</span>), <span class="st">&#39;Downloads&#39;</span>, <span class="st">&#39;pyqgis_in_a_day&#39;</span>)</span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a>options <span class="op">=</span> QgsVectorFileWriter.SaveVectorOptions()</span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a>options.actionOnExistingFile <span class="op">=</span> QgsVectorFileWriter.CreateOrOverwriteLayer </span>
<span id="cb61-6"><a href="#cb61-6" aria-hidden="true" tabindex="-1"></a>options.layerName <span class="op">=</span> <span class="st">&#39;point&#39;</span></span>
<span id="cb61-7"><a href="#cb61-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-8"><a href="#cb61-8" aria-hidden="true" tabindex="-1"></a>filename <span class="op">=</span> <span class="st">&#39;sf.gpkg&#39;</span></span>
<span id="cb61-9"><a href="#cb61-9" aria-hidden="true" tabindex="-1"></a>path <span class="op">=</span> os.path.join(data_dir, filename)</span>
<span id="cb61-10"><a href="#cb61-10" aria-hidden="true" tabindex="-1"></a>QgsVectorFileWriter.writeAsVectorFormat(vlayer, path, options)</span></code></pre></div>
</div>
<div id="displaying-a-label-with-a-background-color" class="section level2">
<h2>Displaying a label with a background color</h2>
<p>This is a vast topic, but you can get a taste of the flexibility offered by the API to control all aspects of labeling. Notice the class name <code>QgsPalLayerSettings</code> - this is because QGIS uses a labeling library called <a href="http://pal.heig-vd.ch/index.php?page=about-pal">PAL</a> for labels. The code snippet below shows how to create a label for a point layer with a background color. <a href="#fn7" class="footnote-ref" id="fnref7"><sup>7</sup></a></p>
<div class="sourceCode" id="cb62"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a>vlayer <span class="op">=</span> QgsProject.instance().mapLayersByName(<span class="st">&#39;point&#39;</span>)[<span class="dv">0</span>]</span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a>symbol <span class="op">=</span> QgsMarkerSymbol.createSimple({<span class="st">&#39;name&#39;</span>: <span class="st">&#39;square&#39;</span>, <span class="st">&#39;color&#39;</span>: <span class="st">&#39;red&#39;</span>})</span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a>vlayer.renderer().setSymbol(symbol)</span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a>label_settings <span class="op">=</span> QgsPalLayerSettings()</span>
<span id="cb62-6"><a href="#cb62-6" aria-hidden="true" tabindex="-1"></a><span class="co">#label_settings.drawBackground = True</span></span>
<span id="cb62-7"><a href="#cb62-7" aria-hidden="true" tabindex="-1"></a>label_settings.fieldName <span class="op">=</span> <span class="st">&#39;name&#39;</span></span>
<span id="cb62-8"><a href="#cb62-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-9"><a href="#cb62-9" aria-hidden="true" tabindex="-1"></a>text_format <span class="op">=</span> QgsTextFormat()</span>
<span id="cb62-10"><a href="#cb62-10" aria-hidden="true" tabindex="-1"></a>background_color <span class="op">=</span> QgsTextBackgroundSettings()</span>
<span id="cb62-11"><a href="#cb62-11" aria-hidden="true" tabindex="-1"></a>background_color.setFillColor(QColor(<span class="st">&#39;white&#39;</span>))</span>
<span id="cb62-12"><a href="#cb62-12" aria-hidden="true" tabindex="-1"></a>background_color.setEnabled(<span class="va">True</span>)</span>
<span id="cb62-13"><a href="#cb62-13" aria-hidden="true" tabindex="-1"></a>text_format.setBackground(background_color )</span>
<span id="cb62-14"><a href="#cb62-14" aria-hidden="true" tabindex="-1"></a>label_settings.setFormat(text_format)</span>
<span id="cb62-15"><a href="#cb62-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-16"><a href="#cb62-16" aria-hidden="true" tabindex="-1"></a>vlayer.setLabeling(QgsVectorLayerSimpleLabeling(label_settings))</span>
<span id="cb62-17"><a href="#cb62-17" aria-hidden="true" tabindex="-1"></a>vlayer.setLabelsEnabled(<span class="va">True</span>)</span>
<span id="cb62-18"><a href="#cb62-18" aria-hidden="true" tabindex="-1"></a>vlayer.triggerRepaint()</span></code></pre></div>
<p><img src="images/pyqgis/label.png" width="75%" style="display: block; margin: auto;" /></p>
</div>
<div id="edit-attribute-table-of-a-vector-layer" class="section level2">
<h2>Edit Attribute Table of a Vector Layer</h2>
<p>When you use processing, a new layer is created by each algorithm. This example shows, how to use processing to overwrite the original layer with the results of processing.</p>
<div class="sourceCode" id="cb63"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>data_dir <span class="op">=</span> os.path.join(os.path.expanduser(<span class="st">&#39;~&#39;</span>), <span class="st">&#39;Downloads&#39;</span>, <span class="st">&#39;pyqgis_in_a_day&#39;</span>)</span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a>filename <span class="op">=</span> <span class="st">&#39;sf.gpkg|layername=blocks&#39;</span></span>
<span id="cb63-5"><a href="#cb63-5" aria-hidden="true" tabindex="-1"></a>uri <span class="op">=</span> os.path.join(data_dir, filename)</span>
<span id="cb63-6"><a href="#cb63-6" aria-hidden="true" tabindex="-1"></a>blocks <span class="op">=</span> QgsVectorLayer(uri, <span class="st">&#39;blocks&#39;</span>, <span class="st">&#39;ogr&#39;</span>)</span>
<span id="cb63-7"><a href="#cb63-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-8"><a href="#cb63-8" aria-hidden="true" tabindex="-1"></a>output <span class="op">=</span> processing.run(</span>
<span id="cb63-9"><a href="#cb63-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;qgis:deletecolumn&quot;</span>, </span>
<span id="cb63-10"><a href="#cb63-10" aria-hidden="true" tabindex="-1"></a>    {<span class="st">&#39;INPUT&#39;</span>: blocks,<span class="st">&#39;COLUMN&#39;</span>:[<span class="st">&#39;multigeom&#39;</span>],<span class="st">&#39;OUTPUT&#39;</span>:<span class="st">&#39;memory:&#39;</span>})</span>
<span id="cb63-11"><a href="#cb63-11" aria-hidden="true" tabindex="-1"></a>outputlayer <span class="op">=</span> output[<span class="st">&#39;OUTPUT&#39;</span>]</span>
<span id="cb63-12"><a href="#cb63-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-13"><a href="#cb63-13" aria-hidden="true" tabindex="-1"></a>final <span class="op">=</span> processing.run(<span class="st">&quot;qgis:fieldcalculator&quot;</span>,</span>
<span id="cb63-14"><a href="#cb63-14" aria-hidden="true" tabindex="-1"></a>    {<span class="st">&#39;INPUT&#39;</span>:outputlayer,</span>
<span id="cb63-15"><a href="#cb63-15" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;FIELD_NAME&#39;</span>:<span class="st">&#39;area&#39;</span>,</span>
<span id="cb63-16"><a href="#cb63-16" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;FIELD_TYPE&#39;</span>:<span class="dv">0</span>,</span>
<span id="cb63-17"><a href="#cb63-17" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;FIELD_LENGTH&#39;</span>:<span class="dv">10</span>,</span>
<span id="cb63-18"><a href="#cb63-18" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;FIELD_PRECISION&#39;</span>:<span class="dv">3</span>,</span>
<span id="cb63-19"><a href="#cb63-19" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;NEW_FIELD&#39;</span>:<span class="va">True</span>,</span>
<span id="cb63-20"><a href="#cb63-20" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;FORMULA&#39;</span>:<span class="st">&#39;$area&#39;</span>,</span>
<span id="cb63-21"><a href="#cb63-21" aria-hidden="true" tabindex="-1"></a>    <span class="st">&#39;OUTPUT&#39;</span>:<span class="st">&#39;memory:&#39;</span>})</span>
<span id="cb63-22"><a href="#cb63-22" aria-hidden="true" tabindex="-1"></a>finallayer <span class="op">=</span> final[<span class="st">&#39;OUTPUT&#39;</span>]</span>
<span id="cb63-23"><a href="#cb63-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-24"><a href="#cb63-24" aria-hidden="true" tabindex="-1"></a>options <span class="op">=</span> QgsVectorFileWriter.SaveVectorOptions()</span>
<span id="cb63-25"><a href="#cb63-25" aria-hidden="true" tabindex="-1"></a><span class="co"># We overwrite the original layer</span></span>
<span id="cb63-26"><a href="#cb63-26" aria-hidden="true" tabindex="-1"></a>options.layerName <span class="op">=</span> <span class="st">&#39;blocks&#39;</span></span>
<span id="cb63-27"><a href="#cb63-27" aria-hidden="true" tabindex="-1"></a>options.actionOnExistingFile <span class="op">=</span> QgsVectorFileWriter.CreateOrOverwriteLayer </span>
<span id="cb63-28"><a href="#cb63-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-29"><a href="#cb63-29" aria-hidden="true" tabindex="-1"></a>output_file <span class="op">=</span> <span class="st">&#39;sf.gpkg&#39;</span></span>
<span id="cb63-30"><a href="#cb63-30" aria-hidden="true" tabindex="-1"></a>output_path <span class="op">=</span> os.path.join(data_dir, output_file)</span>
<span id="cb63-31"><a href="#cb63-31" aria-hidden="true" tabindex="-1"></a>QgsVectorFileWriter.writeAsVectorFormat(finallayer, output_path, options)</span>
<span id="cb63-32"><a href="#cb63-32" aria-hidden="true" tabindex="-1"></a>QgsProject.instance().reloadAllLayers()</span></code></pre></div>
</div>
<div id="creating-a-pdf-with-title" class="section level2">
<h2>Creating a PDF with Title</h2>
<p><img src="images/pyqgis/layout.png" width="75%" style="display: block; margin: auto;" /></p>
<div class="sourceCode" id="cb64"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a>data_dir <span class="op">=</span> os.path.join(os.path.expanduser(<span class="st">&#39;~&#39;</span>), <span class="st">&#39;Downloads&#39;</span>, <span class="st">&#39;pyqgis_in_a_day&#39;</span>)</span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a>project <span class="op">=</span> QgsProject.instance()</span>
<span id="cb64-5"><a href="#cb64-5" aria-hidden="true" tabindex="-1"></a>extent <span class="op">=</span> QgsRectangle(<span class="op">-</span><span class="fl">122.52</span>, <span class="fl">37.71</span>, <span class="op">-</span><span class="fl">122.35</span>, <span class="fl">37.83</span>)</span>
<span id="cb64-6"><a href="#cb64-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-7"><a href="#cb64-7" aria-hidden="true" tabindex="-1"></a>layout <span class="op">=</span> QgsPrintLayout(project)</span>
<span id="cb64-8"><a href="#cb64-8" aria-hidden="true" tabindex="-1"></a>layout.initializeDefaults()</span>
<span id="cb64-9"><a href="#cb64-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-10"><a href="#cb64-10" aria-hidden="true" tabindex="-1"></a>pages <span class="op">=</span> layout.pageCollection()</span>
<span id="cb64-11"><a href="#cb64-11" aria-hidden="true" tabindex="-1"></a>pages.beginPageSizeChange()</span>
<span id="cb64-12"><a href="#cb64-12" aria-hidden="true" tabindex="-1"></a>page <span class="op">=</span> pages.page(<span class="dv">0</span>)</span>
<span id="cb64-13"><a href="#cb64-13" aria-hidden="true" tabindex="-1"></a>page.setPageSize(<span class="st">&#39;A4&#39;</span>,  QgsLayoutItemPage.Landscape)</span>
<span id="cb64-14"><a href="#cb64-14" aria-hidden="true" tabindex="-1"></a>pages.endPageSizeChange()</span>
<span id="cb64-15"><a href="#cb64-15" aria-hidden="true" tabindex="-1"></a>page_center <span class="op">=</span> page.pageSize().width() <span class="op">/</span> <span class="dv">2</span></span>
<span id="cb64-16"><a href="#cb64-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-17"><a href="#cb64-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-18"><a href="#cb64-18" aria-hidden="true" tabindex="-1"></a><span class="bu">map</span> <span class="op">=</span> QgsLayoutItemMap(layout)</span>
<span id="cb64-19"><a href="#cb64-19" aria-hidden="true" tabindex="-1"></a><span class="bu">map</span>.setRect(QRectF(<span class="op">-</span><span class="fl">122.52</span>, <span class="fl">37.71</span>, <span class="op">-</span><span class="fl">122.35</span>, <span class="fl">37.83</span>))</span>
<span id="cb64-20"><a href="#cb64-20" aria-hidden="true" tabindex="-1"></a><span class="bu">map</span>.setExtent(extent)</span>
<span id="cb64-21"><a href="#cb64-21" aria-hidden="true" tabindex="-1"></a>a4 <span class="op">=</span> QPageSize().size(QPageSize.A4, QPageSize.Millimeter)</span>
<span id="cb64-22"><a href="#cb64-22" aria-hidden="true" tabindex="-1"></a><span class="bu">map</span>.attemptResize(QgsLayoutSize(a4.height(),  a4.width()))</span>
<span id="cb64-23"><a href="#cb64-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-24"><a href="#cb64-24" aria-hidden="true" tabindex="-1"></a>layout.addItem(<span class="bu">map</span>)</span>
<span id="cb64-25"><a href="#cb64-25" aria-hidden="true" tabindex="-1"></a>title <span class="op">=</span> QgsLayoutItemLabel(layout)</span>
<span id="cb64-26"><a href="#cb64-26" aria-hidden="true" tabindex="-1"></a>title.setText(<span class="st">&#39;San Francisco&#39;</span>)</span>
<span id="cb64-27"><a href="#cb64-27" aria-hidden="true" tabindex="-1"></a>title.setFont(QFont(<span class="st">&#39;Arial&#39;</span>, <span class="dv">36</span>))</span>
<span id="cb64-28"><a href="#cb64-28" aria-hidden="true" tabindex="-1"></a>title.adjustSizeToText()</span>
<span id="cb64-29"><a href="#cb64-29" aria-hidden="true" tabindex="-1"></a>title.setReferencePoint(QgsLayoutItem.UpperMiddle)</span>
<span id="cb64-30"><a href="#cb64-30" aria-hidden="true" tabindex="-1"></a>title.attemptMove(QgsLayoutPoint(page_center, <span class="dv">10</span>))</span>
<span id="cb64-31"><a href="#cb64-31" aria-hidden="true" tabindex="-1"></a>layout.addItem(title)</span>
<span id="cb64-32"><a href="#cb64-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-33"><a href="#cb64-33" aria-hidden="true" tabindex="-1"></a>output_file <span class="op">=</span> <span class="st">&#39;sf.pdf&#39;</span></span>
<span id="cb64-34"><a href="#cb64-34" aria-hidden="true" tabindex="-1"></a>output_path <span class="op">=</span> os.path.join(data_dir, output_file)</span>
<span id="cb64-35"><a href="#cb64-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-36"><a href="#cb64-36" aria-hidden="true" tabindex="-1"></a>exporter <span class="op">=</span> QgsLayoutExporter(layout)</span>
<span id="cb64-37"><a href="#cb64-37" aria-hidden="true" tabindex="-1"></a>exporter.exportToPdf(</span>
<span id="cb64-38"><a href="#cb64-38" aria-hidden="true" tabindex="-1"></a>    output_path, QgsLayoutExporter.PdfExportSettings())</span></code></pre></div>
<p><img src="images/pyqgis/layoutpdf.png" width="75%" style="display: block; margin: auto;" /></p>
</div>
</div>
<div id="resources" class="section level1">
<h1>Resources</h1>
<ul>
<li>Official QGIS Documentation - <a href="https://docs.qgis.org/testing/en/docs/pyqgis_developer_cookbook/">PyQGIS Developer Cookbook</a></li>
<li><a href="https://anitagraser.com/pyqgis-101-introduction-to-qgis-python-programming-for-non-programmers/">PyQGIS 101: Introduction to QGIS Python programming for non-programmers</a> by Anita Graser</li>
<li><a href="https://webgeodatavore.github.io/pyqgis-samples/">PyQGIS Samples</a> by Thomas Gratier</li>
<li><a href="https://github.com/haubourg/custom-osgeo4w-qgis">Deploying a Customized Version of QGIS</a> by Régis Haubourg</li>
</ul>
</div>
<div id="data-credits" class="section level1">
<h1>Data Credits</h1>
<ul>
<li><code>blocks</code>, <code>parcels</code>, <code>streets</code>, <code>zoning</code>, <code>trees</code>, <code>seasmic_zones</code>, <code>shoreline</code>. Downloaded from <a href="https://datasf.org/opendata/">DataSF Open Data Portal</a></li>
<li><code>srtm</code> NASA Shuttle Radar Topography Mission Global 1 arc second provided by The Land Processes Distributed Active Archive Center (LP DAAC). Downloaded using <a href="https://dwtkns.com/srtm30m/">30-Meter SRTM Tile Downloader</a></li>
<li><code>aoi</code>: CA Places Boundaries from 2016 TIGER/Line Shapefiles. Downloaded from <a href="https://data.ca.gov/dataset/ca-geographic-boundaries">California Open Data Portal</a></li>
<li><code>populated_places</code>: Made with Natural Earth. Free vector and raster map data @ <a href="https://www.naturalearthdata.com/">naturalearthdata.com</a></li>
</ul>
</div>
<div id="license" class="section level1">
<h1>License</h1>
<p>This course material is licensed under a <a href="https://creativecommons.org/licenses/by-nc/4.0/">Creative Commons Attribution-NonCommercial 4.0 International License</a>. You are free to use the material for any non-commercial purpose. Kindly give appropriate credit to the original author.</p>
<p>If you would like to utilize these materials as part of a commercial offering, you can purchase a <em>Trainer License</em> for a small fee.</p>
<p>Please <a href="https://spatialthoughts.com/contact/">contact us</a> for pricing and terms. <!--
This material is part of the *Trainer's Package* and the buyer gets a non-exclusive, non-transferable, perpetual license to the material. You can fully customise and brand the materials to your requirements.
--></p>
<p>© 2020 Ujaval Gandhi <a href="https://spatialthoughts.com">www.spatialthoughts.com</a></p>
<hr />
<p><strong>This course is offered as an instructor-led online class. Visit <a href="https://spatialthoughts.com/events/">Spatial Thoughts</a> to know details of upcoming sessions.</strong></p>
</div>
<div class="footnotes">
<hr />
<ol>
<li id="fn1"><p>See <a href="https://qgis.org/api/3.4/classQgsProject.html" class="uri">https://qgis.org/api/3.4/classQgsProject.html</a><a href="#fnref1" class="footnote-back">↩︎</a></p></li>
<li id="fn2"><p>Code reference <a href="https://gis.stackexchange.com/questions/318816/add-help-menu-entry-in-qgis-3-from-startup-py" class="uri">https://gis.stackexchange.com/questions/318816/add-help-menu-entry-in-qgis-3-from-startup-py</a><a href="#fnref2" class="footnote-back">↩︎</a></p></li>
<li id="fn3"><p>Code reference: <a href="https://gis.stackexchange.com/a/340615/5160" class="uri">https://gis.stackexchange.com/a/340615/5160</a><a href="#fnref3" class="footnote-back">↩︎</a></p></li>
<li id="fn4"><p>Code reference <a href="https://github.com/qgis/QGIS/blob/8a3c7b14c367771d096b4a6d006aa3c4b1017dd5/tests/src/python/utilities.py" class="uri">https://github.com/qgis/QGIS/blob/8a3c7b14c367771d096b4a6d006aa3c4b1017dd5/tests/src/python/utilities.py</a><a href="#fnref4" class="footnote-back">↩︎</a></p></li>
<li id="fn5"><p>Code reference <a href="https://anitagraser.com/pyqgis-101-introduction-to-qgis-python-programming-for-non-programmers/pyqgis101-creating-editing-a-new-vector-layer/" class="uri">https://anitagraser.com/pyqgis-101-introduction-to-qgis-python-programming-for-non-programmers/pyqgis101-creating-editing-a-new-vector-layer/</a><a href="#fnref5" class="footnote-back">↩︎</a></p></li>
<li id="fn6"><p>Code reference <a href="https://gis.stackexchange.com/questions/285346/add-layers-to-geopackage-using-pyqgis-qgis-3" class="uri">https://gis.stackexchange.com/questions/285346/add-layers-to-geopackage-using-pyqgis-qgis-3</a><a href="#fnref6" class="footnote-back">↩︎</a></p></li>
<li id="fn7"><p>Code reference <a href="https://gis.stackexchange.com/questions/292136/qgspallayersettings-error/294019" class="uri">https://gis.stackexchange.com/questions/292136/qgspallayersettings-error/294019</a><a href="#fnref7" class="footnote-back">↩︎</a></p></li>
</ol>
</div>

<div id="disqus_thread" class="standardPadding"></div>

<!-- disqus -->
<script>

/**
*  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
*  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/
/*
var disqus_config = function () {
this.page.url = 'https://courses.spatialthoughts.com' + location.pathname;  // Replace PAGE_URL with your page's canonical URL variable
this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
};
*/
(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');
s.src = 'https://spatialthoughts.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
                            



</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.odd').parent('tbody').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open');
  });
});
</script>

<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
