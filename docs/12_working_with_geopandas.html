<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />




<title></title>

<script src="site_libs/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/flatly.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<link href="site_libs/highlightjs-9.12.0/default.css" rel="stylesheet" />
<script src="site_libs/highlightjs-9.12.0/highlight.js"></script>
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-172372432-3"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-172372432-3');
</script>

<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>
<script type="text/javascript">
if (window.hljs) {
  hljs.configure({languages: []});
  hljs.initHighlightingOnLoad();
  if (document.readyState && document.readyState === "complete") {
    window.setTimeout(function() { hljs.initHighlighting(); }, 0);
  }
}
</script>



<style type="text/css">
h1 {
  font-size: 34px;
}
h1.title {
  font-size: 38px;
}
h2 {
  font-size: 30px;
}
h3 {
  font-size: 24px;
}
h4 {
  font-size: 18px;
}
h5 {
  font-size: 16px;
}
h6 {
  font-size: 12px;
}
.table th:not([align]) {
  text-align: left;
}
</style>




<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
</style>


<style type="text/css">
/* padding for bootstrap navbar */
body {
  padding-top: 60px;
  padding-bottom: 40px;
}
/* offset scroll position for anchor links (for fixed navbar)  */
.section h1 {
  padding-top: 65px;
  margin-top: -65px;
}
.section h2 {
  padding-top: 65px;
  margin-top: -65px;
}
.section h3 {
  padding-top: 65px;
  margin-top: -65px;
}
.section h4 {
  padding-top: 65px;
  margin-top: -65px;
}
.section h5 {
  padding-top: 65px;
  margin-top: -65px;
}
.section h6 {
  padding-top: 65px;
  margin-top: -65px;
}
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #ffffff;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script>
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.parent().addClass('active');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  background: white;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "&#xe258;";
  border: none;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->




</head>

<body>


<div class="container-fluid main-container">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">Courses</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="http://spatialthoughts.com">Back to Main Site</a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div class="fluid-row" id="header">




</div>


<div id="working-with-geopandas" class="section level1">
<h1>Working with Geopandas</h1>
<p>GeoPandas extends the Pandas library to enable spatial operations. It provides new data types such as <strong>GeoDataFrame</strong> and <strong>GeoSeries</strong> which are subclasses of Pandas <strong>DataFrame</strong> and <strong>Series</strong> and enables efficient vector data processing in Python.</p>
<p>GeoPandas make use of many other widely used spatial libraries - but it provides an interface similar to Pandas that make it intuitive to use it with spatial analysis. GeoPandas is built on top of the following libraries that allow it to be spatially aware.</p>
<ul>
<li><a href="https://shapely.readthedocs.io/en/latest/manual.html">Shapely</a> for geometric operations (i.e. buffer, intersections etc.)</li>
<li><a href="https://pyproj4.github.io/pyproj/stable/index.html">PyProj</a> for working with projections</li>
<li><a href="https://pypi.org/project/Fiona/">Fiona</a> for file input and output, which itself is based on the widely used <a href="https://gdal.org/">GDAL/OGR</a> library</li>
</ul>
<p>We will carry out a geoprocessing task that shows various features of this library and show how to do geo data processing in Python. The task is to take a roads data layer from OpenStreetMap and compute the total length of National Highways for each district in a state. The problem is described in detail in my <a href="https://courses.spatialthoughts.com/advanced-qgis.html#exercise-find-the-length-of-national-highways-in-a-state">Advanced QGIS</a> course and show the steps needed to perform this analysis in QGIS. We will replicate this example in Python.</p>
<div class="figure">
<img src="images/python_foundation/karnataka.png" />

</div>
<p>By convention, <code>geopandas</code> is commonly imported as <code>gpd</code></p>
<pre class="python"><code>import geopandas as gpd</code></pre>
<div id="reading-spatial-data" class="section level2">
<h2>Reading Spatial Data</h2>
<pre class="python"><code>import os
data_pkg_path = &#39;data&#39;
filename = &#39;karnataka.gpkg&#39;
path = os.path.join(data_pkg_path, filename)</code></pre>
<p>GeoPandas has a <code>read_file()</code> method that is able to open a wide variety of vector datasets, including zip files. Here we will open the GeoPackage <code>karnataka.gpkg</code> and read a layer called <code>karnataka_major_roads</code>. The result of the read method is a <strong>GeoDataFrame</strong>.</p>
<pre class="python"><code>roads_gdf = gpd.read_file(path, layer=&#39;karnataka_major_roads&#39;)
print(roads_gdf.info())</code></pre>
<pre><code>&lt;class &#39;geopandas.geodataframe.GeoDataFrame&#39;&gt;
RangeIndex: 44606 entries, 0 to 44605
Data columns (total 11 columns):
 #   Column    Non-Null Count  Dtype   
---  ------    --------------  -----   
 0   osm_id    44606 non-null  object  
 1   code      44606 non-null  int64   
 2   fclass    44606 non-null  object  
 3   name      7018 non-null   object  
 4   ref       7702 non-null   object  
 5   oneway    44606 non-null  object  
 6   maxspeed  44606 non-null  int64   
 7   layer     44606 non-null  int64   
 8   bridge    44606 non-null  object  
 9   tunnel    44606 non-null  object  
 10  geometry  44606 non-null  geometry
dtypes: geometry(1), int64(3), object(7)
memory usage: 3.7+ MB
None</code></pre>
<p>A GeoDataFrame contains a special column called <em>geometry</em>. All spatial operations on the GeoDataFrame are applied to the geomety column. The geometry column can be accessed using the <code>geometry</code> attribute.</p>
<pre class="python"><code>print(roads_gdf.geometry)</code></pre>
<pre><code>0        MULTILINESTRING ((77.59928 12.97672, 77.59950 ...
1        MULTILINESTRING ((76.65944 12.31809, 76.65904 ...
2        MULTILINESTRING ((76.65906 12.31389, 76.65912 ...
3        MULTILINESTRING ((76.65600 12.30895, 76.65646 ...
4        MULTILINESTRING ((76.65615 12.30989, 76.65600 ...
                               ...                        
44601    MULTILINESTRING ((77.60806 12.97517, 77.60797 ...
44602    MULTILINESTRING ((77.60798 12.97519, 77.60806 ...
44603    MULTILINESTRING ((77.57115 13.00849, 77.57156 ...
44604    MULTILINESTRING ((77.70140 12.95693, 77.70164 ...
44605    MULTILINESTRING ((77.61040 12.97360, 77.61052 ...
Name: geometry, Length: 44606, dtype: geometry</code></pre>
</div>
<div id="filtering-data" class="section level2">
<h2>Filtering Data</h2>
<p>One can use the standard Pandas filtering methods to select a subset of the GeoDataFrame. In addition, GeoPandas also provide way to subset the data based on a bounding box with the <a href="https://geopandas.readthedocs.io/en/latest/indexing.html"><code>cx[]</code> indexer</a>.</p>
<p>For our analysis, we need to apply a filter to extract only the road segments where the <code>ref</code> attribute starts with <strong>‘NH’</strong> - indicating a national highway. We can apply boolean filtering using Panda’s <code>str.match()</code> method with a regular expression.</p>
<pre class="python"><code>filtered = roads_gdf[roads_gdf[&#39;ref&#39;].str.match(&#39;^NH&#39;) == True]
print(filtered.head())</code></pre>
<pre><code>      osm_id  code fclass                        name    ref oneway  maxspeed  \
17   8684837  5112  trunk  Bengaluru - Mangaluru Road  NH373      F         0   
26   9951034  5112  trunk                        None  NH948      B        50   
54  22838314  5112  trunk   Solapur-Mangalore Highway  NH169      B         0   
55  22838318  5112  trunk                        None   NH66      B         0   
56  22838318  5112  trunk                        None   NH66      B         0   

    layer bridge tunnel                                           geometry  
17      0      F      F  MULTILINESTRING ((76.10024 13.00326, 76.09950 ...  
26      0      F      F  MULTILINESTRING ((77.16472 12.24774, 77.16416 ...  
54      0      F      F  MULTILINESTRING ((74.86387 12.88387, 74.86419 ...  
55      0      F      F  MULTILINESTRING ((74.78756 13.09142, 74.78744 ...  
56      0      F      F  MULTILINESTRING ((74.78767 13.09723, 74.78767 ...  </code></pre>
</div>
<div id="working-with-projections" class="section level2">
<h2>Working with Projections</h2>
<p>Dealing with projetions is a key aspect of working with spatial data. GeoPandas uses the <code>pyproj</code> library to assign and manage projections. Each GeoDataFrame as a <code>crs</code> attribute that contains the projection info. Our source dataset is in EPSG:4326 WGS84 CRS.</p>
<pre class="python"><code>print(filtered.crs)</code></pre>
<pre><code>epsg:4326</code></pre>
<p>Since our task is to compute line lengths, we need to use a Projected CRS. We can use the <code>to_crs()</code> method to reproject the GeoDataFrame.</p>
<pre class="python"><code>roads_reprojected = filtered.to_crs(&#39;EPSG:32643&#39;)
print(roads_reprojected.crs)</code></pre>
<pre><code>EPSG:32643</code></pre>
<p>Now that the layer has been reprojected, we can calculate the length of each geometry using the <code>length</code> attribute. The result would be in meters. We can add the line lengths in a new column named <code>length</code>.</p>
<pre class="python"><code>roads_reprojected[&#39;length&#39;] = roads_reprojected[&#39;geometry&#39;].length</code></pre>
<p>We can apply statistical operations on a DataFrame columns. Here we can compute the total length of national highways in the state by calling the <code>sum()</code> method.</p>
<pre class="python"><code>total_length = roads_reprojected[&#39;length&#39;].sum()
print(&#39;Total length of national highways in the state is {} KM&#39;.format(total_length/1000))</code></pre>
<pre><code>Total length of national highways in the state is 8616.166058402967 KM</code></pre>
</div>
<div id="performing-spatial-joins" class="section level2">
<h2>Performing Spatial joins</h2>
<p>There are two ways to combine datasets in geopandas – table joins and spatial joins. For our task, we need information about which district each road segments belongs to. This can be achived using another spatial layer for the districts and doing a spatial join to transfer the attributes of the district layer to the matching road segment.</p>
<p>The <code>karnataka.gpkg</code> contains a layer called <code>karnataka_districts</code> with the district boundaries and names.</p>
<pre class="python"><code>districts_gdf = gpd.read_file(path, layer=&#39;karnataka_districts&#39;)
print(districts_gdf.head())</code></pre>
<pre><code>          DISTRICT      ST_NM  ST_CEN_CD  DT_CEN_CD  censuscode  \
0         Bagalkot  Karnataka         29          2         556   
1  Bangalore Rural  Karnataka         29         29         583   
2        Bangalore  Karnataka         29         18         572   
3          Belgaum  Karnataka         29          1         555   
4          Bellary  Karnataka         29         11         565   

                                            geometry  
0  MULTIPOLYGON (((76.24100 16.16531, 76.23538 16...  
1  MULTIPOLYGON (((77.38701 13.50002, 77.40099 13...  
2  MULTIPOLYGON (((77.83549 12.86809, 77.83213 12...  
3  MULTIPOLYGON (((75.02647 16.93264, 75.02827 16...  
4  MULTIPOLYGON (((77.15757 15.13706, 77.15887 15...  </code></pre>
<p>Before joining this layer to the roads, we must reproject it to match the CRS of the roads layer.</p>
<pre class="python"><code>districts_reprojected = districts_gdf.to_crs(&#39;EPSG:32643&#39;)</code></pre>
<p>A spatial join is performed using the <code>sjoin()</code> method. It takes 2 core arguments.</p>
<ul>
<li><code>op</code>: The spatial predicate to decdie which objects to join. Options are <em>intersects</em>, <em>within</em> and <em>contains</em>.</li>
<li><code>how</code>: The type of join to perform. Options are <em>left</em>, <em>right</em> and <em>inner</em>.</li>
</ul>
<p>For our task, we can do a <em>left</em> join and add attributes of the district that <em>intersect</em> the road.</p>
<pre class="python"><code>joined = gpd.sjoin(roads_reprojected, districts_reprojected, how=&#39;left&#39;, op=&#39;intersects&#39;)
print(joined.head())</code></pre>
<pre><code>      osm_id  code fclass                        name    ref oneway  maxspeed  \
17   8684837  5112  trunk  Bengaluru - Mangaluru Road  NH373      F         0   
26   9951034  5112  trunk                        None  NH948      B        50   
54  22838314  5112  trunk   Solapur-Mangalore Highway  NH169      B         0   
55  22838318  5112  trunk                        None   NH66      B         0   
55  22838318  5112  trunk                        None   NH66      B         0   

    layer bridge tunnel                                           geometry  \
17      0      F      F  MULTILINESTRING ((619317.005 1437753.696, 6192...   
26      0      F      F  MULTILINESTRING ((735483.761 1354892.067, 7354...   
54      0      F      F  MULTILINESTRING ((485231.162 1424297.721, 4852...   
55      0      F      F  MULTILINESTRING ((476971.413 1447255.675, 4769...   
55      0      F      F  MULTILINESTRING ((476971.413 1447255.675, 4769...   

          length  index_right          DISTRICT      ST_NM  ST_CEN_CD  \
17   2352.939132         16.0            Hassan  Karnataka       29.0   
26  12876.925507          7.0      Chamrajnagar  Karnataka       29.0   
54    822.021433         11.0  Dakshina Kannada  Karnataka       29.0   
55    648.925208         11.0  Dakshina Kannada  Karnataka       29.0   
55    648.925208         27.0             Udupi  Karnataka       29.0   

    DT_CEN_CD  censuscode  
17       20.0       574.0  
26       24.0       578.0  
54       21.0       575.0  
55       21.0       575.0  
55       15.0       569.0  </code></pre>
</div>
<div id="group-statistics" class="section level2">
<h2>Group Statistics</h2>
<p>The resulting geodataframe now has the matching column from the intersecting district feature. We can now sum the length of the roads and group them by districts. This type of <em>Group Statistics</em> is performed using Panda’s <code>group_by()</code> method.</p>
<pre class="python"><code>results = joined.groupby(&#39;DISTRICT&#39;)[&#39;length&#39;].sum()/1000
print(results)</code></pre>
<pre><code>DISTRICT
Bagalkot            258.449475
Bangalore           311.445505
Bangalore Rural     320.036790
Belgaum             528.922528
Bellary             304.789522
Bidar               247.348300
Bijapur             424.197281
Chamrajnagar        217.737255
Chikkaballapura     211.957819
Chikmagalur         334.423573
Chitradurga         531.932443
Dakshina Kannada    316.339566
Davanagere          177.877407
Dharwad             314.978752
Gadag               111.548768
Gulbarga            294.551578
Hassan              436.231356
Haveri              306.582730
Kodagu               63.806864
Kolar               221.598406
Koppal              288.358711
Mandya              337.617829
Mysore              359.862216
Raichur             167.746669
Ramanagara          199.426362
Shimoga             479.140995
Tumkur              613.177564
Udupi               277.331577
Uttara Kannada      424.184040
Yadgir              144.858328
Name: length, dtype: float64</code></pre>
<p>The result of the <code>group_by()</code> method is a Pandas <em>Series</em>. It can be saved to a CSV file using the <code>to_csv()</code> method.</p>
<pre class="python"><code>output_filename = &#39;national_highways_by_districts.csv&#39;
output_dir = &#39;output&#39;
output_path = os.path.join(output_dir, output_filename)
results.to_csv(output_path)
print(&#39;Successfully written output file at {}&#39;.format(output_path))</code></pre>
<pre><code>Successfully written output file at output/national_highways_by_districts.csv</code></pre>
</div>
<div id="exercise" class="section level2">
<h2>Exercise</h2>
<p>Before writing the output to the file, round the distance numbers to a whole number.</p>
<hr />
</div>
</div>




</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.header').parent('thead').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open')
  });
});
</script>

<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
