<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />


<meta name="author" content="Ujaval Gandhi" />


<title>Advanced QGIS (Full Course)</title>

<script src="site_libs/header-attrs-2.29/header-attrs.js"></script>
<script src="site_libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/flatly.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<style>h1 {font-size: 34px;}
       h1.title {font-size: 38px;}
       h2 {font-size: 30px;}
       h3 {font-size: 24px;}
       h4 {font-size: 18px;}
       h5 {font-size: 16px;}
       h6 {font-size: 12px;}
       code {color: inherit; background-color: rgba(0, 0, 0, 0.04);}
       pre:not([class]) { background-color: white }</style>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<link href="site_libs/pagedtable-1.1/css/pagedtable.css" rel="stylesheet" />
<script src="site_libs/pagedtable-1.1/js/pagedtable.js"></script>
<style>
.copy-btn {
  position: absolute;
  top: 5px;
  right: 5px;
  padding: 4px 8px;
  font-size: 18px;
  background: #969696;
  color: white;
  border: none;
  border-radius: 3px;
  cursor: pointer;
  opacity: 0.7;
  transition: opacity 0.3s;
}

.copy-btn:hover {
  opacity: 1;
}

.copy-btn.copied {
  background: #636363;
}

pre {
  position: relative;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Find all code blocks
  const codeBlocks = document.querySelectorAll('pre code');
  
  codeBlocks.forEach(function(codeBlock) {
    const pre = codeBlock.parentElement;
    
    // Create copy button
    const button = document.createElement('button');
    button.className = 'copy-btn';
    button.textContent = '⎘';
    
    // Add button to pre element
    pre.appendChild(button);
    
    // Add click event
    button.addEventListener('click', function() {
      // Create temporary textarea to copy text
      const textarea = document.createElement('textarea');
      textarea.value = codeBlock.textContent;
      document.body.appendChild(textarea);
      textarea.select();
      document.execCommand('copy');
      document.body.removeChild(textarea);
      
      // Update button text
      button.textContent = 'Copied!';
      button.classList.add('copied');
      
      // Reset button after 2 seconds
      setTimeout(function() {
        button.textContent = '⎘';
        button.classList.remove('copied');
      }, 2000);
    });
  });
});
</script>

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>










<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
details > summary > p:only-child {
  display: inline;
}
pre code {
  padding: 0;
}
</style>


<style type="text/css">
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #adb5bd;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script type="text/javascript">
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark the anchor link active (and if it's in a dropdown, also mark that active)
  var dropdown = menuAnchor.closest('li.dropdown');
  if (window.bootstrap) { // Bootstrap 4+
    menuAnchor.addClass('active');
    dropdown.find('> .dropdown-toggle').addClass('active');
  } else { // Bootstrap 3
    menuAnchor.parent().addClass('active');
    dropdown.addClass('active');
  }

  // Navbar adjustments
  var navHeight = $(".navbar").first().height() + 15;
  var style = document.createElement('style');
  var pt = "padding-top: " + navHeight + "px; ";
  var mt = "margin-top: -" + navHeight + "px; ";
  var css = "";
  // offset scroll position for anchor links (for fixed navbar)
  for (var i = 1; i <= 6; i++) {
    css += ".section h" + i + "{ " + pt + mt + "}\n";
  }
  style.innerHTML = "body {" + pt + "padding-bottom: 40px; }\n" + css;
  document.head.appendChild(style);
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before, .tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "\e259";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "\e258";
  font-family: 'Glyphicons Halflings';
  border: none;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->




</head>

<body>


<div class="container-fluid main-container">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-bs-toggle="collapse" data-target="#navbar" data-bs-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">Courses</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="http://spatialthoughts.com">Back to Main Site</a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li>
  <a href="#">Back to Top</a>
</li>
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div id="header">



<h1 class="title toc-ignore">Advanced QGIS (Full Course)</h1>
<h3 class="subtitle">Learn Techniques for Automating GIS Workflows and
Advanced Visualizations.</h3>
<h4 class="author">Ujaval Gandhi</h4>

</div>

<div id="TOC">
<ul>
<li><a href="#introduction" id="toc-introduction">Introduction</a></li>
<li><a href="#software" id="toc-software">Software</a></li>
<li><a href="#get-the-data-package" id="toc-get-the-data-package">Get
the Data Package</a></li>
<li><a href="#get-the-course-videos" id="toc-get-the-course-videos">Get
the Course Videos</a>
<ul>
<li><a href="#youtube" id="toc-youtube">YouTube</a></li>
<li><a href="#vimeo" id="toc-vimeo">Vimeo</a></li>
</ul></li>
<li><a href="#concept-processing-framework"
id="toc-concept-processing-framework">Concept: Processing
Framework</a></li>
<li><a href="#using-processing-toolbox"
id="toc-using-processing-toolbox">1. Using Processing Toolbox</a>
<ul>
<li><a href="#extract-transform-and-load"
id="toc-extract-transform-and-load">1.1 Extract, Transform and Load</a>
<ul>
<li><a href="#challenge" id="toc-challenge">1.1.1 Challenge</a></li>
</ul></li>
<li><a href="#spatial-join-and-summary-statistics"
id="toc-spatial-join-and-summary-statistics">1.2 Spatial Join and
Summary Statistics</a>
<ul>
<li><a href="#challenge-1" id="toc-challenge-1">1.2.1 Challenge</a></li>
</ul></li>
</ul></li>
<li><a href="#batch-processing" id="toc-batch-processing">2. Batch
Processing</a>
<ul>
<li><a href="#clip-multiple-layers" id="toc-clip-multiple-layers">2.1
Clip Multiple Layers</a>
<ul>
<li><a href="#challenge-2" id="toc-challenge-2">2.1.1 Challenge</a></li>
</ul></li>
</ul></li>
<li><a href="#model-designer" id="toc-model-designer">3. Model
Designer</a>
<ul>
<li><a href="#workflow-automation" id="toc-workflow-automation">3.1
Workflow Automation</a>
<ul>
<li><a href="#challenge-3" id="toc-challenge-3">3.1.1 Challenge</a></li>
</ul></li>
<li><a href="#concept-spatial-indexing"
id="toc-concept-spatial-indexing">Concept: Spatial Indexing</a></li>
<li><a href="#using-spatial-index" id="toc-using-spatial-index">3.2
Using Spatial Index</a>
<ul>
<li><a href="#challenge-4" id="toc-challenge-4">3.2.1 Challenge</a></li>
</ul></li>
<li><a href="#enabling-reproducible-workflows"
id="toc-enabling-reproducible-workflows">3.3 Enabling Reproducible
Workflows</a></li>
</ul></li>
<li><a href="#assignment" id="toc-assignment">Assignment</a></li>
<li><a href="#d-animations" id="toc-d-animations">4. 2D Animations</a>
<ul>
<li><a href="#animated-temporal-navigation"
id="toc-animated-temporal-navigation">4.1 Animated Temporal
Navigation</a>
<ul>
<li><a href="#challenge-4.1.1" id="toc-challenge-4.1.1">Challenge
4.1.1</a></li>
</ul></li>
<li><a href="#exporting-animation" id="toc-exporting-animation">4.2
Exporting Animation</a>
<ul>
<li><a href="#animation-using-ezgif.com"
id="toc-animation-using-ezgif.com">4.2.1 Animation using
EzGIF.com</a></li>
<li><a href="#animation-using-imagemagick"
id="toc-animation-using-imagemagick">4.2.2 Animation using
ImageMagick</a></li>
<li><a href="#challenge-4.2.1" id="toc-challenge-4.2.1">Challenge
4.2.1</a></li>
</ul></li>
<li><a href="#animating-gps-tracks" id="toc-animating-gps-tracks">4.3
Animating GPS Tracks</a>
<ul>
<li><a href="#collecting-a-gps-track"
id="toc-collecting-a-gps-track">4.3.1 Collecting a GPS Track</a></li>
<li><a href="#loading-a-basemap" id="toc-loading-a-basemap">4.3.2
Loading a Basemap</a></li>
<li><a href="#visualizing-and-creating-animation"
id="toc-visualizing-and-creating-animation">4.3.3 Visualizing and
Creating Animation</a></li>
<li><a href="#placing-labels-on-animation"
id="toc-placing-labels-on-animation">4.3.4 Placing Labels on
Animation</a></li>
</ul></li>
<li><a href="#learn-more" id="toc-learn-more">4.4 Learn more</a></li>
</ul></li>
<li><a href="#d-animations-1" id="toc-d-animations-1">5. 3D
Animations</a>
<ul>
<li><a href="#create-a-3d-visualization"
id="toc-create-a-3d-visualization">5.1 Create a 3D
Visualization</a></li>
<li><a href="#create-a-3d-fly-through"
id="toc-create-a-3d-fly-through">5.2 Create a 3D Fly-through</a>
<ul>
<li><a href="#challenge-5" id="toc-challenge-5">5.2.1 Challenge</a></li>
</ul></li>
</ul></li>
<li><a href="#summary-aggregate-expressions"
id="toc-summary-aggregate-expressions">6. Summary Aggregate
Expressions</a>
<ul>
<li><a href="#auto-populate-field-values"
id="toc-auto-populate-field-values">6.1 Auto-populate Field Values</a>
<ul>
<li><a href="#challenge-6" id="toc-challenge-6">6.1.1 Challenge</a></li>
</ul></li>
<li><a href="#learn-more-1" id="toc-learn-more-1">6.2 Learn
more</a></li>
</ul></li>
<li><a href="#useful-plugins" id="toc-useful-plugins">7. Useful
Plugins</a></li>
<li><a href="#supplement" id="toc-supplement">Supplement</a>
<ul>
<li><a href="#using-conditions-in-modeler"
id="toc-using-conditions-in-modeler">Using Conditions in
Modeler</a></li>
<li><a href="#running-processing-algorithms-from-the-locator-bar"
id="toc-running-processing-algorithms-from-the-locator-bar">Running
Processing Algorithms from the Locator Bar</a></li>
<li><a href="#in-place-editing" id="toc-in-place-editing">In-place
Editing</a></li>
</ul></li>
<li><a href="#data-credits" id="toc-data-credits">Data Credits</a></li>
<li><a href="#license" id="toc-license">License</a></li>
</ul>
</div>

<div style="page-break-after: always;"></div>
<hr />
<p><img src="images/spatial_thoughts_logo.png" width="250pt" style="display: block; margin: auto;" /></p>
<hr />
<div style="page-break-after: always;"></div>
<div id="introduction" class="section level1">
<h1>Introduction</h1>
<p>This class focuses on techniques for the automation of GIS workflows.
You will learn techniques that will help you be more productive, create
beautiful visualizations and solve complex spatial analysis problems.
This class is ideal for participants who already use QGIS and want to
take their skills to the next level.</p>
<p>Below are the topics covered in this class</p>
<ul>
<li>Processing Framework - Algorithms, Batch processing, and
Modeler</li>
<li>Animating time-series data</li>
<li>Creating 3D fly-through from aerial imagery</li>
<li>Advanced Expressions for enabling faster data editing, fuzzy
matching, and more.</li>
</ul>
<p>Before we do the exercises, it will help you to learn a bit more
about open-source and how the QGIS project operates.</p>
<p><a
href="https://www.youtube.com/watch?v=ny-rH9FBpn8&amp;list=PLppGmFLhQ1HIqNiNWxVqs5wBLiA_UrKTQ&amp;index=1"
target="_blank"><img
src="https://img.youtube.com/vi/ny-rH9FBpn8/mqdefault.jpg"
alt="Watch the video" /></a></p>
<p><a
href="https://www.youtube.com/watch?v=ny-rH9FBpn8&amp;list=PLppGmFLhQ1HIqNiNWxVqs5wBLiA_UrKTQ&amp;index=1"
target="_blank">Watch the Video ↗</a></p>
<p><a
href="https://docs.google.com/presentation/d/13R-RbR5LJmBr5F-VAN0OXh7fRxRC8olFIl2yrOFgG-w/edit?usp=sharing"
target="_blank">Access the Presentation ↗</a></p>
</div>
<div id="software" class="section level1">
<h1>Software</h1>
<p>This course requires QGIS LTR version 3.34.</p>
<p>Please review <a href="install-qgis-ltr.html">QGIS-LTR Installation
Guide</a> for step-by-step instructions.</p>
</div>
<div id="get-the-data-package" class="section level1">
<h1>Get the Data Package</h1>
<p>The examples in this class use a variety of datasets. All the
required layers, project files etc. are supplied to you in the
<code>advanced_qgis.zip</code> file along with your class materials.
Unzip this file to the <code>Downloads</code> directory.</p>
<p>Download <a
href="https://storage.googleapis.com/spatialthoughts-public-data/course_data_packages/advanced_qgis.zip">advanced_qgis.zip</a>.</p>
<blockquote>
<p>Note: Certification and Support are only available for participants
in our paid instructor-led classes.</p>
</blockquote>
</div>
<div id="get-the-course-videos" class="section level1">
<h1>Get the Course Videos</h1>
<p>The course is accompanied by a set of videos covering the all the
modules. These videos are recorded from our live instructor-led classes
and are edited to make them easier to consume for self-study. We have 2
versions of the videos:</p>
<div id="youtube" class="section level2">
<h2>YouTube</h2>
<p>We have created a YouTube Playlist with separate videos for each
section and exercise to enable effective online-learning. <a
href="https://www.youtube.com/playlist?list=PLppGmFLhQ1HIqNiNWxVqs5wBLiA_UrKTQ"
target="_blank">Access the YouTube Playlist ↗</a></p>
</div>
<div id="vimeo" class="section level2">
<h2>Vimeo</h2>
<p>We are also making combined full-length video for each module
available on Vimeo. These videos can be downloaded for offline learning.
<a href="https://vimeo.com/showcase/11232120" target="_blank">Access the
Vimeo Playlist ↗</a></p>
</div>
</div>
<div id="concept-processing-framework" class="section level1">
<h1>Concept: Processing Framework</h1>
<p>QGIS 2.0 introduced a new concept called Processing Framework.
Previously known as Sextante, the Processing Framework provides an
environment within QGIS to run native and third-party algorithms for
processing data. It is now the recommended way to run any type of data
processing and analysis within QGIS - including tasks such as selecting
features, altering attributes, saving layers etc. - that can be
accomplished by other means. But leveraging the processing framework
allows you to be more productive, fast, and less error-prone.</p>
<p>The Processing Framework consists of the following distinct elements
that work together.</p>
<ul>
<li><strong>Processing Toolbox</strong>: Contains individual tools
(i.e. algorithms) grouped by providers and functionality. There are
hundreds of algorithms available out of the box. They are organized by
<em>Providers</em>. The tools created by QGIS developers are available
as a <strong>Native</strong> QGIS provider. Processing Framework
providers an easy way to integrate tools written by other software and
libraries such as GDAL, GRASS, and SAGA. QGIS Plugins can also add new
functionality via processing algorithms in the toolbox.<br />
</li>
<li><strong>Batch Processing Interface</strong>: Allows any processing
tool to be executed on multiple layers together.</li>
<li><strong>Model Designer</strong>: This allows the user to define the
workflow and chain multiple processing steps together using a
drag-and-drop mechanism.</li>
<li><strong>History Manager</strong>: Records and stores all executions
of algorithms to allow users to reproduce the past analysis.</li>
<li><strong>Results Viewer</strong>: An interface to view non-spatial
outputs from algorithms - such as tables and charts.</li>
</ul>
<p><a
href="https://docs.google.com/presentation/d/1Vej8xgY710C-dsxneVXO_6UkXNkcIrYukzgJqxI2j3k/edit?usp=sharing"
target="_blank"><img src="images/advanced_qgis/processing.png"
width="400" alt="View Presentation" /></a></p>
<p><a
href="https://docs.google.com/presentation/d/1Vej8xgY710C-dsxneVXO_6UkXNkcIrYukzgJqxI2j3k/edit?usp=sharing"
target="_blank">View the Presentation</a></p>
<p>We will learn about each of these through hands-on exercises in the
following sections.</p>
</div>
<div id="using-processing-toolbox" class="section level1">
<h1>1. Using Processing Toolbox</h1>
<p>This exercise aims is to show how a multi-step spatial analysis
problem can be solved using a purely processing-based workflow. This
exercise also shows the richness of available algorithms in QGIS that
can do sophisticated operations that previously needed plugins or were
more complex.</p>
<p>We will work with roads extracted from OpenStreetMap for the state of
Karnataka in India. The admin boundary for the state and the districts
come from DataMeet.</p>
<div id="extract-transform-and-load" class="section level2">
<h2>1.1 Extract, Transform and Load</h2>
<p>We will learn about some useful processing algorithms for basic data
processing operations such as Extract, Transform and Load (ETL). Our
goal for this section is to read a road layer and a boundary layer from
a GeoPackage and calculate what is the total length of the national
highways in a state. We will also see how to append the resulting layer
to same GeoPackage.</p>
<ol style="list-style-type: decimal">
<li>Browse to the data directory and expand <code>karnataka.gpkg</code>.
Drag and drop the <code>karnataka</code>,
<code>karnataka_districts</code> and <code>karnataka_major_roads</code>
layers to the canvas.</li>
</ol>
<p><img src="images/advanced_qgis/karnataka1.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="2" style="list-style-type: decimal">
<li>The layer <code>karnataka_major_roads</code> contain all major
roads, including national highways, state highways, major arterial roads
etc. Select the layer and use the keyboard shortcut <strong>F6</strong>
to open the attribute table.</li>
</ol>
<p><img src="images/advanced_qgis/karnataka2.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="3" style="list-style-type: decimal">
<li>You will notice that the <code>ref</code> column has information
about road designation. As we are interested in only national highways,
we can use the information in this column to extract relevant road
segments.</li>
</ol>
<p><img src="images/advanced_qgis/karnataka3.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="4" style="list-style-type: decimal">
<li>You can use tools such as <em>Select by expression</em>, export the
selected features as a new layer and continue to work. But the
processing toolbox providers a much seamless workflow. Search for the
algorithm <strong>Extract by expression</strong>.</li>
</ol>
<p><img src="images/advanced_qgis/karnataka4.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="5" style="list-style-type: decimal">
<li>Enter the following expression to extract the features where the
value of the <code>ref</code> field starts with the letters
<code>NH</code>.</li>
</ol>
<blockquote>
<p>We are using <em>Regular Expression (or RegEx)</em> to match the
field value to a specific pattern. Regular expressions are quite
powerful and can be used for many complex data filtering operations. <a
href="https://medium.com/factory-mind/regex-tutorial-a-simple-cheatsheet-by-examples-649dc1c3f285">Here’s
a good tutorial</a> that explains the basics of regular expressions.</p>
</blockquote>
<pre><code>regexp_match(&quot;ref&quot;, &#39;^NH&#39;)</code></pre>
<p><img src="images/advanced_qgis/karnataka5.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="6" style="list-style-type: decimal">
<li>You will get a new layer <code>Matching Features</code> in the
Layers Panel. Next, we want to calculate the length of each segment. You
can use the built-in algorithm <strong>Add geometry
attributes</strong></li>
</ol>
<p><img src="images/advanced_qgis/karnataka6.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="7" style="list-style-type: decimal">
<li>The source layer is in the Geographic CRS EPSG:4326. But for the
analysis, we want the lengths to be measured in meters/kilometers. The
algorithm provides us with a handy option to calculate the distances in
<strong>Elliposidal</strong> math - which is ideal for layers in the
geographic CRS.</li>
</ol>
<p><img src="images/advanced_qgis/karnataka7.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="8" style="list-style-type: decimal">
<li>A new layer with an additional field called <code>length</code> will
be added to the Layers panel. The distances in this field are in meters.
Let’s convert them to kilometers. You may reach out to the trusty QGIS
field calculator to add a new field. That’s a perfectly valid way - but
as mentioned earlier, there is a <em>processing</em> way to do things
which is the preferred way. Search and open the <strong>Field
Calculator</strong> processing algorithm instead and enter the following
expression.</li>
</ol>
<pre><code>&quot;length&quot;/1000</code></pre>
<p><img src="images/advanced_qgis/karnataka8.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="9" style="list-style-type: decimal">
<li>A new layer with the field <code>length_km</code> will be added to
the Layers panel. Now we are ready to find out the answer. We just need
to sum up the values in the <code>length_km</code> field. Use the
<strong>Basic Statistics for Fields</strong> algorithm.</li>
</ol>
<p><img src="images/advanced_qgis/karnataka9.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="10" style="list-style-type: decimal">
<li>In the <em>Basic Statistics for Fields</em> dialog, select
<code>Calculated</code> as the <em>Input layer</em> and
<code>length_km</code> as the <em>Field to calculate statistics on</em>.
Click <em>Run</em>.</li>
</ol>
<p><img src="images/advanced_qgis/karnataka10.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="11" style="list-style-type: decimal">
<li>It will generate a new temporary layer <code>Statistics</code>. You
can view the <em>Attribute Table</em> of the layer to view the
statistics in a table format. The result will also be displayed in the
<em>Results Viewer</em>. The panel will contain the link to an HTML file
containing the statistics. The <strong>Sum</strong> contains the total
length of national highways in the state.</li>
</ol>
<p><img src="images/advanced_qgis/karnataka11.png" width="75%" style="display: block; margin: auto;" /></p>
<blockquote>
<p><em>What do you think of the results?</em> The resulting number may
not be perfect because the OpenStreetMap database may have missing roads
or are classified differently. But it is close to the number provided in
the <a
href="https://morth.nic.in/sites/default/files/PragatiKiNayiGati/pdf/karnataka.pdf">official
statistics</a>.</p>
</blockquote>
<ol start="12" style="list-style-type: decimal">
<li>The final layer is called <code>Calculated</code> and is a temporary
memory layer. Let’s save it to the disk so we can use it later. The
layer contains many fields which are not relevant to us, so let’s delete
some columns before saving them. The <em>classic</em> way to do this is
to toggle editing and use the <em>Delete Column</em> button from the
Attribute Table. If you wanted to rename/reorder certain fields, that
needed a plugin. But now, we have a really easy processing algorithm
called <strong>Refactor Fields</strong> that can add, delete, rename,
re-order and change the field types all at once. Delete fields that are
not required and save the result as the layer
<code>national_highways</code> in the source
<code>karnataka.gpkg</code>.</li>
</ol>
<p><img src="images/advanced_qgis/karnataka12.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="13" style="list-style-type: decimal">
<li>The layer <code>national_highways</code> will be added to the Layers
panel.</li>
</ol>
<p><img src="images/advanced_qgis/karnataka13.png" width="75%" style="display: block; margin: auto;" /></p>
<p>We have now finished the first part of this exercise. Your output
should match the contents of the
<code>Processing_Tools_Checkpoint1.qgz</code> file in the
<code>solutions</code> folder.</p>
<div id="challenge" class="section level3">
<h3>1.1.1 Challenge</h3>
<p>There are many features in the <code>national_highways</code> layer
where the <code>"name"</code> attribute is <strong>NULL</strong>. Find
an appopriate algorithm from the Processing Toolbox to create a new
layer with the features having NULL values removed.</p>
<p><img src="images/advanced_qgis/1_1_1_challenge.png" width="75%" style="display: block; margin: auto;" /></p>
</div>
</div>
<div id="spatial-join-and-summary-statistics" class="section level2">
<h2>1.2 Spatial Join and Summary Statistics</h2>
<p>We achieved the goal of the exercise, but we can explore the results
a bit better if we can break down the results into a smaller
administrative unit. Let’s try to calculate the length of national
highways for each district in the state. This will require us to perform
a spatial join and analyze the results using group statistics.</p>
<ol style="list-style-type: decimal">
<li>Add the <code>karnataka_districts</code> layer from the
<code>karnataka.gpkg</code> file. This layer contains the geometry of
each district along with its name in the <strong>DISTRICT</strong>
field.</li>
</ol>
<p><img src="images/advanced_qgis/join01.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="2" style="list-style-type: decimal">
<li>To add the name of the district to the roads layer, we need to
perform a spatial-join. This is done using the <strong>Join attributes
by Location</strong> algorithm. Search and locate the tool in the
toolbox. Double-click to open it. For <em>Join to features in</em>,
select the <code>national_highways</code> layer and <em>By comparing
to</em> as <code>karnataka_districts</code>. This will join each feature
in the roads layer to the intersecting feature from the districts layer.
Select only the <strong>DISTRICT</strong> field to be added to the
output. For the <em>Join type</em>, you have 3 options. Here we want to
do a one-to-one join where the for each road feature, we want to select
one district feature. Select the <strong>Take attributes of the feature
with largest overlap only</strong> option.</li>
</ol>
<blockquote>
<p>In our dataset, the are some road geometries that cross district
boundaries - causing part of the length being counted as part of another
district. You can instead use the <em>Sum line lengths</em> algorithm
from the Processing Toolbox which gives you accurate line lenghts
contained in each polygon.</p>
</blockquote>
<p><img src="images/advanced_qgis/join02.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="3" style="list-style-type: decimal">
<li>The new layer <code>Joined layer</code> now has the intersecting
district name in the <strong>DISTRICT</strong> field. We can now sum the
road lengths and group them for each district. You may recall that in
earlier versions of QGIS, you needed a plugin called Group Stats to do
this. But now we can do this via the built-in <strong>Statistic by
Categories</strong> algorithm. Select the <code>Joined layer</code> as
the <em>Input vector layer</em>, <strong>length_km</strong> as the
<em>Field to calculate statistics on</em>. Select the
<strong>DISTRICT</strong> field as the <em>Field(s) with
Categories</em>.</li>
</ol>
<p><img src="images/advanced_qgis/join03.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="4" style="list-style-type: decimal">
<li>Save the layer to the <code>karnataka.gpkg</code> as a layer named
<code>national_highways_by_districts</code>. Click <em>Run</em>.</li>
</ol>
<p><img src="images/advanced_qgis/join04.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="5" style="list-style-type: decimal">
<li>The output of the algorithm is a table containing various statistics
on the <code>length_km</code> column for each district. The values in
the <strong>Sum</strong> column is the total length of national highways
in the district.</li>
</ol>
<p><img src="images/advanced_qgis/join05.png" width="75%" style="display: block; margin: auto;" /></p>
<p>Note that we did data processing, spatial analysis and statistical
analysis - all using just processing algorithms in a fast, reproducible
and intuitive workflow. We have now finish the first part of this
exercise. Your output should match the contents of the
<code>Processing_Tools_Checkpoint2.qgz</code> file in the
<code>solutions</code> folder.</p>
<div id="challenge-1" class="section level3">
<h3>1.2.1 Challenge</h3>
<p>Apply the following formatting changes on the
<code>national_highways_by_districts</code> layer and save it to
<code>karnataka.gpkg</code> as a new layer
<code>national_highways_by_districts_formatted</code>.</p>
<ul>
<li>Rename the <strong>DISTRICT</strong> field to
<strong>district</strong>.</li>
<li>Rename the <strong>sum</strong> field to
<strong>total_length</strong>.</li>
<li>Round the lengths in the <strong>total_length</strong> field to
nearest integer using the <code>round()</code> function.</li>
<li>Delete all remaining fields.</li>
</ul>
<p><img src="images/advanced_qgis/1_2_1_challenge.png" width="75%" style="display: block; margin: auto;" /></p>
<p>Hint: You can apply an expression on a field in the <em>Refactor
Fields</em> algorithm by entering it in the <em>Source Expression</em>
column.</p>
</div>
</div>
</div>
<div id="batch-processing" class="section level1">
<h1>2. Batch Processing</h1>
<p>So far we have run the algorithm on 1 layer at a time. But each
processing algorithm can also be run in a <strong>Batch</strong> mode on
multiple inputs. This provides an easy way to process large amounts of
data and automate repetitive tasks.</p>
<p>The batch processing interface can be invoked by right-clicking any
processing algorithm and choosing <strong>Execute as Batch
Process</strong>.</p>
<div id="clip-multiple-layers" class="section level2">
<h2>2.1 Clip Multiple Layers</h2>
<p>We will take multiple country-level data layers and use the batch
processing operation to clip them to a state polygon in a single
operation.</p>
<ol style="list-style-type: decimal">
<li>Open the <strong>batch_processing</strong> project.</li>
</ol>
<p><img src="images/advanced_qgis/batch01.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="2" style="list-style-type: decimal">
<li>Next, right-click on the <code>state boundary</code> layer, and
click <strong>Zoom to Layer</strong>.</li>
</ol>
<p><img src="images/advanced_qgis/batch02.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="3" style="list-style-type: decimal">
<li>Now that we have centered on our area of interest,select the
<code>places</code> layer. Go to the the <strong>Processing</strong>
menu and select <strong>toolbox</strong>. Now in <em>Processing
Toolbox</em>, search for <strong>clip</strong>, under <strong>Vector
overlay → Clip</strong> right-click and select <strong>Execute as Batch
Process..</strong>.</li>
</ol>
<p><img src="images/advanced_qgis/batch03.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="4" style="list-style-type: decimal">
<li>In the <em>Batch processing - Clip</em> dialog box, click the
<em>Autofill…</em> under the <em>Input layer</em> column and choose
<em>Select from Open Layers..</em>.</li>
</ol>
<p><img src="images/advanced_qgis/batch04.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="5" style="list-style-type: decimal">
<li>Select all data layers except <code>state_boundary</code> and
<code>places</code> then click <strong>OK</strong>. The
<code>places</code> layer is on the top and it gets selected by
default.We won’t select it manually to avoid repetition.</li>
</ol>
<p><img src="images/advanced_qgis/batch05.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="6" style="list-style-type: decimal">
<li>Under <em>Overlay Layer</em> select the
<strong>state_boundary</strong> layer. Then click the drop-down button
near <em>Autofill…</em> and choose to <strong>Fill Down</strong>. This
will auto-populate all the <em>Overlay Layer</em> with the
<code>state_boundary</code> layer.</li>
</ol>
<p><img src="images/advanced_qgis/batch06.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="7" style="list-style-type: decimal">
<li>Under <em>Clipped</em>, select <em>…</em> button to add the output
filenames.</li>
</ol>
<p><img src="images/advanced_qgis/batch07.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="8" style="list-style-type: decimal">
<li>In the <em>Save File</em> dialog box, enter the <em>File name</em>
as <code>clipped_</code>. This is just the prefix of the name that you
will auto-complete in the next step. Select <strong>GPKG files
(.gpkg)</strong> in <em>Save as type</em>. Click
<strong>Save</strong>.</li>
</ol>
<p><img src="images/advanced_qgis/batch08.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="9" style="list-style-type: decimal">
<li>Next, you will be prompted to choose the <em>Autofill settings</em>.
Select to <strong>Fill with parameter values</strong> as the
<em>Autofill mode</em>, and <strong>Input layer</strong> as the
<em>Parameter to use</em>. Click <strong>OK</strong>.</li>
</ol>
<p><img src="images/advanced_qgis/batch09.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="10" style="list-style-type: decimal">
<li>Note that each row has a different file name now. The output file
name is the result of the chosen prefix and the autofill settings. Make
sure the <em>Load layers on completion</em> box is checked and click
<em>Run</em>.</li>
</ol>
<p><img src="images/advanced_qgis/batch10.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="11" style="list-style-type: decimal">
<li>The resulting clipped layers will be added to the <em>Layers
panel</em>. Turn off all previous layers in the Layers panel to see the
results clearly. We can now combine all the clipped layers into a single
<em>geopackage</em> file for ease of sharing. Now in the <em>Processing
Toolbox</em>, search and select the <strong>Package
Layers</strong>.</li>
</ol>
<p><img src="images/advanced_qgis/batch11.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="12" style="list-style-type: decimal">
<li>In the <em>Package Layers</em> dialog box, in <em>Input layers</em>
choose all the clipped layers and in <em>Destination GeoPackage</em>
click <em>…</em> and select <strong>Save to File…</strong>. Then save
the file as <code>clipped.gpkg</code>. Click <strong>Run</strong></li>
</ol>
<p><img src="images/advanced_qgis/batch12.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="13" style="list-style-type: decimal">
<li>Now a new <code>clipped.gpkg</code> geopackage layer will be created
with all the clipped layers in it.</li>
</ol>
<p><img src="images/advanced_qgis/batch13.png" width="75%" style="display: block; margin: auto;" /></p>
<p>Your output should match the contents of the
<code>Batch_Processing_Checkpoint1.qgz</code> file in the
<code>solutions</code> folder.</p>
<div id="challenge-2" class="section level3">
<h3>2.1.1 Challenge</h3>
<p>Reprojected all the clipped layers to a UTM projection. You can
reproject all the layers to the CRS <strong>WGS84 / UTM zone 43N
EPSG:32643</strong>. Save the reprojected layers to the same GeoPackage
<code>clipped.gpkg</code></p>
<p><img src="images/advanced_qgis/2_1_1_challenge.png" width="75%" style="display: block; margin: auto;" /></p>
</div>
</div>
</div>
<div id="model-designer" class="section level1">
<h1>3. Model Designer</h1>
<p>GIS Workflows typically involve many steps - with each step
generating intermediate output that is used by the next step. If you
change the input data or want to tweak a parameter, you will need to run
through the entire process again manually. Fortunately, Processing
Framework provides a model designer that can help you define your
workflow and run it with a single invocation. You can also run these
workflows as a batch over a large number of inputs.</p>
<div id="workflow-automation" class="section level2">
<h2>3.1 Workflow Automation</h2>
<p>National Geospatial-Intelligence Agency’s Maritime Safety Information
portal provides a shapefile of all incidents of maritime piracy in the
form of Anti-shipping Activity Messages. We can create a density map by
aggregating the incident points over a global hexagonal grid.</p>
<p>The steps needed to create a hex-bin layer suitable for visualization
is as follows:</p>
<ul>
<li>Reproject the input to an equal-area projection</li>
<li>Create a global hexagonal grid layer</li>
<li>Select all grids that intersect with at least 1 point</li>
<li>Count points within each grid</li>
</ul>
<p>We will now learn how to build a model that runs the above processing
steps in a single workflow.</p>
<ol style="list-style-type: decimal">
<li>Open the <strong>maritime_piracy</strong> project.</li>
</ol>
<p><img src="images/advanced_qgis/modeler1.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="2" style="list-style-type: decimal">
<li>Launch the modeler from <strong>Processing → Model
Designer</strong></li>
</ol>
<p><img src="images/advanced_qgis/modeler2.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="3" style="list-style-type: decimal">
<li>In the Processing Modeler dialog, locate the <em>Model
Properties</em> panel. Enter <code>piracy_hexbin</code> as the Name of
the model. Note that there is a History panel in the bottom left, which
keeps track of all the work done in Model Builder. Click the Save
button.</li>
</ol>
<p><img src="images/advanced_qgis/modeler3.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="4" style="list-style-type: decimal">
<li>Save the model as <code>piracy_hexbin.model3</code>. Also, check the
folder in which it is being saved. <em>Processing → models</em>, from
this location QGIS will read the model by default.</li>
</ol>
<p><img src="images/advanced_qgis/modeler4.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="5" style="list-style-type: decimal">
<li>Now, we can start building a graphical model of our processing
pipeline. The Processing modeler dialog contains a left-hand panel and
the main canvas. On the left-hand panel, locate the Inputs panel listing
various types of input data types. Scroll down and select the <strong>+
Vector Layer</strong> input. Drag it to the canvas.</li>
</ol>
<p><img src="images/advanced_qgis/modeler5.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="6" style="list-style-type: decimal">
<li>Enter <strong>Input Points</strong> as the <em>Description</em> and
<strong>Point</strong> as the <em>Geometry type</em>. This input
represents the piracy incidents point layer.</li>
</ol>
<p><img src="images/advanced_qgis/modeler6.png" width="50%" style="display: block; margin: auto;" /></p>
<ol start="7" style="list-style-type: decimal">
<li>Next, drag another <strong>+ Vector Layer</strong> input to the
canvas. Enter <strong>Base Layer</strong> as the <em>Description</em>
and <strong>Polygon</strong> as the <em>Geometry type</em>. This input
represents the natural earth global land layer in which we will use as
the extent of the grid layer.</li>
</ol>
<p><img src="images/advanced_qgis/modeler7.png" width="50%" style="display: block; margin: auto;" /></p>
<ol start="8" style="list-style-type: decimal">
<li>As we are generating a global hexagonal grid, we can ask the user to
supply us with the grid size as an input instead of hard-coding it as
part of our model. This way, the user can quickly experiment with
different grid sizes without changing the model at all. Select a
<strong>+ Number</strong> input and drag it to the canvas. Enter
<strong>Grid Size</strong> as the Parameter name,
<strong>Integer</strong> as the Number Type, <strong>200000</strong> as
Default Value, and click OK.</li>
</ol>
<p><img src="images/advanced_qgis/modeler8.png" width="50%" style="display: block; margin: auto;" /></p>
<ol start="9" style="list-style-type: decimal">
<li>Now that we have our user inputs defined, we are ready to add
processing steps. All of the processing algorithms are available to you
under the <em>Algorithms</em> tab. The first step in our pipeline will
be to reproject the base layer to the Project CRS. Search for the
<strong>Reproject layer</strong> algorithm and drag it to the
canvas.</li>
</ol>
<p><img src="images/advanced_qgis/modeler9.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="10" style="list-style-type: decimal">
<li>In the <em>Reproject layer</em> dialog, select <strong>Base
Layer</strong>, by clicking the button under the <em>Input Layer</em>
and select <strong>Model Input</strong> as the <em>Input layer</em>.
Check the Use <strong>project CRS</strong> as the <em>Target CRS</em>.
Click OK.</li>
</ol>
<p><img src="images/advanced_qgis/modeler10.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="11" style="list-style-type: decimal">
<li>In the Processing Modeler canvas, you will notice a connection
appear between the <code>+ Base Layer</code> input and the
<code>Reproject layer</code> algorithm. This connection indicates the
flow of our processing pipeline. The next step is to create a hexagonal
grid. Now search for the <strong>Create grid</strong> algorithm and drag
it to the canvas.</li>
</ol>
<p><img src="images/advanced_qgis/modeler11.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="12" style="list-style-type: decimal">
<li>In the Create grid dialog, choose <strong>Hexagon (polygon)</strong>
as the <em>Grid type</em>. Select <strong>Algorithm Output</strong> by
clicking the button under <em>Grid extent</em> and choose
<strong>‘Reprojected’ from the algorithm ‘Reproject Layer’</strong> as
the Grid extent.</li>
</ol>
<p><img src="images/advanced_qgis/modeler12.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="13" style="list-style-type: decimal">
<li>Select <strong>Model input</strong> by clicking the button under
<em>Horizontal Spacing</em> and choose <strong>Grid Size</strong> as the
<em>Horizontal Spacing</em>. Click OK.</li>
</ol>
<p><img src="images/advanced_qgis/modeler13.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="14" style="list-style-type: decimal">
<li>Select <strong>Model input</strong> by clicking the button under
<em>Vertical Spacing</em> and choose <strong>Grid Size</strong> as the
<em>Vertical Spacing</em>. Click OK.</li>
</ol>
<p><img src="images/advanced_qgis/modeler14.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="15" style="list-style-type: decimal">
<li>At this point, we have a global hexagonal grid. The grid spans the
full extent of the base layer, including land areas and places where
there are no points. Let us filter out those grid polygons where there
are no input points. Search for <strong>Extract by location</strong>
algorithm and drag it to the canvas.</li>
</ol>
<p><img src="images/advanced_qgis/modeler15.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="16" style="list-style-type: decimal">
<li>Select <strong>Algorithm Output</strong> from the icon below
<em>Extract features from</em>. Now choose <strong>‘Grid’ from the
algorithm ‘Generate Grid’</strong>. Click <strong>…</strong> at the
right end.</li>
</ol>
<p><img src="images/advanced_qgis/modeler16.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="17" style="list-style-type: decimal">
<li>Select <strong>Intersect</strong> by clicking the button, as Where
the features(geometric predicate). And click the triangle button to go
back to the previous window. Now click OK.</li>
</ol>
<p><img src="images/advanced_qgis/modeler17.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="18" style="list-style-type: decimal">
<li>Select <strong>Model input</strong> by clicking the button under
<em>By comparing to the features from</em> and choose <strong>Input
Points</strong> as <em>By comparing to the features from</em>. Click
OK.</li>
</ol>
<p><img src="images/advanced_qgis/modeler18.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="19" style="list-style-type: decimal">
<li>Now, we have only those grid polygons that contain some input
points. To aggregate these points, we will use <strong>Count points in
polygon</strong> algorithm. Search and drag it to the canvas.</li>
</ol>
<p><img src="images/advanced_qgis/modeler19.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="20" style="list-style-type: decimal">
<li>Select <strong>Algorithm Output</strong> by clicking the button
under <em>Polygons</em> and choose <strong>‘Extracted (location)’ from
algorithm ‘Extract by location’</strong> for <em>Polygons</em>. Now,
Select <strong>Model Input</strong> by clicking the button under
<em>Points</em> and choose <strong>Input Points</strong> for
<em>Points</em>. Type <strong>NUMPOINTS</strong> in <strong>Count field
name</strong>. At the bottom, name the Count output layer as
<strong>Aggregated</strong>. Click OK.</li>
</ol>
<p><img src="images/advanced_qgis/modeler20.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="21" style="list-style-type: decimal">
<li>The model is now complete. Click the <em>Save</em> button.</li>
</ol>
<p><img src="images/advanced_qgis/modeler21.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="22" style="list-style-type: decimal">
<li>Switch to the main QGIS window. You can find your newly created
model in the <em>Processing Toolbox</em> under <strong>Models
→piracy_hexbin</strong>. Double-click to run the model.</li>
</ol>
<p><img src="images/advanced_qgis/modeler22.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="23" style="list-style-type: decimal">
<li>Our <em>Base Layer</em> is the <code>ne_10m_land</code> and the
<em>Input Points</em> layer is <code>ASAM_events</code>. The Grid Size
needs to be specified in the units of the selected CRS. Enter
<code>100000</code> as the Grid Size. Grid size is in the unit of the
current CRS, which is meters. Click Run to start the processing
pipeline. Once the process finishes, click Close.</li>
</ol>
<p><img src="images/advanced_qgis/modeler23.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="24" style="list-style-type: decimal">
<li>You will see a new layer <code>Aggregated</code> loaded as the
result of the model. As you explore, you will notice the layer contains
an attribute called <em>NUMPOINTS</em> containing the number of piracy
incidents points contained within that grid feature.</li>
</ol>
<p><img src="images/advanced_qgis/modeler24.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="25" style="list-style-type: decimal">
<li>To ensure that you are always able to reproduce your results, it is
recommended to bundle the model in your project. The modeler interface
has a button <strong>Save model in project</strong>. Click on it to
embed the model in your QGIS project file.</li>
</ol>
<p><img src="images/advanced_qgis/modeler25.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="26" style="list-style-type: decimal">
<li>Once the model is embedded, Whenever you open the project, the model
will be available to the user under the <strong>Project models</strong>
in the Processing Toolbox.</li>
</ol>
<p><img src="images/advanced_qgis/modeler26.png" width="75%" style="display: block; margin: auto;" /></p>
<p>Your output should match the contents of the
<code>Modeler_Checkpoint1.qgz</code> file in the <code>solutions</code>
folder.</p>
<div id="challenge-3" class="section level3">
<h3>3.1.1 Challenge</h3>
<p>Add a step to extract the grid with the highest piracy incidents.</p>
<p>Hint: The expression <code>maximum("NUMPOINTS")</code> will give you
the highest value contained in the <code>"NUMPOINTS"</code> field. Use
it to build your complete expression.</p>
<p><img src="images/advanced_qgis/3_1_1_challenge.png" width="75%" style="display: block; margin: auto;" /></p>
</div>
</div>
<div id="concept-spatial-indexing" class="section level2">
<h2>Concept: Spatial Indexing</h2>
<p>When you ran your model, you may have noticed a warning message
<strong>No spatial index exists for the input layer, performance will be
severely degraded</strong>. This is because certain spatial queries make
use of a spatial index and QGIS warns you when having a spatial index
can speed up your operations. PostGIS documentation has a good <a
href="https://postgis.net/workshops/postgis-intro/indexing.html">overview
of spatial indexes</a> and why they are important.</p>
<p>You can compare a <em>spatial index</em> to a book <em>index</em>.
When you want to search for a particular term, rather than scanning each
page sequentially, you can speed up your search by looking up the index
and directly going to the pages where the word appears. Spatial indexes
work in similarly. You spent the effort once to create the index and all
subsequent operations can make use of it. When you create a spatial
index, each feature’s bounding box is used to establish its relationship
with other features. This is stored alongside the dataset and can be
used by algorithms. When trying to determine spatial relationships, the
algorithms speed-up the look-up using the following <em>two-pass</em>
method:</p>
<ul>
<li>Step 1: Use the spatial index to determine which target features’
bounding boxes intersect with the source feature’s bounding box. Since
the spatial index already has computed this - this is very fast. The
result is a list of candidate features.</li>
<li>Step 2: Now that there is a small subset of candidate features,
iterate over them and use their full geometry to evaluate exact
intersections.</li>
</ul>
<p>For large datasets, this approach helps reduce the processing time
significantly.</p>
<p><a
href="https://docs.google.com/presentation/d/1K1lR1JfonxGbmj8rCIVln_WkbWv6-tOYTYHAEJKAiw4/edit?usp=sharing"
target="_blank"><img src="images/advanced_qgis/spatial_indexing.png"
width="400" alt="View Presentation" /></a></p>
<p><a
href="https://docs.google.com/presentation/d/1K1lR1JfonxGbmj8rCIVln_WkbWv6-tOYTYHAEJKAiw4/edit?usp=sharing"
target="_blank">View the Presentation</a></p>
</div>
<div id="using-spatial-index" class="section level2">
<h2>3.2 Using Spatial Index</h2>
<p>QGIS has built-in tools to create and use spatial indexes. Let’s see
how we can create a spatial index for a layer and use it in our
model.</p>
<ol style="list-style-type: decimal">
<li>Double click on the <code>piracy_hexbin</code> model from
<em>Processing Toolbox</em>, select <strong>ne_10m_land</strong> as
<em>Base Layer</em>, <strong>200000</strong> as <em>Grid size</em> and
<strong>ASAM_events</strong> as <em>Inputs Points</em>. Click Run.</li>
</ol>
<p><img src="images/advanced_qgis/index01.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="2" style="list-style-type: decimal">
<li>Switch to <em>Log</em>, and note down the execution time of the
model. In this instance we got <em>34.80 seconds</em> (The exact time
will vary depending on your computer configuration). Also note that it
prompts a warning <em>No spatial index exists for input layer,
performance will be severely degraded</em>.</li>
</ol>
<p><img src="images/advanced_qgis/index02.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="3" style="list-style-type: decimal">
<li>To create spatial index right-click the <strong>Aggregated</strong>
layer and select <em>Properties</em>.</li>
</ol>
<p><img src="images/advanced_qgis/index03.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="4" style="list-style-type: decimal">
<li>In the <em>Layer Properties</em> dialog, switch to the
<em>Source</em> tab. You will see the <em>Create Spatial Index</em>
button. This button indicates that this layer does not currently have a
spatial index. Click that button to create a spatial index. But we will
use a better and more scalable way. Click <strong>OK</strong> and close
the <em>Layer Properties</em> dialog.</li>
</ol>
<p><img src="images/advanced_qgis/index04.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="5" style="list-style-type: decimal">
<li>Go to <strong>Processing → Toolbox</strong>. Search for the
algorithm <strong>Vector general → Create spatial index</strong> and
double-click to launch it.</li>
</ol>
<p><img src="images/advanced_qgis/index05.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="6" style="list-style-type: decimal">
<li>Select <strong>Aggregated</strong> layer as the <em>Input layer</em>
and click <em>Run</em>.</li>
</ol>
<p><img src="images/advanced_qgis/index06.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="7" style="list-style-type: decimal">
<li>Creating a spatial index is usually a fast operation. Once the
algorithm finishes, right-click on the <strong>Aggregated</strong> layer
and select <em>Properties</em>. Switch to the <em>Source</em> tab and
you will see that the button has now changed to <em>Spatial Index
Exists</em> - indicating that the layer now has a spatial index.</li>
</ol>
<p><img src="images/advanced_qgis/index07.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="8" style="list-style-type: decimal">
<li>While creating a spatial index on a layer like this is useful, it is
even more powerful to have the spatial index created during the
execution of our model. We will see how to add the spatial index
creation step in our model. Right-click the <code>piracy_hexbin</code>
model and select <em>Edit Model…</em>. Search <strong>Create spatial
index</strong> in <em>Algorithms</em> tab and drag it to the model
canvas.</li>
</ol>
<p><img src="images/advanced_qgis/index08.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="9" style="list-style-type: decimal">
<li>Choose <strong>Algorithm output</strong> from the button below
<em>Input Layer</em>, and select <strong>“Grid” from algorithm “Create
Grid”.</strong> Click OK.</li>
</ol>
<p><img src="images/advanced_qgis/index09.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="10" style="list-style-type: decimal">
<li>You will see that the newly added <code>Create spatial index</code>
algorithm is connected to the <code>Create grid</code> algorithm. But
the workflow should be, <strong>Create grid → Create spatial index →
Extract from location</strong>.</li>
</ol>
<p><img src="images/advanced_qgis/index10.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="11" style="list-style-type: decimal">
<li>Right-click the <code>Extract by location</code> layer and select
<em>Edit</em>. In <em>Extract features from</em> select <strong>“Indexed
Layer” from algorithm “Create spatial index”</strong>.</li>
</ol>
<p><img src="images/advanced_qgis/index11.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="12" style="list-style-type: decimal">
<li>Now you will see the model diagram updated and the connection
changed between the <code>Create Grid</code> and
<code>Extract by location</code> layer. Click <em>Save model</em>.</li>
</ol>
<p><img src="images/advanced_qgis/index12.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="13" style="list-style-type: decimal">
<li>Now return to the main canvas and select <code>piracy_hexbin</code>
model.</li>
</ol>
<p><img src="images/advanced_qgis/index13.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="14" style="list-style-type: decimal">
<li>Select <strong>ne_10m_land</strong> as <em>Base Layer</em>,
<strong>200000</strong> as <em>Grid size</em> and
<strong>ASAM_events</strong> as <em>Inputs Points</em>. Click Run.</li>
</ol>
<p><img src="images/advanced_qgis/index14.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="15" style="list-style-type: decimal">
<li>In this instance we got <em>3.39 seconds</em> (The exact time will
vary depending on your computer configuration). Also, note that it has
executed 5 algorithms which is including creating the spatial
index.</li>
</ol>
<p><img src="images/advanced_qgis/index15.png" width="75%" style="display: block; margin: auto;" /></p>
<p>Your output should match the contents of the
<code>Modeler_Checkpoint2.qgz</code> file in the <code>solutions</code>
folder.</p>
<div id="challenge-4" class="section level3">
<h3>3.2.1 Challenge</h3>
<p>Can you change the model so that instead of entering the grid size in
meters, the user can enter the size in kilometers?</p>
<p><img src="images/advanced_qgis/3_2_1_challenge.png" width="75%" style="display: block; margin: auto;" /></p>
<p>Hint: The <strong>Create Grid</strong> algorithm expects the size in
meters, so you will have to convert the input to meters. Instead of
using <em>Model Input</em>, use <em>Pre-calculated Value</em> to enter
an expression.</p>
</div>
</div>
<div id="enabling-reproducible-workflows" class="section level2">
<h2>3.3 Enabling Reproducible Workflows</h2>
<p>GeoPackage is an open and flexible data format that makes data
management simple. We saw how you can package multiple layers in a
GeoPackage. We will now learn how to embed QGIS projects inside of a
goepackage.</p>
<p>QGIS projects contain information of layer configuration, symbology,
label positions and even models. We can make the reproducing your
workflow even easier by embedding the QGIS Project in the same
geopackage containing the source layers.</p>
<ol style="list-style-type: decimal">
<li>Now, lets save this project in <code>martime_piracy.gpkg</code>
geopackage. Click <strong>Project → Save To → GeoPackage…</strong>.</li>
</ol>
<p><img src="images/advanced_qgis/reproducibleWorkflows01.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="2" style="list-style-type: decimal">
<li>In the <em>Save project to GeoPackage</em> dialog box, click … to
browse to martime_piracy geopackage.</li>
</ol>
<p><img src="images/advanced_qgis/reproducibleWorkflows02.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="3" style="list-style-type: decimal">
<li>Enter project name as <code>martime_piracy</code> and click
<strong>OK</strong>.</li>
</ol>
<p><img src="images/advanced_qgis/reproducibleWorkflows03.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="4" style="list-style-type: decimal">
<li>Now in <em>Browser</em>, under <code>martime_piracy.gpkg</code> the
project is saved. You now have just 1 GeoPackage file that contains all
your input layers, styles, project and models. Sharing this 1 file will
enable anyone to reproduce your output using the embedded model and
layers.</li>
</ol>
<p><img src="images/advanced_qgis/reproducibleWorkflows04.png" width="75%" style="display: block; margin: auto;" /></p>
</div>
</div>
<div id="assignment" class="section level1">
<h1>Assignment</h1>
<p>The following assignment is designed to help you practice the skills
learnt so far in the course and explore automation using the model
designer.</p>
<p>Your task is to create a model called <strong>Calculate Highway
Statistics</strong> that will automate the workflow outlined in the
previous section <a href="#using-processing-toolbox">1. Using Processing
Toolbox</a>.</p>
<p>Your model is expected to take following 3 inputs</p>
<ul>
<li><em>Roads Layer</em>: A vector layer of the road network.
i.e. <code>karnataka_major_roads</code>.</li>
<li><em>Admin Boundaries Layer</em>: A vector layer containing admin
boundaries. i.e. <code>karnataka_districts</code></li>
<li><em>Highway Type</em>: An enum input with 2 options: <em>National
Highway</em> and <em>State Highway</em>.</li>
</ul>
<div class="figure" style="text-align: center">
<img src="images/advanced_qgis/assignment1.png" alt="Model Inputs" width="75%" />
<p class="caption">
Model Inputs
</p>
</div>
<p>The model should take the input and calculate the total length of
highways in each admin polygon. The result should be a formatted table
containing 2 columns: <code>district</code> and
<code>total_length</code>. Test the model on the layers provided in the
<code>karnataka.gpkg</code> file in the data package.</p>
<div class="figure" style="text-align: center">
<img src="images/advanced_qgis/assignment2.png" alt="Expected Model Output" width="40%" />
<p class="caption">
Expected Model Output
</p>
</div>
<p><strong>Tips and Best Practices</strong>:</p>
<ul>
<li>Test your model at each step. After adding an algorithm, enter a
name for the output, save the model and run it. The output will be
loaded in QGIS. Ensure the generated output is as expected. If you get
an error, fix it before adding another step.</li>
<li>You need to extract the correct type of highways from the roads
layer based on the model input for the parameter <em>Highway Type</em>.
If the selected type is <strong>National Highway</strong>, you must
extract the features with <code>ref</code> column values starting with
<strong>NH</strong>. If the selected type is <strong>State
Highway</strong>, you must extract the features with <code>ref</code>
column values starting with <strong>SH</strong>. You may use either
<code>if</code> or the <code>CASE</code> conditionals to build your
expression.</li>
<li>The <em>Enum</em> input type is used to define a set of pre-selected
values that the user can pick from. The values are displayed as strings,
but in the algorithm they are stored as integers. If the user selected
the first option - its value will be 0. The second option will have the
value 1 and so on.</li>
<li>The <em>Refactor Fields</em> algorithm will need to be configured
manually in the modeler. The input to that algorithm is an intermediate
layer which has not been generated yet, so the model cannot pre-fill the
values. Configure that algorithm from the main QGIS window and copy the
parameter values from there.</li>
<li>Use <em>Modeler Tools → Raise message</em> algorithm to display the
value of any variable during the model execution.</li>
</ul>
<p><strong>Starter Model</strong>: The hardest part of the assignment is
to take the Enum input and write an expression to extract the
appropriate highway type. We encourage you to try to figure this out
yourself. If you struggle with this, you can download the <a
href="https://drive.google.com/uc?export=download&amp;id=1GMF_YfsvpHmex22WdNC6b0Fx5PsFPttQ"><code>assignment_hint.model3</code></a>
file which has the first step configured. You will need to add the
remaining steps to complete the model. You can open this downloaded file
from the <em>Processing Toolbox Menu → Models → Open Existing
Model</em>.</p>
</div>
<div id="d-animations" class="section level1">
<h1>4. 2D Animations</h1>
<p>Time is an important component of many spatial datasets. Along with
location information, time providers another dimension for analysis and
visualization of data. If you are working with a dataset that contains
timestamps or have observations recorded at multiple time-steps, you can
easily visualize it using the <strong>Temporal Controller</strong> in
QGIS 3.14 or above.</p>
<div id="animated-temporal-navigation" class="section level2">
<h2>4.1 Animated Temporal Navigation</h2>
<p>We will continue to work with the maritime piracy dataset. First, we
will create a heatmap visualization and then animate the heatmap to show
how the piracy hot-spots have changed over the past 2 decades.</p>
<ol style="list-style-type: decimal">
<li>Open the <strong>maritime_piracy</strong> project from the data
package. There are thousands of incidents and it is difficult to
determine with more piracy. Rather than individual points, a better way
to visualize this data is through a heatmap. Select the
<code>ASAM_events</code> layers and click the <strong>Open the layer
Styling Panel</strong> button in the Layers panel. Click the
<strong>Single symbol</strong> drop-down.</li>
</ol>
<p><img src="images/advanced_qgis/2d01.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="2" style="list-style-type: decimal">
<li>In the renderer selection drop-down, select <strong>Heatmap</strong>
renderer. Next, select the <strong>Viridis</strong> color ramp from the
Color ramp selector. Adjust the Radius value to <strong>5.0.</strong> At
the bottom, expand the <em>Layer Rendering</em> section and adjust the
opacity to <strong>75.0%</strong>. This gives a nice visual effect of
the hotspots with the land layer below.</li>
</ol>
<p><img src="images/advanced_qgis/2d02.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="3" style="list-style-type: decimal">
<li>Now let’s animate this data to show the yearly map of piracy
incidents. Right click on <code>ASAM_event</code> layer, and choose
<em>Properties.</em></li>
</ol>
<p><img src="images/advanced_qgis/2d03.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="4" style="list-style-type: decimal">
<li>In the layer properties dialog box, select the <em>Temporal
Settings</em> tab and enable it by clicking the checkbox.</li>
</ol>
<p><img src="images/advanced_qgis/2d04.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="5" style="list-style-type: decimal">
<li>The source data contains an attribute <code>dateofocc</code> -
representing the date on which the incident took place. This is the
field that will be used to determine the points that are rendered for
each time period. Select <strong>Single Field with Data/Time</strong> in
<em>Configuration</em> Drop down menu, <strong>dateofocc</strong> as
Field. Click <em>OK</em>.</li>
</ol>
<p><img src="images/advanced_qgis/2d05.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="6" style="list-style-type: decimal">
<li>Now a <em>Clock symbol</em> will appear next to the layer name.
Click on the <strong>Temporal Control Panel</strong> (Clock icon) from
Map Navigation Toolbar.</li>
</ol>
<p><img src="images/advanced_qgis/2d06.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="7" style="list-style-type: decimal">
<li>Click on the <em>Animated Temporal Navigation</em> (play icon).</li>
</ol>
<p><img src="images/advanced_qgis/2d07.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="8" style="list-style-type: decimal">
<li>By default, the date range is set to the current date. Click <em>Set
to Full Range</em> button to set the date range from the dataset.</li>
</ol>
<p><img src="images/advanced_qgis/2d08.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="9" style="list-style-type: decimal">
<li>Now the data will be set to <code>2000-01-02</code> to
<code>2018-01-01</code>. Update the start date to
<code>2000-01-01</code> and set the <em>Step</em> to
<strong>years</strong>. Click <em>play</em> button to start
rendering.</li>
</ol>
<p><img src="images/advanced_qgis/2d09.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="10" style="list-style-type: decimal">
<li>It will be useful to add a label to the animation showing the date
of the animation frame being displayed. We can use the <em>Title
Decoration</em> to place that label. Go to <strong>View → Decorations →
Title Label Decorations.</strong> Click the checkbox to enable it and
then the <strong>Insert an Expression</strong> button.</li>
</ol>
<p><img src="images/advanced_qgis/2d10.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="11" style="list-style-type: decimal">
<li>Enter the following expression to display the year and click
<em>OK</em>.</li>
</ol>
<p><code>format_date(@map_start_time, 'yyyy-MM-dd')</code></p>
<p><img src="images/advanced_qgis/2d11.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="12" style="list-style-type: decimal">
<li>Select font size as <strong>25</strong>, set background color as
<strong>white.</strong> In placement choose <strong>Top Center.</strong>
Now click OK.</li>
</ol>
<p><img src="images/advanced_qgis/2d12.png" width="75%" style="display: block; margin: auto;" /></p>
<p>Your output should match the contents of the
<code>2DAnimation_Checkpoint1.qgz</code> file in the
<code>solutions</code> folder.</p>
<div id="challenge-4.1.1" class="section level3">
<h3>Challenge 4.1.1</h3>
<p>Update the heatmap to use a weight field. We want to give more
importance to more serious attacks. We can use the Hostility Description
contained in the <strong>hostility_D</strong> field of the
<code>ASAM_events</code> layer and assign weights to different types of
events. Once created, style the new layer using the <em>Heatmap</em>
renderer with the <em>weight</em> value.</p>
<p>Hint: Use the <em>Field Calculator</em> algorithm to create a new
layer with a field called <code>weight</code>. You can use the
expression below to assign different weights to each category.</p>
<pre><code>CASE 
WHEN  &quot;hostilit_D&quot; = &#39;Suspicious Approach&#39; THEN 1
WHEN  &quot;hostilit_D&quot; = &#39;Kidnapping&#39; THEN 2
WHEN  &quot;hostilit_D&quot; = &#39;Pirate Assault&#39; THEN 5 
WHEN  &quot;hostilit_D&quot; = &#39;Naval Engagement&#39; THEN 10 
ELSE 1
END</code></pre>
</div>
</div>
<div id="exporting-animation" class="section level2">
<h2>4.2 Exporting Animation</h2>
<div id="animation-using-ezgif.com" class="section level3">
<h3>4.2.1 Animation using EzGIF.com</h3>
<ol style="list-style-type: decimal">
<li>To export these as images and convert them as GIF select the
<strong>Export Animation</strong> (save icon) in the Temporal controller
window.</li>
</ol>
<p><img src="images/advanced_qgis/export01.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="2" style="list-style-type: decimal">
<li>Choose the directory to save the images and select the
<code>ne_10_land</code> for map extent.</li>
</ol>
<p><img src="images/advanced_qgis/export02.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="3" style="list-style-type: decimal">
<li>Once the export finishes, you will see PNG images for each year in
the output directory. Now let’s create an animated GIF from these
images. There are many options for creating animations from individual
image frames. We like ![<a href="https://ezgif.com/maker">ezgif.com</a>]
for an easy and online tool. Visit the site and click Choose Files and
select all the .png files. You may want to sort the images by Type to
allow easy bulk selection of only .png files. Once selected, click the
Upload and make a GIF! button.</li>
</ol>
<p><img src="images/advanced_qgis/export03.png" width="75%" style="display: block; margin: auto;" /></p>
</div>
<div id="animation-using-imagemagick" class="section level3">
<h3>4.2.2 Animation using ImageMagick</h3>
<p>For exporting large animations, it is preferable to compose the
individual frames to a GIF on your own machine. <a
href="https://imagemagick.org/">ImageMagick</a> is a free and
open-source command-line tool that is widely used for bulk image
processing. You can <a
href="https://imagemagick.org/script/download.php">Download and
Install</a> it on your system. Once installed, it can be run from
Windows Command Prompt or a Mac/Linux Terminal. Navigate to the
directory containing exported image frames using the <code>cd</code>
command and run the following command to create the GIF.</p>
<pre><code>magick -delay 50 -loop 0 *.png animation.gif</code></pre>
<p><img src="images/advanced_qgis/imagemagick.png" width="75%" style="display: block; margin: auto;" /></p>
</div>
<div id="challenge-4.2.1" class="section level3">
<h3>Challenge 4.2.1</h3>
<p>Export your animation and create an animated GIF showing the changes
in piracy hotspots over time.</p>
</div>
</div>
<div id="animating-gps-tracks" class="section level2">
<h2>4.3 Animating GPS Tracks</h2>
<p>GPS tracks have become ubiquitous in modern life. With GPS built-into
most phones, many of us capture the tracks while running or biking
outdoors. Cab companies use GPS tracks collected during the trip to
determine fares. Delivery and logistics companies store and analyze
millions of GPS tracks from their assets to derive location
intelligence.</p>
<p>We will now learn how to collect a GPS track and create an animation
from it. We will produce an animation that looks like shown below.</p>
<div class="float">
<img src="images/advanced_qgis/gps_animation.png"
alt="View Animated GIF ↗" />
<div class="figcaption"><a href="images/advanced_qgis/gps_animation.gif"
target="_blank">View Animated GIF ↗</a></div>
</div>
<div id="collecting-a-gps-track" class="section level3">
<h3>4.3.1 Collecting a GPS Track</h3>
<p>We encourage you to collect your own GPS track for this exercise. You
can collect a GPS track from a smartphone and download it to your
computer. The default format for storing GPS tracks is <a
href="https://en.wikipedia.org/wiki/GPS_Exchange_Format">GPS Exchange
Format (GPX)</a>. It is a XML-based text format that allows storing
points, tracks and routes in a single file. You can use any of the
options below to capture your track.</p>
<ul>
<li>Android: There are many GPS logger apps. We recommend the
open-source <a
href="https://www.basicairdata.eu/projects/android/android-gps-logger/">GPS
Logger app</a>.</li>
<li>iOS: A good free and open-source app is the <a
href="https://apps.apple.com/app/open-gpx-tracker/id984503772">Open GPX
Tracker</a> for your iPhone.</li>
<li>Strava: You can also record your activity using the popular fitness
tracking app <a href="https://www.strava.com/">Strava</a>. Once the
activity is uploaded, you can use the <a
href="https://support.strava.com/hc/en-us/articles/216918437-Exporting-your-Data-and-Bulk-Export#h_01GDP2JB35R4ECM0E6YAH316B9">GPX
Export</a> option to download a GPX file.</li>
</ul>
<p>If you do not have your own data, you can use the
<code>sample_gps_track.gpx</code> file from your data package.</p>
</div>
<div id="loading-a-basemap" class="section level3">
<h3>4.3.2 Loading a Basemap</h3>
<p>We will use a plugin called <strong>QuickMapServices</strong> to
select and load a basemap.</p>
<ol style="list-style-type: decimal">
<li>Open QGIS. From the <em>Plugins</em> menu choose <em>Manage and
Install Plugins…</em>.</li>
</ol>
<p><img src="images/advanced_qgis/basemap1.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="2" style="list-style-type: decimal">
<li>The <em>Plugins</em> dialog contains all the available plugins in
QGIS. Under the <em>All</em> tab, search for
<strong>quickmapservices</strong>. It has different basemaps that can be
used based on your purpose. Click on the <em>Install Plugin</em>, to add
this plugin to QGIS.</li>
</ol>
<p><img src="images/advanced_qgis/basemap2.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="3" style="list-style-type: decimal">
<li>Once installed, check the box next to the <em>QuickMapServices</em>
label to enable it. Click <em>Close</em>.</li>
</ol>
<p><img src="images/advanced_qgis/basemap3.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="4" style="list-style-type: decimal">
<li>Now you will see a new <em>Web</em> menu added to the menu-bar. Go
to <em>Web → QuickMapServices</em> menu. You will see some map providers
and available basemaps. We can enable a few more providers to have many
more options. Click on the <em>Web → QuickMapServices →
Settings</em>.</li>
</ol>
<p><img src="images/advanced_qgis/basemap4.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="5" style="list-style-type: decimal">
<li>In the <em>Settings</em> dialog, switch to the <em>More
services</em> tab. Click on the <code>Get contributed pack</code> to
download 3rd-party basemaps.</li>
</ol>
<blockquote>
<p>You will see a warning against using contributed services. Some of
these services may have restrictions on their usage and/or attribution
requirement that you need to follow. Please review them before using
them in your project.</p>
</blockquote>
<p><img src="images/advanced_qgis/basemap5.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="6" style="list-style-type: decimal">
<li>Once the new services are added, you will see many more options in
the <em>Web → QuickMapServices</em> menu.</li>
</ol>
<p><img src="images/advanced_qgis/basemap6.png" width="75%" style="display: block; margin: auto;" /></p>
</div>
<div id="visualizing-and-creating-animation" class="section level3">
<h3>4.3.3 Visualizing and Creating Animation</h3>
<ol style="list-style-type: decimal">
<li>Start a new QGIS Project. Locate your GPS file in the
<em>Browser</em> panel. If you are using the track from the data
package, locate the <code>sample_gps_track.gpx</code> file. Drag and
drop it to the canvas.</li>
</ol>
<p><img src="images/advanced_qgis/gps_visualize1.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="2" style="list-style-type: decimal">
<li>As the file contains multiple data types, a pop-up will ask us to
select the layers to add. Hold the <em>Shift</em> key and select both
<code>track_points</code> and <code>tracks</code> layers. Click <em>Add
Layers</em>.</li>
</ol>
<p><img src="images/advanced_qgis/gps_visualize2.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="3" style="list-style-type: decimal">
<li>Two new layers will be added to the <em>Layers</em> panel. To add
some context to the map, we should add a basemap. A dark background map
works best for the visualization we want to create. Go to <em>Web →
QuickMapServices → CartoDB → Dark Matter [no labels]</em> layer.</li>
</ol>
<p><img src="images/advanced_qgis/gps_visualize3.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="4" style="list-style-type: decimal">
<li>Turn off the visibility of the <code>track_points</code> layer by
un-checking the box next to it. Select the <code>tracks</code> layer and
click <em>Open the Layer Styling Panel</em>. You can change the line
<em>Color</em> to <strong>Blue</strong> and <em>Width</em> to
<strong>0.2</strong>.</li>
</ol>
<p><img src="images/advanced_qgis/gps_visualize4.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="5" style="list-style-type: decimal">
<li>Turn on the visibility of the <code>track_points</code> layer and
drag it above the <code>tracks</code> layer. This changes the rendering
order and the points will be drawn on top of the line layer. In the
<em>Layer Styling Panel</em>, select <em>Simple marker</em> symbol.
Change the point <em>Size</em> to <code>1</code> . Choose a lighter
shade of Blue as the <em>Fill color</em> and a
<code>Transparent Stroke</code> as <em>Stroke color</em>.</li>
</ol>
<p><img src="images/advanced_qgis/gps_visualize5.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="6" style="list-style-type: decimal">
<li>Depending on how fast you were moving and how often the data was
collected, you may have a lot of points. You may want to filter out some
points so we can create a meaningful animation. We can apply an
expression to display only a subset of points from the layer using
<em>Geometry Generators</em>. Change the <em>Symbol layer type</em> from
<strong>Simple Marker</strong> to <strong>Geometry
generator</strong>.</li>
</ol>
<p><img src="images/advanced_qgis/gps_visualize6.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="7" style="list-style-type: decimal">
<li>Enter the following expression. The following expression displays
every 10th point from the original track. Adjust that number for your
dataset.</li>
</ol>
<pre><code>if(@id % 10 = 0, $geometry, NULL)</code></pre>
<p><img src="images/advanced_qgis/gps_visualize7.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="8" style="list-style-type: decimal">
<li>We want to give a glow effect to the points as it is animating. To
achieve this effect, we will apply a different symbology. Right-click
the <code>track_points</code> layer and choose <em>Duplicate
Layer</em>.</li>
</ol>
<p><img src="images/advanced_qgis/gps_visualize8.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="9" style="list-style-type: decimal">
<li>A new layer <code>track_points copy</code> will be added to the
<em>Layers</em> panel. Drag it on top of the stack in the
<em>Layers</em> panel. In the <em>Layer Styling Panel</em> for the
duplicated <code>track_points copy</code> layer, choose bright neon as
the <em>Color</em> from the color picker and increase the size to
<strong>3</strong>. Check the <em>Draw Effects</em> option and click the
<em>Effects</em> button next to it.</li>
</ol>
<p><img src="images/advanced_qgis/gps_visualize9.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="10" style="list-style-type: decimal">
<li>In the <em>Effects Properties</em> panel, check <em>Outer Glow</em>.
Select <code>2.0</code> for both <em>Spread</em> and <em>Blur
radius</em>. Click <em>Go Back</em>.</li>
</ol>
<p><img src="images/advanced_qgis/gps_visualize10.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="11" style="list-style-type: decimal">
<li>Now we are ready to animate the points. Right-click the
<code>track points copy</code> layer and select
<em>Properties</em>.</li>
</ol>
<p><img src="images/advanced_qgis/gps_visualize11.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="12" style="list-style-type: decimal">
<li>Switch to the <em>Temportal</em> tab. Check the <em>Dynamic Temporal
Control</em> button. Select <code>Single Field with Date/Time</code> as
the <em>Configuration</em>. Set <strong>time</strong> as the
<em>Field</em>. Click <em>OK</em>.</li>
</ol>
<p><img src="images/advanced_qgis/gps_visualize12.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="13" style="list-style-type: decimal">
<li>You will notice that a clock icon now appears to the layer
indicating that this layer can now be controlled by the <em>Temporal
Controller</em>. Next, right-click the <code>track_points</code> layer
and select <em>Properties</em>.</li>
</ol>
<p><img src="images/advanced_qgis/gps_visualize13.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="14" style="list-style-type: decimal">
<li>Repeat the same configuration as before. But this time, check the
<em>Accumulate features over time</em>. This setting will keep the
points from the past timestamps visible as the layer is animated.</li>
</ol>
<p><img src="images/advanced_qgis/gps_visualize14.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="15" style="list-style-type: decimal">
<li>Locate the <em>Temporal Controller Panel</em> button from the
<em>Map Navigation Toolbar</em>. The <em>Temporal Controller</em> panel
will appear at the top of the map canvas. Click the <em>Animated
temportal navigation</em> button.</li>
</ol>
<p><img src="images/advanced_qgis/gps_visualize15.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="16" style="list-style-type: decimal">
<li>Next, click the <em>Set to Full Range</em> button to load the start
and end times automatically. Set the <em>Step</em> to
<strong>10</strong> and from the drop-down select
<strong>seconds</strong>. You can adjust the step size later depending
on your dataset. Click the <em>Temporal Settings</em> button on the
top-right corner.</li>
</ol>
<p><img src="images/advanced_qgis/gps_visualize16.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="17" style="list-style-type: decimal">
<li>Set the <em>Frame rate</em> to <strong>10</strong>. Click <em>Go
back</em>.</li>
</ol>
<p><img src="images/advanced_qgis/gps_visualize17.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="18" style="list-style-type: decimal">
<li>Check the <em>Loop</em> button and hit the <em>Play</em> button. You
will see the map canvas animate to show the trip progress.</li>
</ol>
<p><img src="images/advanced_qgis/gps_visualize18.png" width="75%" style="display: block; margin: auto;" /></p>
<p>Your output should match the contents of the
<code>GPS_Animation_Checkpoint1.qgz</code> file in the
<code>solutions</code> folder.</p>
</div>
<div id="placing-labels-on-animation" class="section level3">
<h3>4.3.4 Placing Labels on Animation</h3>
<p>In the previous exercise, we used the <em>Title Label
Decorations</em> to display the time of the animation. There is another
approach that offers more flexibility in label placement and styling.
Let’s add a label to display the timestamp.</p>
<ol style="list-style-type: decimal">
<li>We will create a new point layer and add a point feature at the
place where we want the label. Go to <em>Layer → Create layer → New
Geopackage Layer</em>.</li>
</ol>
<p><img src="images/advanced_qgis/gps_label1.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="2" style="list-style-type: decimal">
<li>In the <em>New GeoPackage Layer</em> dialog, click the <em>…</em>
button and browse to a directory on your computer. Enter the name
<strong>label.gpkg</strong>. Select <strong>Point</strong> as the
<em>Geometry type</em> and click <em>OK</em>.</li>
</ol>
<p><img src="images/advanced_qgis/gps_label2.png" width="50%" style="display: block; margin: auto;" /></p>
<ol start="3" style="list-style-type: decimal">
<li>Click <em>Toggle Editing</em> button from the <em>Digitizing
Toolbar</em>. Once enabled, click the <em>Add Point Feature</em> button.
Click at the location where you want to place the timestamp label.</li>
</ol>
<p><img src="images/advanced_qgis/gps_label3.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="4" style="list-style-type: decimal">
<li>In the <em>Feature Attribute</em> pop-up, click <em>OK</em>.</li>
</ol>
<p><img src="images/advanced_qgis/gps_label4.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="5" style="list-style-type: decimal">
<li>A point will be added on the canvas. Select the <code>label</code>
layer and click <em>Open the Layer Styling Panel</em> button. Switch to
the <em>Labels</em> tab and enter the following expression. GPS
timestamps are in UTC, so we uses the <code>to_interval()</code>
function to adjust the timestamp to the local timezone. Note the use of
the <strong>|</strong> character which will allow us to split the label
in multiple lines later on.</li>
</ol>
<pre><code>format_date( @map_start_time + to_interval(&#39;5 hours 30 mins&#39;), &#39;dd MMM, yyyy| hh:mm:ss&#39;)</code></pre>
<p><img src="images/advanced_qgis/gps_label5.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="6" style="list-style-type: decimal">
<li>Next, change the <em>Font</em>, <em>Size</em> and <em>Style</em> as
per your liking. Once done, switch to the <em>Formatting</em> tab.</li>
</ol>
<p><img src="images/advanced_qgis/gps_label6.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="7" style="list-style-type: decimal">
<li>Scroll down and under the <em>Multiple lines</em> section, enter
<strong>|</strong> as the <em>Wrap on character</em> value. Change the
<em>Alignment</em> to be <strong>Right</strong>.</li>
</ol>
<p><img src="images/advanced_qgis/gps_label7.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="8" style="list-style-type: decimal">
<li>Once you are satistfied with the label, switch to the
<em>Symbology</em> tab and set the <em>Size</em> to <strong>0</strong>.
This will make the point marker disappear.</li>
</ol>
<p><img src="images/advanced_qgis/gps_label8.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="9" style="list-style-type: decimal">
<li>It will be useful to add a title label to the animation as well. Go
to <strong>View → Decorations → Title Label Decorations.</strong> Click
the checkbox to enable it and then enter a title for your animation.
Adjust the <em>Font</em> as per your liking. Select <strong>Bottom
Center</strong> as the <em>Placement</em>. You can also add <em>Margin
from edge</em> by entering <strong>5</strong> as the <em>Vertical</em>
distance. Click <em>OK</em>.</li>
</ol>
<p><img src="images/advanced_qgis/gps_label9.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="10" style="list-style-type: decimal">
<li>If you preview your animation, you will notice that the label does
not update. Let’s fix it. Right-click the <code>label</code> layer and
click <em>Properties</em>. Switch to the <em>Temporal</em> tab. Check
the <em>Dynamic Temporal Control</em> button and select <strong>Redraw
Layer Only</strong>. This option merely refreshes the layer on every
frame of the animation.</li>
</ol>
<p><img src="images/advanced_qgis/gps_label10.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="11" style="list-style-type: decimal">
<li>Back in the main QGIS canvas, open the <em>Temporal Controller</em>
and preview your animation. The timestamp should now update with the
animation.</li>
</ol>
<p><img src="images/advanced_qgis/gps_label11.png" width="75%" style="display: block; margin: auto;" /></p>
<p>Your output should match the contents of the
<code>GPS_Animation_Checkpoint2.qgz</code> file in the
<code>solutions</code> folder.</p>
</div>
</div>
<div id="learn-more" class="section level2">
<h2>4.4 Learn more</h2>
<p>See the resources below to learn more about creating animations in
QGIS.</p>
<ul>
<li>Steven Bernard creates and posts publication quality animations
created using QGIS on on <a
href="https://x.com/sdbernard">Twitter/X</a>. Some of our favorites are
listed below:
<ul>
<li><a href="https://x.com/sdbernard/status/1374780461889773569">Suez
Canal blocked after huge container ship runs aground</a></li>
<li><a
href="https://medium.com/@steve.bernard/etcdf-optionscreating-animated-smoke-map-4cd8f3480da4">Creating
an animated smoke map</a></li>
</ul></li>
<li>Kurt Menke’s Animation Tutorials:
<ul>
<li><a
href="https://www.birdseyeviewgis.com/blog/2020/8/14/creating-a-covid-19-temporal-animation-with-qgis">Creating
a COVID-19 Temporal animation with QGIS</a></li>
<li><a href="https://www.youtube.com/watch?v=bzyB6sTNVfI">Displaying and
Animating Mesh Weather Data in QGIS</a></li>
</ul></li>
<li>Topi Tjukanov’s technique on creating animations that
<em>follow</em> an object:
<ul>
<li><a
href="https://medium.com/@tjukanov/geospatial-animations-with-qgis-atlas-995d7ddb2d67">Geospatial
animations with QGIS Atlas</a></li>
</ul></li>
</ul>
</div>
</div>
<div id="d-animations-1" class="section level1">
<h1>5. 3D Animations</h1>
<p>Recent versions of QGIS include native support for 3D data. Using
this feature, you can easily view, explore and animate 3D elevation
data. Note that your computer must have a supported graphics card for
this feature to work.</p>
<div id="create-a-3d-visualization" class="section level2">
<h2>5.1 Create a 3D Visualization</h2>
<p>We will work with a 5m Digital Elevation Model (DEM) of Denali peak
in Alaska and create a 3D visualization of the dataset.</p>
<ol style="list-style-type: decimal">
<li>Open the <strong>denali</strong> project from the data package. The
data contains the raw DEM layer and a hillshade layer created from the
DEM.</li>
</ol>
<p><img src="images/advanced_qgis/3d01.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="2" style="list-style-type: decimal">
<li>Let’s create a colorized hillshade. It is possible to drape an image
or colorized DEM to a hillshade layer using QGIS’s <strong>Layer
Blending Modes</strong>. Click on the <strong>Open the Layer Styling
Panel</strong> icon. In the <em>Layer styling</em> panel, choose
<code>denali_hillshade</code> and under <em>Layer Rendering</em> choose
<strong>Multiply</strong> as <em>Blending mode</em>. The selected layer
will be blended with the bottom layer. This is a great way to visualize
your elevation dataset.</li>
</ol>
<p><img src="images/advanced_qgis/3d02.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="3" style="list-style-type: decimal">
<li>Let’s view this data in 3D. Go to <strong>View → 3D Map Views → New
3D Map View</strong>.</li>
</ol>
<p><img src="images/advanced_qgis/3d03.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="4" style="list-style-type: decimal">
<li>A new map window will open containing the rendered map layers from
the main canvas. Click the <strong>Configure</strong> button.</li>
</ol>
<p><img src="images/advanced_qgis/3d04.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="5" style="list-style-type: decimal">
<li>In the <em>Terrain</em> section, select <strong>DEM (Raster
Layer)</strong> as the <em>Type</em>. Select <code>denali_dem</code>
layer as the <em>Elevation</em>. Click OK.</li>
</ol>
<p><img src="images/advanced_qgis/3d05.png" width="50%" style="display: block; margin: auto;" /></p>
<ol start="6" style="list-style-type: decimal">
<li>In the 3D view, you can hold the <em>Shift</em> key and drag your
mouse to tilt the top-down view. You will see the map in 3D. You can
also use the controls on the right-hand panel to tilt, zoom and pan the
view.</li>
</ol>
<p><img src="images/advanced_qgis/3d06.png" width="75%" style="display: block; margin: auto;" /></p>
<p>Your output should match the contents of the
<code>3DAnimation_Checkpoint1.qgz</code> file in the
<code>solutions</code> folder.</p>
</div>
<div id="create-a-3d-fly-through" class="section level2">
<h2>5.2 Create a 3D Fly-through</h2>
<ol style="list-style-type: decimal">
<li>Now we will create an animation. Click the <em>Animations</em>
button in the toolbar. To animate the view, we must define certain
<em>keyframes</em>. Once you define a specific view for keyframes at
different times, the system will try to smoothly animate the views
between them. You can use the slider to go to a specific time, use the
controls to set a specific view and click the <em>+</em> button to add a
keyframe. Click the <em>Play</em> button to see the animation in
action.</li>
</ol>
<p><img src="images/advanced_qgis/fly01.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="2" style="list-style-type: decimal">
<li>Once you are satisfied, click the <em>Export Animation Frames</em>
button. Choose an output directory on your computer and click OK.
Individual frames will be rendered and saved as separate files.</li>
</ol>
<p><img src="images/advanced_qgis/fly02.png" width="75%" style="display: block; margin: auto;" /></p>
<div id="challenge-5" class="section level3">
<h3>5.2.1 Challenge</h3>
<p>As we did in the previous section, you can use a service such as
<em><a href="https://ezgif.com/maker">ezgif.com</a></em> to create a
GIF/Video from these frames.</p>
<div class="float">
<img src="images/advanced_qgis/fly03.png" alt="View Animated GIF ↗" />
<div class="figcaption"><a href="images/advanced_qgis/3d.gif"
target="_blank">View Animated GIF ↗</a></div>
</div>
</div>
</div>
</div>
<div id="summary-aggregate-expressions" class="section level1">
<h1>6. Summary Aggregate Expressions</h1>
<p>QGIS expression engine has a powerful function called ‘summary
aggregates’ that allows evaluating a feature’s geometry and attributes
with those of another layer. Expressions can be used for static
calculations as well as on-the-fly computations, such as labels, virtual
fields, symbology etc. This enables some powerful use cases.</p>
<p>The summary aggregate function operates on all the values from a
different layer, returning a single summary value. The syntax of the
aggregate function is as follows</p>
<pre><code>aggregate(
  layer:=&#39;layer name or id&#39;,
  aggregate:=&#39;aggegate type&#39;,
  expression:=&#39;expression to aggregate&#39;,
  filter:=&#39;optional filter expression,
  concatenator:=&#39;optional string to use to join values&#39;,
  order_by:=&#39;optional expression to order the features&#39;
  )</code></pre>
<p><a
href="https://docs.google.com/presentation/d/1F-gH729oWv4zcCecXd9BYoNdqHr7KaahgMPm_4XCgBY/edit?usp=sharing"
target="_blank"><img src="images/advanced_qgis/expressions.png"
width="400" alt="View Presentation" /></a></p>
<p><a
href="https://docs.google.com/presentation/d/1F-gH729oWv4zcCecXd9BYoNdqHr7KaahgMPm_4XCgBY/edit?usp=sharing"
target="_blank">View the Presentation</a></p>
<div id="auto-populate-field-values" class="section level2">
<h2>6.1 Auto-populate Field Values</h2>
<p>We will work with a land parcels data layer provided by the City of
San Francisco. The goal of this exercise is to demonstrate the use of
aggregate expression for on-the-fly computation when digitizing new
features.</p>
<ol style="list-style-type: decimal">
<li>Open the <strong>parcels</strong> project from the data package.
Select the <code>boundary</code> layer and click the <strong>Open Field
Calculator</strong> button.</li>
</ol>
<p><img src="images/advanced_qgis/aggregate1.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="2" style="list-style-type: decimal">
<li>Add a new field named <code>count</code> with the following
expression. The expression is reading the features from the
<code>parcels</code> layer and giving an aggregate count of the
features. You will notice that the the result will be displayed at the
bottom of the window.</li>
</ol>
<pre><code>aggregate(
 layer:= &#39;parcels&#39;,
 aggregate:=&#39;count&#39;,
 expression:=&quot;fid&quot;
 )</code></pre>
<p><img src="images/advanced_qgis/aggregate2.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="3" style="list-style-type: decimal">
<li>Now we can apply the same concept in a dynamic calculation. Back in
the main QGIS window, select the <code>polygons</code> layer and
right-click it. Select <strong>Properties</strong>.</li>
</ol>
<p><img src="images/advanced_qgis/aggregate3.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="4" style="list-style-type: decimal">
<li>Switch to the <strong>Attributes Form</strong> tab. Select the field
<code>count</code> and choose <strong>Text Edit</strong> as the
<em>Widget Type</em>. At the <strong>Default Value</strong> field at the
bottom, enter the following expression. Note that additional filter
value. Here the <code>$geometry</code> refers to the geometry of the
<code>parcels</code> layer and <code>geometry(@parent)</code> refers to
the geometry of feature from the <code>polygons</code> layer. Click
OK.</li>
</ol>
<pre><code>aggregate(
 layer:= &#39;parcels&#39;,
 aggregate:=&#39;count&#39;,
 expression:=&quot;fid&quot;,
 filter:=intersects($geometry, geometry(@parent))
 )</code></pre>
<p><img src="images/advanced_qgis/aggregate4.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="5" style="list-style-type: decimal">
<li>Back in QGIS, click the <strong>Toggle Editing</strong> button and
draw a polygon using the <strong>Add Polygon Feature</strong> button.
Right-click to finish the drawing. As soon as you finish, the count of
intersecting features will be calculated by the aggregate expression and
displayed in the <code>count</code> field.</li>
</ol>
<div class="float">
<img src="images/advanced_qgis/aggregate5.png"
alt="View Animated GIF ↗" />
<div class="figcaption"><a href="images/advanced_qgis/aggregate5.gif"
target="_blank">View Animated GIF ↗</a></div>
</div>
<ol start="6" style="list-style-type: decimal">
<li>There are many different types of aggregates available. We can use
an aggregate called <strong>concatenate</strong> to compute a
comma-separated text of all feature ids. Go to the <strong>Attribute
Form</strong> properties again and select the <code>parcels</code>
field. Enter the following expression as the <strong>Default
Value</strong>.</li>
</ol>
<pre><code>aggregate(
 layer:= &#39;parcels&#39;,
 aggregate:=&#39;concatenate&#39;,
 concatenator:=&#39;,&#39;,
 expression:=to_string(&quot;fid&quot;),
 filter:=intersects($geometry, geometry(@parent))
 )</code></pre>
<p><img src="images/advanced_qgis/aggregate6.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="7" style="list-style-type: decimal">
<li>Now when to add a new feature, all the intersecting feature ids will
be displayed along with the count.</li>
</ol>
<p><img src="images/advanced_qgis/aggregate7.png"
alt="View Animated GIF ↗" /> Your output should match the contents of
the <code>Expressions_Checkpoint1.qgz</code> file in the
<code>solutions</code> folder.</p>
<div id="challenge-6" class="section level3">
<h3>6.1.1 Challenge</h3>
<p>Add a new field in the <code>parcels</code> layer called
<strong>neighbors</strong> with the count of neighboring polygons. Use
that field to find the parcel having the highest number of
neighbors.</p>
<p>Hint: You can use the <code>aggregate()</code> function on the same
layer to compare each feature against all other features in the layer.
The <code>@layer</code> variable contains the name of the current layer,
so you can use the below expression</p>
<pre><code>aggregate(
    layer:=@layer,
    aggregate:=&#39;count&#39;,
    expression:=&quot;fid&quot;,
    filter:=touches($geometry, geometry(@parent)))</code></pre>
</div>
</div>
<div id="learn-more-1" class="section level2">
<h2>6.2 Learn more</h2>
<p>Apart from <code>aggregate()</code>, there are other advanced
functions in the expression engine. Learn about these in the following
video where I explain some fun and practical use cases that leverage
QGIS expressions.</p>
<p><a href="https://www.youtube.com/watch?v=4Rtwqv_z-F4"
target="_blank"><img
src="https://img.youtube.com/vi/4Rtwqv_z-F4/mqdefault.jpg"
alt="Watch the Video" /></a></p>
<p><a href="https://www.youtube.com/watch?v=4Rtwqv_z-F4"
target="_blank">Watch the Video ↗</a></p>
</div>
</div>
<div id="useful-plugins" class="section level1">
<h1>7. Useful Plugins</h1>
<p><a
href="https://docs.google.com/presentation/d/1T02HeNaCHdWD7TuDdy1IrcYycVshd4kDik1WR_11-58/edit?usp=sharing"
target="_blank"><img src="images/advanced_qgis/plugins.png" width="400"
alt="View Presentation" /></a></p>
<p><a
href="https://docs.google.com/presentation/d/1T02HeNaCHdWD7TuDdy1IrcYycVshd4kDik1WR_11-58/edit?usp=sharing"
target="_blank">View the Presentation</a></p>
</div>
<div id="supplement" class="section level1">
<h1>Supplement</h1>
<div id="using-conditions-in-modeler" class="section level2">
<h2>Using Conditions in Modeler</h2>
<p>A key feature introduced in QGIS 3.14 was the ability for models to
have a conditional branch. This allows models to check for a condition
and execute a different part of the model based on the output of the
condition. This is equivalent to <em>If/Else statements</em> in a
programming language.</p>
<p>Let us develop a <em>Conditional branch</em> in the
<code>piracy_hexbin</code> model covered in the previous section. We
will add a new check-box input <em>Use Spatial Index</em> - that allows
the user to specify whether to use a spatial index in the model. We will
add a conditional branch that takes the following actions:</p>
<ul>
<li>If the <em>Use Spatial Index</em> option is selected, the model will
create a spatial index for the grid layer and use it in the subsequent
steps.</li>
<li>If the option is not selected, the model will proceed without
generating a spatial index.</li>
</ul>
<blockquote>
<p>You can download the <a
href="https://drive.google.com/uc?export=download&amp;id=1nEFAEG-3McP1m_cVwsFn6UAA5oFg-JGm"><code>piracy_hexbin_conditional_branch.model3</code></a>
file which has the complete model with the conditional branch developed
as per instructions below. You can open this downloaded file from the
<em>Processing Toolbox Menu → Models → Open Existing Model</em>.</p>
</blockquote>
<ol style="list-style-type: decimal">
<li>Right-click the <code>piracy_hexbin</code> model and select
<strong>Edit Model…</strong>.</li>
</ol>
<p><img src="images/advanced_qgis/conditionalBranch01.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="2" style="list-style-type: decimal">
<li>Search for <strong>+Boolean</strong> in <em>Inputs</em> tab and drag
to canvas.</li>
</ol>
<p><img src="images/advanced_qgis/conditionalBranch02.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="3" style="list-style-type: decimal">
<li>Give <em>Description</em> as <strong>Use Spatial Index</strong>,
leave <strong>Checked</strong> unticked. Click <strong>OK</strong>.</li>
</ol>
<p><img src="images/advanced_qgis/conditionalBranch03.png" width="50%" style="display: block; margin: auto;" /></p>
<ol start="4" style="list-style-type: decimal">
<li>Now, search for <strong>Conditional branch</strong> in
<em>Algorithms</em> tabs and drag to canvas.</li>
</ol>
<p><img src="images/advanced_qgis/conditionalBranch04.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="5" style="list-style-type: decimal">
<li>Click the Add button and select the Expression Dialog button.</li>
</ol>
<p><img src="images/advanced_qgis/conditionalBranch05.png" width="75%" style="display: block; margin: auto;" />
6. All the model output and intermediate layers will be displayed in
Bold characters, double click on <strong>use_spatial_index</strong>. It
will add the variable <code>@use_spatial_index</code> as the expression.
Click <em>OK</em>.</p>
<p><img src="images/advanced_qgis/conditionalBranch06.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="7" style="list-style-type: decimal">
<li>Now, in <em>Branch Name</em> type <strong>Use Spatial
Index</strong>. We will add another branch now. Click the <em>Add</em>
button and enter the <em>Branch Name</em> as <strong>Don’t Use Spatial
Index</strong>. Since this is the opposite condition, we can use the
expression <code>NOT @use_spatial_index</code> Click <em>OK</em>.</li>
</ol>
<blockquote>
<p>Make sure to hit the <em>Enter</em> key after typing the <em>Branch
Name</em>. The input may not be saved if you forget to do so.</p>
</blockquote>
<p><img src="images/advanced_qgis/conditionalBranch07.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="8" style="list-style-type: decimal">
<li>We have 2 branches in the model. Let’s connect them to appropriate
algorithms. Double click on <code>Create spatial index</code> algorithm
in model canvas and click <em>…</em> next to <em>Dependencies.</em></li>
</ol>
<p><img src="images/advanced_qgis/conditionalBranch08.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="9" style="list-style-type: decimal">
<li>Choose <strong>Condition “Use Spatial Index” from algorithm
“Conditional branch”</strong> and click <strong>OK</strong>. The <em>Use
Spatial Index</em> branch is now ready. Let’s build the other
branch.</li>
</ol>
<p><img src="images/advanced_qgis/conditionalBranch09.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="10" style="list-style-type: decimal">
<li>Search for <strong>Extract by location</strong> in
<em>Algorithms</em> tab and drag to canvas.</li>
</ol>
<p><img src="images/advanced_qgis/conditionalBranch10.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="11" style="list-style-type: decimal">
<li>In the <em>Description</em> type <strong>Extract by location (No
Spatial Index)</strong>. Choose <em>Algorithm Output</em> in <em>Extract
features from</em> and select <strong>“Grid” from algorithm “Create
grid”</strong>. Click <em>…</em> next to <em>Dependencies</em>.</li>
</ol>
<p><img src="images/advanced_qgis/conditionalBranch11.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="12" style="list-style-type: decimal">
<li>Choose <strong>Condition “Don’t use Spatial Index” from algorithm
“Conditional branch”</strong>. Click <strong>OK</strong>.</li>
</ol>
<p><img src="images/advanced_qgis/conditionalBranch12.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="13" style="list-style-type: decimal">
<li>Similarly in <em>Extract by location</em> using <em>Spatial
Index</em> change the description to <strong>Extract by location
(Spatial Index)</strong>. Both the branches will be executed according
to the user selection whether to use the spatial index or not. The next
step is to update the the <em>Count points in polygon</em> algorithm to
use the appropriate output. Double-click on the algorithm box.</li>
</ol>
<p><img src="images/advanced_qgis/conditionalBranch13.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="14" style="list-style-type: decimal">
<li>Under <em>Polygons</em> change <em>Algorithm output</em> to
<em>Pre-calculated Value</em>, then press the <em>Expression</em>
button.</li>
</ol>
<p><img src="images/advanced_qgis/conditionalBranch14.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="15" style="list-style-type: decimal">
<li>In the <em>Expression Dialog</em>, we need to select output from any
one of the <em>Extract by location</em> algorithms based on the user
condition of <code>@use_spatial_index</code>. We can use the
<code>if</code> condition to return a layer based on user input. Use the
expression below. Remember to pick the variables from the list and
double-click them to enter them in your expression. If you had named the
algorithms or input differently, the variable names will be different
for you. Click <strong>OK</strong>.</li>
</ol>
<pre><code>if( @use_spatial_index ,  
    @Extract_by_location__Spatial_Index__OUTPUT ,
    @Extract_by_location__No_Spatial_Index__OUTPUT) </code></pre>
<p><img src="images/advanced_qgis/conditionalBranch15.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="16" style="list-style-type: decimal">
<li>Now click … in <em>Dependencies</em>.</li>
</ol>
<p><img src="images/advanced_qgis/conditionalBranch16.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="17" style="list-style-type: decimal">
<li>Check <code>Extract by location (Spatial Index)</code> and
<code>Extract by location (No Spatial Index)</code> and click
<strong>OK</strong>.</li>
</ol>
<p><img src="images/advanced_qgis/conditionalBranch17.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="18" style="list-style-type: decimal">
<li>Now that the model is completed, click <strong>Zoom full</strong>
button to view the model. Let us save the model click <strong>Save
model</strong> button.</li>
</ol>
<p><img src="images/advanced_qgis/conditionalBranch18.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="19" style="list-style-type: decimal">
<li>Now in the <em>Processing toolbox</em>, under that <strong>Models →
projects → piracy_hexbin</strong> model will be available. Double click
to execute it.</li>
</ol>
<p><img src="images/advanced_qgis/conditionalBranch19.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="20" style="list-style-type: decimal">
<li>In the <em>Base Layer</em> select <strong>ne_10m_land</strong>,
<em>Grid size</em> as <strong>100000</strong>, and <em>Input points</em>
as <strong>ASAM_events</strong>, check <em>Use Spatial Index</em> and
click <strong>Run</strong>.</li>
</ol>
<p><img src="images/advanced_qgis/conditionalBranch20.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="21" style="list-style-type: decimal">
<li>Switch to <em>Log</em>, we can notice the <em>Create spatial
index</em> algorithm is activated, and the total time of execution is
7.41 seconds.</li>
</ol>
<p><img src="images/advanced_qgis/conditionalBranch21.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="22" style="list-style-type: decimal">
<li>Now switch to <em>Parameters</em>, un-check the <em>Use Spatial
Index</em> and click <strong>Run</strong>. tab.</li>
</ol>
<p><img src="images/advanced_qgis/conditionalBranch22.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="23" style="list-style-type: decimal">
<li>Switch to the <em>Log</em>, we can notice the <em>No spatial index
exists for input layer, performance will be severely degraded</em>
warning get displayed, and the execution took 78.897 seconds.</li>
</ol>
<p><img src="images/advanced_qgis/conditionalBranch23.png" width="75%" style="display: block; margin: auto;" /></p>
</div>
<div id="running-processing-algorithms-from-the-locator-bar"
class="section level2">
<h2>Running Processing Algorithms from the Locator Bar</h2>
<p>To take your processing experience to the next-level, you can use the
built-in <strong>Locator Bar</strong>. At the bottom-left of QGIS main
window, there is a universal search bar that can do keyword-search
across layers, settings, processing algorithms and more. You can open
the locator bar using the keyboard shortcut <strong>Ctrl+K</strong>.</p>
<p><img src="images/advanced_qgis/locator1.png" width="75%" style="display: block; margin: auto;" /></p>
<p>I find that rather than clicking-around the processing toolbox, you
can just use the locator bar to search and open the algorithms. Type
<strong>Ctrl+K</strong>, followed by <strong>a</strong> (to restrict
search to algorithms), followed by a <strong>space</strong> and
<strong>a few characters</strong>. Use the arrow keys to select and
press <strong>Enter</strong> to open the algorithm.</p>
<div class="float">
<img src="images/advanced_qgis/locator.png" alt="View Animated GIF ↗" />
<div class="figcaption"><a href="images/advanced_qgis/locator.gif"
target="_blank">View Animated GIF ↗</a></div>
</div>
</div>
<div id="in-place-editing" class="section level2">
<h2>In-place Editing</h2>
<p>Processing algorithms are designed to take inputs and produce
outputs. The default behavior is to create a new layer after each
operation. This is useful for many workflows, especially in an
enterprise setting, where you may not have the ability to edit the
source data. If your algorithms are altering the source data, that also
means that the workflows cannot be reproduced easily. So you would want
a setup where the algorithms read from source data and create modified
outputs.</p>
<p>An exception to this workflow is when you are doing data editing.
When your workflow involves creating new features or editing them -
creating a new layer for every edit is undesirable. A recent <a
href="https://north-road.com/edit-features-in-place-using-qgis-spatial-operations-campaign/">QGIS
crowd-funding campaign</a> added the ability for processing algorithms
to modify the features in-place and this functionality is available
out-of-the-box in QGIS now.</p>
<ol style="list-style-type: decimal">
<li>Load the <strong>basic_network_analysis</strong> project from the
data package. This project contains a street network for Washington DC
from DCGISopendata where the arrows display the digitizing direction of
the line segments. You can click the <strong>Edit Features
In-Place</strong> button in the processing toolbox to use algorithms
that support this functionality. Once this mode is activated, processing
algorithms will modify the selected features in the chosen layer instead
of creating a new layer.</li>
</ol>
<p><img src="images/advanced_qgis/inplace1.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="2" style="list-style-type: decimal">
<li>Select a line segment and run the <strong>Reverse line
direction</strong> algorithm. The algorithm will enable editing on the
layer, perform the operation and overwrite the existing feature with a
segment in the reverse direction. You will see that the arrow rendering
is now in the opposite direction.</li>
</ol>
<div class="float">
<img src="images/advanced_qgis/inplace2.png"
alt="View Animated GIF ↗" />
<div class="figcaption"><a href="images/advanced_qgis/inplace2.gif"
target="_blank">View Animated GIF ↗</a></div>
</div>
</div>
</div>
<div id="data-credits" class="section level1">
<h1>Data Credits</h1>
<ul>
<li>OpenStreetMap (osm) data layers: Data/Maps Copyright 2019 Geofabrik
GmbH and OpenStreetMap Contributors. <a
href="https://download.geofabrik.de/asia/india.html">OSM India free
extract</a> downloaded from Geofabrik.</li>
<li>India State boundary: Downloaded from <a
href="https://github.com/datameet/maps/tree/master/States">Datameet
Spatial Data repository</a>.</li>
<li>Anti-shipping Activity Messages: <a
href="https://msi.nga.mil/NGAPortal/MSI.porta">Maritime Safety
Information portal</a> , National Geospatial-Intelligence Agency. Data
downloaded from <a href="https://msi.nga.mil/Piracy">ASAM Geospatial
Files</a>.</li>
<li>Land boundaries: Made with Natural Earth. Free vector and raster map
data @ naturalearthdata.com.</li>
<li>Road Network: District of Columbia <a
href="https://opendata.dc.gov/">Open Data Catalog</a>.</li>
<li><a
href="https://www.usgs.gov/centers/eros/science/usgs-eros-archive-digital-elevation-interferometric-synthetic-aperture-radar">Alaska
IFSAR DTM</a> distributed by USGS Earth Resources Observation and
Science (EROS), Downloaded from USGS Earth Explorer</li>
<li>Parcels and Neighborhood boundaries downloaded from <a
href="https://datasf.org/opendata/">DataSF Open Data Portal</a></li>
</ul>
</div>
<div id="license" class="section level1">
<h1>License</h1>
<p>This course material is licensed under a <a
href="https://creativecommons.org/licenses/by/4.0/">Creative Commons
Attribution 4.0 International (CC BY 4.0)</a>. You are free to re-use
and adapt the material but are required to give appropriate credit to
the original author as below:</p>
<p><em>Advanced QGIS Course</em> by Ujaval Gandhi <a
href="https://spatialthoughts.com">www.spatialthoughts.com</a></p>
<!--
If you would like to white-label these materials as part of a commercial offering, you can purchase a *Trainer License* for a small fee. Please [contact us](https://spatialthoughts.com/contact/) for pricing and terms.


This material is part of the *Trainer's Package* and the buyer gets a non-exclusive, non-transferable, perpetual license to the material. You can fully customize and brand the materials to your requirements.
-->
<hr />
<p><strong>This course is offered as an instructor-led online class.
Visit <a href="https://spatialthoughts.com/events/">Spatial Thoughts</a>
to know details of upcoming sessions.</strong></p>
<hr />
<p>© 2021 Spatial Thoughts <a
href="https://spatialthoughts.com">www.spatialthoughts.com</a></p>
</div>

<!-- Comment Section Powered by utterances -->
<div id="comments">
  <hr />
  <p>If you want to report any issues with this page, please comment below.</p>
<script src="https://utteranc.es/client.js"
        repo="spatialthoughts/courses"
        issue-term="title"
        label="comment"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>
</div>



</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.odd').parent('tbody').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open');
  });
});
</script>

<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
