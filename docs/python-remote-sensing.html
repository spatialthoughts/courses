<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />


<meta name="author" content="Ujaval Gandhi" />


<title>Scalable Remote Sensing Workflows with Xarray (Full Workshop)</title>

<script src="site_libs/header-attrs-2.10/header-attrs.js"></script>
<script src="site_libs/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/flatly.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<style>h1 {font-size: 34px;}
       h1.title {font-size: 38px;}
       h2 {font-size: 30px;}
       h3 {font-size: 24px;}
       h4 {font-size: 18px;}
       h5 {font-size: 16px;}
       h6 {font-size: 12px;}
       code {color: inherit; background-color: rgba(0, 0, 0, 0.04);}
       pre:not([class]) { background-color: white }</style>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<link href="site_libs/pagedtable-1.1/css/pagedtable.css" rel="stylesheet" />
<script src="site_libs/pagedtable-1.1/js/pagedtable.js"></script>
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-PDGF11RK4Z"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-PDGF11RK4Z');
</script>

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>


<style type="text/css">
  code {
    white-space: pre;
  }
  .sourceCode {
    overflow: visible;
  }
</style>
<style type="text/css" data-origin="pandoc">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */

</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    for (var j = 0; j < rules.length; j++) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") continue;
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') continue;
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>







<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
pre code {
  padding: 0;
}
</style>


<style type="text/css">
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #adb5bd;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script type="text/javascript">
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.tab('show');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');

  // Navbar adjustments
  var navHeight = $(".navbar").first().height() + 15;
  var style = document.createElement('style');
  var pt = "padding-top: " + navHeight + "px; ";
  var mt = "margin-top: -" + navHeight + "px; ";
  var css = "";
  // offset scroll position for anchor links (for fixed navbar)
  for (var i = 1; i <= 6; i++) {
    css += ".section h" + i + "{ " + pt + mt + "}\n";
  }
  style.innerHTML = "body {" + pt + "padding-bottom: 40px; }\n" + css;
  document.head.appendChild(style);
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "&#xe258;";
  border: none;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->




</head>

<body>


<div class="container-fluid main-container">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">Courses</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="http://spatialthoughts.com">Back to Main Site</a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li>
  <a href="#">Back to Top</a>
</li>
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div id="header">



<h1 class="title toc-ignore">Scalable Remote Sensing Workflows with
Xarray (Full Workshop)</h1>
<h3 class="subtitle">A structured introduction to XArray, STAC and Dask
with use-cases focused on cloud-based remote sensing applications.</h3>
<h4 class="author">Ujaval Gandhi</h4>

</div>

<div id="TOC">
<ul>
<li><a href="#introduction" id="toc-introduction">Introduction</a></li>
<li><a href="#notebooks-and-datasets"
id="toc-notebooks-and-datasets">Notebooks and Datasets</a></li>
<li><a href="#hello-colab" id="toc-hello-colab">Hello Colab</a></li>
<li><a href="#xarray-basics" id="toc-xarray-basics">XArray
Basics</a></li>
<li><a href="#stac-and-dask-basics" id="toc-stac-and-dask-basics">STAC
and Dask Basics</a></li>
<li><a href="#license" id="toc-license">License</a></li>
</ul>
</div>

<div style="page-break-after: always;"></div>
<hr />
<p><img src="images/spatial_thoughts_logo.png" width="250pt" style="display: block; margin: auto;" /></p>
<hr />
<div style="page-break-after: always;"></div>
<div id="introduction" class="section level1">
<h1>Introduction</h1>
<p>XArray is a powerful Python package for working with climate and
earth observation datasets. Inspired by libraries like pandas - it is
particularly suited for working with multi-dimensional time-series
raster datasets. With the growing ecosystem of spatial extensions like
rioxarray and xarray-spatial and built-in support for parallel computing
with Dask, it has become the de-facto standard for working with large
spatio-temporal raster datasets. This workshop will show you how you can
use it to effectively process large volumes of earth observation data
using cloud-based datasets.</p>
</div>
<div id="notebooks-and-datasets" class="section level1">
<h1>Notebooks and Datasets</h1>
<p>This workshop uses Google Colab for all exercises. You do not need to
install any packages or download any datasets.</p>
<p>The notebooks can be accessed by clicking on the <img
src="https://colab.research.google.com/assets/colab-badge.svg"
alt="Open In Colab" /> buttons at the beginning of each section. Once
you have opened the notebook in Colab, you can copy it to your own
account by going to <em>File → Save a Copy in Drive</em>.</p>
<p><img src="images/common/colab1.png" width="75%" style="display: block; margin: auto;" /></p>
<p>Once the notebooks are saved to your drive, you will be able to
modify the code and save the updated copy. You can also click the
<em>Share</em> button and share a link to the notebook with others.</p>
<p><img src="images/common/colab2.png" width="75%" style="display: block; margin: auto;" /></p>
</div>
<div id="hello-colab" class="section level1">
<h1>Hello Colab</h1>
<p><a
href="https://colab.research.google.com/github/spatialthoughts/python-dataviz-web/blob/main/00_hello_colab.ipynb"><img
src="https://colab.research.google.com/assets/colab-badge.svg"
alt="Open In Colab" /></a></p>
<p><a href="https://colab.research.google.com/">Google Colab</a> is a
hosted Jupyter notebook environment that allows anyone to run Python
code via a web-browser. It provides you free computation and data
storage that can be utilized by your Python code.</p>
<p>You can click the <code>+Code</code> button to create a new cell and
enter a block of code. To run the code, click the <strong>Run
Code</strong> button next to the cell, or press <code>Shirt+Enter</code>
key.</p>
<div class="sourceCode" id="cb1"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&#39;Hello World&#39;</span>)</span></code></pre></div>
<div id="package-management" class="section level3">
<h3>Package Management</h3>
<p>Colab comes pre-installed with many Python packages. You can use a
package by simply importing it.</p>
<div class="sourceCode" id="cb2"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb2-2"><a href="#cb2-2" tabindex="-1"></a><span class="im">import</span> geopandas <span class="im">as</span> gpd</span></code></pre></div>
<p>Each Colab notebook instance is run on a Ubuntu Linux machine in the
cloud. If you want to install any packages, you can run a command by
prefixing the command with a <code>!</code>. For example, you can
install third-party packages via <code>pip</code> using the command
<code>!pip</code>.</p>
<blockquote>
<p>Tip: If you want to list all pre-install packages and their versions
in your Colab environemnt, you can run <code>!pip list -v</code>.</p>
</blockquote>
<div class="sourceCode" id="cb3"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a><span class="op">!</span>pip install rioxarray</span></code></pre></div>
<div class="sourceCode" id="cb4"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a><span class="im">import</span> rioxarray</span></code></pre></div>
</div>
<div id="data-management" class="section level3">
<h3>Data Management</h3>
<p>Colab provides 100GB of disk space along with your notebook. This can
be used to store your data, intermediate outputs and results.</p>
<p>The code below will create 2 folders named ‘data’ and ‘output’ in
your local filesystem.</p>
<div class="sourceCode" id="cb5"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb5-2"><a href="#cb5-2" tabindex="-1"></a></span>
<span id="cb5-3"><a href="#cb5-3" tabindex="-1"></a>data_folder <span class="op">=</span> <span class="st">&#39;data&#39;</span></span>
<span id="cb5-4"><a href="#cb5-4" tabindex="-1"></a>output_folder <span class="op">=</span> <span class="st">&#39;output&#39;</span></span>
<span id="cb5-5"><a href="#cb5-5" tabindex="-1"></a></span>
<span id="cb5-6"><a href="#cb5-6" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> os.path.exists(data_folder):</span>
<span id="cb5-7"><a href="#cb5-7" tabindex="-1"></a>    os.mkdir(data_folder)</span>
<span id="cb5-8"><a href="#cb5-8" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> os.path.exists(output_folder):</span>
<span id="cb5-9"><a href="#cb5-9" tabindex="-1"></a>    os.mkdir(output_folder)</span></code></pre></div>
<p>We can download some data from the internet and store it in the Colab
environment. Below is a helper function to download a file from a
URL.</p>
<div class="sourceCode" id="cb6"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a><span class="im">import</span> requests</span>
<span id="cb6-2"><a href="#cb6-2" tabindex="-1"></a></span>
<span id="cb6-3"><a href="#cb6-3" tabindex="-1"></a><span class="kw">def</span> download(url):</span>
<span id="cb6-4"><a href="#cb6-4" tabindex="-1"></a>    filename <span class="op">=</span> os.path.join(data_folder, os.path.basename(url))</span>
<span id="cb6-5"><a href="#cb6-5" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> os.path.exists(filename):</span>
<span id="cb6-6"><a href="#cb6-6" tabindex="-1"></a>      <span class="cf">with</span> requests.get(url, stream<span class="op">=</span><span class="va">True</span>, allow_redirects<span class="op">=</span><span class="va">True</span>) <span class="im">as</span> r:</span>
<span id="cb6-7"><a href="#cb6-7" tabindex="-1"></a>          <span class="cf">with</span> <span class="bu">open</span>(filename, <span class="st">&#39;wb&#39;</span>) <span class="im">as</span> f:</span>
<span id="cb6-8"><a href="#cb6-8" tabindex="-1"></a>              <span class="cf">for</span> chunk <span class="kw">in</span> r.iter_content(chunk_size<span class="op">=</span><span class="dv">8192</span>):</span>
<span id="cb6-9"><a href="#cb6-9" tabindex="-1"></a>                  f.write(chunk)</span>
<span id="cb6-10"><a href="#cb6-10" tabindex="-1"></a>      <span class="bu">print</span>(<span class="st">&#39;Downloaded&#39;</span>, filename)</span></code></pre></div>
<p>Let’s download the <a
href="https://www.naturalearthdata.com/downloads/10m-cultural-vectors/">Populated
Places</a> dataset from Natural Earth.</p>
<div class="sourceCode" id="cb7"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a>download(<span class="st">&#39;https://naciscdn.org/naturalearth/10m/cultural/&#39;</span> <span class="op">+</span></span>
<span id="cb7-2"><a href="#cb7-2" tabindex="-1"></a>         <span class="st">&#39;ne_10m_populated_places_simple.zip&#39;</span>)</span></code></pre></div>
<p>The file is now in our local filesystem. We can construct the path to
the data folder and read it using <code>geopandas</code></p>
<div class="sourceCode" id="cb8"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a><span class="bu">file</span> <span class="op">=</span> <span class="st">&#39;ne_10m_populated_places_simple.zip&#39;</span></span>
<span id="cb8-2"><a href="#cb8-2" tabindex="-1"></a>filepath <span class="op">=</span> os.path.join(data_folder, <span class="bu">file</span>)</span>
<span id="cb8-3"><a href="#cb8-3" tabindex="-1"></a>places <span class="op">=</span> gpd.read_file(filepath)</span></code></pre></div>
<p>Let’s do some data processing and write the results to a new file.
The code below will filter all places which are also country
capitals.</p>
<div class="sourceCode" id="cb9"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a>capitals <span class="op">=</span> places[places[<span class="st">&#39;adm0cap&#39;</span>] <span class="op">==</span> <span class="dv">1</span>]</span>
<span id="cb9-2"><a href="#cb9-2" tabindex="-1"></a>capitals</span></code></pre></div>
<p>We can write the results to the disk as a GeoPackage file.</p>
<div class="sourceCode" id="cb10"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" tabindex="-1"></a>output_file <span class="op">=</span> <span class="st">&#39;capitals.gpkg&#39;</span></span>
<span id="cb10-2"><a href="#cb10-2" tabindex="-1"></a>output_path <span class="op">=</span> os.path.join(output_folder, output_file)</span>
<span id="cb10-3"><a href="#cb10-3" tabindex="-1"></a>capitals.to_file(driver<span class="op">=</span><span class="st">&#39;GPKG&#39;</span>, filename<span class="op">=</span>output_path)</span></code></pre></div>
<p>You can open the <strong>Files</strong> tab from the left-hand panel
in Colab and browse to the <code>output</code> folder. Locate the
<code>capitals.gpkg</code> file and click the <strong>⋮</strong> button
and select <em>Download</em> to download the file locally.</p>
</div>
</div>
<div id="xarray-basics" class="section level1">
<h1>XArray Basics</h1>
<p><a
href="https://colab.research.google.com/github/spatialthoughts/courses/blob/master/code/python_remote_sensing/xarray_basics.ipynb"><img
src="https://colab.research.google.com/assets/colab-badge.svg"
alt="Open In Colab" /></a></p>
<div id="overview" class="section level2">
<h2>Overview</h2>
<p><a href="https://docs.xarray.dev/en/stable/"><code>XArray</code></a>
has emerged as one of the key Python libraries to work with gridded
raster datasets. It can natively handle time-series data making it ideal
for working with Remote Sensing datasets. It builds on NumPy/Pandas for
fast arrays/indexing and is orders of magnitude faster than other Python
libraries like <code>rasterio</code>. It has a growing ecosystem of
extensions <code>rioxarray</code>, <code>xarray-spatial</code>,
<code>XEE</code> and more allowing it to be used for geospatial
analysis. XArray offers the flexibility to seamlessly work with local
datasets along with cloud-hosted datasets in a variety of optimized data
formats.</p>
<p>In this section, we will learn about XArray basics and learn how to
work with a time-series of Sentinel-2 satellite imagery to create and
visualize a median composite image.</p>
</div>
<div id="setup-and-data-download" class="section level2">
<h2>Setup and Data Download</h2>
<p>The following blocks of code will install the required packages and
download the datasets to your Colab environment.</p>
<div class="sourceCode" id="cb11"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" tabindex="-1"></a><span class="op">%%</span>capture</span>
<span id="cb11-2"><a href="#cb11-2" tabindex="-1"></a><span class="cf">if</span> <span class="st">&#39;google.colab&#39;</span> <span class="kw">in</span> <span class="bu">str</span>(get_ipython()):</span>
<span id="cb11-3"><a href="#cb11-3" tabindex="-1"></a>    <span class="op">!</span>pip install pystac<span class="op">-</span>client odc<span class="op">-</span>stac rioxarray dask</span></code></pre></div>
<div class="sourceCode" id="cb12"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb12-2"><a href="#cb12-2" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb12-3"><a href="#cb12-3" tabindex="-1"></a><span class="im">import</span> pystac_client</span>
<span id="cb12-4"><a href="#cb12-4" tabindex="-1"></a><span class="im">from</span> odc.stac <span class="im">import</span> stac_load</span>
<span id="cb12-5"><a href="#cb12-5" tabindex="-1"></a><span class="im">import</span> xarray <span class="im">as</span> xr</span>
<span id="cb12-6"><a href="#cb12-6" tabindex="-1"></a><span class="im">import</span> rioxarray <span class="im">as</span> rxr</span></code></pre></div>
<div class="sourceCode" id="cb13"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" tabindex="-1"></a>data_folder <span class="op">=</span> <span class="st">&#39;data&#39;</span></span>
<span id="cb13-2"><a href="#cb13-2" tabindex="-1"></a>output_folder <span class="op">=</span> <span class="st">&#39;output&#39;</span></span>
<span id="cb13-3"><a href="#cb13-3" tabindex="-1"></a></span>
<span id="cb13-4"><a href="#cb13-4" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> os.path.exists(data_folder):</span>
<span id="cb13-5"><a href="#cb13-5" tabindex="-1"></a>    os.mkdir(data_folder)</span>
<span id="cb13-6"><a href="#cb13-6" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> os.path.exists(output_folder):</span>
<span id="cb13-7"><a href="#cb13-7" tabindex="-1"></a>    os.mkdir(output_folder)</span></code></pre></div>
</div>
<div id="get-satellite-imagery" class="section level2">
<h2>Get Satellite Imagery</h2>
<p>We define a location and time of interest to get some satellite
imagery.</p>
<div class="sourceCode" id="cb14"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" tabindex="-1"></a>latitude <span class="op">=</span> <span class="fl">27.163</span></span>
<span id="cb14-2"><a href="#cb14-2" tabindex="-1"></a>longitude <span class="op">=</span> <span class="fl">82.608</span></span>
<span id="cb14-3"><a href="#cb14-3" tabindex="-1"></a>year <span class="op">=</span> <span class="dv">2023</span></span></code></pre></div>
<p>Let’s use Element84 search endpoint to look for items from the
sentinel-2-l2a collection on AWS.</p>
<div class="sourceCode" id="cb15"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" tabindex="-1"></a>catalog <span class="op">=</span> pystac_client.Client.<span class="bu">open</span>(</span>
<span id="cb15-2"><a href="#cb15-2" tabindex="-1"></a>    <span class="st">&#39;https://earth-search.aws.element84.com/v1&#39;</span>)</span>
<span id="cb15-3"><a href="#cb15-3" tabindex="-1"></a></span>
<span id="cb15-4"><a href="#cb15-4" tabindex="-1"></a><span class="co"># Define a small bounding box around the chosen point</span></span>
<span id="cb15-5"><a href="#cb15-5" tabindex="-1"></a>km2deg <span class="op">=</span> <span class="fl">1.0</span> <span class="op">/</span> <span class="dv">111</span></span>
<span id="cb15-6"><a href="#cb15-6" tabindex="-1"></a>x, y <span class="op">=</span> (longitude, latitude)</span>
<span id="cb15-7"><a href="#cb15-7" tabindex="-1"></a>r <span class="op">=</span> <span class="dv">1</span> <span class="op">*</span> km2deg  <span class="co"># radius in degrees</span></span>
<span id="cb15-8"><a href="#cb15-8" tabindex="-1"></a>bbox <span class="op">=</span> (x <span class="op">-</span> r, y <span class="op">-</span> r, x <span class="op">+</span> r, y <span class="op">+</span> r)</span>
<span id="cb15-9"><a href="#cb15-9" tabindex="-1"></a></span>
<span id="cb15-10"><a href="#cb15-10" tabindex="-1"></a>search <span class="op">=</span> catalog.search(</span>
<span id="cb15-11"><a href="#cb15-11" tabindex="-1"></a>    collections<span class="op">=</span>[<span class="st">&#39;sentinel-2-c1-l2a&#39;</span>],</span>
<span id="cb15-12"><a href="#cb15-12" tabindex="-1"></a>    bbox<span class="op">=</span>bbox,</span>
<span id="cb15-13"><a href="#cb15-13" tabindex="-1"></a>    datetime<span class="op">=</span><span class="ss">f&#39;</span><span class="sc">{</span>year<span class="sc">}</span><span class="ss">&#39;</span>,</span>
<span id="cb15-14"><a href="#cb15-14" tabindex="-1"></a>    query<span class="op">=</span>{<span class="st">&#39;eo:cloud_cover&#39;</span>: {<span class="st">&#39;lt&#39;</span>: <span class="dv">30</span>}},</span>
<span id="cb15-15"><a href="#cb15-15" tabindex="-1"></a>)</span>
<span id="cb15-16"><a href="#cb15-16" tabindex="-1"></a>items <span class="op">=</span> search.item_collection()</span></code></pre></div>
<p>Load the matching images as a XArray Dataset.</p>
<div class="sourceCode" id="cb16"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" tabindex="-1"></a>ds <span class="op">=</span> stac_load(</span>
<span id="cb16-2"><a href="#cb16-2" tabindex="-1"></a>    items,</span>
<span id="cb16-3"><a href="#cb16-3" tabindex="-1"></a>    bands<span class="op">=</span>[<span class="st">&#39;red&#39;</span>, <span class="st">&#39;green&#39;</span>, <span class="st">&#39;blue&#39;</span>, <span class="st">&#39;nir&#39;</span>],</span>
<span id="cb16-4"><a href="#cb16-4" tabindex="-1"></a>    resolution<span class="op">=</span><span class="dv">10</span>,</span>
<span id="cb16-5"><a href="#cb16-5" tabindex="-1"></a>    bbox<span class="op">=</span>bbox,</span>
<span id="cb16-6"><a href="#cb16-6" tabindex="-1"></a>    chunks<span class="op">=</span>{},  <span class="co"># &lt;-- use Dask</span></span>
<span id="cb16-7"><a href="#cb16-7" tabindex="-1"></a>    groupby<span class="op">=</span><span class="st">&#39;solar_day&#39;</span>,</span>
<span id="cb16-8"><a href="#cb16-8" tabindex="-1"></a>)</span>
<span id="cb16-9"><a href="#cb16-9" tabindex="-1"></a>ds</span></code></pre></div>
<div class="sourceCode" id="cb17"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" tabindex="-1"></a><span class="op">%%</span>time</span>
<span id="cb17-2"><a href="#cb17-2" tabindex="-1"></a>ds <span class="op">=</span> ds.compute()</span></code></pre></div>
</div>
<div id="xarray-terminology" class="section level2">
<h2>XArray Terminology</h2>
<p>We now have a <code>xarray.Dataset</code> object. Let’s understand
what is contained in a Dataset.</p>
<ul>
<li><em>Variables</em>: This is similar to a band in a raster dataset.
Each variable contains an array of values.</li>
<li><em>Dimensions</em>: This is similar to number of array axes.</li>
<li><em>Coordinates</em>: These are the labels for values in each
dimension.</li>
<li><em>Attributes</em>: This is the metadata associated with the
dataset.</li>
</ul>
<p><img src='https://courses.spatialthoughts.com/images/common/xarray_terminology.png' width=800/></p>
<p>A Dataset consists of one or more <code>xarray.DataArray</code>
object. This is the main object that consists of a single variable with
dimension names, coordinates and attributes. You can access each
variable using <code>dataset.variable_name</code> syntax.</p>
<div class="sourceCode" id="cb18"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" tabindex="-1"></a>da <span class="op">=</span> ds.red</span>
<span id="cb18-2"><a href="#cb18-2" tabindex="-1"></a>da</span></code></pre></div>
</div>
<div id="selecting-data" class="section level2">
<h2>Selecting Data</h2>
<p>XArray provides a very powerful way to select subsets of data, using
similar framework as Pandas. Similar to Panda’s <code>loc</code> and
<code>iloc</code> methods, XArray provides <code>sel</code> and
<code>isel</code> methods. Since DataArray dimensions have names, these
methods allow you to specify which dimension to query.</p>
<p>Let’s select the temperature anomany values for the last time step.
Since we know the index (-1) of the datam we can use <code>isel</code>
method.</p>
<div class="sourceCode" id="cb19"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" tabindex="-1"></a>da.isel(time<span class="op">=-</span><span class="dv">1</span>)</span></code></pre></div>
<p>You can call <code>.values</code> on a DataArray to get an array of
the values.</p>
<div class="sourceCode" id="cb20"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" tabindex="-1"></a>da.isel(time<span class="op">=-</span><span class="dv">1</span>).values</span></code></pre></div>
<p>You can query for a values at using multiple dimensions.</p>
<div class="sourceCode" id="cb21"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" tabindex="-1"></a>da.isel(time<span class="op">=-</span><span class="dv">1</span>, x<span class="op">=-</span><span class="dv">1</span>, y<span class="op">=-</span><span class="dv">1</span>).values</span></code></pre></div>
<p>We can also specify a value to query using the <code>sel()</code>
method.</p>
<p>Let’s see what are the values of <code>time</code> variable.</p>
<div class="sourceCode" id="cb22"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" tabindex="-1"></a>dates <span class="op">=</span> da.time.values</span>
<span id="cb22-2"><a href="#cb22-2" tabindex="-1"></a>dates</span></code></pre></div>
<p>We can query using the value of a coordinate using the
<code>sel()</code> method.</p>
<div class="sourceCode" id="cb23"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" tabindex="-1"></a>da.sel(time<span class="op">=</span><span class="st">&#39;2023-12-16&#39;</span>)</span></code></pre></div>
<p>The <code>sel()</code> method also support nearest neighbor lookups.
This is useful when you do not know the exact label of the dimension,
but want to find the closest one.</p>
<blockquote>
<p>Tip: You can use <code>interp()</code> instead of <code>sel()</code>
to interpolate the value instead of closest lookup.</p>
</blockquote>
<div class="sourceCode" id="cb24"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" tabindex="-1"></a>da.sel(time<span class="op">=</span><span class="st">&#39;2023-01-01&#39;</span>, method<span class="op">=</span><span class="st">&#39;nearest&#39;</span>)</span></code></pre></div>
<p>The <code>sel()</code> method also allows specifying range of values
using Python’s built-in <code>slice()</code> function. The code below
will select all observations during January 2023.</p>
<div class="sourceCode" id="cb25"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" tabindex="-1"></a>da.sel(time<span class="op">=</span><span class="bu">slice</span>(<span class="st">&#39;2023-01-01&#39;</span>, <span class="st">&#39;2023-01-31&#39;</span>))</span></code></pre></div>
</div>
<div id="aggregating-data" class="section level2">
<h2>Aggregating Data</h2>
<p>A very-powerful feature of XArray is the ability to easily aggregate
data across dimensions - making it ideal for many remote sensing
analysis. Let’s create a median composite from all the individual
images.</p>
<p>We apply the <code>.median()</code> aggregation across the
<code>time</code> dimension.</p>
<div class="sourceCode" id="cb26"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" tabindex="-1"></a>median <span class="op">=</span> ds.median(dim<span class="op">=</span><span class="st">&#39;time&#39;</span>)</span>
<span id="cb26-2"><a href="#cb26-2" tabindex="-1"></a>median</span></code></pre></div>
</div>
<div id="visualizing-data" class="section level2">
<h2>Visualizing Data</h2>
<p>XArray provides a <code>plot.imshow()</code> method based on
Matplotlib to plot DataArrays.</p>
<p>Reference : <a
href="https://docs.xarray.dev/en/stable/generated/xarray.plot.imshow.html">xarray.plot.imshow</a></p>
<p>To visualize our Dataset, we first convert it to a DataArray using
the <code>to_array()</code> method. All the variables will be converted
to a new dimension. Since our variables are image bands, we give the
name of the new dimesion as <code>band</code>.</p>
<div class="sourceCode" id="cb27"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" tabindex="-1"></a>median_da <span class="op">=</span> median.to_array(<span class="st">&#39;band&#39;</span>)</span>
<span id="cb27-2"><a href="#cb27-2" tabindex="-1"></a>median_da</span></code></pre></div>
<p>The easy way to visualize the data without the outliers is to pass
the parameter <code>robust=True</code>. This will use the 2nd and 98th
percentiles of the data to compute the color limits. We also specify the
<code>set_aspect('equal')</code> to ensure the original aspect ratio is
maintained and the image is not stretched.</p>
<div class="sourceCode" id="cb28"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb28-2"><a href="#cb28-2" tabindex="-1"></a>fig.set_size_inches(<span class="dv">5</span>,<span class="dv">5</span>)</span>
<span id="cb28-3"><a href="#cb28-3" tabindex="-1"></a>median_da.sel(band<span class="op">=</span>[<span class="st">&#39;red&#39;</span>, <span class="st">&#39;green&#39;</span>, <span class="st">&#39;blue&#39;</span>]).plot.imshow(</span>
<span id="cb28-4"><a href="#cb28-4" tabindex="-1"></a>    ax<span class="op">=</span>ax,</span>
<span id="cb28-5"><a href="#cb28-5" tabindex="-1"></a>    robust<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb28-6"><a href="#cb28-6" tabindex="-1"></a>ax.set_title(<span class="st">&#39;RGB Visualization&#39;</span>)</span>
<span id="cb28-7"><a href="#cb28-7" tabindex="-1"></a>ax.set_axis_off()</span>
<span id="cb28-8"><a href="#cb28-8" tabindex="-1"></a>ax.set_aspect(<span class="st">&#39;equal&#39;</span>)</span>
<span id="cb28-9"><a href="#cb28-9" tabindex="-1"></a>plt.show()</span></code></pre></div>
<p><img
src="python-remote-sensing-output/01_xarray_basics_files/01_xarray_basics_41_0.png" /></p>
<p>We can save the resulting median compositeas a multi-band GeoTIFF
file.</p>
<div class="sourceCode" id="cb29"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" tabindex="-1"></a>output_file <span class="op">=</span> <span class="st">&#39;median_composite.tif&#39;</span></span>
<span id="cb29-2"><a href="#cb29-2" tabindex="-1"></a>output_file_path <span class="op">=</span> os.path.join(output_folder, output_file)</span>
<span id="cb29-3"><a href="#cb29-3" tabindex="-1"></a>median_da.rio.to_raster(output_file_path, compress<span class="op">=</span><span class="st">&#39;LZW&#39;</span>)</span></code></pre></div>
</div>
<div id="exercise" class="section level2">
<h2>Exercise</h2>
<p>Display the median composite for the month of May.</p>
<p>The snippet below takes our time-series and aggregate it to a monthly
median composites <code>groupby()</code> method.</p>
<div class="sourceCode" id="cb30"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" tabindex="-1"></a>monthly <span class="op">=</span> ds.groupby(<span class="st">&#39;time.month&#39;</span>).median(dim<span class="op">=</span><span class="st">&#39;time&#39;</span>)</span>
<span id="cb30-2"><a href="#cb30-2" tabindex="-1"></a>monthly</span></code></pre></div>
<p>You now have a new dimension named <code>month</code>. Start your
exercise by first converting the Dataset to a DataArray. Then extract
the data for the chosen month using <code>sel()</code> method and plot
it.</p>
</div>
</div>
<div id="stac-and-dask-basics" class="section level1">
<h1>STAC and Dask Basics</h1>
<p><a
href="https://colab.research.google.com/github/spatialthoughts/courses/blob/master/code/python_remote_sensing/stac_dask_basics.ipynb"><img
src="https://colab.research.google.com/assets/colab-badge.svg"
alt="Open In Colab" /></a></p>
<div id="overview-1" class="section level2">
<h2>Overview</h2>
<p>Xarray is an evolution of rasterio and is inspired by libraries like
pandas to work with raster datasets. It is particularly suited for
working with multi-dimensional time-series raster datasets. It also
integrates tightly with dask that allows one to scale raster data
processing using parallel computing. XArray provides <a
href="https://xarray.pydata.org/en/stable/user-guide/plotting.html">Plotting
Functions</a> based on Matplotlib.</p>
<p>In this section, we will learn about XArray basics and learn how to
work with a time-series of Sentinel-2 satellite imagery to create and
visualize a median composite image.</p>
</div>
<div id="setup-and-data-download-1" class="section level2">
<h2>Setup and Data Download</h2>
<p>The following blocks of code will install the required packages and
download the datasets to your Colab environment.</p>
<div class="sourceCode" id="cb31"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" tabindex="-1"></a><span class="op">%%</span>capture</span>
<span id="cb31-2"><a href="#cb31-2" tabindex="-1"></a><span class="cf">if</span> <span class="st">&#39;google.colab&#39;</span> <span class="kw">in</span> <span class="bu">str</span>(get_ipython()):</span>
<span id="cb31-3"><a href="#cb31-3" tabindex="-1"></a>    <span class="op">!</span>pip install pystac<span class="op">-</span>client odc<span class="op">-</span>stac rioxarray dask jupyter<span class="op">-</span>server<span class="op">-</span>proxy</span></code></pre></div>
<div class="sourceCode" id="cb32"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb32-2"><a href="#cb32-2" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb32-3"><a href="#cb32-3" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb32-4"><a href="#cb32-4" tabindex="-1"></a><span class="im">import</span> pystac_client</span>
<span id="cb32-5"><a href="#cb32-5" tabindex="-1"></a><span class="im">from</span> odc <span class="im">import</span> stac</span>
<span id="cb32-6"><a href="#cb32-6" tabindex="-1"></a><span class="im">import</span> xarray <span class="im">as</span> xr</span>
<span id="cb32-7"><a href="#cb32-7" tabindex="-1"></a><span class="im">import</span> rioxarray <span class="im">as</span> rxr</span></code></pre></div>
</div>
<div id="dask" class="section level2">
<h2>Dask</h2>
<p><a href="https://www.dask.org/"><code>Dask</code></a> is a python
library to run your computation in parallel across many machines. Dask
has built-in support for key geospatial packages like XArray and Pandas
allowing you to scale your computation easily. You can choose to run
your code in parallel on your laptop, a machine in the cloud, local or
cloud cluster of machines etc.</p>
<div class="sourceCode" id="cb33"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" tabindex="-1"></a><span class="im">from</span> dask.distributed <span class="im">import</span> Client</span>
<span id="cb33-2"><a href="#cb33-2" tabindex="-1"></a>client <span class="op">=</span> Client()  <span class="co"># set up local cluster on the machine</span></span>
<span id="cb33-3"><a href="#cb33-3" tabindex="-1"></a>client</span></code></pre></div>
<p>f you are running this notebook in Colab, you will need to create and
use a proxy URL to see the dashboard running on the local server.</p>
<div class="sourceCode" id="cb34"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" tabindex="-1"></a><span class="cf">if</span> <span class="st">&#39;google.colab&#39;</span> <span class="kw">in</span> <span class="bu">str</span>(get_ipython()):</span>
<span id="cb34-2"><a href="#cb34-2" tabindex="-1"></a>    <span class="im">from</span> google.colab <span class="im">import</span> output</span>
<span id="cb34-3"><a href="#cb34-3" tabindex="-1"></a>    port_to_expose <span class="op">=</span> <span class="dv">8787</span>  <span class="co"># This is the default port for Dask dashboard</span></span>
<span id="cb34-4"><a href="#cb34-4" tabindex="-1"></a>    <span class="bu">print</span>(output.eval_js(<span class="ss">f&#39;google.colab.kernel.proxyPort(</span><span class="sc">{</span>port_to_expose<span class="sc">}</span><span class="ss">)&#39;</span>))</span></code></pre></div>
</div>
<div id="spatio-temporal-asset-catalog-stac" class="section level2">
<h2>Spatio Temporal Asset Catalog (STAC)</h2>
<p>Spatio Temporal Asset Catalog (STAC) is an open standard for
specifying and querying geospatial data. Data provider can share
catalogs of satellite imagery ,climate datasets, LIDAR data, vector data
etc. and specify asset metadata according to the STAC specifications.
All STAC catalogs can be queried to find matching assets by time,
location or metadata.</p>
<p>You can browse all available catalogs at <a
href="https://stacindex.org/" class="uri">https://stacindex.org/</a></p>
<p>Let’s use <a
href="https://stacindex.org/catalogs/earth-search#/">Earth Search by
Element 84</a> STAC API Catalog to look for items from the
sentinel-2-l2a collection on AWS.</p>
<div class="sourceCode" id="cb35"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" tabindex="-1"></a>catalog <span class="op">=</span> pystac_client.Client.<span class="bu">open</span>(</span>
<span id="cb35-2"><a href="#cb35-2" tabindex="-1"></a>    <span class="st">&#39;https://earth-search.aws.element84.com/v1&#39;</span>)</span></code></pre></div>
<p>We define a location and time of interest to get some satellite
imagery.</p>
<div class="sourceCode" id="cb36"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" tabindex="-1"></a>latitude <span class="op">=</span> <span class="fl">27.163</span></span>
<span id="cb36-2"><a href="#cb36-2" tabindex="-1"></a>longitude <span class="op">=</span> <span class="fl">82.608</span></span>
<span id="cb36-3"><a href="#cb36-3" tabindex="-1"></a>year <span class="op">=</span> <span class="dv">2023</span></span></code></pre></div>
<div class="sourceCode" id="cb37"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" tabindex="-1"></a><span class="co"># Define a small bounding box around the chosen point</span></span>
<span id="cb37-2"><a href="#cb37-2" tabindex="-1"></a>km2deg <span class="op">=</span> <span class="fl">1.0</span> <span class="op">/</span> <span class="dv">111</span></span>
<span id="cb37-3"><a href="#cb37-3" tabindex="-1"></a>x, y <span class="op">=</span> (longitude, latitude)</span>
<span id="cb37-4"><a href="#cb37-4" tabindex="-1"></a>r <span class="op">=</span> <span class="dv">1</span> <span class="op">*</span> km2deg  <span class="co"># radius in degrees</span></span>
<span id="cb37-5"><a href="#cb37-5" tabindex="-1"></a>bbox <span class="op">=</span> (x <span class="op">-</span> r, y <span class="op">-</span> r, x <span class="op">+</span> r, y <span class="op">+</span> r)</span></code></pre></div>
<p>Search the catalog for matching items.</p>
<div class="sourceCode" id="cb38"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" tabindex="-1"></a>search <span class="op">=</span> catalog.search(</span>
<span id="cb38-2"><a href="#cb38-2" tabindex="-1"></a>    collections<span class="op">=</span>[<span class="st">&#39;sentinel-2-c1-l2a&#39;</span>],</span>
<span id="cb38-3"><a href="#cb38-3" tabindex="-1"></a>    bbox<span class="op">=</span>bbox,</span>
<span id="cb38-4"><a href="#cb38-4" tabindex="-1"></a>    datetime<span class="op">=</span><span class="ss">f&#39;</span><span class="sc">{</span>year<span class="sc">}</span><span class="ss">&#39;</span></span>
<span id="cb38-5"><a href="#cb38-5" tabindex="-1"></a>)</span>
<span id="cb38-6"><a href="#cb38-6" tabindex="-1"></a>items <span class="op">=</span> search.item_collection()</span>
<span id="cb38-7"><a href="#cb38-7" tabindex="-1"></a>items</span></code></pre></div>
<p>We can apply some additional metadata filters to look for images with
less cloud cover and granules with less nodata pixels.</p>
<div class="sourceCode" id="cb39"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" tabindex="-1"></a>search <span class="op">=</span> catalog.search(</span>
<span id="cb39-2"><a href="#cb39-2" tabindex="-1"></a>    collections<span class="op">=</span>[<span class="st">&#39;sentinel-2-c1-l2a&#39;</span>],</span>
<span id="cb39-3"><a href="#cb39-3" tabindex="-1"></a>    bbox<span class="op">=</span>bbox,</span>
<span id="cb39-4"><a href="#cb39-4" tabindex="-1"></a>    datetime<span class="op">=</span><span class="ss">f&#39;</span><span class="sc">{</span>year<span class="sc">}</span><span class="ss">&#39;</span>,</span>
<span id="cb39-5"><a href="#cb39-5" tabindex="-1"></a>    query<span class="op">=</span>{<span class="st">&#39;eo:cloud_cover&#39;</span>: {<span class="st">&#39;lt&#39;</span>: <span class="dv">30</span>}, <span class="st">&#39;s2:nodata_pixel_percentage&#39;</span>: {<span class="st">&#39;lt&#39;</span>: <span class="dv">10</span>}}</span>
<span id="cb39-6"><a href="#cb39-6" tabindex="-1"></a>)</span>
<span id="cb39-7"><a href="#cb39-7" tabindex="-1"></a>items <span class="op">=</span> search.item_collection()</span>
<span id="cb39-8"><a href="#cb39-8" tabindex="-1"></a>items</span></code></pre></div>
<p>We can also sort the results by some metadata. Here we sort by cloud
cover.</p>
<div class="sourceCode" id="cb40"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" tabindex="-1"></a>search <span class="op">=</span> catalog.search(</span>
<span id="cb40-2"><a href="#cb40-2" tabindex="-1"></a>    collections<span class="op">=</span>[<span class="st">&#39;sentinel-2-c1-l2a&#39;</span>],</span>
<span id="cb40-3"><a href="#cb40-3" tabindex="-1"></a>    bbox<span class="op">=</span>bbox,</span>
<span id="cb40-4"><a href="#cb40-4" tabindex="-1"></a>    datetime<span class="op">=</span><span class="ss">f&#39;</span><span class="sc">{</span>year<span class="sc">}</span><span class="ss">&#39;</span>,</span>
<span id="cb40-5"><a href="#cb40-5" tabindex="-1"></a>    query<span class="op">=</span>{<span class="st">&#39;eo:cloud_cover&#39;</span>: {<span class="st">&#39;lt&#39;</span>: <span class="dv">30</span>}, <span class="st">&#39;s2:nodata_pixel_percentage&#39;</span>: {<span class="st">&#39;lt&#39;</span>: <span class="dv">10</span>}},</span>
<span id="cb40-6"><a href="#cb40-6" tabindex="-1"></a>    sortby<span class="op">=</span>[{<span class="st">&#39;field&#39;</span>: <span class="st">&#39;properties.eo:cloud_cover&#39;</span>, <span class="st">&#39;direction&#39;</span>: <span class="st">&#39;asc&#39;</span>}]</span>
<span id="cb40-7"><a href="#cb40-7" tabindex="-1"></a></span>
<span id="cb40-8"><a href="#cb40-8" tabindex="-1"></a>)</span>
<span id="cb40-9"><a href="#cb40-9" tabindex="-1"></a>items <span class="op">=</span> search.item_collection()</span>
<span id="cb40-10"><a href="#cb40-10" tabindex="-1"></a>items</span></code></pre></div>
</div>
<div id="load-stac-images-to-xarray" class="section level2">
<h2>Load STAC Images to XArray</h2>
<p>Load the matching images as a XArray Dataset.</p>
<div class="sourceCode" id="cb41"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" tabindex="-1"></a>ds <span class="op">=</span> stac.load(</span>
<span id="cb41-2"><a href="#cb41-2" tabindex="-1"></a>    items,</span>
<span id="cb41-3"><a href="#cb41-3" tabindex="-1"></a>    bands<span class="op">=</span>[<span class="st">&#39;red&#39;</span>, <span class="st">&#39;green&#39;</span>, <span class="st">&#39;blue&#39;</span>, <span class="st">&#39;nir&#39;</span>, <span class="st">&#39;scl&#39;</span>],</span>
<span id="cb41-4"><a href="#cb41-4" tabindex="-1"></a>    resolution<span class="op">=</span><span class="dv">10</span>,</span>
<span id="cb41-5"><a href="#cb41-5" tabindex="-1"></a>    chunks<span class="op">=</span>{},  <span class="co"># &lt;-- use Dask</span></span>
<span id="cb41-6"><a href="#cb41-6" tabindex="-1"></a>    groupby<span class="op">=</span><span class="st">&#39;solar_day&#39;</span>,</span>
<span id="cb41-7"><a href="#cb41-7" tabindex="-1"></a>    preserve_original_order<span class="op">=</span><span class="va">True</span></span>
<span id="cb41-8"><a href="#cb41-8" tabindex="-1"></a>)</span>
<span id="cb41-9"><a href="#cb41-9" tabindex="-1"></a>ds</span></code></pre></div>
<p>Use<a
href="https://docs.xarray.dev/en/latest/generated/xarray.Dataset.nbytes.html"><code>xarray.Dataset.nbytes</code></a>
property to check the size of the loaded dataset.</p>
<div class="sourceCode" id="cb42"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f&#39;DataSet size: </span><span class="sc">{</span>ds<span class="sc">.</span>nbytes<span class="op">/</span><span class="fl">1e6</span><span class="sc">:.2f}</span><span class="ss"> MB.&#39;</span>)</span></code></pre></div>
</div>
<div id="select-a-single-scene" class="section level2">
<h2>Select a Single Scene</h2>
<p>Let’s work with a single scene for now. We will use the first item
from our search (the least cloudy scene). When the items are loaded as a
XArray Dataset, the <code>time</code> dimension is sorted. We get the
timestamp of the least cloudy scene and select it from the dataset.</p>
<div class="sourceCode" id="cb43"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" tabindex="-1"></a>timestamp <span class="op">=</span> pd.to_datetime(items[<span class="dv">0</span>].properties[<span class="st">&#39;datetime&#39;</span>]).tz_convert(<span class="va">None</span>)</span>
<span id="cb43-2"><a href="#cb43-2" tabindex="-1"></a>scene <span class="op">=</span> ds.sel(time<span class="op">=</span>timestamp)</span>
<span id="cb43-3"><a href="#cb43-3" tabindex="-1"></a>scene</span></code></pre></div>
<div class="sourceCode" id="cb44"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f&#39;Scene size: </span><span class="sc">{</span>ds<span class="sc">.</span>nbytes<span class="op">/</span><span class="fl">1e6</span><span class="sc">:.2f}</span><span class="ss"> MB.&#39;</span>)</span></code></pre></div>
<p>This scene is small enough to fit into RAM, so let’s call
<code>compute()</code> to load this into memory. Dask will query the
cloud-hosted dataset to fetch the required pixels. As we setup a Dask
LocalCluster, the process will be paralellized across all available
cores of the machine. Once you run the cell, look at the Dask Diagnostic
Dashboard to see the data processing in action.</p>
<div class="sourceCode" id="cb45"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" tabindex="-1"></a><span class="op">%%</span>time</span>
<span id="cb45-2"><a href="#cb45-2" tabindex="-1"></a>scene <span class="op">=</span> scene.compute()</span></code></pre></div>
<div class="sourceCode" id="cb46"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" tabindex="-1"></a>scene</span></code></pre></div>
<p>The Sentinel-2 scenes come with NoData value of 0. So we set the
correct NoData value before further processing.</p>
<div class="sourceCode" id="cb47"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" tabindex="-1"></a>scene <span class="op">=</span> scene.where(scene <span class="op">!=</span> <span class="dv">0</span>)</span>
<span id="cb47-2"><a href="#cb47-2" tabindex="-1"></a>scene</span></code></pre></div>
</div>
<div id="visualize-the-scene" class="section level2">
<h2>Visualize the Scene</h2>
<p>To visualize our Dataset, we first convert it to a DataArray using
the <code>to_array()</code> method. All the variables will be converted
to a new dimension. Since our variables are image bands, we give the
name of the new dimesion as band.</p>
<div class="sourceCode" id="cb48"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" tabindex="-1"></a>scene_da <span class="op">=</span> scene.to_array(<span class="st">&#39;band&#39;</span>)</span>
<span id="cb48-2"><a href="#cb48-2" tabindex="-1"></a>scene_da</span></code></pre></div>
<p>We can create a low-resolution preview by resampling the DataArray
from its native resolution. The raster metadata is stored in the <a
href="https://corteva.github.io/rioxarray/stable/rioxarray.html#rioxarray-rio-accessors">rio
accessor</a>. This is enabled by the <code>rioxarray</code> library
which provides geospatial functions on top of xarray.</p>
<div class="sourceCode" id="cb49"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&#39;CRS:&#39;</span>, rds.rio.crs)</span>
<span id="cb49-2"><a href="#cb49-2" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&#39;Resolution:&#39;</span>, rds.rio.resolution())</span></code></pre></div>
<p>Reproject and plot the results.</p>
<div class="sourceCode" id="cb50"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" tabindex="-1"></a>preview <span class="op">=</span> scene_da.rio.reproject(</span>
<span id="cb50-2"><a href="#cb50-2" tabindex="-1"></a>    scene.rio.crs, resolution<span class="op">=</span><span class="dv">300</span></span>
<span id="cb50-3"><a href="#cb50-3" tabindex="-1"></a>)</span>
<span id="cb50-4"><a href="#cb50-4" tabindex="-1"></a></span>
<span id="cb50-5"><a href="#cb50-5" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb50-6"><a href="#cb50-6" tabindex="-1"></a>fig.set_size_inches(<span class="dv">5</span>,<span class="dv">5</span>)</span>
<span id="cb50-7"><a href="#cb50-7" tabindex="-1"></a>preview.sel(band<span class="op">=</span>[<span class="st">&#39;red&#39;</span>, <span class="st">&#39;green&#39;</span>, <span class="st">&#39;blue&#39;</span>]).plot.imshow(</span>
<span id="cb50-8"><a href="#cb50-8" tabindex="-1"></a>    ax<span class="op">=</span>ax,</span>
<span id="cb50-9"><a href="#cb50-9" tabindex="-1"></a>    robust<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb50-10"><a href="#cb50-10" tabindex="-1"></a>ax.set_title(<span class="st">&#39;RGB Visualization&#39;</span>)</span>
<span id="cb50-11"><a href="#cb50-11" tabindex="-1"></a>ax.set_axis_off()</span>
<span id="cb50-12"><a href="#cb50-12" tabindex="-1"></a>ax.set_aspect(<span class="st">&#39;equal&#39;</span>)</span>
<span id="cb50-13"><a href="#cb50-13" tabindex="-1"></a>plt.show()</span></code></pre></div>
</div>
<div id="save-the-scene-to-disk" class="section level2">
<h2>Save the Scene to Disk</h2>
<div class="sourceCode" id="cb51"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb51-1"><a href="#cb51-1" tabindex="-1"></a>scene_id <span class="op">=</span> items[<span class="dv">0</span>].<span class="bu">id</span></span>
<span id="cb51-2"><a href="#cb51-2" tabindex="-1"></a>output_da <span class="op">=</span> scene_da.sel(band<span class="op">=</span>[<span class="st">&#39;red&#39;</span>, <span class="st">&#39;green&#39;</span>, <span class="st">&#39;blue&#39;</span>])</span>
<span id="cb51-3"><a href="#cb51-3" tabindex="-1"></a>output_file <span class="op">=</span> <span class="ss">f&#39;</span><span class="sc">{</span>scene_id<span class="sc">}</span><span class="ss">.tif&#39;</span></span></code></pre></div>
<p>Rather than saving it to the temporary machine where Colab is
running, we can save it to our own Google Drive. This will ensure the
image will be available to us even after existing Google Colab.</p>
<p>Run the following cell to authenticate and mount the Google
Drive.</p>
<div class="sourceCode" id="cb52"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1" tabindex="-1"></a><span class="im">from</span> google.colab <span class="im">import</span> drive</span>
<span id="cb52-2"><a href="#cb52-2" tabindex="-1"></a>drive.mount(<span class="st">&#39;/content/drive&#39;</span>)</span></code></pre></div>
<div class="sourceCode" id="cb53"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb53-1"><a href="#cb53-1" tabindex="-1"></a>drive_folder_root <span class="op">=</span> <span class="st">&#39;/content/drive/MyDrive&#39;</span></span>
<span id="cb53-2"><a href="#cb53-2" tabindex="-1"></a>output_file_path <span class="op">=</span> os.path.join(drive_folder_root, output_file)</span>
<span id="cb53-3"><a href="#cb53-3" tabindex="-1"></a>output_da.rio.to_raster(output_file_path, compress<span class="op">=</span><span class="st">&#39;LZW&#39;</span>)</span></code></pre></div>
<hr />
</div>
</div>
<div id="license" class="section level1">
<h1>License</h1>
<p>This workshop material is licensed under a <a
href="https://creativecommons.org/licenses/by/4.0/">Creative Commons
Attribution 4.0 International (CC BY 4.0)</a>. You are free to re-use
and adapt the material but are required to give appropriate credit to
the original author as below:</p>
<p><em>Scalable Remote Sensing Workflows with Xarray</em> workshop by
Ujaval Gandhi <a
href="https://spatialthoughts.com">www.spatialthoughts.com</a></p>
<hr />
<p>© 2025 Spatial Thoughts <a
href="https://spatialthoughts.com">www.spatialthoughts.com</a></p>
</div>

<!-- Comment Section Powered by utterances -->
<div id="comments">
  <hr />
  <p>If you want to report any issues with this page, please comment below.</p>
<script src="https://utteranc.es/client.js"
        repo="spatialthoughts/courses"
        issue-term="title"
        label="comment"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>
</div>



</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.odd').parent('tbody').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open');
  });
});
</script>

<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
