<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />


<meta name="author" content="Ujaval Gandhi" />


<title>Google Earth Engine for Water Resources Management (Full Course)</title>

<script src="site_libs/header-attrs-2.10/header-attrs.js"></script>
<script src="site_libs/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/flatly.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<style>h1 {font-size: 34px;}
       h1.title {font-size: 38px;}
       h2 {font-size: 30px;}
       h3 {font-size: 24px;}
       h4 {font-size: 18px;}
       h5 {font-size: 16px;}
       h6 {font-size: 12px;}
       code {color: inherit; background-color: rgba(0, 0, 0, 0.04);}
       pre:not([class]) { background-color: white }</style>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<link href="site_libs/pagedtable-1.1/css/pagedtable.css" rel="stylesheet" />
<script src="site_libs/pagedtable-1.1/js/pagedtable.js"></script>
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-PDGF11RK4Z"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-PDGF11RK4Z');
</script>

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>


<style type="text/css">
  code {
    white-space: pre;
  }
  .sourceCode {
    overflow: visible;
  }
</style>
<style type="text/css" data-origin="pandoc">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */

</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    for (var j = 0; j < rules.length; j++) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") continue;
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') continue;
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>







<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
pre code {
  padding: 0;
}
</style>


<style type="text/css">
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #adb5bd;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script type="text/javascript">
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.tab('show');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');

  // Navbar adjustments
  var navHeight = $(".navbar").first().height() + 15;
  var style = document.createElement('style');
  var pt = "padding-top: " + navHeight + "px; ";
  var mt = "margin-top: -" + navHeight + "px; ";
  var css = "";
  // offset scroll position for anchor links (for fixed navbar)
  for (var i = 1; i <= 6; i++) {
    css += ".section h" + i + "{ " + pt + mt + "}\n";
  }
  style.innerHTML = "body {" + pt + "padding-bottom: 40px; }\n" + css;
  document.head.appendChild(style);
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "&#xe258;";
  border: none;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->




</head>

<body>


<div class="container-fluid main-container">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">Courses</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="http://spatialthoughts.com">Back to Main Site</a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li>
  <a href="#">Back to Top</a>
</li>
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div id="header">



<h1 class="title toc-ignore">Google Earth Engine for Water Resources
Management (Full Course)</h1>
<h3 class="subtitle">Application-focused Introduction to Google Earth
Engine.</h3>
<h4 class="author">Ujaval Gandhi</h4>

</div>

<div id="TOC">
<ul>
<li><a href="#introduction" id="toc-introduction">Introduction</a></li>
<li><a href="#setting-up-the-environment"
id="toc-setting-up-the-environment">Setting up the Environment</a>
<ul>
<li><a href="#sign-up-for-google-earth-engine"
id="toc-sign-up-for-google-earth-engine">Sign-up for Google Earth
Engine</a></li>
<li><a href="#get-the-course-materials"
id="toc-get-the-course-materials">Get the Course Materials</a></li>
<li><a href="#get-the-course-videos" id="toc-get-the-course-videos">Get
the Course Videos</a></li>
</ul></li>
<li><a href="#module-1-google-earth-engine-fundamentals"
id="toc-module-1-google-earth-engine-fundamentals">Module 1: Google
Earth Engine Fundamentals</a>
<ul>
<li><a href="#hello-world" id="toc-hello-world">01. Hello World</a></li>
<li><a href="#working-with-image-collections"
id="toc-working-with-image-collections">02. Working with Image
Collections</a></li>
<li><a href="#filtering-image-collections"
id="toc-filtering-image-collections">03. Filtering Image
Collections</a></li>
<li><a href="#mosaics-and-composites"
id="toc-mosaics-and-composites">04. Mosaics and Composites</a></li>
<li><a href="#feature-collections" id="toc-feature-collections">05.
Feature Collections</a></li>
<li><a href="#clipping" id="toc-clipping">06. Clipping</a></li>
<li><a href="#calculating-indices" id="toc-calculating-indices">07.
Calculating Indices</a></li>
<li><a href="#computation-on-images" id="toc-computation-on-images">08.
Computation on Images</a></li>
<li><a href="#export" id="toc-export">09. Export</a></li>
</ul></li>
<li><a href="#module-2-surface-water-mapping"
id="toc-module-2-surface-water-mapping">Module 2: Surface Water
Mapping</a>
<ul>
<li><a href="#load-global-surface-water-data"
id="toc-load-global-surface-water-data">01. Load Global Surface Water
Data</a></li>
<li><a href="#create-a-water-mask" id="toc-create-a-water-mask">02.
Create a Water Mask</a></li>
<li><a href="#find-lost-waterbodies" id="toc-find-lost-waterbodies">03.
Find Lost Waterbodies</a></li>
<li><a href="#get-yearly-water-history"
id="toc-get-yearly-water-history">04. Get Yearly Water History</a></li>
<li><a href="#locate-a-subbasin" id="toc-locate-a-subbasin">05. Locate a
SubBasin</a></li>
<li><a href="#create-a-surface-water-map"
id="toc-create-a-surface-water-map">06. Create a Surface Water
Map</a></li>
<li><a href="#convert-raster-to-vector"
id="toc-convert-raster-to-vector">07. Convert Raster to Vector</a></li>
</ul></li>
<li><a href="#module-3-precipitation-time-series-analysis"
id="toc-module-3-precipitation-time-series-analysis">Module 3:
Precipitation Time Series Analysis</a>
<ul>
<li><a href="#mapping-a-function" id="toc-mapping-a-function">01.
Mapping a Function</a></li>
<li><a href="#reducers" id="toc-reducers">02. Reducers</a></li>
<li><a href="#calculating-total-rainfall"
id="toc-calculating-total-rainfall">03. Calculating Total
Rainfall</a></li>
<li><a href="#aggregating-time-series"
id="toc-aggregating-time-series">04. Aggregating Time Series</a></li>
<li><a href="#charting-monthly-rainfall"
id="toc-charting-monthly-rainfall">05. Charting Monthly
Rainfall</a></li>
<li><a href="#import" id="toc-import">06. Import</a></li>
<li><a href="#zonal-statistics" id="toc-zonal-statistics">07. Zonal
Statistics</a></li>
<li><a href="#trend-analysis" id="toc-trend-analysis">08. Trend
Analysis</a></li>
</ul></li>
<li><a href="#module-4-land-use-land-cover-classification"
id="toc-module-4-land-use-land-cover-classification">Module 4: Land Use
Land Cover Classification</a>
<ul>
<li><a href="#basic-supervised-classification"
id="toc-basic-supervised-classification">01. Basic Supervised
Classification</a></li>
<li><a href="#accuracy-assessment" id="toc-accuracy-assessment">02.
Accuracy Assessment</a></li>
<li><a href="#improving-the-classification"
id="toc-improving-the-classification">03. Improving the
Classification</a></li>
<li><a href="#exporting-classification-results"
id="toc-exporting-classification-results">04. Exporting Classification
Results</a></li>
<li><a href="#using-existing-landcover-datasets"
id="toc-using-existing-landcover-datasets">05. Using Existing Landcover
Datasets</a></li>
<li><a href="#calculating-area" id="toc-calculating-area">06.
Calculating Area</a></li>
</ul></li>
<li><a href="#module-5-flood-mapping"
id="toc-module-5-flood-mapping">Module 5: Flood Mapping</a>
<ul>
<li><a href="#load-and-filter-sentinel-1-data"
id="toc-load-and-filter-sentinel-1-data">01. Load and Filter Sentinel-1
Data</a></li>
<li><a href="#visualize-rgb-composites"
id="toc-visualize-rgb-composites">02. Visualize RGB Composites</a></li>
<li><a href="#apply-speckle-filter" id="toc-apply-speckle-filter">03.
Apply Speckle Filter</a></li>
<li><a href="#apply-a-threshold" id="toc-apply-a-threshold">04. Apply a
Threshold</a></li>
<li><a href="#apply-masks" id="toc-apply-masks">05. Apply Masks</a></li>
<li><a href="#calculate-flooded-area"
id="toc-calculate-flooded-area">06. Calculate Flooded Area</a></li>
</ul></li>
<li><a href="#module-6-drought-monitoring"
id="toc-module-6-drought-monitoring">Module 6: Drought Monitoring</a>
<ul>
<li><a href="#load-modis-ndvi" id="toc-load-modis-ndvi">01. Load MODIS
NDVI</a></li>
<li><a href="#apply-cloud-mask" id="toc-apply-cloud-mask">02. Apply
Cloud Mask</a></li>
<li><a href="#extract-and-scale-ndvi-band"
id="toc-extract-and-scale-ndvi-band">03. Extract and Scale NDVI
Band</a></li>
<li><a href="#create-monthly-images" id="toc-create-monthly-images">04.
Create Monthly Images</a></li>
<li><a href="#calculate-min-max-composites"
id="toc-calculate-min-max-composites">05. Calculate Min Max
Composites</a></li>
<li><a href="#calculate-vci" id="toc-calculate-vci">06. Calculate
VCI</a></li>
<li><a href="#classify-vci-image" id="toc-classify-vci-image">07.
Classify VCI Image</a></li>
</ul></li>
<li><a href="#module-7-earth-engine-apps"
id="toc-module-7-earth-engine-apps">Module 7: Earth Engine Apps</a>
<ul>
<li><a href="#client-vs-server" id="toc-client-vs-server">01. Client vs
Server</a></li>
<li><a href="#building-an-app-with-ui-widgets"
id="toc-building-an-app-with-ui-widgets">02. Building an App with UI
Widgets</a></li>
<li><a href="#performing-calculations"
id="toc-performing-calculations">03. Performing Calculations</a></li>
</ul></li>
<li><a href="#supplement" id="toc-supplement">Supplement</a>
<ul>
<li><a href="#drought-monitoring" id="toc-drought-monitoring">Drought
Monitoring</a></li>
<li><a href="#hydrology" id="toc-hydrology">Hydrology</a></li>
<li><a href="#surface-water" id="toc-surface-water">Surface
Water</a></li>
<li><a href="#sar" id="toc-sar">SAR</a></li>
<li><a href="#time-series-analysis" id="toc-time-series-analysis">Time
Series Analysis</a></li>
</ul></li>
<li><a href="#data-credits" id="toc-data-credits">Data Credits</a></li>
<li><a href="#license" id="toc-license">License</a></li>
<li><a href="#citing-and-referencing"
id="toc-citing-and-referencing">Citing and Referencing</a></li>
</ul>
</div>

<!--- Install package vembedr to get YouTube videos rendered -->
<div style="page-break-after: always;"></div>
<hr />
<p><img src="images/spatial_thoughts_logo.png" width="250pt" style="display: block; margin: auto;" /></p>
<hr />
<div style="page-break-after: always;"></div>
<div id="introduction" class="section level1">
<h1>Introduction</h1>
<p>GIS and Remote Sensing plays a critical role in the management of
water resources. Many practitioners in this field are constrained by the
availability of tools and computing resources to use these techniques
effectively. Recent advances in cloud computing technology have given
rise to platforms such as Google Earth Engine, which provide free access
to a large pool of computational resources and datasets. The course is
designed for researchers in the water sector, academicians, water
managers, and stakeholders with basic knowledge of Remote Sensing. It
will enable them to leverage this platform for water resource management
applications.</p>
<p>You will learn Google Earth Engine programming by building the
following 5 complete applications:</p>
<ol style="list-style-type: decimal">
<li>Surface Water Mapping</li>
<li>Precipitation Time Series Analysis</li>
<li>Land Use Land Cover Classification</li>
<li>Flood Mapping</li>
<li>Drought Monitoring</li>
</ol>
<blockquote>
<p>Note: Certification and Support are only available for participants
in our paid instructor-led classes.</p>
</blockquote>
<p><a
href="https://www.youtube.com/watch?v=TcQ60TIqXf0&amp;list=PLppGmFLhQ1HI0YeA5zQHxdNlmxihvBawF&amp;index=2"
target="_blank"><img
src="https://img.youtube.com/vi/TcQ60TIqXf0/mqdefault.jpg"
alt="Watch the video" /></a></p>
<p><a
href="https://www.youtube.com/watch?v=TcQ60TIqXf0&amp;list=PLppGmFLhQ1HI0YeA5zQHxdNlmxihvBawF&amp;index=2"
target="_blank">Watch the Video ↗</a></p>
<p><a
href="https://docs.google.com/presentation/d/1-PqksKb2QB8YJTQic5M80ZAsKh1Ld6OxOoO6BG77Uhg/edit?usp=sharing"
target="_blank">Access the Presentation ↗</a></p>
</div>
<div id="setting-up-the-environment" class="section level1">
<h1>Setting up the Environment</h1>
<div id="sign-up-for-google-earth-engine" class="section level2">
<h2>Sign-up for Google Earth Engine</h2>
<p>If you already have a Google Earth Engine account, you can skip this
step.</p>
<p>Visit our <a href="gee-sign-up.html">GEE Sign-Up Guide</a> for
step-by-step instructions.</p>
</div>
<div id="get-the-course-materials" class="section level2">
<h2>Get the Course Materials</h2>
<p>The course material and exercises are in the form of Earth Engine
scripts shared via a code repository.</p>
<ol style="list-style-type: decimal">
<li><a
href="https://code.earthengine.google.co.in/?accept_repo=users/ujavalgandhi/GEE-Water-Resources-Management">Click
this link</a> to open Google Earth Engine code editor and add the
repository to your account.</li>
<li>If successful, you will have a new repository named
<code>users/ujavalgandhi/GEE-Water-Resources-Management</code> in the
<em>Scripts</em> tab in the <em>Reader</em> section.</li>
<li>Verify that your code editor looks like below</li>
</ol>
<div class="figure" style="text-align: center">
<img src="images/gee_water_resources_management/repository.png" alt="Code Editor After Adding the Class Repository" width="75%" />
<p class="caption">
Code Editor After Adding the Class Repository
</p>
</div>
<p>If you do not see the repository in the <em>Reader</em> section,
click <em>Refresh repository cache</em> button in your <em>Scripts</em>
tab and it will show up.</p>
<div class="figure" style="text-align: center">
<img src="images/common/repository_cache.png" alt="Refresh repository cache" width="50%" />
<p class="caption">
Refresh repository cache
</p>
</div>
</div>
<div id="get-the-course-videos" class="section level2">
<h2>Get the Course Videos</h2>
<p>The course is accompanied by a set of videos covering the all the
modules. These videos are recorded from our live instructor-led classes
and are edited to make them easier to consume for self-study. We have 2
versions of the videos</p>
<div id="youtube" class="section level3">
<h3>YouTube</h3>
<p>We have created a YouTube Playlist with separate videos for each
script and exercise to enable effective online-learning. <a
href="https://www.youtube.com/playlist?list=PLppGmFLhQ1HI0YeA5zQHxdNlmxihvBawF"
target="_blank">Access the YouTube Playlist ↗</a></p>
</div>
<div id="vimeo" class="section level3">
<h3>Vimeo</h3>
<p>We are also making combined full-length video for each module
available on Vimeo. These videos can be downloaded for offline learning.
<a href="https://vimeo.com/showcase/10944117" target="_blank">Access the
Vimeo Playlist ↗</a></p>
<div style="page-break-after: always;"></div>
</div>
</div>
</div>
<div id="module-1-google-earth-engine-fundamentals"
class="section level1">
<h1>Module 1: Google Earth Engine Fundamentals</h1>
<p>In Module 1, you will gain the essential skills to find datasets,
filter them to your region, clip them to your boundary, calculate remote
sensing indices, extract water-bodies using thresholding techniques and
export raster data.</p>
<p><a
href="https://www.youtube.com/watch?v=jmCFVpYUcno&amp;list=PLppGmFLhQ1HI0YeA5zQHxdNlmxihvBawF&amp;index=3"
target="_blank"><img
src="https://img.youtube.com/vi/jmCFVpYUcno/mqdefault.jpg"
alt="Start Module 1 Videos" /></a></p>
<p><a
href="https://www.youtube.com/watch?v=jmCFVpYUcno&amp;list=PLppGmFLhQ1HI0YeA5zQHxdNlmxihvBawF&amp;index=3"
target="_blank">Start Module 1 Videos ↗</a></p>
<div id="hello-world" class="section level2">
<h2>01. Hello World</h2>
<p>This script introduces the basic Javascript syntax and the video
covers the programming concepts you need to learn when using Earth
Engine. To learn more, visit <a
href="https://developers.google.com/earth-engine/tutorials/tutorial_js_01">Introduction
to JavaScript for Earth Engine</a> section of the Earth Engine User
Guide.</p>
<p>The <em>Code Editor</em> is an Integrated Development Environment
(IDE) for Earth Engine Javascript API. It offers an easy way to type,
debug, run and manage code. Type the code below and click <em>Run</em>
to execute it and see the output in the <em>Console</em> tab.</p>
<blockquote>
<p>Tip: You can use the keyboard shortcut <em>Ctrl+Enter</em> to run the
code in the Code Editor</p>
</blockquote>
<div class="figure" style="text-align: center">
<img src="images/gee_water_resources_management/hello_world.png" alt="Hello World" width="100%" />
<p class="caption">
Hello World
</p>
</div>
<p><a
href="https://code.earthengine.google.co.in/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3A01-Earth_Engine_Basics%2F01b_Hello_World_(complete)"
target="_blank">Open in Code Editor ↗</a></p>
<div class="sourceCode" id="cb1"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="fu">print</span>(<span class="st">&#39;Hello World&#39;</span>)<span class="op">;</span></span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" tabindex="-1"></a><span class="co">// Variables</span></span>
<span id="cb1-4"><a href="#cb1-4" tabindex="-1"></a><span class="kw">var</span> city <span class="op">=</span> <span class="st">&#39;Bengaluru&#39;</span><span class="op">;</span></span>
<span id="cb1-5"><a href="#cb1-5" tabindex="-1"></a><span class="kw">var</span> country <span class="op">=</span> <span class="st">&#39;India&#39;</span><span class="op">;</span></span>
<span id="cb1-6"><a href="#cb1-6" tabindex="-1"></a><span class="fu">print</span>(city<span class="op">,</span> country)<span class="op">;</span></span>
<span id="cb1-7"><a href="#cb1-7" tabindex="-1"></a></span>
<span id="cb1-8"><a href="#cb1-8" tabindex="-1"></a><span class="kw">var</span> population <span class="op">=</span> <span class="dv">8400000</span><span class="op">;</span></span>
<span id="cb1-9"><a href="#cb1-9" tabindex="-1"></a><span class="fu">print</span>(population)<span class="op">;</span></span>
<span id="cb1-10"><a href="#cb1-10" tabindex="-1"></a> </span>
<span id="cb1-11"><a href="#cb1-11" tabindex="-1"></a><span class="co">// List</span></span>
<span id="cb1-12"><a href="#cb1-12" tabindex="-1"></a><span class="kw">var</span> majorCities <span class="op">=</span> [<span class="st">&#39;Mumbai&#39;</span><span class="op">,</span> <span class="st">&#39;Delhi&#39;</span><span class="op">,</span> <span class="st">&#39;Chennai&#39;</span><span class="op">,</span> <span class="st">&#39;Kolkata&#39;</span>]<span class="op">;</span></span>
<span id="cb1-13"><a href="#cb1-13" tabindex="-1"></a><span class="fu">print</span>(majorCities)<span class="op">;</span></span>
<span id="cb1-14"><a href="#cb1-14" tabindex="-1"></a></span>
<span id="cb1-15"><a href="#cb1-15" tabindex="-1"></a><span class="co">// Dictionary</span></span>
<span id="cb1-16"><a href="#cb1-16" tabindex="-1"></a><span class="kw">var</span> cityData <span class="op">=</span> {</span>
<span id="cb1-17"><a href="#cb1-17" tabindex="-1"></a>  <span class="st">&#39;city&#39;</span><span class="op">:</span> city<span class="op">,</span></span>
<span id="cb1-18"><a href="#cb1-18" tabindex="-1"></a>  <span class="st">&#39;population&#39;</span><span class="op">:</span> <span class="dv">8400000</span><span class="op">,</span></span>
<span id="cb1-19"><a href="#cb1-19" tabindex="-1"></a>  <span class="st">&#39;elevation&#39;</span><span class="op">:</span> <span class="dv">930</span></span>
<span id="cb1-20"><a href="#cb1-20" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb1-21"><a href="#cb1-21" tabindex="-1"></a><span class="fu">print</span>(cityData)<span class="op">;</span></span>
<span id="cb1-22"><a href="#cb1-22" tabindex="-1"></a></span>
<span id="cb1-23"><a href="#cb1-23" tabindex="-1"></a><span class="co">// Function</span></span>
<span id="cb1-24"><a href="#cb1-24" tabindex="-1"></a><span class="kw">var</span> greet <span class="op">=</span> <span class="kw">function</span>(name) {</span>
<span id="cb1-25"><a href="#cb1-25" tabindex="-1"></a>    <span class="cf">return</span> <span class="st">&#39;Hello &#39;</span> <span class="op">+</span> name<span class="op">;</span></span>
<span id="cb1-26"><a href="#cb1-26" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb1-27"><a href="#cb1-27" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">greet</span>(<span class="st">&#39;World&#39;</span>))<span class="op">;</span></span>
<span id="cb1-28"><a href="#cb1-28" tabindex="-1"></a></span>
<span id="cb1-29"><a href="#cb1-29" tabindex="-1"></a><span class="co">// This is a comment</span></span></code></pre></div>
<div id="exercise" class="section level3">
<h3>Exercise</h3>
<p><a
href="https://code.earthengine.google.co.in/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3A01-Earth_Engine_Basics%2F01c_Hello_World_(exercise)"
target="_blank">Try in Code Editor ↗</a></p>
<div class="sourceCode" id="cb2"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a><span class="co">// These are the 5 largest cities in the world: </span></span>
<span id="cb2-2"><a href="#cb2-2" tabindex="-1"></a><span class="co">// Tokyo, Delhi, Shanghai, Mexico City, Sao Paulo</span></span>
<span id="cb2-3"><a href="#cb2-3" tabindex="-1"></a></span>
<span id="cb2-4"><a href="#cb2-4" tabindex="-1"></a><span class="co">// Create a list named &#39;largeCities&#39;</span></span>
<span id="cb2-5"><a href="#cb2-5" tabindex="-1"></a><span class="co">// The list should have names of all the above cities</span></span>
<span id="cb2-6"><a href="#cb2-6" tabindex="-1"></a><span class="co">// Print the list </span></span></code></pre></div>
</div>
<div id="saving-your-work" class="section level3">
<h3>Saving Your Work</h3>
<p>When you modify any script for the course repository, you may want to
save a copy for yourself. If you try to click the <em>Save</em> button,
you will get an error message like below</p>
<p><img src="images/gee_water_resources_management/setup1.png" width="75%" style="display: block; margin: auto;" /></p>
<p>This is because the shared class repository is a <em>Read-only</em>
repository. You can click <em>Yes</em> to save a copy in your
repository. If this is the first time you are using Earth Engine, you
will be prompted to choose a <em>Earth Engine username</em>. Choose the
name carefully, as it cannot be changed once created.</p>
<p><img src="images/gee_water_resources_management/setup2.png" width="50%" style="display: block; margin: auto;" /></p>
<p>After entering your username, your home folder will be created. After
that, you will be prompted to enter a new repository. A repository can
help you organize and share code. Your account can have multiple
repositories and each repository can have multiple scripts inside it. To
get started, you can create a repository named <em>default</em>.
Finally, you will be able to save the script.</p>
</div>
</div>
<div id="working-with-image-collections" class="section level2">
<h2>02. Working with Image Collections</h2>
<p>Most datasets in Earth Engine come as a <code>ImageCollection</code>.
An ImageCollection is a dataset that consists of images takes at
different time and locations - usually from the same satellite or data
provider. You can load a collection by searching the <a
href="https://developers.google.com/earth-engine/datasets">Earth Engine
Data Catalog</a> for the <em>ImageCollection ID</em>. Search for the
<em>Sentinel-2 Level 2A</em> dataset and you will find its id
<code>COPERNICUS/S2_SR</code>. Visit the <a
href="https://developers.google.com/earth-engine/datasets/catalog/COPERNICUS_S2_SR">Sentinel-2,
Level 2A page</a> and see <em>Explore in Earth Engine</em> section to
find the code snippet to load and visualize the collection. This snippet
is a great starting point for your work with this dataset. Click the
<strong>Copy Code Sample</strong> button and paste the code into the
code editor. Click <em>Run</em> and you will see the image tiles load in
the map.</p>
<p><img src="images/gee_water_resources_management/image_collection1.png" width="100%" style="display: block; margin: auto;" /></p>
<p>In the code snippet, You will see a function
<code>Map.setCenter()</code> which sets the viewport to a specific
location and zoom level. The function takes the X coordinate
(longitude), Y coordinate (latitude) and Zoom Level parameters ranging
from 1 (whole world) to 22 (pixel level). Replace the X and Y
coordinates with the coordinates of your city and click <em>Run</em> to
see the images of your city.</p>
<p><a
href="https://code.earthengine.google.co.in/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3A01-Earth_Engine_Basics%2F02b_Image_Collections_(complete)"
target="_blank">Open in Code Editor ↗</a></p>
<p><img src="images/gee_water_resources_management/image_collection2.png" width="100%" style="display: block; margin: auto;" /></p>
<div class="sourceCode" id="cb3"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a><span class="co">/**</span></span>
<span id="cb3-2"><a href="#cb3-2" tabindex="-1"></a><span class="co"> * Function to mask clouds using the Sentinel-2 QA band</span></span>
<span id="cb3-3"><a href="#cb3-3" tabindex="-1"></a><span class="co"> * </span><span class="an">@param</span><span class="co"> </span><span class="cv">{ee.Image}</span><span class="co"> image Sentinel-2 image</span></span>
<span id="cb3-4"><a href="#cb3-4" tabindex="-1"></a><span class="co"> * </span><span class="an">@return</span><span class="co"> {ee.Image} cloud masked Sentinel-2 image</span></span>
<span id="cb3-5"><a href="#cb3-5" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb3-6"><a href="#cb3-6" tabindex="-1"></a><span class="kw">function</span> <span class="fu">maskS2clouds</span>(image) {</span>
<span id="cb3-7"><a href="#cb3-7" tabindex="-1"></a>  <span class="kw">var</span> qa <span class="op">=</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;QA60&#39;</span>)<span class="op">;</span></span>
<span id="cb3-8"><a href="#cb3-8" tabindex="-1"></a></span>
<span id="cb3-9"><a href="#cb3-9" tabindex="-1"></a>  <span class="co">// Bits 10 and 11 are clouds and cirrus, respectively.</span></span>
<span id="cb3-10"><a href="#cb3-10" tabindex="-1"></a>  <span class="kw">var</span> cloudBitMask <span class="op">=</span> <span class="dv">1</span> <span class="op">&lt;&lt;</span> <span class="dv">10</span><span class="op">;</span></span>
<span id="cb3-11"><a href="#cb3-11" tabindex="-1"></a>  <span class="kw">var</span> cirrusBitMask <span class="op">=</span> <span class="dv">1</span> <span class="op">&lt;&lt;</span> <span class="dv">11</span><span class="op">;</span></span>
<span id="cb3-12"><a href="#cb3-12" tabindex="-1"></a></span>
<span id="cb3-13"><a href="#cb3-13" tabindex="-1"></a>  <span class="co">// Both flags should be set to zero, indicating clear conditions.</span></span>
<span id="cb3-14"><a href="#cb3-14" tabindex="-1"></a>  <span class="kw">var</span> mask <span class="op">=</span> qa<span class="op">.</span><span class="fu">bitwiseAnd</span>(cloudBitMask)<span class="op">.</span><span class="fu">eq</span>(<span class="dv">0</span>)</span>
<span id="cb3-15"><a href="#cb3-15" tabindex="-1"></a>      <span class="op">.</span><span class="fu">and</span>(qa<span class="op">.</span><span class="fu">bitwiseAnd</span>(cirrusBitMask)<span class="op">.</span><span class="fu">eq</span>(<span class="dv">0</span>))<span class="op">;</span></span>
<span id="cb3-16"><a href="#cb3-16" tabindex="-1"></a></span>
<span id="cb3-17"><a href="#cb3-17" tabindex="-1"></a>  <span class="cf">return</span> image<span class="op">.</span><span class="fu">updateMask</span>(mask)<span class="op">.</span><span class="fu">divide</span>(<span class="dv">10000</span>)<span class="op">;</span></span>
<span id="cb3-18"><a href="#cb3-18" tabindex="-1"></a>}</span>
<span id="cb3-19"><a href="#cb3-19" tabindex="-1"></a></span>
<span id="cb3-20"><a href="#cb3-20" tabindex="-1"></a><span class="co">// Map the function over one month of data and take the median.</span></span>
<span id="cb3-21"><a href="#cb3-21" tabindex="-1"></a><span class="co">// Load Sentinel-2 TOA reflectance data.</span></span>
<span id="cb3-22"><a href="#cb3-22" tabindex="-1"></a><span class="kw">var</span> dataset <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&#39;COPERNICUS/S2_HARMONIZED&#39;</span>)</span>
<span id="cb3-23"><a href="#cb3-23" tabindex="-1"></a>                  <span class="op">.</span><span class="fu">filterDate</span>(<span class="st">&#39;2018-01-01&#39;</span><span class="op">,</span> <span class="st">&#39;2018-01-31&#39;</span>)</span>
<span id="cb3-24"><a href="#cb3-24" tabindex="-1"></a>                  <span class="co">// Pre-filter to get less cloudy granules.</span></span>
<span id="cb3-25"><a href="#cb3-25" tabindex="-1"></a>                  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">lt</span>(<span class="st">&#39;CLOUDY_PIXEL_PERCENTAGE&#39;</span><span class="op">,</span> <span class="dv">20</span>))</span>
<span id="cb3-26"><a href="#cb3-26" tabindex="-1"></a>                  <span class="op">.</span><span class="fu">map</span>(maskS2clouds)<span class="op">;</span></span>
<span id="cb3-27"><a href="#cb3-27" tabindex="-1"></a></span>
<span id="cb3-28"><a href="#cb3-28" tabindex="-1"></a><span class="kw">var</span> rgbVis <span class="op">=</span> {</span>
<span id="cb3-29"><a href="#cb3-29" tabindex="-1"></a>  <span class="dt">min</span><span class="op">:</span> <span class="fl">0.0</span><span class="op">,</span></span>
<span id="cb3-30"><a href="#cb3-30" tabindex="-1"></a>  <span class="dt">max</span><span class="op">:</span> <span class="fl">0.3</span><span class="op">,</span></span>
<span id="cb3-31"><a href="#cb3-31" tabindex="-1"></a>  <span class="dt">bands</span><span class="op">:</span> [<span class="st">&#39;B4&#39;</span><span class="op">,</span> <span class="st">&#39;B3&#39;</span><span class="op">,</span> <span class="st">&#39;B2&#39;</span>]<span class="op">,</span></span>
<span id="cb3-32"><a href="#cb3-32" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb3-33"><a href="#cb3-33" tabindex="-1"></a></span>
<span id="cb3-34"><a href="#cb3-34" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">setCenter</span>(<span class="fl">77.61</span><span class="op">,</span> <span class="fl">12.97</span><span class="op">,</span> <span class="dv">10</span>)<span class="op">;</span></span>
<span id="cb3-35"><a href="#cb3-35" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(dataset<span class="op">.</span><span class="fu">median</span>()<span class="op">,</span> rgbVis<span class="op">,</span> <span class="st">&#39;RGB&#39;</span>)<span class="op">;</span></span></code></pre></div>
<div id="exercise-1" class="section level3">
<h3>Exercise</h3>
<p><a
href="https://code.earthengine.google.co.in/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3A01-Earth_Engine_Basics%2F02c_Image_Collections_(exercise)"
target="_blank">Try in Code Editor ↗</a></p>
<div class="sourceCode" id="cb4"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a><span class="co">/**</span></span>
<span id="cb4-2"><a href="#cb4-2" tabindex="-1"></a><span class="co"> * Function to mask clouds using the Sentinel-2 QA band</span></span>
<span id="cb4-3"><a href="#cb4-3" tabindex="-1"></a><span class="co"> * </span><span class="an">@param</span><span class="co"> </span><span class="cv">{ee.Image}</span><span class="co"> image Sentinel-2 image</span></span>
<span id="cb4-4"><a href="#cb4-4" tabindex="-1"></a><span class="co"> * </span><span class="an">@return</span><span class="co"> {ee.Image} cloud masked Sentinel-2 image</span></span>
<span id="cb4-5"><a href="#cb4-5" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb4-6"><a href="#cb4-6" tabindex="-1"></a><span class="kw">function</span> <span class="fu">maskS2clouds</span>(image) {</span>
<span id="cb4-7"><a href="#cb4-7" tabindex="-1"></a>  <span class="kw">var</span> qa <span class="op">=</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;QA60&#39;</span>)<span class="op">;</span></span>
<span id="cb4-8"><a href="#cb4-8" tabindex="-1"></a></span>
<span id="cb4-9"><a href="#cb4-9" tabindex="-1"></a>  <span class="co">// Bits 10 and 11 are clouds and cirrus, respectively.</span></span>
<span id="cb4-10"><a href="#cb4-10" tabindex="-1"></a>  <span class="kw">var</span> cloudBitMask <span class="op">=</span> <span class="dv">1</span> <span class="op">&lt;&lt;</span> <span class="dv">10</span><span class="op">;</span></span>
<span id="cb4-11"><a href="#cb4-11" tabindex="-1"></a>  <span class="kw">var</span> cirrusBitMask <span class="op">=</span> <span class="dv">1</span> <span class="op">&lt;&lt;</span> <span class="dv">11</span><span class="op">;</span></span>
<span id="cb4-12"><a href="#cb4-12" tabindex="-1"></a></span>
<span id="cb4-13"><a href="#cb4-13" tabindex="-1"></a>  <span class="co">// Both flags should be set to zero, indicating clear conditions.</span></span>
<span id="cb4-14"><a href="#cb4-14" tabindex="-1"></a>  <span class="kw">var</span> mask <span class="op">=</span> qa<span class="op">.</span><span class="fu">bitwiseAnd</span>(cloudBitMask)<span class="op">.</span><span class="fu">eq</span>(<span class="dv">0</span>)</span>
<span id="cb4-15"><a href="#cb4-15" tabindex="-1"></a>      <span class="op">.</span><span class="fu">and</span>(qa<span class="op">.</span><span class="fu">bitwiseAnd</span>(cirrusBitMask)<span class="op">.</span><span class="fu">eq</span>(<span class="dv">0</span>))<span class="op">;</span></span>
<span id="cb4-16"><a href="#cb4-16" tabindex="-1"></a></span>
<span id="cb4-17"><a href="#cb4-17" tabindex="-1"></a>  <span class="cf">return</span> image<span class="op">.</span><span class="fu">updateMask</span>(mask)<span class="op">.</span><span class="fu">divide</span>(<span class="dv">10000</span>)<span class="op">;</span></span>
<span id="cb4-18"><a href="#cb4-18" tabindex="-1"></a>}</span>
<span id="cb4-19"><a href="#cb4-19" tabindex="-1"></a></span>
<span id="cb4-20"><a href="#cb4-20" tabindex="-1"></a><span class="co">// Map the function over one month of data and take the median.</span></span>
<span id="cb4-21"><a href="#cb4-21" tabindex="-1"></a><span class="co">// Load Sentinel-2 TOA reflectance data.</span></span>
<span id="cb4-22"><a href="#cb4-22" tabindex="-1"></a><span class="kw">var</span> dataset <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&#39;COPERNICUS/S2_HARMONIZED&#39;</span>)</span>
<span id="cb4-23"><a href="#cb4-23" tabindex="-1"></a>                  <span class="op">.</span><span class="fu">filterDate</span>(<span class="st">&#39;2018-01-01&#39;</span><span class="op">,</span> <span class="st">&#39;2018-01-31&#39;</span>)</span>
<span id="cb4-24"><a href="#cb4-24" tabindex="-1"></a>                  <span class="co">// Pre-filter to get less cloudy granules.</span></span>
<span id="cb4-25"><a href="#cb4-25" tabindex="-1"></a>                  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">lt</span>(<span class="st">&#39;CLOUDY_PIXEL_PERCENTAGE&#39;</span><span class="op">,</span> <span class="dv">20</span>))</span>
<span id="cb4-26"><a href="#cb4-26" tabindex="-1"></a>                  <span class="op">.</span><span class="fu">map</span>(maskS2clouds)<span class="op">;</span></span>
<span id="cb4-27"><a href="#cb4-27" tabindex="-1"></a></span>
<span id="cb4-28"><a href="#cb4-28" tabindex="-1"></a><span class="kw">var</span> rgbVis <span class="op">=</span> {</span>
<span id="cb4-29"><a href="#cb4-29" tabindex="-1"></a>  <span class="dt">min</span><span class="op">:</span> <span class="fl">0.0</span><span class="op">,</span></span>
<span id="cb4-30"><a href="#cb4-30" tabindex="-1"></a>  <span class="dt">max</span><span class="op">:</span> <span class="fl">0.3</span><span class="op">,</span></span>
<span id="cb4-31"><a href="#cb4-31" tabindex="-1"></a>  <span class="dt">bands</span><span class="op">:</span> [<span class="st">&#39;B4&#39;</span><span class="op">,</span> <span class="st">&#39;B3&#39;</span><span class="op">,</span> <span class="st">&#39;B2&#39;</span>]<span class="op">,</span></span>
<span id="cb4-32"><a href="#cb4-32" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb4-33"><a href="#cb4-33" tabindex="-1"></a></span>
<span id="cb4-34"><a href="#cb4-34" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">setCenter</span>(<span class="fl">77.61</span><span class="op">,</span> <span class="fl">12.97</span><span class="op">,</span> <span class="dv">10</span>)<span class="op">;</span></span>
<span id="cb4-35"><a href="#cb4-35" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(dataset<span class="op">.</span><span class="fu">median</span>()<span class="op">,</span> rgbVis<span class="op">,</span> <span class="st">&#39;RGB&#39;</span>)<span class="op">;</span></span></code></pre></div>
</div>
</div>
<div id="filtering-image-collections" class="section level2">
<h2>03. Filtering Image Collections</h2>
<p>The collection contains all imagery ever collected by the sensor. The
entire collections are not very useful. Most applications require a
subset of the images. We use <strong>filters</strong> to select the
appropriate images. There are many types of filter functions, look at
<code>ee.Filter...</code> module to see all available filters. Select a
filter and then run the <code>filter()</code> function with the filter
parameters.</p>
<p>We will learn about 3 main types of filtering techniques</p>
<ul>
<li><strong>Filter by metadata</strong>: You can apply a filter on the
image metadata using filters such as <code>ee.Filter.eq()</code>,
<code>ee.Filter.lt()</code> etc. You can filter by PATH/ROW values,
Orbit number, Cloud cover etc.</li>
<li><strong>Filter by date</strong>: You can select images in a
particular date range using filters such as
<code>ee.Filter.date()</code>.</li>
<li><strong>Filter by location</strong>: You can select the subset of
images with a bounding box, location or geometry using the
<code>ee.Filter.bounds()</code>. You can also use the drawing tools to
draw a geometry for filtering.</li>
</ul>
<p>After applying the filters, you can use the <code>.size()</code>
function to check how many images match the filter criteria.</p>
<p><a
href="https://code.earthengine.google.co.in/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3A01-Earth_Engine_Basics%2F03b_Filtering_Image_Collection_(complete)"
target="_blank">Open in Code Editor ↗</a>
<img src="images/gee_water_resources_management/filters.png" width="100%" style="display: block; margin: auto;" /></p>
<div class="sourceCode" id="cb5"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a><span class="kw">var</span> geometry <span class="op">=</span> ee<span class="op">.</span><span class="at">Geometry</span><span class="op">.</span><span class="fu">Point</span>([<span class="fl">77.60412933051538</span><span class="op">,</span> <span class="fl">12.952912912328241</span>])</span>
<span id="cb5-2"><a href="#cb5-2" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">centerObject</span>(geometry<span class="op">,</span> <span class="dv">10</span>)</span>
<span id="cb5-3"><a href="#cb5-3" tabindex="-1"></a></span>
<span id="cb5-4"><a href="#cb5-4" tabindex="-1"></a><span class="kw">var</span> s2 <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&quot;COPERNICUS/S2_SR_HARMONIZED&quot;</span>)<span class="op">;</span></span>
<span id="cb5-5"><a href="#cb5-5" tabindex="-1"></a></span>
<span id="cb5-6"><a href="#cb5-6" tabindex="-1"></a><span class="co">// Filter by metadata</span></span>
<span id="cb5-7"><a href="#cb5-7" tabindex="-1"></a><span class="kw">var</span> filtered <span class="op">=</span> s2<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">lt</span>(<span class="st">&#39;CLOUDY_PIXEL_PERCENTAGE&#39;</span><span class="op">,</span> <span class="dv">30</span>))</span>
<span id="cb5-8"><a href="#cb5-8" tabindex="-1"></a></span>
<span id="cb5-9"><a href="#cb5-9" tabindex="-1"></a><span class="co">// Filter by date</span></span>
<span id="cb5-10"><a href="#cb5-10" tabindex="-1"></a><span class="kw">var</span> filtered <span class="op">=</span> s2<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(<span class="st">&#39;2019-01-01&#39;</span><span class="op">,</span> <span class="st">&#39;2020-01-01&#39;</span>))</span>
<span id="cb5-11"><a href="#cb5-11" tabindex="-1"></a></span>
<span id="cb5-12"><a href="#cb5-12" tabindex="-1"></a><span class="co">// Filter by location</span></span>
<span id="cb5-13"><a href="#cb5-13" tabindex="-1"></a><span class="kw">var</span> filtered <span class="op">=</span> s2<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">bounds</span>(geometry))</span>
<span id="cb5-14"><a href="#cb5-14" tabindex="-1"></a></span>
<span id="cb5-15"><a href="#cb5-15" tabindex="-1"></a><span class="co">// Let&#39;s apply all the 3 filters together on the collection</span></span>
<span id="cb5-16"><a href="#cb5-16" tabindex="-1"></a></span>
<span id="cb5-17"><a href="#cb5-17" tabindex="-1"></a><span class="co">// First apply metadata fileter</span></span>
<span id="cb5-18"><a href="#cb5-18" tabindex="-1"></a><span class="kw">var</span> filtered1 <span class="op">=</span> s2<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">lt</span>(<span class="st">&#39;CLOUDY_PIXEL_PERCENTAGE&#39;</span><span class="op">,</span> <span class="dv">30</span>))</span>
<span id="cb5-19"><a href="#cb5-19" tabindex="-1"></a><span class="co">// Apply date filter on the results</span></span>
<span id="cb5-20"><a href="#cb5-20" tabindex="-1"></a><span class="kw">var</span> filtered2 <span class="op">=</span> filtered1<span class="op">.</span><span class="fu">filter</span>(</span>
<span id="cb5-21"><a href="#cb5-21" tabindex="-1"></a>  ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(<span class="st">&#39;2019-01-01&#39;</span><span class="op">,</span> <span class="st">&#39;2020-01-01&#39;</span>))</span>
<span id="cb5-22"><a href="#cb5-22" tabindex="-1"></a><span class="co">// Lastly apply the location filter</span></span>
<span id="cb5-23"><a href="#cb5-23" tabindex="-1"></a><span class="kw">var</span> filtered3 <span class="op">=</span> filtered2<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">bounds</span>(geometry))</span>
<span id="cb5-24"><a href="#cb5-24" tabindex="-1"></a></span>
<span id="cb5-25"><a href="#cb5-25" tabindex="-1"></a><span class="co">// Instead of applying filters one after the other, we can &#39;chain&#39; them</span></span>
<span id="cb5-26"><a href="#cb5-26" tabindex="-1"></a><span class="co">// Use the . notation to apply all the filters together</span></span>
<span id="cb5-27"><a href="#cb5-27" tabindex="-1"></a><span class="kw">var</span> filtered <span class="op">=</span> s2<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">lt</span>(<span class="st">&#39;CLOUDY_PIXEL_PERCENTAGE&#39;</span><span class="op">,</span> <span class="dv">30</span>))</span>
<span id="cb5-28"><a href="#cb5-28" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(<span class="st">&#39;2019-01-01&#39;</span><span class="op">,</span> <span class="st">&#39;2020-01-01&#39;</span>))</span>
<span id="cb5-29"><a href="#cb5-29" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">bounds</span>(geometry))</span>
<span id="cb5-30"><a href="#cb5-30" tabindex="-1"></a>  </span>
<span id="cb5-31"><a href="#cb5-31" tabindex="-1"></a><span class="fu">print</span>(filtered<span class="op">.</span><span class="fu">size</span>())<span class="op">;</span></span></code></pre></div>
<div id="exercise-2" class="section level3">
<h3>Exercise</h3>
<p><a
href="https://code.earthengine.google.co.in/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3A01-Earth_Engine_Basics%2F03c_Filtering_Image_Collection_(exercise)"
target="_blank">Try in Code Editor ↗</a></p>
<div class="sourceCode" id="cb6"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a><span class="kw">var</span> geometry <span class="op">=</span> ee<span class="op">.</span><span class="at">Geometry</span><span class="op">.</span><span class="fu">Point</span>([<span class="fl">77.60412933051538</span><span class="op">,</span> <span class="fl">12.952912912328241</span>])<span class="op">;</span></span>
<span id="cb6-2"><a href="#cb6-2" tabindex="-1"></a></span>
<span id="cb6-3"><a href="#cb6-3" tabindex="-1"></a><span class="kw">var</span> s2 <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&quot;COPERNICUS/S2_SR_HARMONIZED&quot;</span>)<span class="op">;</span></span>
<span id="cb6-4"><a href="#cb6-4" tabindex="-1"></a></span>
<span id="cb6-5"><a href="#cb6-5" tabindex="-1"></a><span class="kw">var</span> filtered <span class="op">=</span> s2</span>
<span id="cb6-6"><a href="#cb6-6" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">lt</span>(<span class="st">&#39;CLOUDY_PIXEL_PERCENTAGE&#39;</span><span class="op">,</span> <span class="dv">30</span>))</span>
<span id="cb6-7"><a href="#cb6-7" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(<span class="st">&#39;2019-01-01&#39;</span><span class="op">,</span> <span class="st">&#39;2020-01-01&#39;</span>))</span>
<span id="cb6-8"><a href="#cb6-8" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">bounds</span>(geometry))<span class="op">;</span></span>
<span id="cb6-9"><a href="#cb6-9" tabindex="-1"></a></span>
<span id="cb6-10"><a href="#cb6-10" tabindex="-1"></a><span class="fu">print</span>(filtered<span class="op">.</span><span class="fu">size</span>())<span class="op">;</span></span>
<span id="cb6-11"><a href="#cb6-11" tabindex="-1"></a></span>
<span id="cb6-12"><a href="#cb6-12" tabindex="-1"></a><span class="co">// Exercise</span></span>
<span id="cb6-13"><a href="#cb6-13" tabindex="-1"></a><span class="co">// Delete the &#39;geometry&#39; import</span></span>
<span id="cb6-14"><a href="#cb6-14" tabindex="-1"></a><span class="co">// Add a point at your chosen location</span></span>
<span id="cb6-15"><a href="#cb6-15" tabindex="-1"></a><span class="co">// Change the filter to find images from January 2023</span></span>
<span id="cb6-16"><a href="#cb6-16" tabindex="-1"></a></span>
<span id="cb6-17"><a href="#cb6-17" tabindex="-1"></a><span class="co">// Note: If you are in a very cloudy region, </span></span>
<span id="cb6-18"><a href="#cb6-18" tabindex="-1"></a><span class="co">// make sure to adjust the CLOUDY_PIXEL_PERCENTAGE</span></span></code></pre></div>
</div>
</div>
<div id="mosaics-and-composites" class="section level2">
<h2>04. Mosaics and Composites</h2>
<p>The default order of the collection is by date. So when you display
the collection, it implicitly creates a mosaic with the latest pixels on
top. You can call <code>.mosaic()</code> on a ImageCollection to create
a mosaic image from the pixels at the top (i.e) first image in the
stack.</p>
<p>We can also create a composite image by applying selection criteria
to each pixel from all pixels in the stack. Here we use the
<code>.median()</code> function to create a composite where each pixel
value is the median of all pixels values at each pixel from the stack
for all matching bands.</p>
<blockquote>
<p>Tip: If you need to create a mosaic where the images are in a
specific order, you can use the <code>.sort()</code> function to sort
your collection by a property first.</p>
</blockquote>
<a
href="https://code.earthengine.google.co.in/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3A01-Earth_Engine_Basics%2F04b_Mosaics_and_Composites_(complete)"
target="_blank">Open in Code Editor ↗</a>
<div class="figure" style="text-align: center">
<img src="images/gee_water_resources_management/mosaic_median.png" alt="Mosaic vs. Median Composite" width="100%" />
<p class="caption">
Mosaic vs. Median Composite
</p>
</div>
<div class="sourceCode" id="cb7"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a><span class="kw">var</span> geometry <span class="op">=</span> ee<span class="op">.</span><span class="at">Geometry</span><span class="op">.</span><span class="fu">Point</span>([<span class="fl">77.60412933051538</span><span class="op">,</span> <span class="fl">12.952912912328241</span>])</span>
<span id="cb7-2"><a href="#cb7-2" tabindex="-1"></a><span class="kw">var</span> s2 <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&quot;COPERNICUS/S2_SR_HARMONIZED&quot;</span>)<span class="op">;</span></span>
<span id="cb7-3"><a href="#cb7-3" tabindex="-1"></a></span>
<span id="cb7-4"><a href="#cb7-4" tabindex="-1"></a><span class="kw">var</span> rgbVis <span class="op">=</span> {</span>
<span id="cb7-5"><a href="#cb7-5" tabindex="-1"></a>  <span class="dt">min</span><span class="op">:</span> <span class="fl">0.0</span><span class="op">,</span></span>
<span id="cb7-6"><a href="#cb7-6" tabindex="-1"></a>  <span class="dt">max</span><span class="op">:</span> <span class="dv">3000</span><span class="op">,</span></span>
<span id="cb7-7"><a href="#cb7-7" tabindex="-1"></a>  <span class="dt">bands</span><span class="op">:</span> [<span class="st">&#39;B4&#39;</span><span class="op">,</span> <span class="st">&#39;B3&#39;</span><span class="op">,</span> <span class="st">&#39;B2&#39;</span>]<span class="op">,</span></span>
<span id="cb7-8"><a href="#cb7-8" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb7-9"><a href="#cb7-9" tabindex="-1"></a><span class="kw">var</span> filtered <span class="op">=</span> s2<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">lt</span>(<span class="st">&#39;CLOUDY_PIXEL_PERCENTAGE&#39;</span><span class="op">,</span> <span class="dv">30</span>))</span>
<span id="cb7-10"><a href="#cb7-10" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(<span class="st">&#39;2019-01-01&#39;</span><span class="op">,</span> <span class="st">&#39;2020-01-01&#39;</span>))</span>
<span id="cb7-11"><a href="#cb7-11" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">bounds</span>(geometry))</span>
<span id="cb7-12"><a href="#cb7-12" tabindex="-1"></a> </span>
<span id="cb7-13"><a href="#cb7-13" tabindex="-1"></a><span class="kw">var</span> mosaic <span class="op">=</span> filtered<span class="op">.</span><span class="fu">mosaic</span>() </span>
<span id="cb7-14"><a href="#cb7-14" tabindex="-1"></a> </span>
<span id="cb7-15"><a href="#cb7-15" tabindex="-1"></a><span class="kw">var</span> medianComposite <span class="op">=</span> filtered<span class="op">.</span><span class="fu">median</span>()<span class="op">;</span></span>
<span id="cb7-16"><a href="#cb7-16" tabindex="-1"></a></span>
<span id="cb7-17"><a href="#cb7-17" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">centerObject</span>(geometry<span class="op">,</span> <span class="dv">10</span>)</span>
<span id="cb7-18"><a href="#cb7-18" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(filtered<span class="op">,</span> rgbVis<span class="op">,</span> <span class="st">&#39;Filtered Collection&#39;</span>)<span class="op">;</span></span>
<span id="cb7-19"><a href="#cb7-19" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(mosaic<span class="op">,</span> rgbVis<span class="op">,</span> <span class="st">&#39;Mosaic&#39;</span>)<span class="op">;</span></span>
<span id="cb7-20"><a href="#cb7-20" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(medianComposite<span class="op">,</span> rgbVis<span class="op">,</span> <span class="st">&#39;Median Composite&#39;</span>)</span></code></pre></div>
<div id="exercise-3" class="section level3">
<h3>Exercise</h3>
<p><a
href="https://code.earthengine.google.co.in/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3A01-Earth_Engine_Basics%2F04c_Mosaics_and_Composites_(exercise)"
target="_blank">Try in Code Editor ↗</a></p>
<div class="sourceCode" id="cb8"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a><span class="co">// Create a median composite for the year 2020 and load it to the map</span></span>
<span id="cb8-2"><a href="#cb8-2" tabindex="-1"></a></span>
<span id="cb8-3"><a href="#cb8-3" tabindex="-1"></a><span class="co">// Compare both the composites to see the changes in your city</span></span></code></pre></div>
</div>
</div>
<div id="feature-collections" class="section level2">
<h2>05. Feature Collections</h2>
<p>Feature Collections are similar to Image Collections - but they
contain <em>Features</em>, not images. They are equivalent to a Vector
Layers in a GIS. We can load, filter and display Feature Collections
using similar techniques that we have learned so far.</p>
<p>Search for <em>GAUL Second Level Administrative Boundaries</em> and
load the collection. This is a global collection that contains all
Admin2 boundaries. We can apply a filter using the
<code>ADM1_NAME</code> property to get all Admin2 boundaries
(i.e. Districts) from a state.</p>
<p><a
href="https://code.earthengine.google.co.in/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3A01-Earth_Engine_Basics%2F05b_Feature_Collections_(complete)"
target="_blank">Open in Code Editor ↗</a>
<img src="images/gee_water_resources_management/feature_collection.png" width="100%" style="display: block; margin: auto;" /></p>
<div class="sourceCode" id="cb9"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a><span class="kw">var</span> admin2 <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">&quot;FAO/GAUL_SIMPLIFIED_500m/2015/level2&quot;</span>)<span class="op">;</span></span>
<span id="cb9-2"><a href="#cb9-2" tabindex="-1"></a></span>
<span id="cb9-3"><a href="#cb9-3" tabindex="-1"></a><span class="kw">var</span> karnataka <span class="op">=</span> admin2<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;ADM1_NAME&#39;</span><span class="op">,</span> <span class="st">&#39;Karnataka&#39;</span>))</span>
<span id="cb9-4"><a href="#cb9-4" tabindex="-1"></a></span>
<span id="cb9-5"><a href="#cb9-5" tabindex="-1"></a><span class="kw">var</span> visParams <span class="op">=</span> {<span class="st">&#39;color&#39;</span><span class="op">:</span> <span class="st">&#39;red&#39;</span>}</span>
<span id="cb9-6"><a href="#cb9-6" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(karnataka<span class="op">,</span> visParams<span class="op">,</span> <span class="st">&#39;Karnataka Districts&#39;</span>)</span></code></pre></div>
<div id="exercise-4" class="section level3">
<h3>Exercise</h3>
<p><a
href="https://code.earthengine.google.com/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3A01-Earth_Engine_Basics%2F05c_Feature_Collections_(exercise)"
target="_blank">Try in Code Editor ↗</a></p>
<div class="sourceCode" id="cb10"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb10-1"><a href="#cb10-1" tabindex="-1"></a><span class="co">// Add the admin2 layer to the map using Map.addLayer() function</span></span>
<span id="cb10-2"><a href="#cb10-2" tabindex="-1"></a><span class="co">// Go to your home city and inspect the layer to find the name of the region</span></span>
<span id="cb10-3"><a href="#cb10-3" tabindex="-1"></a><span class="co">// Use the ADM2_NAME property and apply a filter</span></span>
<span id="cb10-4"><a href="#cb10-4" tabindex="-1"></a><span class="co">// Display only the selected polygon on the map.</span></span></code></pre></div>
</div>
</div>
<div id="clipping" class="section level2">
<h2>06. Clipping</h2>
<p>It is often desirable to clip the images to your area of interest.
You can use the <code>clip()</code> function to mask an image using
geometry.</p>
<blockquote>
<p>While in Desktop softwares, clipping is used to remove the
unnecessary portion of a large image to save computation time, but in
the Earth Engine, clipping can <em>increase</em> the computation time.
As described in the <a
href="https://developers.google.com/earth-engine/guides/best_practices?hl=en#if-you-dont-need-to-clip,-dont-use-clip">Earth
Engine Coding Best Practices</a> guide, avoid clipping or do it at the
very end of your process.</p>
</blockquote>
<p><a
href="https://code.earthengine.google.co.in/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3A01-Earth_Engine_Basics%2F06b_Clipping_(complete)"
target="_blank">Open in Code Editor ↗</a></p>
<div class="figure" style="text-align: center">
<img src="images/gee_water_resources_management/clipping.png" alt="Full Image vs. Clipped Image" width="100%" />
<p class="caption">
Full Image vs. Clipped Image
</p>
</div>
<div class="sourceCode" id="cb11"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb11-1"><a href="#cb11-1" tabindex="-1"></a><span class="kw">var</span> admin2 <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">&quot;FAO/GAUL_SIMPLIFIED_500m/2015/level2&quot;</span>)<span class="op">;</span></span>
<span id="cb11-2"><a href="#cb11-2" tabindex="-1"></a><span class="kw">var</span> s2 <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&quot;COPERNICUS/S2_SR_HARMONIZED&quot;</span>)<span class="op">;</span></span>
<span id="cb11-3"><a href="#cb11-3" tabindex="-1"></a></span>
<span id="cb11-4"><a href="#cb11-4" tabindex="-1"></a><span class="kw">var</span> selected <span class="op">=</span> admin2<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;ADM2_NAME&#39;</span><span class="op">,</span> <span class="st">&#39;Bangalore Urban&#39;</span>))<span class="op">;</span></span>
<span id="cb11-5"><a href="#cb11-5" tabindex="-1"></a></span>
<span id="cb11-6"><a href="#cb11-6" tabindex="-1"></a><span class="kw">var</span> geometry <span class="op">=</span> selected<span class="op">.</span><span class="fu">geometry</span>()<span class="op">;</span></span>
<span id="cb11-7"><a href="#cb11-7" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">centerObject</span>(geometry)<span class="op">;</span></span>
<span id="cb11-8"><a href="#cb11-8" tabindex="-1"></a></span>
<span id="cb11-9"><a href="#cb11-9" tabindex="-1"></a><span class="kw">var</span> rgbVis <span class="op">=</span> {</span>
<span id="cb11-10"><a href="#cb11-10" tabindex="-1"></a>  <span class="dt">min</span><span class="op">:</span> <span class="fl">0.0</span><span class="op">,</span></span>
<span id="cb11-11"><a href="#cb11-11" tabindex="-1"></a>  <span class="dt">max</span><span class="op">:</span> <span class="dv">3000</span><span class="op">,</span></span>
<span id="cb11-12"><a href="#cb11-12" tabindex="-1"></a>  <span class="dt">bands</span><span class="op">:</span> [<span class="st">&#39;B4&#39;</span><span class="op">,</span> <span class="st">&#39;B3&#39;</span><span class="op">,</span> <span class="st">&#39;B2&#39;</span>]<span class="op">,</span> </span>
<span id="cb11-13"><a href="#cb11-13" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb11-14"><a href="#cb11-14" tabindex="-1"></a></span>
<span id="cb11-15"><a href="#cb11-15" tabindex="-1"></a><span class="kw">var</span> filtered <span class="op">=</span> s2<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">lt</span>(<span class="st">&#39;CLOUDY_PIXEL_PERCENTAGE&#39;</span><span class="op">,</span> <span class="dv">30</span>))</span>
<span id="cb11-16"><a href="#cb11-16" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(<span class="st">&#39;2019-01-01&#39;</span><span class="op">,</span> <span class="st">&#39;2020-01-01&#39;</span>))</span>
<span id="cb11-17"><a href="#cb11-17" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">bounds</span>(geometry))<span class="op">;</span></span>
<span id="cb11-18"><a href="#cb11-18" tabindex="-1"></a></span>
<span id="cb11-19"><a href="#cb11-19" tabindex="-1"></a><span class="kw">var</span> image <span class="op">=</span> filtered<span class="op">.</span><span class="fu">median</span>()<span class="op">;</span></span>
<span id="cb11-20"><a href="#cb11-20" tabindex="-1"></a></span>
<span id="cb11-21"><a href="#cb11-21" tabindex="-1"></a><span class="kw">var</span> clipped <span class="op">=</span> image<span class="op">.</span><span class="fu">clip</span>(geometry)<span class="op">;</span></span>
<span id="cb11-22"><a href="#cb11-22" tabindex="-1"></a></span>
<span id="cb11-23"><a href="#cb11-23" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(clipped<span class="op">,</span> rgbVis<span class="op">,</span> <span class="st">&#39;Clipped&#39;</span>)<span class="op">;</span></span></code></pre></div>
<div id="exercise-5" class="section level3">
<h3>Exercise</h3>
<p><a
href="https://code.earthengine.google.co.in/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3A01-Earth_Engine_Basics%2F06c_Clipping_(exercise)"
target="_blank">Try in Code Editor ↗</a></p>
<div class="sourceCode" id="cb12"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb12-1"><a href="#cb12-1" tabindex="-1"></a><span class="co">// Add the GAUL admin boundary to the Map</span></span>
<span id="cb12-2"><a href="#cb12-2" tabindex="-1"></a><span class="co">// Search for your city and inspect the ADM2_NAME</span></span>
<span id="cb12-3"><a href="#cb12-3" tabindex="-1"></a><span class="co">// Replace the name with the ADM2_NAME of your selected region</span></span>
<span id="cb12-4"><a href="#cb12-4" tabindex="-1"></a><span class="co">// And display the clipped composite on the map.</span></span></code></pre></div>
</div>
</div>
<div id="calculating-indices" class="section level2">
<h2>07. Calculating Indices</h2>
<p>Spectral Indices are central to many aspects of remote sensing. For
almost all research/work, you will need to compute one spectral indices.
The most commonly used formula for calculating an index is computing the
<em>Normalized Difference</em> between 2 bands. Earth Engine provides a
helper function <code>normalizedDifference()</code> to help calculate
normalized indices, such as Normalized Difference Vegetation Index
(NDVI) or Modified Normalized Difference Water Index (MNDWI).</p>
<p>Some indices - such as the Automated Water Extraction Index (AWEI) -
require calculation using a more complex formula.In such cases, you can
use the <code>expression()</code> function which allow you to to
construct formula with common arithmetic operators. The script below
shows how to implement common water-related indices in Earth Engine.
Note that the AWEI formula expects the pixel values to be reflectances,
so we need to apply a scaling factor of 0.0001 to convert the Sentinel-2
band values to reflectances.</p>
<p><a
href="https://code.earthengine.google.co.in/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3A01-Earth_Engine_Basics%2F07b_Calculating_Indices_(complete)"
target="_blank">Open in Code Editor ↗</a></p>
<div class="figure" style="text-align: center">
<img src="images/gee_water_resources_management/indices.png" alt="RGB, MNDWI, NDVI and AWEI images" width="100%" />
<p class="caption">
RGB, MNDWI, NDVI and AWEI images
</p>
</div>
<div class="sourceCode" id="cb13"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb13-1"><a href="#cb13-1" tabindex="-1"></a><span class="kw">var</span> admin2 <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">&quot;FAO/GAUL_SIMPLIFIED_500m/2015/level2&quot;</span>)<span class="op">;</span></span>
<span id="cb13-2"><a href="#cb13-2" tabindex="-1"></a><span class="kw">var</span> s2 <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&quot;COPERNICUS/S2_SR_HARMONIZED&quot;</span>)<span class="op">;</span></span>
<span id="cb13-3"><a href="#cb13-3" tabindex="-1"></a></span>
<span id="cb13-4"><a href="#cb13-4" tabindex="-1"></a><span class="kw">var</span> selected <span class="op">=</span> admin2<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;ADM2_NAME&#39;</span><span class="op">,</span> <span class="st">&#39;Bangalore Urban&#39;</span>))</span>
<span id="cb13-5"><a href="#cb13-5" tabindex="-1"></a><span class="kw">var</span> geometry <span class="op">=</span> selected<span class="op">.</span><span class="fu">geometry</span>()</span>
<span id="cb13-6"><a href="#cb13-6" tabindex="-1"></a></span>
<span id="cb13-7"><a href="#cb13-7" tabindex="-1"></a><span class="kw">var</span> filtered <span class="op">=</span> s2<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">lt</span>(<span class="st">&#39;CLOUDY_PIXEL_PERCENTAGE&#39;</span><span class="op">,</span> <span class="dv">30</span>))</span>
<span id="cb13-8"><a href="#cb13-8" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(<span class="st">&#39;2019-01-01&#39;</span><span class="op">,</span> <span class="st">&#39;2020-01-01&#39;</span>))</span>
<span id="cb13-9"><a href="#cb13-9" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">bounds</span>(geometry))</span>
<span id="cb13-10"><a href="#cb13-10" tabindex="-1"></a></span>
<span id="cb13-11"><a href="#cb13-11" tabindex="-1"></a><span class="kw">var</span> image <span class="op">=</span> filtered<span class="op">.</span><span class="fu">median</span>()<span class="op">;</span> </span>
<span id="cb13-12"><a href="#cb13-12" tabindex="-1"></a></span>
<span id="cb13-13"><a href="#cb13-13" tabindex="-1"></a></span>
<span id="cb13-14"><a href="#cb13-14" tabindex="-1"></a><span class="co">// Calculate  Normalized Difference Vegetation Index (NDVI)</span></span>
<span id="cb13-15"><a href="#cb13-15" tabindex="-1"></a><span class="co">// &#39;NIR&#39; (B8) and &#39;RED&#39; (B4)</span></span>
<span id="cb13-16"><a href="#cb13-16" tabindex="-1"></a><span class="kw">var</span> ndvi <span class="op">=</span> image<span class="op">.</span><span class="fu">normalizedDifference</span>([<span class="st">&#39;B8&#39;</span><span class="op">,</span> <span class="st">&#39;B4&#39;</span>])<span class="op">.</span><span class="fu">rename</span>([<span class="st">&#39;ndvi&#39;</span>])<span class="op">;</span></span>
<span id="cb13-17"><a href="#cb13-17" tabindex="-1"></a> </span>
<span id="cb13-18"><a href="#cb13-18" tabindex="-1"></a><span class="co">// Calculate Modified Normalized Difference Water Index (MNDWI)</span></span>
<span id="cb13-19"><a href="#cb13-19" tabindex="-1"></a><span class="co">// &#39;GREEN&#39; (B3) and &#39;SWIR1&#39; (B11)</span></span>
<span id="cb13-20"><a href="#cb13-20" tabindex="-1"></a><span class="kw">var</span> mndwi <span class="op">=</span> image<span class="op">.</span><span class="fu">normalizedDifference</span>([<span class="st">&#39;B3&#39;</span><span class="op">,</span> <span class="st">&#39;B11&#39;</span>])<span class="op">.</span><span class="fu">rename</span>([<span class="st">&#39;mndwi&#39;</span>])<span class="op">;</span> </span>
<span id="cb13-21"><a href="#cb13-21" tabindex="-1"></a></span>
<span id="cb13-22"><a href="#cb13-22" tabindex="-1"></a><span class="co">// Calculate Automated Water Extraction Index (AWEI)</span></span>
<span id="cb13-23"><a href="#cb13-23" tabindex="-1"></a><span class="co">// AWEI is a Multi-band Index that uses the following bands</span></span>
<span id="cb13-24"><a href="#cb13-24" tabindex="-1"></a><span class="co">// &#39;BLUE&#39; (B2), GREEN&#39; (B3), &#39;NIR&#39; (B8), &#39;SWIR1&#39; (B11) and &#39;SWIR2&#39; (B12)</span></span>
<span id="cb13-25"><a href="#cb13-25" tabindex="-1"></a></span>
<span id="cb13-26"><a href="#cb13-26" tabindex="-1"></a><span class="co">// Formula for AWEI is as follows</span></span>
<span id="cb13-27"><a href="#cb13-27" tabindex="-1"></a><span class="co">// AWEI = 4 * (GREEN - SWIR2) - (0.25 * NIR + 2.75 * SWIR1)</span></span>
<span id="cb13-28"><a href="#cb13-28" tabindex="-1"></a></span>
<span id="cb13-29"><a href="#cb13-29" tabindex="-1"></a><span class="co">// For more complex indices, you can use the expression() function</span></span>
<span id="cb13-30"><a href="#cb13-30" tabindex="-1"></a></span>
<span id="cb13-31"><a href="#cb13-31" tabindex="-1"></a><span class="co">// Note: </span></span>
<span id="cb13-32"><a href="#cb13-32" tabindex="-1"></a><span class="co">// For the AWEI formula, the pixel values need to converted to reflectances</span></span>
<span id="cb13-33"><a href="#cb13-33" tabindex="-1"></a><span class="co">// Multiplyng the pixel values by &#39;scale&#39; gives us the reflectance value</span></span>
<span id="cb13-34"><a href="#cb13-34" tabindex="-1"></a><span class="co">// The scale value is 0.0001 for Sentinel-2 dataset</span></span>
<span id="cb13-35"><a href="#cb13-35" tabindex="-1"></a></span>
<span id="cb13-36"><a href="#cb13-36" tabindex="-1"></a><span class="kw">var</span> awei <span class="op">=</span> image<span class="op">.</span><span class="fu">expression</span>(</span>
<span id="cb13-37"><a href="#cb13-37" tabindex="-1"></a>    <span class="st">&#39;4*(GREEN - SWIR1) - (0.25*NIR + 2.75*SWIR2)&#39;</span><span class="op">,</span> {</span>
<span id="cb13-38"><a href="#cb13-38" tabindex="-1"></a>      <span class="st">&#39;GREEN&#39;</span><span class="op">:</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;B3&#39;</span>)<span class="op">.</span><span class="fu">multiply</span>(<span class="fl">0.0001</span>)<span class="op">,</span></span>
<span id="cb13-39"><a href="#cb13-39" tabindex="-1"></a>      <span class="st">&#39;NIR&#39;</span><span class="op">:</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;B8&#39;</span>)<span class="op">.</span><span class="fu">multiply</span>(<span class="fl">0.0001</span>)<span class="op">,</span></span>
<span id="cb13-40"><a href="#cb13-40" tabindex="-1"></a>      <span class="st">&#39;SWIR1&#39;</span><span class="op">:</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;B11&#39;</span>)<span class="op">.</span><span class="fu">multiply</span>(<span class="fl">0.0001</span>)<span class="op">,</span></span>
<span id="cb13-41"><a href="#cb13-41" tabindex="-1"></a>      <span class="st">&#39;SWIR2&#39;</span><span class="op">:</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;B12&#39;</span>)<span class="op">.</span><span class="fu">multiply</span>(<span class="fl">0.0001</span>)<span class="op">,</span></span>
<span id="cb13-42"><a href="#cb13-42" tabindex="-1"></a></span>
<span id="cb13-43"><a href="#cb13-43" tabindex="-1"></a>})<span class="op">.</span><span class="fu">rename</span>(<span class="st">&#39;awei&#39;</span>)<span class="op">;</span></span>
<span id="cb13-44"><a href="#cb13-44" tabindex="-1"></a></span>
<span id="cb13-45"><a href="#cb13-45" tabindex="-1"></a></span>
<span id="cb13-46"><a href="#cb13-46" tabindex="-1"></a><span class="kw">var</span> rgbVis <span class="op">=</span> {<span class="dt">min</span><span class="op">:</span> <span class="fl">0.0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span> <span class="dv">3000</span><span class="op">,</span> <span class="dt">bands</span><span class="op">:</span> [<span class="st">&#39;B4&#39;</span><span class="op">,</span> <span class="st">&#39;B3&#39;</span><span class="op">,</span> <span class="st">&#39;B2&#39;</span>]}<span class="op">;</span></span>
<span id="cb13-47"><a href="#cb13-47" tabindex="-1"></a><span class="kw">var</span> ndviVis <span class="op">=</span> {<span class="dt">min</span><span class="op">:</span><span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span><span class="dv">1</span><span class="op">,</span> <span class="dt">palette</span><span class="op">:</span> [<span class="st">&#39;white&#39;</span><span class="op">,</span> <span class="st">&#39;green&#39;</span>]}</span>
<span id="cb13-48"><a href="#cb13-48" tabindex="-1"></a><span class="kw">var</span> ndwiVis <span class="op">=</span> {<span class="dt">min</span><span class="op">:</span><span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span><span class="fl">0.5</span><span class="op">,</span> <span class="dt">palette</span><span class="op">:</span> [<span class="st">&#39;white&#39;</span><span class="op">,</span> <span class="st">&#39;blue&#39;</span>]}</span>
<span id="cb13-49"><a href="#cb13-49" tabindex="-1"></a></span>
<span id="cb13-50"><a href="#cb13-50" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">centerObject</span>(geometry<span class="op">,</span> <span class="dv">10</span>)</span>
<span id="cb13-51"><a href="#cb13-51" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(image<span class="op">.</span><span class="fu">clip</span>(geometry)<span class="op">,</span> rgbVis<span class="op">,</span> <span class="st">&#39;Image&#39;</span>)<span class="op">;</span></span>
<span id="cb13-52"><a href="#cb13-52" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(ndvi<span class="op">.</span><span class="fu">clip</span>(geometry)<span class="op">,</span> ndviVis<span class="op">,</span> <span class="st">&#39;ndvi&#39;</span>)</span>
<span id="cb13-53"><a href="#cb13-53" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(mndwi<span class="op">.</span><span class="fu">clip</span>(geometry)<span class="op">,</span> ndwiVis<span class="op">,</span> <span class="st">&#39;mndwi&#39;</span>)</span>
<span id="cb13-54"><a href="#cb13-54" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(awei<span class="op">.</span><span class="fu">clip</span>(geometry)<span class="op">,</span> ndwiVis<span class="op">,</span> <span class="st">&#39;awei&#39;</span>) </span></code></pre></div>
<div id="exercise-6" class="section level3">
<h3>Exercise</h3>
<p><a
href="https://code.earthengine.google.co.in/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3A01-Earth_Engine_Basics%2F07c_Calculating_Indices_(exercise)"
target="_blank">Try in Code Editor ↗</a></p>
<p>There is another version of AWEI called AWEIsh. This index is useful
where there are mountain or building shadows. This works best where
there are shadows but no bright reflective surfaces (snow, roof). The
expression for AWEI (sh) is as follows</p>
<p><code>AWEI (sh) = BLUE + 2.5*GREEN - 1.5*(NIR + SWIR1) - 0.25*SWIR2</code></p>
<p>We have implemented both versions of AWEI in the script. Add them to
the map and visualize both of them.</p>
</div>
</div>
<div id="computation-on-images" class="section level2">
<h2>08. Computation on Images</h2>
<p>Inspecting the MNDWI or AWEI index images, you will see that water
pixels have a higher value than other pixels. If we wanted to extract
those pixels, we can apply a threshold value to select all pixels above
a certain value. The result will be a binary image with pixel values 1
or 0. For all the pixels that matched the condition, the resulting value
will be 1, and for other pixels it will be 0. The conditions can be
written using the <em>conditional operators</em> like greater than
<code>.gt()</code>, lesser than <code>.lt()</code>, equal to
<code>.eq()</code>, greater than or equal to <code>.gte()</code>, etc.
We can also combine multiple layers to create a condition using the
<em>boolean operators</em> like AND <code>.and()</code>, OR
<code>.or()</code> functions. The script below shows how to implement
static thresholding in Earth Engine.</p>
<a
href="https://code.earthengine.google.co.in/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3A01-Earth_Engine_Basics%2F08b_Computation_on_Images_(complete)"
target="_blank">Open in Code Editor ↗</a>
<div class="figure" style="text-align: center">
<img src="images/gee_water_resources_management/threshold.png" alt="Extracting Waterbodies using a Simple Threshold" width="100%" />
<p class="caption">
Extracting Waterbodies using a Simple Threshold
</p>
</div>
<div class="sourceCode" id="cb14"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb14-1"><a href="#cb14-1" tabindex="-1"></a><span class="kw">var</span> admin2 <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">&quot;FAO/GAUL_SIMPLIFIED_500m/2015/level2&quot;</span>)<span class="op">;</span></span>
<span id="cb14-2"><a href="#cb14-2" tabindex="-1"></a><span class="kw">var</span> s2 <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&quot;COPERNICUS/S2_SR_HARMONIZED&quot;</span>)<span class="op">;</span></span>
<span id="cb14-3"><a href="#cb14-3" tabindex="-1"></a></span>
<span id="cb14-4"><a href="#cb14-4" tabindex="-1"></a><span class="kw">var</span> selected <span class="op">=</span> admin2<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;ADM2_NAME&#39;</span><span class="op">,</span> <span class="st">&#39;Bangalore Urban&#39;</span>))</span>
<span id="cb14-5"><a href="#cb14-5" tabindex="-1"></a><span class="kw">var</span> geometry <span class="op">=</span> selected<span class="op">.</span><span class="fu">geometry</span>()</span>
<span id="cb14-6"><a href="#cb14-6" tabindex="-1"></a></span>
<span id="cb14-7"><a href="#cb14-7" tabindex="-1"></a><span class="kw">var</span> filtered <span class="op">=</span> s2<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">lt</span>(<span class="st">&#39;CLOUDY_PIXEL_PERCENTAGE&#39;</span><span class="op">,</span> <span class="dv">30</span>))</span>
<span id="cb14-8"><a href="#cb14-8" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(<span class="st">&#39;2019-01-01&#39;</span><span class="op">,</span> <span class="st">&#39;2020-01-01&#39;</span>))</span>
<span id="cb14-9"><a href="#cb14-9" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">bounds</span>(geometry))</span>
<span id="cb14-10"><a href="#cb14-10" tabindex="-1"></a></span>
<span id="cb14-11"><a href="#cb14-11" tabindex="-1"></a><span class="kw">var</span> image <span class="op">=</span> filtered<span class="op">.</span><span class="fu">median</span>()<span class="op">;</span> </span>
<span id="cb14-12"><a href="#cb14-12" tabindex="-1"></a></span>
<span id="cb14-13"><a href="#cb14-13" tabindex="-1"></a><span class="kw">var</span> ndvi <span class="op">=</span> image<span class="op">.</span><span class="fu">normalizedDifference</span>([<span class="st">&#39;B8&#39;</span><span class="op">,</span> <span class="st">&#39;B4&#39;</span>])<span class="op">.</span><span class="fu">rename</span>([<span class="st">&#39;ndvi&#39;</span>])<span class="op">;</span></span>
<span id="cb14-14"><a href="#cb14-14" tabindex="-1"></a><span class="kw">var</span> mndwi <span class="op">=</span> image<span class="op">.</span><span class="fu">normalizedDifference</span>([<span class="st">&#39;B3&#39;</span><span class="op">,</span> <span class="st">&#39;B11&#39;</span>])<span class="op">.</span><span class="fu">rename</span>([<span class="st">&#39;mndwi&#39;</span>])<span class="op">;</span> </span>
<span id="cb14-15"><a href="#cb14-15" tabindex="-1"></a><span class="kw">var</span> awei <span class="op">=</span> image<span class="op">.</span><span class="fu">expression</span>(</span>
<span id="cb14-16"><a href="#cb14-16" tabindex="-1"></a>    <span class="st">&#39;4*(GREEN - SWIR1) - (0.25*NIR + 2.75*SWIR2)&#39;</span><span class="op">,</span> {</span>
<span id="cb14-17"><a href="#cb14-17" tabindex="-1"></a>      <span class="st">&#39;GREEN&#39;</span><span class="op">:</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;B3&#39;</span>)<span class="op">.</span><span class="fu">multiply</span>(<span class="fl">0.0001</span>)<span class="op">,</span></span>
<span id="cb14-18"><a href="#cb14-18" tabindex="-1"></a>      <span class="st">&#39;NIR&#39;</span><span class="op">:</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;B8&#39;</span>)<span class="op">.</span><span class="fu">multiply</span>(<span class="fl">0.0001</span>)<span class="op">,</span></span>
<span id="cb14-19"><a href="#cb14-19" tabindex="-1"></a>      <span class="st">&#39;SWIR1&#39;</span><span class="op">:</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;B11&#39;</span>)<span class="op">.</span><span class="fu">multiply</span>(<span class="fl">0.0001</span>)<span class="op">,</span></span>
<span id="cb14-20"><a href="#cb14-20" tabindex="-1"></a>      <span class="st">&#39;SWIR2&#39;</span><span class="op">:</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;B12&#39;</span>)<span class="op">.</span><span class="fu">multiply</span>(<span class="fl">0.0001</span>)<span class="op">,</span></span>
<span id="cb14-21"><a href="#cb14-21" tabindex="-1"></a>})<span class="op">.</span><span class="fu">rename</span>(<span class="st">&#39;awei&#39;</span>)<span class="op">;</span></span>
<span id="cb14-22"><a href="#cb14-22" tabindex="-1"></a></span>
<span id="cb14-23"><a href="#cb14-23" tabindex="-1"></a><span class="co">// Simple Thresholding</span></span>
<span id="cb14-24"><a href="#cb14-24" tabindex="-1"></a><span class="kw">var</span> waterMndwi <span class="op">=</span> mndwi<span class="op">.</span><span class="fu">gt</span>(<span class="dv">0</span>)</span>
<span id="cb14-25"><a href="#cb14-25" tabindex="-1"></a><span class="kw">var</span> waterAwei <span class="op">=</span> awei<span class="op">.</span><span class="fu">gt</span>(<span class="dv">0</span>)</span>
<span id="cb14-26"><a href="#cb14-26" tabindex="-1"></a></span>
<span id="cb14-27"><a href="#cb14-27" tabindex="-1"></a><span class="co">// Combining Multiple Conditions</span></span>
<span id="cb14-28"><a href="#cb14-28" tabindex="-1"></a><span class="kw">var</span> waterMultiple <span class="op">=</span> ndvi<span class="op">.</span><span class="fu">lt</span>(<span class="dv">0</span>)<span class="op">.</span><span class="fu">and</span>(mndwi<span class="op">.</span><span class="fu">gt</span>(<span class="dv">0</span>))</span>
<span id="cb14-29"><a href="#cb14-29" tabindex="-1"></a></span>
<span id="cb14-30"><a href="#cb14-30" tabindex="-1"></a><span class="kw">var</span> rgbVis <span class="op">=</span> {<span class="dt">min</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span> <span class="dv">3000</span><span class="op">,</span> <span class="dt">bands</span><span class="op">:</span> [<span class="st">&#39;B4&#39;</span><span class="op">,</span> <span class="st">&#39;B3&#39;</span><span class="op">,</span> <span class="st">&#39;B2&#39;</span>]}<span class="op">;</span></span>
<span id="cb14-31"><a href="#cb14-31" tabindex="-1"></a><span class="kw">var</span> waterVis <span class="op">=</span> {<span class="dt">min</span><span class="op">:</span><span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span><span class="dv">1</span><span class="op">,</span> <span class="dt">palette</span><span class="op">:</span> [<span class="st">&#39;white&#39;</span><span class="op">,</span> <span class="st">&#39;blue&#39;</span>]}</span>
<span id="cb14-32"><a href="#cb14-32" tabindex="-1"></a></span>
<span id="cb14-33"><a href="#cb14-33" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">centerObject</span>(geometry<span class="op">,</span> <span class="dv">10</span>)</span>
<span id="cb14-34"><a href="#cb14-34" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(image<span class="op">.</span><span class="fu">clip</span>(geometry)<span class="op">,</span> rgbVis<span class="op">,</span> <span class="st">&#39;Image&#39;</span>)<span class="op">;</span></span>
<span id="cb14-35"><a href="#cb14-35" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(waterMndwi<span class="op">.</span><span class="fu">clip</span>(geometry)<span class="op">,</span> waterVis<span class="op">,</span> <span class="st">&#39;MNDWI - Simple threshold&#39;</span>)</span>
<span id="cb14-36"><a href="#cb14-36" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(waterAwei<span class="op">.</span><span class="fu">clip</span>(geometry)<span class="op">,</span> waterVis<span class="op">,</span> <span class="st">&#39;AWEI - Simple threshold&#39;</span>)</span>
<span id="cb14-37"><a href="#cb14-37" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(waterMultiple<span class="op">.</span><span class="fu">clip</span>(geometry)<span class="op">,</span> waterVis<span class="op">,</span> <span class="st">&#39;MNDWI and NDVI Threshold&#39;</span>)</span></code></pre></div>
<div id="exercise-7" class="section level3">
<h3>Exercise</h3>
<p><a
href="https://code.earthengine.google.co.in/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3A01-Earth_Engine_Basics%2F08c_Computation_on_Images_(exercise)"
target="_blank">Try in Code Editor ↗</a></p>
<p>Replace the selected region with the region of your choice and and
adjust the MNDWI thresholds to extract the waterbodies.</p>
<p>Try different thresholds and add images to the map to compare</p>
<ul>
<li>Hint: Try negative thresholds -0.1 and -0.2</li>
<li>Hint: Try positive thresholds 0.1 and 0.2</li>
</ul>
<div class="sourceCode" id="cb15"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb15-1"><a href="#cb15-1" tabindex="-1"></a><span class="kw">var</span> admin2 <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">&quot;FAO/GAUL_SIMPLIFIED_500m/2015/level2&quot;</span>)<span class="op">;</span></span>
<span id="cb15-2"><a href="#cb15-2" tabindex="-1"></a><span class="kw">var</span> s2 <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&quot;COPERNICUS/S2_SR_HARMONIZED&quot;</span>)<span class="op">;</span></span>
<span id="cb15-3"><a href="#cb15-3" tabindex="-1"></a></span>
<span id="cb15-4"><a href="#cb15-4" tabindex="-1"></a><span class="kw">var</span> selected <span class="op">=</span> admin2<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;ADM2_NAME&#39;</span><span class="op">,</span> <span class="st">&#39;Bangalore Urban&#39;</span>))</span>
<span id="cb15-5"><a href="#cb15-5" tabindex="-1"></a><span class="kw">var</span> geometry <span class="op">=</span> selected<span class="op">.</span><span class="fu">geometry</span>()</span>
<span id="cb15-6"><a href="#cb15-6" tabindex="-1"></a></span>
<span id="cb15-7"><a href="#cb15-7" tabindex="-1"></a><span class="kw">var</span> filtered <span class="op">=</span> s2<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">lt</span>(<span class="st">&#39;CLOUDY_PIXEL_PERCENTAGE&#39;</span><span class="op">,</span> <span class="dv">30</span>))</span>
<span id="cb15-8"><a href="#cb15-8" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(<span class="st">&#39;2019-01-01&#39;</span><span class="op">,</span> <span class="st">&#39;2020-01-01&#39;</span>))</span>
<span id="cb15-9"><a href="#cb15-9" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">bounds</span>(geometry))</span>
<span id="cb15-10"><a href="#cb15-10" tabindex="-1"></a></span>
<span id="cb15-11"><a href="#cb15-11" tabindex="-1"></a><span class="kw">var</span> image <span class="op">=</span> filtered<span class="op">.</span><span class="fu">median</span>()<span class="op">;</span> </span>
<span id="cb15-12"><a href="#cb15-12" tabindex="-1"></a></span>
<span id="cb15-13"><a href="#cb15-13" tabindex="-1"></a><span class="kw">var</span> mndwi <span class="op">=</span> image<span class="op">.</span><span class="fu">normalizedDifference</span>([<span class="st">&#39;B3&#39;</span><span class="op">,</span> <span class="st">&#39;B11&#39;</span>])<span class="op">.</span><span class="fu">rename</span>([<span class="st">&#39;mndwi&#39;</span>])<span class="op">;</span> </span>
<span id="cb15-14"><a href="#cb15-14" tabindex="-1"></a></span>
<span id="cb15-15"><a href="#cb15-15" tabindex="-1"></a><span class="co">// Simple Thresholding</span></span>
<span id="cb15-16"><a href="#cb15-16" tabindex="-1"></a><span class="kw">var</span> waterMndwi <span class="op">=</span> mndwi<span class="op">.</span><span class="fu">gt</span>(<span class="dv">0</span>)</span>
<span id="cb15-17"><a href="#cb15-17" tabindex="-1"></a></span>
<span id="cb15-18"><a href="#cb15-18" tabindex="-1"></a><span class="co">// Excercise</span></span>
<span id="cb15-19"><a href="#cb15-19" tabindex="-1"></a></span>
<span id="cb15-20"><a href="#cb15-20" tabindex="-1"></a><span class="co">// Replace the selected region with your choice</span></span>
<span id="cb15-21"><a href="#cb15-21" tabindex="-1"></a><span class="co">// And adjust the MNDWI thresholds to extract the waterbodies</span></span>
<span id="cb15-22"><a href="#cb15-22" tabindex="-1"></a><span class="co">// Try different thresholds and add images to the map to compare</span></span>
<span id="cb15-23"><a href="#cb15-23" tabindex="-1"></a><span class="co">// Hint: Try negative thresholds -0.1 and -0.2</span></span>
<span id="cb15-24"><a href="#cb15-24" tabindex="-1"></a><span class="co">// Hint: Try positive thresholds 0.1 and 0.2</span></span>
<span id="cb15-25"><a href="#cb15-25" tabindex="-1"></a></span>
<span id="cb15-26"><a href="#cb15-26" tabindex="-1"></a><span class="kw">var</span> rgbVis <span class="op">=</span> {<span class="dt">min</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span> <span class="dv">3000</span><span class="op">,</span> <span class="dt">bands</span><span class="op">:</span> [<span class="st">&#39;B4&#39;</span><span class="op">,</span> <span class="st">&#39;B3&#39;</span><span class="op">,</span> <span class="st">&#39;B2&#39;</span>]}<span class="op">;</span></span>
<span id="cb15-27"><a href="#cb15-27" tabindex="-1"></a><span class="kw">var</span> waterVis <span class="op">=</span> {<span class="dt">min</span><span class="op">:</span><span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span><span class="dv">1</span><span class="op">,</span> <span class="dt">palette</span><span class="op">:</span> [<span class="st">&#39;black&#39;</span><span class="op">,</span> <span class="st">&#39;white&#39;</span>]}</span>
<span id="cb15-28"><a href="#cb15-28" tabindex="-1"></a></span>
<span id="cb15-29"><a href="#cb15-29" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">centerObject</span>(geometry<span class="op">,</span> <span class="dv">10</span>)</span>
<span id="cb15-30"><a href="#cb15-30" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(image<span class="op">.</span><span class="fu">clip</span>(geometry)<span class="op">,</span> rgbVis<span class="op">,</span> <span class="st">&#39;Image&#39;</span>)<span class="op">;</span></span>
<span id="cb15-31"><a href="#cb15-31" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(waterMndwi<span class="op">.</span><span class="fu">clip</span>(geometry)<span class="op">,</span> waterVis<span class="op">,</span> <span class="st">&#39;MNDWI (Threshold 0)&#39;</span>)</span></code></pre></div>
</div>
</div>
<div id="export" class="section level2">
<h2>09. Export</h2>
<p>Earth Engine allows for exporting both vector and raster data to be
used in an external program. Vector data can be exported as a
<code>CSV</code> or a <code>Shapefile</code>, while Rasters can be
exported as <code>GeoTIFF</code> files. We will now export the
Sentinel-2 Composite as a GeoTIFF file.</p>
<p>During the export, we can export either a raw image or visualized
image. The raw image will retain the original pixel values and is ideal
if the image needs to be used for further analysis. The visualized image
will generate an RGB visualization of the image. The visualized image
will look exactly like you see it in Earth Engine with the visualization
parameters, but original pixel values will be lost. The visualized image
should not use it for analysis purposes.</p>
<blockquote>
<p>Tip: Code Editor supports autocompletion of API functions using the
combination <em>Ctrl+Space</em>. Type a few characters of a function and
press <em>Ctrl+Space</em> to see autocomplete suggestions. You can also
use the same key combination to fill all parameters of the function
automatically.</p>
</blockquote>
<p><a
href="https://code.earthengine.google.co.in/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3A01-Earth_Engine_Basics%2F09b_Export_(complete)"
target="_blank">Open in Code Editor ↗</a></p>
<div class="sourceCode" id="cb16"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb16-1"><a href="#cb16-1" tabindex="-1"></a><span class="kw">var</span> admin2 <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">&quot;FAO/GAUL_SIMPLIFIED_500m/2015/level2&quot;</span>)<span class="op">;</span></span>
<span id="cb16-2"><a href="#cb16-2" tabindex="-1"></a><span class="kw">var</span> s2 <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&quot;COPERNICUS/S2_SR_HARMONIZED&quot;</span>)<span class="op">;</span></span>
<span id="cb16-3"><a href="#cb16-3" tabindex="-1"></a></span>
<span id="cb16-4"><a href="#cb16-4" tabindex="-1"></a><span class="kw">var</span> selected <span class="op">=</span> admin2<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;ADM2_NAME&#39;</span><span class="op">,</span> <span class="st">&#39;Bangalore Urban&#39;</span>))</span>
<span id="cb16-5"><a href="#cb16-5" tabindex="-1"></a><span class="kw">var</span> geometry <span class="op">=</span> selected<span class="op">.</span><span class="fu">geometry</span>()</span>
<span id="cb16-6"><a href="#cb16-6" tabindex="-1"></a></span>
<span id="cb16-7"><a href="#cb16-7" tabindex="-1"></a><span class="kw">var</span> filtered <span class="op">=</span> s2<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">lt</span>(<span class="st">&#39;CLOUDY_PIXEL_PERCENTAGE&#39;</span><span class="op">,</span> <span class="dv">30</span>))</span>
<span id="cb16-8"><a href="#cb16-8" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(<span class="st">&#39;2019-01-01&#39;</span><span class="op">,</span> <span class="st">&#39;2020-01-01&#39;</span>))</span>
<span id="cb16-9"><a href="#cb16-9" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">bounds</span>(geometry))</span>
<span id="cb16-10"><a href="#cb16-10" tabindex="-1"></a></span>
<span id="cb16-11"><a href="#cb16-11" tabindex="-1"></a><span class="kw">var</span> image <span class="op">=</span> filtered<span class="op">.</span><span class="fu">median</span>()<span class="op">;</span> </span>
<span id="cb16-12"><a href="#cb16-12" tabindex="-1"></a></span>
<span id="cb16-13"><a href="#cb16-13" tabindex="-1"></a><span class="kw">var</span> ndvi <span class="op">=</span> image<span class="op">.</span><span class="fu">normalizedDifference</span>([<span class="st">&#39;B8&#39;</span><span class="op">,</span> <span class="st">&#39;B4&#39;</span>])<span class="op">.</span><span class="fu">rename</span>([<span class="st">&#39;ndvi&#39;</span>])<span class="op">;</span></span>
<span id="cb16-14"><a href="#cb16-14" tabindex="-1"></a><span class="kw">var</span> mndwi <span class="op">=</span> image<span class="op">.</span><span class="fu">normalizedDifference</span>([<span class="st">&#39;B3&#39;</span><span class="op">,</span> <span class="st">&#39;B11&#39;</span>])<span class="op">.</span><span class="fu">rename</span>([<span class="st">&#39;mndwi&#39;</span>])<span class="op">;</span> </span>
<span id="cb16-15"><a href="#cb16-15" tabindex="-1"></a></span>
<span id="cb16-16"><a href="#cb16-16" tabindex="-1"></a><span class="kw">var</span> waterMndwi <span class="op">=</span> mndwi<span class="op">.</span><span class="fu">gt</span>(<span class="dv">0</span>)</span>
<span id="cb16-17"><a href="#cb16-17" tabindex="-1"></a></span>
<span id="cb16-18"><a href="#cb16-18" tabindex="-1"></a><span class="kw">var</span> rgbVis <span class="op">=</span> {<span class="dt">min</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span> <span class="dv">3000</span><span class="op">,</span> <span class="dt">bands</span><span class="op">:</span> [<span class="st">&#39;B4&#39;</span><span class="op">,</span> <span class="st">&#39;B3&#39;</span><span class="op">,</span> <span class="st">&#39;B2&#39;</span>]}<span class="op">;</span></span>
<span id="cb16-19"><a href="#cb16-19" tabindex="-1"></a><span class="kw">var</span> waterVis <span class="op">=</span> {<span class="dt">min</span><span class="op">:</span><span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span><span class="dv">1</span><span class="op">,</span> <span class="dt">palette</span><span class="op">:</span> [<span class="st">&#39;black&#39;</span><span class="op">,</span> <span class="st">&#39;white&#39;</span>]}</span>
<span id="cb16-20"><a href="#cb16-20" tabindex="-1"></a></span>
<span id="cb16-21"><a href="#cb16-21" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">centerObject</span>(geometry<span class="op">,</span> <span class="dv">10</span>)</span>
<span id="cb16-22"><a href="#cb16-22" tabindex="-1"></a></span>
<span id="cb16-23"><a href="#cb16-23" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(image<span class="op">.</span><span class="fu">clip</span>(geometry)<span class="op">,</span> rgbVis<span class="op">,</span> <span class="st">&#39;Image&#39;</span>)<span class="op">;</span></span>
<span id="cb16-24"><a href="#cb16-24" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(waterMndwi<span class="op">.</span><span class="fu">clip</span>(geometry)<span class="op">,</span> waterVis<span class="op">,</span> <span class="st">&#39;MNDWI&#39;</span>)</span>
<span id="cb16-25"><a href="#cb16-25" tabindex="-1"></a></span>
<span id="cb16-26"><a href="#cb16-26" tabindex="-1"></a><span class="kw">var</span> exportImage <span class="op">=</span> image<span class="op">.</span><span class="fu">select</span>([<span class="st">&#39;B4&#39;</span><span class="op">,</span> <span class="st">&#39;B3&#39;</span><span class="op">,</span> <span class="st">&#39;B2&#39;</span>])</span>
<span id="cb16-27"><a href="#cb16-27" tabindex="-1"></a></span>
<span id="cb16-28"><a href="#cb16-28" tabindex="-1"></a>Export<span class="op">.</span><span class="at">image</span><span class="op">.</span><span class="fu">toDrive</span>({</span>
<span id="cb16-29"><a href="#cb16-29" tabindex="-1"></a>  <span class="dt">image</span><span class="op">:</span> exportImage<span class="op">.</span><span class="fu">clip</span>(geometry)<span class="op">,</span></span>
<span id="cb16-30"><a href="#cb16-30" tabindex="-1"></a>  <span class="dt">description</span><span class="op">:</span> <span class="st">&#39;Raw_Composite_Image&#39;</span><span class="op">,</span></span>
<span id="cb16-31"><a href="#cb16-31" tabindex="-1"></a>  <span class="dt">folder</span><span class="op">:</span> <span class="st">&#39;earthengine&#39;</span><span class="op">,</span></span>
<span id="cb16-32"><a href="#cb16-32" tabindex="-1"></a>  <span class="dt">fileNamePrefix</span><span class="op">:</span> <span class="st">&#39;composite&#39;</span><span class="op">,</span></span>
<span id="cb16-33"><a href="#cb16-33" tabindex="-1"></a>  <span class="dt">region</span><span class="op">:</span> geometry<span class="op">,</span></span>
<span id="cb16-34"><a href="#cb16-34" tabindex="-1"></a>  <span class="dt">scale</span><span class="op">:</span> <span class="dv">10</span><span class="op">,</span></span>
<span id="cb16-35"><a href="#cb16-35" tabindex="-1"></a>  <span class="dt">maxPixels</span><span class="op">:</span> <span class="fl">1e10</span>})</span>
<span id="cb16-36"><a href="#cb16-36" tabindex="-1"></a></span>
<span id="cb16-37"><a href="#cb16-37" tabindex="-1"></a><span class="kw">var</span> visualizedImage <span class="op">=</span> image<span class="op">.</span><span class="fu">visualize</span>(rgbVis)</span>
<span id="cb16-38"><a href="#cb16-38" tabindex="-1"></a></span>
<span id="cb16-39"><a href="#cb16-39" tabindex="-1"></a>Export<span class="op">.</span><span class="at">image</span><span class="op">.</span><span class="fu">toDrive</span>({</span>
<span id="cb16-40"><a href="#cb16-40" tabindex="-1"></a>  <span class="dt">image</span><span class="op">:</span> visualizedImage<span class="op">.</span><span class="fu">clip</span>(geometry)<span class="op">,</span></span>
<span id="cb16-41"><a href="#cb16-41" tabindex="-1"></a>  <span class="dt">description</span><span class="op">:</span> <span class="st">&#39;Visualized_Composite_Image&#39;</span><span class="op">,</span></span>
<span id="cb16-42"><a href="#cb16-42" tabindex="-1"></a>  <span class="dt">folder</span><span class="op">:</span> <span class="st">&#39;earthengine&#39;</span><span class="op">,</span></span>
<span id="cb16-43"><a href="#cb16-43" tabindex="-1"></a>  <span class="dt">fileNamePrefix</span><span class="op">:</span> <span class="st">&#39;composite_visualized&#39;</span><span class="op">,</span></span>
<span id="cb16-44"><a href="#cb16-44" tabindex="-1"></a>  <span class="dt">region</span><span class="op">:</span> geometry<span class="op">,</span></span>
<span id="cb16-45"><a href="#cb16-45" tabindex="-1"></a>  <span class="dt">scale</span><span class="op">:</span> <span class="dv">10</span><span class="op">,</span></span>
<span id="cb16-46"><a href="#cb16-46" tabindex="-1"></a>  <span class="dt">maxPixels</span><span class="op">:</span> <span class="fl">1e10</span>}) </span></code></pre></div>
<p>Once you run this script, the <em>Tasks</em> tab will be highlighted.
Switch to the tab and you will see the tasks waiting. Click <em>Run</em>
next to each task to start the process. On clicking the <em>Run</em>
button, you will be prompted for a confirmation dialog. Verify the
settings and click <em>Run</em> to start the export.</p>
<div class="figure" style="text-align: center">
<img src="images/gee_water_resources_management/export_task.png" alt="Console, Tasks and Confirmation." width="150%" />
<p class="caption">
Console, Tasks and Confirmation.
</p>
</div>
<p>Once the Export finishes, a GeoTiff file for each export task will be
added to your Google Drive in the specified folder. You can download
them and use it any program that reads GeoTiff files.</p>
<div class="figure" style="text-align: center">
<img src="images/gee_water_resources_management/export_image.png" alt="Visualized vs Raw" width="100%" />
<p class="caption">
Visualized vs Raw
</p>
</div>
<div id="exercise-8" class="section level3">
<h3>Exercise</h3>
<p><a
href="https://code.earthengine.google.co.in/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3A01-Earth_Engine_Basics%2F09c_Export_(exercise)"
target="_blank">Try in Code Editor ↗</a></p>
<p>Export the <code>waterMndwi</code> image to your drive.</p>
</div>
</div>
</div>
<div id="module-2-surface-water-mapping" class="section level1">
<h1>Module 2: Surface Water Mapping</h1>
<p>In this Module, we will learn how to extract surface water polygons
from a chosen watershed. We will be using in <a
href="https://www.hydrosheds.org/page/hydrobasins">HydroSheds</a> and <a
href="https://global-surface-water.appspot.com/#features">JRC - Global
Surface Water</a> datasets. We will map the surface water for a chosen
year, mask non-water pixels, apply morphological filters to remove fill
holes and convert the raster image into polygons.</p>
<p><a
href="https://www.youtube.com/watch?v=sUzt55WGArc&amp;list=PLppGmFLhQ1HI0YeA5zQHxdNlmxihvBawF&amp;index=21"
target="_blank"><img
src="https://img.youtube.com/vi/sUzt55WGArc/mqdefault.jpg"
alt="Start Module 2 Videos" /></a></p>
<p><a
href="https://www.youtube.com/watch?v=sUzt55WGArc&amp;list=PLppGmFLhQ1HI0YeA5zQHxdNlmxihvBawF&amp;index=21"
target="_blank">Start Module 2 Videos ↗</a></p>
<p><a
href="https://docs.google.com/presentation/d/15EIaoRWc-obUrl2kqzlw_mYIaSAzYn7aOOE9SyU6XKc/edit?usp=sharing"
target="_blank">View the Presentation ↗</a></p>
<div id="load-global-surface-water-data" class="section level2">
<h2>01. Load Global Surface Water Data</h2>
<p>Lets load the <a
href="https://developers.google.com/earth-engine/datasets/catalog/JRC_GSW1_3_GlobalSurfaceWater">JRC
Global Surface Water Mapping Layers</a>. This data contains the
spatio-temporal distribution of surface water. It is a single image with
7 bands, where each band contains unique information. Let’s use the
<code>occurrence</code> band, which includes information on the
frequency of the water present from 1984-2020. The pixel value ranges
from 0-100, where 0 represents No trace of water in any year, and 100
represents water present in all 36 years.</p>
<p>Use the Inspector to find the frequency of water present in the
location.</p>
<a
href="https://code.earthengine.google.com/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3A02-Surface_Water_Mapping%2F01b_Load_Global_Surface_Water_Data_(complete)"
target="_blank">Open in Code Editor ↗</a>
<div class="figure" style="text-align: center">
<img src="images/gee_water_resources_management/Load_Global_Surface_Water_Data_01.png" alt="Frequency of water present over Bellandur lake" width="100%" />
<p class="caption">
Frequency of water present over Bellandur lake
</p>
</div>
<div id="exercise-9" class="section level3">
<h3>Exercise</h3>
<p><a
href="https://code.earthengine.google.com/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3A02-Surface_Water_Mapping%2F01c_Load_Global_Surface_Water_Data_(exercise)"
target="_blank">Try in Code Editor ↗</a></p>
<p>The <code>max_extent</code> band gives information on whether a pixel
ever contained water or not, 0 represents the pixel has no water present
in any of the months, and 1 represents the pixel has contained water in
it for at least 1 month.</p>
<p>Load the <code>max_extent</code> band and visualize it with correct
parameters.</p>
<div class="sourceCode" id="cb17"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb17-1"><a href="#cb17-1" tabindex="-1"></a><span class="co">// Create a map showing everywhere surface water was present.</span></span>
<span id="cb17-2"><a href="#cb17-2" tabindex="-1"></a><span class="co">// Select the &#39;max_extent&#39; band and display the results</span></span></code></pre></div>
</div>
</div>
<div id="create-a-water-mask" class="section level2">
<h2>02. Create a Water Mask</h2>
<p>Earth Engine has a <code>mask</code> function to represent the <em>No
Data</em> values in an Image. Any masked pixel of an image will not be
used for analysis or visualization. There are two types of masks
<code>selfMask</code> and <code>updateMask.</code></p>
<p>The <code>selfMask</code> will remove all the pixel values with
<em>zero</em>. In the <code>max_extent</code> band visualization, we saw
the pixel value is either 0 or 1, the pixel value with 0 contains no
information, but the pixel value with 1 represents the water occurrence.
So to remove the No Data pixel within the image, we can use the selfMask
function. This will mask all pixel value with 0.</p>
<p>The <code>updateMask</code> will mask a <em>primary image</em> using
a <em>mask image</em>. A mask image is an image with 0 1 pixel value.
The primary image pixels overlaying with 0-pixel value in mask image
will be set as No Data and masked out.</p>
<a
href="https://code.earthengine.google.co.in/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3A02-Surface_Water_Mapping%2F02b_Create_a_Water_Mask_(complete)"
target="_blank">Open in Code Editor ↗</a>
<div class="figure" style="text-align: center">
<img src="images/gee_water_resources_management/water_mask.png" alt="Before applying Mask vs After applying Mask" width="100%" />
<p class="caption">
Before applying Mask vs After applying Mask
</p>
</div>
<div class="sourceCode" id="cb18"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb18-1"><a href="#cb18-1" tabindex="-1"></a><span class="kw">var</span> gsw <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(<span class="st">&quot;JRC/GSW1_4/GlobalSurfaceWater&quot;</span>)<span class="op">;</span></span>
<span id="cb18-2"><a href="#cb18-2" tabindex="-1"></a><span class="co">// Select the &#39;max_extent&#39; band</span></span>
<span id="cb18-3"><a href="#cb18-3" tabindex="-1"></a><span class="kw">var</span> water <span class="op">=</span> gsw<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;max_extent&#39;</span>)<span class="op">;</span></span>
<span id="cb18-4"><a href="#cb18-4" tabindex="-1"></a></span>
<span id="cb18-5"><a href="#cb18-5" tabindex="-1"></a><span class="co">// max_extent band has values 0 or 1</span></span>
<span id="cb18-6"><a href="#cb18-6" tabindex="-1"></a><span class="co">// We can remove the 0 values by masking the layer</span></span>
<span id="cb18-7"><a href="#cb18-7" tabindex="-1"></a><span class="co">// Mask needs to have 0 or 1 values</span></span>
<span id="cb18-8"><a href="#cb18-8" tabindex="-1"></a><span class="co">// 0 - remove the pixel</span></span>
<span id="cb18-9"><a href="#cb18-9" tabindex="-1"></a><span class="co">// 1 - keep the pixel</span></span>
<span id="cb18-10"><a href="#cb18-10" tabindex="-1"></a></span>
<span id="cb18-11"><a href="#cb18-11" tabindex="-1"></a><span class="kw">var</span> masked <span class="op">=</span> water<span class="op">.</span><span class="fu">updateMask</span>(water)</span>
<span id="cb18-12"><a href="#cb18-12" tabindex="-1"></a></span>
<span id="cb18-13"><a href="#cb18-13" tabindex="-1"></a><span class="co">// There is a handy short-hand for masking out 0 values for a layer</span></span>
<span id="cb18-14"><a href="#cb18-14" tabindex="-1"></a><span class="co">// You can call selfMask() which will mask the image with itself</span></span>
<span id="cb18-15"><a href="#cb18-15" tabindex="-1"></a><span class="co">// Effectively removing 0 values and retaining non-zero values</span></span>
<span id="cb18-16"><a href="#cb18-16" tabindex="-1"></a><span class="kw">var</span> masked <span class="op">=</span> water<span class="op">.</span><span class="fu">selfMask</span>()</span>
<span id="cb18-17"><a href="#cb18-17" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(masked<span class="op">,</span> {}<span class="op">,</span> <span class="st">&#39;Water&#39;</span>)<span class="op">;</span></span></code></pre></div>
<div id="exercise-10" class="section level3">
<h3>Exercise</h3>
<p><a
href="https://code.earthengine.google.co.in/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3A02-Surface_Water_Mapping%2F02c_Create_a_Water_Mask_(exercise)"
target="_blank">Try in Code Editor ↗</a></p>
<p>The <code>seasonality</code> band gives information on the number of
months water was present in a pixel. Pixel value ranges from 1 to 12, 1
represents water present for 1 month, and 12 represents water present
for 12 months in a year.</p>
<p>Select all pixels in which water present for more than 5 months in a
year.</p>
<div class="sourceCode" id="cb19"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb19-1"><a href="#cb19-1" tabindex="-1"></a><span class="co">// Exercise</span></span>
<span id="cb19-2"><a href="#cb19-2" tabindex="-1"></a><span class="co">// Use the &#39;seasonality&#39; band to map permanent water</span></span>
<span id="cb19-3"><a href="#cb19-3" tabindex="-1"></a><span class="co">// Permanent water can be defined where water is </span></span>
<span id="cb19-4"><a href="#cb19-4" tabindex="-1"></a><span class="co">// present &gt; 5 months in a year</span></span>
<span id="cb19-5"><a href="#cb19-5" tabindex="-1"></a></span>
<span id="cb19-6"><a href="#cb19-6" tabindex="-1"></a><span class="co">// Mask the layer and display the map in blue color</span></span>
<span id="cb19-7"><a href="#cb19-7" tabindex="-1"></a></span>
<span id="cb19-8"><a href="#cb19-8" tabindex="-1"></a><span class="kw">var</span> gsw <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(<span class="st">&quot;JRC/GSW1_4/GlobalSurfaceWater&quot;</span>)<span class="op">;</span></span>
<span id="cb19-9"><a href="#cb19-9" tabindex="-1"></a><span class="kw">var</span> seasonality <span class="op">=</span> gsw<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;seasonality&#39;</span>)<span class="op">;</span></span></code></pre></div>
</div>
</div>
<div id="find-lost-waterbodies" class="section level2">
<h2>03. Find Lost Waterbodies</h2>
<p>The <code>transition</code> band has water class changes between 1986
and 2020. It has <a
href="https://developers.google.com/earth-engine/datasets/catalog/JRC_GSW1_3_GlobalSurfaceWater#bands">10
classes</a> representing different changes, in which classes <em>3</em>
and <em>6</em> represent <em>permanent</em> and <em>seasonal water
loss</em>. We can calculate the total area of surface water lost by
selecting both classes.</p>
<p>The <em>binary operator</em> <code>eq</code> is used to select a
particular class and create a binary image representing the availability
of the class. The <em>boolean operator</em> <code>or</code> is used to
create a binary image where either class value is present.</p>
<p><a
href="https://code.earthengine.google.com/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3A02-Surface_Water_Mapping%2F03b_Find_Lost_Waterbodies_(complete)"
target="_blank">Open in Code Editor ↗</a></p>
<div class="sourceCode" id="cb20"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb20-1"><a href="#cb20-1" tabindex="-1"></a><span class="kw">var</span> gsw <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(<span class="st">&quot;JRC/GSW1_4/GlobalSurfaceWater&quot;</span>)</span>
<span id="cb20-2"><a href="#cb20-2" tabindex="-1"></a><span class="co">// Select the &#39;transition&#39; band</span></span>
<span id="cb20-3"><a href="#cb20-3" tabindex="-1"></a><span class="kw">var</span> water <span class="op">=</span> gsw<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;transition&#39;</span>)<span class="op">;</span> </span>
<span id="cb20-4"><a href="#cb20-4" tabindex="-1"></a></span>
<span id="cb20-5"><a href="#cb20-5" tabindex="-1"></a><span class="kw">var</span> lostWater <span class="op">=</span> water<span class="op">.</span><span class="fu">eq</span>(<span class="dv">3</span>)<span class="op">.</span><span class="fu">or</span>(water<span class="op">.</span><span class="fu">eq</span>(<span class="dv">6</span>))</span>
<span id="cb20-6"><a href="#cb20-6" tabindex="-1"></a></span>
<span id="cb20-7"><a href="#cb20-7" tabindex="-1"></a><span class="kw">var</span> visParams <span class="op">=</span> {</span>
<span id="cb20-8"><a href="#cb20-8" tabindex="-1"></a>  <span class="dt">min</span><span class="op">:</span><span class="dv">0</span><span class="op">,</span></span>
<span id="cb20-9"><a href="#cb20-9" tabindex="-1"></a>  <span class="dt">max</span><span class="op">:</span><span class="dv">1</span><span class="op">,</span></span>
<span id="cb20-10"><a href="#cb20-10" tabindex="-1"></a>  <span class="dt">palette</span><span class="op">:</span> [<span class="st">&#39;white&#39;</span><span class="op">,</span><span class="st">&#39;red&#39;</span>]</span>
<span id="cb20-11"><a href="#cb20-11" tabindex="-1"></a>}</span>
<span id="cb20-12"><a href="#cb20-12" tabindex="-1"></a></span>
<span id="cb20-13"><a href="#cb20-13" tabindex="-1"></a><span class="co">// Mask &#39;0&#39; value pixels</span></span>
<span id="cb20-14"><a href="#cb20-14" tabindex="-1"></a><span class="kw">var</span> lostWater <span class="op">=</span> lostWater<span class="op">.</span><span class="fu">selfMask</span>()</span>
<span id="cb20-15"><a href="#cb20-15" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(lostWater<span class="op">,</span> visParams<span class="op">,</span> <span class="st">&#39;Lost Water&#39;</span>) </span></code></pre></div>
<div id="exercise-11" class="section level3">
<h3>Exercise</h3>
<p><a
href="https://code.earthengine.google.com/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3A02-Surface_Water_Mapping%2F03c_Find_Lost_Waterbodies_(exercise)"
target="_blank">Try in Code Editor ↗</a></p>
<p>Use the <code>transition</code> band and find the total surface water
gain.</p>
<div class="sourceCode" id="cb21"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb21-1"><a href="#cb21-1" tabindex="-1"></a><span class="kw">var</span> gsw <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(<span class="st">&quot;JRC/GSW1_4/GlobalSurfaceWater&quot;</span>)</span>
<span id="cb21-2"><a href="#cb21-2" tabindex="-1"></a><span class="kw">var</span> water <span class="op">=</span> gsw<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;transition&#39;</span>)<span class="op">;</span> </span>
<span id="cb21-3"><a href="#cb21-3" tabindex="-1"></a></span>
<span id="cb21-4"><a href="#cb21-4" tabindex="-1"></a><span class="co">// Exercise</span></span>
<span id="cb21-5"><a href="#cb21-5" tabindex="-1"></a><span class="co">// Find the surface water that was gained between 1984-2020 </span></span>
<span id="cb21-6"><a href="#cb21-6" tabindex="-1"></a><span class="co">// Display the results on the map</span></span></code></pre></div>
</div>
</div>
<div id="get-yearly-water-history" class="section level2">
<h2>04. Get Yearly Water History</h2>
<p>The <a
href="https://developers.google.com/earth-engine/datasets/catalog/JRC_GSW1_3_YearlyHistory">JRC
Yearly Water Classification History</a> image collection contains the
spatiotemporal map of surface water from 1984 to 2020. A total of 37
images represent 1 image for each year.</p>
<p>Let us filter this collection to visualize the surface water map of
the year <em>2020</em>. This data contains 4 bands, where bands 2 and 3
indicate water presence.</p>
<blockquote>
<p>After filtering the Image Collection, the resultant would be a
collection even if it contains just 1 image. We can use the function
<code>.first()</code> to extract the particular image.</p>
</blockquote>
<p><a
href="https://code.earthengine.google.com/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3A02-Surface_Water_Mapping%2F04b_Get_Yearly_Water_History_(complete)"
target="_blank">Open in Code Editor ↗</a></p>
<div class="sourceCode" id="cb22"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb22-1"><a href="#cb22-1" tabindex="-1"></a><span class="kw">var</span> gswYearly <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&quot;JRC/GSW1_4/YearlyHistory&quot;</span>)<span class="op">;</span></span>
<span id="cb22-2"><a href="#cb22-2" tabindex="-1"></a></span>
<span id="cb22-3"><a href="#cb22-3" tabindex="-1"></a><span class="co">// Filter using the &#39;year&#39; property</span></span>
<span id="cb22-4"><a href="#cb22-4" tabindex="-1"></a></span>
<span id="cb22-5"><a href="#cb22-5" tabindex="-1"></a><span class="kw">var</span> filtered <span class="op">=</span> gswYearly<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;year&#39;</span><span class="op">,</span> <span class="dv">2020</span>))</span>
<span id="cb22-6"><a href="#cb22-6" tabindex="-1"></a><span class="kw">var</span> gsw2020 <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(filtered<span class="op">.</span><span class="fu">first</span>())</span>
<span id="cb22-7"><a href="#cb22-7" tabindex="-1"></a></span>
<span id="cb22-8"><a href="#cb22-8" tabindex="-1"></a><span class="co">// Select permanent or seasonal water</span></span>
<span id="cb22-9"><a href="#cb22-9" tabindex="-1"></a><span class="kw">var</span> water2020 <span class="op">=</span> gsw2020<span class="op">.</span><span class="fu">eq</span>(<span class="dv">2</span>)<span class="op">.</span><span class="fu">or</span>(gsw2020<span class="op">.</span><span class="fu">eq</span>(<span class="dv">3</span>))</span>
<span id="cb22-10"><a href="#cb22-10" tabindex="-1"></a></span>
<span id="cb22-11"><a href="#cb22-11" tabindex="-1"></a><span class="co">// Mask &#39;0&#39; value pixels</span></span>
<span id="cb22-12"><a href="#cb22-12" tabindex="-1"></a><span class="kw">var</span> water2020 <span class="op">=</span> water2020<span class="op">.</span><span class="fu">selfMask</span>()</span>
<span id="cb22-13"><a href="#cb22-13" tabindex="-1"></a></span>
<span id="cb22-14"><a href="#cb22-14" tabindex="-1"></a><span class="kw">var</span> visParams <span class="op">=</span> {</span>
<span id="cb22-15"><a href="#cb22-15" tabindex="-1"></a>  <span class="dt">min</span><span class="op">:</span><span class="dv">0</span><span class="op">,</span></span>
<span id="cb22-16"><a href="#cb22-16" tabindex="-1"></a>  <span class="dt">max</span><span class="op">:</span><span class="dv">1</span><span class="op">,</span></span>
<span id="cb22-17"><a href="#cb22-17" tabindex="-1"></a>  <span class="dt">palette</span><span class="op">:</span> [<span class="st">&#39;white&#39;</span><span class="op">,</span><span class="st">&#39;blue&#39;</span>]</span>
<span id="cb22-18"><a href="#cb22-18" tabindex="-1"></a>}</span>
<span id="cb22-19"><a href="#cb22-19" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(water2020<span class="op">,</span> visParams<span class="op">,</span> <span class="st">&#39;2020 Water&#39;</span>)</span></code></pre></div>
<div id="exercise-12" class="section level3">
<h3>Exercise</h3>
<p><a
href="https://code.earthengine.google.com/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3A02-Surface_Water_Mapping%2F04c_Get_Yearly_Water_History_(exercise)"
target="_blank">Try in Code Editor ↗</a></p>
<p>Use the <code>JRC Yearly Water Classification History</code> dataset
and visualize the surface water map for the year <em>2010</em>.</p>
<div class="sourceCode" id="cb23"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb23-1"><a href="#cb23-1" tabindex="-1"></a><span class="co">// Get the surface water image for the year 2010</span></span>
<span id="cb23-2"><a href="#cb23-2" tabindex="-1"></a><span class="co">// Display it on the map</span></span></code></pre></div>
</div>
</div>
<div id="locate-a-subbasin" class="section level2">
<h2>05. Locate a SubBasin</h2>
<p>The <a href="https://www.hydrosheds.org/">HydroSHEDS</a> is a series
of data primarily developed by the <em>World Wildlife Fund</em>. It
contains a global level geo-reference stream network, watershed
boundaries, and drainage directions. We will use the
<code>hydroBASINS,</code> a feature collection containing drainage basin
boundaries. This data is created using SRTM DEM data. There are multiple
levels of hydroBASINS, ranging from 1 to 11. In level 1, the basin
boundaries are delineated as huge groups. Moving levels up, these
boundaries will be sub-divided into smaller boundaries.</p>
<p>We will use the Level 7 hydroBASINS feature collection to filter and
locate a sun-basin called <em>Arkavathy</em>. The hydroBASINS doesn’t
contain basin names, so basins should be visually located and filtered
using the <em>HYBAS_ID</em> property to filter a particular basin
boundary.</p>
<p><a
href="https://code.earthengine.google.com/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3A02-Surface_Water_Mapping%2F05b_Locate_a_SubBasin_(complete)"
target="_blank">Open in Code Editor ↗</a></p>
<div class="sourceCode" id="cb24"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb24-1"><a href="#cb24-1" tabindex="-1"></a><span class="kw">var</span> hydrobasins <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">&quot;WWF/HydroSHEDS/v1/Basins/hybas_7&quot;</span>)<span class="op">;</span></span>
<span id="cb24-2"><a href="#cb24-2" tabindex="-1"></a><span class="kw">var</span> basin <span class="op">=</span> hydrobasins<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;HYBAS_ID&#39;</span><span class="op">,</span> <span class="dv">4071139640</span>))</span>
<span id="cb24-3"><a href="#cb24-3" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">centerObject</span>(basin)</span>
<span id="cb24-4"><a href="#cb24-4" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(basin<span class="op">,</span> {<span class="dt">color</span><span class="op">:</span> <span class="st">&#39;grey&#39;</span>}<span class="op">,</span> <span class="st">&#39;Arkavathy Sub Basin&#39;</span>)</span></code></pre></div>
<div id="exercise-13" class="section level3">
<h3>Exercise</h3>
<p><a
href="https://code.earthengine.google.com/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3A02-Surface_Water_Mapping%2F05c_Locate_a_SubBasin_(exercise)"
target="_blank">Try in Code Editor ↗</a></p>
<p>Using the Level 7 hydroBASINS, locate and filter a watershed basin in
your region of interest.</p>
<div class="sourceCode" id="cb25"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb25-1"><a href="#cb25-1" tabindex="-1"></a><span class="co">// Add the hydrobasins layer to the map</span></span>
<span id="cb25-2"><a href="#cb25-2" tabindex="-1"></a><span class="co">// Zoom to your region on interest and inspect the layer</span></span>
<span id="cb25-3"><a href="#cb25-3" tabindex="-1"></a><span class="co">// Find the id for a sub basin of interest and add it to the map.</span></span></code></pre></div>
</div>
</div>
<div id="create-a-surface-water-map" class="section level2">
<h2>06. Create a Surface Water Map</h2>
<p>A raster image output can be post-processed using morphological
operations to create a clean-looking surface map. There are different
types of operations like <em>Morphological Opening</em>,
<em>Morphological Closing</em>, and <em>Majority Filtering</em>.</p>
<blockquote>
<p>Warning: We are processing the image here to clean it up to create a
mapping product, but this changes the structure of the image and alters
the statistics. Skip this step if your goal is to detect water pixels or
compute the surface water area.</p>
</blockquote>
<ul>
<li>The opening operation can reduce the salt and pepper noise in the
image.</li>
<li>The closing operation can fill holes and create a complete
class.</li>
<li>A majority filter will smooth the image. This operation should be
used for mapping purposes only and not used while calculating
statistics, as it will significantly alter the result.</li>
</ul>
<p>Earth Engine has many functions to perform morphological operations
under <code>ee.Image</code>. Let’s use the <code>Max_extent</code> band
from Global Surface Water and fill holes to create a surface water map.
An <em>Erosion</em> operation follows a <em>Dilation</em> operation to
perform a closing operation, which translates as the <em>focalMin</em>
function chained with <em>focalMax</em> in the earth engine. Different
<em>kernelType</em> are available, let’s use the <em>Square</em> kernel
with <em>30</em> as search <em>radius</em> as the JRC’s Global Surface
Water spatial resolution is 30m. We can also define a custom kernel if
the required kernel is unavailable in kernelType.</p>
<a
href="https://code.earthengine.google.com/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3A02-Surface_Water_Mapping%2F06b_Create_a_Surface_Water_Map_(complete)"
target="_blank">Open in Code Editor ↗</a>
<div class="figure" style="text-align: center">
<img src="images/gee_water_resources_management/morphological_operation.png" alt="Before Operation vs After Operation" width="150%" />
<p class="caption">
Before Operation vs After Operation
</p>
</div>
<div class="sourceCode" id="cb26"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb26-1"><a href="#cb26-1" tabindex="-1"></a><span class="kw">var</span> gsw <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(<span class="st">&quot;JRC/GSW1_4/GlobalSurfaceWater&quot;</span>)<span class="op">;</span></span>
<span id="cb26-2"><a href="#cb26-2" tabindex="-1"></a><span class="kw">var</span> hydrobasins <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">&quot;WWF/HydroSHEDS/v1/Basins/hybas_7&quot;</span>)<span class="op">;</span></span>
<span id="cb26-3"><a href="#cb26-3" tabindex="-1"></a><span class="kw">var</span> basin <span class="op">=</span> hydrobasins<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;HYBAS_ID&#39;</span><span class="op">,</span> <span class="dv">4071139640</span>))</span>
<span id="cb26-4"><a href="#cb26-4" tabindex="-1"></a><span class="kw">var</span> geometry <span class="op">=</span> basin<span class="op">.</span><span class="fu">geometry</span>()</span>
<span id="cb26-5"><a href="#cb26-5" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">centerObject</span>(geometry<span class="op">,</span> <span class="dv">10</span>)</span>
<span id="cb26-6"><a href="#cb26-6" tabindex="-1"></a></span>
<span id="cb26-7"><a href="#cb26-7" tabindex="-1"></a><span class="kw">var</span> water <span class="op">=</span> gsw<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;max_extent&#39;</span>)<span class="op">;</span></span>
<span id="cb26-8"><a href="#cb26-8" tabindex="-1"></a></span>
<span id="cb26-9"><a href="#cb26-9" tabindex="-1"></a><span class="kw">var</span> clipped <span class="op">=</span> water<span class="op">.</span><span class="fu">clip</span>(geometry)</span>
<span id="cb26-10"><a href="#cb26-10" tabindex="-1"></a></span>
<span id="cb26-11"><a href="#cb26-11" tabindex="-1"></a><span class="kw">var</span> visParams <span class="op">=</span> {<span class="dt">min</span><span class="op">:</span><span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span><span class="dv">1</span><span class="op">,</span> <span class="dt">palette</span><span class="op">:</span> [<span class="st">&#39;white&#39;</span><span class="op">,</span><span class="st">&#39;blue&#39;</span>]}</span>
<span id="cb26-12"><a href="#cb26-12" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(clipped<span class="op">,</span> visParams<span class="op">,</span> <span class="st">&#39;Surface Water&#39;</span>) </span>
<span id="cb26-13"><a href="#cb26-13" tabindex="-1"></a></span>
<span id="cb26-14"><a href="#cb26-14" tabindex="-1"></a><span class="co">// Do unmask() to replace masked pixels with 0</span></span>
<span id="cb26-15"><a href="#cb26-15" tabindex="-1"></a><span class="co">// This avoids extra pixels along the edges</span></span>
<span id="cb26-16"><a href="#cb26-16" tabindex="-1"></a><span class="kw">var</span> clipped <span class="op">=</span> clipped<span class="op">.</span><span class="fu">unmask</span>(<span class="dv">0</span>)</span>
<span id="cb26-17"><a href="#cb26-17" tabindex="-1"></a><span class="co">// Perform a morphological closing to fill holes in waterbodies</span></span>
<span id="cb26-18"><a href="#cb26-18" tabindex="-1"></a><span class="kw">var</span> waterProcessed <span class="op">=</span> clipped</span>
<span id="cb26-19"><a href="#cb26-19" tabindex="-1"></a>  <span class="op">.</span><span class="fu">focalMax</span>({</span>
<span id="cb26-20"><a href="#cb26-20" tabindex="-1"></a>    <span class="st">&#39;radius&#39;</span><span class="op">:</span><span class="dv">30</span><span class="op">,</span></span>
<span id="cb26-21"><a href="#cb26-21" tabindex="-1"></a>    <span class="st">&#39;units&#39;</span><span class="op">:</span> <span class="st">&#39;meters&#39;</span><span class="op">,</span></span>
<span id="cb26-22"><a href="#cb26-22" tabindex="-1"></a>    <span class="st">&#39;kernelType&#39;</span><span class="op">:</span> <span class="st">&#39;square&#39;</span>})</span>
<span id="cb26-23"><a href="#cb26-23" tabindex="-1"></a>  <span class="op">.</span><span class="fu">focalMin</span>({</span>
<span id="cb26-24"><a href="#cb26-24" tabindex="-1"></a>    <span class="st">&#39;radius&#39;</span><span class="op">:</span><span class="dv">30</span><span class="op">,</span></span>
<span id="cb26-25"><a href="#cb26-25" tabindex="-1"></a>    <span class="st">&#39;units&#39;</span><span class="op">:</span> <span class="st">&#39;meters&#39;</span><span class="op">,</span></span>
<span id="cb26-26"><a href="#cb26-26" tabindex="-1"></a>    <span class="st">&#39;kernelType&#39;</span><span class="op">:</span> <span class="st">&#39;square&#39;</span>})<span class="op">;</span></span>
<span id="cb26-27"><a href="#cb26-27" tabindex="-1"></a></span>
<span id="cb26-28"><a href="#cb26-28" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(waterProcessed<span class="op">,</span> visParams<span class="op">,</span> <span class="st">&#39;Surface Water (Processed)&#39;</span>)</span></code></pre></div>
<div id="exercise-14" class="section level3">
<h3>Exercise</h3>
<p><a
href="https://code.earthengine.google.com/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3A02-Surface_Water_Mapping%2F06c_Create_a_Surface_Water_Map_(exercise)"
target="_blank">Try in Code Editor ↗</a></p>
<p>By default, the total iteration is 1. We can increase it as required,
so the kernel will pass through the image to perform the operation as
many times as required.</p>
<p>Set the iteration parameter to 2 and execute the morphological
closing operation.</p>
<div class="sourceCode" id="cb27"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb27-1"><a href="#cb27-1" tabindex="-1"></a><span class="kw">var</span> gsw <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(<span class="st">&quot;JRC/GSW1_4/GlobalSurfaceWater&quot;</span>)<span class="op">;</span></span>
<span id="cb27-2"><a href="#cb27-2" tabindex="-1"></a><span class="kw">var</span> hydrobasins <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">&quot;WWF/HydroSHEDS/v1/Basins/hybas_7&quot;</span>)<span class="op">;</span></span>
<span id="cb27-3"><a href="#cb27-3" tabindex="-1"></a><span class="kw">var</span> basin <span class="op">=</span> hydrobasins<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;HYBAS_ID&#39;</span><span class="op">,</span> <span class="dv">4071139640</span>))</span>
<span id="cb27-4"><a href="#cb27-4" tabindex="-1"></a><span class="kw">var</span> geometry <span class="op">=</span> basin<span class="op">.</span><span class="fu">geometry</span>()</span>
<span id="cb27-5"><a href="#cb27-5" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">centerObject</span>(geometry<span class="op">,</span> <span class="dv">10</span>)</span>
<span id="cb27-6"><a href="#cb27-6" tabindex="-1"></a></span>
<span id="cb27-7"><a href="#cb27-7" tabindex="-1"></a><span class="kw">var</span> water <span class="op">=</span> gsw<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;max_extent&#39;</span>)<span class="op">;</span></span>
<span id="cb27-8"><a href="#cb27-8" tabindex="-1"></a></span>
<span id="cb27-9"><a href="#cb27-9" tabindex="-1"></a><span class="kw">var</span> clipped <span class="op">=</span> water<span class="op">.</span><span class="fu">clip</span>(geometry)</span>
<span id="cb27-10"><a href="#cb27-10" tabindex="-1"></a></span>
<span id="cb27-11"><a href="#cb27-11" tabindex="-1"></a><span class="kw">var</span> visParams <span class="op">=</span> {<span class="dt">min</span><span class="op">:</span><span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span><span class="dv">1</span><span class="op">,</span> <span class="dt">palette</span><span class="op">:</span> [<span class="st">&#39;white&#39;</span><span class="op">,</span><span class="st">&#39;blue&#39;</span>]}</span>
<span id="cb27-12"><a href="#cb27-12" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(clipped<span class="op">,</span> visParams<span class="op">,</span> <span class="st">&#39;Surface Water&#39;</span>) </span>
<span id="cb27-13"><a href="#cb27-13" tabindex="-1"></a></span>
<span id="cb27-14"><a href="#cb27-14" tabindex="-1"></a><span class="co">// Do unmask() to replace masked pixels with 0</span></span>
<span id="cb27-15"><a href="#cb27-15" tabindex="-1"></a><span class="co">// This avoids extra pixels along the edges</span></span>
<span id="cb27-16"><a href="#cb27-16" tabindex="-1"></a><span class="kw">var</span> clipped <span class="op">=</span> clipped<span class="op">.</span><span class="fu">unmask</span>(<span class="dv">0</span>)</span>
<span id="cb27-17"><a href="#cb27-17" tabindex="-1"></a><span class="co">// Perform a morphological closing to fill holes in waterbodies</span></span>
<span id="cb27-18"><a href="#cb27-18" tabindex="-1"></a><span class="kw">var</span> waterProcessed <span class="op">=</span> clipped</span>
<span id="cb27-19"><a href="#cb27-19" tabindex="-1"></a>  <span class="op">.</span><span class="fu">focalMax</span>({</span>
<span id="cb27-20"><a href="#cb27-20" tabindex="-1"></a>    <span class="st">&#39;radius&#39;</span><span class="op">:</span><span class="dv">30</span><span class="op">,</span></span>
<span id="cb27-21"><a href="#cb27-21" tabindex="-1"></a>    <span class="st">&#39;units&#39;</span><span class="op">:</span> <span class="st">&#39;meters&#39;</span><span class="op">,</span></span>
<span id="cb27-22"><a href="#cb27-22" tabindex="-1"></a>    <span class="st">&#39;kernelType&#39;</span><span class="op">:</span> <span class="st">&#39;square&#39;</span>})</span>
<span id="cb27-23"><a href="#cb27-23" tabindex="-1"></a>  <span class="op">.</span><span class="fu">focalMin</span>({</span>
<span id="cb27-24"><a href="#cb27-24" tabindex="-1"></a>    <span class="st">&#39;radius&#39;</span><span class="op">:</span><span class="dv">30</span><span class="op">,</span></span>
<span id="cb27-25"><a href="#cb27-25" tabindex="-1"></a>    <span class="st">&#39;units&#39;</span><span class="op">:</span> <span class="st">&#39;meters&#39;</span><span class="op">,</span></span>
<span id="cb27-26"><a href="#cb27-26" tabindex="-1"></a>    <span class="st">&#39;kernelType&#39;</span><span class="op">:</span> <span class="st">&#39;square&#39;</span>})<span class="op">;</span></span>
<span id="cb27-27"><a href="#cb27-27" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(waterProcessed<span class="op">,</span> visParams<span class="op">,</span> <span class="st">&#39;Surface Water (Processed)&#39;</span>)</span>
<span id="cb27-28"><a href="#cb27-28" tabindex="-1"></a></span>
<span id="cb27-29"><a href="#cb27-29" tabindex="-1"></a><span class="co">// Exercise</span></span>
<span id="cb27-30"><a href="#cb27-30" tabindex="-1"></a><span class="co">// Replace the HYBAS_ID with the id of your selected basin</span></span>
<span id="cb27-31"><a href="#cb27-31" tabindex="-1"></a><span class="co">// Add an &#39;iterations&#39; parameter with value 2 to </span></span>
<span id="cb27-32"><a href="#cb27-32" tabindex="-1"></a><span class="co">// focalMax and focalMin functions to further process the data</span></span></code></pre></div>
</div>
</div>
<div id="convert-raster-to-vector" class="section level2">
<h2>07. Convert Raster to Vector</h2>
<p>After creating a final raster map, we can vectorize it. The
<code>reduceToVectors</code> function should be used with
<em>countEvery</em> reducer to convert a raster to a vector. This
reducer will connect all linked pixels of the same class into a single
feature and return a feature collection. By default, the connectedness
of a pixel is checked in cardinal directions only. To check the
connectedness of a pixel in the diagonal direction,
<em>eightConnected</em> should be set as <em>true</em>.</p>
<p><a
href="https://code.earthengine.google.com/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3A02-Surface_Water_Mapping%2F07b_Convert_Raster_to_Vector_(complete)"
target="_blank">Open in Code Editor ↗</a></p>
<div class="sourceCode" id="cb28"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb28-1"><a href="#cb28-1" tabindex="-1"></a><span class="kw">var</span> gsw <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(<span class="st">&quot;JRC/GSW1_4/GlobalSurfaceWater&quot;</span>)<span class="op">;</span></span>
<span id="cb28-2"><a href="#cb28-2" tabindex="-1"></a><span class="kw">var</span> hydrobasins <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">&quot;WWF/HydroSHEDS/v1/Basins/hybas_7&quot;</span>)<span class="op">;</span></span>
<span id="cb28-3"><a href="#cb28-3" tabindex="-1"></a><span class="kw">var</span> basin <span class="op">=</span> hydrobasins<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;HYBAS_ID&#39;</span><span class="op">,</span> <span class="dv">4071139640</span>))</span>
<span id="cb28-4"><a href="#cb28-4" tabindex="-1"></a><span class="kw">var</span> geometry <span class="op">=</span> basin<span class="op">.</span><span class="fu">geometry</span>()</span>
<span id="cb28-5"><a href="#cb28-5" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">centerObject</span>(geometry<span class="op">,</span> <span class="dv">10</span>)</span>
<span id="cb28-6"><a href="#cb28-6" tabindex="-1"></a></span>
<span id="cb28-7"><a href="#cb28-7" tabindex="-1"></a><span class="kw">var</span> water <span class="op">=</span> gsw<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;max_extent&#39;</span>)<span class="op">;</span></span>
<span id="cb28-8"><a href="#cb28-8" tabindex="-1"></a></span>
<span id="cb28-9"><a href="#cb28-9" tabindex="-1"></a><span class="kw">var</span> clipped <span class="op">=</span> water<span class="op">.</span><span class="fu">clip</span>(geometry)</span>
<span id="cb28-10"><a href="#cb28-10" tabindex="-1"></a></span>
<span id="cb28-11"><a href="#cb28-11" tabindex="-1"></a><span class="kw">var</span> visParams <span class="op">=</span> {<span class="dt">min</span><span class="op">:</span><span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span><span class="dv">1</span><span class="op">,</span> <span class="dt">palette</span><span class="op">:</span> [<span class="st">&#39;white&#39;</span><span class="op">,</span><span class="st">&#39;blue&#39;</span>]}</span>
<span id="cb28-12"><a href="#cb28-12" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(clipped<span class="op">,</span> visParams<span class="op">,</span> <span class="st">&#39;Surface Water&#39;</span><span class="op">,</span> <span class="kw">false</span>) </span>
<span id="cb28-13"><a href="#cb28-13" tabindex="-1"></a></span>
<span id="cb28-14"><a href="#cb28-14" tabindex="-1"></a><span class="co">// Do unmask() to replace masked pixels with 0</span></span>
<span id="cb28-15"><a href="#cb28-15" tabindex="-1"></a><span class="co">// This avoids extra pixels along the edges</span></span>
<span id="cb28-16"><a href="#cb28-16" tabindex="-1"></a><span class="kw">var</span> clipped <span class="op">=</span> clipped<span class="op">.</span><span class="fu">unmask</span>(<span class="dv">0</span>)</span>
<span id="cb28-17"><a href="#cb28-17" tabindex="-1"></a><span class="co">// Perform a morphological closing to fill holes in waterbodies</span></span>
<span id="cb28-18"><a href="#cb28-18" tabindex="-1"></a><span class="kw">var</span> waterProcessed <span class="op">=</span> clipped</span>
<span id="cb28-19"><a href="#cb28-19" tabindex="-1"></a>  <span class="op">.</span><span class="fu">focal_max</span>({</span>
<span id="cb28-20"><a href="#cb28-20" tabindex="-1"></a>    <span class="st">&#39;radius&#39;</span><span class="op">:</span><span class="dv">30</span><span class="op">,</span></span>
<span id="cb28-21"><a href="#cb28-21" tabindex="-1"></a>    <span class="st">&#39;units&#39;</span><span class="op">:</span> <span class="st">&#39;meters&#39;</span><span class="op">,</span></span>
<span id="cb28-22"><a href="#cb28-22" tabindex="-1"></a>    <span class="st">&#39;kernelType&#39;</span><span class="op">:</span> <span class="st">&#39;square&#39;</span>})</span>
<span id="cb28-23"><a href="#cb28-23" tabindex="-1"></a>  <span class="op">.</span><span class="fu">focal_min</span>({</span>
<span id="cb28-24"><a href="#cb28-24" tabindex="-1"></a>    <span class="st">&#39;radius&#39;</span><span class="op">:</span><span class="dv">30</span><span class="op">,</span></span>
<span id="cb28-25"><a href="#cb28-25" tabindex="-1"></a>    <span class="st">&#39;units&#39;</span><span class="op">:</span> <span class="st">&#39;meters&#39;</span><span class="op">,</span></span>
<span id="cb28-26"><a href="#cb28-26" tabindex="-1"></a>    <span class="st">&#39;kernelType&#39;</span><span class="op">:</span> <span class="st">&#39;square&#39;</span>})<span class="op">;</span></span>
<span id="cb28-27"><a href="#cb28-27" tabindex="-1"></a>    </span>
<span id="cb28-28"><a href="#cb28-28" tabindex="-1"></a></span>
<span id="cb28-29"><a href="#cb28-29" tabindex="-1"></a><span class="kw">var</span> vector <span class="op">=</span> waterProcessed<span class="op">.</span><span class="fu">reduceToVectors</span>({</span>
<span id="cb28-30"><a href="#cb28-30" tabindex="-1"></a>  <span class="dt">reducer</span><span class="op">:</span> ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">countEvery</span>()<span class="op">,</span></span>
<span id="cb28-31"><a href="#cb28-31" tabindex="-1"></a>  <span class="dt">geometry</span><span class="op">:</span> geometry<span class="op">,</span></span>
<span id="cb28-32"><a href="#cb28-32" tabindex="-1"></a>  <span class="dt">scale</span><span class="op">:</span> <span class="dv">30</span><span class="op">,</span></span>
<span id="cb28-33"><a href="#cb28-33" tabindex="-1"></a>  <span class="dt">maxPixels</span><span class="op">:</span> <span class="fl">1e10</span><span class="op">,</span></span>
<span id="cb28-34"><a href="#cb28-34" tabindex="-1"></a>  <span class="dt">eightConnected</span><span class="op">:</span> <span class="kw">false</span></span>
<span id="cb28-35"><a href="#cb28-35" tabindex="-1"></a>})</span>
<span id="cb28-36"><a href="#cb28-36" tabindex="-1"></a><span class="kw">var</span> visParams <span class="op">=</span> {<span class="dt">color</span><span class="op">:</span> <span class="st">&#39;blue&#39;</span>}</span>
<span id="cb28-37"><a href="#cb28-37" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(vector<span class="op">,</span> visParams<span class="op">,</span> <span class="st">&#39;Surface Water Polygons&#39;</span>)  </span></code></pre></div>
<div id="exercise-15" class="section level3">
<h3>Exercise</h3>
<p><a
href="https://code.earthengine.google.com/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3A02-Surface_Water_Mapping%2F07c_Convert_Raster_to_Vector_(exercise)"
target="_blank">Try in Code Editor ↗</a></p>
<p>The final feature collection will contain the class value from the
pixel as the <em>label</em> property. Since the raster is a binary image
with 0 - 1 value, the label with value 1 will represent the water
bodies.</p>
<p>Use the <em>eq</em> filter and filter the water bodies alone.</p>
<div class="sourceCode" id="cb29"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb29-1"><a href="#cb29-1" tabindex="-1"></a><span class="kw">var</span> gsw <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(<span class="st">&quot;JRC/GSW1_4/GlobalSurfaceWater&quot;</span>)<span class="op">;</span></span>
<span id="cb29-2"><a href="#cb29-2" tabindex="-1"></a><span class="kw">var</span> hydrobasins <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">&quot;WWF/HydroSHEDS/v1/Basins/hybas_7&quot;</span>)<span class="op">;</span></span>
<span id="cb29-3"><a href="#cb29-3" tabindex="-1"></a><span class="kw">var</span> basin <span class="op">=</span> hydrobasins<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;HYBAS_ID&#39;</span><span class="op">,</span> <span class="dv">4071139640</span>))</span>
<span id="cb29-4"><a href="#cb29-4" tabindex="-1"></a><span class="kw">var</span> geometry <span class="op">=</span> basin<span class="op">.</span><span class="fu">geometry</span>()</span>
<span id="cb29-5"><a href="#cb29-5" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">centerObject</span>(geometry<span class="op">,</span> <span class="dv">10</span>)</span>
<span id="cb29-6"><a href="#cb29-6" tabindex="-1"></a></span>
<span id="cb29-7"><a href="#cb29-7" tabindex="-1"></a><span class="kw">var</span> water <span class="op">=</span> gsw<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;max_extent&#39;</span>)<span class="op">;</span></span>
<span id="cb29-8"><a href="#cb29-8" tabindex="-1"></a></span>
<span id="cb29-9"><a href="#cb29-9" tabindex="-1"></a><span class="kw">var</span> clipped <span class="op">=</span> water<span class="op">.</span><span class="fu">clip</span>(geometry)</span>
<span id="cb29-10"><a href="#cb29-10" tabindex="-1"></a></span>
<span id="cb29-11"><a href="#cb29-11" tabindex="-1"></a><span class="kw">var</span> visParams <span class="op">=</span> {<span class="dt">min</span><span class="op">:</span><span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span><span class="dv">1</span><span class="op">,</span> <span class="dt">palette</span><span class="op">:</span> [<span class="st">&#39;white&#39;</span><span class="op">,</span><span class="st">&#39;blue&#39;</span>]}</span>
<span id="cb29-12"><a href="#cb29-12" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(clipped<span class="op">,</span> visParams<span class="op">,</span> <span class="st">&#39;Surface Water&#39;</span><span class="op">,</span> <span class="kw">false</span>) </span>
<span id="cb29-13"><a href="#cb29-13" tabindex="-1"></a></span>
<span id="cb29-14"><a href="#cb29-14" tabindex="-1"></a><span class="co">// Do unmask() to replace masked pixels with 0</span></span>
<span id="cb29-15"><a href="#cb29-15" tabindex="-1"></a><span class="co">// This avoids extra pixels along the edges</span></span>
<span id="cb29-16"><a href="#cb29-16" tabindex="-1"></a><span class="kw">var</span> clipped <span class="op">=</span> clipped<span class="op">.</span><span class="fu">unmask</span>(<span class="dv">0</span>)</span>
<span id="cb29-17"><a href="#cb29-17" tabindex="-1"></a><span class="co">// Perform a morphological closing to fill holes in waterbodies</span></span>
<span id="cb29-18"><a href="#cb29-18" tabindex="-1"></a><span class="kw">var</span> waterProcessed <span class="op">=</span> clipped</span>
<span id="cb29-19"><a href="#cb29-19" tabindex="-1"></a>  <span class="op">.</span><span class="fu">focal_max</span>({</span>
<span id="cb29-20"><a href="#cb29-20" tabindex="-1"></a>    <span class="st">&#39;radius&#39;</span><span class="op">:</span><span class="dv">30</span><span class="op">,</span></span>
<span id="cb29-21"><a href="#cb29-21" tabindex="-1"></a>    <span class="st">&#39;units&#39;</span><span class="op">:</span> <span class="st">&#39;meters&#39;</span><span class="op">,</span></span>
<span id="cb29-22"><a href="#cb29-22" tabindex="-1"></a>    <span class="st">&#39;kernelType&#39;</span><span class="op">:</span> <span class="st">&#39;square&#39;</span>})</span>
<span id="cb29-23"><a href="#cb29-23" tabindex="-1"></a>  <span class="op">.</span><span class="fu">focal_min</span>({</span>
<span id="cb29-24"><a href="#cb29-24" tabindex="-1"></a>    <span class="st">&#39;radius&#39;</span><span class="op">:</span><span class="dv">30</span><span class="op">,</span></span>
<span id="cb29-25"><a href="#cb29-25" tabindex="-1"></a>    <span class="st">&#39;units&#39;</span><span class="op">:</span> <span class="st">&#39;meters&#39;</span><span class="op">,</span></span>
<span id="cb29-26"><a href="#cb29-26" tabindex="-1"></a>    <span class="st">&#39;kernelType&#39;</span><span class="op">:</span> <span class="st">&#39;square&#39;</span>})<span class="op">;</span></span>
<span id="cb29-27"><a href="#cb29-27" tabindex="-1"></a>    </span>
<span id="cb29-28"><a href="#cb29-28" tabindex="-1"></a></span>
<span id="cb29-29"><a href="#cb29-29" tabindex="-1"></a><span class="kw">var</span> vector <span class="op">=</span> waterProcessed<span class="op">.</span><span class="fu">reduceToVectors</span>({</span>
<span id="cb29-30"><a href="#cb29-30" tabindex="-1"></a>  <span class="dt">reducer</span><span class="op">:</span> ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">countEvery</span>()<span class="op">,</span></span>
<span id="cb29-31"><a href="#cb29-31" tabindex="-1"></a>  <span class="dt">geometry</span><span class="op">:</span> geometry<span class="op">,</span></span>
<span id="cb29-32"><a href="#cb29-32" tabindex="-1"></a>  <span class="dt">scale</span><span class="op">:</span> <span class="dv">30</span><span class="op">,</span></span>
<span id="cb29-33"><a href="#cb29-33" tabindex="-1"></a>  <span class="dt">maxPixels</span><span class="op">:</span> <span class="fl">1e10</span><span class="op">,</span></span>
<span id="cb29-34"><a href="#cb29-34" tabindex="-1"></a>  <span class="dt">eightConnected</span><span class="op">:</span> <span class="kw">false</span></span>
<span id="cb29-35"><a href="#cb29-35" tabindex="-1"></a>})</span>
<span id="cb29-36"><a href="#cb29-36" tabindex="-1"></a></span>
<span id="cb29-37"><a href="#cb29-37" tabindex="-1"></a><span class="co">// Exercise</span></span>
<span id="cb29-38"><a href="#cb29-38" tabindex="-1"></a><span class="co">// The vector variable is a FeatureCollection</span></span>
<span id="cb29-39"><a href="#cb29-39" tabindex="-1"></a><span class="co">// It contains polygons for both water and non-water areas</span></span>
<span id="cb29-40"><a href="#cb29-40" tabindex="-1"></a><span class="co">// Apply a filter to select only water polygons</span></span>
<span id="cb29-41"><a href="#cb29-41" tabindex="-1"></a><span class="co">// Display the results on the map</span></span>
<span id="cb29-42"><a href="#cb29-42" tabindex="-1"></a><span class="co">// Hint: Use ee.Filter.eq() on the &#39;label&#39; property</span></span>
<span id="cb29-43"><a href="#cb29-43" tabindex="-1"></a></span>
<span id="cb29-44"><a href="#cb29-44" tabindex="-1"></a><span class="kw">var</span> visParams <span class="op">=</span> {<span class="dt">color</span><span class="op">:</span> <span class="st">&#39;blue&#39;</span>}</span></code></pre></div>
</div>
</div>
</div>
<div id="module-3-precipitation-time-series-analysis"
class="section level1">
<h1>Module 3: Precipitation Time Series Analysis</h1>
<p>The main advantage of the gridded precipitation datasets is that they
offer a consistent long-term time-series. We will cover the basics of
gridded rainfall datasets, how to aggregate them to the requirement
temporal resolution, prepare a time-series and perform pixel-wise trend
analysis.</p>
<p>But to fully leverage the computation power of Earth Engine for our
analysis, we must first learn about techniques for writing efficient
parallel computing code. The Earth Engine API uses <a
href="https://en.wikipedia.org/wiki/MapReduce">Map/Reduce</a> paradigm
for parallel computing.</p>
<!-- Map/Reduce Video -->
<p><a
href="https://www.youtube.com/watch?v=frYZf17QyIc&amp;list=PLppGmFLhQ1HI0YeA5zQHxdNlmxihvBawF&amp;index=37"
target="_blank"><img
src="https://img.youtube.com/vi/frYZf17QyIc/mqdefault.jpg"
alt="Start Module 3 Videos" /></a></p>
<p><a
href="https://www.youtube.com/watch?v=frYZf17QyIc&amp;list=PLppGmFLhQ1HI0YeA5zQHxdNlmxihvBawF&amp;index=37"
target="_blank">Start Module 3 Videos ↗</a></p>
<p><a
href="https://docs.google.com/presentation/d/1F_yRyBkItQdpbm-TXOTc4CkMXxynulfKY2p1TG0xS-g/edit?usp=sharing"
target="_blank">View the Presentation ↗</a></p>
<hr />
<!-- Precipitation Time-Series Video -->
<p><a
href="https://www.youtube.com/watch?v=t73sL6DPiiY&amp;list=PLppGmFLhQ1HI0YeA5zQHxdNlmxihvBawF&amp;index=42"
target="_blank"><img
src="https://img.youtube.com/vi/t73sL6DPiiY/mqdefault.jpg"
alt="Watch the video" /></a></p>
<p><a
href="https://www.youtube.com/watch?v=t73sL6DPiiY&amp;list=PLppGmFLhQ1HI0YeA5zQHxdNlmxihvBawF&amp;index=42"
target="_blank">Watch the Video ↗</a></p>
<p><a
href="https://docs.google.com/presentation/d/1G-v9Nz90DGGQ2OfTPxwD5j-HspPcIYUu9UB-nkNnGn4/edit?usp=sharing"
target="_blank">View the Presentation ↗</a></p>
<div id="mapping-a-function" class="section level2">
<h2>01. Mapping a Function</h2>
<p>This script introduces the basics of the Earth Engine API. Here we
map a list of objects over a function to perform a task on all the
objects. While defining a function, it should return a result after
computation, which can be stored in a variable. To learn more, visit the
<a
href="https://developers.google.com/earth-engine/tutorial_js_02">Earth
Engine Objects and Methods</a> section of the Earth Engine User
Guide.</p>
<p>Apart from other regular strings and numbers, the earth engine can
understand dates. Under <code>ee.Date</code> there are many functions by
which dates can be defined or converted from one format to another.</p>
<p><a
href="https://code.earthengine.google.co.in/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3A03-Time_Series_Analysis%2F01b_Mapping_a_Function_(complete)"
target="_blank">Open in Code Editor ↗</a></p>
<div class="sourceCode" id="cb30"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb30-1"><a href="#cb30-1" tabindex="-1"></a><span class="co">// Let&#39;s see how to take a list of numbers and add 1 to each element</span></span>
<span id="cb30-2"><a href="#cb30-2" tabindex="-1"></a><span class="kw">var</span> myList <span class="op">=</span> ee<span class="op">.</span><span class="at">List</span><span class="op">.</span><span class="fu">sequence</span>(<span class="dv">1</span><span class="op">,</span> <span class="dv">10</span>)<span class="op">;</span></span>
<span id="cb30-3"><a href="#cb30-3" tabindex="-1"></a></span>
<span id="cb30-4"><a href="#cb30-4" tabindex="-1"></a><span class="co">// Define a function that takes a number and adds 1 to it</span></span>
<span id="cb30-5"><a href="#cb30-5" tabindex="-1"></a><span class="kw">var</span> myFunction <span class="op">=</span> <span class="kw">function</span>(number) {</span>
<span id="cb30-6"><a href="#cb30-6" tabindex="-1"></a>  <span class="cf">return</span> number <span class="op">+</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb30-7"><a href="#cb30-7" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb30-8"><a href="#cb30-8" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">myFunction</span>(<span class="dv">1</span>))<span class="op">;</span></span>
<span id="cb30-9"><a href="#cb30-9" tabindex="-1"></a></span>
<span id="cb30-10"><a href="#cb30-10" tabindex="-1"></a><span class="co">//Re-Define a function using Earth Engine API</span></span>
<span id="cb30-11"><a href="#cb30-11" tabindex="-1"></a><span class="kw">var</span> myFunction <span class="op">=</span> <span class="kw">function</span>(number) { </span>
<span id="cb30-12"><a href="#cb30-12" tabindex="-1"></a>  <span class="cf">return</span> ee<span class="op">.</span><span class="fu">Number</span>(number)<span class="op">.</span><span class="fu">add</span>(<span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb30-13"><a href="#cb30-13" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb30-14"><a href="#cb30-14" tabindex="-1"></a></span>
<span id="cb30-15"><a href="#cb30-15" tabindex="-1"></a><span class="co">// Map the function of the list</span></span>
<span id="cb30-16"><a href="#cb30-16" tabindex="-1"></a><span class="kw">var</span> newList <span class="op">=</span> myList<span class="op">.</span><span class="fu">map</span>(myFunction)<span class="op">;</span></span>
<span id="cb30-17"><a href="#cb30-17" tabindex="-1"></a><span class="fu">print</span>(newList)<span class="op">;</span> </span>
<span id="cb30-18"><a href="#cb30-18" tabindex="-1"></a></span>
<span id="cb30-19"><a href="#cb30-19" tabindex="-1"></a><span class="co">// Let&#39;s write another function to square a number</span></span>
<span id="cb30-20"><a href="#cb30-20" tabindex="-1"></a><span class="kw">var</span> squareNumber <span class="op">=</span> <span class="kw">function</span>(number) {</span>
<span id="cb30-21"><a href="#cb30-21" tabindex="-1"></a>  <span class="cf">return</span> ee<span class="op">.</span><span class="fu">Number</span>(number)<span class="op">.</span><span class="fu">pow</span>(<span class="dv">2</span>)<span class="op">;</span></span>
<span id="cb30-22"><a href="#cb30-22" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb30-23"><a href="#cb30-23" tabindex="-1"></a><span class="kw">var</span> squares <span class="op">=</span> myList<span class="op">.</span><span class="fu">map</span>(squareNumber)<span class="op">;</span></span>
<span id="cb30-24"><a href="#cb30-24" tabindex="-1"></a><span class="fu">print</span>(squares)<span class="op">;</span></span>
<span id="cb30-25"><a href="#cb30-25" tabindex="-1"></a></span>
<span id="cb30-26"><a href="#cb30-26" tabindex="-1"></a><span class="co">// Extracting value from a list</span></span>
<span id="cb30-27"><a href="#cb30-27" tabindex="-1"></a></span>
<span id="cb30-28"><a href="#cb30-28" tabindex="-1"></a><span class="kw">var</span> value <span class="op">=</span> newList<span class="op">.</span><span class="fu">get</span>(<span class="dv">0</span>)<span class="op">;</span></span>
<span id="cb30-29"><a href="#cb30-29" tabindex="-1"></a><span class="fu">print</span>(value)<span class="op">;</span></span>
<span id="cb30-30"><a href="#cb30-30" tabindex="-1"></a></span>
<span id="cb30-31"><a href="#cb30-31" tabindex="-1"></a><span class="co">// Casting</span></span>
<span id="cb30-32"><a href="#cb30-32" tabindex="-1"></a></span>
<span id="cb30-33"><a href="#cb30-33" tabindex="-1"></a><span class="co">// Let&#39;s try to do some computation on the extracted value</span></span>
<span id="cb30-34"><a href="#cb30-34" tabindex="-1"></a><span class="co">//var newValue = value.add(1)</span></span>
<span id="cb30-35"><a href="#cb30-35" tabindex="-1"></a><span class="co">//print(newValue)</span></span>
<span id="cb30-36"><a href="#cb30-36" tabindex="-1"></a></span>
<span id="cb30-37"><a href="#cb30-37" tabindex="-1"></a><span class="co">// You get an error because Earth Engine doesn&#39;t know what is the type of &#39;value&#39;</span></span>
<span id="cb30-38"><a href="#cb30-38" tabindex="-1"></a><span class="co">// We need to cast it to appropriate type first</span></span>
<span id="cb30-39"><a href="#cb30-39" tabindex="-1"></a><span class="kw">var</span> value <span class="op">=</span> ee<span class="op">.</span><span class="fu">Number</span>(value)<span class="op">;</span></span>
<span id="cb30-40"><a href="#cb30-40" tabindex="-1"></a><span class="kw">var</span> newValue <span class="op">=</span> value<span class="op">.</span><span class="fu">add</span>(<span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb30-41"><a href="#cb30-41" tabindex="-1"></a><span class="fu">print</span>(newValue)<span class="op">;</span></span>
<span id="cb30-42"><a href="#cb30-42" tabindex="-1"></a></span>
<span id="cb30-43"><a href="#cb30-43" tabindex="-1"></a><span class="co">// Dates</span></span>
<span id="cb30-44"><a href="#cb30-44" tabindex="-1"></a><span class="co">// For any date computation, you should use ee.Date module</span></span>
<span id="cb30-45"><a href="#cb30-45" tabindex="-1"></a></span>
<span id="cb30-46"><a href="#cb30-46" tabindex="-1"></a><span class="kw">var</span> date <span class="op">=</span> ee<span class="op">.</span><span class="at">Date</span><span class="op">.</span><span class="fu">fromYMD</span>(<span class="dv">2019</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb30-47"><a href="#cb30-47" tabindex="-1"></a><span class="kw">var</span> futureDate <span class="op">=</span> date<span class="op">.</span><span class="fu">advance</span>(<span class="dv">1</span><span class="op">,</span> <span class="st">&#39;year&#39;</span>)<span class="op">;</span></span>
<span id="cb30-48"><a href="#cb30-48" tabindex="-1"></a><span class="fu">print</span>(futureDate)<span class="op">;</span></span></code></pre></div>
<div id="exercise-16" class="section level3">
<h3>Exercise</h3>
<p><a
href="https://code.earthengine.google.co.in/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3A03-Time_Series_Analysis%2F01c_Mapping_a_Function_(exercise)"
target="_blank">Try in Code Editor ↗</a></p>
<p>Define the function <code>createDate</code>, map the
<code>weeks</code> list as input. The function should return dates
incremented by the week number.</p>
<div class="sourceCode" id="cb31"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb31-1"><a href="#cb31-1" tabindex="-1"></a><span class="kw">var</span> startDate <span class="op">=</span> ee<span class="op">.</span><span class="at">Date</span><span class="op">.</span><span class="fu">fromYMD</span>(<span class="dv">2019</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">1</span>)</span>
<span id="cb31-2"><a href="#cb31-2" tabindex="-1"></a></span>
<span id="cb31-3"><a href="#cb31-3" tabindex="-1"></a><span class="co">// Exercise</span></span>
<span id="cb31-4"><a href="#cb31-4" tabindex="-1"></a><span class="co">// Create a list of dates for start of every week of the year</span></span>
<span id="cb31-5"><a href="#cb31-5" tabindex="-1"></a></span>
<span id="cb31-6"><a href="#cb31-6" tabindex="-1"></a><span class="co">// We first create a list of week numbers </span></span>
<span id="cb31-7"><a href="#cb31-7" tabindex="-1"></a><span class="kw">var</span> weeks <span class="op">=</span> ee<span class="op">.</span><span class="at">List</span><span class="op">.</span><span class="fu">sequence</span>(<span class="dv">0</span><span class="op">,</span> <span class="dv">51</span>)</span>
<span id="cb31-8"><a href="#cb31-8" tabindex="-1"></a></span>
<span id="cb31-9"><a href="#cb31-9" tabindex="-1"></a><span class="co">// Write a function that takes a week number &#39;n&#39;</span></span>
<span id="cb31-10"><a href="#cb31-10" tabindex="-1"></a><span class="co">// and returns a date &#39;n&#39; weeks in advance.</span></span>
<span id="cb31-11"><a href="#cb31-11" tabindex="-1"></a><span class="kw">var</span> createDate <span class="op">=</span> <span class="kw">function</span>(n) {</span>
<span id="cb31-12"><a href="#cb31-12" tabindex="-1"></a>  <span class="co">// Use the .advance() function to find the date &#39;n&#39; weeks from start</span></span>
<span id="cb31-13"><a href="#cb31-13" tabindex="-1"></a>}</span>
<span id="cb31-14"><a href="#cb31-14" tabindex="-1"></a><span class="co">// map() the function on list of weeks</span></span>
<span id="cb31-15"><a href="#cb31-15" tabindex="-1"></a></span>
<span id="cb31-16"><a href="#cb31-16" tabindex="-1"></a><span class="co">// print the result</span></span></code></pre></div>
</div>
</div>
<div id="reducers" class="section level2">
<h2>02. Reducers</h2>
<p>A <em>Reduce</em> operation allows you to compute statistics on a
large amount of inputs. In Earth Engine, you need to run reduction
operation when creating composites, calculating statistics, doing
regression analysis etc. The Earth Engine API comes with a large number
of built-in reducer functions (such as <code>ee.Reducer.sum()</code>,
<code>ee.Reducer.histogram()</code>, <code>ee.Reducer.linearFit()</code>
etc.) that can perform a variety of statistical operations on input
data. You can run reducers using the <code>reduce()</code> function.
Earth Engine supports running reducers on all data structures that can
hold multiple values, such as Images (reducers run on different bands),
ImageCollection, FeatureCollection, List, Dictionary etc. The script
below introduces basic concepts related to reducers.</p>
<p><a
href="https://code.earthengine.google.co.in/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3A03-Time_Series_Analysis%2F02b_Reducers_(complete)"
target="_blank">Open in Code Editor ↗</a></p>
<div class="sourceCode" id="cb32"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb32-1"><a href="#cb32-1" tabindex="-1"></a><span class="co">// Computing stats on a list</span></span>
<span id="cb32-2"><a href="#cb32-2" tabindex="-1"></a><span class="kw">var</span> myList <span class="op">=</span> ee<span class="op">.</span><span class="at">List</span><span class="op">.</span><span class="fu">sequence</span>(<span class="dv">1</span><span class="op">,</span> <span class="dv">10</span>)<span class="op">;</span></span>
<span id="cb32-3"><a href="#cb32-3" tabindex="-1"></a><span class="fu">print</span>(myList)<span class="op">;</span></span>
<span id="cb32-4"><a href="#cb32-4" tabindex="-1"></a></span>
<span id="cb32-5"><a href="#cb32-5" tabindex="-1"></a><span class="co">// Use a reducer to compute min and max in the list</span></span>
<span id="cb32-6"><a href="#cb32-6" tabindex="-1"></a><span class="kw">var</span> mean <span class="op">=</span> myList<span class="op">.</span><span class="fu">reduce</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">mean</span>())<span class="op">;</span></span>
<span id="cb32-7"><a href="#cb32-7" tabindex="-1"></a><span class="fu">print</span>(mean)<span class="op">;</span></span>
<span id="cb32-8"><a href="#cb32-8" tabindex="-1"></a></span>
<span id="cb32-9"><a href="#cb32-9" tabindex="-1"></a><span class="kw">var</span> geometry <span class="op">=</span> ee<span class="op">.</span><span class="at">Geometry</span><span class="op">.</span><span class="fu">Polygon</span>([[</span>
<span id="cb32-10"><a href="#cb32-10" tabindex="-1"></a>  [<span class="fl">82.60642647743225</span><span class="op">,</span> <span class="fl">27.16350437805251</span>]<span class="op">,</span></span>
<span id="cb32-11"><a href="#cb32-11" tabindex="-1"></a>  [<span class="fl">82.60984897613525</span><span class="op">,</span> <span class="fl">27.1618529901377</span>]<span class="op">,</span></span>
<span id="cb32-12"><a href="#cb32-12" tabindex="-1"></a>  [<span class="fl">82.61088967323303</span><span class="op">,</span> <span class="fl">27.163695288375266</span>]<span class="op">,</span></span>
<span id="cb32-13"><a href="#cb32-13" tabindex="-1"></a>  [<span class="fl">82.60757446289062</span><span class="op">,</span> <span class="fl">27.16517483230927</span>]</span>
<span id="cb32-14"><a href="#cb32-14" tabindex="-1"></a>]])<span class="op">;</span></span>
<span id="cb32-15"><a href="#cb32-15" tabindex="-1"></a><span class="kw">var</span> s2 <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&quot;COPERNICUS/S2_HARMONIZED&quot;</span>)<span class="op">;</span></span>
<span id="cb32-16"><a href="#cb32-16" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">centerObject</span>(geometry)<span class="op">;</span></span>
<span id="cb32-17"><a href="#cb32-17" tabindex="-1"></a></span>
<span id="cb32-18"><a href="#cb32-18" tabindex="-1"></a><span class="co">// Apply a reducer on a image collection</span></span>
<span id="cb32-19"><a href="#cb32-19" tabindex="-1"></a><span class="kw">var</span> filtered <span class="op">=</span> s2<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">lt</span>(<span class="st">&#39;CLOUDY_PIXEL_PERCENTAGE&#39;</span><span class="op">,</span> <span class="dv">30</span>))</span>
<span id="cb32-20"><a href="#cb32-20" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(<span class="st">&#39;2019-01-01&#39;</span><span class="op">,</span> <span class="st">&#39;2020-01-01&#39;</span>))</span>
<span id="cb32-21"><a href="#cb32-21" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">bounds</span>(geometry))</span>
<span id="cb32-22"><a href="#cb32-22" tabindex="-1"></a>  <span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;B.*&#39;</span>)<span class="op">;</span></span>
<span id="cb32-23"><a href="#cb32-23" tabindex="-1"></a></span>
<span id="cb32-24"><a href="#cb32-24" tabindex="-1"></a><span class="fu">print</span>(filtered<span class="op">.</span><span class="fu">size</span>())<span class="op">;</span></span>
<span id="cb32-25"><a href="#cb32-25" tabindex="-1"></a><span class="kw">var</span> collMean <span class="op">=</span> filtered<span class="op">.</span><span class="fu">reduce</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">mean</span>())<span class="op">;</span></span>
<span id="cb32-26"><a href="#cb32-26" tabindex="-1"></a><span class="fu">print</span>(<span class="st">&#39;Reducer on Collection&#39;</span><span class="op">,</span> collMean)<span class="op">;</span></span>
<span id="cb32-27"><a href="#cb32-27" tabindex="-1"></a></span>
<span id="cb32-28"><a href="#cb32-28" tabindex="-1"></a><span class="kw">var</span> image <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(<span class="st">&#39;COPERNICUS/S2_HARMONIZED/20190223T050811_20190223T051829_T44RPR&#39;</span>)<span class="op">;</span></span>
<span id="cb32-29"><a href="#cb32-29" tabindex="-1"></a><span class="kw">var</span> rgbVis <span class="op">=</span> {<span class="dt">min</span><span class="op">:</span> <span class="fl">0.0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span> <span class="dv">3000</span><span class="op">,</span> <span class="dt">bands</span><span class="op">:</span> [<span class="st">&#39;B4&#39;</span><span class="op">,</span> <span class="st">&#39;B3&#39;</span><span class="op">,</span> <span class="st">&#39;B2&#39;</span>]}<span class="op">;</span></span>
<span id="cb32-30"><a href="#cb32-30" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(image<span class="op">,</span> rgbVis<span class="op">,</span> <span class="st">&#39;Image&#39;</span>)<span class="op">;</span></span>
<span id="cb32-31"><a href="#cb32-31" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(geometry<span class="op">,</span> {<span class="dt">color</span><span class="op">:</span> <span class="st">&#39;red&#39;</span>}<span class="op">,</span> <span class="st">&#39;Farm&#39;</span>)<span class="op">;</span></span>
<span id="cb32-32"><a href="#cb32-32" tabindex="-1"></a><span class="co">// If we want to compute the average value in each band,</span></span>
<span id="cb32-33"><a href="#cb32-33" tabindex="-1"></a><span class="co">// we can use reduceRegion instead</span></span>
<span id="cb32-34"><a href="#cb32-34" tabindex="-1"></a><span class="kw">var</span> stats <span class="op">=</span> image<span class="op">.</span><span class="fu">reduceRegion</span>({</span>
<span id="cb32-35"><a href="#cb32-35" tabindex="-1"></a>  <span class="dt">reducer</span><span class="op">:</span> ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">mean</span>()<span class="op">,</span></span>
<span id="cb32-36"><a href="#cb32-36" tabindex="-1"></a>  <span class="dt">geometry</span><span class="op">:</span> geometry<span class="op">,</span></span>
<span id="cb32-37"><a href="#cb32-37" tabindex="-1"></a>  <span class="dt">scale</span><span class="op">:</span> <span class="dv">100</span><span class="op">,</span></span>
<span id="cb32-38"><a href="#cb32-38" tabindex="-1"></a>  <span class="dt">maxPixels</span><span class="op">:</span> <span class="fl">1e10</span></span>
<span id="cb32-39"><a href="#cb32-39" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb32-40"><a href="#cb32-40" tabindex="-1"></a><span class="fu">print</span>(stats)<span class="op">;</span></span>
<span id="cb32-41"><a href="#cb32-41" tabindex="-1"></a></span>
<span id="cb32-42"><a href="#cb32-42" tabindex="-1"></a><span class="co">// Result of reduceRegion is a dictionary. </span></span>
<span id="cb32-43"><a href="#cb32-43" tabindex="-1"></a><span class="co">// We can extract the values using .get() function</span></span>
<span id="cb32-44"><a href="#cb32-44" tabindex="-1"></a><span class="fu">print</span>(<span class="st">&#39;Average value in B4&#39;</span><span class="op">,</span> stats<span class="op">.</span><span class="fu">get</span>(<span class="st">&#39;B4&#39;</span>))<span class="op">;</span></span></code></pre></div>
<div id="exercise-17" class="section level3">
<h3>Exercise</h3>
<p><a
href="https://code.earthengine.google.co.in/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3A03-Time_Series_Analysis%2F02c_Reducers_(exercise)"
target="_blank">Try in Code Editor ↗</a></p>
<div class="sourceCode" id="cb33"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb33-1"><a href="#cb33-1" tabindex="-1"></a><span class="kw">var</span> geometry <span class="op">=</span> ee<span class="op">.</span><span class="at">Geometry</span><span class="op">.</span><span class="fu">Polygon</span>([[</span>
<span id="cb33-2"><a href="#cb33-2" tabindex="-1"></a>  [<span class="fl">82.60642647743225</span><span class="op">,</span> <span class="fl">27.16350437805251</span>]<span class="op">,</span></span>
<span id="cb33-3"><a href="#cb33-3" tabindex="-1"></a>  [<span class="fl">82.60984897613525</span><span class="op">,</span> <span class="fl">27.1618529901377</span>]<span class="op">,</span></span>
<span id="cb33-4"><a href="#cb33-4" tabindex="-1"></a>  [<span class="fl">82.61088967323303</span><span class="op">,</span> <span class="fl">27.163695288375266</span>]<span class="op">,</span></span>
<span id="cb33-5"><a href="#cb33-5" tabindex="-1"></a>  [<span class="fl">82.60757446289062</span><span class="op">,</span> <span class="fl">27.16517483230927</span>]</span>
<span id="cb33-6"><a href="#cb33-6" tabindex="-1"></a>]])<span class="op">;</span></span>
<span id="cb33-7"><a href="#cb33-7" tabindex="-1"></a>          </span>
<span id="cb33-8"><a href="#cb33-8" tabindex="-1"></a><span class="kw">var</span> rgbVis <span class="op">=</span> {<span class="dt">min</span><span class="op">:</span> <span class="fl">0.0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span> <span class="dv">3000</span><span class="op">,</span> <span class="dt">bands</span><span class="op">:</span> [<span class="st">&#39;B4&#39;</span><span class="op">,</span> <span class="st">&#39;B3&#39;</span><span class="op">,</span> <span class="st">&#39;B2&#39;</span>]}<span class="op">;</span></span>
<span id="cb33-9"><a href="#cb33-9" tabindex="-1"></a><span class="kw">var</span> image <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(<span class="st">&#39;COPERNICUS/S2_HARMONIZED/20190223T050811_20190223T051829_T44RPR&#39;</span>)</span>
<span id="cb33-10"><a href="#cb33-10" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(image<span class="op">,</span> rgbVis<span class="op">,</span> <span class="st">&#39;Image&#39;</span>)</span>
<span id="cb33-11"><a href="#cb33-11" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(geometry<span class="op">,</span> {<span class="dt">color</span><span class="op">:</span> <span class="st">&#39;red&#39;</span>}<span class="op">,</span> <span class="st">&#39;Farm&#39;</span>)</span>
<span id="cb33-12"><a href="#cb33-12" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">centerObject</span>(geometry)</span>
<span id="cb33-13"><a href="#cb33-13" tabindex="-1"></a></span>
<span id="cb33-14"><a href="#cb33-14" tabindex="-1"></a><span class="kw">var</span> ndvi <span class="op">=</span> image<span class="op">.</span><span class="fu">normalizedDifference</span>([<span class="st">&#39;B8&#39;</span><span class="op">,</span> <span class="st">&#39;B4&#39;</span>])<span class="op">.</span><span class="fu">rename</span>(<span class="st">&#39;ndvi&#39;</span>)<span class="op">;</span></span>
<span id="cb33-15"><a href="#cb33-15" tabindex="-1"></a></span>
<span id="cb33-16"><a href="#cb33-16" tabindex="-1"></a><span class="co">// Exercise</span></span>
<span id="cb33-17"><a href="#cb33-17" tabindex="-1"></a><span class="co">// Compute the average NDVI for the farm from the given image</span></span>
<span id="cb33-18"><a href="#cb33-18" tabindex="-1"></a><span class="co">// Hint: Use the reduceRegion() function</span></span></code></pre></div>
</div>
</div>
<div id="calculating-total-rainfall" class="section level2">
<h2>03. Calculating Total Rainfall</h2>
<p>The CHIRPS Pentad is 5 days composite of rainfall at ~6 km spatial
resolution. To compute this data, both satellite and grounds values are
considered. To read more about the methodology, visit <a
href="https://www.nature.com/articles/sdata201566">nature.com</a></p>
<p>Using this image collection, lets filter all the images for 2017. To
get a yearly rainfall we can reduce the collection using
<code>reduce</code> function with <em>sum</em> reducer. This will return
a single global image where each pixel represent the total annual
rainfall value in <em>mm</em> at that location. Now to get a annual
average rainfall at a particular region of interest, we can do a
<code>reduceRegions</code> with a <em>mean</em> reducer over the region.
This reducer will reduce the region’s image and return a dictionary. The
dictionary will contain the average value of all the bands in the image,
which can be extracted using the <em>get</em> function.</p>
<p><a
href="https://code.earthengine.google.co.in/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3A03-Time_Series_Analysis%2F03b_Calculating_Total_Rainfall_(complete)"
target="_blank">Open in Code Editor ↗</a></p>
<div class="sourceCode" id="cb34"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb34-1"><a href="#cb34-1" tabindex="-1"></a></span>
<span id="cb34-2"><a href="#cb34-2" tabindex="-1"></a><span class="kw">var</span> geometry <span class="op">=</span> ee<span class="op">.</span><span class="at">Geometry</span><span class="op">.</span><span class="fu">Polygon</span>([[[<span class="fl">77.4383382656616</span><span class="op">,</span> <span class="fl">13.049764921558324</span>]<span class="op">,</span></span>
<span id="cb34-3"><a href="#cb34-3" tabindex="-1"></a>          [<span class="fl">77.4383382656616</span><span class="op">,</span> <span class="fl">12.814196240882762</span>]<span class="op">,</span></span>
<span id="cb34-4"><a href="#cb34-4" tabindex="-1"></a>          [<span class="fl">77.72123621488035</span><span class="op">,</span> <span class="fl">12.814196240882762</span>]<span class="op">,</span></span>
<span id="cb34-5"><a href="#cb34-5" tabindex="-1"></a>          [<span class="fl">77.72123621488035</span><span class="op">,</span> <span class="fl">13.049764921558324</span>]]])</span>
<span id="cb34-6"><a href="#cb34-6" tabindex="-1"></a></span>
<span id="cb34-7"><a href="#cb34-7" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(geometry<span class="op">,</span> {}<span class="op">,</span> <span class="st">&#39;ROI&#39;</span>)</span>
<span id="cb34-8"><a href="#cb34-8" tabindex="-1"></a></span>
<span id="cb34-9"><a href="#cb34-9" tabindex="-1"></a><span class="kw">var</span> chirps <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&quot;UCSB-CHG/CHIRPS/PENTAD&quot;</span>)</span>
<span id="cb34-10"><a href="#cb34-10" tabindex="-1"></a></span>
<span id="cb34-11"><a href="#cb34-11" tabindex="-1"></a><span class="kw">var</span> startDate <span class="op">=</span> ee<span class="op">.</span><span class="at">Date</span><span class="op">.</span><span class="fu">fromYMD</span>(<span class="dv">2017</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span><span class="dv">1</span>)</span>
<span id="cb34-12"><a href="#cb34-12" tabindex="-1"></a><span class="kw">var</span> endDate <span class="op">=</span> startDate<span class="op">.</span><span class="fu">advance</span>(<span class="dv">1</span><span class="op">,</span> <span class="st">&#39;year&#39;</span>)</span>
<span id="cb34-13"><a href="#cb34-13" tabindex="-1"></a><span class="kw">var</span> filtered <span class="op">=</span> chirps</span>
<span id="cb34-14"><a href="#cb34-14" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(startDate<span class="op">,</span> endDate))</span>
<span id="cb34-15"><a href="#cb34-15" tabindex="-1"></a></span>
<span id="cb34-16"><a href="#cb34-16" tabindex="-1"></a><span class="co">// Calculate yearly rainfall</span></span>
<span id="cb34-17"><a href="#cb34-17" tabindex="-1"></a><span class="kw">var</span> total <span class="op">=</span> filtered<span class="op">.</span><span class="fu">reduce</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">sum</span>())</span>
<span id="cb34-18"><a href="#cb34-18" tabindex="-1"></a></span>
<span id="cb34-19"><a href="#cb34-19" tabindex="-1"></a><span class="kw">var</span> palette <span class="op">=</span> [<span class="st">&#39;#ffffcc&#39;</span><span class="op">,</span><span class="st">&#39;#a1dab4&#39;</span><span class="op">,</span><span class="st">&#39;#41b6c4&#39;</span><span class="op">,</span><span class="st">&#39;#2c7fb8&#39;</span><span class="op">,</span><span class="st">&#39;#253494&#39;</span>]</span>
<span id="cb34-20"><a href="#cb34-20" tabindex="-1"></a><span class="kw">var</span> visParams <span class="op">=</span> {</span>
<span id="cb34-21"><a href="#cb34-21" tabindex="-1"></a>  <span class="dt">min</span><span class="op">:</span><span class="dv">0</span><span class="op">,</span></span>
<span id="cb34-22"><a href="#cb34-22" tabindex="-1"></a>  <span class="dt">max</span><span class="op">:</span> <span class="dv">2000</span><span class="op">,</span></span>
<span id="cb34-23"><a href="#cb34-23" tabindex="-1"></a>  <span class="dt">palette</span><span class="op">:</span> palette</span>
<span id="cb34-24"><a href="#cb34-24" tabindex="-1"></a>}</span>
<span id="cb34-25"><a href="#cb34-25" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(total<span class="op">,</span> visParams<span class="op">,</span> <span class="st">&#39;Total Precipitation&#39;</span>)</span>
<span id="cb34-26"><a href="#cb34-26" tabindex="-1"></a></span>
<span id="cb34-27"><a href="#cb34-27" tabindex="-1"></a></span>
<span id="cb34-28"><a href="#cb34-28" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">centerObject</span>(geometry<span class="op">,</span> <span class="dv">10</span>)</span>
<span id="cb34-29"><a href="#cb34-29" tabindex="-1"></a></span>
<span id="cb34-30"><a href="#cb34-30" tabindex="-1"></a><span class="co">// Calculate average rainfall across a region</span></span>
<span id="cb34-31"><a href="#cb34-31" tabindex="-1"></a><span class="kw">var</span> stats <span class="op">=</span> total<span class="op">.</span><span class="fu">reduceRegion</span>({</span>
<span id="cb34-32"><a href="#cb34-32" tabindex="-1"></a>  <span class="dt">reducer</span><span class="op">:</span> ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">mean</span>()<span class="op">,</span></span>
<span id="cb34-33"><a href="#cb34-33" tabindex="-1"></a>  <span class="dt">geometry</span><span class="op">:</span> geometry<span class="op">,</span></span>
<span id="cb34-34"><a href="#cb34-34" tabindex="-1"></a>  <span class="dt">scale</span><span class="op">:</span> <span class="dv">5000</span><span class="op">,</span></span>
<span id="cb34-35"><a href="#cb34-35" tabindex="-1"></a>  })</span>
<span id="cb34-36"><a href="#cb34-36" tabindex="-1"></a><span class="fu">print</span>(stats)</span>
<span id="cb34-37"><a href="#cb34-37" tabindex="-1"></a><span class="fu">print</span>(<span class="st">&#39;Average rainfall across ROI :&#39;</span><span class="op">,</span> stats<span class="op">.</span><span class="fu">get</span>(<span class="st">&#39;precipitation_sum&#39;</span>))</span></code></pre></div>
<p>Output</p>
<pre><code>Average rainfall across ROI :
1345.867775034789</code></pre>
<div id="exercise-18" class="section level3">
<h3>Exercise</h3>
<p><a
href="https://code.earthengine.google.co.in/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3A03-Time_Series_Analysis%2F03c_Calculating_Total_Rainfall_(exercise)"
target="_blank">Try in Code Editor ↗</a></p>
<p>Update the date rage for monsoon season(1 June - 30 September) in
India.</p>
<div class="sourceCode" id="cb36"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb36-1"><a href="#cb36-1" tabindex="-1"></a><span class="co">// Update the script to calculate total rainfall for the monsoon season</span></span>
<span id="cb36-2"><a href="#cb36-2" tabindex="-1"></a><span class="co">// Monsoon season in India is from 1 June - 30 September</span></span></code></pre></div>
</div>
</div>
<div id="aggregating-time-series" class="section level2">
<h2>04. Aggregating Time Series</h2>
<p>In the previous exercise, we aggregated to get the average rainfall
across a region. Let’s compute a time series representing the total
rainfall of each month in 2019.</p>
<p>Earth Engine has a function called <code>ee.Date.fromYMD</code> to
create a date from <em>Year</em>, <em>Month</em>, and <em>Date</em>.
Using this function and <code>.advance()</code>, we can create the
filter date to filter the image collection to a particular month. Then
with <code>reduce</code> function with <em>sum</em> as reducer, the
monthly image collection is aggregated to the monthly total image. This
newly created image won’t have any properties. Hence using the
<code>.set()</code> function, we have to assign the <em>Year</em>,
<em>Month</em>, <em>system:time_start</em>, and <em>system:time_end</em>
properties. With the above procedure in the sequence, we can create a
function to input the month’s number and return the monthly total
precipitation image.</p>
<p>We can create the month’s list using <code>ee.List.sequence</code>
and map it to the function built. Since the mapped object is of type
List, the resultant will also be a list with 12 images. This list of
images can be converted back as Image Collection using
<code>ee.ImageCollection.fromYMD</code>. Once we have the collection
print, it will contain 12 images representing the month’s total
precipitation.</p>
<blockquote>
<p>The <em>system:time_start</em> is a unique property that the earth
engine can natively understand. It is the <a
href="https://en.wikipedia.org/wiki/Unix_time">Unix Timestamp</a> that
is used to create a time series chart.</p>
</blockquote>
<p><a
href="https://code.earthengine.google.co.in/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3A03-Time_Series_Analysis%2F04b_Aggregating_Time_Series_(complete)"
target="_blank">Open in Code Editor ↗</a></p>
<div class="sourceCode" id="cb37"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb37-1"><a href="#cb37-1" tabindex="-1"></a><span class="kw">var</span> chirps <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&quot;UCSB-CHG/CHIRPS/PENTAD&quot;</span>)</span>
<span id="cb37-2"><a href="#cb37-2" tabindex="-1"></a></span>
<span id="cb37-3"><a href="#cb37-3" tabindex="-1"></a></span>
<span id="cb37-4"><a href="#cb37-4" tabindex="-1"></a><span class="kw">var</span> year <span class="op">=</span> <span class="dv">2019</span></span>
<span id="cb37-5"><a href="#cb37-5" tabindex="-1"></a><span class="kw">var</span> startDate <span class="op">=</span> ee<span class="op">.</span><span class="at">Date</span><span class="op">.</span><span class="fu">fromYMD</span>(year<span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">1</span>)</span>
<span id="cb37-6"><a href="#cb37-6" tabindex="-1"></a><span class="kw">var</span> endDate <span class="op">=</span> startDate<span class="op">.</span><span class="fu">advance</span>(<span class="dv">1</span><span class="op">,</span> <span class="st">&#39;year&#39;</span>)</span>
<span id="cb37-7"><a href="#cb37-7" tabindex="-1"></a><span class="kw">var</span> yearFiltered <span class="op">=</span> chirps</span>
<span id="cb37-8"><a href="#cb37-8" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(startDate<span class="op">,</span> endDate))</span>
<span id="cb37-9"><a href="#cb37-9" tabindex="-1"></a><span class="co">// CHIRPS collection has 1 image for every pentad (5-days)</span></span>
<span id="cb37-10"><a href="#cb37-10" tabindex="-1"></a><span class="co">// The collection is filtered for 1 year and the time-series</span></span>
<span id="cb37-11"><a href="#cb37-11" tabindex="-1"></a><span class="co">// now has 72 images</span></span>
<span id="cb37-12"><a href="#cb37-12" tabindex="-1"></a><span class="fu">print</span>(yearFiltered)</span>
<span id="cb37-13"><a href="#cb37-13" tabindex="-1"></a></span>
<span id="cb37-14"><a href="#cb37-14" tabindex="-1"></a><span class="co">// We need to aggregate this time series to compute</span></span>
<span id="cb37-15"><a href="#cb37-15" tabindex="-1"></a><span class="co">// monthly images</span></span>
<span id="cb37-16"><a href="#cb37-16" tabindex="-1"></a></span>
<span id="cb37-17"><a href="#cb37-17" tabindex="-1"></a><span class="co">// Create a list of months</span></span>
<span id="cb37-18"><a href="#cb37-18" tabindex="-1"></a><span class="kw">var</span> months <span class="op">=</span> ee<span class="op">.</span><span class="at">List</span><span class="op">.</span><span class="fu">sequence</span>(<span class="dv">1</span><span class="op">,</span> <span class="dv">12</span>)</span>
<span id="cb37-19"><a href="#cb37-19" tabindex="-1"></a></span>
<span id="cb37-20"><a href="#cb37-20" tabindex="-1"></a><span class="co">// Write a function that takes a month number</span></span>
<span id="cb37-21"><a href="#cb37-21" tabindex="-1"></a><span class="co">// and returns a monthly image</span></span>
<span id="cb37-22"><a href="#cb37-22" tabindex="-1"></a><span class="kw">var</span> createMonthlyImage <span class="op">=</span> <span class="kw">function</span>(month) {</span>
<span id="cb37-23"><a href="#cb37-23" tabindex="-1"></a>  <span class="kw">var</span> startDate <span class="op">=</span> ee<span class="op">.</span><span class="at">Date</span><span class="op">.</span><span class="fu">fromYMD</span>(year<span class="op">,</span> month<span class="op">,</span> <span class="dv">1</span>)</span>
<span id="cb37-24"><a href="#cb37-24" tabindex="-1"></a>  <span class="kw">var</span> endDate <span class="op">=</span> startDate<span class="op">.</span><span class="fu">advance</span>(<span class="dv">1</span><span class="op">,</span> <span class="st">&#39;month&#39;</span>)</span>
<span id="cb37-25"><a href="#cb37-25" tabindex="-1"></a>  <span class="kw">var</span> monthFiltered <span class="op">=</span> yearFiltered</span>
<span id="cb37-26"><a href="#cb37-26" tabindex="-1"></a>    <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(startDate<span class="op">,</span> endDate))</span>
<span id="cb37-27"><a href="#cb37-27" tabindex="-1"></a>  <span class="co">// Calculate total precipitation</span></span>
<span id="cb37-28"><a href="#cb37-28" tabindex="-1"></a>  <span class="kw">var</span> total <span class="op">=</span> monthFiltered<span class="op">.</span><span class="fu">reduce</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">sum</span>())</span>
<span id="cb37-29"><a href="#cb37-29" tabindex="-1"></a>  <span class="cf">return</span> total<span class="op">.</span><span class="fu">set</span>({</span>
<span id="cb37-30"><a href="#cb37-30" tabindex="-1"></a>    <span class="st">&#39;system:time_start&#39;</span><span class="op">:</span> startDate<span class="op">.</span><span class="fu">millis</span>()<span class="op">,</span></span>
<span id="cb37-31"><a href="#cb37-31" tabindex="-1"></a>    <span class="st">&#39;system:time_end&#39;</span><span class="op">:</span> endDate<span class="op">.</span><span class="fu">millis</span>()<span class="op">,</span></span>
<span id="cb37-32"><a href="#cb37-32" tabindex="-1"></a>    <span class="st">&#39;year&#39;</span><span class="op">:</span> year<span class="op">,</span></span>
<span id="cb37-33"><a href="#cb37-33" tabindex="-1"></a>    <span class="st">&#39;month&#39;</span><span class="op">:</span> month})</span>
<span id="cb37-34"><a href="#cb37-34" tabindex="-1"></a>}</span>
<span id="cb37-35"><a href="#cb37-35" tabindex="-1"></a></span>
<span id="cb37-36"><a href="#cb37-36" tabindex="-1"></a><span class="co">// map() the function on the list  of months</span></span>
<span id="cb37-37"><a href="#cb37-37" tabindex="-1"></a><span class="co">// This creates a list with images for each month in the list</span></span>
<span id="cb37-38"><a href="#cb37-38" tabindex="-1"></a><span class="kw">var</span> monthlyImages <span class="op">=</span> months<span class="op">.</span><span class="fu">map</span>(createMonthlyImage)</span>
<span id="cb37-39"><a href="#cb37-39" tabindex="-1"></a><span class="co">// Create an imagecollection</span></span>
<span id="cb37-40"><a href="#cb37-40" tabindex="-1"></a><span class="kw">var</span> monthlyCollection <span class="op">=</span> ee<span class="op">.</span><span class="at">ImageCollection</span><span class="op">.</span><span class="fu">fromImages</span>(monthlyImages)</span>
<span id="cb37-41"><a href="#cb37-41" tabindex="-1"></a><span class="fu">print</span>(<span class="st">&#39;Monthly Collection&#39;</span><span class="op">,</span> monthlyCollection)</span></code></pre></div>
<div id="exercise-19" class="section level3">
<h3>Exercise</h3>
<p><a
href="https://code.earthengine.google.co.in/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3A03-Time_Series_Analysis%2F04c_Aggregating_Time_Series_(exercise)"
target="_blank">Try in Code Editor ↗</a></p>
<p>Filter the <code>monthlyCollection</code> for the months June, July,
August and September.</p>
<div class="sourceCode" id="cb38"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb38-1"><a href="#cb38-1" tabindex="-1"></a><span class="co">// Apply a filter to select images for the months</span></span>
<span id="cb38-2"><a href="#cb38-2" tabindex="-1"></a><span class="co">// June, July, August and September</span></span>
<span id="cb38-3"><a href="#cb38-3" tabindex="-1"></a><span class="co">// Print the collection to verify</span></span></code></pre></div>
</div>
</div>
<div id="charting-monthly-rainfall" class="section level2">
<h2>05. Charting Monthly Rainfall</h2>
<p>Now we can put together all the skills we have learned so far -
filter, map, and reduce to create a chart of monthly total rainfall in
the year 2019 over a region. Earth Engine API supports charting
functions based on the Google Chart API. There are various charts to
use, from which we use the <code>ui.Chart.image.series()</code> function
to create a time-series chart.</p>
<p>Image series chart accepts an <em>image collection</em>,
<em>geometry</em>, <em>scale</em>, and <em>reducer</em>. The geometry in
the region of interest, reducer in the reduction operation the region of
interest should be aggregated if the geometry is a polygon. Scale is the
resolution at which the image should be reduced. Using
<code>.setOptions</code>, we can customize the chart to our needs.</p>
<p>Charting itself is vast, and all function are self explanatory.
Google Earth Engine documentation provides all types of <a
href="https://developers.google.com/earth-engine/guides/charts_overview.">charting
examples</a></p>
<p><a
href="https://code.earthengine.google.co.in/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3A03-Time_Series_Analysis%2F05b_Charting_Monthly_Rainfall_(complete)"
target="_blank">Open in Code Editor ↗</a></p>
<div class="sourceCode" id="cb39"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb39-1"><a href="#cb39-1" tabindex="-1"></a><span class="kw">var</span> geometry <span class="op">=</span> ee<span class="op">.</span><span class="at">Geometry</span><span class="op">.</span><span class="fu">Point</span>([<span class="fl">77.58253382230242</span><span class="op">,</span> <span class="fl">12.942038375108362</span>])<span class="op">;</span></span>
<span id="cb39-2"><a href="#cb39-2" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(geometry<span class="op">,</span> {}<span class="op">,</span> <span class="st">&#39;POI&#39;</span>)</span>
<span id="cb39-3"><a href="#cb39-3" tabindex="-1"></a></span>
<span id="cb39-4"><a href="#cb39-4" tabindex="-1"></a><span class="kw">var</span> chirps <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&quot;UCSB-CHG/CHIRPS/PENTAD&quot;</span>)</span>
<span id="cb39-5"><a href="#cb39-5" tabindex="-1"></a></span>
<span id="cb39-6"><a href="#cb39-6" tabindex="-1"></a><span class="kw">var</span> year <span class="op">=</span> <span class="dv">2019</span></span>
<span id="cb39-7"><a href="#cb39-7" tabindex="-1"></a><span class="kw">var</span> startDate <span class="op">=</span> ee<span class="op">.</span><span class="at">Date</span><span class="op">.</span><span class="fu">fromYMD</span>(year<span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">1</span>)</span>
<span id="cb39-8"><a href="#cb39-8" tabindex="-1"></a><span class="kw">var</span> endDate <span class="op">=</span> startDate<span class="op">.</span><span class="fu">advance</span>(<span class="dv">1</span><span class="op">,</span> <span class="st">&#39;year&#39;</span>)</span>
<span id="cb39-9"><a href="#cb39-9" tabindex="-1"></a><span class="kw">var</span> yearFiltered <span class="op">=</span> chirps</span>
<span id="cb39-10"><a href="#cb39-10" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(startDate<span class="op">,</span> endDate))</span>
<span id="cb39-11"><a href="#cb39-11" tabindex="-1"></a><span class="co">// CHIRPS collection has 1 image for every pentad (5-days)</span></span>
<span id="cb39-12"><a href="#cb39-12" tabindex="-1"></a><span class="co">// The collection is filtered for 1 year and the time-series</span></span>
<span id="cb39-13"><a href="#cb39-13" tabindex="-1"></a><span class="co">// now has 72 images</span></span>
<span id="cb39-14"><a href="#cb39-14" tabindex="-1"></a><span class="fu">print</span>(yearFiltered)</span>
<span id="cb39-15"><a href="#cb39-15" tabindex="-1"></a></span>
<span id="cb39-16"><a href="#cb39-16" tabindex="-1"></a><span class="co">// We need to aggregate this time series to compute</span></span>
<span id="cb39-17"><a href="#cb39-17" tabindex="-1"></a><span class="co">// monthly images</span></span>
<span id="cb39-18"><a href="#cb39-18" tabindex="-1"></a></span>
<span id="cb39-19"><a href="#cb39-19" tabindex="-1"></a><span class="co">// Create a list of months</span></span>
<span id="cb39-20"><a href="#cb39-20" tabindex="-1"></a><span class="kw">var</span> months <span class="op">=</span> ee<span class="op">.</span><span class="at">List</span><span class="op">.</span><span class="fu">sequence</span>(<span class="dv">1</span><span class="op">,</span> <span class="dv">12</span>)</span>
<span id="cb39-21"><a href="#cb39-21" tabindex="-1"></a></span>
<span id="cb39-22"><a href="#cb39-22" tabindex="-1"></a><span class="co">// Write a function that takes a month number</span></span>
<span id="cb39-23"><a href="#cb39-23" tabindex="-1"></a><span class="co">// and returns a monthly image</span></span>
<span id="cb39-24"><a href="#cb39-24" tabindex="-1"></a><span class="kw">var</span> createMonthlyImage <span class="op">=</span> <span class="kw">function</span>(month) {</span>
<span id="cb39-25"><a href="#cb39-25" tabindex="-1"></a>  <span class="kw">var</span> startDate <span class="op">=</span> ee<span class="op">.</span><span class="at">Date</span><span class="op">.</span><span class="fu">fromYMD</span>(year<span class="op">,</span> month<span class="op">,</span> <span class="dv">1</span>)</span>
<span id="cb39-26"><a href="#cb39-26" tabindex="-1"></a>  <span class="kw">var</span> endDate <span class="op">=</span> startDate<span class="op">.</span><span class="fu">advance</span>(<span class="dv">1</span><span class="op">,</span> <span class="st">&#39;month&#39;</span>)</span>
<span id="cb39-27"><a href="#cb39-27" tabindex="-1"></a>  <span class="kw">var</span> monthFiltered <span class="op">=</span> yearFiltered</span>
<span id="cb39-28"><a href="#cb39-28" tabindex="-1"></a>    <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(startDate<span class="op">,</span> endDate))</span>
<span id="cb39-29"><a href="#cb39-29" tabindex="-1"></a>  <span class="co">// Calculate total precipitation</span></span>
<span id="cb39-30"><a href="#cb39-30" tabindex="-1"></a>  <span class="kw">var</span> total <span class="op">=</span> monthFiltered<span class="op">.</span><span class="fu">reduce</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">sum</span>())</span>
<span id="cb39-31"><a href="#cb39-31" tabindex="-1"></a>  <span class="cf">return</span> total<span class="op">.</span><span class="fu">set</span>({</span>
<span id="cb39-32"><a href="#cb39-32" tabindex="-1"></a>    <span class="st">&#39;system:time_start&#39;</span><span class="op">:</span> startDate<span class="op">.</span><span class="fu">millis</span>()<span class="op">,</span></span>
<span id="cb39-33"><a href="#cb39-33" tabindex="-1"></a>    <span class="st">&#39;system:time_end&#39;</span><span class="op">:</span> endDate<span class="op">.</span><span class="fu">millis</span>()<span class="op">,</span></span>
<span id="cb39-34"><a href="#cb39-34" tabindex="-1"></a>    <span class="st">&#39;year&#39;</span><span class="op">:</span> year<span class="op">,</span></span>
<span id="cb39-35"><a href="#cb39-35" tabindex="-1"></a>    <span class="st">&#39;month&#39;</span><span class="op">:</span> month})</span>
<span id="cb39-36"><a href="#cb39-36" tabindex="-1"></a>}</span>
<span id="cb39-37"><a href="#cb39-37" tabindex="-1"></a></span>
<span id="cb39-38"><a href="#cb39-38" tabindex="-1"></a><span class="co">// map() the function on the list  of months</span></span>
<span id="cb39-39"><a href="#cb39-39" tabindex="-1"></a><span class="co">// This creates a list with images for each month in the list</span></span>
<span id="cb39-40"><a href="#cb39-40" tabindex="-1"></a><span class="kw">var</span> monthlyImages <span class="op">=</span> months<span class="op">.</span><span class="fu">map</span>(createMonthlyImage)</span>
<span id="cb39-41"><a href="#cb39-41" tabindex="-1"></a><span class="co">// Create an imagecollection</span></span>
<span id="cb39-42"><a href="#cb39-42" tabindex="-1"></a><span class="kw">var</span> monthlyCollection <span class="op">=</span> ee<span class="op">.</span><span class="at">ImageCollection</span><span class="op">.</span><span class="fu">fromImages</span>(monthlyImages)</span>
<span id="cb39-43"><a href="#cb39-43" tabindex="-1"></a><span class="fu">print</span>(monthlyCollection)</span>
<span id="cb39-44"><a href="#cb39-44" tabindex="-1"></a></span>
<span id="cb39-45"><a href="#cb39-45" tabindex="-1"></a><span class="co">// Create a chart of monthly rainfall for a location</span></span>
<span id="cb39-46"><a href="#cb39-46" tabindex="-1"></a><span class="kw">var</span> chart <span class="op">=</span> ui<span class="op">.</span><span class="at">Chart</span><span class="op">.</span><span class="at">image</span><span class="op">.</span><span class="fu">series</span>({</span>
<span id="cb39-47"><a href="#cb39-47" tabindex="-1"></a>  <span class="dt">imageCollection</span><span class="op">:</span> monthlyCollection<span class="op">,</span></span>
<span id="cb39-48"><a href="#cb39-48" tabindex="-1"></a>  <span class="dt">region</span><span class="op">:</span> geometry<span class="op">,</span></span>
<span id="cb39-49"><a href="#cb39-49" tabindex="-1"></a>  <span class="dt">reducer</span><span class="op">:</span> ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">mean</span>()<span class="op">,</span></span>
<span id="cb39-50"><a href="#cb39-50" tabindex="-1"></a>  <span class="dt">scale</span><span class="op">:</span> <span class="dv">5566</span></span>
<span id="cb39-51"><a href="#cb39-51" tabindex="-1"></a>})<span class="op">.</span><span class="fu">setOptions</span>({</span>
<span id="cb39-52"><a href="#cb39-52" tabindex="-1"></a>      <span class="dt">lineWidth</span><span class="op">:</span> <span class="dv">1</span><span class="op">,</span></span>
<span id="cb39-53"><a href="#cb39-53" tabindex="-1"></a>      <span class="dt">pointSize</span><span class="op">:</span> <span class="dv">3</span><span class="op">,</span></span>
<span id="cb39-54"><a href="#cb39-54" tabindex="-1"></a>      <span class="dt">title</span><span class="op">:</span> <span class="st">&#39;Monthly Rainfall at Bengaluru&#39;</span><span class="op">,</span></span>
<span id="cb39-55"><a href="#cb39-55" tabindex="-1"></a>      <span class="dt">vAxis</span><span class="op">:</span> {<span class="dt">title</span><span class="op">:</span> <span class="st">&#39;Rainfall (mm)&#39;</span>}<span class="op">,</span></span>
<span id="cb39-56"><a href="#cb39-56" tabindex="-1"></a>      <span class="dt">hAxis</span><span class="op">:</span> {<span class="dt">title</span><span class="op">:</span> <span class="st">&#39;Month&#39;</span><span class="op">,</span> <span class="dt">gridlines</span><span class="op">:</span> {<span class="dt">count</span><span class="op">:</span> <span class="dv">12</span>}}</span>
<span id="cb39-57"><a href="#cb39-57" tabindex="-1"></a>})</span>
<span id="cb39-58"><a href="#cb39-58" tabindex="-1"></a><span class="fu">print</span>(chart)</span></code></pre></div>
<div class="figure" style="text-align: center">
<img src="images/gee_water_resources_management/Charting_Monthly_Rainfall.png" alt="2019 - Monthly rainfall" width="100%" />
<p class="caption">
2019 - Monthly rainfall
</p>
</div>
<div id="exercise-20" class="section level3">
<h3>Exercise</h3>
<p><a
href="https://code.earthengine.google.co.in/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3A03-Time_Series_Analysis%2F05c_Charting_Monthly_Rainfall_(exercise)"
target="_blank">Try in Code Editor ↗</a></p>
<p>Change the geometry to your location, compute the monthly total
rainfall. Download the timeseries chart generated.</p>
<div class="sourceCode" id="cb40"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb40-1"><a href="#cb40-1" tabindex="-1"></a><span class="co">// Create a chart of monthly rainfall at your selected location</span></span>
<span id="cb40-2"><a href="#cb40-2" tabindex="-1"></a><span class="co">// print the chart and download it as a PNG</span></span></code></pre></div>
</div>
</div>
<div id="import" class="section level2">
<h2>06. Import</h2>
<p>You can import vector or raster data into Earth Engine. We will now
import a shapefile of <a
href="https://kgis.ksrsac.in/kgis/downloads.aspx">Taluk</a> for a state
in India. Unzip the <code>Taluk.rar</code> into a folder on your
computer. In the Code Editor, go to <em>Assets → New → Table Upload →
Shape Files</em>. Select the <code>.cpj</code>, <code>.sbn</code>,
<code>.shp</code>, <code>.shx</code>, <code>.dbf</code>and
.<code>prj</code> files. Enter <code>Taluk_Boundary</code> as the
<em>Asset Name</em> and click <em>Upload</em>. In the <em>Tasks</em> tab
you can see the progress of the upload. Once the ingestion is complete
you will have a new asset in the <em>Assets</em> tab. The shapefile will
be imported as a Feature Collection in Earth Engine. Select the
<code>Taluk_Boundary</code> asset and click <em>Import</em>. You can
then visualize the imported data.</p>
<a
href="https://code.earthengine.google.co.in/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3A03-Time_Series_Analysis%2F06b_Import_(complete)"
target="_blank">Open in Code Editor ↗</a>
<div class="figure" style="text-align: center">
<img src="images/gee_water_resources_management/upload.png" alt="Importing a Shapefile" width="150%" />
<p class="caption">
Importing a Shapefile
</p>
</div>
<div class="sourceCode" id="cb41"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb41-1"><a href="#cb41-1" tabindex="-1"></a><span class="co">// Let&#39;s import some data to Earth Engine</span></span>
<span id="cb41-2"><a href="#cb41-2" tabindex="-1"></a></span>
<span id="cb41-3"><a href="#cb41-3" tabindex="-1"></a><span class="co">// Download the &#39;Taluk&#39; shapefiles from K-GIS</span></span>
<span id="cb41-4"><a href="#cb41-4" tabindex="-1"></a><span class="co">// https://kgis.ksrsac.in/kgis/downloads.aspx</span></span>
<span id="cb41-5"><a href="#cb41-5" tabindex="-1"></a></span>
<span id="cb41-6"><a href="#cb41-6" tabindex="-1"></a><span class="co">// Uncompress and upload the &#39;Taluk_Boundary.shp&#39; shapefile </span></span>
<span id="cb41-7"><a href="#cb41-7" tabindex="-1"></a></span>
<span id="cb41-8"><a href="#cb41-8" tabindex="-1"></a></span>
<span id="cb41-9"><a href="#cb41-9" tabindex="-1"></a><span class="co">// Import the collection</span></span>
<span id="cb41-10"><a href="#cb41-10" tabindex="-1"></a><span class="kw">var</span> taluks <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">&quot;users/ujavalgandhi/gee-water-resources/kgis_taluks&quot;</span>)<span class="op">;</span></span>
<span id="cb41-11"><a href="#cb41-11" tabindex="-1"></a></span>
<span id="cb41-12"><a href="#cb41-12" tabindex="-1"></a><span class="co">// Visualize the collection</span></span>
<span id="cb41-13"><a href="#cb41-13" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">centerObject</span>(taluks)</span>
<span id="cb41-14"><a href="#cb41-14" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(taluks<span class="op">,</span> {<span class="dt">color</span><span class="op">:</span> <span class="st">&#39;gray&#39;</span>}<span class="op">,</span> <span class="st">&#39;Taluks&#39;</span>)</span>
<span id="cb41-15"><a href="#cb41-15" tabindex="-1"></a></span>
<span id="cb41-16"><a href="#cb41-16" tabindex="-1"></a><span class="co">// Function to add a new property &#39;area_sqkm&#39;</span></span>
<span id="cb41-17"><a href="#cb41-17" tabindex="-1"></a><span class="co">// Function takes a feature and returns the feature</span></span>
<span id="cb41-18"><a href="#cb41-18" tabindex="-1"></a><span class="co">// with a new property</span></span>
<span id="cb41-19"><a href="#cb41-19" tabindex="-1"></a><span class="kw">var</span> addArea <span class="op">=</span> <span class="kw">function</span>(f) {</span>
<span id="cb41-20"><a href="#cb41-20" tabindex="-1"></a>  <span class="kw">var</span> area <span class="op">=</span> ee<span class="op">.</span><span class="fu">Number</span>(f<span class="op">.</span><span class="fu">get</span>(<span class="st">&#39;SHAPE_STAr&#39;</span>))<span class="op">.</span><span class="fu">divide</span>(<span class="fl">1e6</span>)</span>
<span id="cb41-21"><a href="#cb41-21" tabindex="-1"></a>  <span class="cf">return</span> f<span class="op">.</span><span class="fu">set</span>(<span class="st">&#39;area_sqkm&#39;</span><span class="op">,</span> area)</span>
<span id="cb41-22"><a href="#cb41-22" tabindex="-1"></a>}</span>
<span id="cb41-23"><a href="#cb41-23" tabindex="-1"></a><span class="kw">var</span> talukWithArea <span class="op">=</span> taluks<span class="op">.</span><span class="fu">map</span>(addArea)</span>
<span id="cb41-24"><a href="#cb41-24" tabindex="-1"></a><span class="fu">print</span>(talukWithArea)</span></code></pre></div>
<div id="exercise-21" class="section level3">
<h3>Exercise</h3>
<p><a
href="https://code.earthengine.google.co.in/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3A03-Time_Series_Analysis%2F06c_Import_(exercise)"
target="_blank">Try in Code Editor ↗</a></p>
<p>Explore the uploaded Feature Collection, <code>SHAPE_STAr</code>
property contains the area in meter_square, using <code>addArea</code>
function area is converted into kilometer_square and stored as
<code>area_sqkm</code>. Using this property filter all regions with area
greater than 1000 sq km.</p>
<div class="sourceCode" id="cb42"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb42-1"><a href="#cb42-1" tabindex="-1"></a><span class="co">// Let&#39;s import some data to Earth Engine</span></span>
<span id="cb42-2"><a href="#cb42-2" tabindex="-1"></a></span>
<span id="cb42-3"><a href="#cb42-3" tabindex="-1"></a><span class="co">// Download the &#39;Taluk&#39; shapefiles from K-GIS</span></span>
<span id="cb42-4"><a href="#cb42-4" tabindex="-1"></a><span class="co">// https://kgis.ksrsac.in/kgis/downloads.aspx</span></span>
<span id="cb42-5"><a href="#cb42-5" tabindex="-1"></a></span>
<span id="cb42-6"><a href="#cb42-6" tabindex="-1"></a><span class="co">// Uncompress and upload the &#39;Taluk_Boundary.shp&#39; shapefile </span></span>
<span id="cb42-7"><a href="#cb42-7" tabindex="-1"></a></span>
<span id="cb42-8"><a href="#cb42-8" tabindex="-1"></a></span>
<span id="cb42-9"><a href="#cb42-9" tabindex="-1"></a><span class="co">// Import the collection</span></span>
<span id="cb42-10"><a href="#cb42-10" tabindex="-1"></a><span class="kw">var</span> taluks <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">&quot;users/ujavalgandhi/gee-water-resources/kgis_taluks&quot;</span>)<span class="op">;</span></span>
<span id="cb42-11"><a href="#cb42-11" tabindex="-1"></a></span>
<span id="cb42-12"><a href="#cb42-12" tabindex="-1"></a><span class="co">// Function to add a new property &#39;area_sqkm&#39;</span></span>
<span id="cb42-13"><a href="#cb42-13" tabindex="-1"></a><span class="co">// Function takes a feature and returns the feature</span></span>
<span id="cb42-14"><a href="#cb42-14" tabindex="-1"></a><span class="co">// with a new property</span></span>
<span id="cb42-15"><a href="#cb42-15" tabindex="-1"></a><span class="kw">var</span> addArea <span class="op">=</span> <span class="kw">function</span>(f) {</span>
<span id="cb42-16"><a href="#cb42-16" tabindex="-1"></a>  <span class="kw">var</span> area <span class="op">=</span> ee<span class="op">.</span><span class="fu">Number</span>(f<span class="op">.</span><span class="fu">get</span>(<span class="st">&#39;SHAPE_STAr&#39;</span>))<span class="op">.</span><span class="fu">divide</span>(<span class="fl">1e6</span>)</span>
<span id="cb42-17"><a href="#cb42-17" tabindex="-1"></a>  <span class="cf">return</span> f<span class="op">.</span><span class="fu">set</span>(<span class="st">&#39;area_sqkm&#39;</span><span class="op">,</span> area)</span>
<span id="cb42-18"><a href="#cb42-18" tabindex="-1"></a>}</span>
<span id="cb42-19"><a href="#cb42-19" tabindex="-1"></a><span class="kw">var</span> talukWithArea <span class="op">=</span> taluks<span class="op">.</span><span class="fu">map</span>(addArea)</span>
<span id="cb42-20"><a href="#cb42-20" tabindex="-1"></a><span class="fu">print</span>(talukWithArea)</span>
<span id="cb42-21"><a href="#cb42-21" tabindex="-1"></a></span>
<span id="cb42-22"><a href="#cb42-22" tabindex="-1"></a><span class="co">// Exercise</span></span>
<span id="cb42-23"><a href="#cb42-23" tabindex="-1"></a><span class="co">// Apply a filter to select all polygons with area &gt; 1000 sq. km.</span></span>
<span id="cb42-24"><a href="#cb42-24" tabindex="-1"></a><span class="co">// Add the results to the map</span></span></code></pre></div>
</div>
</div>
<div id="zonal-statistics" class="section level2">
<h2>07. Zonal Statistics</h2>
<p>Now that we have uploaded a shapefile with many Taluk boundaries let
us calculate the mean rainfall for each district. Before in
<code>reduceRegion</code>, we learned to reduce a single image over a
whole geometry. But by using the <code>reduceRegions</code>, we can
reduce the image for each geometry in the feature collection. This
function will return a <em>Feature Collection</em>, which contains all
the features with an additional property of the reduced value.</p>
<a
href="https://code.earthengine.google.co.in/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3A03-Time_Series_Analysis%2F07b_Zonal_Statistics_(complete)"
target="_blank">Open in Code Editor ↗</a>
<div class="figure" style="text-align: center">
<img src="images/gee_water_resources_management/zonal_statistics.png" alt="Zonal Statistics" width="100%" />
<p class="caption">
Zonal Statistics
</p>
</div>
<div class="sourceCode" id="cb43"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb43-1"><a href="#cb43-1" tabindex="-1"></a><span class="kw">var</span> taluks <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">&quot;users/ujavalgandhi/gee-water-resources/kgis_taluks&quot;</span>)<span class="op">;</span></span>
<span id="cb43-2"><a href="#cb43-2" tabindex="-1"></a><span class="kw">var</span> chirps <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&#39;UCSB-CHG/CHIRPS/PENTAD&#39;</span>)</span>
<span id="cb43-3"><a href="#cb43-3" tabindex="-1"></a></span>
<span id="cb43-4"><a href="#cb43-4" tabindex="-1"></a><span class="kw">var</span> year <span class="op">=</span> <span class="dv">2019</span></span>
<span id="cb43-5"><a href="#cb43-5" tabindex="-1"></a><span class="kw">var</span> startDate <span class="op">=</span> ee<span class="op">.</span><span class="at">Date</span><span class="op">.</span><span class="fu">fromYMD</span>(year<span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">1</span>)</span>
<span id="cb43-6"><a href="#cb43-6" tabindex="-1"></a><span class="kw">var</span> endDate <span class="op">=</span> startDate<span class="op">.</span><span class="fu">advance</span>(<span class="dv">1</span><span class="op">,</span> <span class="st">&#39;year&#39;</span>)</span>
<span id="cb43-7"><a href="#cb43-7" tabindex="-1"></a></span>
<span id="cb43-8"><a href="#cb43-8" tabindex="-1"></a><span class="kw">var</span> filtered <span class="op">=</span> chirps</span>
<span id="cb43-9"><a href="#cb43-9" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(startDate<span class="op">,</span> endDate))</span>
<span id="cb43-10"><a href="#cb43-10" tabindex="-1"></a></span>
<span id="cb43-11"><a href="#cb43-11" tabindex="-1"></a><span class="co">// Calculate the total rainfall for the year</span></span>
<span id="cb43-12"><a href="#cb43-12" tabindex="-1"></a><span class="kw">var</span> total <span class="op">=</span> filtered<span class="op">.</span><span class="fu">reduce</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">sum</span>())</span>
<span id="cb43-13"><a href="#cb43-13" tabindex="-1"></a></span>
<span id="cb43-14"><a href="#cb43-14" tabindex="-1"></a><span class="co">// Display the total rainfall image.</span></span>
<span id="cb43-15"><a href="#cb43-15" tabindex="-1"></a><span class="kw">var</span> palette <span class="op">=</span> [<span class="st">&#39;#ffffcc&#39;</span><span class="op">,</span><span class="st">&#39;#a1dab4&#39;</span><span class="op">,</span><span class="st">&#39;#41b6c4&#39;</span><span class="op">,</span><span class="st">&#39;#2c7fb8&#39;</span><span class="op">,</span><span class="st">&#39;#253494&#39;</span>]</span>
<span id="cb43-16"><a href="#cb43-16" tabindex="-1"></a><span class="kw">var</span> visParams <span class="op">=</span> {</span>
<span id="cb43-17"><a href="#cb43-17" tabindex="-1"></a>  <span class="dt">min</span><span class="op">:</span><span class="dv">0</span><span class="op">,</span></span>
<span id="cb43-18"><a href="#cb43-18" tabindex="-1"></a>  <span class="dt">max</span><span class="op">:</span> <span class="dv">2000</span><span class="op">,</span></span>
<span id="cb43-19"><a href="#cb43-19" tabindex="-1"></a>  <span class="dt">palette</span><span class="op">:</span> palette</span>
<span id="cb43-20"><a href="#cb43-20" tabindex="-1"></a>}</span>
<span id="cb43-21"><a href="#cb43-21" tabindex="-1"></a></span>
<span id="cb43-22"><a href="#cb43-22" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(total<span class="op">,</span> visParams<span class="op">,</span> <span class="st">&#39;Total Precipitation&#39;</span>)</span>
<span id="cb43-23"><a href="#cb43-23" tabindex="-1"></a></span>
<span id="cb43-24"><a href="#cb43-24" tabindex="-1"></a><span class="co">// Compute the average total rainfall for each feature</span></span>
<span id="cb43-25"><a href="#cb43-25" tabindex="-1"></a><span class="co">// reduceRegions() function allows you to do zonal stats</span></span>
<span id="cb43-26"><a href="#cb43-26" tabindex="-1"></a><span class="kw">var</span> withRainfall <span class="op">=</span> total<span class="op">.</span><span class="fu">reduceRegions</span>({</span>
<span id="cb43-27"><a href="#cb43-27" tabindex="-1"></a>  <span class="dt">collection</span><span class="op">:</span> taluks<span class="op">,</span></span>
<span id="cb43-28"><a href="#cb43-28" tabindex="-1"></a>  <span class="dt">reducer</span><span class="op">:</span> ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">mean</span>()<span class="op">,</span></span>
<span id="cb43-29"><a href="#cb43-29" tabindex="-1"></a>  <span class="dt">scale</span><span class="op">:</span> <span class="dv">5566</span>})</span>
<span id="cb43-30"><a href="#cb43-30" tabindex="-1"></a>  </span>
<span id="cb43-31"><a href="#cb43-31" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">centerObject</span>(taluks)</span>
<span id="cb43-32"><a href="#cb43-32" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(withRainfall<span class="op">,</span> {<span class="dt">color</span><span class="op">:</span> <span class="st">&#39;red&#39;</span>}<span class="op">,</span> <span class="st">&#39;Taluks&#39;</span>)</span></code></pre></div>
<div id="exercise-22" class="section level3">
<h3>Exercise</h3>
<p><a
href="https://code.earthengine.google.co.in/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3A03-Time_Series_Analysis%2F07c_Zonal_Statistics_(exercise)"
target="_blank">Try in Code Editor ↗</a></p>
<p>Write an export function to export the Feature Collection as a CSV
file.</p>
<div class="sourceCode" id="cb44"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb44-1"><a href="#cb44-1" tabindex="-1"></a><span class="kw">var</span> taluks <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">&quot;users/ujavalgandhi/gee-water-resources/kgis_taluks&quot;</span>)<span class="op">;</span></span>
<span id="cb44-2"><a href="#cb44-2" tabindex="-1"></a><span class="kw">var</span> chirps <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&#39;UCSB-CHG/CHIRPS/PENTAD&#39;</span>)<span class="op">;</span></span>
<span id="cb44-3"><a href="#cb44-3" tabindex="-1"></a></span>
<span id="cb44-4"><a href="#cb44-4" tabindex="-1"></a><span class="kw">var</span> year <span class="op">=</span> <span class="dv">2019</span><span class="op">;</span></span>
<span id="cb44-5"><a href="#cb44-5" tabindex="-1"></a><span class="kw">var</span> startDate <span class="op">=</span> ee<span class="op">.</span><span class="at">Date</span><span class="op">.</span><span class="fu">fromYMD</span>(year<span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb44-6"><a href="#cb44-6" tabindex="-1"></a><span class="kw">var</span> endDate <span class="op">=</span> startDate<span class="op">.</span><span class="fu">advance</span>(<span class="dv">1</span><span class="op">,</span> <span class="st">&#39;year&#39;</span>)</span>
<span id="cb44-7"><a href="#cb44-7" tabindex="-1"></a></span>
<span id="cb44-8"><a href="#cb44-8" tabindex="-1"></a><span class="kw">var</span> filtered <span class="op">=</span> chirps</span>
<span id="cb44-9"><a href="#cb44-9" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(startDate<span class="op">,</span> endDate))<span class="op">;</span></span>
<span id="cb44-10"><a href="#cb44-10" tabindex="-1"></a></span>
<span id="cb44-11"><a href="#cb44-11" tabindex="-1"></a><span class="co">// Calculate the total rainfall for the year</span></span>
<span id="cb44-12"><a href="#cb44-12" tabindex="-1"></a><span class="kw">var</span> total <span class="op">=</span> filtered<span class="op">.</span><span class="fu">reduce</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">sum</span>())<span class="op">;</span></span>
<span id="cb44-13"><a href="#cb44-13" tabindex="-1"></a></span>
<span id="cb44-14"><a href="#cb44-14" tabindex="-1"></a><span class="co">// Display the total rainfall image.</span></span>
<span id="cb44-15"><a href="#cb44-15" tabindex="-1"></a><span class="kw">var</span> palette <span class="op">=</span> [<span class="st">&#39;#ffffcc&#39;</span><span class="op">,</span><span class="st">&#39;#a1dab4&#39;</span><span class="op">,</span><span class="st">&#39;#41b6c4&#39;</span><span class="op">,</span><span class="st">&#39;#2c7fb8&#39;</span><span class="op">,</span><span class="st">&#39;#253494&#39;</span>]<span class="op">;</span></span>
<span id="cb44-16"><a href="#cb44-16" tabindex="-1"></a><span class="kw">var</span> visParams <span class="op">=</span> {</span>
<span id="cb44-17"><a href="#cb44-17" tabindex="-1"></a>  <span class="dt">min</span><span class="op">:</span><span class="dv">0</span><span class="op">,</span></span>
<span id="cb44-18"><a href="#cb44-18" tabindex="-1"></a>  <span class="dt">max</span><span class="op">:</span> <span class="dv">2000</span><span class="op">,</span></span>
<span id="cb44-19"><a href="#cb44-19" tabindex="-1"></a>  <span class="dt">palette</span><span class="op">:</span> palette</span>
<span id="cb44-20"><a href="#cb44-20" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb44-21"><a href="#cb44-21" tabindex="-1"></a></span>
<span id="cb44-22"><a href="#cb44-22" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(total<span class="op">,</span> visParams<span class="op">,</span> <span class="st">&#39;Total Precipitation&#39;</span>)<span class="op">;</span></span>
<span id="cb44-23"><a href="#cb44-23" tabindex="-1"></a></span>
<span id="cb44-24"><a href="#cb44-24" tabindex="-1"></a><span class="co">// Compute the total rainfall for each feature</span></span>
<span id="cb44-25"><a href="#cb44-25" tabindex="-1"></a><span class="co">// reduceRegions() function allows you to do zonal stats</span></span>
<span id="cb44-26"><a href="#cb44-26" tabindex="-1"></a><span class="kw">var</span> withRainfall <span class="op">=</span> total<span class="op">.</span><span class="fu">reduceRegions</span>({</span>
<span id="cb44-27"><a href="#cb44-27" tabindex="-1"></a>  <span class="dt">collection</span><span class="op">:</span> taluks<span class="op">,</span></span>
<span id="cb44-28"><a href="#cb44-28" tabindex="-1"></a>  <span class="dt">reducer</span><span class="op">:</span> ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">mean</span>()<span class="op">,</span></span>
<span id="cb44-29"><a href="#cb44-29" tabindex="-1"></a>  <span class="dt">scale</span><span class="op">:</span> <span class="dv">5566</span>})<span class="op">;</span></span>
<span id="cb44-30"><a href="#cb44-30" tabindex="-1"></a>  </span>
<span id="cb44-31"><a href="#cb44-31" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">centerObject</span>(taluks)<span class="op">;</span></span>
<span id="cb44-32"><a href="#cb44-32" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(withRainfall<span class="op">,</span> {<span class="dt">color</span><span class="op">:</span> <span class="st">&#39;blue&#39;</span>}<span class="op">,</span> <span class="st">&#39;Taluks&#39;</span>)<span class="op">;</span></span>
<span id="cb44-33"><a href="#cb44-33" tabindex="-1"></a></span>
<span id="cb44-34"><a href="#cb44-34" tabindex="-1"></a><span class="co">// Exercise</span></span>
<span id="cb44-35"><a href="#cb44-35" tabindex="-1"></a><span class="co">// Export the resulting FeatureCollection with average rainfall as a CSV</span></span>
<span id="cb44-36"><a href="#cb44-36" tabindex="-1"></a><span class="co">// Use the Export.table.toDrive() function</span></span>
<span id="cb44-37"><a href="#cb44-37" tabindex="-1"></a></span>
<span id="cb44-38"><a href="#cb44-38" tabindex="-1"></a><span class="co">// You can use the .select() function to select only columns you need</span></span>
<span id="cb44-39"><a href="#cb44-39" tabindex="-1"></a><span class="co">// You can also rename the columns</span></span>
<span id="cb44-40"><a href="#cb44-40" tabindex="-1"></a><span class="kw">var</span> exportCol <span class="op">=</span> withRainfall</span>
<span id="cb44-41"><a href="#cb44-41" tabindex="-1"></a>  <span class="op">.</span><span class="fu">select</span>([<span class="st">&#39;KGISTalukN&#39;</span><span class="op">,</span> <span class="st">&#39;mean&#39;</span>]<span class="op">,</span> [<span class="st">&#39;taluk&#39;</span><span class="op">,</span> <span class="st">&#39;average_rainfall&#39;</span>])<span class="op">;</span></span>
<span id="cb44-42"><a href="#cb44-42" tabindex="-1"></a><span class="fu">print</span>(exportCol)<span class="op">;</span></span>
<span id="cb44-43"><a href="#cb44-43" tabindex="-1"></a></span>
<span id="cb44-44"><a href="#cb44-44" tabindex="-1"></a><span class="co">// Export the exportCol as a CSV</span></span>
<span id="cb44-45"><a href="#cb44-45" tabindex="-1"></a></span>
<span id="cb44-46"><a href="#cb44-46" tabindex="-1"></a><span class="co">// Hint: Even though you have only 2 properties for each feature, </span></span>
<span id="cb44-47"><a href="#cb44-47" tabindex="-1"></a><span class="co">// the CSV will include internal properties system:index and .geo (the geometry)</span></span>
<span id="cb44-48"><a href="#cb44-48" tabindex="-1"></a><span class="co">// To only get the data columns in your CSV, specify the list of properties</span></span>
<span id="cb44-49"><a href="#cb44-49" tabindex="-1"></a><span class="co">// using the &#39;selectors&#39; argument in Export.table.toDrive() function</span></span></code></pre></div>
</div>
</div>
<div id="trend-analysis" class="section level2">
<h2>08. Trend Analysis</h2>
<p>Trend Analysis is a technique that is used to find the pattern. Let
us do a Non-Parametric Trend Analysis using the <a
href="https://en.wikipedia.org/wiki/Theil%E2%80%93Sen_estimator">Sen
Slope</a> technique to find the pattern of rainfall over time.</p>
<p>The sens slope is a reduction operation that expects two-band X and
Y. The X is the constant band with value year, and the Y is the total
precipitation of that pixel in that year. After creating the image
collection in this format we can use the
<code>ee.Reducer.sensSlope()</code> with the collection to compute the
slope at each year.</p>
<p>This function returns an image with a positive pixel value
representing the increase in precipitation and vice-versa.</p>
<blockquote>
<p>An advantage of doing trend analysis in earth engine is computing
pre-pixel calculation other wise which would be computation intestiive
task to perform.</p>
</blockquote>
<p><a
href="https://code.earthengine.google.co.in/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3A03-Time_Series_Analysis%2F08b_Trend_Analysis_(complete)"
target="_blank">Open in Code Editor ↗</a></p>
<div class="sourceCode" id="cb45"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb45-1"><a href="#cb45-1" tabindex="-1"></a><span class="kw">var</span> taluks <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">&quot;users/ujavalgandhi/gee-water-resources/kgis_taluks&quot;</span>)<span class="op">;</span></span>
<span id="cb45-2"><a href="#cb45-2" tabindex="-1"></a><span class="kw">var</span> chirps <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&#39;UCSB-CHG/CHIRPS/PENTAD&#39;</span>)</span>
<span id="cb45-3"><a href="#cb45-3" tabindex="-1"></a></span>
<span id="cb45-4"><a href="#cb45-4" tabindex="-1"></a><span class="co">// We will compute the trend of total seasonal rainfall</span></span>
<span id="cb45-5"><a href="#cb45-5" tabindex="-1"></a></span>
<span id="cb45-6"><a href="#cb45-6" tabindex="-1"></a><span class="co">// Rainy season is June - September</span></span>
<span id="cb45-7"><a href="#cb45-7" tabindex="-1"></a><span class="kw">var</span> createSeasonalImage <span class="op">=</span> <span class="kw">function</span>(year) {</span>
<span id="cb45-8"><a href="#cb45-8" tabindex="-1"></a>  <span class="kw">var</span> startDate <span class="op">=</span> ee<span class="op">.</span><span class="at">Date</span><span class="op">.</span><span class="fu">fromYMD</span>(year<span class="op">,</span> <span class="dv">6</span><span class="op">,</span> <span class="dv">1</span>)</span>
<span id="cb45-9"><a href="#cb45-9" tabindex="-1"></a>  <span class="kw">var</span> endDate <span class="op">=</span> ee<span class="op">.</span><span class="at">Date</span><span class="op">.</span><span class="fu">fromYMD</span>(year<span class="op">,</span> <span class="dv">10</span><span class="op">,</span> <span class="dv">1</span>)</span>
<span id="cb45-10"><a href="#cb45-10" tabindex="-1"></a>  <span class="kw">var</span> seasonFiltered <span class="op">=</span> chirps</span>
<span id="cb45-11"><a href="#cb45-11" tabindex="-1"></a>    <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(startDate<span class="op">,</span> endDate))</span>
<span id="cb45-12"><a href="#cb45-12" tabindex="-1"></a>  <span class="co">// Calculate total precipitation</span></span>
<span id="cb45-13"><a href="#cb45-13" tabindex="-1"></a>  <span class="kw">var</span> total <span class="op">=</span> seasonFiltered<span class="op">.</span><span class="fu">reduce</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">sum</span>())</span>
<span id="cb45-14"><a href="#cb45-14" tabindex="-1"></a>  <span class="cf">return</span> total<span class="op">.</span><span class="fu">set</span>({</span>
<span id="cb45-15"><a href="#cb45-15" tabindex="-1"></a>    <span class="st">&#39;system:time_start&#39;</span><span class="op">:</span> startDate<span class="op">.</span><span class="fu">millis</span>()<span class="op">,</span></span>
<span id="cb45-16"><a href="#cb45-16" tabindex="-1"></a>    <span class="st">&#39;system:time_end&#39;</span><span class="op">:</span> endDate<span class="op">.</span><span class="fu">millis</span>()<span class="op">,</span></span>
<span id="cb45-17"><a href="#cb45-17" tabindex="-1"></a>    <span class="st">&#39;year&#39;</span><span class="op">:</span> year<span class="op">,</span></span>
<span id="cb45-18"><a href="#cb45-18" tabindex="-1"></a>  })</span>
<span id="cb45-19"><a href="#cb45-19" tabindex="-1"></a>}</span>
<span id="cb45-20"><a href="#cb45-20" tabindex="-1"></a></span>
<span id="cb45-21"><a href="#cb45-21" tabindex="-1"></a><span class="co">// Aggregate Precipitation Data to Yearly Time-Series</span></span>
<span id="cb45-22"><a href="#cb45-22" tabindex="-1"></a><span class="kw">var</span> years <span class="op">=</span> ee<span class="op">.</span><span class="at">List</span><span class="op">.</span><span class="fu">sequence</span>(<span class="dv">1981</span><span class="op">,</span> <span class="dv">2013</span>)</span>
<span id="cb45-23"><a href="#cb45-23" tabindex="-1"></a><span class="kw">var</span> yearlyImages <span class="op">=</span> years<span class="op">.</span><span class="fu">map</span>(createSeasonalImage)</span>
<span id="cb45-24"><a href="#cb45-24" tabindex="-1"></a><span class="fu">print</span>(yearlyImages)</span>
<span id="cb45-25"><a href="#cb45-25" tabindex="-1"></a></span>
<span id="cb45-26"><a href="#cb45-26" tabindex="-1"></a><span class="kw">var</span> yearlyCol <span class="op">=</span> ee<span class="op">.</span><span class="at">ImageCollection</span><span class="op">.</span><span class="fu">fromImages</span>(yearlyImages)</span>
<span id="cb45-27"><a href="#cb45-27" tabindex="-1"></a></span>
<span id="cb45-28"><a href="#cb45-28" tabindex="-1"></a></span>
<span id="cb45-29"><a href="#cb45-29" tabindex="-1"></a><span class="co">// Prepare data for Sen&#39;s Slope Estimation</span></span>
<span id="cb45-30"><a href="#cb45-30" tabindex="-1"></a><span class="co">// We need an image with 2 bands for X and Y varibles</span></span>
<span id="cb45-31"><a href="#cb45-31" tabindex="-1"></a><span class="co">// X = year</span></span>
<span id="cb45-32"><a href="#cb45-32" tabindex="-1"></a><span class="co">// Y = total precipitation</span></span>
<span id="cb45-33"><a href="#cb45-33" tabindex="-1"></a></span>
<span id="cb45-34"><a href="#cb45-34" tabindex="-1"></a><span class="kw">var</span> processImage <span class="op">=</span> <span class="kw">function</span>(image) {</span>
<span id="cb45-35"><a href="#cb45-35" tabindex="-1"></a>  <span class="kw">var</span> year <span class="op">=</span> image<span class="op">.</span><span class="fu">get</span>(<span class="st">&#39;year&#39;</span>)<span class="op">;</span></span>
<span id="cb45-36"><a href="#cb45-36" tabindex="-1"></a>  <span class="kw">var</span> yearImage <span class="op">=</span> ee<span class="op">.</span><span class="at">Image</span><span class="op">.</span><span class="fu">constant</span>(ee<span class="op">.</span><span class="fu">Number</span>(year))<span class="op">.</span><span class="fu">toShort</span>()<span class="op">;</span></span>
<span id="cb45-37"><a href="#cb45-37" tabindex="-1"></a>  <span class="cf">return</span> ee<span class="op">.</span><span class="at">Image</span><span class="op">.</span><span class="fu">cat</span>(yearImage<span class="op">,</span> image)<span class="op">.</span><span class="fu">rename</span>([<span class="st">&#39;year&#39;</span><span class="op">,</span> <span class="st">&#39;prcp&#39;</span>])<span class="op">.</span><span class="fu">set</span>(<span class="st">&#39;year&#39;</span><span class="op">,</span> year)<span class="op">;</span></span>
<span id="cb45-38"><a href="#cb45-38" tabindex="-1"></a>}</span>
<span id="cb45-39"><a href="#cb45-39" tabindex="-1"></a></span>
<span id="cb45-40"><a href="#cb45-40" tabindex="-1"></a><span class="kw">var</span> processedCol <span class="op">=</span> yearlyCol<span class="op">.</span><span class="fu">map</span>(processImage)</span>
<span id="cb45-41"><a href="#cb45-41" tabindex="-1"></a><span class="fu">print</span>(processedCol)</span>
<span id="cb45-42"><a href="#cb45-42" tabindex="-1"></a></span>
<span id="cb45-43"><a href="#cb45-43" tabindex="-1"></a><span class="co">// Calculate time series slope using sensSlope().</span></span>
<span id="cb45-44"><a href="#cb45-44" tabindex="-1"></a><span class="kw">var</span> sens <span class="op">=</span> processedCol<span class="op">.</span><span class="fu">reduce</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">sensSlope</span>())<span class="op">;</span></span>
<span id="cb45-45"><a href="#cb45-45" tabindex="-1"></a></span>
<span id="cb45-46"><a href="#cb45-46" tabindex="-1"></a><span class="co">// The resulting image has 2 bands: slope and intercept</span></span>
<span id="cb45-47"><a href="#cb45-47" tabindex="-1"></a><span class="co">// We select the &#39;slope&#39; band</span></span>
<span id="cb45-48"><a href="#cb45-48" tabindex="-1"></a><span class="kw">var</span> slope <span class="op">=</span> sens<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;slope&#39;</span>)</span>
<span id="cb45-49"><a href="#cb45-49" tabindex="-1"></a><span class="co">// Set visualisation parameters</span></span>
<span id="cb45-50"><a href="#cb45-50" tabindex="-1"></a><span class="kw">var</span> visParams <span class="op">=</span> {<span class="dt">min</span><span class="op">:</span> <span class="op">-</span><span class="dv">10</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span> <span class="dv">10</span><span class="op">,</span> <span class="dt">palette</span><span class="op">:</span> [<span class="st">&#39;brown&#39;</span><span class="op">,</span> <span class="st">&#39;white&#39;</span><span class="op">,</span> <span class="st">&#39;blue&#39;</span>]}<span class="op">;</span></span>
<span id="cb45-51"><a href="#cb45-51" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(slope<span class="op">,</span> visParams<span class="op">,</span> <span class="st">&#39;Trend&#39;</span>)<span class="op">;</span></span></code></pre></div>
<div id="exercise-23" class="section level3">
<h3>Exercise</h3>
<p><a
href="https://code.earthengine.google.co.in/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3A03-Time_Series_Analysis%2F08c_Trend_Analysis_(exercise)"
target="_blank">Try in Code Editor ↗</a></p>
<p>The trend analysis is done for a particular season. Change the filter
dates to compute the annual precipitation trend.</p>
<div class="sourceCode" id="cb46"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb46-1"><a href="#cb46-1" tabindex="-1"></a><span class="kw">var</span> taluks <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">&quot;users/ujavalgandhi/gee-water-resources/kgis_taluks&quot;</span>)<span class="op">;</span></span>
<span id="cb46-2"><a href="#cb46-2" tabindex="-1"></a><span class="kw">var</span> chirps <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&#39;UCSB-CHG/CHIRPS/PENTAD&#39;</span>)</span>
<span id="cb46-3"><a href="#cb46-3" tabindex="-1"></a></span>
<span id="cb46-4"><a href="#cb46-4" tabindex="-1"></a><span class="co">// We will compute the trend of total seasonal rainfall</span></span>
<span id="cb46-5"><a href="#cb46-5" tabindex="-1"></a></span>
<span id="cb46-6"><a href="#cb46-6" tabindex="-1"></a><span class="co">// Rainy season is June - September</span></span>
<span id="cb46-7"><a href="#cb46-7" tabindex="-1"></a><span class="kw">var</span> createSeasonalImage <span class="op">=</span> <span class="kw">function</span>(year) {</span>
<span id="cb46-8"><a href="#cb46-8" tabindex="-1"></a>  <span class="kw">var</span> startDate <span class="op">=</span> ee<span class="op">.</span><span class="at">Date</span><span class="op">.</span><span class="fu">fromYMD</span>(year<span class="op">,</span> <span class="dv">6</span><span class="op">,</span> <span class="dv">1</span>)</span>
<span id="cb46-9"><a href="#cb46-9" tabindex="-1"></a>  <span class="kw">var</span> endDate <span class="op">=</span> ee<span class="op">.</span><span class="at">Date</span><span class="op">.</span><span class="fu">fromYMD</span>(year<span class="op">,</span> <span class="dv">10</span><span class="op">,</span> <span class="dv">1</span>)</span>
<span id="cb46-10"><a href="#cb46-10" tabindex="-1"></a>  <span class="kw">var</span> seasonFiltered <span class="op">=</span> chirps</span>
<span id="cb46-11"><a href="#cb46-11" tabindex="-1"></a>    <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(startDate<span class="op">,</span> endDate))</span>
<span id="cb46-12"><a href="#cb46-12" tabindex="-1"></a>  <span class="co">// Calculate total precipitation</span></span>
<span id="cb46-13"><a href="#cb46-13" tabindex="-1"></a>  <span class="kw">var</span> total <span class="op">=</span> seasonFiltered<span class="op">.</span><span class="fu">reduce</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">sum</span>())</span>
<span id="cb46-14"><a href="#cb46-14" tabindex="-1"></a>  <span class="cf">return</span> total<span class="op">.</span><span class="fu">set</span>({</span>
<span id="cb46-15"><a href="#cb46-15" tabindex="-1"></a>    <span class="st">&#39;system:time_start&#39;</span><span class="op">:</span> startDate<span class="op">.</span><span class="fu">millis</span>()<span class="op">,</span></span>
<span id="cb46-16"><a href="#cb46-16" tabindex="-1"></a>    <span class="st">&#39;system:time_end&#39;</span><span class="op">:</span> endDate<span class="op">.</span><span class="fu">millis</span>()<span class="op">,</span></span>
<span id="cb46-17"><a href="#cb46-17" tabindex="-1"></a>    <span class="st">&#39;year&#39;</span><span class="op">:</span> year<span class="op">,</span></span>
<span id="cb46-18"><a href="#cb46-18" tabindex="-1"></a>  })</span>
<span id="cb46-19"><a href="#cb46-19" tabindex="-1"></a>}</span>
<span id="cb46-20"><a href="#cb46-20" tabindex="-1"></a></span>
<span id="cb46-21"><a href="#cb46-21" tabindex="-1"></a><span class="co">// Aggregate Precipitation Data </span></span>
<span id="cb46-22"><a href="#cb46-22" tabindex="-1"></a><span class="kw">var</span> years <span class="op">=</span> ee<span class="op">.</span><span class="at">List</span><span class="op">.</span><span class="fu">sequence</span>(<span class="dv">1981</span><span class="op">,</span> <span class="dv">2013</span>)</span>
<span id="cb46-23"><a href="#cb46-23" tabindex="-1"></a><span class="kw">var</span> yearlyImages <span class="op">=</span> years<span class="op">.</span><span class="fu">map</span>(createSeasonalImage)</span>
<span id="cb46-24"><a href="#cb46-24" tabindex="-1"></a><span class="fu">print</span>(yearlyImages)</span>
<span id="cb46-25"><a href="#cb46-25" tabindex="-1"></a></span>
<span id="cb46-26"><a href="#cb46-26" tabindex="-1"></a><span class="kw">var</span> yearlyCol <span class="op">=</span> ee<span class="op">.</span><span class="at">ImageCollection</span><span class="op">.</span><span class="fu">fromImages</span>(yearlyImages)</span>
<span id="cb46-27"><a href="#cb46-27" tabindex="-1"></a></span>
<span id="cb46-28"><a href="#cb46-28" tabindex="-1"></a></span>
<span id="cb46-29"><a href="#cb46-29" tabindex="-1"></a><span class="co">// Prepare data for Sen&#39;s Slope Estimation</span></span>
<span id="cb46-30"><a href="#cb46-30" tabindex="-1"></a><span class="co">// We need an image with 2 bands for X and Y varibles</span></span>
<span id="cb46-31"><a href="#cb46-31" tabindex="-1"></a><span class="co">// X = year</span></span>
<span id="cb46-32"><a href="#cb46-32" tabindex="-1"></a><span class="co">// Y = total precipitation</span></span>
<span id="cb46-33"><a href="#cb46-33" tabindex="-1"></a></span>
<span id="cb46-34"><a href="#cb46-34" tabindex="-1"></a><span class="kw">var</span> processImage <span class="op">=</span> <span class="kw">function</span>(image) {</span>
<span id="cb46-35"><a href="#cb46-35" tabindex="-1"></a>  <span class="kw">var</span> year <span class="op">=</span> image<span class="op">.</span><span class="fu">get</span>(<span class="st">&#39;year&#39;</span>)<span class="op">;</span></span>
<span id="cb46-36"><a href="#cb46-36" tabindex="-1"></a>  <span class="kw">var</span> yearImage <span class="op">=</span> ee<span class="op">.</span><span class="at">Image</span><span class="op">.</span><span class="fu">constant</span>(ee<span class="op">.</span><span class="fu">Number</span>(year))<span class="op">.</span><span class="fu">toShort</span>()<span class="op">;</span></span>
<span id="cb46-37"><a href="#cb46-37" tabindex="-1"></a>  <span class="cf">return</span> ee<span class="op">.</span><span class="at">Image</span><span class="op">.</span><span class="fu">cat</span>(yearImage<span class="op">,</span> image)<span class="op">.</span><span class="fu">rename</span>([<span class="st">&#39;year&#39;</span><span class="op">,</span> <span class="st">&#39;prcp&#39;</span>])<span class="op">.</span><span class="fu">set</span>(<span class="st">&#39;year&#39;</span><span class="op">,</span> year)<span class="op">;</span></span>
<span id="cb46-38"><a href="#cb46-38" tabindex="-1"></a>}</span>
<span id="cb46-39"><a href="#cb46-39" tabindex="-1"></a></span>
<span id="cb46-40"><a href="#cb46-40" tabindex="-1"></a><span class="kw">var</span> processedCol <span class="op">=</span> yearlyCol<span class="op">.</span><span class="fu">map</span>(processImage)</span>
<span id="cb46-41"><a href="#cb46-41" tabindex="-1"></a><span class="fu">print</span>(processedCol)</span>
<span id="cb46-42"><a href="#cb46-42" tabindex="-1"></a></span>
<span id="cb46-43"><a href="#cb46-43" tabindex="-1"></a><span class="co">// Calculate time series slope using sensSlope().</span></span>
<span id="cb46-44"><a href="#cb46-44" tabindex="-1"></a><span class="kw">var</span> sens <span class="op">=</span> processedCol<span class="op">.</span><span class="fu">reduce</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">sensSlope</span>())<span class="op">;</span></span>
<span id="cb46-45"><a href="#cb46-45" tabindex="-1"></a></span>
<span id="cb46-46"><a href="#cb46-46" tabindex="-1"></a><span class="co">// The resulting image has 2 bands: slope and intercept</span></span>
<span id="cb46-47"><a href="#cb46-47" tabindex="-1"></a><span class="co">// We select the &#39;slope&#39; band</span></span>
<span id="cb46-48"><a href="#cb46-48" tabindex="-1"></a><span class="kw">var</span> slope <span class="op">=</span> sens<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;slope&#39;</span>)</span>
<span id="cb46-49"><a href="#cb46-49" tabindex="-1"></a><span class="co">// Set visualisation parameters</span></span>
<span id="cb46-50"><a href="#cb46-50" tabindex="-1"></a><span class="kw">var</span> visParams <span class="op">=</span> {<span class="dt">min</span><span class="op">:</span> <span class="op">-</span><span class="dv">10</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span> <span class="dv">10</span><span class="op">,</span> <span class="dt">palette</span><span class="op">:</span> [<span class="st">&#39;brown&#39;</span><span class="op">,</span> <span class="st">&#39;white&#39;</span><span class="op">,</span> <span class="st">&#39;blue&#39;</span>]}<span class="op">;</span></span>
<span id="cb46-51"><a href="#cb46-51" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(slope<span class="op">,</span> visParams<span class="op">,</span> <span class="st">&#39;Trend&#39;</span>)<span class="op">;</span> </span>
<span id="cb46-52"><a href="#cb46-52" tabindex="-1"></a></span>
<span id="cb46-53"><a href="#cb46-53" tabindex="-1"></a><span class="co">// Exercise</span></span>
<span id="cb46-54"><a href="#cb46-54" tabindex="-1"></a><span class="co">// Change the code above to compute annual precipitation trend</span></span></code></pre></div>
</div>
</div>
</div>
<div id="module-4-land-use-land-cover-classification"
class="section level1">
<h1>Module 4: Land Use Land Cover Classification</h1>
<p>Supervised classification is one of the most popular machine learning
technique used in remote sensing. Google Earth Engine is uniquely suited
for supervised classification at a large scale and offers a flexible
data model that allows you to easily incorporate variables from multiple
data sources. The interactive nature of Earth Engine development allows
for iterative development of supervised classification workflows by
combining many different datasets into the model. This module covers
basic supervised classification workflow, accuracy assessment, and area
calculation.</p>
<p><a
href="https://www.youtube.com/watch?v=G1TpZ7SrQQc&amp;list=PLppGmFLhQ1HI0YeA5zQHxdNlmxihvBawF&amp;index=56"
target="_blank"><img
src="https://img.youtube.com/vi/G1TpZ7SrQQc/mqdefault.jpg"
alt="Start Module 4 Videos" /></a></p>
<p><a
href="https://www.youtube.com/watch?v=G1TpZ7SrQQc&amp;list=PLppGmFLhQ1HI0YeA5zQHxdNlmxihvBawF&amp;index=56"
target="_blank">Start Module 4 Videos ↗</a></p>
<p><a
href="https://docs.google.com/presentation/d/16jsxRrYG9RddvlUfa6Myt3_mc-ye4GgDcvYK6n7IgkU/edit?usp=sharing"
target="_blank">View the Presentation ↗</a></p>
<div id="basic-supervised-classification" class="section level2">
<h2>01. Basic Supervised Classification</h2>
<p>We will learn the technique to do a basic land cover classification
using training points collected using the Code Editor with the help of
the High-Resolution base map imagery provided by Google Maps. Even if no
field data is available for training the model, this method is very
effective in generating high-quality classification samples anywhere in
the world. The goal is to classify Sentinel 2A pixel into one of the
following classes - <em>urban, bare, water,</em> or <em>vegetation</em>.
Using the drawing tools in the code editor lets us create 4 new feature
collections with points representing pixels of each class. Each feature
collection will be created with a property <code>landcover</code> where
each collection has values of 0, 1, 2, or 3, representing urban, bare,
water, or vegetation, respectively. We use these collected samples to
train a <em>Random Forest</em> classifier and apply it to all the image
pixels to create a land cover image with 4 classes.</p>
<blockquote>
<p>Fun fact: The classifiers in Earth Engine API have names starting
with <strong>smile</strong> - such as
<code>ee.Classifier.smileRandomForest()</code>. The <em>smile</em> part
refers to the <a
href="https://haifengl.github.io/index.html">Statistical Machine
Intelligence and Learning Engine (SMILE)</a> JAVA library which is used
by Google Earth Engine to implement these algorithms.</p>
</blockquote>
<p><a
href="https://code.earthengine.google.com/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3A04-Land_Use_Land_Cover_Classification%2F01d_Basic_Supervised_Classification_(noimport)"
target="_blank">Open in Code Editor ↗</a></p>
<div class="sourceCode" id="cb47"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb47-1"><a href="#cb47-1" tabindex="-1"></a><span class="kw">var</span> bangalore <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">&#39;users/ujavalgandhi/public/bangalore_boundary&#39;</span>)<span class="op">;</span></span>
<span id="cb47-2"><a href="#cb47-2" tabindex="-1"></a><span class="kw">var</span> geometry <span class="op">=</span> bangalore<span class="op">.</span><span class="fu">geometry</span>()<span class="op">;</span></span>
<span id="cb47-3"><a href="#cb47-3" tabindex="-1"></a></span>
<span id="cb47-4"><a href="#cb47-4" tabindex="-1"></a><span class="kw">var</span> s2 <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&#39;COPERNICUS/S2_SR_HARMONIZED&#39;</span>)<span class="op">;</span></span>
<span id="cb47-5"><a href="#cb47-5" tabindex="-1"></a><span class="co">// The following collections were created using the </span></span>
<span id="cb47-6"><a href="#cb47-6" tabindex="-1"></a><span class="co">// Drawing Tools in the code editor </span></span>
<span id="cb47-7"><a href="#cb47-7" tabindex="-1"></a><span class="kw">var</span> urban <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">&#39;users/ujavalgandhi/e2e/urban_gcps&#39;</span>)<span class="op">;</span></span>
<span id="cb47-8"><a href="#cb47-8" tabindex="-1"></a><span class="kw">var</span> bare <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">&#39;users/ujavalgandhi/e2e/bare_gcps&#39;</span>)<span class="op">;</span></span>
<span id="cb47-9"><a href="#cb47-9" tabindex="-1"></a><span class="kw">var</span> water <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">&#39;users/ujavalgandhi/e2e/water_gcps&#39;</span>)<span class="op">;</span></span>
<span id="cb47-10"><a href="#cb47-10" tabindex="-1"></a><span class="kw">var</span> vegetation <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">&#39;users/ujavalgandhi/e2e/vegetation_gcps&#39;</span>)<span class="op">;</span></span>
<span id="cb47-11"><a href="#cb47-11" tabindex="-1"></a></span>
<span id="cb47-12"><a href="#cb47-12" tabindex="-1"></a><span class="kw">var</span> filtered <span class="op">=</span> s2</span>
<span id="cb47-13"><a href="#cb47-13" tabindex="-1"></a><span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">lt</span>(<span class="st">&#39;CLOUDY_PIXEL_PERCENTAGE&#39;</span><span class="op">,</span> <span class="dv">30</span>))</span>
<span id="cb47-14"><a href="#cb47-14" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(<span class="st">&#39;2019-01-01&#39;</span><span class="op">,</span> <span class="st">&#39;2020-01-01&#39;</span>))</span>
<span id="cb47-15"><a href="#cb47-15" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">bounds</span>(geometry))</span>
<span id="cb47-16"><a href="#cb47-16" tabindex="-1"></a>  <span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;B.*&#39;</span>)<span class="op">;</span></span>
<span id="cb47-17"><a href="#cb47-17" tabindex="-1"></a></span>
<span id="cb47-18"><a href="#cb47-18" tabindex="-1"></a><span class="kw">var</span> composite <span class="op">=</span> filtered<span class="op">.</span><span class="fu">median</span>()<span class="op">;</span></span>
<span id="cb47-19"><a href="#cb47-19" tabindex="-1"></a></span>
<span id="cb47-20"><a href="#cb47-20" tabindex="-1"></a><span class="co">// Display the input composite.</span></span>
<span id="cb47-21"><a href="#cb47-21" tabindex="-1"></a><span class="kw">var</span> rgbVis <span class="op">=</span> {</span>
<span id="cb47-22"><a href="#cb47-22" tabindex="-1"></a>  <span class="dt">min</span><span class="op">:</span> <span class="fl">0.0</span><span class="op">,</span></span>
<span id="cb47-23"><a href="#cb47-23" tabindex="-1"></a>  <span class="dt">max</span><span class="op">:</span> <span class="dv">3000</span><span class="op">,</span></span>
<span id="cb47-24"><a href="#cb47-24" tabindex="-1"></a>  <span class="dt">bands</span><span class="op">:</span> [<span class="st">&#39;B4&#39;</span><span class="op">,</span> <span class="st">&#39;B3&#39;</span><span class="op">,</span> <span class="st">&#39;B2&#39;</span>]<span class="op">,</span></span>
<span id="cb47-25"><a href="#cb47-25" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb47-26"><a href="#cb47-26" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(composite<span class="op">.</span><span class="fu">clip</span>(geometry)<span class="op">,</span> rgbVis<span class="op">,</span> <span class="st">&#39;image&#39;</span>)<span class="op">;</span></span>
<span id="cb47-27"><a href="#cb47-27" tabindex="-1"></a></span>
<span id="cb47-28"><a href="#cb47-28" tabindex="-1"></a><span class="kw">var</span> gcps <span class="op">=</span> urban<span class="op">.</span><span class="fu">merge</span>(bare)<span class="op">.</span><span class="fu">merge</span>(water)<span class="op">.</span><span class="fu">merge</span>(vegetation)<span class="op">;</span></span>
<span id="cb47-29"><a href="#cb47-29" tabindex="-1"></a></span>
<span id="cb47-30"><a href="#cb47-30" tabindex="-1"></a><span class="co">// Overlay the point on the image to get training data.</span></span>
<span id="cb47-31"><a href="#cb47-31" tabindex="-1"></a><span class="kw">var</span> training <span class="op">=</span> composite<span class="op">.</span><span class="fu">sampleRegions</span>({</span>
<span id="cb47-32"><a href="#cb47-32" tabindex="-1"></a>  <span class="dt">collection</span><span class="op">:</span> gcps<span class="op">,</span> </span>
<span id="cb47-33"><a href="#cb47-33" tabindex="-1"></a>  <span class="dt">properties</span><span class="op">:</span> [<span class="st">&#39;landcover&#39;</span>]<span class="op">,</span> </span>
<span id="cb47-34"><a href="#cb47-34" tabindex="-1"></a>  <span class="dt">scale</span><span class="op">:</span> <span class="dv">10</span></span>
<span id="cb47-35"><a href="#cb47-35" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb47-36"><a href="#cb47-36" tabindex="-1"></a></span>
<span id="cb47-37"><a href="#cb47-37" tabindex="-1"></a></span>
<span id="cb47-38"><a href="#cb47-38" tabindex="-1"></a><span class="co">// Train a classifier.</span></span>
<span id="cb47-39"><a href="#cb47-39" tabindex="-1"></a><span class="kw">var</span> classifier <span class="op">=</span> ee<span class="op">.</span><span class="at">Classifier</span><span class="op">.</span><span class="fu">smileRandomForest</span>(<span class="dv">50</span>)<span class="op">.</span><span class="fu">train</span>({</span>
<span id="cb47-40"><a href="#cb47-40" tabindex="-1"></a>  <span class="dt">features</span><span class="op">:</span> training<span class="op">,</span>  </span>
<span id="cb47-41"><a href="#cb47-41" tabindex="-1"></a>  <span class="dt">classProperty</span><span class="op">:</span> <span class="st">&#39;landcover&#39;</span><span class="op">,</span> </span>
<span id="cb47-42"><a href="#cb47-42" tabindex="-1"></a>  <span class="dt">inputProperties</span><span class="op">:</span> composite<span class="op">.</span><span class="fu">bandNames</span>()</span>
<span id="cb47-43"><a href="#cb47-43" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb47-44"><a href="#cb47-44" tabindex="-1"></a><span class="co">// // Classify the image.</span></span>
<span id="cb47-45"><a href="#cb47-45" tabindex="-1"></a><span class="kw">var</span> classified <span class="op">=</span> composite<span class="op">.</span><span class="fu">classify</span>(classifier)<span class="op">;</span></span>
<span id="cb47-46"><a href="#cb47-46" tabindex="-1"></a><span class="co">// Choose a 4-color palette</span></span>
<span id="cb47-47"><a href="#cb47-47" tabindex="-1"></a><span class="co">// Assign a color for each class in the following order</span></span>
<span id="cb47-48"><a href="#cb47-48" tabindex="-1"></a><span class="co">// Urban, Bare, Water, Vegetation</span></span>
<span id="cb47-49"><a href="#cb47-49" tabindex="-1"></a><span class="kw">var</span> palette <span class="op">=</span> [<span class="st">&#39;#cc6d8f&#39;</span><span class="op">,</span> <span class="st">&#39;#ffc107&#39;</span><span class="op">,</span> <span class="st">&#39;#1e88e5&#39;</span><span class="op">,</span> <span class="st">&#39;#004d40&#39;</span> ]<span class="op">;</span></span>
<span id="cb47-50"><a href="#cb47-50" tabindex="-1"></a></span>
<span id="cb47-51"><a href="#cb47-51" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(classified<span class="op">.</span><span class="fu">clip</span>(geometry)<span class="op">,</span> {<span class="dt">min</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span> <span class="dv">3</span><span class="op">,</span> <span class="dt">palette</span><span class="op">:</span> palette}<span class="op">,</span> <span class="st">&#39;2019&#39;</span>)<span class="op">;</span></span>
<span id="cb47-52"><a href="#cb47-52" tabindex="-1"></a></span>
<span id="cb47-53"><a href="#cb47-53" tabindex="-1"></a><span class="co">// Select the Water class</span></span>
<span id="cb47-54"><a href="#cb47-54" tabindex="-1"></a><span class="kw">var</span> water <span class="op">=</span> classified<span class="op">.</span><span class="fu">eq</span>(<span class="dv">2</span>)<span class="op">;</span></span>
<span id="cb47-55"><a href="#cb47-55" tabindex="-1"></a><span class="kw">var</span> waterVis <span class="op">=</span> {<span class="dt">min</span><span class="op">:</span><span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span><span class="dv">1</span><span class="op">,</span> <span class="dt">palette</span><span class="op">:</span> [<span class="st">&#39;white&#39;</span><span class="op">,</span> <span class="st">&#39;blue&#39;</span>]}<span class="op">;</span></span>
<span id="cb47-56"><a href="#cb47-56" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(water<span class="op">.</span><span class="fu">clip</span>(geometry)<span class="op">,</span> waterVis<span class="op">,</span> <span class="st">&#39;Water&#39;</span><span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span></span>
<span id="cb47-57"><a href="#cb47-57" tabindex="-1"></a></span>
<span id="cb47-58"><a href="#cb47-58" tabindex="-1"></a><span class="co">// Display the GCPs</span></span>
<span id="cb47-59"><a href="#cb47-59" tabindex="-1"></a><span class="co">// We use the style() function to style the GCPs</span></span>
<span id="cb47-60"><a href="#cb47-60" tabindex="-1"></a><span class="kw">var</span> palette <span class="op">=</span> ee<span class="op">.</span><span class="fu">List</span>(palette)<span class="op">;</span></span>
<span id="cb47-61"><a href="#cb47-61" tabindex="-1"></a><span class="kw">var</span> landcover <span class="op">=</span> ee<span class="op">.</span><span class="fu">List</span>([<span class="dv">0</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">3</span>])<span class="op">;</span></span>
<span id="cb47-62"><a href="#cb47-62" tabindex="-1"></a></span>
<span id="cb47-63"><a href="#cb47-63" tabindex="-1"></a><span class="kw">var</span> gcpsStyled <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(</span>
<span id="cb47-64"><a href="#cb47-64" tabindex="-1"></a>  landcover<span class="op">.</span><span class="fu">map</span>(<span class="kw">function</span>(lc){</span>
<span id="cb47-65"><a href="#cb47-65" tabindex="-1"></a>    <span class="kw">var</span> color <span class="op">=</span> palette<span class="op">.</span><span class="fu">get</span>(landcover<span class="op">.</span><span class="fu">indexOf</span>(lc))<span class="op">;</span></span>
<span id="cb47-66"><a href="#cb47-66" tabindex="-1"></a>    <span class="kw">var</span> markerStyle <span class="op">=</span> { <span class="dt">color</span><span class="op">:</span> <span class="st">&#39;white&#39;</span><span class="op">,</span> <span class="dt">pointShape</span><span class="op">:</span> <span class="st">&#39;diamond&#39;</span><span class="op">,</span> </span>
<span id="cb47-67"><a href="#cb47-67" tabindex="-1"></a>      <span class="dt">pointSize</span><span class="op">:</span> <span class="dv">4</span><span class="op">,</span> <span class="dt">width</span><span class="op">:</span> <span class="dv">1</span><span class="op">,</span> <span class="dt">fillColor</span><span class="op">:</span> color}<span class="op">;</span></span>
<span id="cb47-68"><a href="#cb47-68" tabindex="-1"></a>    <span class="cf">return</span> gcps<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;landcover&#39;</span><span class="op">,</span> lc))</span>
<span id="cb47-69"><a href="#cb47-69" tabindex="-1"></a>                <span class="op">.</span><span class="fu">map</span>(<span class="kw">function</span>(point){</span>
<span id="cb47-70"><a href="#cb47-70" tabindex="-1"></a>                  <span class="cf">return</span> point<span class="op">.</span><span class="fu">set</span>(<span class="st">&#39;style&#39;</span><span class="op">,</span> markerStyle)</span>
<span id="cb47-71"><a href="#cb47-71" tabindex="-1"></a>                })</span>
<span id="cb47-72"><a href="#cb47-72" tabindex="-1"></a>      }))<span class="op">.</span><span class="fu">flatten</span>()<span class="op">;</span></span>
<span id="cb47-73"><a href="#cb47-73" tabindex="-1"></a>      </span>
<span id="cb47-74"><a href="#cb47-74" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(gcpsStyled<span class="op">.</span><span class="fu">style</span>({<span class="dt">styleProperty</span><span class="op">:</span><span class="st">&quot;style&quot;</span>})<span class="op">,</span> {}<span class="op">,</span> <span class="st">&#39;GCPs&#39;</span>)</span>
<span id="cb47-75"><a href="#cb47-75" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">centerObject</span>(gcpsStyled)</span></code></pre></div>
<div class="figure" style="text-align: center">
<img src="images/gee_water_resources_management/classified.png" alt="Supervised Classification Output" width="100%" />
<p class="caption">
Supervised Classification Output
</p>
</div>
<div id="exercise-24" class="section level3">
<h3>Exercise</h3>
<p><a
href="https://code.earthengine.google.com/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3A04-Land_Use_Land_Cover_Classification%2F01c_Basic_Supervised_Classification_(exercise)"
target="_blank">Try in Code Editor ↗</a></p>
<p>Select and city of your choice from <code>urbanAreas</code> data.
Create Feature collection with property <code>landcover</code> and
collect training points for every four classes <em>urban, bare,
water</em>, and <em>vegetation</em>. Then use the code to classify and
create a land cover of the city.</p>
<div class="sourceCode" id="cb48"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb48-1"><a href="#cb48-1" tabindex="-1"></a><span class="kw">var</span> s2 <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&#39;COPERNICUS/S2_SR_HARMONIZED&#39;</span>)<span class="op">;</span></span>
<span id="cb48-2"><a href="#cb48-2" tabindex="-1"></a></span>
<span id="cb48-3"><a href="#cb48-3" tabindex="-1"></a><span class="co">// Perform supervised classification for your city</span></span>
<span id="cb48-4"><a href="#cb48-4" tabindex="-1"></a></span>
<span id="cb48-5"><a href="#cb48-5" tabindex="-1"></a><span class="co">// Delete the geometry below and draw a polygon</span></span>
<span id="cb48-6"><a href="#cb48-6" tabindex="-1"></a><span class="co">// over your chosen city</span></span>
<span id="cb48-7"><a href="#cb48-7" tabindex="-1"></a><span class="kw">var</span> geometry <span class="op">=</span> ee<span class="op">.</span><span class="at">Geometry</span><span class="op">.</span><span class="fu">Polygon</span>([[</span>
<span id="cb48-8"><a href="#cb48-8" tabindex="-1"></a>  [<span class="fl">77.4149</span><span class="op">,</span> <span class="fl">13.1203</span>]<span class="op">,</span></span>
<span id="cb48-9"><a href="#cb48-9" tabindex="-1"></a>  [<span class="fl">77.4149</span><span class="op">,</span> <span class="fl">12.7308</span>]<span class="op">,</span></span>
<span id="cb48-10"><a href="#cb48-10" tabindex="-1"></a>  [<span class="fl">77.8090</span><span class="op">,</span> <span class="fl">12.7308</span>]<span class="op">,</span></span>
<span id="cb48-11"><a href="#cb48-11" tabindex="-1"></a>  [<span class="fl">77.8090</span><span class="op">,</span> <span class="fl">13.1203</span>]</span>
<span id="cb48-12"><a href="#cb48-12" tabindex="-1"></a>]])<span class="op">;</span></span>
<span id="cb48-13"><a href="#cb48-13" tabindex="-1"></a>          </span>
<span id="cb48-14"><a href="#cb48-14" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">centerObject</span>(geometry)<span class="op">;</span></span>
<span id="cb48-15"><a href="#cb48-15" tabindex="-1"></a></span>
<span id="cb48-16"><a href="#cb48-16" tabindex="-1"></a><span class="kw">var</span> filtered <span class="op">=</span> s2</span>
<span id="cb48-17"><a href="#cb48-17" tabindex="-1"></a><span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">lt</span>(<span class="st">&#39;CLOUDY_PIXEL_PERCENTAGE&#39;</span><span class="op">,</span> <span class="dv">30</span>))</span>
<span id="cb48-18"><a href="#cb48-18" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(<span class="st">&#39;2019-01-01&#39;</span><span class="op">,</span> <span class="st">&#39;2020-01-01&#39;</span>))</span>
<span id="cb48-19"><a href="#cb48-19" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">bounds</span>(geometry))</span>
<span id="cb48-20"><a href="#cb48-20" tabindex="-1"></a>  <span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;B.*&#39;</span>)<span class="op">;</span></span>
<span id="cb48-21"><a href="#cb48-21" tabindex="-1"></a></span>
<span id="cb48-22"><a href="#cb48-22" tabindex="-1"></a><span class="kw">var</span> composite <span class="op">=</span> filtered<span class="op">.</span><span class="fu">median</span>()<span class="op">;</span></span>
<span id="cb48-23"><a href="#cb48-23" tabindex="-1"></a></span>
<span id="cb48-24"><a href="#cb48-24" tabindex="-1"></a><span class="co">// Display the input composite.</span></span>
<span id="cb48-25"><a href="#cb48-25" tabindex="-1"></a></span>
<span id="cb48-26"><a href="#cb48-26" tabindex="-1"></a><span class="kw">var</span> rgbVis <span class="op">=</span> {<span class="dt">min</span><span class="op">:</span> <span class="fl">0.0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span> <span class="dv">3000</span><span class="op">,</span> <span class="dt">bands</span><span class="op">:</span> [<span class="st">&#39;B4&#39;</span><span class="op">,</span> <span class="st">&#39;B3&#39;</span><span class="op">,</span> <span class="st">&#39;B2&#39;</span>]}<span class="op">;</span></span>
<span id="cb48-27"><a href="#cb48-27" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(composite<span class="op">.</span><span class="fu">clip</span>(geometry)<span class="op">,</span> rgbVis<span class="op">,</span> <span class="st">&#39;image&#39;</span>)<span class="op">;</span></span>
<span id="cb48-28"><a href="#cb48-28" tabindex="-1"></a></span>
<span id="cb48-29"><a href="#cb48-29" tabindex="-1"></a><span class="co">// Exercise</span></span>
<span id="cb48-30"><a href="#cb48-30" tabindex="-1"></a><span class="co">// Add training points for 4 classes</span></span>
<span id="cb48-31"><a href="#cb48-31" tabindex="-1"></a><span class="co">// Assign the &#39;landcover&#39; property as follows</span></span>
<span id="cb48-32"><a href="#cb48-32" tabindex="-1"></a></span>
<span id="cb48-33"><a href="#cb48-33" tabindex="-1"></a><span class="co">// urban: 0</span></span>
<span id="cb48-34"><a href="#cb48-34" tabindex="-1"></a><span class="co">// bare: 1</span></span>
<span id="cb48-35"><a href="#cb48-35" tabindex="-1"></a><span class="co">// water: 2</span></span>
<span id="cb48-36"><a href="#cb48-36" tabindex="-1"></a><span class="co">// vegetation: 3</span></span>
<span id="cb48-37"><a href="#cb48-37" tabindex="-1"></a></span>
<span id="cb48-38"><a href="#cb48-38" tabindex="-1"></a><span class="co">// After adding points, uncomments lines below</span></span>
<span id="cb48-39"><a href="#cb48-39" tabindex="-1"></a></span>
<span id="cb48-40"><a href="#cb48-40" tabindex="-1"></a><span class="co">// var gcps = urban.merge(bare).merge(water).merge(vegetation);</span></span>
<span id="cb48-41"><a href="#cb48-41" tabindex="-1"></a></span>
<span id="cb48-42"><a href="#cb48-42" tabindex="-1"></a><span class="co">// // Overlay the point on the image to get training data.</span></span>
<span id="cb48-43"><a href="#cb48-43" tabindex="-1"></a><span class="co">// var training = composite.sampleRegions({</span></span>
<span id="cb48-44"><a href="#cb48-44" tabindex="-1"></a><span class="co">//   collection: gcps, </span></span>
<span id="cb48-45"><a href="#cb48-45" tabindex="-1"></a><span class="co">//   properties: [&#39;landcover&#39;], </span></span>
<span id="cb48-46"><a href="#cb48-46" tabindex="-1"></a><span class="co">//   scale: 10,</span></span>
<span id="cb48-47"><a href="#cb48-47" tabindex="-1"></a><span class="co">//   tileScale: 16</span></span>
<span id="cb48-48"><a href="#cb48-48" tabindex="-1"></a><span class="co">// });</span></span>
<span id="cb48-49"><a href="#cb48-49" tabindex="-1"></a><span class="co">// print(training);</span></span>
<span id="cb48-50"><a href="#cb48-50" tabindex="-1"></a></span>
<span id="cb48-51"><a href="#cb48-51" tabindex="-1"></a></span>
<span id="cb48-52"><a href="#cb48-52" tabindex="-1"></a><span class="co">// // Train a classifier.</span></span>
<span id="cb48-53"><a href="#cb48-53" tabindex="-1"></a><span class="co">// var classifier = ee.Classifier.smileRandomForest(50).train({</span></span>
<span id="cb48-54"><a href="#cb48-54" tabindex="-1"></a><span class="co">//   features: training,  </span></span>
<span id="cb48-55"><a href="#cb48-55" tabindex="-1"></a><span class="co">//   classProperty: &#39;landcover&#39;, </span></span>
<span id="cb48-56"><a href="#cb48-56" tabindex="-1"></a><span class="co">//   inputProperties: composite.bandNames()</span></span>
<span id="cb48-57"><a href="#cb48-57" tabindex="-1"></a><span class="co">// });</span></span>
<span id="cb48-58"><a href="#cb48-58" tabindex="-1"></a><span class="co">// // // Classify the image.</span></span>
<span id="cb48-59"><a href="#cb48-59" tabindex="-1"></a><span class="co">// var classified = composite.classify(classifier);</span></span>
<span id="cb48-60"><a href="#cb48-60" tabindex="-1"></a></span>
<span id="cb48-61"><a href="#cb48-61" tabindex="-1"></a><span class="co">// // Choose a 4-color palette</span></span>
<span id="cb48-62"><a href="#cb48-62" tabindex="-1"></a><span class="co">// // Assign a color for each class in the following order</span></span>
<span id="cb48-63"><a href="#cb48-63" tabindex="-1"></a><span class="co">// // Urban, Bare, Water, Vegetation</span></span>
<span id="cb48-64"><a href="#cb48-64" tabindex="-1"></a><span class="co">// var palette = [&#39;#cc6d8f&#39;, &#39;#ffc107&#39;, &#39;#1e88e5&#39;, &#39;#004d40&#39; ];</span></span>
<span id="cb48-65"><a href="#cb48-65" tabindex="-1"></a></span>
<span id="cb48-66"><a href="#cb48-66" tabindex="-1"></a><span class="co">// Map.addLayer(classified.clip(geometry), {min: 0, max: 3, palette: palette}, &#39;2019&#39;);</span></span>
<span id="cb48-67"><a href="#cb48-67" tabindex="-1"></a></span>
<span id="cb48-68"><a href="#cb48-68" tabindex="-1"></a><span class="co">// // Select the Water class</span></span>
<span id="cb48-69"><a href="#cb48-69" tabindex="-1"></a><span class="co">// var water = classified.eq(2);</span></span>
<span id="cb48-70"><a href="#cb48-70" tabindex="-1"></a><span class="co">// var waterVis = {min:0, max:1, palette: [&#39;white&#39;, &#39;blue&#39;]};</span></span>
<span id="cb48-71"><a href="#cb48-71" tabindex="-1"></a><span class="co">// Map.addLayer(water.clip(geometry), waterVis, &#39;Water&#39;);</span></span></code></pre></div>
</div>
</div>
<div id="accuracy-assessment" class="section level2">
<h2>02. Accuracy Assessment</h2>
<p>It is important to get a quantitative estimate of the accuracy of the
classification. To do this, a common strategy is to divide your training
samples into 2 random fractions - one used for <em>training</em> the
model and the other for <em>validation</em> of the predictions. Once a
classifier is trained, it can be used to classify the entire image. We
can then compare the classified values with the ones in the validation
fraction. We can use the <code>ee.Classifier.confusionMatrix()</code>
method to calculate a <em>Confusion Matrix</em> representing expected
accuracy.</p>
<blockquote>
<p>Don’t get carried away tweaking your model to give you the highest
validation accuracy. You must use both qualitative measures (such as
visual inspection of results) along with quantitative measures to assess
the results.</p>
</blockquote>
<p><a
href="https://code.earthengine.google.com/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3A04-Land_Use_Land_Cover_Classification%2F02b_Accuracy_Assessment_(complete)"
target="_blank">Open in Code Editor ↗</a></p>
<div class="sourceCode" id="cb49"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb49-1"><a href="#cb49-1" tabindex="-1"></a><span class="kw">var</span> s2 <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&#39;COPERNICUS/S2_SR_HARMONIZED&#39;</span>)<span class="op">;</span></span>
<span id="cb49-2"><a href="#cb49-2" tabindex="-1"></a><span class="kw">var</span> basin <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">&quot;WWF/HydroSHEDS/v1/Basins/hybas_7&quot;</span>)<span class="op">;</span></span>
<span id="cb49-3"><a href="#cb49-3" tabindex="-1"></a><span class="kw">var</span> gcp <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">&quot;users/ujavalgandhi/e2e/arkavathy_gcps&quot;</span>)<span class="op">;</span></span>
<span id="cb49-4"><a href="#cb49-4" tabindex="-1"></a>    </span>
<span id="cb49-5"><a href="#cb49-5" tabindex="-1"></a><span class="kw">var</span> arkavathy <span class="op">=</span> basin<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;HYBAS_ID&#39;</span><span class="op">,</span> <span class="dv">4071139640</span>))<span class="op">;</span></span>
<span id="cb49-6"><a href="#cb49-6" tabindex="-1"></a><span class="kw">var</span> geometry <span class="op">=</span> arkavathy<span class="op">.</span><span class="fu">geometry</span>()<span class="op">;</span></span>
<span id="cb49-7"><a href="#cb49-7" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">centerObject</span>(geometry)<span class="op">;</span></span>
<span id="cb49-8"><a href="#cb49-8" tabindex="-1"></a></span>
<span id="cb49-9"><a href="#cb49-9" tabindex="-1"></a><span class="kw">var</span> rgbVis <span class="op">=</span> {</span>
<span id="cb49-10"><a href="#cb49-10" tabindex="-1"></a>  <span class="dt">min</span><span class="op">:</span> <span class="fl">0.0</span><span class="op">,</span></span>
<span id="cb49-11"><a href="#cb49-11" tabindex="-1"></a>  <span class="dt">max</span><span class="op">:</span> <span class="dv">3000</span><span class="op">,</span></span>
<span id="cb49-12"><a href="#cb49-12" tabindex="-1"></a>  <span class="dt">bands</span><span class="op">:</span> [<span class="st">&#39;B4&#39;</span><span class="op">,</span> <span class="st">&#39;B3&#39;</span><span class="op">,</span> <span class="st">&#39;B2&#39;</span>]<span class="op">,</span></span>
<span id="cb49-13"><a href="#cb49-13" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb49-14"><a href="#cb49-14" tabindex="-1"></a> </span>
<span id="cb49-15"><a href="#cb49-15" tabindex="-1"></a><span class="kw">var</span> filtered <span class="op">=</span> s2</span>
<span id="cb49-16"><a href="#cb49-16" tabindex="-1"></a><span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">lt</span>(<span class="st">&#39;CLOUDY_PIXEL_PERCENTAGE&#39;</span><span class="op">,</span> <span class="dv">30</span>))</span>
<span id="cb49-17"><a href="#cb49-17" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(<span class="st">&#39;2019-01-01&#39;</span><span class="op">,</span> <span class="st">&#39;2020-01-01&#39;</span>))</span>
<span id="cb49-18"><a href="#cb49-18" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">bounds</span>(geometry))</span>
<span id="cb49-19"><a href="#cb49-19" tabindex="-1"></a>  <span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;B.*&#39;</span>)<span class="op">;</span></span>
<span id="cb49-20"><a href="#cb49-20" tabindex="-1"></a></span>
<span id="cb49-21"><a href="#cb49-21" tabindex="-1"></a><span class="kw">var</span> composite <span class="op">=</span> filtered<span class="op">.</span><span class="fu">median</span>()<span class="op">;</span></span>
<span id="cb49-22"><a href="#cb49-22" tabindex="-1"></a></span>
<span id="cb49-23"><a href="#cb49-23" tabindex="-1"></a><span class="co">// Display the input composite.</span></span>
<span id="cb49-24"><a href="#cb49-24" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(composite<span class="op">.</span><span class="fu">clip</span>(geometry)<span class="op">,</span> rgbVis<span class="op">,</span> <span class="st">&#39;image&#39;</span>)<span class="op">;</span></span>
<span id="cb49-25"><a href="#cb49-25" tabindex="-1"></a></span>
<span id="cb49-26"><a href="#cb49-26" tabindex="-1"></a></span>
<span id="cb49-27"><a href="#cb49-27" tabindex="-1"></a><span class="co">// Add a random column and split the GCPs into training and validation set</span></span>
<span id="cb49-28"><a href="#cb49-28" tabindex="-1"></a><span class="kw">var</span> gcp <span class="op">=</span> gcp<span class="op">.</span><span class="fu">randomColumn</span>()<span class="op">;</span></span>
<span id="cb49-29"><a href="#cb49-29" tabindex="-1"></a></span>
<span id="cb49-30"><a href="#cb49-30" tabindex="-1"></a><span class="co">// This being a simpler classification, we take 60% points</span></span>
<span id="cb49-31"><a href="#cb49-31" tabindex="-1"></a><span class="co">// for validation. Normal recommended ratio is</span></span>
<span id="cb49-32"><a href="#cb49-32" tabindex="-1"></a><span class="co">// 70% training, 30% validation</span></span>
<span id="cb49-33"><a href="#cb49-33" tabindex="-1"></a><span class="kw">var</span> trainingGcp <span class="op">=</span> gcp<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">lt</span>(<span class="st">&#39;random&#39;</span><span class="op">,</span> <span class="fl">0.6</span>))<span class="op">;</span></span>
<span id="cb49-34"><a href="#cb49-34" tabindex="-1"></a><span class="kw">var</span> validationGcp <span class="op">=</span> gcp<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">gte</span>(<span class="st">&#39;random&#39;</span><span class="op">,</span> <span class="fl">0.6</span>))<span class="op">;</span></span>
<span id="cb49-35"><a href="#cb49-35" tabindex="-1"></a></span>
<span id="cb49-36"><a href="#cb49-36" tabindex="-1"></a><span class="co">// Overlay the point on the image to get training data.</span></span>
<span id="cb49-37"><a href="#cb49-37" tabindex="-1"></a><span class="kw">var</span> training <span class="op">=</span> composite<span class="op">.</span><span class="fu">sampleRegions</span>({</span>
<span id="cb49-38"><a href="#cb49-38" tabindex="-1"></a>  <span class="dt">collection</span><span class="op">:</span> trainingGcp<span class="op">,</span></span>
<span id="cb49-39"><a href="#cb49-39" tabindex="-1"></a>  <span class="dt">properties</span><span class="op">:</span> [<span class="st">&#39;landcover&#39;</span>]<span class="op">,</span></span>
<span id="cb49-40"><a href="#cb49-40" tabindex="-1"></a>  <span class="dt">scale</span><span class="op">:</span> <span class="dv">10</span><span class="op">,</span></span>
<span id="cb49-41"><a href="#cb49-41" tabindex="-1"></a>  <span class="dt">tileScale</span><span class="op">:</span> <span class="dv">16</span></span>
<span id="cb49-42"><a href="#cb49-42" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb49-43"><a href="#cb49-43" tabindex="-1"></a></span>
<span id="cb49-44"><a href="#cb49-44" tabindex="-1"></a><span class="co">// Train a classifier.</span></span>
<span id="cb49-45"><a href="#cb49-45" tabindex="-1"></a><span class="kw">var</span> classifier <span class="op">=</span> ee<span class="op">.</span><span class="at">Classifier</span><span class="op">.</span><span class="fu">smileRandomForest</span>(<span class="dv">50</span>)</span>
<span id="cb49-46"><a href="#cb49-46" tabindex="-1"></a><span class="op">.</span><span class="fu">train</span>({</span>
<span id="cb49-47"><a href="#cb49-47" tabindex="-1"></a>  <span class="dt">features</span><span class="op">:</span> training<span class="op">,</span>  </span>
<span id="cb49-48"><a href="#cb49-48" tabindex="-1"></a>  <span class="dt">classProperty</span><span class="op">:</span> <span class="st">&#39;landcover&#39;</span><span class="op">,</span></span>
<span id="cb49-49"><a href="#cb49-49" tabindex="-1"></a>  <span class="dt">inputProperties</span><span class="op">:</span> composite<span class="op">.</span><span class="fu">bandNames</span>()</span>
<span id="cb49-50"><a href="#cb49-50" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb49-51"><a href="#cb49-51" tabindex="-1"></a></span>
<span id="cb49-52"><a href="#cb49-52" tabindex="-1"></a><span class="co">// Classify the image.</span></span>
<span id="cb49-53"><a href="#cb49-53" tabindex="-1"></a><span class="kw">var</span> classified <span class="op">=</span> composite<span class="op">.</span><span class="fu">classify</span>(classifier)<span class="op">;</span></span>
<span id="cb49-54"><a href="#cb49-54" tabindex="-1"></a></span>
<span id="cb49-55"><a href="#cb49-55" tabindex="-1"></a><span class="kw">var</span> palette <span class="op">=</span> [<span class="st">&#39;#cc6d8f&#39;</span><span class="op">,</span> <span class="st">&#39;#ffc107&#39;</span><span class="op">,</span> <span class="st">&#39;#1e88e5&#39;</span><span class="op">,</span> <span class="st">&#39;#004d40&#39;</span> ]<span class="op">;</span></span>
<span id="cb49-56"><a href="#cb49-56" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(classified<span class="op">.</span><span class="fu">clip</span>(geometry)<span class="op">,</span> {<span class="dt">min</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span> <span class="dv">3</span><span class="op">,</span> <span class="dt">palette</span><span class="op">:</span> palette}<span class="op">,</span> <span class="st">&#39;2019&#39;</span>)<span class="op">;</span></span>
<span id="cb49-57"><a href="#cb49-57" tabindex="-1"></a><span class="co">//************************************************************************** </span></span>
<span id="cb49-58"><a href="#cb49-58" tabindex="-1"></a><span class="co">// Accuracy Assessment</span></span>
<span id="cb49-59"><a href="#cb49-59" tabindex="-1"></a><span class="co">//************************************************************************** </span></span>
<span id="cb49-60"><a href="#cb49-60" tabindex="-1"></a></span>
<span id="cb49-61"><a href="#cb49-61" tabindex="-1"></a><span class="co">// Use classification map to assess accuracy using the validation fraction</span></span>
<span id="cb49-62"><a href="#cb49-62" tabindex="-1"></a><span class="co">// of the overall training set created above.</span></span>
<span id="cb49-63"><a href="#cb49-63" tabindex="-1"></a><span class="kw">var</span> test <span class="op">=</span> classified<span class="op">.</span><span class="fu">sampleRegions</span>({</span>
<span id="cb49-64"><a href="#cb49-64" tabindex="-1"></a>  <span class="dt">collection</span><span class="op">:</span> validationGcp<span class="op">,</span></span>
<span id="cb49-65"><a href="#cb49-65" tabindex="-1"></a>  <span class="dt">properties</span><span class="op">:</span> [<span class="st">&#39;landcover&#39;</span>]<span class="op">,</span></span>
<span id="cb49-66"><a href="#cb49-66" tabindex="-1"></a>  <span class="dt">tileScale</span><span class="op">:</span> <span class="dv">16</span><span class="op">,</span></span>
<span id="cb49-67"><a href="#cb49-67" tabindex="-1"></a>  <span class="dt">scale</span><span class="op">:</span> <span class="dv">10</span><span class="op">,</span></span>
<span id="cb49-68"><a href="#cb49-68" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb49-69"><a href="#cb49-69" tabindex="-1"></a></span>
<span id="cb49-70"><a href="#cb49-70" tabindex="-1"></a><span class="kw">var</span> testConfusionMatrix <span class="op">=</span> test<span class="op">.</span><span class="fu">errorMatrix</span>(<span class="st">&#39;landcover&#39;</span><span class="op">,</span> <span class="st">&#39;classification&#39;</span>)</span>
<span id="cb49-71"><a href="#cb49-71" tabindex="-1"></a><span class="co">// Printing of confusion matrix may time out. Alternatively, you can export it as CSV</span></span>
<span id="cb49-72"><a href="#cb49-72" tabindex="-1"></a><span class="fu">print</span>(<span class="st">&#39;Confusion Matrix&#39;</span><span class="op">,</span> testConfusionMatrix)<span class="op">;</span></span>
<span id="cb49-73"><a href="#cb49-73" tabindex="-1"></a><span class="fu">print</span>(<span class="st">&#39;Test Accuracy&#39;</span><span class="op">,</span> testConfusionMatrix<span class="op">.</span><span class="fu">accuracy</span>())<span class="op">;</span></span>
<span id="cb49-74"><a href="#cb49-74" tabindex="-1"></a></span>
<span id="cb49-75"><a href="#cb49-75" tabindex="-1"></a><span class="co">// Alternate workflow </span></span>
<span id="cb49-76"><a href="#cb49-76" tabindex="-1"></a><span class="co">// This is similar to machine learning practice</span></span>
<span id="cb49-77"><a href="#cb49-77" tabindex="-1"></a><span class="kw">var</span> validation <span class="op">=</span> composite<span class="op">.</span><span class="fu">sampleRegions</span>({</span>
<span id="cb49-78"><a href="#cb49-78" tabindex="-1"></a>  <span class="dt">collection</span><span class="op">:</span> validationGcp<span class="op">,</span></span>
<span id="cb49-79"><a href="#cb49-79" tabindex="-1"></a>  <span class="dt">properties</span><span class="op">:</span> [<span class="st">&#39;landcover&#39;</span>]<span class="op">,</span></span>
<span id="cb49-80"><a href="#cb49-80" tabindex="-1"></a>  <span class="dt">scale</span><span class="op">:</span> <span class="dv">10</span><span class="op">,</span></span>
<span id="cb49-81"><a href="#cb49-81" tabindex="-1"></a>  <span class="dt">tileScale</span><span class="op">:</span> <span class="dv">16</span></span>
<span id="cb49-82"><a href="#cb49-82" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb49-83"><a href="#cb49-83" tabindex="-1"></a></span>
<span id="cb49-84"><a href="#cb49-84" tabindex="-1"></a><span class="kw">var</span> test <span class="op">=</span> validation<span class="op">.</span><span class="fu">classify</span>(classifier)<span class="op">;</span></span>
<span id="cb49-85"><a href="#cb49-85" tabindex="-1"></a></span>
<span id="cb49-86"><a href="#cb49-86" tabindex="-1"></a><span class="kw">var</span> testConfusionMatrix <span class="op">=</span> test<span class="op">.</span><span class="fu">errorMatrix</span>(<span class="st">&#39;landcover&#39;</span><span class="op">,</span> <span class="st">&#39;classification&#39;</span>)</span>
<span id="cb49-87"><a href="#cb49-87" tabindex="-1"></a><span class="co">// Printing of confusion matrix may time out. Alternatively, you can export it as CSV</span></span>
<span id="cb49-88"><a href="#cb49-88" tabindex="-1"></a><span class="fu">print</span>(<span class="st">&#39;Confusion Matrix&#39;</span><span class="op">,</span> testConfusionMatrix)<span class="op">;</span></span>
<span id="cb49-89"><a href="#cb49-89" tabindex="-1"></a><span class="fu">print</span>(<span class="st">&#39;Test Accuracy&#39;</span><span class="op">,</span> testConfusionMatrix<span class="op">.</span><span class="fu">accuracy</span>())<span class="op">;</span></span></code></pre></div>
<p>Output</p>
<pre><code>Confusion Matrix
0: [41,4,0,0]
1: [3,43,0,0]
2: [0,0,48,3]
3: [0,0,0,37]

Test Accuracy
0.9441340782122905</code></pre>
</div>
<div id="improving-the-classification" class="section level2">
<h2>03. Improving the Classification</h2>
<p>The Earth Engine data-model is especially well suited for machine
learning tasks because of its ability to easily incorporate data sources
of different spatial resolutions, projections and data types together By
giving additional information to the classifier, it is able to separate
different classes easily. Here we take the same example and augment it
with the following techniques</p>
<ul>
<li><em>Apply Cloud Masking</em></li>
<li><em>Add Spectral Indices</em>: We add bands for different spectral
indices such as - NDVI, NDBI, MNDWI and BSI.</li>
<li><em>Add Elevation and Slope</em>: We also add slope and elevation
bands from the ALOS DEM.</li>
<li><em>Normalize the Inputs</em>: Machine learning models work best
when all the inputs have the same scale. We will divide each band with
the maximum value. This method ensures that all input values are between
0-1.</li>
</ul>
<p>Our training features have more parameters and contain values of the
same scale. The result is a much improved classification.</p>
<p><a
href="https://code.earthengine.google.com/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3A04-Land_Use_Land_Cover_Classification%2F03b_Improving_the_Classification_(complete)"
target="_blank">Open in Code Editor ↗</a></p>
<div class="sourceCode" id="cb51"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb51-1"><a href="#cb51-1" tabindex="-1"></a><span class="kw">var</span> s2 <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&#39;COPERNICUS/S2_SR_HARMONIZED&#39;</span>)<span class="op">;</span></span>
<span id="cb51-2"><a href="#cb51-2" tabindex="-1"></a><span class="kw">var</span> basin <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">&#39;WWF/HydroSHEDS/v1/Basins/hybas_7&#39;</span>)<span class="op">;</span></span>
<span id="cb51-3"><a href="#cb51-3" tabindex="-1"></a><span class="kw">var</span> gcp <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">&#39;users/ujavalgandhi/e2e/arkavathy_gcps&#39;</span>)<span class="op">;</span></span>
<span id="cb51-4"><a href="#cb51-4" tabindex="-1"></a><span class="kw">var</span> alos <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(<span class="st">&#39;JAXA/ALOS/AW3D30/V2_2&#39;</span>)<span class="op">;</span></span>
<span id="cb51-5"><a href="#cb51-5" tabindex="-1"></a></span>
<span id="cb51-6"><a href="#cb51-6" tabindex="-1"></a></span>
<span id="cb51-7"><a href="#cb51-7" tabindex="-1"></a><span class="kw">var</span> arkavathy <span class="op">=</span> basin<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;HYBAS_ID&#39;</span><span class="op">,</span> <span class="dv">4071139640</span>))<span class="op">;</span></span>
<span id="cb51-8"><a href="#cb51-8" tabindex="-1"></a><span class="kw">var</span> geometry <span class="op">=</span> arkavathy<span class="op">.</span><span class="fu">geometry</span>()<span class="op">;</span></span>
<span id="cb51-9"><a href="#cb51-9" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">centerObject</span>(geometry)<span class="op">;</span></span>
<span id="cb51-10"><a href="#cb51-10" tabindex="-1"></a></span>
<span id="cb51-11"><a href="#cb51-11" tabindex="-1"></a><span class="kw">var</span> rgbVis <span class="op">=</span> {</span>
<span id="cb51-12"><a href="#cb51-12" tabindex="-1"></a>  <span class="dt">min</span><span class="op">:</span> <span class="fl">0.0</span><span class="op">,</span></span>
<span id="cb51-13"><a href="#cb51-13" tabindex="-1"></a>  <span class="dt">max</span><span class="op">:</span> <span class="dv">3000</span><span class="op">,</span></span>
<span id="cb51-14"><a href="#cb51-14" tabindex="-1"></a>  <span class="dt">bands</span><span class="op">:</span> [<span class="st">&#39;B4&#39;</span><span class="op">,</span> <span class="st">&#39;B3&#39;</span><span class="op">,</span> <span class="st">&#39;B2&#39;</span>]<span class="op">,</span></span>
<span id="cb51-15"><a href="#cb51-15" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb51-16"><a href="#cb51-16" tabindex="-1"></a><span class="co">// Function to remove cloud and snow pixels from Sentinel-2 SR image</span></span>
<span id="cb51-17"><a href="#cb51-17" tabindex="-1"></a></span>
<span id="cb51-18"><a href="#cb51-18" tabindex="-1"></a><span class="kw">function</span> <span class="fu">maskCloudAndShadowsSR</span>(image) {</span>
<span id="cb51-19"><a href="#cb51-19" tabindex="-1"></a>  <span class="kw">var</span> cloudProb <span class="op">=</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;MSK_CLDPRB&#39;</span>)<span class="op">;</span></span>
<span id="cb51-20"><a href="#cb51-20" tabindex="-1"></a>  <span class="kw">var</span> snowProb <span class="op">=</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;MSK_SNWPRB&#39;</span>)<span class="op">;</span></span>
<span id="cb51-21"><a href="#cb51-21" tabindex="-1"></a>  <span class="kw">var</span> cloud <span class="op">=</span> cloudProb<span class="op">.</span><span class="fu">lt</span>(<span class="dv">10</span>)<span class="op">;</span></span>
<span id="cb51-22"><a href="#cb51-22" tabindex="-1"></a>  <span class="kw">var</span> scl <span class="op">=</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;SCL&#39;</span>)<span class="op">;</span> </span>
<span id="cb51-23"><a href="#cb51-23" tabindex="-1"></a>  <span class="kw">var</span> shadow <span class="op">=</span> scl<span class="op">.</span><span class="fu">eq</span>(<span class="dv">3</span>)<span class="op">;</span> <span class="co">// 3 = cloud shadow</span></span>
<span id="cb51-24"><a href="#cb51-24" tabindex="-1"></a>  <span class="kw">var</span> cirrus <span class="op">=</span> scl<span class="op">.</span><span class="fu">eq</span>(<span class="dv">10</span>)<span class="op">;</span> <span class="co">// 10 = cirrus</span></span>
<span id="cb51-25"><a href="#cb51-25" tabindex="-1"></a>  <span class="co">// Cloud probability less than 10% or cloud shadow classification</span></span>
<span id="cb51-26"><a href="#cb51-26" tabindex="-1"></a>  <span class="kw">var</span> mask <span class="op">=</span> cloud<span class="op">.</span><span class="fu">and</span>(cirrus<span class="op">.</span><span class="fu">neq</span>(<span class="dv">1</span>))<span class="op">.</span><span class="fu">and</span>(shadow<span class="op">.</span><span class="fu">neq</span>(<span class="dv">1</span>))<span class="op">;</span></span>
<span id="cb51-27"><a href="#cb51-27" tabindex="-1"></a>  <span class="cf">return</span> image<span class="op">.</span><span class="fu">updateMask</span>(mask)<span class="op">;</span></span>
<span id="cb51-28"><a href="#cb51-28" tabindex="-1"></a>}</span>
<span id="cb51-29"><a href="#cb51-29" tabindex="-1"></a></span>
<span id="cb51-30"><a href="#cb51-30" tabindex="-1"></a></span>
<span id="cb51-31"><a href="#cb51-31" tabindex="-1"></a><span class="kw">var</span> filtered <span class="op">=</span> s2</span>
<span id="cb51-32"><a href="#cb51-32" tabindex="-1"></a><span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">lt</span>(<span class="st">&#39;CLOUDY_PIXEL_PERCENTAGE&#39;</span><span class="op">,</span> <span class="dv">30</span>))</span>
<span id="cb51-33"><a href="#cb51-33" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(<span class="st">&#39;2019-01-01&#39;</span><span class="op">,</span> <span class="st">&#39;2020-01-01&#39;</span>))</span>
<span id="cb51-34"><a href="#cb51-34" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">bounds</span>(geometry))</span>
<span id="cb51-35"><a href="#cb51-35" tabindex="-1"></a>  <span class="op">.</span><span class="fu">map</span>(maskCloudAndShadowsSR)</span>
<span id="cb51-36"><a href="#cb51-36" tabindex="-1"></a>  <span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;B.*&#39;</span>)<span class="op">;</span></span>
<span id="cb51-37"><a href="#cb51-37" tabindex="-1"></a></span>
<span id="cb51-38"><a href="#cb51-38" tabindex="-1"></a><span class="kw">var</span> composite <span class="op">=</span> filtered<span class="op">.</span><span class="fu">median</span>()<span class="op">;</span></span>
<span id="cb51-39"><a href="#cb51-39" tabindex="-1"></a></span>
<span id="cb51-40"><a href="#cb51-40" tabindex="-1"></a></span>
<span id="cb51-41"><a href="#cb51-41" tabindex="-1"></a><span class="kw">var</span> addIndices <span class="op">=</span> <span class="kw">function</span>(image) {</span>
<span id="cb51-42"><a href="#cb51-42" tabindex="-1"></a>  <span class="kw">var</span> ndvi <span class="op">=</span> image<span class="op">.</span><span class="fu">normalizedDifference</span>([<span class="st">&#39;B8&#39;</span><span class="op">,</span> <span class="st">&#39;B4&#39;</span>])<span class="op">.</span><span class="fu">rename</span>([<span class="st">&#39;ndvi&#39;</span>])<span class="op">;</span></span>
<span id="cb51-43"><a href="#cb51-43" tabindex="-1"></a>  <span class="kw">var</span> ndbi <span class="op">=</span> image<span class="op">.</span><span class="fu">normalizedDifference</span>([<span class="st">&#39;B11&#39;</span><span class="op">,</span> <span class="st">&#39;B8&#39;</span>])<span class="op">.</span><span class="fu">rename</span>([<span class="st">&#39;ndbi&#39;</span>])<span class="op">;</span></span>
<span id="cb51-44"><a href="#cb51-44" tabindex="-1"></a>  <span class="kw">var</span> mndwi <span class="op">=</span> image<span class="op">.</span><span class="fu">normalizedDifference</span>([<span class="st">&#39;B3&#39;</span><span class="op">,</span> <span class="st">&#39;B11&#39;</span>])<span class="op">.</span><span class="fu">rename</span>([<span class="st">&#39;mndwi&#39;</span>])<span class="op">;</span> </span>
<span id="cb51-45"><a href="#cb51-45" tabindex="-1"></a>  <span class="kw">var</span> bsi <span class="op">=</span> image<span class="op">.</span><span class="fu">expression</span>(</span>
<span id="cb51-46"><a href="#cb51-46" tabindex="-1"></a>      <span class="st">&#39;(( X + Y ) - (A + B)) /(( X + Y ) + (A + B)) &#39;</span><span class="op">,</span> {</span>
<span id="cb51-47"><a href="#cb51-47" tabindex="-1"></a>        <span class="st">&#39;X&#39;</span><span class="op">:</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;B11&#39;</span>)<span class="op">,</span> <span class="co">//swir1</span></span>
<span id="cb51-48"><a href="#cb51-48" tabindex="-1"></a>        <span class="st">&#39;Y&#39;</span><span class="op">:</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;B4&#39;</span>)<span class="op">,</span>  <span class="co">//red</span></span>
<span id="cb51-49"><a href="#cb51-49" tabindex="-1"></a>        <span class="st">&#39;A&#39;</span><span class="op">:</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;B8&#39;</span>)<span class="op">,</span> <span class="co">// nir</span></span>
<span id="cb51-50"><a href="#cb51-50" tabindex="-1"></a>        <span class="st">&#39;B&#39;</span><span class="op">:</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;B2&#39;</span>)<span class="op">,</span> <span class="co">// blue</span></span>
<span id="cb51-51"><a href="#cb51-51" tabindex="-1"></a>  })<span class="op">.</span><span class="fu">rename</span>(<span class="st">&#39;bsi&#39;</span>)<span class="op">;</span></span>
<span id="cb51-52"><a href="#cb51-52" tabindex="-1"></a>  <span class="cf">return</span> image<span class="op">.</span><span class="fu">addBands</span>(ndvi)<span class="op">.</span><span class="fu">addBands</span>(ndbi)<span class="op">.</span><span class="fu">addBands</span>(mndwi)<span class="op">.</span><span class="fu">addBands</span>(bsi)<span class="op">;</span></span>
<span id="cb51-53"><a href="#cb51-53" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb51-54"><a href="#cb51-54" tabindex="-1"></a></span>
<span id="cb51-55"><a href="#cb51-55" tabindex="-1"></a><span class="kw">var</span> composite <span class="op">=</span> <span class="fu">addIndices</span>(composite)<span class="op">;</span></span>
<span id="cb51-56"><a href="#cb51-56" tabindex="-1"></a></span>
<span id="cb51-57"><a href="#cb51-57" tabindex="-1"></a></span>
<span id="cb51-58"><a href="#cb51-58" tabindex="-1"></a><span class="co">// Calculate Slope and Elevation</span></span>
<span id="cb51-59"><a href="#cb51-59" tabindex="-1"></a><span class="kw">var</span> elev <span class="op">=</span> alos<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;AVE_DSM&#39;</span>)<span class="op">.</span><span class="fu">rename</span>(<span class="st">&#39;elev&#39;</span>)<span class="op">;</span></span>
<span id="cb51-60"><a href="#cb51-60" tabindex="-1"></a><span class="kw">var</span> slope <span class="op">=</span> ee<span class="op">.</span><span class="at">Terrain</span><span class="op">.</span><span class="fu">slope</span>(alos<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;AVE_DSM&#39;</span>))<span class="op">.</span><span class="fu">rename</span>(<span class="st">&#39;slope&#39;</span>)<span class="op">;</span></span>
<span id="cb51-61"><a href="#cb51-61" tabindex="-1"></a></span>
<span id="cb51-62"><a href="#cb51-62" tabindex="-1"></a><span class="kw">var</span> composite <span class="op">=</span> composite<span class="op">.</span><span class="fu">addBands</span>(elev)<span class="op">.</span><span class="fu">addBands</span>(slope)<span class="op">;</span></span>
<span id="cb51-63"><a href="#cb51-63" tabindex="-1"></a></span>
<span id="cb51-64"><a href="#cb51-64" tabindex="-1"></a><span class="kw">var</span> visParams <span class="op">=</span> {<span class="dt">bands</span><span class="op">:</span> [<span class="st">&#39;B4&#39;</span><span class="op">,</span> <span class="st">&#39;B3&#39;</span><span class="op">,</span> <span class="st">&#39;B2&#39;</span>]<span class="op">,</span> <span class="dt">min</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span> <span class="dv">3000</span><span class="op">,</span> <span class="dt">gamma</span><span class="op">:</span> <span class="fl">1.2</span>}<span class="op">;</span></span>
<span id="cb51-65"><a href="#cb51-65" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(composite<span class="op">.</span><span class="fu">clip</span>(geometry)<span class="op">,</span> visParams<span class="op">,</span> <span class="st">&#39;RGB&#39;</span>)<span class="op">;</span></span>
<span id="cb51-66"><a href="#cb51-66" tabindex="-1"></a></span>
<span id="cb51-67"><a href="#cb51-67" tabindex="-1"></a><span class="co">// Normalize the image </span></span>
<span id="cb51-68"><a href="#cb51-68" tabindex="-1"></a></span>
<span id="cb51-69"><a href="#cb51-69" tabindex="-1"></a><span class="co">// Machine learning algorithms work best on images when all features have</span></span>
<span id="cb51-70"><a href="#cb51-70" tabindex="-1"></a><span class="co">// the same range</span></span>
<span id="cb51-71"><a href="#cb51-71" tabindex="-1"></a></span>
<span id="cb51-72"><a href="#cb51-72" tabindex="-1"></a><span class="co">// Function to Normalize Image</span></span>
<span id="cb51-73"><a href="#cb51-73" tabindex="-1"></a><span class="co">// Pixel Values should be between 0 and 1</span></span>
<span id="cb51-74"><a href="#cb51-74" tabindex="-1"></a><span class="co">// Formula is (x - xmin) / (xmax - xmin)</span></span>
<span id="cb51-75"><a href="#cb51-75" tabindex="-1"></a><span class="co">//************************************************************************** </span></span>
<span id="cb51-76"><a href="#cb51-76" tabindex="-1"></a><span class="kw">function</span> <span class="fu">normalize</span>(image){</span>
<span id="cb51-77"><a href="#cb51-77" tabindex="-1"></a>  <span class="kw">var</span> bandNames <span class="op">=</span> image<span class="op">.</span><span class="fu">bandNames</span>()<span class="op">;</span></span>
<span id="cb51-78"><a href="#cb51-78" tabindex="-1"></a>  <span class="co">// Compute min and max of the image</span></span>
<span id="cb51-79"><a href="#cb51-79" tabindex="-1"></a>  <span class="kw">var</span> minDict <span class="op">=</span> image<span class="op">.</span><span class="fu">reduceRegion</span>({</span>
<span id="cb51-80"><a href="#cb51-80" tabindex="-1"></a>    <span class="dt">reducer</span><span class="op">:</span> ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">min</span>()<span class="op">,</span></span>
<span id="cb51-81"><a href="#cb51-81" tabindex="-1"></a>    <span class="dt">geometry</span><span class="op">:</span> geometry<span class="op">,</span></span>
<span id="cb51-82"><a href="#cb51-82" tabindex="-1"></a>    <span class="dt">scale</span><span class="op">:</span> <span class="dv">10</span><span class="op">,</span></span>
<span id="cb51-83"><a href="#cb51-83" tabindex="-1"></a>    <span class="dt">maxPixels</span><span class="op">:</span> <span class="fl">1e9</span><span class="op">,</span></span>
<span id="cb51-84"><a href="#cb51-84" tabindex="-1"></a>    <span class="dt">bestEffort</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb51-85"><a href="#cb51-85" tabindex="-1"></a>    <span class="dt">tileScale</span><span class="op">:</span> <span class="dv">16</span></span>
<span id="cb51-86"><a href="#cb51-86" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb51-87"><a href="#cb51-87" tabindex="-1"></a>  <span class="kw">var</span> maxDict <span class="op">=</span> image<span class="op">.</span><span class="fu">reduceRegion</span>({</span>
<span id="cb51-88"><a href="#cb51-88" tabindex="-1"></a>    <span class="dt">reducer</span><span class="op">:</span> ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">max</span>()<span class="op">,</span></span>
<span id="cb51-89"><a href="#cb51-89" tabindex="-1"></a>    <span class="dt">geometry</span><span class="op">:</span> geometry<span class="op">,</span></span>
<span id="cb51-90"><a href="#cb51-90" tabindex="-1"></a>    <span class="dt">scale</span><span class="op">:</span> <span class="dv">10</span><span class="op">,</span></span>
<span id="cb51-91"><a href="#cb51-91" tabindex="-1"></a>    <span class="dt">maxPixels</span><span class="op">:</span> <span class="fl">1e9</span><span class="op">,</span></span>
<span id="cb51-92"><a href="#cb51-92" tabindex="-1"></a>    <span class="dt">bestEffort</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb51-93"><a href="#cb51-93" tabindex="-1"></a>    <span class="dt">tileScale</span><span class="op">:</span> <span class="dv">16</span></span>
<span id="cb51-94"><a href="#cb51-94" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb51-95"><a href="#cb51-95" tabindex="-1"></a>  <span class="kw">var</span> mins <span class="op">=</span> ee<span class="op">.</span><span class="at">Image</span><span class="op">.</span><span class="fu">constant</span>(minDict<span class="op">.</span><span class="fu">values</span>(bandNames))<span class="op">;</span></span>
<span id="cb51-96"><a href="#cb51-96" tabindex="-1"></a>  <span class="kw">var</span> maxs <span class="op">=</span> ee<span class="op">.</span><span class="at">Image</span><span class="op">.</span><span class="fu">constant</span>(maxDict<span class="op">.</span><span class="fu">values</span>(bandNames))<span class="op">;</span></span>
<span id="cb51-97"><a href="#cb51-97" tabindex="-1"></a></span>
<span id="cb51-98"><a href="#cb51-98" tabindex="-1"></a>  <span class="kw">var</span> normalized <span class="op">=</span> image<span class="op">.</span><span class="fu">subtract</span>(mins)<span class="op">.</span><span class="fu">divide</span>(maxs<span class="op">.</span><span class="fu">subtract</span>(mins))<span class="op">;</span></span>
<span id="cb51-99"><a href="#cb51-99" tabindex="-1"></a>  <span class="cf">return</span> normalized<span class="op">;</span></span>
<span id="cb51-100"><a href="#cb51-100" tabindex="-1"></a>}</span>
<span id="cb51-101"><a href="#cb51-101" tabindex="-1"></a></span>
<span id="cb51-102"><a href="#cb51-102" tabindex="-1"></a><span class="kw">var</span> composite <span class="op">=</span> <span class="fu">normalize</span>(composite)<span class="op">;</span></span>
<span id="cb51-103"><a href="#cb51-103" tabindex="-1"></a><span class="co">// Add a random column and split the GCPs into training and validation set</span></span>
<span id="cb51-104"><a href="#cb51-104" tabindex="-1"></a><span class="kw">var</span> gcp <span class="op">=</span> gcp<span class="op">.</span><span class="fu">randomColumn</span>()<span class="op">;</span></span>
<span id="cb51-105"><a href="#cb51-105" tabindex="-1"></a></span>
<span id="cb51-106"><a href="#cb51-106" tabindex="-1"></a><span class="co">// This being a simpler classification, we take 60% points</span></span>
<span id="cb51-107"><a href="#cb51-107" tabindex="-1"></a><span class="co">// for validation. Normal recommended ratio is</span></span>
<span id="cb51-108"><a href="#cb51-108" tabindex="-1"></a><span class="co">// 70% training, 30% validation</span></span>
<span id="cb51-109"><a href="#cb51-109" tabindex="-1"></a><span class="kw">var</span> trainingGcp <span class="op">=</span> gcp<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">lt</span>(<span class="st">&#39;random&#39;</span><span class="op">,</span> <span class="fl">0.6</span>))<span class="op">;</span></span>
<span id="cb51-110"><a href="#cb51-110" tabindex="-1"></a><span class="kw">var</span> validationGcp <span class="op">=</span> gcp<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">gte</span>(<span class="st">&#39;random&#39;</span><span class="op">,</span> <span class="fl">0.6</span>))<span class="op">;</span></span>
<span id="cb51-111"><a href="#cb51-111" tabindex="-1"></a></span>
<span id="cb51-112"><a href="#cb51-112" tabindex="-1"></a><span class="co">// Overlay the point on the image to get training data.</span></span>
<span id="cb51-113"><a href="#cb51-113" tabindex="-1"></a><span class="kw">var</span> training <span class="op">=</span> composite<span class="op">.</span><span class="fu">sampleRegions</span>({</span>
<span id="cb51-114"><a href="#cb51-114" tabindex="-1"></a>  <span class="dt">collection</span><span class="op">:</span> trainingGcp<span class="op">,</span></span>
<span id="cb51-115"><a href="#cb51-115" tabindex="-1"></a>  <span class="dt">properties</span><span class="op">:</span> [<span class="st">&#39;landcover&#39;</span>]<span class="op">,</span></span>
<span id="cb51-116"><a href="#cb51-116" tabindex="-1"></a>  <span class="dt">scale</span><span class="op">:</span> <span class="dv">10</span><span class="op">,</span></span>
<span id="cb51-117"><a href="#cb51-117" tabindex="-1"></a>  <span class="dt">tileScale</span><span class="op">:</span> <span class="dv">16</span></span>
<span id="cb51-118"><a href="#cb51-118" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb51-119"><a href="#cb51-119" tabindex="-1"></a><span class="fu">print</span>(training)<span class="op">;</span></span>
<span id="cb51-120"><a href="#cb51-120" tabindex="-1"></a></span>
<span id="cb51-121"><a href="#cb51-121" tabindex="-1"></a><span class="co">// Train a classifier.</span></span>
<span id="cb51-122"><a href="#cb51-122" tabindex="-1"></a><span class="kw">var</span> classifier <span class="op">=</span> ee<span class="op">.</span><span class="at">Classifier</span><span class="op">.</span><span class="fu">smileRandomForest</span>(<span class="dv">50</span>)</span>
<span id="cb51-123"><a href="#cb51-123" tabindex="-1"></a><span class="op">.</span><span class="fu">train</span>({</span>
<span id="cb51-124"><a href="#cb51-124" tabindex="-1"></a>  <span class="dt">features</span><span class="op">:</span> training<span class="op">,</span>  </span>
<span id="cb51-125"><a href="#cb51-125" tabindex="-1"></a>  <span class="dt">classProperty</span><span class="op">:</span> <span class="st">&#39;landcover&#39;</span><span class="op">,</span></span>
<span id="cb51-126"><a href="#cb51-126" tabindex="-1"></a>  <span class="dt">inputProperties</span><span class="op">:</span> composite<span class="op">.</span><span class="fu">bandNames</span>()</span>
<span id="cb51-127"><a href="#cb51-127" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb51-128"><a href="#cb51-128" tabindex="-1"></a></span>
<span id="cb51-129"><a href="#cb51-129" tabindex="-1"></a><span class="co">// Classify the image.</span></span>
<span id="cb51-130"><a href="#cb51-130" tabindex="-1"></a><span class="kw">var</span> classified <span class="op">=</span> composite<span class="op">.</span><span class="fu">classify</span>(classifier)<span class="op">;</span></span>
<span id="cb51-131"><a href="#cb51-131" tabindex="-1"></a></span>
<span id="cb51-132"><a href="#cb51-132" tabindex="-1"></a><span class="kw">var</span> palette <span class="op">=</span> [<span class="st">&#39;#cc6d8f&#39;</span><span class="op">,</span> <span class="st">&#39;#ffc107&#39;</span><span class="op">,</span> <span class="st">&#39;#1e88e5&#39;</span><span class="op">,</span> <span class="st">&#39;#004d40&#39;</span> ]<span class="op">;</span></span>
<span id="cb51-133"><a href="#cb51-133" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(classified<span class="op">.</span><span class="fu">clip</span>(geometry)<span class="op">,</span> {<span class="dt">min</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span> <span class="dv">3</span><span class="op">,</span> <span class="dt">palette</span><span class="op">:</span> palette}<span class="op">,</span> <span class="st">&#39;2019&#39;</span>)<span class="op">;</span></span>
<span id="cb51-134"><a href="#cb51-134" tabindex="-1"></a></span>
<span id="cb51-135"><a href="#cb51-135" tabindex="-1"></a><span class="co">//************************************************************************** </span></span>
<span id="cb51-136"><a href="#cb51-136" tabindex="-1"></a><span class="co">// Accuracy Assessment</span></span>
<span id="cb51-137"><a href="#cb51-137" tabindex="-1"></a><span class="co">//************************************************************************** </span></span>
<span id="cb51-138"><a href="#cb51-138" tabindex="-1"></a></span>
<span id="cb51-139"><a href="#cb51-139" tabindex="-1"></a><span class="co">// Use classification map to assess accuracy using the validation fraction</span></span>
<span id="cb51-140"><a href="#cb51-140" tabindex="-1"></a><span class="co">// of the overall training set created above.</span></span>
<span id="cb51-141"><a href="#cb51-141" tabindex="-1"></a><span class="kw">var</span> test <span class="op">=</span> classified<span class="op">.</span><span class="fu">sampleRegions</span>({</span>
<span id="cb51-142"><a href="#cb51-142" tabindex="-1"></a>  <span class="dt">collection</span><span class="op">:</span> validationGcp<span class="op">,</span></span>
<span id="cb51-143"><a href="#cb51-143" tabindex="-1"></a>  <span class="dt">properties</span><span class="op">:</span> [<span class="st">&#39;landcover&#39;</span>]<span class="op">,</span></span>
<span id="cb51-144"><a href="#cb51-144" tabindex="-1"></a>  <span class="dt">scale</span><span class="op">:</span> <span class="dv">10</span><span class="op">,</span></span>
<span id="cb51-145"><a href="#cb51-145" tabindex="-1"></a>  <span class="dt">tileScale</span><span class="op">:</span> <span class="dv">16</span></span>
<span id="cb51-146"><a href="#cb51-146" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb51-147"><a href="#cb51-147" tabindex="-1"></a></span>
<span id="cb51-148"><a href="#cb51-148" tabindex="-1"></a><span class="kw">var</span> testConfusionMatrix <span class="op">=</span> test<span class="op">.</span><span class="fu">errorMatrix</span>(<span class="st">&#39;landcover&#39;</span><span class="op">,</span> <span class="st">&#39;classification&#39;</span>)<span class="op">;</span></span>
<span id="cb51-149"><a href="#cb51-149" tabindex="-1"></a></span>
<span id="cb51-150"><a href="#cb51-150" tabindex="-1"></a><span class="co">// Printing of confusion matrix may time out. Alternatively, you can export it as CSV</span></span>
<span id="cb51-151"><a href="#cb51-151" tabindex="-1"></a><span class="fu">print</span>(<span class="st">&#39;Confusion Matrix&#39;</span><span class="op">,</span> testConfusionMatrix)<span class="op">;</span></span>
<span id="cb51-152"><a href="#cb51-152" tabindex="-1"></a><span class="fu">print</span>(<span class="st">&#39;Test Accuracy&#39;</span><span class="op">,</span> testConfusionMatrix<span class="op">.</span><span class="fu">accuracy</span>())<span class="op">;</span></span>
<span id="cb51-153"><a href="#cb51-153" tabindex="-1"></a> </span></code></pre></div>
<p>Output</p>
<pre><code>Confusion Matrix
0: [41,3,0,0]
1: [3,43,0,0]
2: [0,0,49,2]
3: [0,0,0,37]

Test Accuracy
0.9550561797752809</code></pre>
</div>
<div id="exporting-classification-results" class="section level2">
<h2>04. Exporting Classification Results</h2>
<p>When working with complex classifiers over large regions, you may get
a <em>User memory limit exceeded</em> or <em>Computation timed out</em>
error in the Code Editor. The reason for this is that there is a fixed
time limit and smaller memory allocated for code that is run with the
<em>On-Demand Computation</em> mode. For larger computations, you can
use the <em>Batch</em> mode with the <code>Export</code> functions.
Exports run in the background and can run longer than 5-minutes time
allocated to the computation code run from the Code Editor. This allows
you to process very large and complex datasets. Here’s an example
showing how to export your classification results to Google Drive.</p>
<blockquote>
<p>We can only export Images or FeatureCollections. What if you wanted
to export a number that is the result of a long computation? A useful
<em>hack</em> is to create a FeatureCollection with just 1 feature
containing <code>null</code> geometry and a property containing the
number you want to export.</p>
</blockquote>
<p><a
href="https://code.earthengine.google.com/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3A04-Land_Use_Land_Cover_Classification%2F04b_Exporting_Classification_Results_(complete)"
target="_blank">Open in Code Editor ↗</a></p>
<div class="sourceCode" id="cb53"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb53-1"><a href="#cb53-1" tabindex="-1"></a><span class="kw">var</span> s2 <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&#39;COPERNICUS/S2_SR_HARMONIZED&#39;</span>)<span class="op">;</span></span>
<span id="cb53-2"><a href="#cb53-2" tabindex="-1"></a><span class="kw">var</span> basin <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">&#39;WWF/HydroSHEDS/v1/Basins/hybas_7&#39;</span>)<span class="op">;</span></span>
<span id="cb53-3"><a href="#cb53-3" tabindex="-1"></a><span class="kw">var</span> gcp <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">&#39;users/ujavalgandhi/e2e/arkavathy_gcps&#39;</span>)<span class="op">;</span></span>
<span id="cb53-4"><a href="#cb53-4" tabindex="-1"></a><span class="kw">var</span> alos <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(<span class="st">&#39;JAXA/ALOS/AW3D30/V2_2&#39;</span>)<span class="op">;</span></span>
<span id="cb53-5"><a href="#cb53-5" tabindex="-1"></a></span>
<span id="cb53-6"><a href="#cb53-6" tabindex="-1"></a></span>
<span id="cb53-7"><a href="#cb53-7" tabindex="-1"></a><span class="kw">var</span> arkavathy <span class="op">=</span> basin<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;HYBAS_ID&#39;</span><span class="op">,</span> <span class="dv">4071139640</span>))</span>
<span id="cb53-8"><a href="#cb53-8" tabindex="-1"></a><span class="kw">var</span> geometry <span class="op">=</span> arkavathy<span class="op">.</span><span class="fu">geometry</span>()</span>
<span id="cb53-9"><a href="#cb53-9" tabindex="-1"></a></span>
<span id="cb53-10"><a href="#cb53-10" tabindex="-1"></a><span class="kw">var</span> rgbVis <span class="op">=</span> {</span>
<span id="cb53-11"><a href="#cb53-11" tabindex="-1"></a>  <span class="dt">min</span><span class="op">:</span> <span class="fl">0.0</span><span class="op">,</span></span>
<span id="cb53-12"><a href="#cb53-12" tabindex="-1"></a>  <span class="dt">max</span><span class="op">:</span> <span class="dv">3000</span><span class="op">,</span></span>
<span id="cb53-13"><a href="#cb53-13" tabindex="-1"></a>  <span class="dt">bands</span><span class="op">:</span> [<span class="st">&#39;B4&#39;</span><span class="op">,</span> <span class="st">&#39;B3&#39;</span><span class="op">,</span> <span class="st">&#39;B2&#39;</span>]<span class="op">,</span></span>
<span id="cb53-14"><a href="#cb53-14" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb53-15"><a href="#cb53-15" tabindex="-1"></a><span class="co">// Function to remove cloud and snow pixels from Sentinel-2 SR image</span></span>
<span id="cb53-16"><a href="#cb53-16" tabindex="-1"></a></span>
<span id="cb53-17"><a href="#cb53-17" tabindex="-1"></a><span class="kw">function</span> <span class="fu">maskCloudAndShadowsSR</span>(image) {</span>
<span id="cb53-18"><a href="#cb53-18" tabindex="-1"></a>  <span class="kw">var</span> cloudProb <span class="op">=</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;MSK_CLDPRB&#39;</span>)<span class="op">;</span></span>
<span id="cb53-19"><a href="#cb53-19" tabindex="-1"></a>  <span class="kw">var</span> snowProb <span class="op">=</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;MSK_SNWPRB&#39;</span>)<span class="op">;</span></span>
<span id="cb53-20"><a href="#cb53-20" tabindex="-1"></a>  <span class="kw">var</span> cloud <span class="op">=</span> cloudProb<span class="op">.</span><span class="fu">lt</span>(<span class="dv">10</span>)<span class="op">;</span></span>
<span id="cb53-21"><a href="#cb53-21" tabindex="-1"></a>  <span class="kw">var</span> scl <span class="op">=</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;SCL&#39;</span>)<span class="op">;</span> </span>
<span id="cb53-22"><a href="#cb53-22" tabindex="-1"></a>  <span class="kw">var</span> shadow <span class="op">=</span> scl<span class="op">.</span><span class="fu">eq</span>(<span class="dv">3</span>)<span class="op">;</span> <span class="co">// 3 = cloud shadow</span></span>
<span id="cb53-23"><a href="#cb53-23" tabindex="-1"></a>  <span class="kw">var</span> cirrus <span class="op">=</span> scl<span class="op">.</span><span class="fu">eq</span>(<span class="dv">10</span>)<span class="op">;</span> <span class="co">// 10 = cirrus</span></span>
<span id="cb53-24"><a href="#cb53-24" tabindex="-1"></a>  <span class="co">// Cloud probability less than 10% or cloud shadow classification</span></span>
<span id="cb53-25"><a href="#cb53-25" tabindex="-1"></a>  <span class="kw">var</span> mask <span class="op">=</span> cloud<span class="op">.</span><span class="fu">and</span>(cirrus<span class="op">.</span><span class="fu">neq</span>(<span class="dv">1</span>))<span class="op">.</span><span class="fu">and</span>(shadow<span class="op">.</span><span class="fu">neq</span>(<span class="dv">1</span>))<span class="op">;</span></span>
<span id="cb53-26"><a href="#cb53-26" tabindex="-1"></a>  <span class="cf">return</span> image<span class="op">.</span><span class="fu">updateMask</span>(mask)<span class="op">;</span></span>
<span id="cb53-27"><a href="#cb53-27" tabindex="-1"></a>}</span>
<span id="cb53-28"><a href="#cb53-28" tabindex="-1"></a></span>
<span id="cb53-29"><a href="#cb53-29" tabindex="-1"></a></span>
<span id="cb53-30"><a href="#cb53-30" tabindex="-1"></a><span class="kw">var</span> filtered <span class="op">=</span> s2</span>
<span id="cb53-31"><a href="#cb53-31" tabindex="-1"></a><span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">lt</span>(<span class="st">&#39;CLOUDY_PIXEL_PERCENTAGE&#39;</span><span class="op">,</span> <span class="dv">30</span>))</span>
<span id="cb53-32"><a href="#cb53-32" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(<span class="st">&#39;2019-01-01&#39;</span><span class="op">,</span> <span class="st">&#39;2020-01-01&#39;</span>))</span>
<span id="cb53-33"><a href="#cb53-33" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">bounds</span>(geometry))</span>
<span id="cb53-34"><a href="#cb53-34" tabindex="-1"></a>  <span class="op">.</span><span class="fu">map</span>(maskCloudAndShadowsSR)</span>
<span id="cb53-35"><a href="#cb53-35" tabindex="-1"></a>  <span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;B.*&#39;</span>)<span class="op">;</span></span>
<span id="cb53-36"><a href="#cb53-36" tabindex="-1"></a></span>
<span id="cb53-37"><a href="#cb53-37" tabindex="-1"></a><span class="kw">var</span> composite <span class="op">=</span> filtered<span class="op">.</span><span class="fu">median</span>()<span class="op">;</span></span>
<span id="cb53-38"><a href="#cb53-38" tabindex="-1"></a></span>
<span id="cb53-39"><a href="#cb53-39" tabindex="-1"></a><span class="kw">var</span> addIndices <span class="op">=</span> <span class="kw">function</span>(image) {</span>
<span id="cb53-40"><a href="#cb53-40" tabindex="-1"></a>  <span class="kw">var</span> ndvi <span class="op">=</span> image<span class="op">.</span><span class="fu">normalizedDifference</span>([<span class="st">&#39;B8&#39;</span><span class="op">,</span> <span class="st">&#39;B4&#39;</span>])<span class="op">.</span><span class="fu">rename</span>([<span class="st">&#39;ndvi&#39;</span>])<span class="op">;</span></span>
<span id="cb53-41"><a href="#cb53-41" tabindex="-1"></a>  <span class="kw">var</span> ndbi <span class="op">=</span> image<span class="op">.</span><span class="fu">normalizedDifference</span>([<span class="st">&#39;B11&#39;</span><span class="op">,</span> <span class="st">&#39;B8&#39;</span>])<span class="op">.</span><span class="fu">rename</span>([<span class="st">&#39;ndbi&#39;</span>])<span class="op">;</span></span>
<span id="cb53-42"><a href="#cb53-42" tabindex="-1"></a>  <span class="kw">var</span> mndwi <span class="op">=</span> image<span class="op">.</span><span class="fu">normalizedDifference</span>([<span class="st">&#39;B3&#39;</span><span class="op">,</span> <span class="st">&#39;B11&#39;</span>])<span class="op">.</span><span class="fu">rename</span>([<span class="st">&#39;mndwi&#39;</span>])<span class="op">;</span> </span>
<span id="cb53-43"><a href="#cb53-43" tabindex="-1"></a>  <span class="kw">var</span> bsi <span class="op">=</span> image<span class="op">.</span><span class="fu">expression</span>(</span>
<span id="cb53-44"><a href="#cb53-44" tabindex="-1"></a>      <span class="st">&#39;(( X + Y ) - (A + B)) /(( X + Y ) + (A + B)) &#39;</span><span class="op">,</span> {</span>
<span id="cb53-45"><a href="#cb53-45" tabindex="-1"></a>        <span class="st">&#39;X&#39;</span><span class="op">:</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;B11&#39;</span>)<span class="op">,</span> <span class="co">//swir1</span></span>
<span id="cb53-46"><a href="#cb53-46" tabindex="-1"></a>        <span class="st">&#39;Y&#39;</span><span class="op">:</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;B4&#39;</span>)<span class="op">,</span>  <span class="co">//red</span></span>
<span id="cb53-47"><a href="#cb53-47" tabindex="-1"></a>        <span class="st">&#39;A&#39;</span><span class="op">:</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;B8&#39;</span>)<span class="op">,</span> <span class="co">// nir</span></span>
<span id="cb53-48"><a href="#cb53-48" tabindex="-1"></a>        <span class="st">&#39;B&#39;</span><span class="op">:</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;B2&#39;</span>)<span class="op">,</span> <span class="co">// blue</span></span>
<span id="cb53-49"><a href="#cb53-49" tabindex="-1"></a>  })<span class="op">.</span><span class="fu">rename</span>(<span class="st">&#39;bsi&#39;</span>)<span class="op">;</span></span>
<span id="cb53-50"><a href="#cb53-50" tabindex="-1"></a>  <span class="cf">return</span> image<span class="op">.</span><span class="fu">addBands</span>(ndvi)<span class="op">.</span><span class="fu">addBands</span>(ndbi)<span class="op">.</span><span class="fu">addBands</span>(mndwi)<span class="op">.</span><span class="fu">addBands</span>(bsi)<span class="op">;</span></span>
<span id="cb53-51"><a href="#cb53-51" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb53-52"><a href="#cb53-52" tabindex="-1"></a></span>
<span id="cb53-53"><a href="#cb53-53" tabindex="-1"></a><span class="kw">var</span> composite <span class="op">=</span> <span class="fu">addIndices</span>(composite)<span class="op">;</span></span>
<span id="cb53-54"><a href="#cb53-54" tabindex="-1"></a></span>
<span id="cb53-55"><a href="#cb53-55" tabindex="-1"></a></span>
<span id="cb53-56"><a href="#cb53-56" tabindex="-1"></a><span class="co">// Calculate Slope and Elevation</span></span>
<span id="cb53-57"><a href="#cb53-57" tabindex="-1"></a><span class="kw">var</span> elev <span class="op">=</span> alos<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;AVE_DSM&#39;</span>)<span class="op">.</span><span class="fu">rename</span>(<span class="st">&#39;elev&#39;</span>)<span class="op">;</span></span>
<span id="cb53-58"><a href="#cb53-58" tabindex="-1"></a><span class="kw">var</span> slope <span class="op">=</span> ee<span class="op">.</span><span class="at">Terrain</span><span class="op">.</span><span class="fu">slope</span>(alos<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;AVE_DSM&#39;</span>))<span class="op">.</span><span class="fu">rename</span>(<span class="st">&#39;slope&#39;</span>)<span class="op">;</span></span>
<span id="cb53-59"><a href="#cb53-59" tabindex="-1"></a></span>
<span id="cb53-60"><a href="#cb53-60" tabindex="-1"></a><span class="kw">var</span> composite <span class="op">=</span> composite<span class="op">.</span><span class="fu">addBands</span>(elev)<span class="op">.</span><span class="fu">addBands</span>(slope)<span class="op">;</span></span>
<span id="cb53-61"><a href="#cb53-61" tabindex="-1"></a></span>
<span id="cb53-62"><a href="#cb53-62" tabindex="-1"></a><span class="kw">var</span> visParams <span class="op">=</span> {<span class="dt">bands</span><span class="op">:</span> [<span class="st">&#39;B4&#39;</span><span class="op">,</span> <span class="st">&#39;B3&#39;</span><span class="op">,</span> <span class="st">&#39;B2&#39;</span>]<span class="op">,</span> <span class="dt">min</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span> <span class="dv">3000</span><span class="op">,</span> <span class="dt">gamma</span><span class="op">:</span> <span class="fl">1.2</span>}<span class="op">;</span></span>
<span id="cb53-63"><a href="#cb53-63" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(composite<span class="op">.</span><span class="fu">clip</span>(geometry)<span class="op">,</span> visParams<span class="op">,</span> <span class="st">&#39;RGB&#39;</span>)<span class="op">;</span></span>
<span id="cb53-64"><a href="#cb53-64" tabindex="-1"></a></span>
<span id="cb53-65"><a href="#cb53-65" tabindex="-1"></a><span class="co">// Normalize the image </span></span>
<span id="cb53-66"><a href="#cb53-66" tabindex="-1"></a></span>
<span id="cb53-67"><a href="#cb53-67" tabindex="-1"></a><span class="co">// Machine learning algorithms work best on images when all features have</span></span>
<span id="cb53-68"><a href="#cb53-68" tabindex="-1"></a><span class="co">// the same range</span></span>
<span id="cb53-69"><a href="#cb53-69" tabindex="-1"></a></span>
<span id="cb53-70"><a href="#cb53-70" tabindex="-1"></a><span class="co">// Function to Normalize Image</span></span>
<span id="cb53-71"><a href="#cb53-71" tabindex="-1"></a><span class="co">// Pixel Values should be between 0 and 1</span></span>
<span id="cb53-72"><a href="#cb53-72" tabindex="-1"></a><span class="co">// Formula is (x - xmin) / (xmax - xmin)</span></span>
<span id="cb53-73"><a href="#cb53-73" tabindex="-1"></a><span class="co">//************************************************************************** </span></span>
<span id="cb53-74"><a href="#cb53-74" tabindex="-1"></a><span class="kw">function</span> <span class="fu">normalize</span>(image){</span>
<span id="cb53-75"><a href="#cb53-75" tabindex="-1"></a>  <span class="kw">var</span> bandNames <span class="op">=</span> image<span class="op">.</span><span class="fu">bandNames</span>()<span class="op">;</span></span>
<span id="cb53-76"><a href="#cb53-76" tabindex="-1"></a>  <span class="co">// Compute min and max of the image</span></span>
<span id="cb53-77"><a href="#cb53-77" tabindex="-1"></a>  <span class="kw">var</span> minDict <span class="op">=</span> image<span class="op">.</span><span class="fu">reduceRegion</span>({</span>
<span id="cb53-78"><a href="#cb53-78" tabindex="-1"></a>    <span class="dt">reducer</span><span class="op">:</span> ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">min</span>()<span class="op">,</span></span>
<span id="cb53-79"><a href="#cb53-79" tabindex="-1"></a>    <span class="dt">geometry</span><span class="op">:</span> geometry<span class="op">,</span></span>
<span id="cb53-80"><a href="#cb53-80" tabindex="-1"></a>    <span class="dt">scale</span><span class="op">:</span> <span class="dv">20</span><span class="op">,</span></span>
<span id="cb53-81"><a href="#cb53-81" tabindex="-1"></a>    <span class="dt">maxPixels</span><span class="op">:</span> <span class="fl">1e9</span><span class="op">,</span></span>
<span id="cb53-82"><a href="#cb53-82" tabindex="-1"></a>    <span class="dt">bestEffort</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb53-83"><a href="#cb53-83" tabindex="-1"></a>    <span class="dt">tileScale</span><span class="op">:</span> <span class="dv">16</span></span>
<span id="cb53-84"><a href="#cb53-84" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb53-85"><a href="#cb53-85" tabindex="-1"></a>  <span class="kw">var</span> maxDict <span class="op">=</span> image<span class="op">.</span><span class="fu">reduceRegion</span>({</span>
<span id="cb53-86"><a href="#cb53-86" tabindex="-1"></a>    <span class="dt">reducer</span><span class="op">:</span> ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">max</span>()<span class="op">,</span></span>
<span id="cb53-87"><a href="#cb53-87" tabindex="-1"></a>    <span class="dt">geometry</span><span class="op">:</span> geometry<span class="op">,</span></span>
<span id="cb53-88"><a href="#cb53-88" tabindex="-1"></a>    <span class="dt">scale</span><span class="op">:</span> <span class="dv">20</span><span class="op">,</span></span>
<span id="cb53-89"><a href="#cb53-89" tabindex="-1"></a>    <span class="dt">maxPixels</span><span class="op">:</span> <span class="fl">1e9</span><span class="op">,</span></span>
<span id="cb53-90"><a href="#cb53-90" tabindex="-1"></a>    <span class="dt">bestEffort</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb53-91"><a href="#cb53-91" tabindex="-1"></a>    <span class="dt">tileScale</span><span class="op">:</span> <span class="dv">16</span></span>
<span id="cb53-92"><a href="#cb53-92" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb53-93"><a href="#cb53-93" tabindex="-1"></a>  <span class="kw">var</span> mins <span class="op">=</span> ee<span class="op">.</span><span class="at">Image</span><span class="op">.</span><span class="fu">constant</span>(minDict<span class="op">.</span><span class="fu">values</span>(bandNames))<span class="op">;</span></span>
<span id="cb53-94"><a href="#cb53-94" tabindex="-1"></a>  <span class="kw">var</span> maxs <span class="op">=</span> ee<span class="op">.</span><span class="at">Image</span><span class="op">.</span><span class="fu">constant</span>(maxDict<span class="op">.</span><span class="fu">values</span>(bandNames))<span class="op">;</span></span>
<span id="cb53-95"><a href="#cb53-95" tabindex="-1"></a></span>
<span id="cb53-96"><a href="#cb53-96" tabindex="-1"></a>  <span class="kw">var</span> normalized <span class="op">=</span> image<span class="op">.</span><span class="fu">subtract</span>(mins)<span class="op">.</span><span class="fu">divide</span>(maxs<span class="op">.</span><span class="fu">subtract</span>(mins))<span class="op">;</span></span>
<span id="cb53-97"><a href="#cb53-97" tabindex="-1"></a>  <span class="cf">return</span> normalized<span class="op">;</span></span>
<span id="cb53-98"><a href="#cb53-98" tabindex="-1"></a>}</span>
<span id="cb53-99"><a href="#cb53-99" tabindex="-1"></a></span>
<span id="cb53-100"><a href="#cb53-100" tabindex="-1"></a><span class="kw">var</span> composite <span class="op">=</span> <span class="fu">normalize</span>(composite)<span class="op">;</span></span>
<span id="cb53-101"><a href="#cb53-101" tabindex="-1"></a><span class="co">// Add a random column and split the GCPs into training and validation set</span></span>
<span id="cb53-102"><a href="#cb53-102" tabindex="-1"></a><span class="kw">var</span> gcp <span class="op">=</span> gcp<span class="op">.</span><span class="fu">randomColumn</span>()<span class="op">;</span></span>
<span id="cb53-103"><a href="#cb53-103" tabindex="-1"></a></span>
<span id="cb53-104"><a href="#cb53-104" tabindex="-1"></a><span class="co">// This being a simpler classification, we take 60% points</span></span>
<span id="cb53-105"><a href="#cb53-105" tabindex="-1"></a><span class="co">// for validation. Normal recommended ratio is</span></span>
<span id="cb53-106"><a href="#cb53-106" tabindex="-1"></a><span class="co">// 70% training, 30% validation</span></span>
<span id="cb53-107"><a href="#cb53-107" tabindex="-1"></a><span class="kw">var</span> trainingGcp <span class="op">=</span> gcp<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">lt</span>(<span class="st">&#39;random&#39;</span><span class="op">,</span> <span class="fl">0.6</span>))<span class="op">;</span></span>
<span id="cb53-108"><a href="#cb53-108" tabindex="-1"></a><span class="kw">var</span> validationGcp <span class="op">=</span> gcp<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">gte</span>(<span class="st">&#39;random&#39;</span><span class="op">,</span> <span class="fl">0.6</span>))<span class="op">;</span></span>
<span id="cb53-109"><a href="#cb53-109" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(validationGcp)<span class="op">;</span></span>
<span id="cb53-110"><a href="#cb53-110" tabindex="-1"></a></span>
<span id="cb53-111"><a href="#cb53-111" tabindex="-1"></a><span class="co">// Overlay the point on the image to get training data.</span></span>
<span id="cb53-112"><a href="#cb53-112" tabindex="-1"></a><span class="kw">var</span> training <span class="op">=</span> composite<span class="op">.</span><span class="fu">sampleRegions</span>({</span>
<span id="cb53-113"><a href="#cb53-113" tabindex="-1"></a>  <span class="dt">collection</span><span class="op">:</span> trainingGcp<span class="op">,</span></span>
<span id="cb53-114"><a href="#cb53-114" tabindex="-1"></a>  <span class="dt">properties</span><span class="op">:</span> [<span class="st">&#39;landcover&#39;</span>]<span class="op">,</span></span>
<span id="cb53-115"><a href="#cb53-115" tabindex="-1"></a>  <span class="dt">scale</span><span class="op">:</span> <span class="dv">10</span><span class="op">,</span></span>
<span id="cb53-116"><a href="#cb53-116" tabindex="-1"></a>  <span class="dt">tileScale</span><span class="op">:</span> <span class="dv">16</span></span>
<span id="cb53-117"><a href="#cb53-117" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb53-118"><a href="#cb53-118" tabindex="-1"></a><span class="fu">print</span>(training)<span class="op">;</span></span>
<span id="cb53-119"><a href="#cb53-119" tabindex="-1"></a></span>
<span id="cb53-120"><a href="#cb53-120" tabindex="-1"></a><span class="co">// Train a classifier.</span></span>
<span id="cb53-121"><a href="#cb53-121" tabindex="-1"></a><span class="kw">var</span> classifier <span class="op">=</span> ee<span class="op">.</span><span class="at">Classifier</span><span class="op">.</span><span class="fu">smileRandomForest</span>(<span class="dv">50</span>)</span>
<span id="cb53-122"><a href="#cb53-122" tabindex="-1"></a><span class="op">.</span><span class="fu">train</span>({</span>
<span id="cb53-123"><a href="#cb53-123" tabindex="-1"></a>  <span class="dt">features</span><span class="op">:</span> training<span class="op">,</span>  </span>
<span id="cb53-124"><a href="#cb53-124" tabindex="-1"></a>  <span class="dt">classProperty</span><span class="op">:</span> <span class="st">&#39;landcover&#39;</span><span class="op">,</span></span>
<span id="cb53-125"><a href="#cb53-125" tabindex="-1"></a>  <span class="dt">inputProperties</span><span class="op">:</span> composite<span class="op">.</span><span class="fu">bandNames</span>()</span>
<span id="cb53-126"><a href="#cb53-126" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb53-127"><a href="#cb53-127" tabindex="-1"></a></span>
<span id="cb53-128"><a href="#cb53-128" tabindex="-1"></a><span class="co">// Classify the image.</span></span>
<span id="cb53-129"><a href="#cb53-129" tabindex="-1"></a><span class="kw">var</span> classified <span class="op">=</span> composite<span class="op">.</span><span class="fu">classify</span>(classifier)<span class="op">;</span></span>
<span id="cb53-130"><a href="#cb53-130" tabindex="-1"></a></span>
<span id="cb53-131"><a href="#cb53-131" tabindex="-1"></a><span class="kw">var</span> palette <span class="op">=</span> [<span class="st">&#39;#cc6d8f&#39;</span><span class="op">,</span> <span class="st">&#39;#ffc107&#39;</span><span class="op">,</span> <span class="st">&#39;#1e88e5&#39;</span><span class="op">,</span> <span class="st">&#39;#004d40&#39;</span> ]<span class="op">;</span></span>
<span id="cb53-132"><a href="#cb53-132" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(classified<span class="op">.</span><span class="fu">clip</span>(geometry)<span class="op">,</span> {<span class="dt">min</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span> <span class="dv">3</span><span class="op">,</span> <span class="dt">palette</span><span class="op">:</span> palette}<span class="op">,</span> <span class="st">&#39;2019&#39;</span>)<span class="op">;</span></span>
<span id="cb53-133"><a href="#cb53-133" tabindex="-1"></a></span>
<span id="cb53-134"><a href="#cb53-134" tabindex="-1"></a><span class="co">//************************************************************************** </span></span>
<span id="cb53-135"><a href="#cb53-135" tabindex="-1"></a><span class="co">// Accuracy Assessment</span></span>
<span id="cb53-136"><a href="#cb53-136" tabindex="-1"></a><span class="co">//************************************************************************** </span></span>
<span id="cb53-137"><a href="#cb53-137" tabindex="-1"></a></span>
<span id="cb53-138"><a href="#cb53-138" tabindex="-1"></a><span class="co">// Use classification map to assess accuracy using the validation fraction</span></span>
<span id="cb53-139"><a href="#cb53-139" tabindex="-1"></a><span class="co">// of the overall training set created above.</span></span>
<span id="cb53-140"><a href="#cb53-140" tabindex="-1"></a><span class="kw">var</span> test <span class="op">=</span> classified<span class="op">.</span><span class="fu">sampleRegions</span>({</span>
<span id="cb53-141"><a href="#cb53-141" tabindex="-1"></a>  <span class="dt">collection</span><span class="op">:</span> validationGcp<span class="op">,</span></span>
<span id="cb53-142"><a href="#cb53-142" tabindex="-1"></a>  <span class="dt">properties</span><span class="op">:</span> [<span class="st">&#39;landcover&#39;</span>]<span class="op">,</span></span>
<span id="cb53-143"><a href="#cb53-143" tabindex="-1"></a>  <span class="dt">scale</span><span class="op">:</span> <span class="dv">10</span><span class="op">,</span></span>
<span id="cb53-144"><a href="#cb53-144" tabindex="-1"></a>  <span class="dt">tileScale</span><span class="op">:</span> <span class="dv">16</span></span>
<span id="cb53-145"><a href="#cb53-145" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb53-146"><a href="#cb53-146" tabindex="-1"></a></span>
<span id="cb53-147"><a href="#cb53-147" tabindex="-1"></a><span class="kw">var</span> testConfusionMatrix <span class="op">=</span> test<span class="op">.</span><span class="fu">errorMatrix</span>(<span class="st">&#39;landcover&#39;</span><span class="op">,</span> <span class="st">&#39;classification&#39;</span>)<span class="op">;</span></span>
<span id="cb53-148"><a href="#cb53-148" tabindex="-1"></a></span>
<span id="cb53-149"><a href="#cb53-149" tabindex="-1"></a><span class="fu">print</span>(<span class="st">&#39;Confusion Matrix&#39;</span><span class="op">,</span> testConfusionMatrix)<span class="op">;</span></span>
<span id="cb53-150"><a href="#cb53-150" tabindex="-1"></a><span class="fu">print</span>(<span class="st">&#39;Test Accuracy&#39;</span><span class="op">,</span> testConfusionMatrix<span class="op">.</span><span class="fu">accuracy</span>())<span class="op">;</span> </span>
<span id="cb53-151"><a href="#cb53-151" tabindex="-1"></a></span>
<span id="cb53-152"><a href="#cb53-152" tabindex="-1"></a><span class="co">//************************************************************************** </span></span>
<span id="cb53-153"><a href="#cb53-153" tabindex="-1"></a><span class="co">// Exporting Results</span></span>
<span id="cb53-154"><a href="#cb53-154" tabindex="-1"></a><span class="co">//************************************************************************** </span></span>
<span id="cb53-155"><a href="#cb53-155" tabindex="-1"></a></span>
<span id="cb53-156"><a href="#cb53-156" tabindex="-1"></a><span class="co">// Export the classified image to Drive</span></span>
<span id="cb53-157"><a href="#cb53-157" tabindex="-1"></a></span>
<span id="cb53-158"><a href="#cb53-158" tabindex="-1"></a><span class="co">// For images having integers (such as class numbers)</span></span>
<span id="cb53-159"><a href="#cb53-159" tabindex="-1"></a><span class="co">// we cast the image to floating point data type which</span></span>
<span id="cb53-160"><a href="#cb53-160" tabindex="-1"></a><span class="co">// allows the masked values to be saved as NaN values</span></span>
<span id="cb53-161"><a href="#cb53-161" tabindex="-1"></a><span class="co">// in the GeoTIFF format.</span></span>
<span id="cb53-162"><a href="#cb53-162" tabindex="-1"></a>Export<span class="op">.</span><span class="at">image</span><span class="op">.</span><span class="fu">toDrive</span>({</span>
<span id="cb53-163"><a href="#cb53-163" tabindex="-1"></a>  <span class="dt">image</span><span class="op">:</span> classified<span class="op">.</span><span class="fu">clip</span>(geometry)<span class="op">.</span><span class="fu">toFloat</span>()<span class="op">,</span></span>
<span id="cb53-164"><a href="#cb53-164" tabindex="-1"></a>  <span class="dt">description</span><span class="op">:</span> <span class="st">&#39;Classified_Image_Export&#39;</span><span class="op">,</span></span>
<span id="cb53-165"><a href="#cb53-165" tabindex="-1"></a>  <span class="dt">folder</span><span class="op">:</span> <span class="st">&#39;earthengine&#39;</span><span class="op">,</span></span>
<span id="cb53-166"><a href="#cb53-166" tabindex="-1"></a>  <span class="dt">fileNamePrefix</span><span class="op">:</span> <span class="st">&#39;classified&#39;</span><span class="op">,</span></span>
<span id="cb53-167"><a href="#cb53-167" tabindex="-1"></a>  <span class="dt">region</span><span class="op">:</span> geometry<span class="op">,</span></span>
<span id="cb53-168"><a href="#cb53-168" tabindex="-1"></a>  <span class="dt">scale</span><span class="op">:</span> <span class="dv">10</span><span class="op">,</span></span>
<span id="cb53-169"><a href="#cb53-169" tabindex="-1"></a>  <span class="dt">maxPixels</span><span class="op">:</span> <span class="fl">1e10</span></span>
<span id="cb53-170"><a href="#cb53-170" tabindex="-1"></a>})</span>
<span id="cb53-171"><a href="#cb53-171" tabindex="-1"></a></span>
<span id="cb53-172"><a href="#cb53-172" tabindex="-1"></a><span class="co">// Export the results of accuracy asssessment</span></span>
<span id="cb53-173"><a href="#cb53-173" tabindex="-1"></a></span>
<span id="cb53-174"><a href="#cb53-174" tabindex="-1"></a><span class="co">// Create a Feature with null geometry and the value we want to export.</span></span>
<span id="cb53-175"><a href="#cb53-175" tabindex="-1"></a><span class="co">// Use .array() to convert Confusion Matrix to an Array so it can be</span></span>
<span id="cb53-176"><a href="#cb53-176" tabindex="-1"></a><span class="co">// exported in a CSV file</span></span>
<span id="cb53-177"><a href="#cb53-177" tabindex="-1"></a><span class="kw">var</span> fc <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>([</span>
<span id="cb53-178"><a href="#cb53-178" tabindex="-1"></a>  ee<span class="op">.</span><span class="fu">Feature</span>(<span class="kw">null</span><span class="op">,</span> {</span>
<span id="cb53-179"><a href="#cb53-179" tabindex="-1"></a>    <span class="st">&#39;accuracy&#39;</span><span class="op">:</span> testConfusionMatrix<span class="op">.</span><span class="fu">accuracy</span>()<span class="op">,</span></span>
<span id="cb53-180"><a href="#cb53-180" tabindex="-1"></a>    <span class="st">&#39;matrix&#39;</span><span class="op">:</span> testConfusionMatrix<span class="op">.</span><span class="fu">array</span>()</span>
<span id="cb53-181"><a href="#cb53-181" tabindex="-1"></a>  })</span>
<span id="cb53-182"><a href="#cb53-182" tabindex="-1"></a>])<span class="op">;</span></span>
<span id="cb53-183"><a href="#cb53-183" tabindex="-1"></a></span>
<span id="cb53-184"><a href="#cb53-184" tabindex="-1"></a><span class="fu">print</span>(fc)<span class="op">;</span></span>
<span id="cb53-185"><a href="#cb53-185" tabindex="-1"></a></span>
<span id="cb53-186"><a href="#cb53-186" tabindex="-1"></a>Export<span class="op">.</span><span class="at">table</span><span class="op">.</span><span class="fu">toDrive</span>({</span>
<span id="cb53-187"><a href="#cb53-187" tabindex="-1"></a>  <span class="dt">collection</span><span class="op">:</span> fc<span class="op">,</span></span>
<span id="cb53-188"><a href="#cb53-188" tabindex="-1"></a>  <span class="dt">description</span><span class="op">:</span> <span class="st">&#39;Accuracy_Assessment_Export&#39;</span><span class="op">,</span></span>
<span id="cb53-189"><a href="#cb53-189" tabindex="-1"></a>  <span class="dt">folder</span><span class="op">:</span> <span class="st">&#39;earthengine&#39;</span><span class="op">,</span></span>
<span id="cb53-190"><a href="#cb53-190" tabindex="-1"></a>  <span class="dt">fileNamePrefix</span><span class="op">:</span> <span class="st">&#39;accuracy&#39;</span><span class="op">,</span></span>
<span id="cb53-191"><a href="#cb53-191" tabindex="-1"></a>  <span class="dt">fileFormat</span><span class="op">:</span> <span class="st">&#39;CSV&#39;</span></span>
<span id="cb53-192"><a href="#cb53-192" tabindex="-1"></a>})<span class="op">;</span></span></code></pre></div>
<div class="figure" style="text-align: center">
<img src="images/gee_water_resources_management/export_accuracy.png" alt="Exported Classification Accuracy" width="50%" />
<p class="caption">
Exported Classification Accuracy
</p>
</div>
<div id="exercise-25" class="section level3">
<h3>Exercise</h3>
<p><a
href="https://code.earthengine.google.co.in/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3A04-Land_Use_Land_Cover_Classification%2F04c_Exporting_Classification_Results_(exercise)"
target="_blank">Try in Code Editor ↗</a></p>
<p>It is also a good idea to export the classified image as an Asset.
This will allows you to import the classified image in another script
without running the whole classification workflow. Use the
<code>Export.image.toAsset()</code> function to export the classified
image as an asset.</p>
<div class="sourceCode" id="cb54"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb54-1"><a href="#cb54-1" tabindex="-1"></a><span class="kw">var</span> s2 <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&#39;COPERNICUS/S2_SR_HARMONIZED&#39;</span>)<span class="op">;</span></span>
<span id="cb54-2"><a href="#cb54-2" tabindex="-1"></a><span class="kw">var</span> basin <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">&#39;WWF/HydroSHEDS/v1/Basins/hybas_7&#39;</span>)<span class="op">;</span></span>
<span id="cb54-3"><a href="#cb54-3" tabindex="-1"></a><span class="kw">var</span> gcp <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">&#39;users/ujavalgandhi/e2e/arkavathy_gcps&#39;</span>)<span class="op">;</span></span>
<span id="cb54-4"><a href="#cb54-4" tabindex="-1"></a><span class="kw">var</span> alos <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(<span class="st">&#39;JAXA/ALOS/AW3D30/V2_2&#39;</span>)<span class="op">;</span></span>
<span id="cb54-5"><a href="#cb54-5" tabindex="-1"></a></span>
<span id="cb54-6"><a href="#cb54-6" tabindex="-1"></a></span>
<span id="cb54-7"><a href="#cb54-7" tabindex="-1"></a><span class="kw">var</span> arkavathy <span class="op">=</span> basin<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;HYBAS_ID&#39;</span><span class="op">,</span> <span class="dv">4071139640</span>))</span>
<span id="cb54-8"><a href="#cb54-8" tabindex="-1"></a><span class="kw">var</span> geometry <span class="op">=</span> arkavathy<span class="op">.</span><span class="fu">geometry</span>()</span>
<span id="cb54-9"><a href="#cb54-9" tabindex="-1"></a></span>
<span id="cb54-10"><a href="#cb54-10" tabindex="-1"></a><span class="kw">var</span> rgbVis <span class="op">=</span> {</span>
<span id="cb54-11"><a href="#cb54-11" tabindex="-1"></a>  <span class="dt">min</span><span class="op">:</span> <span class="fl">0.0</span><span class="op">,</span></span>
<span id="cb54-12"><a href="#cb54-12" tabindex="-1"></a>  <span class="dt">max</span><span class="op">:</span> <span class="dv">3000</span><span class="op">,</span></span>
<span id="cb54-13"><a href="#cb54-13" tabindex="-1"></a>  <span class="dt">bands</span><span class="op">:</span> [<span class="st">&#39;B4&#39;</span><span class="op">,</span> <span class="st">&#39;B3&#39;</span><span class="op">,</span> <span class="st">&#39;B2&#39;</span>]<span class="op">,</span></span>
<span id="cb54-14"><a href="#cb54-14" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb54-15"><a href="#cb54-15" tabindex="-1"></a><span class="co">// Function to remove cloud and snow pixels from Sentinel-2 SR image</span></span>
<span id="cb54-16"><a href="#cb54-16" tabindex="-1"></a></span>
<span id="cb54-17"><a href="#cb54-17" tabindex="-1"></a><span class="kw">function</span> <span class="fu">maskCloudAndShadowsSR</span>(image) {</span>
<span id="cb54-18"><a href="#cb54-18" tabindex="-1"></a>  <span class="kw">var</span> cloudProb <span class="op">=</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;MSK_CLDPRB&#39;</span>)<span class="op">;</span></span>
<span id="cb54-19"><a href="#cb54-19" tabindex="-1"></a>  <span class="kw">var</span> snowProb <span class="op">=</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;MSK_SNWPRB&#39;</span>)<span class="op">;</span></span>
<span id="cb54-20"><a href="#cb54-20" tabindex="-1"></a>  <span class="kw">var</span> cloud <span class="op">=</span> cloudProb<span class="op">.</span><span class="fu">lt</span>(<span class="dv">10</span>)<span class="op">;</span></span>
<span id="cb54-21"><a href="#cb54-21" tabindex="-1"></a>  <span class="kw">var</span> scl <span class="op">=</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;SCL&#39;</span>)<span class="op">;</span> </span>
<span id="cb54-22"><a href="#cb54-22" tabindex="-1"></a>  <span class="kw">var</span> shadow <span class="op">=</span> scl<span class="op">.</span><span class="fu">eq</span>(<span class="dv">3</span>)<span class="op">;</span> <span class="co">// 3 = cloud shadow</span></span>
<span id="cb54-23"><a href="#cb54-23" tabindex="-1"></a>  <span class="kw">var</span> cirrus <span class="op">=</span> scl<span class="op">.</span><span class="fu">eq</span>(<span class="dv">10</span>)<span class="op">;</span> <span class="co">// 10 = cirrus</span></span>
<span id="cb54-24"><a href="#cb54-24" tabindex="-1"></a>  <span class="co">// Cloud probability less than 10% or cloud shadow classification</span></span>
<span id="cb54-25"><a href="#cb54-25" tabindex="-1"></a>  <span class="kw">var</span> mask <span class="op">=</span> cloud<span class="op">.</span><span class="fu">and</span>(cirrus<span class="op">.</span><span class="fu">neq</span>(<span class="dv">1</span>))<span class="op">.</span><span class="fu">and</span>(shadow<span class="op">.</span><span class="fu">neq</span>(<span class="dv">1</span>))<span class="op">;</span></span>
<span id="cb54-26"><a href="#cb54-26" tabindex="-1"></a>  <span class="cf">return</span> image<span class="op">.</span><span class="fu">updateMask</span>(mask)<span class="op">;</span></span>
<span id="cb54-27"><a href="#cb54-27" tabindex="-1"></a>}</span>
<span id="cb54-28"><a href="#cb54-28" tabindex="-1"></a></span>
<span id="cb54-29"><a href="#cb54-29" tabindex="-1"></a></span>
<span id="cb54-30"><a href="#cb54-30" tabindex="-1"></a><span class="kw">var</span> filtered <span class="op">=</span> s2</span>
<span id="cb54-31"><a href="#cb54-31" tabindex="-1"></a><span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">lt</span>(<span class="st">&#39;CLOUDY_PIXEL_PERCENTAGE&#39;</span><span class="op">,</span> <span class="dv">30</span>))</span>
<span id="cb54-32"><a href="#cb54-32" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(<span class="st">&#39;2019-01-01&#39;</span><span class="op">,</span> <span class="st">&#39;2020-01-01&#39;</span>))</span>
<span id="cb54-33"><a href="#cb54-33" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">bounds</span>(geometry))</span>
<span id="cb54-34"><a href="#cb54-34" tabindex="-1"></a>  <span class="op">.</span><span class="fu">map</span>(maskCloudAndShadowsSR)</span>
<span id="cb54-35"><a href="#cb54-35" tabindex="-1"></a>  <span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;B.*&#39;</span>)<span class="op">;</span></span>
<span id="cb54-36"><a href="#cb54-36" tabindex="-1"></a></span>
<span id="cb54-37"><a href="#cb54-37" tabindex="-1"></a><span class="kw">var</span> composite <span class="op">=</span> filtered<span class="op">.</span><span class="fu">median</span>()<span class="op">;</span></span>
<span id="cb54-38"><a href="#cb54-38" tabindex="-1"></a></span>
<span id="cb54-39"><a href="#cb54-39" tabindex="-1"></a><span class="kw">var</span> addIndices <span class="op">=</span> <span class="kw">function</span>(image) {</span>
<span id="cb54-40"><a href="#cb54-40" tabindex="-1"></a>  <span class="kw">var</span> ndvi <span class="op">=</span> image<span class="op">.</span><span class="fu">normalizedDifference</span>([<span class="st">&#39;B8&#39;</span><span class="op">,</span> <span class="st">&#39;B4&#39;</span>])<span class="op">.</span><span class="fu">rename</span>([<span class="st">&#39;ndvi&#39;</span>])<span class="op">;</span></span>
<span id="cb54-41"><a href="#cb54-41" tabindex="-1"></a>  <span class="kw">var</span> ndbi <span class="op">=</span> image<span class="op">.</span><span class="fu">normalizedDifference</span>([<span class="st">&#39;B11&#39;</span><span class="op">,</span> <span class="st">&#39;B8&#39;</span>])<span class="op">.</span><span class="fu">rename</span>([<span class="st">&#39;ndbi&#39;</span>])<span class="op">;</span></span>
<span id="cb54-42"><a href="#cb54-42" tabindex="-1"></a>  <span class="kw">var</span> mndwi <span class="op">=</span> image<span class="op">.</span><span class="fu">normalizedDifference</span>([<span class="st">&#39;B3&#39;</span><span class="op">,</span> <span class="st">&#39;B11&#39;</span>])<span class="op">.</span><span class="fu">rename</span>([<span class="st">&#39;mndwi&#39;</span>])<span class="op">;</span> </span>
<span id="cb54-43"><a href="#cb54-43" tabindex="-1"></a>  <span class="kw">var</span> bsi <span class="op">=</span> image<span class="op">.</span><span class="fu">expression</span>(</span>
<span id="cb54-44"><a href="#cb54-44" tabindex="-1"></a>      <span class="st">&#39;(( X + Y ) - (A + B)) /(( X + Y ) + (A + B)) &#39;</span><span class="op">,</span> {</span>
<span id="cb54-45"><a href="#cb54-45" tabindex="-1"></a>        <span class="st">&#39;X&#39;</span><span class="op">:</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;B11&#39;</span>)<span class="op">,</span> <span class="co">//swir1</span></span>
<span id="cb54-46"><a href="#cb54-46" tabindex="-1"></a>        <span class="st">&#39;Y&#39;</span><span class="op">:</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;B4&#39;</span>)<span class="op">,</span>  <span class="co">//red</span></span>
<span id="cb54-47"><a href="#cb54-47" tabindex="-1"></a>        <span class="st">&#39;A&#39;</span><span class="op">:</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;B8&#39;</span>)<span class="op">,</span> <span class="co">// nir</span></span>
<span id="cb54-48"><a href="#cb54-48" tabindex="-1"></a>        <span class="st">&#39;B&#39;</span><span class="op">:</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;B2&#39;</span>)<span class="op">,</span> <span class="co">// blue</span></span>
<span id="cb54-49"><a href="#cb54-49" tabindex="-1"></a>  })<span class="op">.</span><span class="fu">rename</span>(<span class="st">&#39;bsi&#39;</span>)<span class="op">;</span></span>
<span id="cb54-50"><a href="#cb54-50" tabindex="-1"></a>  <span class="cf">return</span> image<span class="op">.</span><span class="fu">addBands</span>(ndvi)<span class="op">.</span><span class="fu">addBands</span>(ndbi)<span class="op">.</span><span class="fu">addBands</span>(mndwi)<span class="op">.</span><span class="fu">addBands</span>(bsi)<span class="op">;</span></span>
<span id="cb54-51"><a href="#cb54-51" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb54-52"><a href="#cb54-52" tabindex="-1"></a></span>
<span id="cb54-53"><a href="#cb54-53" tabindex="-1"></a><span class="kw">var</span> composite <span class="op">=</span> <span class="fu">addIndices</span>(composite)<span class="op">;</span></span>
<span id="cb54-54"><a href="#cb54-54" tabindex="-1"></a></span>
<span id="cb54-55"><a href="#cb54-55" tabindex="-1"></a></span>
<span id="cb54-56"><a href="#cb54-56" tabindex="-1"></a><span class="co">// Calculate Slope and Elevation</span></span>
<span id="cb54-57"><a href="#cb54-57" tabindex="-1"></a><span class="kw">var</span> elev <span class="op">=</span> alos<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;AVE_DSM&#39;</span>)<span class="op">.</span><span class="fu">rename</span>(<span class="st">&#39;elev&#39;</span>)<span class="op">;</span></span>
<span id="cb54-58"><a href="#cb54-58" tabindex="-1"></a><span class="kw">var</span> slope <span class="op">=</span> ee<span class="op">.</span><span class="at">Terrain</span><span class="op">.</span><span class="fu">slope</span>(alos<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;AVE_DSM&#39;</span>))<span class="op">.</span><span class="fu">rename</span>(<span class="st">&#39;slope&#39;</span>)<span class="op">;</span></span>
<span id="cb54-59"><a href="#cb54-59" tabindex="-1"></a></span>
<span id="cb54-60"><a href="#cb54-60" tabindex="-1"></a><span class="kw">var</span> composite <span class="op">=</span> composite<span class="op">.</span><span class="fu">addBands</span>(elev)<span class="op">.</span><span class="fu">addBands</span>(slope)<span class="op">;</span></span>
<span id="cb54-61"><a href="#cb54-61" tabindex="-1"></a></span>
<span id="cb54-62"><a href="#cb54-62" tabindex="-1"></a><span class="kw">var</span> visParams <span class="op">=</span> {<span class="dt">bands</span><span class="op">:</span> [<span class="st">&#39;B4&#39;</span><span class="op">,</span> <span class="st">&#39;B3&#39;</span><span class="op">,</span> <span class="st">&#39;B2&#39;</span>]<span class="op">,</span> <span class="dt">min</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span> <span class="dv">3000</span><span class="op">,</span> <span class="dt">gamma</span><span class="op">:</span> <span class="fl">1.2</span>}<span class="op">;</span></span>
<span id="cb54-63"><a href="#cb54-63" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(composite<span class="op">.</span><span class="fu">clip</span>(geometry)<span class="op">,</span> visParams<span class="op">,</span> <span class="st">&#39;RGB&#39;</span>)<span class="op">;</span></span>
<span id="cb54-64"><a href="#cb54-64" tabindex="-1"></a></span>
<span id="cb54-65"><a href="#cb54-65" tabindex="-1"></a><span class="co">// Normalize the image </span></span>
<span id="cb54-66"><a href="#cb54-66" tabindex="-1"></a></span>
<span id="cb54-67"><a href="#cb54-67" tabindex="-1"></a><span class="co">// Machine learning algorithms work best on images when all features have</span></span>
<span id="cb54-68"><a href="#cb54-68" tabindex="-1"></a><span class="co">// the same range</span></span>
<span id="cb54-69"><a href="#cb54-69" tabindex="-1"></a></span>
<span id="cb54-70"><a href="#cb54-70" tabindex="-1"></a><span class="co">// Function to Normalize Image</span></span>
<span id="cb54-71"><a href="#cb54-71" tabindex="-1"></a><span class="co">// Pixel Values should be between 0 and 1</span></span>
<span id="cb54-72"><a href="#cb54-72" tabindex="-1"></a><span class="co">// Formula is (x - xmin) / (xmax - xmin)</span></span>
<span id="cb54-73"><a href="#cb54-73" tabindex="-1"></a><span class="co">//************************************************************************** </span></span>
<span id="cb54-74"><a href="#cb54-74" tabindex="-1"></a><span class="kw">function</span> <span class="fu">normalize</span>(image){</span>
<span id="cb54-75"><a href="#cb54-75" tabindex="-1"></a>  <span class="kw">var</span> bandNames <span class="op">=</span> image<span class="op">.</span><span class="fu">bandNames</span>()<span class="op">;</span></span>
<span id="cb54-76"><a href="#cb54-76" tabindex="-1"></a>  <span class="co">// Compute min and max of the image</span></span>
<span id="cb54-77"><a href="#cb54-77" tabindex="-1"></a>  <span class="kw">var</span> minDict <span class="op">=</span> image<span class="op">.</span><span class="fu">reduceRegion</span>({</span>
<span id="cb54-78"><a href="#cb54-78" tabindex="-1"></a>    <span class="dt">reducer</span><span class="op">:</span> ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">min</span>()<span class="op">,</span></span>
<span id="cb54-79"><a href="#cb54-79" tabindex="-1"></a>    <span class="dt">geometry</span><span class="op">:</span> geometry<span class="op">,</span></span>
<span id="cb54-80"><a href="#cb54-80" tabindex="-1"></a>    <span class="dt">scale</span><span class="op">:</span> <span class="dv">20</span><span class="op">,</span></span>
<span id="cb54-81"><a href="#cb54-81" tabindex="-1"></a>    <span class="dt">maxPixels</span><span class="op">:</span> <span class="fl">1e9</span><span class="op">,</span></span>
<span id="cb54-82"><a href="#cb54-82" tabindex="-1"></a>    <span class="dt">bestEffort</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb54-83"><a href="#cb54-83" tabindex="-1"></a>    <span class="dt">tileScale</span><span class="op">:</span> <span class="dv">16</span></span>
<span id="cb54-84"><a href="#cb54-84" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb54-85"><a href="#cb54-85" tabindex="-1"></a>  <span class="kw">var</span> maxDict <span class="op">=</span> image<span class="op">.</span><span class="fu">reduceRegion</span>({</span>
<span id="cb54-86"><a href="#cb54-86" tabindex="-1"></a>    <span class="dt">reducer</span><span class="op">:</span> ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">max</span>()<span class="op">,</span></span>
<span id="cb54-87"><a href="#cb54-87" tabindex="-1"></a>    <span class="dt">geometry</span><span class="op">:</span> geometry<span class="op">,</span></span>
<span id="cb54-88"><a href="#cb54-88" tabindex="-1"></a>    <span class="dt">scale</span><span class="op">:</span> <span class="dv">20</span><span class="op">,</span></span>
<span id="cb54-89"><a href="#cb54-89" tabindex="-1"></a>    <span class="dt">maxPixels</span><span class="op">:</span> <span class="fl">1e9</span><span class="op">,</span></span>
<span id="cb54-90"><a href="#cb54-90" tabindex="-1"></a>    <span class="dt">bestEffort</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb54-91"><a href="#cb54-91" tabindex="-1"></a>    <span class="dt">tileScale</span><span class="op">:</span> <span class="dv">16</span></span>
<span id="cb54-92"><a href="#cb54-92" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb54-93"><a href="#cb54-93" tabindex="-1"></a>  <span class="kw">var</span> mins <span class="op">=</span> ee<span class="op">.</span><span class="at">Image</span><span class="op">.</span><span class="fu">constant</span>(minDict<span class="op">.</span><span class="fu">values</span>(bandNames))<span class="op">;</span></span>
<span id="cb54-94"><a href="#cb54-94" tabindex="-1"></a>  <span class="kw">var</span> maxs <span class="op">=</span> ee<span class="op">.</span><span class="at">Image</span><span class="op">.</span><span class="fu">constant</span>(maxDict<span class="op">.</span><span class="fu">values</span>(bandNames))<span class="op">;</span></span>
<span id="cb54-95"><a href="#cb54-95" tabindex="-1"></a></span>
<span id="cb54-96"><a href="#cb54-96" tabindex="-1"></a>  <span class="kw">var</span> normalized <span class="op">=</span> image<span class="op">.</span><span class="fu">subtract</span>(mins)<span class="op">.</span><span class="fu">divide</span>(maxs<span class="op">.</span><span class="fu">subtract</span>(mins))<span class="op">;</span></span>
<span id="cb54-97"><a href="#cb54-97" tabindex="-1"></a>  <span class="cf">return</span> normalized<span class="op">;</span></span>
<span id="cb54-98"><a href="#cb54-98" tabindex="-1"></a>}</span>
<span id="cb54-99"><a href="#cb54-99" tabindex="-1"></a></span>
<span id="cb54-100"><a href="#cb54-100" tabindex="-1"></a><span class="kw">var</span> composite <span class="op">=</span> <span class="fu">normalize</span>(composite)<span class="op">;</span></span>
<span id="cb54-101"><a href="#cb54-101" tabindex="-1"></a><span class="co">// Add a random column and split the GCPs into training and validation set</span></span>
<span id="cb54-102"><a href="#cb54-102" tabindex="-1"></a><span class="kw">var</span> gcp <span class="op">=</span> gcp<span class="op">.</span><span class="fu">randomColumn</span>()<span class="op">;</span></span>
<span id="cb54-103"><a href="#cb54-103" tabindex="-1"></a></span>
<span id="cb54-104"><a href="#cb54-104" tabindex="-1"></a><span class="co">// This being a simpler classification, we take 60% points</span></span>
<span id="cb54-105"><a href="#cb54-105" tabindex="-1"></a><span class="co">// for validation. Normal recommended ratio is</span></span>
<span id="cb54-106"><a href="#cb54-106" tabindex="-1"></a><span class="co">// 70% training, 30% validation</span></span>
<span id="cb54-107"><a href="#cb54-107" tabindex="-1"></a><span class="kw">var</span> trainingGcp <span class="op">=</span> gcp<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">lt</span>(<span class="st">&#39;random&#39;</span><span class="op">,</span> <span class="fl">0.6</span>))<span class="op">;</span></span>
<span id="cb54-108"><a href="#cb54-108" tabindex="-1"></a><span class="kw">var</span> validationGcp <span class="op">=</span> gcp<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">gte</span>(<span class="st">&#39;random&#39;</span><span class="op">,</span> <span class="fl">0.6</span>))<span class="op">;</span></span>
<span id="cb54-109"><a href="#cb54-109" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(validationGcp)<span class="op">;</span></span>
<span id="cb54-110"><a href="#cb54-110" tabindex="-1"></a></span>
<span id="cb54-111"><a href="#cb54-111" tabindex="-1"></a><span class="co">// Overlay the point on the image to get training data.</span></span>
<span id="cb54-112"><a href="#cb54-112" tabindex="-1"></a><span class="kw">var</span> training <span class="op">=</span> composite<span class="op">.</span><span class="fu">sampleRegions</span>({</span>
<span id="cb54-113"><a href="#cb54-113" tabindex="-1"></a>  <span class="dt">collection</span><span class="op">:</span> trainingGcp<span class="op">,</span></span>
<span id="cb54-114"><a href="#cb54-114" tabindex="-1"></a>  <span class="dt">properties</span><span class="op">:</span> [<span class="st">&#39;landcover&#39;</span>]<span class="op">,</span></span>
<span id="cb54-115"><a href="#cb54-115" tabindex="-1"></a>  <span class="dt">scale</span><span class="op">:</span> <span class="dv">10</span><span class="op">,</span></span>
<span id="cb54-116"><a href="#cb54-116" tabindex="-1"></a>  <span class="dt">tileScale</span><span class="op">:</span> <span class="dv">16</span></span>
<span id="cb54-117"><a href="#cb54-117" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb54-118"><a href="#cb54-118" tabindex="-1"></a><span class="fu">print</span>(training)<span class="op">;</span></span>
<span id="cb54-119"><a href="#cb54-119" tabindex="-1"></a></span>
<span id="cb54-120"><a href="#cb54-120" tabindex="-1"></a><span class="co">// Train a classifier.</span></span>
<span id="cb54-121"><a href="#cb54-121" tabindex="-1"></a><span class="kw">var</span> classifier <span class="op">=</span> ee<span class="op">.</span><span class="at">Classifier</span><span class="op">.</span><span class="fu">smileRandomForest</span>(<span class="dv">50</span>)</span>
<span id="cb54-122"><a href="#cb54-122" tabindex="-1"></a><span class="op">.</span><span class="fu">train</span>({</span>
<span id="cb54-123"><a href="#cb54-123" tabindex="-1"></a>  <span class="dt">features</span><span class="op">:</span> training<span class="op">,</span>  </span>
<span id="cb54-124"><a href="#cb54-124" tabindex="-1"></a>  <span class="dt">classProperty</span><span class="op">:</span> <span class="st">&#39;landcover&#39;</span><span class="op">,</span></span>
<span id="cb54-125"><a href="#cb54-125" tabindex="-1"></a>  <span class="dt">inputProperties</span><span class="op">:</span> composite<span class="op">.</span><span class="fu">bandNames</span>()</span>
<span id="cb54-126"><a href="#cb54-126" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb54-127"><a href="#cb54-127" tabindex="-1"></a></span>
<span id="cb54-128"><a href="#cb54-128" tabindex="-1"></a><span class="co">// Classify the image.</span></span>
<span id="cb54-129"><a href="#cb54-129" tabindex="-1"></a><span class="kw">var</span> classified <span class="op">=</span> composite<span class="op">.</span><span class="fu">classify</span>(classifier)<span class="op">;</span></span>
<span id="cb54-130"><a href="#cb54-130" tabindex="-1"></a></span>
<span id="cb54-131"><a href="#cb54-131" tabindex="-1"></a><span class="kw">var</span> palette <span class="op">=</span> [<span class="st">&#39;#cc6d8f&#39;</span><span class="op">,</span> <span class="st">&#39;#ffc107&#39;</span><span class="op">,</span> <span class="st">&#39;#1e88e5&#39;</span><span class="op">,</span> <span class="st">&#39;#004d40&#39;</span> ]<span class="op">;</span></span>
<span id="cb54-132"><a href="#cb54-132" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(classified<span class="op">.</span><span class="fu">clip</span>(geometry)<span class="op">,</span> {<span class="dt">min</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span> <span class="dv">3</span><span class="op">,</span> <span class="dt">palette</span><span class="op">:</span> palette}<span class="op">,</span> <span class="st">&#39;2019&#39;</span>)<span class="op">;</span></span>
<span id="cb54-133"><a href="#cb54-133" tabindex="-1"></a></span>
<span id="cb54-134"><a href="#cb54-134" tabindex="-1"></a><span class="co">// Exercise </span></span>
<span id="cb54-135"><a href="#cb54-135" tabindex="-1"></a></span>
<span id="cb54-136"><a href="#cb54-136" tabindex="-1"></a><span class="co">// Use the Export.image.toAsset() function to export the </span></span>
<span id="cb54-137"><a href="#cb54-137" tabindex="-1"></a><span class="co">// classified image as a Earth Engine Asset.</span></span>
<span id="cb54-138"><a href="#cb54-138" tabindex="-1"></a></span>
<span id="cb54-139"><a href="#cb54-139" tabindex="-1"></a><span class="co">// This will allows you to import the classified image in another script</span></span>
<span id="cb54-140"><a href="#cb54-140" tabindex="-1"></a><span class="co">// without running the whole classification workflow.</span></span>
<span id="cb54-141"><a href="#cb54-141" tabindex="-1"></a></span>
<span id="cb54-142"><a href="#cb54-142" tabindex="-1"></a><span class="co">// Hint: For images with discrete pixel values, we must set the</span></span>
<span id="cb54-143"><a href="#cb54-143" tabindex="-1"></a><span class="co">// pyramidingPolicy to &#39;mode&#39;.</span></span>
<span id="cb54-144"><a href="#cb54-144" tabindex="-1"></a><span class="co">// The pyramidingPolicy parameter should a dictionary specifying</span></span>
<span id="cb54-145"><a href="#cb54-145" tabindex="-1"></a><span class="co">// the policy for each band. A simpler way to specify it for all</span></span>
<span id="cb54-146"><a href="#cb54-146" tabindex="-1"></a><span class="co">// bands is to use {&#39;.default&#39;: &#39;mode&#39;}</span></span>
<span id="cb54-147"><a href="#cb54-147" tabindex="-1"></a></span>
<span id="cb54-148"><a href="#cb54-148" tabindex="-1"></a><span class="co">// assetId should be specified as a string</span></span>
<span id="cb54-149"><a href="#cb54-149" tabindex="-1"></a><span class="co">// Lookup your asset root name from the &#39;Assets&#39; tab</span></span>
<span id="cb54-150"><a href="#cb54-150" tabindex="-1"></a><span class="co">// If it is &#39;users/username&#39;, you can specify the id as</span></span>
<span id="cb54-151"><a href="#cb54-151" tabindex="-1"></a><span class="co">// &#39;users/username/classified_image&#39;</span></span></code></pre></div>
<div class="figure" style="text-align: center">
<img src="images/gee_water_resources_management/export_classification.png" alt="Exported Classified Asset" width="100%" />
<p class="caption">
Exported Classified Asset
</p>
</div>
</div>
</div>
<div id="using-existing-landcover-datasets" class="section level2">
<h2>05. Using Existing Landcover Datasets</h2>
<p>One of the ambitious projects was creating a global landcover data
with many classes for many years. This type of data is essential as in
expect few countries, the landcover data of terrain is not available /
not shared publicly by the local governments. Hence creating a global
land cover has been attempted by a few organizations One among them is
<em>European Space Agency</em>. The ESA has created the 10m global
landcover called <a href="https://esa-worldcover.org/en">WorldCover</a>
with 10 classes. At present, this data is available for the year 2020
and, ESA has promised to develop and release this data every year
following 2020. <a href="https://vimeo.com/637205140">Watch the launch
event</a> to know more about this data and the methodology used to
create this.</p>
<p>We can use the <code>eq</code> operator to extract a particular
class, extract the water class, and create a surface water map for the
Arkavathy region.</p>
<p><a
href="https://code.earthengine.google.com/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3A04-Land_Use_Land_Cover_Classification%2F05b_Using_Existing_Landcover_Datasets_(complete)"
target="_blank">Open in Code Editor ↗</a></p>
<div class="sourceCode" id="cb55"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb55-1"><a href="#cb55-1" tabindex="-1"></a><span class="kw">var</span> dataset <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&quot;ESA/WorldCover/v100&quot;</span>)<span class="op">.</span><span class="fu">first</span>()<span class="op">;</span></span>
<span id="cb55-2"><a href="#cb55-2" tabindex="-1"></a></span>
<span id="cb55-3"><a href="#cb55-3" tabindex="-1"></a><span class="co">// Select a Basin</span></span>
<span id="cb55-4"><a href="#cb55-4" tabindex="-1"></a><span class="kw">var</span> basin <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">&quot;WWF/HydroSHEDS/v1/Basins/hybas_7&quot;</span>)<span class="op">;</span></span>
<span id="cb55-5"><a href="#cb55-5" tabindex="-1"></a><span class="kw">var</span> selected <span class="op">=</span> basin<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;HYBAS_ID&#39;</span><span class="op">,</span> <span class="dv">4071139640</span>))</span>
<span id="cb55-6"><a href="#cb55-6" tabindex="-1"></a><span class="kw">var</span> geometry <span class="op">=</span> selected<span class="op">.</span><span class="fu">geometry</span>()</span>
<span id="cb55-7"><a href="#cb55-7" tabindex="-1"></a></span>
<span id="cb55-8"><a href="#cb55-8" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">centerObject</span>(geometry)<span class="op">;</span></span>
<span id="cb55-9"><a href="#cb55-9" tabindex="-1"></a><span class="co">// Add the classified image</span></span>
<span id="cb55-10"><a href="#cb55-10" tabindex="-1"></a><span class="kw">var</span> classification <span class="op">=</span> dataset<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;Map&#39;</span>)<span class="op">.</span><span class="fu">clip</span>(geometry)</span>
<span id="cb55-11"><a href="#cb55-11" tabindex="-1"></a></span>
<span id="cb55-12"><a href="#cb55-12" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(classification<span class="op">,</span> {}<span class="op">,</span> <span class="st">&#39;WorldCover Classification&#39;</span>)</span>
<span id="cb55-13"><a href="#cb55-13" tabindex="-1"></a><span class="co">// Select water class</span></span>
<span id="cb55-14"><a href="#cb55-14" tabindex="-1"></a><span class="kw">var</span> water <span class="op">=</span> classification<span class="op">.</span><span class="fu">eq</span>(<span class="dv">80</span>)</span>
<span id="cb55-15"><a href="#cb55-15" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(water<span class="op">,</span> {<span class="dt">min</span><span class="op">:</span><span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span><span class="dv">1</span><span class="op">,</span> <span class="dt">palette</span><span class="op">:</span> [<span class="st">&#39;white&#39;</span><span class="op">,</span> <span class="st">&#39;blue&#39;</span>]}<span class="op">,</span> <span class="st">&#39;Water&#39;</span>)</span></code></pre></div>
<div class="figure" style="text-align: center">
<img src="images/gee_water_resources_management/esa_worldcover.png" alt="WorldView" width="75%" />
<p class="caption">
WorldView
</p>
</div>
<div id="exercise-26" class="section level3">
<h3>Exercise</h3>
<p><a
href="https://code.earthengine.google.com/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3A04-Land_Use_Land_Cover_Classification%2F05c_Using_Existing_Landcover_Datasets_(exercise)"
target="_blank">Open in Code Editor ↗</a></p>
<p>Use the WorldCover data and extract the <code>Cropland</code> class
for Arkavathy region. Then add it to map with <em>green</em>
palette.</p>
<div class="sourceCode" id="cb56"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb56-1"><a href="#cb56-1" tabindex="-1"></a><span class="kw">var</span> dataset <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&quot;ESA/WorldCover/v100&quot;</span>)<span class="op">.</span><span class="fu">first</span>()<span class="op">;</span></span>
<span id="cb56-2"><a href="#cb56-2" tabindex="-1"></a></span>
<span id="cb56-3"><a href="#cb56-3" tabindex="-1"></a><span class="co">// Select a Basin</span></span>
<span id="cb56-4"><a href="#cb56-4" tabindex="-1"></a><span class="kw">var</span> basin <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">&quot;WWF/HydroSHEDS/v1/Basins/hybas_7&quot;</span>)<span class="op">;</span></span>
<span id="cb56-5"><a href="#cb56-5" tabindex="-1"></a><span class="kw">var</span> selected <span class="op">=</span> basin<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;HYBAS_ID&#39;</span><span class="op">,</span> <span class="dv">4071139640</span>))</span>
<span id="cb56-6"><a href="#cb56-6" tabindex="-1"></a><span class="kw">var</span> geometry <span class="op">=</span> selected<span class="op">.</span><span class="fu">geometry</span>()</span>
<span id="cb56-7"><a href="#cb56-7" tabindex="-1"></a></span>
<span id="cb56-8"><a href="#cb56-8" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">centerObject</span>(geometry)<span class="op">;</span></span>
<span id="cb56-9"><a href="#cb56-9" tabindex="-1"></a><span class="co">// Add the classified image</span></span>
<span id="cb56-10"><a href="#cb56-10" tabindex="-1"></a><span class="kw">var</span> classification <span class="op">=</span> dataset<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;Map&#39;</span>)<span class="op">.</span><span class="fu">clip</span>(geometry)</span>
<span id="cb56-11"><a href="#cb56-11" tabindex="-1"></a></span>
<span id="cb56-12"><a href="#cb56-12" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(classification<span class="op">,</span> {}<span class="op">,</span> <span class="st">&#39;WorldCover Classification&#39;</span>)</span>
<span id="cb56-13"><a href="#cb56-13" tabindex="-1"></a></span>
<span id="cb56-14"><a href="#cb56-14" tabindex="-1"></a><span class="co">// Change the region to a basin of your choice</span></span>
<span id="cb56-15"><a href="#cb56-15" tabindex="-1"></a><span class="co">// Extract the &#39;Cropland&#39; class</span></span>
<span id="cb56-16"><a href="#cb56-16" tabindex="-1"></a><span class="co">// Apply a selfMask()</span></span>
<span id="cb56-17"><a href="#cb56-17" tabindex="-1"></a><span class="co">// Add it to the map with the &#39;green&#39; palette</span></span></code></pre></div>
</div>
</div>
<div id="calculating-area" class="section level2">
<h2>06. Calculating Area</h2>
<p>Now that we have extracted the open water from WorldCover, we will
learn how to calculate the area for pixels in each class. Calculating
area for features is done using the <code>area()</code> function and for
images using the <code>ee.Image.pixelArea()</code> function. The
<code>ee.Image.pixelArea()</code> function creates an image where each
pixel’s value is the area of the pixel. We multiply this pixel area
image with our image and sum up the area using the
<code>reduceRegion()</code> function.</p>
<blockquote>
<p>The <code>ee.Image.pixelArea()</code> function uses a custom
equal-area projection for area calculation. The result is area in square
meters regardless of the projection of the input image. <a
href="https://groups.google.com/g/google-earth-engine-developers/c/Ccaorx-obVw/m/_ZQdP2wVAgAJ">Learn
more</a></p>
</blockquote>
<p><a
href="https://code.earthengine.google.com/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3A04-Land_Use_Land_Cover_Classification%2F06b_Calculating_Area_(complete)"
target="_blank">Open in Code Editor ↗</a></p>
<div class="sourceCode" id="cb57"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb57-1"><a href="#cb57-1" tabindex="-1"></a><span class="kw">var</span> dataset <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&quot;ESA/WorldCover/v100&quot;</span>)<span class="op">.</span><span class="fu">first</span>()<span class="op">;</span></span>
<span id="cb57-2"><a href="#cb57-2" tabindex="-1"></a></span>
<span id="cb57-3"><a href="#cb57-3" tabindex="-1"></a><span class="co">// Select a Basin</span></span>
<span id="cb57-4"><a href="#cb57-4" tabindex="-1"></a><span class="kw">var</span> basin <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">&quot;WWF/HydroSHEDS/v1/Basins/hybas_7&quot;</span>)<span class="op">;</span></span>
<span id="cb57-5"><a href="#cb57-5" tabindex="-1"></a><span class="kw">var</span> selected <span class="op">=</span> basin<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;HYBAS_ID&#39;</span><span class="op">,</span> <span class="dv">4071139640</span>))</span>
<span id="cb57-6"><a href="#cb57-6" tabindex="-1"></a><span class="kw">var</span> geometry <span class="op">=</span> selected<span class="op">.</span><span class="fu">geometry</span>()</span>
<span id="cb57-7"><a href="#cb57-7" tabindex="-1"></a></span>
<span id="cb57-8"><a href="#cb57-8" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">centerObject</span>(geometry)<span class="op">;</span></span>
<span id="cb57-9"><a href="#cb57-9" tabindex="-1"></a><span class="co">// Add the classified image</span></span>
<span id="cb57-10"><a href="#cb57-10" tabindex="-1"></a><span class="kw">var</span> classification <span class="op">=</span> dataset<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;Map&#39;</span>)<span class="op">.</span><span class="fu">clip</span>(geometry)</span>
<span id="cb57-11"><a href="#cb57-11" tabindex="-1"></a></span>
<span id="cb57-12"><a href="#cb57-12" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(classification<span class="op">,</span> {}<span class="op">,</span> <span class="st">&#39;WorldCover Classification&#39;</span>)</span>
<span id="cb57-13"><a href="#cb57-13" tabindex="-1"></a></span>
<span id="cb57-14"><a href="#cb57-14" tabindex="-1"></a><span class="co">// .area() function calculates the area in square meters</span></span>
<span id="cb57-15"><a href="#cb57-15" tabindex="-1"></a><span class="kw">var</span> basinArea <span class="op">=</span> geometry<span class="op">.</span><span class="fu">area</span>()</span>
<span id="cb57-16"><a href="#cb57-16" tabindex="-1"></a></span>
<span id="cb57-17"><a href="#cb57-17" tabindex="-1"></a><span class="co">// We can cast the result to a ee.Number() and calculate the</span></span>
<span id="cb57-18"><a href="#cb57-18" tabindex="-1"></a><span class="co">// area in square kilometers</span></span>
<span id="cb57-19"><a href="#cb57-19" tabindex="-1"></a><span class="kw">var</span> basinAreaSqKm <span class="op">=</span> ee<span class="op">.</span><span class="fu">Number</span>(basinArea)<span class="op">.</span><span class="fu">divide</span>(<span class="fl">1e6</span>)<span class="op">.</span><span class="fu">round</span>()</span>
<span id="cb57-20"><a href="#cb57-20" tabindex="-1"></a><span class="fu">print</span>(basinAreaSqKm)</span>
<span id="cb57-21"><a href="#cb57-21" tabindex="-1"></a></span>
<span id="cb57-22"><a href="#cb57-22" tabindex="-1"></a></span>
<span id="cb57-23"><a href="#cb57-23" tabindex="-1"></a><span class="co">// Area Calculation for Images</span></span>
<span id="cb57-24"><a href="#cb57-24" tabindex="-1"></a><span class="co">// Extract all water pixels</span></span>
<span id="cb57-25"><a href="#cb57-25" tabindex="-1"></a><span class="kw">var</span> water <span class="op">=</span> classification<span class="op">.</span><span class="fu">eq</span>(<span class="dv">80</span>)</span>
<span id="cb57-26"><a href="#cb57-26" tabindex="-1"></a></span>
<span id="cb57-27"><a href="#cb57-27" tabindex="-1"></a><span class="co">// If the image contains values 0 or 1, we can calculate the</span></span>
<span id="cb57-28"><a href="#cb57-28" tabindex="-1"></a><span class="co">// total area using reduceRegion() function</span></span>
<span id="cb57-29"><a href="#cb57-29" tabindex="-1"></a></span>
<span id="cb57-30"><a href="#cb57-30" tabindex="-1"></a><span class="co">// The result of .eq() operation is a binary image with pixels</span></span>
<span id="cb57-31"><a href="#cb57-31" tabindex="-1"></a><span class="co">// values of 1 where the condition matched and 0 where it didn&#39;t</span></span>
<span id="cb57-32"><a href="#cb57-32" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(water<span class="op">,</span> {<span class="dt">min</span><span class="op">:</span><span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span><span class="dv">1</span><span class="op">,</span> <span class="dt">palette</span><span class="op">:</span> [<span class="st">&#39;white&#39;</span><span class="op">,</span> <span class="st">&#39;blue&#39;</span>]}<span class="op">,</span> <span class="st">&#39;Surface Water&#39;</span>)</span>
<span id="cb57-33"><a href="#cb57-33" tabindex="-1"></a></span>
<span id="cb57-34"><a href="#cb57-34" tabindex="-1"></a><span class="co">// Since our image has only 0 and 1 pixel values, the water</span></span>
<span id="cb57-35"><a href="#cb57-35" tabindex="-1"></a><span class="co">// pixels will have values equal to their area</span></span>
<span id="cb57-36"><a href="#cb57-36" tabindex="-1"></a><span class="kw">var</span> areaImage <span class="op">=</span> water<span class="op">.</span><span class="fu">multiply</span>(ee<span class="op">.</span><span class="at">Image</span><span class="op">.</span><span class="fu">pixelArea</span>())</span>
<span id="cb57-37"><a href="#cb57-37" tabindex="-1"></a></span>
<span id="cb57-38"><a href="#cb57-38" tabindex="-1"></a></span>
<span id="cb57-39"><a href="#cb57-39" tabindex="-1"></a><span class="co">// Now that each pixel for water class in the image has the value</span></span>
<span id="cb57-40"><a href="#cb57-40" tabindex="-1"></a><span class="co">// equal to its area, we can sum up all the values in the region</span></span>
<span id="cb57-41"><a href="#cb57-41" tabindex="-1"></a><span class="co">// to get the total green cover.</span></span>
<span id="cb57-42"><a href="#cb57-42" tabindex="-1"></a></span>
<span id="cb57-43"><a href="#cb57-43" tabindex="-1"></a><span class="kw">var</span> area <span class="op">=</span> areaImage<span class="op">.</span><span class="fu">reduceRegion</span>({</span>
<span id="cb57-44"><a href="#cb57-44" tabindex="-1"></a>  <span class="dt">reducer</span><span class="op">:</span> ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">sum</span>()<span class="op">,</span></span>
<span id="cb57-45"><a href="#cb57-45" tabindex="-1"></a>  <span class="dt">geometry</span><span class="op">:</span> geometry<span class="op">,</span></span>
<span id="cb57-46"><a href="#cb57-46" tabindex="-1"></a>  <span class="dt">scale</span><span class="op">:</span> <span class="dv">10</span><span class="op">,</span></span>
<span id="cb57-47"><a href="#cb57-47" tabindex="-1"></a>  <span class="dt">maxPixels</span><span class="op">:</span> <span class="fl">1e10</span></span>
<span id="cb57-48"><a href="#cb57-48" tabindex="-1"></a>  })</span>
<span id="cb57-49"><a href="#cb57-49" tabindex="-1"></a></span>
<span id="cb57-50"><a href="#cb57-50" tabindex="-1"></a><span class="co">// The result of the reduceRegion() function is a dictionary with the key</span></span>
<span id="cb57-51"><a href="#cb57-51" tabindex="-1"></a><span class="co">// being the band name. We can extract the area number and convert it to</span></span>
<span id="cb57-52"><a href="#cb57-52" tabindex="-1"></a><span class="co">// square kilometers</span></span>
<span id="cb57-53"><a href="#cb57-53" tabindex="-1"></a><span class="kw">var</span> waterAreaSqKm <span class="op">=</span> ee<span class="op">.</span><span class="fu">Number</span>(area<span class="op">.</span><span class="fu">get</span>(<span class="st">&#39;Map&#39;</span>))<span class="op">.</span><span class="fu">divide</span>(<span class="fl">1e6</span>)<span class="op">.</span><span class="fu">round</span>()</span>
<span id="cb57-54"><a href="#cb57-54" tabindex="-1"></a><span class="fu">print</span>(waterAreaSqKm) </span></code></pre></div>
<p>Output</p>
<pre><code>Total basin Area(sqkm)
4178

Total water area in the basin(sqkm)
19</code></pre>
<div id="exercise-27" class="section level3">
<h3>Exercise</h3>
<p><a
href="https://code.earthengine.google.com/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3A04-Land_Use_Land_Cover_Classification%2F06c_Calculating_Area_(exercise)"
target="_blank">Try in Code Editor ↗</a></p>
<p>Extract the area value as a number and convert it as hectares.</p>
<div class="sourceCode" id="cb59"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb59-1"><a href="#cb59-1" tabindex="-1"></a><span class="kw">var</span> dataset <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&quot;ESA/WorldCover/v100&quot;</span>)<span class="op">.</span><span class="fu">first</span>()<span class="op">;</span></span>
<span id="cb59-2"><a href="#cb59-2" tabindex="-1"></a></span>
<span id="cb59-3"><a href="#cb59-3" tabindex="-1"></a><span class="co">// Select a Basin</span></span>
<span id="cb59-4"><a href="#cb59-4" tabindex="-1"></a><span class="kw">var</span> basin <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">&quot;WWF/HydroSHEDS/v1/Basins/hybas_7&quot;</span>)<span class="op">;</span></span>
<span id="cb59-5"><a href="#cb59-5" tabindex="-1"></a><span class="kw">var</span> selected <span class="op">=</span> basin<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;HYBAS_ID&#39;</span><span class="op">,</span> <span class="dv">4071139640</span>))</span>
<span id="cb59-6"><a href="#cb59-6" tabindex="-1"></a><span class="kw">var</span> geometry <span class="op">=</span> selected<span class="op">.</span><span class="fu">geometry</span>()</span>
<span id="cb59-7"><a href="#cb59-7" tabindex="-1"></a></span>
<span id="cb59-8"><a href="#cb59-8" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">centerObject</span>(geometry)<span class="op">;</span></span>
<span id="cb59-9"><a href="#cb59-9" tabindex="-1"></a><span class="co">// Add the classified image</span></span>
<span id="cb59-10"><a href="#cb59-10" tabindex="-1"></a><span class="kw">var</span> classification <span class="op">=</span> dataset<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;Map&#39;</span>)<span class="op">.</span><span class="fu">clip</span>(geometry)</span>
<span id="cb59-11"><a href="#cb59-11" tabindex="-1"></a></span>
<span id="cb59-12"><a href="#cb59-12" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(classification<span class="op">,</span> {}<span class="op">,</span> <span class="st">&#39;WorldCover Classification&#39;</span>)</span>
<span id="cb59-13"><a href="#cb59-13" tabindex="-1"></a></span>
<span id="cb59-14"><a href="#cb59-14" tabindex="-1"></a><span class="kw">var</span> basinArea <span class="op">=</span> geometry<span class="op">.</span><span class="fu">area</span>()</span>
<span id="cb59-15"><a href="#cb59-15" tabindex="-1"></a></span>
<span id="cb59-16"><a href="#cb59-16" tabindex="-1"></a><span class="kw">var</span> cropland <span class="op">=</span> classification<span class="op">.</span><span class="fu">eq</span>(<span class="dv">40</span>)</span>
<span id="cb59-17"><a href="#cb59-17" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(cropland<span class="op">,</span> {<span class="dt">min</span><span class="op">:</span><span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span><span class="dv">1</span><span class="op">,</span> <span class="dt">palette</span><span class="op">:</span> [<span class="st">&#39;white&#39;</span><span class="op">,</span> <span class="st">&#39;green&#39;</span>]}<span class="op">,</span> <span class="st">&#39;Cropland&#39;</span>)</span>
<span id="cb59-18"><a href="#cb59-18" tabindex="-1"></a></span>
<span id="cb59-19"><a href="#cb59-19" tabindex="-1"></a><span class="co">// Since our image has only 0 and 1 pixel values, the vegetation</span></span>
<span id="cb59-20"><a href="#cb59-20" tabindex="-1"></a><span class="co">// pixels will have values equal to their area</span></span>
<span id="cb59-21"><a href="#cb59-21" tabindex="-1"></a><span class="kw">var</span> areaImage <span class="op">=</span> cropland<span class="op">.</span><span class="fu">multiply</span>(ee<span class="op">.</span><span class="at">Image</span><span class="op">.</span><span class="fu">pixelArea</span>())</span>
<span id="cb59-22"><a href="#cb59-22" tabindex="-1"></a></span>
<span id="cb59-23"><a href="#cb59-23" tabindex="-1"></a><span class="kw">var</span> area <span class="op">=</span> areaImage<span class="op">.</span><span class="fu">reduceRegion</span>({</span>
<span id="cb59-24"><a href="#cb59-24" tabindex="-1"></a>  <span class="dt">reducer</span><span class="op">:</span> ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">sum</span>()<span class="op">,</span></span>
<span id="cb59-25"><a href="#cb59-25" tabindex="-1"></a>  <span class="dt">geometry</span><span class="op">:</span> geometry<span class="op">,</span></span>
<span id="cb59-26"><a href="#cb59-26" tabindex="-1"></a>  <span class="dt">scale</span><span class="op">:</span> <span class="dv">10</span><span class="op">,</span></span>
<span id="cb59-27"><a href="#cb59-27" tabindex="-1"></a>  <span class="dt">maxPixels</span><span class="op">:</span> <span class="fl">1e10</span></span>
<span id="cb59-28"><a href="#cb59-28" tabindex="-1"></a>  })</span>
<span id="cb59-29"><a href="#cb59-29" tabindex="-1"></a><span class="fu">print</span>(<span class="st">&#39;Cropland Area Sq Meters&#39;</span><span class="op">,</span> area)</span>
<span id="cb59-30"><a href="#cb59-30" tabindex="-1"></a></span>
<span id="cb59-31"><a href="#cb59-31" tabindex="-1"></a><span class="co">// Extract the area value from the dictionaty</span></span>
<span id="cb59-32"><a href="#cb59-32" tabindex="-1"></a><span class="co">// Print the cropland area in hectares</span></span>
<span id="cb59-33"><a href="#cb59-33" tabindex="-1"></a><span class="co">// Hint: 1 Hectare = 10000 sq. meters</span></span></code></pre></div>
</div>
</div>
</div>
<div id="module-5-flood-mapping" class="section level1">
<h1>Module 5: Flood Mapping</h1>
<p>This module covers the change detection techniques for mapping
floods. We will work with Sentinel-1 dataset and calculate the flooded
area during the <a
href="https://en.wikipedia.org/wiki/2018_Kerala_floods">2018 Kerala
Floods</a> in Ernakulam district in India.</p>
<p>Sentinel-1 is an active remote sensing platform that uses the
microwave C-band to collect data. The main advantage of using microwave
data is that it can penetrate through clouds and capture reflectance
value both day and night since it is not dependent on Sunlight for
reflectance. The spatial resolution of this data is 10m, and the
temporal resolution varies between 6-12 days, depending on the
location.</p>
<p><a
href="https://www.youtube.com/watch?v=JWq_WepA5DY&amp;list=PLppGmFLhQ1HI0YeA5zQHxdNlmxihvBawF&amp;index=69"
target="_blank"><img
src="https://img.youtube.com/vi/JWq_WepA5DY/mqdefault.jpg"
alt="Start Module 5 Videos" /></a></p>
<p><a
href="https://www.youtube.com/watch?v=JWq_WepA5DY&amp;list=PLppGmFLhQ1HI0YeA5zQHxdNlmxihvBawF&amp;index=69"
target="_blank">Start Module 5 Videos ↗</a></p>
<p><a
href="https://docs.google.com/presentation/d/1w1bTP49jI4LbHYTtQzEg4yytGGbCx_l5bhTisITXxKY/edit?usp=sharing"
target="_blank">View the Presentation ↗</a></p>
<div id="load-and-filter-sentinel-1-data" class="section level2">
<h2>01. Load and Filter Sentinel-1 Data</h2>
<p>We have learned basic skills to search for a dataset and filter it to
a date range and location. Let us load the <a
href="https://developers.google.com/earth-engine/datasets/catalog/COPERNICUS_S1_GRD">Sentinel-1
C-band SAR log scaling</a> dataset and filter the collection to flooding
event time period. Filter the collection to the Ernakulam region.</p>
<p>Each image will have 3 bands <em>VV</em>, <em>VH</em>, and
<em>angle</em>. Most research results say <em>VH - (vertical transmit
and horizontal receive)</em> is best for detecting floods as water has
low reflectance in the VH band and is easy to detect. Lets us select the
VH band, clip it to the ROI and display it in Map with the appropriate
visualization parameter.</p>
<p><a
href="https://code.earthengine.google.com/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3A05-Flood_Mapping%2F01b_Load_and_Filter_Sentinel-1_Data_(complete)"
target="_blank">Open in Code Editor ↗</a></p>
<div class="sourceCode" id="cb60"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb60-1"><a href="#cb60-1" tabindex="-1"></a><span class="co">// On 16 August 2018, severe floods affected the south Indian state Kerala</span></span>
<span id="cb60-2"><a href="#cb60-2" tabindex="-1"></a><span class="co">// due to unusually high rainfall during the monsoon season.</span></span>
<span id="cb60-3"><a href="#cb60-3" tabindex="-1"></a><span class="co">// It was the worst flood in Kerala in nearly a century.</span></span>
<span id="cb60-4"><a href="#cb60-4" tabindex="-1"></a><span class="co">// https://en.wikipedia.org/wiki/2018_Kerala_floods</span></span>
<span id="cb60-5"><a href="#cb60-5" tabindex="-1"></a></span>
<span id="cb60-6"><a href="#cb60-6" tabindex="-1"></a><span class="co">// Select images by predefined dates</span></span>
<span id="cb60-7"><a href="#cb60-7" tabindex="-1"></a><span class="kw">var</span> beforeStart <span class="op">=</span> <span class="st">&#39;2018-07-15&#39;</span></span>
<span id="cb60-8"><a href="#cb60-8" tabindex="-1"></a><span class="kw">var</span> beforeEnd <span class="op">=</span> <span class="st">&#39;2018-08-10&#39;</span></span>
<span id="cb60-9"><a href="#cb60-9" tabindex="-1"></a><span class="kw">var</span> afterStart <span class="op">=</span> <span class="st">&#39;2018-08-10&#39;</span></span>
<span id="cb60-10"><a href="#cb60-10" tabindex="-1"></a><span class="kw">var</span> afterEnd <span class="op">=</span> <span class="st">&#39;2018-08-23&#39;</span></span>
<span id="cb60-11"><a href="#cb60-11" tabindex="-1"></a></span>
<span id="cb60-12"><a href="#cb60-12" tabindex="-1"></a><span class="kw">var</span> admin2 <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">&quot;FAO/GAUL_SIMPLIFIED_500m/2015/level2&quot;</span>)<span class="op">;</span></span>
<span id="cb60-13"><a href="#cb60-13" tabindex="-1"></a><span class="kw">var</span> ernakulam <span class="op">=</span> admin2<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;ADM2_NAME&#39;</span><span class="op">,</span> <span class="st">&#39;Ernakulam&#39;</span>))</span>
<span id="cb60-14"><a href="#cb60-14" tabindex="-1"></a><span class="kw">var</span> geometry <span class="op">=</span> ernakulam<span class="op">.</span><span class="fu">geometry</span>()</span>
<span id="cb60-15"><a href="#cb60-15" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">centerObject</span>(geometry)</span>
<span id="cb60-16"><a href="#cb60-16" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(geometry<span class="op">,</span> {<span class="dt">color</span><span class="op">:</span> <span class="st">&#39;grey&#39;</span>}<span class="op">,</span> <span class="st">&#39;Ernakulam District&#39;</span>)</span>
<span id="cb60-17"><a href="#cb60-17" tabindex="-1"></a></span>
<span id="cb60-18"><a href="#cb60-18" tabindex="-1"></a><span class="kw">var</span> collection<span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&#39;COPERNICUS/S1_GRD&#39;</span>)</span>
<span id="cb60-19"><a href="#cb60-19" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(beforeStart<span class="op">,</span> beforeEnd))</span>
<span id="cb60-20"><a href="#cb60-20" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">bounds</span>(geometry))</span>
<span id="cb60-21"><a href="#cb60-21" tabindex="-1"></a></span>
<span id="cb60-22"><a href="#cb60-22" tabindex="-1"></a><span class="kw">var</span> image <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(collection<span class="op">.</span><span class="fu">first</span>())</span>
<span id="cb60-23"><a href="#cb60-23" tabindex="-1"></a></span>
<span id="cb60-24"><a href="#cb60-24" tabindex="-1"></a><span class="kw">var</span> imageVh <span class="op">=</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;VH&#39;</span>)<span class="op">.</span><span class="fu">clip</span>(geometry)</span>
<span id="cb60-25"><a href="#cb60-25" tabindex="-1"></a></span>
<span id="cb60-26"><a href="#cb60-26" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(imageVh<span class="op">,</span> {<span class="dt">min</span><span class="op">:-</span><span class="dv">30</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span> <span class="dv">0</span>}<span class="op">,</span> <span class="st">&#39;VH (dB)&#39;</span>)</span></code></pre></div>
<div id="exercise-28" class="section level3">
<h3>Exercise</h3>
<p><a
href="https://code.earthengine.google.com/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3A05-Flood_Mapping%2F01c_Load_and_Filter_Sentinel-1_Data_(exercise)"
target="_blank">Try in Code Editor ↗</a></p>
<p>To detect the flooded regions, we need 2 collections, one before and
another after flood occurrence. A before image and an after image has
been created. Select the <em>VH</em> band from the images and add both
images to the map canvas.</p>
<div class="figure" style="text-align: center">
<img src="images/gee_water_resources_management/flood_vh.png" alt="VH single band visualization" width="100%" />
<p class="caption">
VH single band visualization
</p>
</div>
<div class="sourceCode" id="cb61"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb61-1"><a href="#cb61-1" tabindex="-1"></a><span class="co">// On 16 August 2018, severe floods affected the south Indian state Kerala</span></span>
<span id="cb61-2"><a href="#cb61-2" tabindex="-1"></a><span class="co">// due to unusually high rainfall during the monsoon season.</span></span>
<span id="cb61-3"><a href="#cb61-3" tabindex="-1"></a><span class="co">// It was the worst flood in Kerala in nearly a century.</span></span>
<span id="cb61-4"><a href="#cb61-4" tabindex="-1"></a><span class="co">// https://en.wikipedia.org/wiki/2018_Kerala_floods</span></span>
<span id="cb61-5"><a href="#cb61-5" tabindex="-1"></a></span>
<span id="cb61-6"><a href="#cb61-6" tabindex="-1"></a><span class="co">// Select images by predefined dates</span></span>
<span id="cb61-7"><a href="#cb61-7" tabindex="-1"></a><span class="kw">var</span> beforeStart <span class="op">=</span> <span class="st">&#39;2018-07-15&#39;</span></span>
<span id="cb61-8"><a href="#cb61-8" tabindex="-1"></a><span class="kw">var</span> beforeEnd <span class="op">=</span> <span class="st">&#39;2018-08-10&#39;</span></span>
<span id="cb61-9"><a href="#cb61-9" tabindex="-1"></a><span class="kw">var</span> afterStart <span class="op">=</span> <span class="st">&#39;2018-08-10&#39;</span></span>
<span id="cb61-10"><a href="#cb61-10" tabindex="-1"></a><span class="kw">var</span> afterEnd <span class="op">=</span> <span class="st">&#39;2018-08-23&#39;</span></span>
<span id="cb61-11"><a href="#cb61-11" tabindex="-1"></a></span>
<span id="cb61-12"><a href="#cb61-12" tabindex="-1"></a><span class="kw">var</span> admin2 <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">&quot;FAO/GAUL_SIMPLIFIED_500m/2015/level2&quot;</span>)<span class="op">;</span></span>
<span id="cb61-13"><a href="#cb61-13" tabindex="-1"></a><span class="kw">var</span> ernakulam <span class="op">=</span> admin2<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;ADM2_NAME&#39;</span><span class="op">,</span> <span class="st">&#39;Ernakulam&#39;</span>))</span>
<span id="cb61-14"><a href="#cb61-14" tabindex="-1"></a><span class="kw">var</span> geometry <span class="op">=</span> ernakulam<span class="op">.</span><span class="fu">geometry</span>()</span>
<span id="cb61-15"><a href="#cb61-15" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">centerObject</span>(geometry)</span>
<span id="cb61-16"><a href="#cb61-16" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(geometry<span class="op">,</span> {<span class="dt">color</span><span class="op">:</span> <span class="st">&#39;grey&#39;</span>}<span class="op">,</span> <span class="st">&#39;Ernakulam District&#39;</span>)</span>
<span id="cb61-17"><a href="#cb61-17" tabindex="-1"></a></span>
<span id="cb61-18"><a href="#cb61-18" tabindex="-1"></a><span class="kw">var</span> collection<span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&#39;COPERNICUS/S1_GRD&#39;</span>)</span>
<span id="cb61-19"><a href="#cb61-19" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">bounds</span>(geometry))</span>
<span id="cb61-20"><a href="#cb61-20" tabindex="-1"></a></span>
<span id="cb61-21"><a href="#cb61-21" tabindex="-1"></a><span class="kw">var</span> beforeCollection <span class="op">=</span> collection<span class="op">.</span><span class="fu">filterDate</span>(beforeStart<span class="op">,</span> beforeEnd)</span>
<span id="cb61-22"><a href="#cb61-22" tabindex="-1"></a><span class="kw">var</span> afterCollection <span class="op">=</span> collection<span class="op">.</span><span class="fu">filterDate</span>(afterStart<span class="op">,</span>afterEnd)</span>
<span id="cb61-23"><a href="#cb61-23" tabindex="-1"></a></span>
<span id="cb61-24"><a href="#cb61-24" tabindex="-1"></a><span class="kw">var</span> beforeImage <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(beforeCollection<span class="op">.</span><span class="fu">first</span>())</span>
<span id="cb61-25"><a href="#cb61-25" tabindex="-1"></a><span class="kw">var</span> afterImage <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(afterCollection<span class="op">.</span><span class="fu">first</span>())</span>
<span id="cb61-26"><a href="#cb61-26" tabindex="-1"></a></span>
<span id="cb61-27"><a href="#cb61-27" tabindex="-1"></a><span class="fu">print</span>(beforeImage)</span>
<span id="cb61-28"><a href="#cb61-28" tabindex="-1"></a><span class="fu">print</span>(afterImage)</span>
<span id="cb61-29"><a href="#cb61-29" tabindex="-1"></a></span>
<span id="cb61-30"><a href="#cb61-30" tabindex="-1"></a><span class="co">// Exercise</span></span>
<span id="cb61-31"><a href="#cb61-31" tabindex="-1"></a><span class="co">// Select the &#39;VH&#39; band of before and after images</span></span>
<span id="cb61-32"><a href="#cb61-32" tabindex="-1"></a><span class="co">// Add them to the map.</span></span>
<span id="cb61-33"><a href="#cb61-33" tabindex="-1"></a><span class="co">// Inspect the images and find suitable values for visualization parameters</span></span>
<span id="cb61-34"><a href="#cb61-34" tabindex="-1"></a> </span></code></pre></div>
</div>
</div>
<div id="visualize-rgb-composites" class="section level2">
<h2>02. Visualize RGB Composites</h2>
<p>We visualized the VH band as a single band image in the previous
exercise. We can also visualize a SAR image as a multi-band RGB image.
The usual practice is using the <em>VV</em> band in the red channel, the
<em>VH</em> band in the green channel, and the <em>VV/VH</em> in the
blue channel.</p>
<p>Three bands have different min-max values, but a single number for
min-max value in visualization will not be correct. So we can pass a
list of numbers, each representing each band’s min-max value in Red
Green Blue order, respectively.</p>
<a
href="https://code.earthengine.google.com/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3A05-Flood_Mapping%2F02b_Visualize_RGB_Composites_(complete)"
target="_blank">Open in Code Editor ↗</a>
<div class="figure" style="text-align: center">
<img src="images/gee_water_resources_management/flood_rgb.png" alt="RGB multi band visualization" width="100%" />
<p class="caption">
RGB multi band visualization
</p>
</div>
<div class="sourceCode" id="cb62"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb62-1"><a href="#cb62-1" tabindex="-1"></a><span class="co">// On 16 August 2018, severe floods affected the south Indian state Kerala</span></span>
<span id="cb62-2"><a href="#cb62-2" tabindex="-1"></a><span class="co">// due to unusually high rainfall during the monsoon season.</span></span>
<span id="cb62-3"><a href="#cb62-3" tabindex="-1"></a><span class="co">// It was the worst flood in Kerala in nearly a century.</span></span>
<span id="cb62-4"><a href="#cb62-4" tabindex="-1"></a><span class="co">// https://en.wikipedia.org/wiki/2018_Kerala_floods</span></span>
<span id="cb62-5"><a href="#cb62-5" tabindex="-1"></a></span>
<span id="cb62-6"><a href="#cb62-6" tabindex="-1"></a><span class="co">// Select images by predefined dates</span></span>
<span id="cb62-7"><a href="#cb62-7" tabindex="-1"></a><span class="kw">var</span> beforeStart <span class="op">=</span> <span class="st">&#39;2018-07-15&#39;</span></span>
<span id="cb62-8"><a href="#cb62-8" tabindex="-1"></a><span class="kw">var</span> beforeEnd <span class="op">=</span> <span class="st">&#39;2018-08-10&#39;</span></span>
<span id="cb62-9"><a href="#cb62-9" tabindex="-1"></a><span class="kw">var</span> afterStart <span class="op">=</span> <span class="st">&#39;2018-08-10&#39;</span></span>
<span id="cb62-10"><a href="#cb62-10" tabindex="-1"></a><span class="kw">var</span> afterEnd <span class="op">=</span> <span class="st">&#39;2018-08-23&#39;</span></span>
<span id="cb62-11"><a href="#cb62-11" tabindex="-1"></a></span>
<span id="cb62-12"><a href="#cb62-12" tabindex="-1"></a><span class="kw">var</span> admin2 <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">&quot;FAO/GAUL_SIMPLIFIED_500m/2015/level2&quot;</span>)<span class="op">;</span></span>
<span id="cb62-13"><a href="#cb62-13" tabindex="-1"></a><span class="kw">var</span> ernakulam <span class="op">=</span> admin2<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;ADM2_NAME&#39;</span><span class="op">,</span> <span class="st">&#39;Ernakulam&#39;</span>))</span>
<span id="cb62-14"><a href="#cb62-14" tabindex="-1"></a><span class="kw">var</span> geometry <span class="op">=</span> ernakulam<span class="op">.</span><span class="fu">geometry</span>()</span>
<span id="cb62-15"><a href="#cb62-15" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(geometry<span class="op">,</span> {<span class="dt">color</span><span class="op">:</span> <span class="st">&#39;grey&#39;</span>}<span class="op">,</span> <span class="st">&#39;Ernakulam District&#39;</span>)</span>
<span id="cb62-16"><a href="#cb62-16" tabindex="-1"></a></span>
<span id="cb62-17"><a href="#cb62-17" tabindex="-1"></a><span class="kw">var</span> collection<span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&#39;COPERNICUS/S1_GRD&#39;</span>)</span>
<span id="cb62-18"><a href="#cb62-18" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;instrumentMode&#39;</span><span class="op">,</span><span class="st">&#39;IW&#39;</span>))</span>
<span id="cb62-19"><a href="#cb62-19" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">listContains</span>(<span class="st">&#39;transmitterReceiverPolarisation&#39;</span><span class="op">,</span> <span class="st">&#39;VH&#39;</span>))</span>
<span id="cb62-20"><a href="#cb62-20" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">listContains</span>(<span class="st">&#39;transmitterReceiverPolarisation&#39;</span><span class="op">,</span> <span class="st">&#39;VV&#39;</span>))</span>
<span id="cb62-21"><a href="#cb62-21" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;orbitProperties_pass&#39;</span><span class="op">,</span> <span class="st">&#39;DESCENDING&#39;</span>)) </span>
<span id="cb62-22"><a href="#cb62-22" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;resolution_meters&#39;</span><span class="op">,</span><span class="dv">10</span>))</span>
<span id="cb62-23"><a href="#cb62-23" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">bounds</span>(geometry))</span>
<span id="cb62-24"><a href="#cb62-24" tabindex="-1"></a>  <span class="op">.</span><span class="fu">select</span>([<span class="st">&#39;VV&#39;</span><span class="op">,</span> <span class="st">&#39;VH&#39;</span>])</span>
<span id="cb62-25"><a href="#cb62-25" tabindex="-1"></a></span>
<span id="cb62-26"><a href="#cb62-26" tabindex="-1"></a></span>
<span id="cb62-27"><a href="#cb62-27" tabindex="-1"></a><span class="kw">var</span> beforeCollection <span class="op">=</span> collection</span>
<span id="cb62-28"><a href="#cb62-28" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(beforeStart<span class="op">,</span> beforeEnd))</span>
<span id="cb62-29"><a href="#cb62-29" tabindex="-1"></a></span>
<span id="cb62-30"><a href="#cb62-30" tabindex="-1"></a><span class="kw">var</span> afterCollection <span class="op">=</span> collection</span>
<span id="cb62-31"><a href="#cb62-31" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(afterStart<span class="op">,</span> afterEnd))</span>
<span id="cb62-32"><a href="#cb62-32" tabindex="-1"></a></span>
<span id="cb62-33"><a href="#cb62-33" tabindex="-1"></a><span class="kw">var</span> before <span class="op">=</span> beforeCollection<span class="op">.</span><span class="fu">mosaic</span>()<span class="op">.</span><span class="fu">clip</span>(geometry)<span class="op">;</span></span>
<span id="cb62-34"><a href="#cb62-34" tabindex="-1"></a><span class="kw">var</span> after <span class="op">=</span> afterCollection<span class="op">.</span><span class="fu">mosaic</span>()<span class="op">.</span><span class="fu">clip</span>(geometry)<span class="op">;</span></span>
<span id="cb62-35"><a href="#cb62-35" tabindex="-1"></a></span>
<span id="cb62-36"><a href="#cb62-36" tabindex="-1"></a><span class="kw">var</span> addRatioBand <span class="op">=</span> <span class="kw">function</span>(image) {</span>
<span id="cb62-37"><a href="#cb62-37" tabindex="-1"></a>  <span class="kw">var</span> ratioBand <span class="op">=</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;VV&#39;</span>)<span class="op">.</span><span class="fu">divide</span>(image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;VH&#39;</span>))<span class="op">.</span><span class="fu">rename</span>(<span class="st">&#39;VV/VH&#39;</span>)</span>
<span id="cb62-38"><a href="#cb62-38" tabindex="-1"></a>  <span class="cf">return</span> image<span class="op">.</span><span class="fu">addBands</span>(ratioBand)</span>
<span id="cb62-39"><a href="#cb62-39" tabindex="-1"></a>}</span>
<span id="cb62-40"><a href="#cb62-40" tabindex="-1"></a></span>
<span id="cb62-41"><a href="#cb62-41" tabindex="-1"></a><span class="kw">var</span> beforeRgb <span class="op">=</span> <span class="fu">addRatioBand</span>(before)</span>
<span id="cb62-42"><a href="#cb62-42" tabindex="-1"></a><span class="kw">var</span> afterRgb <span class="op">=</span> <span class="fu">addRatioBand</span>(after)</span>
<span id="cb62-43"><a href="#cb62-43" tabindex="-1"></a></span>
<span id="cb62-44"><a href="#cb62-44" tabindex="-1"></a><span class="kw">var</span> visParams <span class="op">=</span> {<span class="dt">min</span><span class="op">:</span>[<span class="op">-</span><span class="dv">25</span><span class="op">,</span> <span class="op">-</span><span class="dv">25</span><span class="op">,</span> <span class="dv">0</span>] <span class="op">,</span><span class="dt">max</span><span class="op">:</span>[<span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">2</span>]}</span>
<span id="cb62-45"><a href="#cb62-45" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">centerObject</span>(geometry<span class="op">,</span> <span class="dv">10</span>)</span>
<span id="cb62-46"><a href="#cb62-46" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(beforeRgb<span class="op">,</span> visParams<span class="op">,</span> <span class="st">&#39;Before Floods&#39;</span>)<span class="op">;</span></span>
<span id="cb62-47"><a href="#cb62-47" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(afterRgb<span class="op">,</span> visParams<span class="op">,</span> <span class="st">&#39;After Floods&#39;</span>)<span class="op">;</span> </span></code></pre></div>
<div id="exercise-29" class="section level3">
<h3>Exercise</h3>
<p><a
href="https://code.earthengine.google.com/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3A05-Flood_Mapping%2F02c_Visualize_RGB_Composites_(exercise)"
target="_blank">Try in Code Editor ↗</a></p>
<p>We have learned to visualize a multi-band image using <em>VV</em>,
<em>VH</em>, and <em>VV/VH</em> bands. Let us visualize the change by
creating a composite image with <em>VH - before image</em>, <em>VH -
after image</em>, and <em>VH - before image</em>. This visualization can
effectively identify the before and after images’ changes.</p>
<p>To create this visualization, select the particular bands from each
image and concatenate the three bands in the same order using
<code>ee.Image.cat</code> function, use the visualization parameter as
min: -25 and max: -8 and add it to the canvas.</p>
<div class="figure" style="text-align: center">
<img src="images/gee_water_resources_management/flood_change.png" alt="Change visualization" width="75%" />
<p class="caption">
Change visualization
</p>
</div>
<div class="sourceCode" id="cb63"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb63-1"><a href="#cb63-1" tabindex="-1"></a><span class="co">// On 16 August 2018, severe floods affected the south Indian state Kerala</span></span>
<span id="cb63-2"><a href="#cb63-2" tabindex="-1"></a><span class="co">// due to unusually high rainfall during the monsoon season.</span></span>
<span id="cb63-3"><a href="#cb63-3" tabindex="-1"></a><span class="co">// It was the worst flood in Kerala in nearly a century.</span></span>
<span id="cb63-4"><a href="#cb63-4" tabindex="-1"></a><span class="co">// https://en.wikipedia.org/wiki/2018_Kerala_floods</span></span>
<span id="cb63-5"><a href="#cb63-5" tabindex="-1"></a></span>
<span id="cb63-6"><a href="#cb63-6" tabindex="-1"></a><span class="co">// Select images by predefined dates</span></span>
<span id="cb63-7"><a href="#cb63-7" tabindex="-1"></a><span class="kw">var</span> beforeStart <span class="op">=</span> <span class="st">&#39;2018-07-15&#39;</span></span>
<span id="cb63-8"><a href="#cb63-8" tabindex="-1"></a><span class="kw">var</span> beforeEnd <span class="op">=</span> <span class="st">&#39;2018-08-10&#39;</span></span>
<span id="cb63-9"><a href="#cb63-9" tabindex="-1"></a><span class="kw">var</span> afterStart <span class="op">=</span> <span class="st">&#39;2018-08-10&#39;</span></span>
<span id="cb63-10"><a href="#cb63-10" tabindex="-1"></a><span class="kw">var</span> afterEnd <span class="op">=</span> <span class="st">&#39;2018-08-23&#39;</span></span>
<span id="cb63-11"><a href="#cb63-11" tabindex="-1"></a></span>
<span id="cb63-12"><a href="#cb63-12" tabindex="-1"></a><span class="kw">var</span> admin2 <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">&quot;FAO/GAUL_SIMPLIFIED_500m/2015/level2&quot;</span>)<span class="op">;</span></span>
<span id="cb63-13"><a href="#cb63-13" tabindex="-1"></a><span class="kw">var</span> ernakulam <span class="op">=</span> admin2<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;ADM2_NAME&#39;</span><span class="op">,</span> <span class="st">&#39;Ernakulam&#39;</span>))</span>
<span id="cb63-14"><a href="#cb63-14" tabindex="-1"></a><span class="kw">var</span> geometry <span class="op">=</span> ernakulam<span class="op">.</span><span class="fu">geometry</span>()</span>
<span id="cb63-15"><a href="#cb63-15" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(geometry<span class="op">,</span> {<span class="dt">color</span><span class="op">:</span> <span class="st">&#39;grey&#39;</span>}<span class="op">,</span> <span class="st">&#39;Ernakulam District&#39;</span>)</span>
<span id="cb63-16"><a href="#cb63-16" tabindex="-1"></a></span>
<span id="cb63-17"><a href="#cb63-17" tabindex="-1"></a><span class="kw">var</span> collection<span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&#39;COPERNICUS/S1_GRD&#39;</span>)</span>
<span id="cb63-18"><a href="#cb63-18" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;instrumentMode&#39;</span><span class="op">,</span><span class="st">&#39;IW&#39;</span>))</span>
<span id="cb63-19"><a href="#cb63-19" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">listContains</span>(<span class="st">&#39;transmitterReceiverPolarisation&#39;</span><span class="op">,</span> <span class="st">&#39;VH&#39;</span>))</span>
<span id="cb63-20"><a href="#cb63-20" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">listContains</span>(<span class="st">&#39;transmitterReceiverPolarisation&#39;</span><span class="op">,</span> <span class="st">&#39;VV&#39;</span>))</span>
<span id="cb63-21"><a href="#cb63-21" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;orbitProperties_pass&#39;</span><span class="op">,</span> <span class="st">&#39;DESCENDING&#39;</span>)) </span>
<span id="cb63-22"><a href="#cb63-22" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;resolution_meters&#39;</span><span class="op">,</span><span class="dv">10</span>))</span>
<span id="cb63-23"><a href="#cb63-23" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">bounds</span>(geometry))</span>
<span id="cb63-24"><a href="#cb63-24" tabindex="-1"></a>  <span class="op">.</span><span class="fu">select</span>([<span class="st">&#39;VV&#39;</span><span class="op">,</span> <span class="st">&#39;VH&#39;</span>])</span>
<span id="cb63-25"><a href="#cb63-25" tabindex="-1"></a></span>
<span id="cb63-26"><a href="#cb63-26" tabindex="-1"></a><span class="kw">var</span> beforeCollection <span class="op">=</span> collection</span>
<span id="cb63-27"><a href="#cb63-27" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(beforeStart<span class="op">,</span> beforeEnd))</span>
<span id="cb63-28"><a href="#cb63-28" tabindex="-1"></a></span>
<span id="cb63-29"><a href="#cb63-29" tabindex="-1"></a><span class="kw">var</span> afterCollection <span class="op">=</span> collection</span>
<span id="cb63-30"><a href="#cb63-30" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(afterStart<span class="op">,</span> afterEnd))</span>
<span id="cb63-31"><a href="#cb63-31" tabindex="-1"></a></span>
<span id="cb63-32"><a href="#cb63-32" tabindex="-1"></a><span class="kw">var</span> before <span class="op">=</span> beforeCollection<span class="op">.</span><span class="fu">mosaic</span>()<span class="op">.</span><span class="fu">clip</span>(geometry)<span class="op">;</span></span>
<span id="cb63-33"><a href="#cb63-33" tabindex="-1"></a><span class="kw">var</span> after <span class="op">=</span> afterCollection<span class="op">.</span><span class="fu">mosaic</span>()<span class="op">.</span><span class="fu">clip</span>(geometry)<span class="op">;</span></span>
<span id="cb63-34"><a href="#cb63-34" tabindex="-1"></a></span>
<span id="cb63-35"><a href="#cb63-35" tabindex="-1"></a><span class="kw">var</span> visParams <span class="op">=</span> {<span class="dt">min</span><span class="op">:</span> <span class="op">-</span><span class="dv">30</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span> <span class="dv">0</span>}</span>
<span id="cb63-36"><a href="#cb63-36" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">centerObject</span>(geometry<span class="op">,</span> <span class="dv">10</span>)</span>
<span id="cb63-37"><a href="#cb63-37" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(before<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;VH&#39;</span>)<span class="op">,</span> visParams<span class="op">,</span> <span class="st">&#39;Before Floods&#39;</span>)<span class="op">;</span></span>
<span id="cb63-38"><a href="#cb63-38" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(after<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;VH&#39;</span>)<span class="op">,</span> visParams<span class="op">,</span> <span class="st">&#39;After Floods&#39;</span>)<span class="op">;</span> </span>
<span id="cb63-39"><a href="#cb63-39" tabindex="-1"></a></span>
<span id="cb63-40"><a href="#cb63-40" tabindex="-1"></a><span class="co">// Change Detection  RGB Visualization</span></span>
<span id="cb63-41"><a href="#cb63-41" tabindex="-1"></a><span class="co">// Create a RGB composite with following Band Combination</span></span>
<span id="cb63-42"><a href="#cb63-42" tabindex="-1"></a><span class="co">// Before VH, After VH, Before VH</span></span>
<span id="cb63-43"><a href="#cb63-43" tabindex="-1"></a></span>
<span id="cb63-44"><a href="#cb63-44" tabindex="-1"></a><span class="co">// Hint: Use ee.Image.cat() to create a 3-band image</span></span>
<span id="cb63-45"><a href="#cb63-45" tabindex="-1"></a> </span>
<span id="cb63-46"><a href="#cb63-46" tabindex="-1"></a>  </span>
<span id="cb63-47"><a href="#cb63-47" tabindex="-1"></a><span class="co">// Display the image with a min/max range of -25 to -8</span></span></code></pre></div>
</div>
</div>
<div id="apply-speckle-filter" class="section level2">
<h2>03. Apply Speckle Filter</h2>
<p>Any SAR image will be with noise. Speckle is like salt and pepper
noise in the image. Before performing any operation, a filter is applied
over the image to smooth it and reduce the noise. There are many types
of filters. <em>Refined Lee</em> filter is a more scientific approach in
filtering the noise.</p>
<p>The raw image should be passed into the <code>Refined Lee</code>
function. Hence, the log image is converted to raw using the
<code>toNatural</code> function. The resulting image from Refined Lee is
again converted to log scale by passing it <code>toDB</code>
function.</p>
<blockquote>
<p>Guido Lemoine implemented the Refined Lee filter in GEE. Keeping the
Speckle filtering function at the end of any SAR processing script can
be very handy for conversions and save time.</p>
</blockquote>
<a
href="https://code.earthengine.google.com/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3A05-Flood_Mapping%2F03b_Apply_Speckle_Filter_(complete)"
target="_blank">Open in Code Editor ↗</a>
<div class="figure" style="text-align: center">
<img src="images/gee_water_resources_management/flood_speckle.png" alt="Speckle Filter" width="100%" />
<p class="caption">
Speckle Filter
</p>
</div>
<div class="sourceCode" id="cb64"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb64-1"><a href="#cb64-1" tabindex="-1"></a><span class="kw">var</span> gsw <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(<span class="st">&quot;JRC/GSW1_2/GlobalSurfaceWater&quot;</span>)<span class="op">;</span></span>
<span id="cb64-2"><a href="#cb64-2" tabindex="-1"></a><span class="kw">var</span> admin2 <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">&quot;FAO/GAUL_SIMPLIFIED_500m/2015/level2&quot;</span>)<span class="op">;</span></span>
<span id="cb64-3"><a href="#cb64-3" tabindex="-1"></a><span class="kw">var</span> hydrosheds <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(<span class="st">&quot;WWF/HydroSHEDS/03VFDEM&quot;</span>)<span class="op">;</span></span>
<span id="cb64-4"><a href="#cb64-4" tabindex="-1"></a>    </span>
<span id="cb64-5"><a href="#cb64-5" tabindex="-1"></a><span class="kw">var</span> beforeStart <span class="op">=</span> <span class="st">&#39;2018-07-15&#39;</span></span>
<span id="cb64-6"><a href="#cb64-6" tabindex="-1"></a><span class="kw">var</span> beforeEnd <span class="op">=</span> <span class="st">&#39;2018-08-10&#39;</span></span>
<span id="cb64-7"><a href="#cb64-7" tabindex="-1"></a><span class="kw">var</span> afterStart <span class="op">=</span> <span class="st">&#39;2018-08-10&#39;</span></span>
<span id="cb64-8"><a href="#cb64-8" tabindex="-1"></a><span class="kw">var</span> afterEnd <span class="op">=</span> <span class="st">&#39;2018-08-23&#39;</span></span>
<span id="cb64-9"><a href="#cb64-9" tabindex="-1"></a></span>
<span id="cb64-10"><a href="#cb64-10" tabindex="-1"></a><span class="kw">var</span> ernakulam <span class="op">=</span> admin2<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;ADM2_NAME&#39;</span><span class="op">,</span> <span class="st">&#39;Ernakulam&#39;</span>))</span>
<span id="cb64-11"><a href="#cb64-11" tabindex="-1"></a><span class="kw">var</span> geometry <span class="op">=</span> ernakulam<span class="op">.</span><span class="fu">geometry</span>()</span>
<span id="cb64-12"><a href="#cb64-12" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(geometry<span class="op">,</span> {<span class="dt">color</span><span class="op">:</span> <span class="st">&#39;grey&#39;</span>}<span class="op">,</span> <span class="st">&#39;Ernakulam District&#39;</span>)</span>
<span id="cb64-13"><a href="#cb64-13" tabindex="-1"></a></span>
<span id="cb64-14"><a href="#cb64-14" tabindex="-1"></a><span class="kw">var</span> collection<span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&#39;COPERNICUS/S1_GRD&#39;</span>)</span>
<span id="cb64-15"><a href="#cb64-15" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;instrumentMode&#39;</span><span class="op">,</span><span class="st">&#39;IW&#39;</span>))</span>
<span id="cb64-16"><a href="#cb64-16" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">listContains</span>(<span class="st">&#39;transmitterReceiverPolarisation&#39;</span><span class="op">,</span> <span class="st">&#39;VH&#39;</span>))</span>
<span id="cb64-17"><a href="#cb64-17" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;orbitProperties_pass&#39;</span><span class="op">,</span> <span class="st">&#39;DESCENDING&#39;</span>)) </span>
<span id="cb64-18"><a href="#cb64-18" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;resolution_meters&#39;</span><span class="op">,</span><span class="dv">10</span>))</span>
<span id="cb64-19"><a href="#cb64-19" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">bounds</span>(geometry))</span>
<span id="cb64-20"><a href="#cb64-20" tabindex="-1"></a>  <span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;VH&#39;</span>)<span class="op">;</span></span>
<span id="cb64-21"><a href="#cb64-21" tabindex="-1"></a></span>
<span id="cb64-22"><a href="#cb64-22" tabindex="-1"></a><span class="kw">var</span> beforeCollection <span class="op">=</span> collection</span>
<span id="cb64-23"><a href="#cb64-23" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(beforeStart<span class="op">,</span> beforeEnd))</span>
<span id="cb64-24"><a href="#cb64-24" tabindex="-1"></a></span>
<span id="cb64-25"><a href="#cb64-25" tabindex="-1"></a><span class="kw">var</span> afterCollection <span class="op">=</span> collection</span>
<span id="cb64-26"><a href="#cb64-26" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(afterStart<span class="op">,</span> afterEnd))</span>
<span id="cb64-27"><a href="#cb64-27" tabindex="-1"></a></span>
<span id="cb64-28"><a href="#cb64-28" tabindex="-1"></a><span class="kw">var</span> before <span class="op">=</span> beforeCollection<span class="op">.</span><span class="fu">mosaic</span>()<span class="op">.</span><span class="fu">clip</span>(geometry)<span class="op">;</span></span>
<span id="cb64-29"><a href="#cb64-29" tabindex="-1"></a><span class="kw">var</span> after <span class="op">=</span> afterCollection<span class="op">.</span><span class="fu">mosaic</span>()<span class="op">.</span><span class="fu">clip</span>(geometry)<span class="op">;</span></span>
<span id="cb64-30"><a href="#cb64-30" tabindex="-1"></a></span>
<span id="cb64-31"><a href="#cb64-31" tabindex="-1"></a><span class="kw">var</span> beforeFiltered <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(<span class="fu">toDB</span>(<span class="fu">RefinedLee</span>(<span class="fu">toNatural</span>(before))))</span>
<span id="cb64-32"><a href="#cb64-32" tabindex="-1"></a><span class="kw">var</span> afterFiltered <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(<span class="fu">toDB</span>(<span class="fu">RefinedLee</span>(<span class="fu">toNatural</span>(after))))</span>
<span id="cb64-33"><a href="#cb64-33" tabindex="-1"></a></span>
<span id="cb64-34"><a href="#cb64-34" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">centerObject</span>(geometry<span class="op">,</span> <span class="dv">10</span>)</span>
<span id="cb64-35"><a href="#cb64-35" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(before<span class="op">,</span> {<span class="dt">min</span><span class="op">:-</span><span class="dv">25</span><span class="op">,</span><span class="dt">max</span><span class="op">:</span><span class="dv">0</span>}<span class="op">,</span> <span class="st">&#39;Before Floods&#39;</span><span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span></span>
<span id="cb64-36"><a href="#cb64-36" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(after<span class="op">,</span> {<span class="dt">min</span><span class="op">:-</span><span class="dv">25</span><span class="op">,</span><span class="dt">max</span><span class="op">:</span><span class="dv">0</span>}<span class="op">,</span> <span class="st">&#39;After Floods&#39;</span><span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span> </span>
<span id="cb64-37"><a href="#cb64-37" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(beforeFiltered<span class="op">,</span> {<span class="dt">min</span><span class="op">:-</span><span class="dv">25</span><span class="op">,</span><span class="dt">max</span><span class="op">:</span><span class="dv">0</span>}<span class="op">,</span> <span class="st">&#39;Before Filtered&#39;</span><span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span></span>
<span id="cb64-38"><a href="#cb64-38" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(afterFiltered<span class="op">,</span> {<span class="dt">min</span><span class="op">:-</span><span class="dv">25</span><span class="op">,</span><span class="dt">max</span><span class="op">:</span><span class="dv">0</span>}<span class="op">,</span> <span class="st">&#39;After Filtered&#39;</span><span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span> </span>
<span id="cb64-39"><a href="#cb64-39" tabindex="-1"></a></span>
<span id="cb64-40"><a href="#cb64-40" tabindex="-1"></a><span class="co">//############################</span></span>
<span id="cb64-41"><a href="#cb64-41" tabindex="-1"></a><span class="co">// Speckle Filtering Functions</span></span>
<span id="cb64-42"><a href="#cb64-42" tabindex="-1"></a><span class="co">//############################</span></span>
<span id="cb64-43"><a href="#cb64-43" tabindex="-1"></a></span>
<span id="cb64-44"><a href="#cb64-44" tabindex="-1"></a><span class="co">// Function to convert from dB</span></span>
<span id="cb64-45"><a href="#cb64-45" tabindex="-1"></a><span class="kw">function</span> <span class="fu">toNatural</span>(img) {</span>
<span id="cb64-46"><a href="#cb64-46" tabindex="-1"></a>  <span class="cf">return</span> ee<span class="op">.</span><span class="fu">Image</span>(<span class="fl">10.0</span>)<span class="op">.</span><span class="fu">pow</span>(img<span class="op">.</span><span class="fu">select</span>(<span class="dv">0</span>)<span class="op">.</span><span class="fu">divide</span>(<span class="fl">10.0</span>))<span class="op">;</span></span>
<span id="cb64-47"><a href="#cb64-47" tabindex="-1"></a>}</span>
<span id="cb64-48"><a href="#cb64-48" tabindex="-1"></a></span>
<span id="cb64-49"><a href="#cb64-49" tabindex="-1"></a><span class="co">//Function to convert to dB</span></span>
<span id="cb64-50"><a href="#cb64-50" tabindex="-1"></a><span class="kw">function</span> <span class="fu">toDB</span>(img) {</span>
<span id="cb64-51"><a href="#cb64-51" tabindex="-1"></a>  <span class="cf">return</span> ee<span class="op">.</span><span class="fu">Image</span>(img)<span class="op">.</span><span class="fu">log10</span>()<span class="op">.</span><span class="fu">multiply</span>(<span class="fl">10.0</span>)<span class="op">;</span></span>
<span id="cb64-52"><a href="#cb64-52" tabindex="-1"></a>}</span>
<span id="cb64-53"><a href="#cb64-53" tabindex="-1"></a></span>
<span id="cb64-54"><a href="#cb64-54" tabindex="-1"></a><span class="co">//Apllying a Refined Lee Speckle filter as coded in the SNAP 3.0 S1TBX:</span></span>
<span id="cb64-55"><a href="#cb64-55" tabindex="-1"></a></span>
<span id="cb64-56"><a href="#cb64-56" tabindex="-1"></a><span class="co">//https://github.com/senbox-org/s1tbx/blob/master/s1tbx-op-sar-processing/src/main/java/org/esa/s1tbx/sar/gpf/filtering/SpeckleFilters/RefinedLee.java</span></span>
<span id="cb64-57"><a href="#cb64-57" tabindex="-1"></a><span class="co">//Adapted by Guido Lemoine</span></span>
<span id="cb64-58"><a href="#cb64-58" tabindex="-1"></a></span>
<span id="cb64-59"><a href="#cb64-59" tabindex="-1"></a><span class="co">// by Guido Lemoine</span></span>
<span id="cb64-60"><a href="#cb64-60" tabindex="-1"></a><span class="kw">function</span> <span class="fu">RefinedLee</span>(img) {</span>
<span id="cb64-61"><a href="#cb64-61" tabindex="-1"></a>  <span class="co">// img must be in natural units, i.e. not in dB!</span></span>
<span id="cb64-62"><a href="#cb64-62" tabindex="-1"></a>  <span class="co">// Set up 3x3 kernels </span></span>
<span id="cb64-63"><a href="#cb64-63" tabindex="-1"></a>  <span class="kw">var</span> weights3 <span class="op">=</span> ee<span class="op">.</span><span class="at">List</span><span class="op">.</span><span class="fu">repeat</span>(ee<span class="op">.</span><span class="at">List</span><span class="op">.</span><span class="fu">repeat</span>(<span class="dv">1</span><span class="op">,</span><span class="dv">3</span>)<span class="op">,</span><span class="dv">3</span>)<span class="op">;</span></span>
<span id="cb64-64"><a href="#cb64-64" tabindex="-1"></a>  <span class="kw">var</span> kernel3 <span class="op">=</span> ee<span class="op">.</span><span class="at">Kernel</span><span class="op">.</span><span class="fu">fixed</span>(<span class="dv">3</span><span class="op">,</span><span class="dv">3</span><span class="op">,</span> weights3<span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span></span>
<span id="cb64-65"><a href="#cb64-65" tabindex="-1"></a></span>
<span id="cb64-66"><a href="#cb64-66" tabindex="-1"></a>  <span class="kw">var</span> mean3 <span class="op">=</span> img<span class="op">.</span><span class="fu">reduceNeighborhood</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">mean</span>()<span class="op">,</span> kernel3)<span class="op">;</span></span>
<span id="cb64-67"><a href="#cb64-67" tabindex="-1"></a>  <span class="kw">var</span> variance3 <span class="op">=</span> img<span class="op">.</span><span class="fu">reduceNeighborhood</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">variance</span>()<span class="op">,</span> kernel3)<span class="op">;</span></span>
<span id="cb64-68"><a href="#cb64-68" tabindex="-1"></a></span>
<span id="cb64-69"><a href="#cb64-69" tabindex="-1"></a>  <span class="co">// Use a sample of the 3x3 windows inside a 7x7 windows to determine gradients and directions</span></span>
<span id="cb64-70"><a href="#cb64-70" tabindex="-1"></a>  <span class="kw">var</span> sample_weights <span class="op">=</span> ee<span class="op">.</span><span class="fu">List</span>([[<span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span>]<span class="op">,</span> [<span class="dv">0</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span>]<span class="op">,</span>[<span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span>]<span class="op">,</span> [<span class="dv">0</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span>]<span class="op">,</span> [<span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span>]<span class="op">,</span> [<span class="dv">0</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span>]<span class="op">,</span>[<span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span>]])<span class="op">;</span></span>
<span id="cb64-71"><a href="#cb64-71" tabindex="-1"></a></span>
<span id="cb64-72"><a href="#cb64-72" tabindex="-1"></a>  <span class="kw">var</span> sample_kernel <span class="op">=</span> ee<span class="op">.</span><span class="at">Kernel</span><span class="op">.</span><span class="fu">fixed</span>(<span class="dv">7</span><span class="op">,</span><span class="dv">7</span><span class="op">,</span> sample_weights<span class="op">,</span> <span class="dv">3</span><span class="op">,</span><span class="dv">3</span><span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span></span>
<span id="cb64-73"><a href="#cb64-73" tabindex="-1"></a></span>
<span id="cb64-74"><a href="#cb64-74" tabindex="-1"></a>  <span class="co">// Calculate mean and variance for the sampled windows and store as 9 bands</span></span>
<span id="cb64-75"><a href="#cb64-75" tabindex="-1"></a>  <span class="kw">var</span> sample_mean <span class="op">=</span> mean3<span class="op">.</span><span class="fu">neighborhoodToBands</span>(sample_kernel)<span class="op">;</span> </span>
<span id="cb64-76"><a href="#cb64-76" tabindex="-1"></a>  <span class="kw">var</span> sample_var <span class="op">=</span> variance3<span class="op">.</span><span class="fu">neighborhoodToBands</span>(sample_kernel)<span class="op">;</span></span>
<span id="cb64-77"><a href="#cb64-77" tabindex="-1"></a></span>
<span id="cb64-78"><a href="#cb64-78" tabindex="-1"></a>  <span class="co">// Determine the 4 gradients for the sampled windows</span></span>
<span id="cb64-79"><a href="#cb64-79" tabindex="-1"></a>  <span class="kw">var</span> gradients <span class="op">=</span> sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">1</span>)<span class="op">.</span><span class="fu">subtract</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">7</span>))<span class="op">.</span><span class="fu">abs</span>()<span class="op">;</span></span>
<span id="cb64-80"><a href="#cb64-80" tabindex="-1"></a>  gradients <span class="op">=</span> gradients<span class="op">.</span><span class="fu">addBands</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">6</span>)<span class="op">.</span><span class="fu">subtract</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">2</span>))<span class="op">.</span><span class="fu">abs</span>())<span class="op">;</span></span>
<span id="cb64-81"><a href="#cb64-81" tabindex="-1"></a>  gradients <span class="op">=</span> gradients<span class="op">.</span><span class="fu">addBands</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">3</span>)<span class="op">.</span><span class="fu">subtract</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">5</span>))<span class="op">.</span><span class="fu">abs</span>())<span class="op">;</span></span>
<span id="cb64-82"><a href="#cb64-82" tabindex="-1"></a>  gradients <span class="op">=</span> gradients<span class="op">.</span><span class="fu">addBands</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">0</span>)<span class="op">.</span><span class="fu">subtract</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">8</span>))<span class="op">.</span><span class="fu">abs</span>())<span class="op">;</span></span>
<span id="cb64-83"><a href="#cb64-83" tabindex="-1"></a></span>
<span id="cb64-84"><a href="#cb64-84" tabindex="-1"></a>  <span class="co">// And find the maximum gradient amongst gradient bands</span></span>
<span id="cb64-85"><a href="#cb64-85" tabindex="-1"></a>  <span class="kw">var</span> max_gradient <span class="op">=</span> gradients<span class="op">.</span><span class="fu">reduce</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">max</span>())<span class="op">;</span></span>
<span id="cb64-86"><a href="#cb64-86" tabindex="-1"></a></span>
<span id="cb64-87"><a href="#cb64-87" tabindex="-1"></a>  <span class="co">// Create a mask for band pixels that are the maximum gradient</span></span>
<span id="cb64-88"><a href="#cb64-88" tabindex="-1"></a>  <span class="kw">var</span> gradmask <span class="op">=</span> gradients<span class="op">.</span><span class="fu">eq</span>(max_gradient)<span class="op">;</span></span>
<span id="cb64-89"><a href="#cb64-89" tabindex="-1"></a></span>
<span id="cb64-90"><a href="#cb64-90" tabindex="-1"></a>  <span class="co">// duplicate gradmask bands: each gradient represents 2 directions</span></span>
<span id="cb64-91"><a href="#cb64-91" tabindex="-1"></a>  gradmask <span class="op">=</span> gradmask<span class="op">.</span><span class="fu">addBands</span>(gradmask)<span class="op">;</span></span>
<span id="cb64-92"><a href="#cb64-92" tabindex="-1"></a></span>
<span id="cb64-93"><a href="#cb64-93" tabindex="-1"></a>  <span class="co">// Determine the 8 directions</span></span>
<span id="cb64-94"><a href="#cb64-94" tabindex="-1"></a>  <span class="kw">var</span> directions <span class="op">=</span> sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">1</span>)<span class="op">.</span><span class="fu">subtract</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">4</span>))<span class="op">.</span><span class="fu">gt</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">4</span>)<span class="op">.</span><span class="fu">subtract</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">7</span>)))<span class="op">.</span><span class="fu">multiply</span>(<span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb64-95"><a href="#cb64-95" tabindex="-1"></a>  directions <span class="op">=</span> directions<span class="op">.</span><span class="fu">addBands</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">6</span>)<span class="op">.</span><span class="fu">subtract</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">4</span>))<span class="op">.</span><span class="fu">gt</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">4</span>)<span class="op">.</span><span class="fu">subtract</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">2</span>)))<span class="op">.</span><span class="fu">multiply</span>(<span class="dv">2</span>))<span class="op">;</span></span>
<span id="cb64-96"><a href="#cb64-96" tabindex="-1"></a>  directions <span class="op">=</span> directions<span class="op">.</span><span class="fu">addBands</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">3</span>)<span class="op">.</span><span class="fu">subtract</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">4</span>))<span class="op">.</span><span class="fu">gt</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">4</span>)<span class="op">.</span><span class="fu">subtract</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">5</span>)))<span class="op">.</span><span class="fu">multiply</span>(<span class="dv">3</span>))<span class="op">;</span></span>
<span id="cb64-97"><a href="#cb64-97" tabindex="-1"></a>  directions <span class="op">=</span> directions<span class="op">.</span><span class="fu">addBands</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">0</span>)<span class="op">.</span><span class="fu">subtract</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">4</span>))<span class="op">.</span><span class="fu">gt</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">4</span>)<span class="op">.</span><span class="fu">subtract</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">8</span>)))<span class="op">.</span><span class="fu">multiply</span>(<span class="dv">4</span>))<span class="op">;</span></span>
<span id="cb64-98"><a href="#cb64-98" tabindex="-1"></a>  <span class="co">// The next 4 are the not() of the previous 4</span></span>
<span id="cb64-99"><a href="#cb64-99" tabindex="-1"></a>  directions <span class="op">=</span> directions<span class="op">.</span><span class="fu">addBands</span>(directions<span class="op">.</span><span class="fu">select</span>(<span class="dv">0</span>)<span class="op">.</span><span class="fu">not</span>()<span class="op">.</span><span class="fu">multiply</span>(<span class="dv">5</span>))<span class="op">;</span></span>
<span id="cb64-100"><a href="#cb64-100" tabindex="-1"></a>  directions <span class="op">=</span> directions<span class="op">.</span><span class="fu">addBands</span>(directions<span class="op">.</span><span class="fu">select</span>(<span class="dv">1</span>)<span class="op">.</span><span class="fu">not</span>()<span class="op">.</span><span class="fu">multiply</span>(<span class="dv">6</span>))<span class="op">;</span></span>
<span id="cb64-101"><a href="#cb64-101" tabindex="-1"></a>  directions <span class="op">=</span> directions<span class="op">.</span><span class="fu">addBands</span>(directions<span class="op">.</span><span class="fu">select</span>(<span class="dv">2</span>)<span class="op">.</span><span class="fu">not</span>()<span class="op">.</span><span class="fu">multiply</span>(<span class="dv">7</span>))<span class="op">;</span></span>
<span id="cb64-102"><a href="#cb64-102" tabindex="-1"></a>  directions <span class="op">=</span> directions<span class="op">.</span><span class="fu">addBands</span>(directions<span class="op">.</span><span class="fu">select</span>(<span class="dv">3</span>)<span class="op">.</span><span class="fu">not</span>()<span class="op">.</span><span class="fu">multiply</span>(<span class="dv">8</span>))<span class="op">;</span></span>
<span id="cb64-103"><a href="#cb64-103" tabindex="-1"></a></span>
<span id="cb64-104"><a href="#cb64-104" tabindex="-1"></a>  <span class="co">// Mask all values that are not 1-8</span></span>
<span id="cb64-105"><a href="#cb64-105" tabindex="-1"></a>  directions <span class="op">=</span> directions<span class="op">.</span><span class="fu">updateMask</span>(gradmask)<span class="op">;</span></span>
<span id="cb64-106"><a href="#cb64-106" tabindex="-1"></a></span>
<span id="cb64-107"><a href="#cb64-107" tabindex="-1"></a>  <span class="co">// &quot;collapse&quot; the stack into a singe band image (due to masking, each pixel has just one value (1-8) in it&#39;s directional band, and is otherwise masked)</span></span>
<span id="cb64-108"><a href="#cb64-108" tabindex="-1"></a>  directions <span class="op">=</span> directions<span class="op">.</span><span class="fu">reduce</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">sum</span>())<span class="op">;</span>  </span>
<span id="cb64-109"><a href="#cb64-109" tabindex="-1"></a></span>
<span id="cb64-110"><a href="#cb64-110" tabindex="-1"></a>  <span class="co">//var pal = [&#39;ffffff&#39;,&#39;ff0000&#39;,&#39;ffff00&#39;, &#39;00ff00&#39;, &#39;00ffff&#39;, &#39;0000ff&#39;, &#39;ff00ff&#39;, &#39;000000&#39;];</span></span>
<span id="cb64-111"><a href="#cb64-111" tabindex="-1"></a>  <span class="co">//Map.addLayer(directions.reduce(ee.Reducer.sum()), {min:1, max:8, palette: pal}, &#39;Directions&#39;, false);</span></span>
<span id="cb64-112"><a href="#cb64-112" tabindex="-1"></a></span>
<span id="cb64-113"><a href="#cb64-113" tabindex="-1"></a>  <span class="kw">var</span> sample_stats <span class="op">=</span> sample_var<span class="op">.</span><span class="fu">divide</span>(sample_mean<span class="op">.</span><span class="fu">multiply</span>(sample_mean))<span class="op">;</span></span>
<span id="cb64-114"><a href="#cb64-114" tabindex="-1"></a></span>
<span id="cb64-115"><a href="#cb64-115" tabindex="-1"></a>  <span class="co">// Calculate localNoiseVariance</span></span>
<span id="cb64-116"><a href="#cb64-116" tabindex="-1"></a>  <span class="kw">var</span> sigmaV <span class="op">=</span> sample_stats<span class="op">.</span><span class="fu">toArray</span>()<span class="op">.</span><span class="fu">arraySort</span>()<span class="op">.</span><span class="fu">arraySlice</span>(<span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">5</span>)<span class="op">.</span><span class="fu">arrayReduce</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">mean</span>()<span class="op">,</span> [<span class="dv">0</span>])<span class="op">;</span></span>
<span id="cb64-117"><a href="#cb64-117" tabindex="-1"></a></span>
<span id="cb64-118"><a href="#cb64-118" tabindex="-1"></a>  <span class="co">// Set up the 7*7 kernels for directional statistics</span></span>
<span id="cb64-119"><a href="#cb64-119" tabindex="-1"></a>  <span class="kw">var</span> rect_weights <span class="op">=</span> ee<span class="op">.</span><span class="at">List</span><span class="op">.</span><span class="fu">repeat</span>(ee<span class="op">.</span><span class="at">List</span><span class="op">.</span><span class="fu">repeat</span>(<span class="dv">0</span><span class="op">,</span><span class="dv">7</span>)<span class="op">,</span><span class="dv">3</span>)<span class="op">.</span><span class="fu">cat</span>(ee<span class="op">.</span><span class="at">List</span><span class="op">.</span><span class="fu">repeat</span>(ee<span class="op">.</span><span class="at">List</span><span class="op">.</span><span class="fu">repeat</span>(<span class="dv">1</span><span class="op">,</span><span class="dv">7</span>)<span class="op">,</span><span class="dv">4</span>))<span class="op">;</span></span>
<span id="cb64-120"><a href="#cb64-120" tabindex="-1"></a></span>
<span id="cb64-121"><a href="#cb64-121" tabindex="-1"></a>  <span class="kw">var</span> diag_weights <span class="op">=</span> ee<span class="op">.</span><span class="fu">List</span>([[<span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span>]<span class="op">,</span> [<span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span>]<span class="op">,</span> [<span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span>]<span class="op">,</span> </span>
<span id="cb64-122"><a href="#cb64-122" tabindex="-1"></a>    [<span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span>]<span class="op">,</span> [<span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span>]<span class="op">,</span> [<span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span>]<span class="op">,</span> [<span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span>]])<span class="op">;</span></span>
<span id="cb64-123"><a href="#cb64-123" tabindex="-1"></a></span>
<span id="cb64-124"><a href="#cb64-124" tabindex="-1"></a>  <span class="kw">var</span> rect_kernel <span class="op">=</span> ee<span class="op">.</span><span class="at">Kernel</span><span class="op">.</span><span class="fu">fixed</span>(<span class="dv">7</span><span class="op">,</span><span class="dv">7</span><span class="op">,</span> rect_weights<span class="op">,</span> <span class="dv">3</span><span class="op">,</span> <span class="dv">3</span><span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span></span>
<span id="cb64-125"><a href="#cb64-125" tabindex="-1"></a>  <span class="kw">var</span> diag_kernel <span class="op">=</span> ee<span class="op">.</span><span class="at">Kernel</span><span class="op">.</span><span class="fu">fixed</span>(<span class="dv">7</span><span class="op">,</span><span class="dv">7</span><span class="op">,</span> diag_weights<span class="op">,</span> <span class="dv">3</span><span class="op">,</span> <span class="dv">3</span><span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span></span>
<span id="cb64-126"><a href="#cb64-126" tabindex="-1"></a></span>
<span id="cb64-127"><a href="#cb64-127" tabindex="-1"></a>  <span class="co">// Create stacks for mean and variance using the original kernels. Mask with relevant direction.</span></span>
<span id="cb64-128"><a href="#cb64-128" tabindex="-1"></a>  <span class="kw">var</span> dir_mean <span class="op">=</span> img<span class="op">.</span><span class="fu">reduceNeighborhood</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">mean</span>()<span class="op">,</span> rect_kernel)<span class="op">.</span><span class="fu">updateMask</span>(directions<span class="op">.</span><span class="fu">eq</span>(<span class="dv">1</span>))<span class="op">;</span></span>
<span id="cb64-129"><a href="#cb64-129" tabindex="-1"></a>  <span class="kw">var</span> dir_var <span class="op">=</span> img<span class="op">.</span><span class="fu">reduceNeighborhood</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">variance</span>()<span class="op">,</span> rect_kernel)<span class="op">.</span><span class="fu">updateMask</span>(directions<span class="op">.</span><span class="fu">eq</span>(<span class="dv">1</span>))<span class="op">;</span></span>
<span id="cb64-130"><a href="#cb64-130" tabindex="-1"></a></span>
<span id="cb64-131"><a href="#cb64-131" tabindex="-1"></a>  dir_mean <span class="op">=</span> dir_mean<span class="op">.</span><span class="fu">addBands</span>(img<span class="op">.</span><span class="fu">reduceNeighborhood</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">mean</span>()<span class="op">,</span> diag_kernel)<span class="op">.</span><span class="fu">updateMask</span>(directions<span class="op">.</span><span class="fu">eq</span>(<span class="dv">2</span>)))<span class="op">;</span></span>
<span id="cb64-132"><a href="#cb64-132" tabindex="-1"></a>  dir_var <span class="op">=</span> dir_var<span class="op">.</span><span class="fu">addBands</span>(img<span class="op">.</span><span class="fu">reduceNeighborhood</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">variance</span>()<span class="op">,</span> diag_kernel)<span class="op">.</span><span class="fu">updateMask</span>(directions<span class="op">.</span><span class="fu">eq</span>(<span class="dv">2</span>)))<span class="op">;</span></span>
<span id="cb64-133"><a href="#cb64-133" tabindex="-1"></a></span>
<span id="cb64-134"><a href="#cb64-134" tabindex="-1"></a>  <span class="co">// and add the bands for rotated kernels</span></span>
<span id="cb64-135"><a href="#cb64-135" tabindex="-1"></a>  <span class="cf">for</span> (<span class="kw">var</span> i<span class="op">=</span><span class="dv">1</span><span class="op">;</span> i<span class="op">&lt;</span><span class="dv">4</span><span class="op">;</span> i<span class="op">++</span>) {</span>
<span id="cb64-136"><a href="#cb64-136" tabindex="-1"></a>    dir_mean <span class="op">=</span> dir_mean<span class="op">.</span><span class="fu">addBands</span>(img<span class="op">.</span><span class="fu">reduceNeighborhood</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">mean</span>()<span class="op">,</span> rect_kernel<span class="op">.</span><span class="fu">rotate</span>(i))<span class="op">.</span><span class="fu">updateMask</span>(directions<span class="op">.</span><span class="fu">eq</span>(<span class="dv">2</span><span class="op">*</span>i<span class="op">+</span><span class="dv">1</span>)))<span class="op">;</span></span>
<span id="cb64-137"><a href="#cb64-137" tabindex="-1"></a>    dir_var <span class="op">=</span> dir_var<span class="op">.</span><span class="fu">addBands</span>(img<span class="op">.</span><span class="fu">reduceNeighborhood</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">variance</span>()<span class="op">,</span> rect_kernel<span class="op">.</span><span class="fu">rotate</span>(i))<span class="op">.</span><span class="fu">updateMask</span>(directions<span class="op">.</span><span class="fu">eq</span>(<span class="dv">2</span><span class="op">*</span>i<span class="op">+</span><span class="dv">1</span>)))<span class="op">;</span></span>
<span id="cb64-138"><a href="#cb64-138" tabindex="-1"></a>    dir_mean <span class="op">=</span> dir_mean<span class="op">.</span><span class="fu">addBands</span>(img<span class="op">.</span><span class="fu">reduceNeighborhood</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">mean</span>()<span class="op">,</span> diag_kernel<span class="op">.</span><span class="fu">rotate</span>(i))<span class="op">.</span><span class="fu">updateMask</span>(directions<span class="op">.</span><span class="fu">eq</span>(<span class="dv">2</span><span class="op">*</span>i<span class="op">+</span><span class="dv">2</span>)))<span class="op">;</span></span>
<span id="cb64-139"><a href="#cb64-139" tabindex="-1"></a>    dir_var <span class="op">=</span> dir_var<span class="op">.</span><span class="fu">addBands</span>(img<span class="op">.</span><span class="fu">reduceNeighborhood</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">variance</span>()<span class="op">,</span> diag_kernel<span class="op">.</span><span class="fu">rotate</span>(i))<span class="op">.</span><span class="fu">updateMask</span>(directions<span class="op">.</span><span class="fu">eq</span>(<span class="dv">2</span><span class="op">*</span>i<span class="op">+</span><span class="dv">2</span>)))<span class="op">;</span></span>
<span id="cb64-140"><a href="#cb64-140" tabindex="-1"></a>  }</span>
<span id="cb64-141"><a href="#cb64-141" tabindex="-1"></a></span>
<span id="cb64-142"><a href="#cb64-142" tabindex="-1"></a>  <span class="co">// &quot;collapse&quot; the stack into a single band image (due to masking, each pixel has just one value in it&#39;s directional band, and is otherwise masked)</span></span>
<span id="cb64-143"><a href="#cb64-143" tabindex="-1"></a>  dir_mean <span class="op">=</span> dir_mean<span class="op">.</span><span class="fu">reduce</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">sum</span>())<span class="op">;</span></span>
<span id="cb64-144"><a href="#cb64-144" tabindex="-1"></a>  dir_var <span class="op">=</span> dir_var<span class="op">.</span><span class="fu">reduce</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">sum</span>())<span class="op">;</span></span>
<span id="cb64-145"><a href="#cb64-145" tabindex="-1"></a></span>
<span id="cb64-146"><a href="#cb64-146" tabindex="-1"></a>  <span class="co">// A finally generate the filtered value</span></span>
<span id="cb64-147"><a href="#cb64-147" tabindex="-1"></a>  <span class="kw">var</span> varX <span class="op">=</span> dir_var<span class="op">.</span><span class="fu">subtract</span>(dir_mean<span class="op">.</span><span class="fu">multiply</span>(dir_mean)<span class="op">.</span><span class="fu">multiply</span>(sigmaV))<span class="op">.</span><span class="fu">divide</span>(sigmaV<span class="op">.</span><span class="fu">add</span>(<span class="fl">1.0</span>))<span class="op">;</span></span>
<span id="cb64-148"><a href="#cb64-148" tabindex="-1"></a></span>
<span id="cb64-149"><a href="#cb64-149" tabindex="-1"></a>  <span class="kw">var</span> b <span class="op">=</span> varX<span class="op">.</span><span class="fu">divide</span>(dir_var)<span class="op">;</span></span>
<span id="cb64-150"><a href="#cb64-150" tabindex="-1"></a></span>
<span id="cb64-151"><a href="#cb64-151" tabindex="-1"></a>  <span class="kw">var</span> result <span class="op">=</span> dir_mean<span class="op">.</span><span class="fu">add</span>(b<span class="op">.</span><span class="fu">multiply</span>(img<span class="op">.</span><span class="fu">subtract</span>(dir_mean)))<span class="op">;</span></span>
<span id="cb64-152"><a href="#cb64-152" tabindex="-1"></a>  <span class="cf">return</span>(result<span class="op">.</span><span class="fu">arrayFlatten</span>([[<span class="st">&#39;sum&#39;</span>]]))<span class="op">;</span></span>
<span id="cb64-153"><a href="#cb64-153" tabindex="-1"></a>}</span></code></pre></div>
<div id="exercise-30" class="section level3">
<h3>Exercise</h3>
<p><a
href="https://code.earthengine.google.co.in/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3A05-Flood_Mapping%2F03c_Apply_Speckle_Filter_(exercise)"
target="_blank">Try in Code Editor ↗</a></p>
<div class="sourceCode" id="cb65"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb65-1"><a href="#cb65-1" tabindex="-1"></a><span class="kw">var</span> gsw <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(<span class="st">&quot;JRC/GSW1_2/GlobalSurfaceWater&quot;</span>)<span class="op">;</span></span>
<span id="cb65-2"><a href="#cb65-2" tabindex="-1"></a><span class="kw">var</span> admin2 <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">&quot;FAO/GAUL_SIMPLIFIED_500m/2015/level2&quot;</span>)<span class="op">;</span></span>
<span id="cb65-3"><a href="#cb65-3" tabindex="-1"></a><span class="kw">var</span> hydrosheds <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(<span class="st">&quot;WWF/HydroSHEDS/03VFDEM&quot;</span>)<span class="op">;</span></span>
<span id="cb65-4"><a href="#cb65-4" tabindex="-1"></a>    </span>
<span id="cb65-5"><a href="#cb65-5" tabindex="-1"></a><span class="kw">var</span> beforeStart <span class="op">=</span> <span class="st">&#39;2018-07-15&#39;</span></span>
<span id="cb65-6"><a href="#cb65-6" tabindex="-1"></a><span class="kw">var</span> beforeEnd <span class="op">=</span> <span class="st">&#39;2018-08-10&#39;</span></span>
<span id="cb65-7"><a href="#cb65-7" tabindex="-1"></a><span class="kw">var</span> afterStart <span class="op">=</span> <span class="st">&#39;2018-08-10&#39;</span></span>
<span id="cb65-8"><a href="#cb65-8" tabindex="-1"></a><span class="kw">var</span> afterEnd <span class="op">=</span> <span class="st">&#39;2018-08-23&#39;</span></span>
<span id="cb65-9"><a href="#cb65-9" tabindex="-1"></a></span>
<span id="cb65-10"><a href="#cb65-10" tabindex="-1"></a><span class="kw">var</span> ernakulam <span class="op">=</span> admin2<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;ADM2_NAME&#39;</span><span class="op">,</span> <span class="st">&#39;Ernakulam&#39;</span>))</span>
<span id="cb65-11"><a href="#cb65-11" tabindex="-1"></a><span class="kw">var</span> geometry <span class="op">=</span> ernakulam<span class="op">.</span><span class="fu">geometry</span>()</span>
<span id="cb65-12"><a href="#cb65-12" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(geometry<span class="op">,</span> {<span class="dt">color</span><span class="op">:</span> <span class="st">&#39;grey&#39;</span>}<span class="op">,</span> <span class="st">&#39;Ernakulam District&#39;</span>)</span>
<span id="cb65-13"><a href="#cb65-13" tabindex="-1"></a></span>
<span id="cb65-14"><a href="#cb65-14" tabindex="-1"></a><span class="kw">var</span> collection<span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&#39;COPERNICUS/S1_GRD&#39;</span>)</span>
<span id="cb65-15"><a href="#cb65-15" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;instrumentMode&#39;</span><span class="op">,</span><span class="st">&#39;IW&#39;</span>))</span>
<span id="cb65-16"><a href="#cb65-16" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">listContains</span>(<span class="st">&#39;transmitterReceiverPolarisation&#39;</span><span class="op">,</span> <span class="st">&#39;VH&#39;</span>))</span>
<span id="cb65-17"><a href="#cb65-17" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;orbitProperties_pass&#39;</span><span class="op">,</span> <span class="st">&#39;DESCENDING&#39;</span>)) </span>
<span id="cb65-18"><a href="#cb65-18" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;resolution_meters&#39;</span><span class="op">,</span><span class="dv">10</span>))</span>
<span id="cb65-19"><a href="#cb65-19" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">bounds</span>(geometry))</span>
<span id="cb65-20"><a href="#cb65-20" tabindex="-1"></a>  <span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;VH&#39;</span>)<span class="op">;</span></span>
<span id="cb65-21"><a href="#cb65-21" tabindex="-1"></a></span>
<span id="cb65-22"><a href="#cb65-22" tabindex="-1"></a><span class="kw">var</span> beforeCollection <span class="op">=</span> collection</span>
<span id="cb65-23"><a href="#cb65-23" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(beforeStart<span class="op">,</span> beforeEnd))</span>
<span id="cb65-24"><a href="#cb65-24" tabindex="-1"></a></span>
<span id="cb65-25"><a href="#cb65-25" tabindex="-1"></a><span class="kw">var</span> afterCollection <span class="op">=</span> collection</span>
<span id="cb65-26"><a href="#cb65-26" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(afterStart<span class="op">,</span> afterEnd))</span>
<span id="cb65-27"><a href="#cb65-27" tabindex="-1"></a></span>
<span id="cb65-28"><a href="#cb65-28" tabindex="-1"></a><span class="kw">var</span> before <span class="op">=</span> beforeCollection<span class="op">.</span><span class="fu">mosaic</span>()<span class="op">.</span><span class="fu">clip</span>(geometry)<span class="op">;</span></span>
<span id="cb65-29"><a href="#cb65-29" tabindex="-1"></a><span class="kw">var</span> after <span class="op">=</span> afterCollection<span class="op">.</span><span class="fu">mosaic</span>()<span class="op">.</span><span class="fu">clip</span>(geometry)<span class="op">;</span></span>
<span id="cb65-30"><a href="#cb65-30" tabindex="-1"></a></span>
<span id="cb65-31"><a href="#cb65-31" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">centerObject</span>(geometry<span class="op">,</span> <span class="dv">10</span>)</span>
<span id="cb65-32"><a href="#cb65-32" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(before<span class="op">,</span> {<span class="dt">min</span><span class="op">:-</span><span class="dv">25</span><span class="op">,</span><span class="dt">max</span><span class="op">:</span><span class="dv">0</span>}<span class="op">,</span> <span class="st">&#39;Before Floods&#39;</span><span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span></span>
<span id="cb65-33"><a href="#cb65-33" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(after<span class="op">,</span> {<span class="dt">min</span><span class="op">:-</span><span class="dv">25</span><span class="op">,</span><span class="dt">max</span><span class="op">:</span><span class="dv">0</span>}<span class="op">,</span> <span class="st">&#39;After Floods&#39;</span><span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span> </span>
<span id="cb65-34"><a href="#cb65-34" tabindex="-1"></a></span>
<span id="cb65-35"><a href="#cb65-35" tabindex="-1"></a><span class="co">// Exercise</span></span>
<span id="cb65-36"><a href="#cb65-36" tabindex="-1"></a><span class="co">// A simple method for filtering speckles is using</span></span>
<span id="cb65-37"><a href="#cb65-37" tabindex="-1"></a><span class="co">// a focal median filter.</span></span>
<span id="cb65-38"><a href="#cb65-38" tabindex="-1"></a></span>
<span id="cb65-39"><a href="#cb65-39" tabindex="-1"></a><span class="co">// Apply a Focal Median filter on both before and after images</span></span>
<span id="cb65-40"><a href="#cb65-40" tabindex="-1"></a><span class="co">// Use a Circle kernel with a 30 meter radius</span></span>
<span id="cb65-41"><a href="#cb65-41" tabindex="-1"></a><span class="co">// Add the filtered images to the map.</span></span>
<span id="cb65-42"><a href="#cb65-42" tabindex="-1"></a></span>
<span id="cb65-43"><a href="#cb65-43" tabindex="-1"></a><span class="co">// Hint: Use the focalMedian() function</span></span></code></pre></div>
</div>
</div>
<div id="apply-a-threshold" class="section level2">
<h2>04. Apply a Threshold</h2>
<p>A <em>difference</em> image can be created by dividing the <em>after
image</em> by the <em>before image</em>. Then by considering a 25%
change, we can select all the pixel values greater than 1.25. This 1.25
threshold is arbitrary, and it can be updated by trial and error for any
region. In general, considering a 25% change as the initial assumption
is common.</p>
<p>This threshold can be applied using the boolean function
<code>gt()</code>. The resultant will be a binary image where a pixel
value with <em>1</em> represents the flooded region.</p>
<a
href="https://code.earthengine.google.com/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3A05-Flood_Mapping%2F04b_Apply_a_Threshold_(complete)"
target="_blank">Open in Code Editor ↗</a>
<div class="figure" style="text-align: center">
<img src="images/gee_water_resources_management/flood_initialArea.png" alt="Flooded Area" width="75%" />
<p class="caption">
Flooded Area
</p>
</div>
<div class="sourceCode" id="cb66"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb66-1"><a href="#cb66-1" tabindex="-1"></a><span class="kw">var</span> admin2 <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">&quot;FAO/GAUL_SIMPLIFIED_500m/2015/level2&quot;</span>)<span class="op">;</span></span>
<span id="cb66-2"><a href="#cb66-2" tabindex="-1"></a>   </span>
<span id="cb66-3"><a href="#cb66-3" tabindex="-1"></a><span class="kw">var</span> beforeStart <span class="op">=</span> <span class="st">&#39;2018-07-15&#39;</span></span>
<span id="cb66-4"><a href="#cb66-4" tabindex="-1"></a><span class="kw">var</span> beforeEnd <span class="op">=</span> <span class="st">&#39;2018-08-10&#39;</span></span>
<span id="cb66-5"><a href="#cb66-5" tabindex="-1"></a><span class="kw">var</span> afterStart <span class="op">=</span> <span class="st">&#39;2018-08-10&#39;</span></span>
<span id="cb66-6"><a href="#cb66-6" tabindex="-1"></a><span class="kw">var</span> afterEnd <span class="op">=</span> <span class="st">&#39;2018-08-23&#39;</span></span>
<span id="cb66-7"><a href="#cb66-7" tabindex="-1"></a></span>
<span id="cb66-8"><a href="#cb66-8" tabindex="-1"></a><span class="kw">var</span> ernakulam <span class="op">=</span> admin2<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;ADM2_NAME&#39;</span><span class="op">,</span> <span class="st">&#39;Ernakulam&#39;</span>))</span>
<span id="cb66-9"><a href="#cb66-9" tabindex="-1"></a><span class="kw">var</span> geometry <span class="op">=</span> ernakulam<span class="op">.</span><span class="fu">geometry</span>()</span>
<span id="cb66-10"><a href="#cb66-10" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(geometry<span class="op">,</span> {<span class="dt">color</span><span class="op">:</span> <span class="st">&#39;grey&#39;</span>}<span class="op">,</span> <span class="st">&#39;Ernakulam District&#39;</span>)</span>
<span id="cb66-11"><a href="#cb66-11" tabindex="-1"></a></span>
<span id="cb66-12"><a href="#cb66-12" tabindex="-1"></a><span class="kw">var</span> collection<span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&#39;COPERNICUS/S1_GRD&#39;</span>)</span>
<span id="cb66-13"><a href="#cb66-13" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;instrumentMode&#39;</span><span class="op">,</span><span class="st">&#39;IW&#39;</span>))</span>
<span id="cb66-14"><a href="#cb66-14" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">listContains</span>(<span class="st">&#39;transmitterReceiverPolarisation&#39;</span><span class="op">,</span> <span class="st">&#39;VH&#39;</span>))</span>
<span id="cb66-15"><a href="#cb66-15" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;orbitProperties_pass&#39;</span><span class="op">,</span> <span class="st">&#39;DESCENDING&#39;</span>)) </span>
<span id="cb66-16"><a href="#cb66-16" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;resolution_meters&#39;</span><span class="op">,</span><span class="dv">10</span>))</span>
<span id="cb66-17"><a href="#cb66-17" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">bounds</span>(geometry))</span>
<span id="cb66-18"><a href="#cb66-18" tabindex="-1"></a>  <span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;VH&#39;</span>)<span class="op">;</span></span>
<span id="cb66-19"><a href="#cb66-19" tabindex="-1"></a></span>
<span id="cb66-20"><a href="#cb66-20" tabindex="-1"></a><span class="kw">var</span> beforeCollection <span class="op">=</span> collection</span>
<span id="cb66-21"><a href="#cb66-21" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(beforeStart<span class="op">,</span> beforeEnd))</span>
<span id="cb66-22"><a href="#cb66-22" tabindex="-1"></a></span>
<span id="cb66-23"><a href="#cb66-23" tabindex="-1"></a><span class="kw">var</span> afterCollection <span class="op">=</span> collection</span>
<span id="cb66-24"><a href="#cb66-24" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(afterStart<span class="op">,</span> afterEnd))</span>
<span id="cb66-25"><a href="#cb66-25" tabindex="-1"></a>  </span>
<span id="cb66-26"><a href="#cb66-26" tabindex="-1"></a><span class="kw">var</span> before <span class="op">=</span> beforeCollection<span class="op">.</span><span class="fu">mosaic</span>()<span class="op">.</span><span class="fu">clip</span>(geometry)<span class="op">;</span></span>
<span id="cb66-27"><a href="#cb66-27" tabindex="-1"></a><span class="kw">var</span> after <span class="op">=</span> afterCollection<span class="op">.</span><span class="fu">mosaic</span>()<span class="op">.</span><span class="fu">clip</span>(geometry)<span class="op">;</span></span>
<span id="cb66-28"><a href="#cb66-28" tabindex="-1"></a></span>
<span id="cb66-29"><a href="#cb66-29" tabindex="-1"></a><span class="kw">var</span> beforeFiltered <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(<span class="fu">toDB</span>(<span class="fu">RefinedLee</span>(<span class="fu">toNatural</span>(before))))</span>
<span id="cb66-30"><a href="#cb66-30" tabindex="-1"></a><span class="kw">var</span> afterFiltered <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(<span class="fu">toDB</span>(<span class="fu">RefinedLee</span>(<span class="fu">toNatural</span>(after))))</span>
<span id="cb66-31"><a href="#cb66-31" tabindex="-1"></a></span>
<span id="cb66-32"><a href="#cb66-32" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">centerObject</span>(geometry<span class="op">,</span> <span class="dv">10</span>)</span>
<span id="cb66-33"><a href="#cb66-33" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(before<span class="op">,</span> {<span class="dt">min</span><span class="op">:-</span><span class="dv">25</span><span class="op">,</span><span class="dt">max</span><span class="op">:</span><span class="dv">0</span>}<span class="op">,</span> <span class="st">&#39;Before Floods&#39;</span><span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span></span>
<span id="cb66-34"><a href="#cb66-34" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(after<span class="op">,</span> {<span class="dt">min</span><span class="op">:-</span><span class="dv">25</span><span class="op">,</span><span class="dt">max</span><span class="op">:</span><span class="dv">0</span>}<span class="op">,</span> <span class="st">&#39;After Floods&#39;</span><span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span> </span>
<span id="cb66-35"><a href="#cb66-35" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(beforeFiltered<span class="op">,</span> {<span class="dt">min</span><span class="op">:-</span><span class="dv">25</span><span class="op">,</span><span class="dt">max</span><span class="op">:</span><span class="dv">0</span>}<span class="op">,</span> <span class="st">&#39;Before Filtered&#39;</span><span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span></span>
<span id="cb66-36"><a href="#cb66-36" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(afterFiltered<span class="op">,</span> {<span class="dt">min</span><span class="op">:-</span><span class="dv">25</span><span class="op">,</span><span class="dt">max</span><span class="op">:</span><span class="dv">0</span>}<span class="op">,</span> <span class="st">&#39;After Filtered&#39;</span><span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span> </span>
<span id="cb66-37"><a href="#cb66-37" tabindex="-1"></a></span>
<span id="cb66-38"><a href="#cb66-38" tabindex="-1"></a><span class="kw">var</span> difference <span class="op">=</span> afterFiltered<span class="op">.</span><span class="fu">divide</span>(beforeFiltered)<span class="op">;</span></span>
<span id="cb66-39"><a href="#cb66-39" tabindex="-1"></a></span>
<span id="cb66-40"><a href="#cb66-40" tabindex="-1"></a><span class="co">// Define a threshold</span></span>
<span id="cb66-41"><a href="#cb66-41" tabindex="-1"></a><span class="kw">var</span> diffThreshold <span class="op">=</span> <span class="fl">1.25</span><span class="op">;</span></span>
<span id="cb66-42"><a href="#cb66-42" tabindex="-1"></a><span class="co">// Initial estimate of flooded pixels</span></span>
<span id="cb66-43"><a href="#cb66-43" tabindex="-1"></a><span class="kw">var</span> flooded <span class="op">=</span> difference<span class="op">.</span><span class="fu">gt</span>(diffThreshold)<span class="op">.</span><span class="fu">rename</span>(<span class="st">&#39;water&#39;</span>)<span class="op">.</span><span class="fu">selfMask</span>()<span class="op">;</span></span>
<span id="cb66-44"><a href="#cb66-44" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(flooded<span class="op">,</span> {<span class="dt">min</span><span class="op">:</span><span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span><span class="dv">1</span><span class="op">,</span> <span class="dt">palette</span><span class="op">:</span> [<span class="st">&#39;orange&#39;</span>]}<span class="op">,</span> <span class="st">&#39;Initial Flood Area&#39;</span><span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span></span>
<span id="cb66-45"><a href="#cb66-45" tabindex="-1"></a></span>
<span id="cb66-46"><a href="#cb66-46" tabindex="-1"></a></span>
<span id="cb66-47"><a href="#cb66-47" tabindex="-1"></a><span class="co">//############################</span></span>
<span id="cb66-48"><a href="#cb66-48" tabindex="-1"></a><span class="co">// Speckle Filtering Functions</span></span>
<span id="cb66-49"><a href="#cb66-49" tabindex="-1"></a><span class="co">//############################</span></span>
<span id="cb66-50"><a href="#cb66-50" tabindex="-1"></a></span>
<span id="cb66-51"><a href="#cb66-51" tabindex="-1"></a><span class="co">// Function to convert from dB</span></span>
<span id="cb66-52"><a href="#cb66-52" tabindex="-1"></a><span class="kw">function</span> <span class="fu">toNatural</span>(img) {</span>
<span id="cb66-53"><a href="#cb66-53" tabindex="-1"></a>  <span class="cf">return</span> ee<span class="op">.</span><span class="fu">Image</span>(<span class="fl">10.0</span>)<span class="op">.</span><span class="fu">pow</span>(img<span class="op">.</span><span class="fu">select</span>(<span class="dv">0</span>)<span class="op">.</span><span class="fu">divide</span>(<span class="fl">10.0</span>))<span class="op">;</span></span>
<span id="cb66-54"><a href="#cb66-54" tabindex="-1"></a>}</span>
<span id="cb66-55"><a href="#cb66-55" tabindex="-1"></a></span>
<span id="cb66-56"><a href="#cb66-56" tabindex="-1"></a><span class="co">//Function to convert to dB</span></span>
<span id="cb66-57"><a href="#cb66-57" tabindex="-1"></a><span class="kw">function</span> <span class="fu">toDB</span>(img) {</span>
<span id="cb66-58"><a href="#cb66-58" tabindex="-1"></a>  <span class="cf">return</span> ee<span class="op">.</span><span class="fu">Image</span>(img)<span class="op">.</span><span class="fu">log10</span>()<span class="op">.</span><span class="fu">multiply</span>(<span class="fl">10.0</span>)<span class="op">;</span></span>
<span id="cb66-59"><a href="#cb66-59" tabindex="-1"></a>}</span>
<span id="cb66-60"><a href="#cb66-60" tabindex="-1"></a></span>
<span id="cb66-61"><a href="#cb66-61" tabindex="-1"></a><span class="co">//Apllying a Refined Lee Speckle filter as coded in the SNAP 3.0 S1TBX:</span></span>
<span id="cb66-62"><a href="#cb66-62" tabindex="-1"></a></span>
<span id="cb66-63"><a href="#cb66-63" tabindex="-1"></a><span class="co">//https://github.com/senbox-org/s1tbx/blob/master/s1tbx-op-sar-processing/src/main/java/org/esa/s1tbx/sar/gpf/filtering/SpeckleFilters/RefinedLee.java</span></span>
<span id="cb66-64"><a href="#cb66-64" tabindex="-1"></a><span class="co">//Adapted by Guido Lemoine</span></span>
<span id="cb66-65"><a href="#cb66-65" tabindex="-1"></a></span>
<span id="cb66-66"><a href="#cb66-66" tabindex="-1"></a><span class="co">// by Guido Lemoine</span></span>
<span id="cb66-67"><a href="#cb66-67" tabindex="-1"></a><span class="kw">function</span> <span class="fu">RefinedLee</span>(img) {</span>
<span id="cb66-68"><a href="#cb66-68" tabindex="-1"></a>  <span class="co">// img must be in natural units, i.e. not in dB!</span></span>
<span id="cb66-69"><a href="#cb66-69" tabindex="-1"></a>  <span class="co">// Set up 3x3 kernels </span></span>
<span id="cb66-70"><a href="#cb66-70" tabindex="-1"></a>  <span class="kw">var</span> weights3 <span class="op">=</span> ee<span class="op">.</span><span class="at">List</span><span class="op">.</span><span class="fu">repeat</span>(ee<span class="op">.</span><span class="at">List</span><span class="op">.</span><span class="fu">repeat</span>(<span class="dv">1</span><span class="op">,</span><span class="dv">3</span>)<span class="op">,</span><span class="dv">3</span>)<span class="op">;</span></span>
<span id="cb66-71"><a href="#cb66-71" tabindex="-1"></a>  <span class="kw">var</span> kernel3 <span class="op">=</span> ee<span class="op">.</span><span class="at">Kernel</span><span class="op">.</span><span class="fu">fixed</span>(<span class="dv">3</span><span class="op">,</span><span class="dv">3</span><span class="op">,</span> weights3<span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span></span>
<span id="cb66-72"><a href="#cb66-72" tabindex="-1"></a></span>
<span id="cb66-73"><a href="#cb66-73" tabindex="-1"></a>  <span class="kw">var</span> mean3 <span class="op">=</span> img<span class="op">.</span><span class="fu">reduceNeighborhood</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">mean</span>()<span class="op">,</span> kernel3)<span class="op">;</span></span>
<span id="cb66-74"><a href="#cb66-74" tabindex="-1"></a>  <span class="kw">var</span> variance3 <span class="op">=</span> img<span class="op">.</span><span class="fu">reduceNeighborhood</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">variance</span>()<span class="op">,</span> kernel3)<span class="op">;</span></span>
<span id="cb66-75"><a href="#cb66-75" tabindex="-1"></a></span>
<span id="cb66-76"><a href="#cb66-76" tabindex="-1"></a>  <span class="co">// Use a sample of the 3x3 windows inside a 7x7 windows to determine gradients and directions</span></span>
<span id="cb66-77"><a href="#cb66-77" tabindex="-1"></a>  <span class="kw">var</span> sample_weights <span class="op">=</span> ee<span class="op">.</span><span class="fu">List</span>([[<span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span>]<span class="op">,</span> [<span class="dv">0</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span>]<span class="op">,</span>[<span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span>]<span class="op">,</span> [<span class="dv">0</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span>]<span class="op">,</span> [<span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span>]<span class="op">,</span> [<span class="dv">0</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span>]<span class="op">,</span>[<span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span>]])<span class="op">;</span></span>
<span id="cb66-78"><a href="#cb66-78" tabindex="-1"></a></span>
<span id="cb66-79"><a href="#cb66-79" tabindex="-1"></a>  <span class="kw">var</span> sample_kernel <span class="op">=</span> ee<span class="op">.</span><span class="at">Kernel</span><span class="op">.</span><span class="fu">fixed</span>(<span class="dv">7</span><span class="op">,</span><span class="dv">7</span><span class="op">,</span> sample_weights<span class="op">,</span> <span class="dv">3</span><span class="op">,</span><span class="dv">3</span><span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span></span>
<span id="cb66-80"><a href="#cb66-80" tabindex="-1"></a></span>
<span id="cb66-81"><a href="#cb66-81" tabindex="-1"></a>  <span class="co">// Calculate mean and variance for the sampled windows and store as 9 bands</span></span>
<span id="cb66-82"><a href="#cb66-82" tabindex="-1"></a>  <span class="kw">var</span> sample_mean <span class="op">=</span> mean3<span class="op">.</span><span class="fu">neighborhoodToBands</span>(sample_kernel)<span class="op">;</span> </span>
<span id="cb66-83"><a href="#cb66-83" tabindex="-1"></a>  <span class="kw">var</span> sample_var <span class="op">=</span> variance3<span class="op">.</span><span class="fu">neighborhoodToBands</span>(sample_kernel)<span class="op">;</span></span>
<span id="cb66-84"><a href="#cb66-84" tabindex="-1"></a></span>
<span id="cb66-85"><a href="#cb66-85" tabindex="-1"></a>  <span class="co">// Determine the 4 gradients for the sampled windows</span></span>
<span id="cb66-86"><a href="#cb66-86" tabindex="-1"></a>  <span class="kw">var</span> gradients <span class="op">=</span> sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">1</span>)<span class="op">.</span><span class="fu">subtract</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">7</span>))<span class="op">.</span><span class="fu">abs</span>()<span class="op">;</span></span>
<span id="cb66-87"><a href="#cb66-87" tabindex="-1"></a>  gradients <span class="op">=</span> gradients<span class="op">.</span><span class="fu">addBands</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">6</span>)<span class="op">.</span><span class="fu">subtract</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">2</span>))<span class="op">.</span><span class="fu">abs</span>())<span class="op">;</span></span>
<span id="cb66-88"><a href="#cb66-88" tabindex="-1"></a>  gradients <span class="op">=</span> gradients<span class="op">.</span><span class="fu">addBands</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">3</span>)<span class="op">.</span><span class="fu">subtract</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">5</span>))<span class="op">.</span><span class="fu">abs</span>())<span class="op">;</span></span>
<span id="cb66-89"><a href="#cb66-89" tabindex="-1"></a>  gradients <span class="op">=</span> gradients<span class="op">.</span><span class="fu">addBands</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">0</span>)<span class="op">.</span><span class="fu">subtract</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">8</span>))<span class="op">.</span><span class="fu">abs</span>())<span class="op">;</span></span>
<span id="cb66-90"><a href="#cb66-90" tabindex="-1"></a></span>
<span id="cb66-91"><a href="#cb66-91" tabindex="-1"></a>  <span class="co">// And find the maximum gradient amongst gradient bands</span></span>
<span id="cb66-92"><a href="#cb66-92" tabindex="-1"></a>  <span class="kw">var</span> max_gradient <span class="op">=</span> gradients<span class="op">.</span><span class="fu">reduce</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">max</span>())<span class="op">;</span></span>
<span id="cb66-93"><a href="#cb66-93" tabindex="-1"></a></span>
<span id="cb66-94"><a href="#cb66-94" tabindex="-1"></a>  <span class="co">// Create a mask for band pixels that are the maximum gradient</span></span>
<span id="cb66-95"><a href="#cb66-95" tabindex="-1"></a>  <span class="kw">var</span> gradmask <span class="op">=</span> gradients<span class="op">.</span><span class="fu">eq</span>(max_gradient)<span class="op">;</span></span>
<span id="cb66-96"><a href="#cb66-96" tabindex="-1"></a></span>
<span id="cb66-97"><a href="#cb66-97" tabindex="-1"></a>  <span class="co">// duplicate gradmask bands: each gradient represents 2 directions</span></span>
<span id="cb66-98"><a href="#cb66-98" tabindex="-1"></a>  gradmask <span class="op">=</span> gradmask<span class="op">.</span><span class="fu">addBands</span>(gradmask)<span class="op">;</span></span>
<span id="cb66-99"><a href="#cb66-99" tabindex="-1"></a></span>
<span id="cb66-100"><a href="#cb66-100" tabindex="-1"></a>  <span class="co">// Determine the 8 directions</span></span>
<span id="cb66-101"><a href="#cb66-101" tabindex="-1"></a>  <span class="kw">var</span> directions <span class="op">=</span> sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">1</span>)<span class="op">.</span><span class="fu">subtract</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">4</span>))<span class="op">.</span><span class="fu">gt</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">4</span>)<span class="op">.</span><span class="fu">subtract</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">7</span>)))<span class="op">.</span><span class="fu">multiply</span>(<span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb66-102"><a href="#cb66-102" tabindex="-1"></a>  directions <span class="op">=</span> directions<span class="op">.</span><span class="fu">addBands</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">6</span>)<span class="op">.</span><span class="fu">subtract</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">4</span>))<span class="op">.</span><span class="fu">gt</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">4</span>)<span class="op">.</span><span class="fu">subtract</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">2</span>)))<span class="op">.</span><span class="fu">multiply</span>(<span class="dv">2</span>))<span class="op">;</span></span>
<span id="cb66-103"><a href="#cb66-103" tabindex="-1"></a>  directions <span class="op">=</span> directions<span class="op">.</span><span class="fu">addBands</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">3</span>)<span class="op">.</span><span class="fu">subtract</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">4</span>))<span class="op">.</span><span class="fu">gt</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">4</span>)<span class="op">.</span><span class="fu">subtract</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">5</span>)))<span class="op">.</span><span class="fu">multiply</span>(<span class="dv">3</span>))<span class="op">;</span></span>
<span id="cb66-104"><a href="#cb66-104" tabindex="-1"></a>  directions <span class="op">=</span> directions<span class="op">.</span><span class="fu">addBands</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">0</span>)<span class="op">.</span><span class="fu">subtract</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">4</span>))<span class="op">.</span><span class="fu">gt</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">4</span>)<span class="op">.</span><span class="fu">subtract</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">8</span>)))<span class="op">.</span><span class="fu">multiply</span>(<span class="dv">4</span>))<span class="op">;</span></span>
<span id="cb66-105"><a href="#cb66-105" tabindex="-1"></a>  <span class="co">// The next 4 are the not() of the previous 4</span></span>
<span id="cb66-106"><a href="#cb66-106" tabindex="-1"></a>  directions <span class="op">=</span> directions<span class="op">.</span><span class="fu">addBands</span>(directions<span class="op">.</span><span class="fu">select</span>(<span class="dv">0</span>)<span class="op">.</span><span class="fu">not</span>()<span class="op">.</span><span class="fu">multiply</span>(<span class="dv">5</span>))<span class="op">;</span></span>
<span id="cb66-107"><a href="#cb66-107" tabindex="-1"></a>  directions <span class="op">=</span> directions<span class="op">.</span><span class="fu">addBands</span>(directions<span class="op">.</span><span class="fu">select</span>(<span class="dv">1</span>)<span class="op">.</span><span class="fu">not</span>()<span class="op">.</span><span class="fu">multiply</span>(<span class="dv">6</span>))<span class="op">;</span></span>
<span id="cb66-108"><a href="#cb66-108" tabindex="-1"></a>  directions <span class="op">=</span> directions<span class="op">.</span><span class="fu">addBands</span>(directions<span class="op">.</span><span class="fu">select</span>(<span class="dv">2</span>)<span class="op">.</span><span class="fu">not</span>()<span class="op">.</span><span class="fu">multiply</span>(<span class="dv">7</span>))<span class="op">;</span></span>
<span id="cb66-109"><a href="#cb66-109" tabindex="-1"></a>  directions <span class="op">=</span> directions<span class="op">.</span><span class="fu">addBands</span>(directions<span class="op">.</span><span class="fu">select</span>(<span class="dv">3</span>)<span class="op">.</span><span class="fu">not</span>()<span class="op">.</span><span class="fu">multiply</span>(<span class="dv">8</span>))<span class="op">;</span></span>
<span id="cb66-110"><a href="#cb66-110" tabindex="-1"></a></span>
<span id="cb66-111"><a href="#cb66-111" tabindex="-1"></a>  <span class="co">// Mask all values that are not 1-8</span></span>
<span id="cb66-112"><a href="#cb66-112" tabindex="-1"></a>  directions <span class="op">=</span> directions<span class="op">.</span><span class="fu">updateMask</span>(gradmask)<span class="op">;</span></span>
<span id="cb66-113"><a href="#cb66-113" tabindex="-1"></a></span>
<span id="cb66-114"><a href="#cb66-114" tabindex="-1"></a>  <span class="co">// &quot;collapse&quot; the stack into a singe band image (due to masking, each pixel has just one value (1-8) in it&#39;s directional band, and is otherwise masked)</span></span>
<span id="cb66-115"><a href="#cb66-115" tabindex="-1"></a>  directions <span class="op">=</span> directions<span class="op">.</span><span class="fu">reduce</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">sum</span>())<span class="op">;</span>  </span>
<span id="cb66-116"><a href="#cb66-116" tabindex="-1"></a></span>
<span id="cb66-117"><a href="#cb66-117" tabindex="-1"></a>  <span class="co">//var pal = [&#39;ffffff&#39;,&#39;ff0000&#39;,&#39;ffff00&#39;, &#39;00ff00&#39;, &#39;00ffff&#39;, &#39;0000ff&#39;, &#39;ff00ff&#39;, &#39;000000&#39;];</span></span>
<span id="cb66-118"><a href="#cb66-118" tabindex="-1"></a>  <span class="co">//Map.addLayer(directions.reduce(ee.Reducer.sum()), {min:1, max:8, palette: pal}, &#39;Directions&#39;, false);</span></span>
<span id="cb66-119"><a href="#cb66-119" tabindex="-1"></a></span>
<span id="cb66-120"><a href="#cb66-120" tabindex="-1"></a>  <span class="kw">var</span> sample_stats <span class="op">=</span> sample_var<span class="op">.</span><span class="fu">divide</span>(sample_mean<span class="op">.</span><span class="fu">multiply</span>(sample_mean))<span class="op">;</span></span>
<span id="cb66-121"><a href="#cb66-121" tabindex="-1"></a></span>
<span id="cb66-122"><a href="#cb66-122" tabindex="-1"></a>  <span class="co">// Calculate localNoiseVariance</span></span>
<span id="cb66-123"><a href="#cb66-123" tabindex="-1"></a>  <span class="kw">var</span> sigmaV <span class="op">=</span> sample_stats<span class="op">.</span><span class="fu">toArray</span>()<span class="op">.</span><span class="fu">arraySort</span>()<span class="op">.</span><span class="fu">arraySlice</span>(<span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">5</span>)<span class="op">.</span><span class="fu">arrayReduce</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">mean</span>()<span class="op">,</span> [<span class="dv">0</span>])<span class="op">;</span></span>
<span id="cb66-124"><a href="#cb66-124" tabindex="-1"></a></span>
<span id="cb66-125"><a href="#cb66-125" tabindex="-1"></a>  <span class="co">// Set up the 7*7 kernels for directional statistics</span></span>
<span id="cb66-126"><a href="#cb66-126" tabindex="-1"></a>  <span class="kw">var</span> rect_weights <span class="op">=</span> ee<span class="op">.</span><span class="at">List</span><span class="op">.</span><span class="fu">repeat</span>(ee<span class="op">.</span><span class="at">List</span><span class="op">.</span><span class="fu">repeat</span>(<span class="dv">0</span><span class="op">,</span><span class="dv">7</span>)<span class="op">,</span><span class="dv">3</span>)<span class="op">.</span><span class="fu">cat</span>(ee<span class="op">.</span><span class="at">List</span><span class="op">.</span><span class="fu">repeat</span>(ee<span class="op">.</span><span class="at">List</span><span class="op">.</span><span class="fu">repeat</span>(<span class="dv">1</span><span class="op">,</span><span class="dv">7</span>)<span class="op">,</span><span class="dv">4</span>))<span class="op">;</span></span>
<span id="cb66-127"><a href="#cb66-127" tabindex="-1"></a></span>
<span id="cb66-128"><a href="#cb66-128" tabindex="-1"></a>  <span class="kw">var</span> diag_weights <span class="op">=</span> ee<span class="op">.</span><span class="fu">List</span>([[<span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span>]<span class="op">,</span> [<span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span>]<span class="op">,</span> [<span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span>]<span class="op">,</span> </span>
<span id="cb66-129"><a href="#cb66-129" tabindex="-1"></a>    [<span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span>]<span class="op">,</span> [<span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span>]<span class="op">,</span> [<span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span>]<span class="op">,</span> [<span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span>]])<span class="op">;</span></span>
<span id="cb66-130"><a href="#cb66-130" tabindex="-1"></a></span>
<span id="cb66-131"><a href="#cb66-131" tabindex="-1"></a>  <span class="kw">var</span> rect_kernel <span class="op">=</span> ee<span class="op">.</span><span class="at">Kernel</span><span class="op">.</span><span class="fu">fixed</span>(<span class="dv">7</span><span class="op">,</span><span class="dv">7</span><span class="op">,</span> rect_weights<span class="op">,</span> <span class="dv">3</span><span class="op">,</span> <span class="dv">3</span><span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span></span>
<span id="cb66-132"><a href="#cb66-132" tabindex="-1"></a>  <span class="kw">var</span> diag_kernel <span class="op">=</span> ee<span class="op">.</span><span class="at">Kernel</span><span class="op">.</span><span class="fu">fixed</span>(<span class="dv">7</span><span class="op">,</span><span class="dv">7</span><span class="op">,</span> diag_weights<span class="op">,</span> <span class="dv">3</span><span class="op">,</span> <span class="dv">3</span><span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span></span>
<span id="cb66-133"><a href="#cb66-133" tabindex="-1"></a></span>
<span id="cb66-134"><a href="#cb66-134" tabindex="-1"></a>  <span class="co">// Create stacks for mean and variance using the original kernels. Mask with relevant direction.</span></span>
<span id="cb66-135"><a href="#cb66-135" tabindex="-1"></a>  <span class="kw">var</span> dir_mean <span class="op">=</span> img<span class="op">.</span><span class="fu">reduceNeighborhood</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">mean</span>()<span class="op">,</span> rect_kernel)<span class="op">.</span><span class="fu">updateMask</span>(directions<span class="op">.</span><span class="fu">eq</span>(<span class="dv">1</span>))<span class="op">;</span></span>
<span id="cb66-136"><a href="#cb66-136" tabindex="-1"></a>  <span class="kw">var</span> dir_var <span class="op">=</span> img<span class="op">.</span><span class="fu">reduceNeighborhood</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">variance</span>()<span class="op">,</span> rect_kernel)<span class="op">.</span><span class="fu">updateMask</span>(directions<span class="op">.</span><span class="fu">eq</span>(<span class="dv">1</span>))<span class="op">;</span></span>
<span id="cb66-137"><a href="#cb66-137" tabindex="-1"></a></span>
<span id="cb66-138"><a href="#cb66-138" tabindex="-1"></a>  dir_mean <span class="op">=</span> dir_mean<span class="op">.</span><span class="fu">addBands</span>(img<span class="op">.</span><span class="fu">reduceNeighborhood</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">mean</span>()<span class="op">,</span> diag_kernel)<span class="op">.</span><span class="fu">updateMask</span>(directions<span class="op">.</span><span class="fu">eq</span>(<span class="dv">2</span>)))<span class="op">;</span></span>
<span id="cb66-139"><a href="#cb66-139" tabindex="-1"></a>  dir_var <span class="op">=</span> dir_var<span class="op">.</span><span class="fu">addBands</span>(img<span class="op">.</span><span class="fu">reduceNeighborhood</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">variance</span>()<span class="op">,</span> diag_kernel)<span class="op">.</span><span class="fu">updateMask</span>(directions<span class="op">.</span><span class="fu">eq</span>(<span class="dv">2</span>)))<span class="op">;</span></span>
<span id="cb66-140"><a href="#cb66-140" tabindex="-1"></a></span>
<span id="cb66-141"><a href="#cb66-141" tabindex="-1"></a>  <span class="co">// and add the bands for rotated kernels</span></span>
<span id="cb66-142"><a href="#cb66-142" tabindex="-1"></a>  <span class="cf">for</span> (<span class="kw">var</span> i<span class="op">=</span><span class="dv">1</span><span class="op">;</span> i<span class="op">&lt;</span><span class="dv">4</span><span class="op">;</span> i<span class="op">++</span>) {</span>
<span id="cb66-143"><a href="#cb66-143" tabindex="-1"></a>    dir_mean <span class="op">=</span> dir_mean<span class="op">.</span><span class="fu">addBands</span>(img<span class="op">.</span><span class="fu">reduceNeighborhood</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">mean</span>()<span class="op">,</span> rect_kernel<span class="op">.</span><span class="fu">rotate</span>(i))<span class="op">.</span><span class="fu">updateMask</span>(directions<span class="op">.</span><span class="fu">eq</span>(<span class="dv">2</span><span class="op">*</span>i<span class="op">+</span><span class="dv">1</span>)))<span class="op">;</span></span>
<span id="cb66-144"><a href="#cb66-144" tabindex="-1"></a>    dir_var <span class="op">=</span> dir_var<span class="op">.</span><span class="fu">addBands</span>(img<span class="op">.</span><span class="fu">reduceNeighborhood</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">variance</span>()<span class="op">,</span> rect_kernel<span class="op">.</span><span class="fu">rotate</span>(i))<span class="op">.</span><span class="fu">updateMask</span>(directions<span class="op">.</span><span class="fu">eq</span>(<span class="dv">2</span><span class="op">*</span>i<span class="op">+</span><span class="dv">1</span>)))<span class="op">;</span></span>
<span id="cb66-145"><a href="#cb66-145" tabindex="-1"></a>    dir_mean <span class="op">=</span> dir_mean<span class="op">.</span><span class="fu">addBands</span>(img<span class="op">.</span><span class="fu">reduceNeighborhood</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">mean</span>()<span class="op">,</span> diag_kernel<span class="op">.</span><span class="fu">rotate</span>(i))<span class="op">.</span><span class="fu">updateMask</span>(directions<span class="op">.</span><span class="fu">eq</span>(<span class="dv">2</span><span class="op">*</span>i<span class="op">+</span><span class="dv">2</span>)))<span class="op">;</span></span>
<span id="cb66-146"><a href="#cb66-146" tabindex="-1"></a>    dir_var <span class="op">=</span> dir_var<span class="op">.</span><span class="fu">addBands</span>(img<span class="op">.</span><span class="fu">reduceNeighborhood</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">variance</span>()<span class="op">,</span> diag_kernel<span class="op">.</span><span class="fu">rotate</span>(i))<span class="op">.</span><span class="fu">updateMask</span>(directions<span class="op">.</span><span class="fu">eq</span>(<span class="dv">2</span><span class="op">*</span>i<span class="op">+</span><span class="dv">2</span>)))<span class="op">;</span></span>
<span id="cb66-147"><a href="#cb66-147" tabindex="-1"></a>  }</span>
<span id="cb66-148"><a href="#cb66-148" tabindex="-1"></a></span>
<span id="cb66-149"><a href="#cb66-149" tabindex="-1"></a>  <span class="co">// &quot;collapse&quot; the stack into a single band image (due to masking, each pixel has just one value in it&#39;s directional band, and is otherwise masked)</span></span>
<span id="cb66-150"><a href="#cb66-150" tabindex="-1"></a>  dir_mean <span class="op">=</span> dir_mean<span class="op">.</span><span class="fu">reduce</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">sum</span>())<span class="op">;</span></span>
<span id="cb66-151"><a href="#cb66-151" tabindex="-1"></a>  dir_var <span class="op">=</span> dir_var<span class="op">.</span><span class="fu">reduce</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">sum</span>())<span class="op">;</span></span>
<span id="cb66-152"><a href="#cb66-152" tabindex="-1"></a></span>
<span id="cb66-153"><a href="#cb66-153" tabindex="-1"></a>  <span class="co">// A finally generate the filtered value</span></span>
<span id="cb66-154"><a href="#cb66-154" tabindex="-1"></a>  <span class="kw">var</span> varX <span class="op">=</span> dir_var<span class="op">.</span><span class="fu">subtract</span>(dir_mean<span class="op">.</span><span class="fu">multiply</span>(dir_mean)<span class="op">.</span><span class="fu">multiply</span>(sigmaV))<span class="op">.</span><span class="fu">divide</span>(sigmaV<span class="op">.</span><span class="fu">add</span>(<span class="fl">1.0</span>))<span class="op">;</span></span>
<span id="cb66-155"><a href="#cb66-155" tabindex="-1"></a></span>
<span id="cb66-156"><a href="#cb66-156" tabindex="-1"></a>  <span class="kw">var</span> b <span class="op">=</span> varX<span class="op">.</span><span class="fu">divide</span>(dir_var)<span class="op">;</span></span>
<span id="cb66-157"><a href="#cb66-157" tabindex="-1"></a></span>
<span id="cb66-158"><a href="#cb66-158" tabindex="-1"></a>  <span class="kw">var</span> result <span class="op">=</span> dir_mean<span class="op">.</span><span class="fu">add</span>(b<span class="op">.</span><span class="fu">multiply</span>(img<span class="op">.</span><span class="fu">subtract</span>(dir_mean)))<span class="op">;</span></span>
<span id="cb66-159"><a href="#cb66-159" tabindex="-1"></a>  <span class="cf">return</span>(result<span class="op">.</span><span class="fu">arrayFlatten</span>([[<span class="st">&#39;sum&#39;</span>]]))<span class="op">;</span></span>
<span id="cb66-160"><a href="#cb66-160" tabindex="-1"></a>}</span></code></pre></div>
<div id="exercise-31" class="section level3">
<h3>Exercise</h3>
<p><a
href="https://code.earthengine.google.com/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3A05-Flood_Mapping%2F04c_Apply_a_Threshold_(exercise)"
target="_blank">Try in Code Editor ↗</a></p>
<p>This exercise script is adopted from UN-SPIDER’s recommended approach
to computing the flooded region.</p>
<p>Compute the <em>difference</em> image by finding the difference
between the after and before images. Use a threshold of -3 (arbitrary
value) to identify the initial flooded regions. Click <em>Try in Code
Editor</em> to view the complete script.</p>
<div class="sourceCode" id="cb67"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb67-1"><a href="#cb67-1" tabindex="-1"></a><span class="co">// There is an alternate way to detect change</span></span>
<span id="cb67-2"><a href="#cb67-2" tabindex="-1"></a><span class="co">// Since the S1_GRD collection has log-scaled DB values, subtract is more appropriate</span></span>
<span id="cb67-3"><a href="#cb67-3" tabindex="-1"></a><span class="co">// If you use subtract(), the threshold value also changes.</span></span>
<span id="cb67-4"><a href="#cb67-4" tabindex="-1"></a></span>
<span id="cb67-5"><a href="#cb67-5" tabindex="-1"></a><span class="co">// Calculate afterFiltered - beforeFiltered</span></span>
<span id="cb67-6"><a href="#cb67-6" tabindex="-1"></a><span class="co">// Create a flood imagge using a threshold of -3</span></span>
<span id="cb67-7"><a href="#cb67-7" tabindex="-1"></a><span class="co">// Display the results with a &#39;purple&#39; palette</span></span></code></pre></div>
</div>
</div>
<div id="apply-masks" class="section level2">
<h2>05. Apply Masks</h2>
<p>The Initial flooded map shows all the areas where the possibility of
water is logged. But this contains both noise and permanent water. We
can mask out the other pixels based on our need to get the exact flooded
area. In this exercise, we will mask</p>
<ol style="list-style-type: decimal">
<li><p>Permanent water.</p></li>
<li><p>High degree slope area.</p></li>
<li><p>Isolated pixels.</p></li>
</ol>
<p>The <em>permanent water</em> is detected using the GSW water dataset.
The pixel with a <a href="#exercise-10">seasonality band</a> greater
than 5 is considered permanent water for this computation. Based on the
ground information, this value can be changed. Using the
<code>updateMask</code> function, we can mask out all the permanent
water pixels.</p>
<p>The <em>slope</em> mask is created using the hydroSheds DEM dataset.
The terrain slope can be calculated from the DEM using
<code>ee.Algorithms.Terrain</code>. The areas with a slope greater than
5 degrees are selected and masked out. Mostly the water detected in this
area is due to noise in the imagery.</p>
<p>The <em>isolated</em> pixel mask is done to reduce the noise. A
single pixel detected as flood in the middle of nowhere must probably be
a noise. Hence, all the pixels with less than 8 connected neighbors can
be considered noise and masked out. To identify the connected pixels, we
can use the <code>connectedPixelCount</code> function to check the
connectedness for a pixel in all possible directions. This function will
return an image where each pixel has the number of connected pixel
counts of the image passed to it. Then, using the boolean function
<code>gt()</code>, select all the connected pixel count greater than
8.</p>
<p>After applying all the filters to the initial flooded area image, the
remaining pixels can be considered an original flooded region.</p>
<blockquote>
<p>Although the computation for the mask is done between images with
different resolutions, GEE will convert all the images to the images
added in map canvas or resolution mentioned during export. In our case,
all the images will be resampled and projected to Sentinel 1 GRD
projection.</p>
</blockquote>
<a
href="https://code.earthengine.google.com/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3A05-Flood_Mapping%2F05b_Apply_Masks_(complete)"
target="_blank">Open in Code Editor ↗</a>
<div class="figure" style="text-align: center">
<img src="images/gee_water_resources_management/flood_allMask.png" alt="Flood mask" width="100%" />
<p class="caption">
Flood mask
</p>
</div>
<div class="figure" style="text-align: center">
<img src="images/gee_water_resources_management/flood_mask.png" alt="Flooded region" width="100%" />
<p class="caption">
Flooded region
</p>
</div>
<div class="sourceCode" id="cb68"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb68-1"><a href="#cb68-1" tabindex="-1"></a><span class="kw">var</span> admin2 <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">&#39;FAO/GAUL_SIMPLIFIED_500m/2015/level2&#39;</span>)</span>
<span id="cb68-2"><a href="#cb68-2" tabindex="-1"></a><span class="kw">var</span> hydrosheds <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(<span class="st">&#39;WWF/HydroSHEDS/03VFDEM&#39;</span>)</span>
<span id="cb68-3"><a href="#cb68-3" tabindex="-1"></a><span class="kw">var</span> gsw <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(<span class="st">&#39;JRC/GSW1_4/GlobalSurfaceWater&#39;</span>)</span>
<span id="cb68-4"><a href="#cb68-4" tabindex="-1"></a>    </span>
<span id="cb68-5"><a href="#cb68-5" tabindex="-1"></a><span class="kw">var</span> beforeStart <span class="op">=</span> <span class="st">&#39;2018-07-15&#39;</span></span>
<span id="cb68-6"><a href="#cb68-6" tabindex="-1"></a><span class="kw">var</span> beforeEnd <span class="op">=</span> <span class="st">&#39;2018-08-10&#39;</span></span>
<span id="cb68-7"><a href="#cb68-7" tabindex="-1"></a><span class="kw">var</span> afterStart <span class="op">=</span> <span class="st">&#39;2018-08-10&#39;</span></span>
<span id="cb68-8"><a href="#cb68-8" tabindex="-1"></a><span class="kw">var</span> afterEnd <span class="op">=</span> <span class="st">&#39;2018-08-23&#39;</span></span>
<span id="cb68-9"><a href="#cb68-9" tabindex="-1"></a></span>
<span id="cb68-10"><a href="#cb68-10" tabindex="-1"></a><span class="kw">var</span> ernakulam <span class="op">=</span> admin2<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;ADM2_NAME&#39;</span><span class="op">,</span> <span class="st">&#39;Ernakulam&#39;</span>))</span>
<span id="cb68-11"><a href="#cb68-11" tabindex="-1"></a><span class="kw">var</span> geometry <span class="op">=</span> ernakulam<span class="op">.</span><span class="fu">geometry</span>()</span>
<span id="cb68-12"><a href="#cb68-12" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(geometry<span class="op">,</span> {<span class="dt">color</span><span class="op">:</span> <span class="st">&#39;grey&#39;</span>}<span class="op">,</span> <span class="st">&#39;Ernakulam District&#39;</span>)</span>
<span id="cb68-13"><a href="#cb68-13" tabindex="-1"></a></span>
<span id="cb68-14"><a href="#cb68-14" tabindex="-1"></a><span class="kw">var</span> collection<span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&#39;COPERNICUS/S1_GRD&#39;</span>)</span>
<span id="cb68-15"><a href="#cb68-15" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;instrumentMode&#39;</span><span class="op">,</span><span class="st">&#39;IW&#39;</span>))</span>
<span id="cb68-16"><a href="#cb68-16" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">listContains</span>(<span class="st">&#39;transmitterReceiverPolarisation&#39;</span><span class="op">,</span> <span class="st">&#39;VH&#39;</span>))</span>
<span id="cb68-17"><a href="#cb68-17" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;orbitProperties_pass&#39;</span><span class="op">,</span> <span class="st">&#39;DESCENDING&#39;</span>)) </span>
<span id="cb68-18"><a href="#cb68-18" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;resolution_meters&#39;</span><span class="op">,</span><span class="dv">10</span>))</span>
<span id="cb68-19"><a href="#cb68-19" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">bounds</span>(geometry))</span>
<span id="cb68-20"><a href="#cb68-20" tabindex="-1"></a>  <span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;VH&#39;</span>)<span class="op">;</span></span>
<span id="cb68-21"><a href="#cb68-21" tabindex="-1"></a></span>
<span id="cb68-22"><a href="#cb68-22" tabindex="-1"></a><span class="kw">var</span> beforeCollection <span class="op">=</span> collection</span>
<span id="cb68-23"><a href="#cb68-23" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(beforeStart<span class="op">,</span> beforeEnd))</span>
<span id="cb68-24"><a href="#cb68-24" tabindex="-1"></a></span>
<span id="cb68-25"><a href="#cb68-25" tabindex="-1"></a><span class="kw">var</span> afterCollection <span class="op">=</span> collection</span>
<span id="cb68-26"><a href="#cb68-26" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(afterStart<span class="op">,</span> afterEnd))</span>
<span id="cb68-27"><a href="#cb68-27" tabindex="-1"></a></span>
<span id="cb68-28"><a href="#cb68-28" tabindex="-1"></a><span class="kw">var</span> before <span class="op">=</span> beforeCollection<span class="op">.</span><span class="fu">mosaic</span>()<span class="op">.</span><span class="fu">clip</span>(geometry)<span class="op">;</span></span>
<span id="cb68-29"><a href="#cb68-29" tabindex="-1"></a><span class="kw">var</span> after <span class="op">=</span> afterCollection<span class="op">.</span><span class="fu">mosaic</span>()<span class="op">.</span><span class="fu">clip</span>(geometry)<span class="op">;</span></span>
<span id="cb68-30"><a href="#cb68-30" tabindex="-1"></a></span>
<span id="cb68-31"><a href="#cb68-31" tabindex="-1"></a><span class="kw">var</span> beforeFiltered <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(<span class="fu">toDB</span>(<span class="fu">RefinedLee</span>(<span class="fu">toNatural</span>(before))))</span>
<span id="cb68-32"><a href="#cb68-32" tabindex="-1"></a><span class="kw">var</span> afterFiltered <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(<span class="fu">toDB</span>(<span class="fu">RefinedLee</span>(<span class="fu">toNatural</span>(after))))</span>
<span id="cb68-33"><a href="#cb68-33" tabindex="-1"></a></span>
<span id="cb68-34"><a href="#cb68-34" tabindex="-1"></a><span class="kw">var</span> difference <span class="op">=</span> afterFiltered<span class="op">.</span><span class="fu">divide</span>(beforeFiltered)<span class="op">;</span></span>
<span id="cb68-35"><a href="#cb68-35" tabindex="-1"></a></span>
<span id="cb68-36"><a href="#cb68-36" tabindex="-1"></a><span class="co">// Define a threshold</span></span>
<span id="cb68-37"><a href="#cb68-37" tabindex="-1"></a><span class="kw">var</span> diffThreshold <span class="op">=</span> <span class="fl">1.25</span><span class="op">;</span></span>
<span id="cb68-38"><a href="#cb68-38" tabindex="-1"></a><span class="co">// Initial estimate of flooded pixels</span></span>
<span id="cb68-39"><a href="#cb68-39" tabindex="-1"></a><span class="kw">var</span> flooded <span class="op">=</span> difference<span class="op">.</span><span class="fu">gt</span>(diffThreshold)<span class="op">.</span><span class="fu">rename</span>(<span class="st">&#39;water&#39;</span>)<span class="op">.</span><span class="fu">selfMask</span>()<span class="op">;</span></span>
<span id="cb68-40"><a href="#cb68-40" tabindex="-1"></a></span>
<span id="cb68-41"><a href="#cb68-41" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">centerObject</span>(geometry<span class="op">,</span> <span class="dv">10</span>)</span>
<span id="cb68-42"><a href="#cb68-42" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(before<span class="op">,</span> {<span class="dt">min</span><span class="op">:-</span><span class="dv">25</span><span class="op">,</span><span class="dt">max</span><span class="op">:</span><span class="dv">0</span>}<span class="op">,</span> <span class="st">&#39;Before Floods&#39;</span><span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span></span>
<span id="cb68-43"><a href="#cb68-43" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(after<span class="op">,</span> {<span class="dt">min</span><span class="op">:-</span><span class="dv">25</span><span class="op">,</span><span class="dt">max</span><span class="op">:</span><span class="dv">0</span>}<span class="op">,</span> <span class="st">&#39;After Floods&#39;</span><span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span> </span>
<span id="cb68-44"><a href="#cb68-44" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(beforeFiltered<span class="op">,</span> {<span class="dt">min</span><span class="op">:-</span><span class="dv">25</span><span class="op">,</span><span class="dt">max</span><span class="op">:</span><span class="dv">0</span>}<span class="op">,</span> <span class="st">&#39;Before Filtered&#39;</span><span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span></span>
<span id="cb68-45"><a href="#cb68-45" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(afterFiltered<span class="op">,</span> {<span class="dt">min</span><span class="op">:-</span><span class="dv">25</span><span class="op">,</span><span class="dt">max</span><span class="op">:</span><span class="dv">0</span>}<span class="op">,</span> <span class="st">&#39;After Filtered&#39;</span><span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span> </span>
<span id="cb68-46"><a href="#cb68-46" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(flooded<span class="op">,</span> {<span class="dt">min</span><span class="op">:</span><span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span><span class="dv">1</span><span class="op">,</span> <span class="dt">palette</span><span class="op">:</span> [<span class="st">&#39;orange&#39;</span>]}<span class="op">,</span> <span class="st">&#39;Initial Flood Area&#39;</span><span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span></span>
<span id="cb68-47"><a href="#cb68-47" tabindex="-1"></a></span>
<span id="cb68-48"><a href="#cb68-48" tabindex="-1"></a></span>
<span id="cb68-49"><a href="#cb68-49" tabindex="-1"></a><span class="co">// Mask out area with permanent/semi-permanent water</span></span>
<span id="cb68-50"><a href="#cb68-50" tabindex="-1"></a><span class="kw">var</span> permanentWater <span class="op">=</span> gsw<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;seasonality&#39;</span>)<span class="op">.</span><span class="fu">gte</span>(<span class="dv">5</span>)<span class="op">.</span><span class="fu">clip</span>(geometry)</span>
<span id="cb68-51"><a href="#cb68-51" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(permanentWater<span class="op">.</span><span class="fu">selfMask</span>()<span class="op">,</span> {<span class="dt">min</span><span class="op">:</span><span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span><span class="dv">1</span><span class="op">,</span> <span class="dt">palette</span><span class="op">:</span> [<span class="st">&#39;blue&#39;</span>]}<span class="op">,</span> <span class="st">&#39;Permanent Water&#39;</span><span class="op">,</span> <span class="kw">false</span>)</span>
<span id="cb68-52"><a href="#cb68-52" tabindex="-1"></a></span>
<span id="cb68-53"><a href="#cb68-53" tabindex="-1"></a><span class="co">// GSW data is masked in non-water areas. Set it to 0 using unmask()</span></span>
<span id="cb68-54"><a href="#cb68-54" tabindex="-1"></a><span class="co">// Invert the image to set all non-permanent regions to 1</span></span>
<span id="cb68-55"><a href="#cb68-55" tabindex="-1"></a><span class="kw">var</span> permanentWaterMask <span class="op">=</span> permanentWater<span class="op">.</span><span class="fu">unmask</span>(<span class="dv">0</span>)<span class="op">.</span><span class="fu">not</span>()</span>
<span id="cb68-56"><a href="#cb68-56" tabindex="-1"></a></span>
<span id="cb68-57"><a href="#cb68-57" tabindex="-1"></a><span class="kw">var</span> flooded <span class="op">=</span> flooded<span class="op">.</span><span class="fu">updateMask</span>(permanentWaterMask)</span>
<span id="cb68-58"><a href="#cb68-58" tabindex="-1"></a><span class="co">// Mask out areas with more than 5 percent slope using the HydroSHEDS DEM</span></span>
<span id="cb68-59"><a href="#cb68-59" tabindex="-1"></a><span class="kw">var</span> slopeThreshold <span class="op">=</span> <span class="dv">5</span><span class="op">;</span></span>
<span id="cb68-60"><a href="#cb68-60" tabindex="-1"></a><span class="kw">var</span> terrain <span class="op">=</span> ee<span class="op">.</span><span class="at">Algorithms</span><span class="op">.</span><span class="fu">Terrain</span>(hydrosheds)<span class="op">;</span></span>
<span id="cb68-61"><a href="#cb68-61" tabindex="-1"></a><span class="kw">var</span> slope <span class="op">=</span> terrain<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;slope&#39;</span>)<span class="op">;</span></span>
<span id="cb68-62"><a href="#cb68-62" tabindex="-1"></a><span class="kw">var</span> steepAreas <span class="op">=</span> slope<span class="op">.</span><span class="fu">gt</span>(slopeThreshold)</span>
<span id="cb68-63"><a href="#cb68-63" tabindex="-1"></a><span class="kw">var</span> slopeMask <span class="op">=</span> steepAreas<span class="op">.</span><span class="fu">not</span>()</span>
<span id="cb68-64"><a href="#cb68-64" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(steepAreas<span class="op">.</span><span class="fu">selfMask</span>()<span class="op">,</span> {<span class="dt">min</span><span class="op">:</span><span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span><span class="dv">1</span><span class="op">,</span> <span class="dt">palette</span><span class="op">:</span> [<span class="st">&#39;cyan&#39;</span>]}<span class="op">,</span> <span class="st">&#39;Steep Areas&#39;</span><span class="op">,</span> <span class="kw">false</span>)</span>
<span id="cb68-65"><a href="#cb68-65" tabindex="-1"></a></span>
<span id="cb68-66"><a href="#cb68-66" tabindex="-1"></a><span class="kw">var</span> flooded <span class="op">=</span> flooded<span class="op">.</span><span class="fu">updateMask</span>(slopeMask)</span>
<span id="cb68-67"><a href="#cb68-67" tabindex="-1"></a></span>
<span id="cb68-68"><a href="#cb68-68" tabindex="-1"></a><span class="co">// Remove isolated pixels</span></span>
<span id="cb68-69"><a href="#cb68-69" tabindex="-1"></a><span class="co">// connectedPixelCount is Zoom dependent, so visual result will vary</span></span>
<span id="cb68-70"><a href="#cb68-70" tabindex="-1"></a><span class="kw">var</span> connectedPixelThreshold <span class="op">=</span> <span class="dv">8</span><span class="op">;</span></span>
<span id="cb68-71"><a href="#cb68-71" tabindex="-1"></a><span class="kw">var</span> connections <span class="op">=</span> flooded<span class="op">.</span><span class="fu">connectedPixelCount</span>(<span class="dv">25</span>)</span>
<span id="cb68-72"><a href="#cb68-72" tabindex="-1"></a><span class="kw">var</span> disconnectedAreas <span class="op">=</span> connections<span class="op">.</span><span class="fu">lt</span>(connectedPixelThreshold)</span>
<span id="cb68-73"><a href="#cb68-73" tabindex="-1"></a><span class="kw">var</span> disconnectedAreasMask <span class="op">=</span> disconnectedAreas<span class="op">.</span><span class="fu">not</span>()</span>
<span id="cb68-74"><a href="#cb68-74" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(disconnectedAreas<span class="op">.</span><span class="fu">selfMask</span>()<span class="op">,</span> {<span class="dt">min</span><span class="op">:</span><span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span><span class="dv">1</span><span class="op">,</span> <span class="dt">palette</span><span class="op">:</span> [<span class="st">&#39;yellow&#39;</span>]}<span class="op">,</span> <span class="st">&#39;Disconnected Areas&#39;</span><span class="op">,</span> <span class="kw">false</span>)</span>
<span id="cb68-75"><a href="#cb68-75" tabindex="-1"></a></span>
<span id="cb68-76"><a href="#cb68-76" tabindex="-1"></a><span class="kw">var</span> flooded <span class="op">=</span> flooded<span class="op">.</span><span class="fu">updateMask</span>(disconnectedAreasMask)</span>
<span id="cb68-77"><a href="#cb68-77" tabindex="-1"></a></span>
<span id="cb68-78"><a href="#cb68-78" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(flooded<span class="op">,</span> {<span class="dt">min</span><span class="op">:</span><span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span><span class="dv">1</span><span class="op">,</span> <span class="dt">palette</span><span class="op">:</span> [<span class="st">&#39;red&#39;</span>]}<span class="op">,</span> <span class="st">&#39;Flooded Areas&#39;</span>)<span class="op">;</span></span>
<span id="cb68-79"><a href="#cb68-79" tabindex="-1"></a></span>
<span id="cb68-80"><a href="#cb68-80" tabindex="-1"></a></span>
<span id="cb68-81"><a href="#cb68-81" tabindex="-1"></a><span class="co">//############################</span></span>
<span id="cb68-82"><a href="#cb68-82" tabindex="-1"></a><span class="co">// Speckle Filtering Functions</span></span>
<span id="cb68-83"><a href="#cb68-83" tabindex="-1"></a><span class="co">//############################</span></span>
<span id="cb68-84"><a href="#cb68-84" tabindex="-1"></a></span>
<span id="cb68-85"><a href="#cb68-85" tabindex="-1"></a><span class="co">// Function to convert from dB</span></span>
<span id="cb68-86"><a href="#cb68-86" tabindex="-1"></a><span class="kw">function</span> <span class="fu">toNatural</span>(img) {</span>
<span id="cb68-87"><a href="#cb68-87" tabindex="-1"></a>  <span class="cf">return</span> ee<span class="op">.</span><span class="fu">Image</span>(<span class="fl">10.0</span>)<span class="op">.</span><span class="fu">pow</span>(img<span class="op">.</span><span class="fu">select</span>(<span class="dv">0</span>)<span class="op">.</span><span class="fu">divide</span>(<span class="fl">10.0</span>))<span class="op">;</span></span>
<span id="cb68-88"><a href="#cb68-88" tabindex="-1"></a>}</span>
<span id="cb68-89"><a href="#cb68-89" tabindex="-1"></a></span>
<span id="cb68-90"><a href="#cb68-90" tabindex="-1"></a><span class="co">//Function to convert to dB</span></span>
<span id="cb68-91"><a href="#cb68-91" tabindex="-1"></a><span class="kw">function</span> <span class="fu">toDB</span>(img) {</span>
<span id="cb68-92"><a href="#cb68-92" tabindex="-1"></a>  <span class="cf">return</span> ee<span class="op">.</span><span class="fu">Image</span>(img)<span class="op">.</span><span class="fu">log10</span>()<span class="op">.</span><span class="fu">multiply</span>(<span class="fl">10.0</span>)<span class="op">;</span></span>
<span id="cb68-93"><a href="#cb68-93" tabindex="-1"></a>}</span>
<span id="cb68-94"><a href="#cb68-94" tabindex="-1"></a></span>
<span id="cb68-95"><a href="#cb68-95" tabindex="-1"></a><span class="co">//Apllying a Refined Lee Speckle filter as coded in the SNAP 3.0 S1TBX:</span></span>
<span id="cb68-96"><a href="#cb68-96" tabindex="-1"></a></span>
<span id="cb68-97"><a href="#cb68-97" tabindex="-1"></a><span class="co">//https://github.com/senbox-org/s1tbx/blob/master/s1tbx-op-sar-processing/src/main/java/org/esa/s1tbx/sar/gpf/filtering/SpeckleFilters/RefinedLee.java</span></span>
<span id="cb68-98"><a href="#cb68-98" tabindex="-1"></a><span class="co">//Adapted by Guido Lemoine</span></span>
<span id="cb68-99"><a href="#cb68-99" tabindex="-1"></a></span>
<span id="cb68-100"><a href="#cb68-100" tabindex="-1"></a><span class="co">// by Guido Lemoine</span></span>
<span id="cb68-101"><a href="#cb68-101" tabindex="-1"></a><span class="kw">function</span> <span class="fu">RefinedLee</span>(img) {</span>
<span id="cb68-102"><a href="#cb68-102" tabindex="-1"></a>  <span class="co">// img must be in natural units, i.e. not in dB!</span></span>
<span id="cb68-103"><a href="#cb68-103" tabindex="-1"></a>  <span class="co">// Set up 3x3 kernels </span></span>
<span id="cb68-104"><a href="#cb68-104" tabindex="-1"></a>  <span class="kw">var</span> weights3 <span class="op">=</span> ee<span class="op">.</span><span class="at">List</span><span class="op">.</span><span class="fu">repeat</span>(ee<span class="op">.</span><span class="at">List</span><span class="op">.</span><span class="fu">repeat</span>(<span class="dv">1</span><span class="op">,</span><span class="dv">3</span>)<span class="op">,</span><span class="dv">3</span>)<span class="op">;</span></span>
<span id="cb68-105"><a href="#cb68-105" tabindex="-1"></a>  <span class="kw">var</span> kernel3 <span class="op">=</span> ee<span class="op">.</span><span class="at">Kernel</span><span class="op">.</span><span class="fu">fixed</span>(<span class="dv">3</span><span class="op">,</span><span class="dv">3</span><span class="op">,</span> weights3<span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span></span>
<span id="cb68-106"><a href="#cb68-106" tabindex="-1"></a></span>
<span id="cb68-107"><a href="#cb68-107" tabindex="-1"></a>  <span class="kw">var</span> mean3 <span class="op">=</span> img<span class="op">.</span><span class="fu">reduceNeighborhood</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">mean</span>()<span class="op">,</span> kernel3)<span class="op">;</span></span>
<span id="cb68-108"><a href="#cb68-108" tabindex="-1"></a>  <span class="kw">var</span> variance3 <span class="op">=</span> img<span class="op">.</span><span class="fu">reduceNeighborhood</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">variance</span>()<span class="op">,</span> kernel3)<span class="op">;</span></span>
<span id="cb68-109"><a href="#cb68-109" tabindex="-1"></a></span>
<span id="cb68-110"><a href="#cb68-110" tabindex="-1"></a>  <span class="co">// Use a sample of the 3x3 windows inside a 7x7 windows to determine gradients and directions</span></span>
<span id="cb68-111"><a href="#cb68-111" tabindex="-1"></a>  <span class="kw">var</span> sample_weights <span class="op">=</span> ee<span class="op">.</span><span class="fu">List</span>([[<span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span>]<span class="op">,</span> [<span class="dv">0</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span>]<span class="op">,</span>[<span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span>]<span class="op">,</span> [<span class="dv">0</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span>]<span class="op">,</span> [<span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span>]<span class="op">,</span> [<span class="dv">0</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span>]<span class="op">,</span>[<span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span>]])<span class="op">;</span></span>
<span id="cb68-112"><a href="#cb68-112" tabindex="-1"></a></span>
<span id="cb68-113"><a href="#cb68-113" tabindex="-1"></a>  <span class="kw">var</span> sample_kernel <span class="op">=</span> ee<span class="op">.</span><span class="at">Kernel</span><span class="op">.</span><span class="fu">fixed</span>(<span class="dv">7</span><span class="op">,</span><span class="dv">7</span><span class="op">,</span> sample_weights<span class="op">,</span> <span class="dv">3</span><span class="op">,</span><span class="dv">3</span><span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span></span>
<span id="cb68-114"><a href="#cb68-114" tabindex="-1"></a></span>
<span id="cb68-115"><a href="#cb68-115" tabindex="-1"></a>  <span class="co">// Calculate mean and variance for the sampled windows and store as 9 bands</span></span>
<span id="cb68-116"><a href="#cb68-116" tabindex="-1"></a>  <span class="kw">var</span> sample_mean <span class="op">=</span> mean3<span class="op">.</span><span class="fu">neighborhoodToBands</span>(sample_kernel)<span class="op">;</span> </span>
<span id="cb68-117"><a href="#cb68-117" tabindex="-1"></a>  <span class="kw">var</span> sample_var <span class="op">=</span> variance3<span class="op">.</span><span class="fu">neighborhoodToBands</span>(sample_kernel)<span class="op">;</span></span>
<span id="cb68-118"><a href="#cb68-118" tabindex="-1"></a></span>
<span id="cb68-119"><a href="#cb68-119" tabindex="-1"></a>  <span class="co">// Determine the 4 gradients for the sampled windows</span></span>
<span id="cb68-120"><a href="#cb68-120" tabindex="-1"></a>  <span class="kw">var</span> gradients <span class="op">=</span> sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">1</span>)<span class="op">.</span><span class="fu">subtract</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">7</span>))<span class="op">.</span><span class="fu">abs</span>()<span class="op">;</span></span>
<span id="cb68-121"><a href="#cb68-121" tabindex="-1"></a>  gradients <span class="op">=</span> gradients<span class="op">.</span><span class="fu">addBands</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">6</span>)<span class="op">.</span><span class="fu">subtract</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">2</span>))<span class="op">.</span><span class="fu">abs</span>())<span class="op">;</span></span>
<span id="cb68-122"><a href="#cb68-122" tabindex="-1"></a>  gradients <span class="op">=</span> gradients<span class="op">.</span><span class="fu">addBands</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">3</span>)<span class="op">.</span><span class="fu">subtract</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">5</span>))<span class="op">.</span><span class="fu">abs</span>())<span class="op">;</span></span>
<span id="cb68-123"><a href="#cb68-123" tabindex="-1"></a>  gradients <span class="op">=</span> gradients<span class="op">.</span><span class="fu">addBands</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">0</span>)<span class="op">.</span><span class="fu">subtract</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">8</span>))<span class="op">.</span><span class="fu">abs</span>())<span class="op">;</span></span>
<span id="cb68-124"><a href="#cb68-124" tabindex="-1"></a></span>
<span id="cb68-125"><a href="#cb68-125" tabindex="-1"></a>  <span class="co">// And find the maximum gradient amongst gradient bands</span></span>
<span id="cb68-126"><a href="#cb68-126" tabindex="-1"></a>  <span class="kw">var</span> max_gradient <span class="op">=</span> gradients<span class="op">.</span><span class="fu">reduce</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">max</span>())<span class="op">;</span></span>
<span id="cb68-127"><a href="#cb68-127" tabindex="-1"></a></span>
<span id="cb68-128"><a href="#cb68-128" tabindex="-1"></a>  <span class="co">// Create a mask for band pixels that are the maximum gradient</span></span>
<span id="cb68-129"><a href="#cb68-129" tabindex="-1"></a>  <span class="kw">var</span> gradmask <span class="op">=</span> gradients<span class="op">.</span><span class="fu">eq</span>(max_gradient)<span class="op">;</span></span>
<span id="cb68-130"><a href="#cb68-130" tabindex="-1"></a></span>
<span id="cb68-131"><a href="#cb68-131" tabindex="-1"></a>  <span class="co">// duplicate gradmask bands: each gradient represents 2 directions</span></span>
<span id="cb68-132"><a href="#cb68-132" tabindex="-1"></a>  gradmask <span class="op">=</span> gradmask<span class="op">.</span><span class="fu">addBands</span>(gradmask)<span class="op">;</span></span>
<span id="cb68-133"><a href="#cb68-133" tabindex="-1"></a></span>
<span id="cb68-134"><a href="#cb68-134" tabindex="-1"></a>  <span class="co">// Determine the 8 directions</span></span>
<span id="cb68-135"><a href="#cb68-135" tabindex="-1"></a>  <span class="kw">var</span> directions <span class="op">=</span> sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">1</span>)<span class="op">.</span><span class="fu">subtract</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">4</span>))<span class="op">.</span><span class="fu">gt</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">4</span>)<span class="op">.</span><span class="fu">subtract</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">7</span>)))<span class="op">.</span><span class="fu">multiply</span>(<span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb68-136"><a href="#cb68-136" tabindex="-1"></a>  directions <span class="op">=</span> directions<span class="op">.</span><span class="fu">addBands</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">6</span>)<span class="op">.</span><span class="fu">subtract</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">4</span>))<span class="op">.</span><span class="fu">gt</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">4</span>)<span class="op">.</span><span class="fu">subtract</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">2</span>)))<span class="op">.</span><span class="fu">multiply</span>(<span class="dv">2</span>))<span class="op">;</span></span>
<span id="cb68-137"><a href="#cb68-137" tabindex="-1"></a>  directions <span class="op">=</span> directions<span class="op">.</span><span class="fu">addBands</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">3</span>)<span class="op">.</span><span class="fu">subtract</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">4</span>))<span class="op">.</span><span class="fu">gt</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">4</span>)<span class="op">.</span><span class="fu">subtract</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">5</span>)))<span class="op">.</span><span class="fu">multiply</span>(<span class="dv">3</span>))<span class="op">;</span></span>
<span id="cb68-138"><a href="#cb68-138" tabindex="-1"></a>  directions <span class="op">=</span> directions<span class="op">.</span><span class="fu">addBands</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">0</span>)<span class="op">.</span><span class="fu">subtract</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">4</span>))<span class="op">.</span><span class="fu">gt</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">4</span>)<span class="op">.</span><span class="fu">subtract</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">8</span>)))<span class="op">.</span><span class="fu">multiply</span>(<span class="dv">4</span>))<span class="op">;</span></span>
<span id="cb68-139"><a href="#cb68-139" tabindex="-1"></a>  <span class="co">// The next 4 are the not() of the previous 4</span></span>
<span id="cb68-140"><a href="#cb68-140" tabindex="-1"></a>  directions <span class="op">=</span> directions<span class="op">.</span><span class="fu">addBands</span>(directions<span class="op">.</span><span class="fu">select</span>(<span class="dv">0</span>)<span class="op">.</span><span class="fu">not</span>()<span class="op">.</span><span class="fu">multiply</span>(<span class="dv">5</span>))<span class="op">;</span></span>
<span id="cb68-141"><a href="#cb68-141" tabindex="-1"></a>  directions <span class="op">=</span> directions<span class="op">.</span><span class="fu">addBands</span>(directions<span class="op">.</span><span class="fu">select</span>(<span class="dv">1</span>)<span class="op">.</span><span class="fu">not</span>()<span class="op">.</span><span class="fu">multiply</span>(<span class="dv">6</span>))<span class="op">;</span></span>
<span id="cb68-142"><a href="#cb68-142" tabindex="-1"></a>  directions <span class="op">=</span> directions<span class="op">.</span><span class="fu">addBands</span>(directions<span class="op">.</span><span class="fu">select</span>(<span class="dv">2</span>)<span class="op">.</span><span class="fu">not</span>()<span class="op">.</span><span class="fu">multiply</span>(<span class="dv">7</span>))<span class="op">;</span></span>
<span id="cb68-143"><a href="#cb68-143" tabindex="-1"></a>  directions <span class="op">=</span> directions<span class="op">.</span><span class="fu">addBands</span>(directions<span class="op">.</span><span class="fu">select</span>(<span class="dv">3</span>)<span class="op">.</span><span class="fu">not</span>()<span class="op">.</span><span class="fu">multiply</span>(<span class="dv">8</span>))<span class="op">;</span></span>
<span id="cb68-144"><a href="#cb68-144" tabindex="-1"></a></span>
<span id="cb68-145"><a href="#cb68-145" tabindex="-1"></a>  <span class="co">// Mask all values that are not 1-8</span></span>
<span id="cb68-146"><a href="#cb68-146" tabindex="-1"></a>  directions <span class="op">=</span> directions<span class="op">.</span><span class="fu">updateMask</span>(gradmask)<span class="op">;</span></span>
<span id="cb68-147"><a href="#cb68-147" tabindex="-1"></a></span>
<span id="cb68-148"><a href="#cb68-148" tabindex="-1"></a>  <span class="co">// &quot;collapse&quot; the stack into a singe band image (due to masking, each pixel has just one value (1-8) in it&#39;s directional band, and is otherwise masked)</span></span>
<span id="cb68-149"><a href="#cb68-149" tabindex="-1"></a>  directions <span class="op">=</span> directions<span class="op">.</span><span class="fu">reduce</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">sum</span>())<span class="op">;</span>  </span>
<span id="cb68-150"><a href="#cb68-150" tabindex="-1"></a></span>
<span id="cb68-151"><a href="#cb68-151" tabindex="-1"></a>  <span class="co">//var pal = [&#39;ffffff&#39;,&#39;ff0000&#39;,&#39;ffff00&#39;, &#39;00ff00&#39;, &#39;00ffff&#39;, &#39;0000ff&#39;, &#39;ff00ff&#39;, &#39;000000&#39;];</span></span>
<span id="cb68-152"><a href="#cb68-152" tabindex="-1"></a>  <span class="co">//Map.addLayer(directions.reduce(ee.Reducer.sum()), {min:1, max:8, palette: pal}, &#39;Directions&#39;, false);</span></span>
<span id="cb68-153"><a href="#cb68-153" tabindex="-1"></a></span>
<span id="cb68-154"><a href="#cb68-154" tabindex="-1"></a>  <span class="kw">var</span> sample_stats <span class="op">=</span> sample_var<span class="op">.</span><span class="fu">divide</span>(sample_mean<span class="op">.</span><span class="fu">multiply</span>(sample_mean))<span class="op">;</span></span>
<span id="cb68-155"><a href="#cb68-155" tabindex="-1"></a></span>
<span id="cb68-156"><a href="#cb68-156" tabindex="-1"></a>  <span class="co">// Calculate localNoiseVariance</span></span>
<span id="cb68-157"><a href="#cb68-157" tabindex="-1"></a>  <span class="kw">var</span> sigmaV <span class="op">=</span> sample_stats<span class="op">.</span><span class="fu">toArray</span>()<span class="op">.</span><span class="fu">arraySort</span>()<span class="op">.</span><span class="fu">arraySlice</span>(<span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">5</span>)<span class="op">.</span><span class="fu">arrayReduce</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">mean</span>()<span class="op">,</span> [<span class="dv">0</span>])<span class="op">;</span></span>
<span id="cb68-158"><a href="#cb68-158" tabindex="-1"></a></span>
<span id="cb68-159"><a href="#cb68-159" tabindex="-1"></a>  <span class="co">// Set up the 7*7 kernels for directional statistics</span></span>
<span id="cb68-160"><a href="#cb68-160" tabindex="-1"></a>  <span class="kw">var</span> rect_weights <span class="op">=</span> ee<span class="op">.</span><span class="at">List</span><span class="op">.</span><span class="fu">repeat</span>(ee<span class="op">.</span><span class="at">List</span><span class="op">.</span><span class="fu">repeat</span>(<span class="dv">0</span><span class="op">,</span><span class="dv">7</span>)<span class="op">,</span><span class="dv">3</span>)<span class="op">.</span><span class="fu">cat</span>(ee<span class="op">.</span><span class="at">List</span><span class="op">.</span><span class="fu">repeat</span>(ee<span class="op">.</span><span class="at">List</span><span class="op">.</span><span class="fu">repeat</span>(<span class="dv">1</span><span class="op">,</span><span class="dv">7</span>)<span class="op">,</span><span class="dv">4</span>))<span class="op">;</span></span>
<span id="cb68-161"><a href="#cb68-161" tabindex="-1"></a></span>
<span id="cb68-162"><a href="#cb68-162" tabindex="-1"></a>  <span class="kw">var</span> diag_weights <span class="op">=</span> ee<span class="op">.</span><span class="fu">List</span>([[<span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span>]<span class="op">,</span> [<span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span>]<span class="op">,</span> [<span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span>]<span class="op">,</span> </span>
<span id="cb68-163"><a href="#cb68-163" tabindex="-1"></a>    [<span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span>]<span class="op">,</span> [<span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span>]<span class="op">,</span> [<span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span>]<span class="op">,</span> [<span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span>]])<span class="op">;</span></span>
<span id="cb68-164"><a href="#cb68-164" tabindex="-1"></a></span>
<span id="cb68-165"><a href="#cb68-165" tabindex="-1"></a>  <span class="kw">var</span> rect_kernel <span class="op">=</span> ee<span class="op">.</span><span class="at">Kernel</span><span class="op">.</span><span class="fu">fixed</span>(<span class="dv">7</span><span class="op">,</span><span class="dv">7</span><span class="op">,</span> rect_weights<span class="op">,</span> <span class="dv">3</span><span class="op">,</span> <span class="dv">3</span><span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span></span>
<span id="cb68-166"><a href="#cb68-166" tabindex="-1"></a>  <span class="kw">var</span> diag_kernel <span class="op">=</span> ee<span class="op">.</span><span class="at">Kernel</span><span class="op">.</span><span class="fu">fixed</span>(<span class="dv">7</span><span class="op">,</span><span class="dv">7</span><span class="op">,</span> diag_weights<span class="op">,</span> <span class="dv">3</span><span class="op">,</span> <span class="dv">3</span><span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span></span>
<span id="cb68-167"><a href="#cb68-167" tabindex="-1"></a></span>
<span id="cb68-168"><a href="#cb68-168" tabindex="-1"></a>  <span class="co">// Create stacks for mean and variance using the original kernels. Mask with relevant direction.</span></span>
<span id="cb68-169"><a href="#cb68-169" tabindex="-1"></a>  <span class="kw">var</span> dir_mean <span class="op">=</span> img<span class="op">.</span><span class="fu">reduceNeighborhood</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">mean</span>()<span class="op">,</span> rect_kernel)<span class="op">.</span><span class="fu">updateMask</span>(directions<span class="op">.</span><span class="fu">eq</span>(<span class="dv">1</span>))<span class="op">;</span></span>
<span id="cb68-170"><a href="#cb68-170" tabindex="-1"></a>  <span class="kw">var</span> dir_var <span class="op">=</span> img<span class="op">.</span><span class="fu">reduceNeighborhood</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">variance</span>()<span class="op">,</span> rect_kernel)<span class="op">.</span><span class="fu">updateMask</span>(directions<span class="op">.</span><span class="fu">eq</span>(<span class="dv">1</span>))<span class="op">;</span></span>
<span id="cb68-171"><a href="#cb68-171" tabindex="-1"></a></span>
<span id="cb68-172"><a href="#cb68-172" tabindex="-1"></a>  dir_mean <span class="op">=</span> dir_mean<span class="op">.</span><span class="fu">addBands</span>(img<span class="op">.</span><span class="fu">reduceNeighborhood</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">mean</span>()<span class="op">,</span> diag_kernel)<span class="op">.</span><span class="fu">updateMask</span>(directions<span class="op">.</span><span class="fu">eq</span>(<span class="dv">2</span>)))<span class="op">;</span></span>
<span id="cb68-173"><a href="#cb68-173" tabindex="-1"></a>  dir_var <span class="op">=</span> dir_var<span class="op">.</span><span class="fu">addBands</span>(img<span class="op">.</span><span class="fu">reduceNeighborhood</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">variance</span>()<span class="op">,</span> diag_kernel)<span class="op">.</span><span class="fu">updateMask</span>(directions<span class="op">.</span><span class="fu">eq</span>(<span class="dv">2</span>)))<span class="op">;</span></span>
<span id="cb68-174"><a href="#cb68-174" tabindex="-1"></a></span>
<span id="cb68-175"><a href="#cb68-175" tabindex="-1"></a>  <span class="co">// and add the bands for rotated kernels</span></span>
<span id="cb68-176"><a href="#cb68-176" tabindex="-1"></a>  <span class="cf">for</span> (<span class="kw">var</span> i<span class="op">=</span><span class="dv">1</span><span class="op">;</span> i<span class="op">&lt;</span><span class="dv">4</span><span class="op">;</span> i<span class="op">++</span>) {</span>
<span id="cb68-177"><a href="#cb68-177" tabindex="-1"></a>    dir_mean <span class="op">=</span> dir_mean<span class="op">.</span><span class="fu">addBands</span>(img<span class="op">.</span><span class="fu">reduceNeighborhood</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">mean</span>()<span class="op">,</span> rect_kernel<span class="op">.</span><span class="fu">rotate</span>(i))<span class="op">.</span><span class="fu">updateMask</span>(directions<span class="op">.</span><span class="fu">eq</span>(<span class="dv">2</span><span class="op">*</span>i<span class="op">+</span><span class="dv">1</span>)))<span class="op">;</span></span>
<span id="cb68-178"><a href="#cb68-178" tabindex="-1"></a>    dir_var <span class="op">=</span> dir_var<span class="op">.</span><span class="fu">addBands</span>(img<span class="op">.</span><span class="fu">reduceNeighborhood</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">variance</span>()<span class="op">,</span> rect_kernel<span class="op">.</span><span class="fu">rotate</span>(i))<span class="op">.</span><span class="fu">updateMask</span>(directions<span class="op">.</span><span class="fu">eq</span>(<span class="dv">2</span><span class="op">*</span>i<span class="op">+</span><span class="dv">1</span>)))<span class="op">;</span></span>
<span id="cb68-179"><a href="#cb68-179" tabindex="-1"></a>    dir_mean <span class="op">=</span> dir_mean<span class="op">.</span><span class="fu">addBands</span>(img<span class="op">.</span><span class="fu">reduceNeighborhood</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">mean</span>()<span class="op">,</span> diag_kernel<span class="op">.</span><span class="fu">rotate</span>(i))<span class="op">.</span><span class="fu">updateMask</span>(directions<span class="op">.</span><span class="fu">eq</span>(<span class="dv">2</span><span class="op">*</span>i<span class="op">+</span><span class="dv">2</span>)))<span class="op">;</span></span>
<span id="cb68-180"><a href="#cb68-180" tabindex="-1"></a>    dir_var <span class="op">=</span> dir_var<span class="op">.</span><span class="fu">addBands</span>(img<span class="op">.</span><span class="fu">reduceNeighborhood</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">variance</span>()<span class="op">,</span> diag_kernel<span class="op">.</span><span class="fu">rotate</span>(i))<span class="op">.</span><span class="fu">updateMask</span>(directions<span class="op">.</span><span class="fu">eq</span>(<span class="dv">2</span><span class="op">*</span>i<span class="op">+</span><span class="dv">2</span>)))<span class="op">;</span></span>
<span id="cb68-181"><a href="#cb68-181" tabindex="-1"></a>  }</span>
<span id="cb68-182"><a href="#cb68-182" tabindex="-1"></a></span>
<span id="cb68-183"><a href="#cb68-183" tabindex="-1"></a>  <span class="co">// &quot;collapse&quot; the stack into a single band image (due to masking, each pixel has just one value in it&#39;s directional band, and is otherwise masked)</span></span>
<span id="cb68-184"><a href="#cb68-184" tabindex="-1"></a>  dir_mean <span class="op">=</span> dir_mean<span class="op">.</span><span class="fu">reduce</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">sum</span>())<span class="op">;</span></span>
<span id="cb68-185"><a href="#cb68-185" tabindex="-1"></a>  dir_var <span class="op">=</span> dir_var<span class="op">.</span><span class="fu">reduce</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">sum</span>())<span class="op">;</span></span>
<span id="cb68-186"><a href="#cb68-186" tabindex="-1"></a></span>
<span id="cb68-187"><a href="#cb68-187" tabindex="-1"></a>  <span class="co">// A finally generate the filtered value</span></span>
<span id="cb68-188"><a href="#cb68-188" tabindex="-1"></a>  <span class="kw">var</span> varX <span class="op">=</span> dir_var<span class="op">.</span><span class="fu">subtract</span>(dir_mean<span class="op">.</span><span class="fu">multiply</span>(dir_mean)<span class="op">.</span><span class="fu">multiply</span>(sigmaV))<span class="op">.</span><span class="fu">divide</span>(sigmaV<span class="op">.</span><span class="fu">add</span>(<span class="fl">1.0</span>))<span class="op">;</span></span>
<span id="cb68-189"><a href="#cb68-189" tabindex="-1"></a></span>
<span id="cb68-190"><a href="#cb68-190" tabindex="-1"></a>  <span class="kw">var</span> b <span class="op">=</span> varX<span class="op">.</span><span class="fu">divide</span>(dir_var)<span class="op">;</span></span>
<span id="cb68-191"><a href="#cb68-191" tabindex="-1"></a></span>
<span id="cb68-192"><a href="#cb68-192" tabindex="-1"></a>  <span class="kw">var</span> result <span class="op">=</span> dir_mean<span class="op">.</span><span class="fu">add</span>(b<span class="op">.</span><span class="fu">multiply</span>(img<span class="op">.</span><span class="fu">subtract</span>(dir_mean)))<span class="op">;</span></span>
<span id="cb68-193"><a href="#cb68-193" tabindex="-1"></a>  <span class="cf">return</span>(result<span class="op">.</span><span class="fu">arrayFlatten</span>([[<span class="st">&#39;sum&#39;</span>]]))<span class="op">;</span></span>
<span id="cb68-194"><a href="#cb68-194" tabindex="-1"></a>}</span></code></pre></div>
<div id="exercise-32" class="section level3">
<h3>Exercise</h3>
<p><a
href="https://code.earthengine.google.com/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3A05-Flood_Mapping%2F05c_Apply_Masks_(exercise)"
target="_blank">Try in Code Editor ↗</a></p>
<p>We just learned to mask permanent water using the GSW water dataset.
Now mask the cropland pixels extracted from the ESA worldview dataset
and add the layer to canvas.</p>
<div class="sourceCode" id="cb69"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb69-1"><a href="#cb69-1" tabindex="-1"></a><span class="kw">var</span> admin2 <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">&#39;FAO/GAUL_SIMPLIFIED_500m/2015/level2&#39;</span>)</span>
<span id="cb69-2"><a href="#cb69-2" tabindex="-1"></a><span class="kw">var</span> hydrosheds <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(<span class="st">&#39;WWF/HydroSHEDS/03VFDEM&#39;</span>)</span>
<span id="cb69-3"><a href="#cb69-3" tabindex="-1"></a><span class="kw">var</span> gsw <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(<span class="st">&#39;JRC/GSW1_3/GlobalSurfaceWater&#39;</span>)</span>
<span id="cb69-4"><a href="#cb69-4" tabindex="-1"></a></span>
<span id="cb69-5"><a href="#cb69-5" tabindex="-1"></a><span class="kw">var</span> beforeStart <span class="op">=</span> <span class="st">&#39;2018-07-15&#39;</span></span>
<span id="cb69-6"><a href="#cb69-6" tabindex="-1"></a><span class="kw">var</span> beforeEnd <span class="op">=</span> <span class="st">&#39;2018-08-10&#39;</span></span>
<span id="cb69-7"><a href="#cb69-7" tabindex="-1"></a><span class="kw">var</span> afterStart <span class="op">=</span> <span class="st">&#39;2018-08-10&#39;</span></span>
<span id="cb69-8"><a href="#cb69-8" tabindex="-1"></a><span class="kw">var</span> afterEnd <span class="op">=</span> <span class="st">&#39;2018-08-23&#39;</span></span>
<span id="cb69-9"><a href="#cb69-9" tabindex="-1"></a></span>
<span id="cb69-10"><a href="#cb69-10" tabindex="-1"></a><span class="kw">var</span> ernakulam <span class="op">=</span> admin2<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;ADM2_NAME&#39;</span><span class="op">,</span> <span class="st">&#39;Ernakulam&#39;</span>))</span>
<span id="cb69-11"><a href="#cb69-11" tabindex="-1"></a><span class="kw">var</span> geometry <span class="op">=</span> ernakulam<span class="op">.</span><span class="fu">geometry</span>()</span>
<span id="cb69-12"><a href="#cb69-12" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(geometry<span class="op">,</span> {<span class="dt">color</span><span class="op">:</span> <span class="st">&#39;grey&#39;</span>}<span class="op">,</span> <span class="st">&#39;Ernakulam District&#39;</span>)</span>
<span id="cb69-13"><a href="#cb69-13" tabindex="-1"></a></span>
<span id="cb69-14"><a href="#cb69-14" tabindex="-1"></a><span class="kw">var</span> collection<span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&#39;COPERNICUS/S1_GRD&#39;</span>)</span>
<span id="cb69-15"><a href="#cb69-15" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;instrumentMode&#39;</span><span class="op">,</span><span class="st">&#39;IW&#39;</span>))</span>
<span id="cb69-16"><a href="#cb69-16" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">listContains</span>(<span class="st">&#39;transmitterReceiverPolarisation&#39;</span><span class="op">,</span> <span class="st">&#39;VH&#39;</span>))</span>
<span id="cb69-17"><a href="#cb69-17" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;orbitProperties_pass&#39;</span><span class="op">,</span> <span class="st">&#39;DESCENDING&#39;</span>)) </span>
<span id="cb69-18"><a href="#cb69-18" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;resolution_meters&#39;</span><span class="op">,</span><span class="dv">10</span>))</span>
<span id="cb69-19"><a href="#cb69-19" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">bounds</span>(geometry))</span>
<span id="cb69-20"><a href="#cb69-20" tabindex="-1"></a>  <span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;VH&#39;</span>)<span class="op">;</span></span>
<span id="cb69-21"><a href="#cb69-21" tabindex="-1"></a></span>
<span id="cb69-22"><a href="#cb69-22" tabindex="-1"></a><span class="kw">var</span> beforeCollection <span class="op">=</span> collection</span>
<span id="cb69-23"><a href="#cb69-23" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(beforeStart<span class="op">,</span> beforeEnd))</span>
<span id="cb69-24"><a href="#cb69-24" tabindex="-1"></a></span>
<span id="cb69-25"><a href="#cb69-25" tabindex="-1"></a><span class="kw">var</span> afterCollection <span class="op">=</span> collection</span>
<span id="cb69-26"><a href="#cb69-26" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(afterStart<span class="op">,</span> afterEnd))</span>
<span id="cb69-27"><a href="#cb69-27" tabindex="-1"></a></span>
<span id="cb69-28"><a href="#cb69-28" tabindex="-1"></a><span class="kw">var</span> before <span class="op">=</span> beforeCollection<span class="op">.</span><span class="fu">mosaic</span>()<span class="op">.</span><span class="fu">clip</span>(geometry)<span class="op">;</span></span>
<span id="cb69-29"><a href="#cb69-29" tabindex="-1"></a><span class="kw">var</span> after <span class="op">=</span> afterCollection<span class="op">.</span><span class="fu">mosaic</span>()<span class="op">.</span><span class="fu">clip</span>(geometry)<span class="op">;</span></span>
<span id="cb69-30"><a href="#cb69-30" tabindex="-1"></a></span>
<span id="cb69-31"><a href="#cb69-31" tabindex="-1"></a><span class="kw">var</span> beforeFiltered <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(<span class="fu">toDB</span>(<span class="fu">RefinedLee</span>(<span class="fu">toNatural</span>(before))))</span>
<span id="cb69-32"><a href="#cb69-32" tabindex="-1"></a><span class="kw">var</span> afterFiltered <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(<span class="fu">toDB</span>(<span class="fu">RefinedLee</span>(<span class="fu">toNatural</span>(after))))</span>
<span id="cb69-33"><a href="#cb69-33" tabindex="-1"></a></span>
<span id="cb69-34"><a href="#cb69-34" tabindex="-1"></a><span class="kw">var</span> difference <span class="op">=</span> afterFiltered<span class="op">.</span><span class="fu">divide</span>(beforeFiltered)<span class="op">;</span></span>
<span id="cb69-35"><a href="#cb69-35" tabindex="-1"></a></span>
<span id="cb69-36"><a href="#cb69-36" tabindex="-1"></a><span class="co">// Define a threshold</span></span>
<span id="cb69-37"><a href="#cb69-37" tabindex="-1"></a><span class="kw">var</span> diffThreshold <span class="op">=</span> <span class="fl">1.25</span><span class="op">;</span></span>
<span id="cb69-38"><a href="#cb69-38" tabindex="-1"></a><span class="co">// Initial estimate of flooded pixels</span></span>
<span id="cb69-39"><a href="#cb69-39" tabindex="-1"></a><span class="kw">var</span> flooded <span class="op">=</span> difference<span class="op">.</span><span class="fu">gt</span>(diffThreshold)<span class="op">.</span><span class="fu">rename</span>(<span class="st">&#39;water&#39;</span>)<span class="op">.</span><span class="fu">selfMask</span>()<span class="op">;</span></span>
<span id="cb69-40"><a href="#cb69-40" tabindex="-1"></a></span>
<span id="cb69-41"><a href="#cb69-41" tabindex="-1"></a><span class="co">//Map.centerObject(geometry, 10)</span></span>
<span id="cb69-42"><a href="#cb69-42" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(before<span class="op">,</span> {<span class="dt">min</span><span class="op">:-</span><span class="dv">25</span><span class="op">,</span><span class="dt">max</span><span class="op">:</span><span class="dv">0</span>}<span class="op">,</span> <span class="st">&#39;Before Floods&#39;</span><span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span></span>
<span id="cb69-43"><a href="#cb69-43" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(after<span class="op">,</span> {<span class="dt">min</span><span class="op">:-</span><span class="dv">25</span><span class="op">,</span><span class="dt">max</span><span class="op">:</span><span class="dv">0</span>}<span class="op">,</span> <span class="st">&#39;After Floods&#39;</span><span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span> </span>
<span id="cb69-44"><a href="#cb69-44" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(beforeFiltered<span class="op">,</span> {<span class="dt">min</span><span class="op">:-</span><span class="dv">25</span><span class="op">,</span><span class="dt">max</span><span class="op">:</span><span class="dv">0</span>}<span class="op">,</span> <span class="st">&#39;Before Filtered&#39;</span><span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span></span>
<span id="cb69-45"><a href="#cb69-45" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(afterFiltered<span class="op">,</span> {<span class="dt">min</span><span class="op">:-</span><span class="dv">25</span><span class="op">,</span><span class="dt">max</span><span class="op">:</span><span class="dv">0</span>}<span class="op">,</span> <span class="st">&#39;After Filtered&#39;</span><span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span> </span>
<span id="cb69-46"><a href="#cb69-46" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(flooded<span class="op">,</span> {<span class="dt">min</span><span class="op">:</span><span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span><span class="dv">1</span><span class="op">,</span> <span class="dt">palette</span><span class="op">:</span> [<span class="st">&#39;orange&#39;</span>]}<span class="op">,</span> <span class="st">&#39;Initial Flood Area&#39;</span><span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span></span>
<span id="cb69-47"><a href="#cb69-47" tabindex="-1"></a></span>
<span id="cb69-48"><a href="#cb69-48" tabindex="-1"></a></span>
<span id="cb69-49"><a href="#cb69-49" tabindex="-1"></a><span class="co">// Mask out area with permanent/semi-permanent water</span></span>
<span id="cb69-50"><a href="#cb69-50" tabindex="-1"></a><span class="kw">var</span> permanentWater <span class="op">=</span> gsw<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;seasonality&#39;</span>)<span class="op">.</span><span class="fu">gte</span>(<span class="dv">5</span>)<span class="op">.</span><span class="fu">clip</span>(geometry)</span>
<span id="cb69-51"><a href="#cb69-51" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(permanentWater<span class="op">.</span><span class="fu">selfMask</span>()<span class="op">,</span> {<span class="dt">min</span><span class="op">:</span><span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span><span class="dv">1</span><span class="op">,</span> <span class="dt">palette</span><span class="op">:</span> [<span class="st">&#39;blue&#39;</span>]}<span class="op">,</span> <span class="st">&#39;Permanent Water&#39;</span><span class="op">,</span> <span class="kw">false</span>)</span>
<span id="cb69-52"><a href="#cb69-52" tabindex="-1"></a></span>
<span id="cb69-53"><a href="#cb69-53" tabindex="-1"></a><span class="co">// GSW data is masked in non-water areas. Set it to 0 using unmask()</span></span>
<span id="cb69-54"><a href="#cb69-54" tabindex="-1"></a><span class="co">// Invert the image to set all non-permanent regions to 1</span></span>
<span id="cb69-55"><a href="#cb69-55" tabindex="-1"></a><span class="kw">var</span> permanentWaterMask <span class="op">=</span> permanentWater<span class="op">.</span><span class="fu">unmask</span>(<span class="dv">0</span>)<span class="op">.</span><span class="fu">not</span>()</span>
<span id="cb69-56"><a href="#cb69-56" tabindex="-1"></a></span>
<span id="cb69-57"><a href="#cb69-57" tabindex="-1"></a><span class="kw">var</span> flooded <span class="op">=</span> flooded<span class="op">.</span><span class="fu">updateMask</span>(permanentWaterMask)</span>
<span id="cb69-58"><a href="#cb69-58" tabindex="-1"></a><span class="co">// Mask out areas with more than 5 percent slope using the HydroSHEDS DEM</span></span>
<span id="cb69-59"><a href="#cb69-59" tabindex="-1"></a><span class="kw">var</span> slopeThreshold <span class="op">=</span> <span class="dv">5</span><span class="op">;</span></span>
<span id="cb69-60"><a href="#cb69-60" tabindex="-1"></a><span class="kw">var</span> terrain <span class="op">=</span> ee<span class="op">.</span><span class="at">Algorithms</span><span class="op">.</span><span class="fu">Terrain</span>(hydrosheds)<span class="op">;</span></span>
<span id="cb69-61"><a href="#cb69-61" tabindex="-1"></a><span class="kw">var</span> slope <span class="op">=</span> terrain<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;slope&#39;</span>)<span class="op">;</span></span>
<span id="cb69-62"><a href="#cb69-62" tabindex="-1"></a><span class="kw">var</span> steepAreas <span class="op">=</span> slope<span class="op">.</span><span class="fu">gt</span>(slopeThreshold)</span>
<span id="cb69-63"><a href="#cb69-63" tabindex="-1"></a><span class="kw">var</span> slopeMask <span class="op">=</span> steepAreas<span class="op">.</span><span class="fu">not</span>()</span>
<span id="cb69-64"><a href="#cb69-64" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(steepAreas<span class="op">.</span><span class="fu">selfMask</span>()<span class="op">,</span> {<span class="dt">min</span><span class="op">:</span><span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span><span class="dv">1</span><span class="op">,</span> <span class="dt">palette</span><span class="op">:</span> [<span class="st">&#39;cyan&#39;</span>]}<span class="op">,</span> <span class="st">&#39;Steep Areas&#39;</span><span class="op">,</span> <span class="kw">false</span>)</span>
<span id="cb69-65"><a href="#cb69-65" tabindex="-1"></a></span>
<span id="cb69-66"><a href="#cb69-66" tabindex="-1"></a><span class="kw">var</span> flooded <span class="op">=</span> flooded<span class="op">.</span><span class="fu">updateMask</span>(slopeMask)</span>
<span id="cb69-67"><a href="#cb69-67" tabindex="-1"></a></span>
<span id="cb69-68"><a href="#cb69-68" tabindex="-1"></a><span class="co">// Remove isolated pixels</span></span>
<span id="cb69-69"><a href="#cb69-69" tabindex="-1"></a><span class="co">// connectedPixelCount is Zoom dependent, so visual result will vary</span></span>
<span id="cb69-70"><a href="#cb69-70" tabindex="-1"></a><span class="kw">var</span> connectedPixelThreshold <span class="op">=</span> <span class="dv">8</span><span class="op">;</span></span>
<span id="cb69-71"><a href="#cb69-71" tabindex="-1"></a><span class="kw">var</span> connections <span class="op">=</span> flooded<span class="op">.</span><span class="fu">connectedPixelCount</span>(<span class="dv">25</span>)</span>
<span id="cb69-72"><a href="#cb69-72" tabindex="-1"></a><span class="kw">var</span> disconnectedAreas <span class="op">=</span> connections<span class="op">.</span><span class="fu">lt</span>(connectedPixelThreshold)</span>
<span id="cb69-73"><a href="#cb69-73" tabindex="-1"></a><span class="kw">var</span> disconnectedAreasMask <span class="op">=</span> disconnectedAreas<span class="op">.</span><span class="fu">not</span>()</span>
<span id="cb69-74"><a href="#cb69-74" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(disconnectedAreas<span class="op">.</span><span class="fu">selfMask</span>()<span class="op">,</span> {<span class="dt">min</span><span class="op">:</span><span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span><span class="dv">1</span><span class="op">,</span> <span class="dt">palette</span><span class="op">:</span> [<span class="st">&#39;yellow&#39;</span>]}<span class="op">,</span> <span class="st">&#39;Disconnected Areas&#39;</span><span class="op">,</span> <span class="kw">false</span>)</span>
<span id="cb69-75"><a href="#cb69-75" tabindex="-1"></a></span>
<span id="cb69-76"><a href="#cb69-76" tabindex="-1"></a><span class="kw">var</span> flooded <span class="op">=</span> flooded<span class="op">.</span><span class="fu">updateMask</span>(disconnectedAreasMask)</span>
<span id="cb69-77"><a href="#cb69-77" tabindex="-1"></a></span>
<span id="cb69-78"><a href="#cb69-78" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(flooded<span class="op">,</span> {<span class="dt">min</span><span class="op">:</span><span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span><span class="dv">1</span><span class="op">,</span> <span class="dt">palette</span><span class="op">:</span> [<span class="st">&#39;red&#39;</span>]}<span class="op">,</span> <span class="st">&#39;Flooded Areas&#39;</span>)<span class="op">;</span></span>
<span id="cb69-79"><a href="#cb69-79" tabindex="-1"></a></span>
<span id="cb69-80"><a href="#cb69-80" tabindex="-1"></a><span class="co">// Exercise</span></span>
<span id="cb69-81"><a href="#cb69-81" tabindex="-1"></a><span class="co">// Apply a Crop Mask to asses flood damage to crops</span></span>
<span id="cb69-82"><a href="#cb69-82" tabindex="-1"></a><span class="co">// Use the ESA WorldCover data to extract cropland</span></span>
<span id="cb69-83"><a href="#cb69-83" tabindex="-1"></a><span class="kw">var</span> dataset <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&quot;ESA/WorldCover/v100&quot;</span>)<span class="op">.</span><span class="fu">first</span>()<span class="op">;</span></span>
<span id="cb69-84"><a href="#cb69-84" tabindex="-1"></a><span class="kw">var</span> classification <span class="op">=</span> dataset<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;Map&#39;</span>)<span class="op">.</span><span class="fu">clip</span>(geometry)</span>
<span id="cb69-85"><a href="#cb69-85" tabindex="-1"></a><span class="kw">var</span> cropland <span class="op">=</span> classification<span class="op">.</span><span class="fu">eq</span>(<span class="dv">40</span>)</span>
<span id="cb69-86"><a href="#cb69-86" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(cropland<span class="op">.</span><span class="fu">selfMask</span>()<span class="op">,</span> {<span class="dt">min</span><span class="op">:</span><span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span><span class="dv">1</span><span class="op">,</span> <span class="dt">palette</span><span class="op">:</span> [<span class="st">&#39;white&#39;</span><span class="op">,</span> <span class="st">&#39;green&#39;</span>]}<span class="op">,</span> <span class="st">&#39;Cropland&#39;</span>)</span>
<span id="cb69-87"><a href="#cb69-87" tabindex="-1"></a></span>
<span id="cb69-88"><a href="#cb69-88" tabindex="-1"></a><span class="co">// Mask all non-cropland and display flooded regions</span></span>
<span id="cb69-89"><a href="#cb69-89" tabindex="-1"></a><span class="co">// Display the result on the map.</span></span>
<span id="cb69-90"><a href="#cb69-90" tabindex="-1"></a></span>
<span id="cb69-91"><a href="#cb69-91" tabindex="-1"></a></span>
<span id="cb69-92"><a href="#cb69-92" tabindex="-1"></a><span class="co">//############################</span></span>
<span id="cb69-93"><a href="#cb69-93" tabindex="-1"></a><span class="co">// Speckle Filtering Functions</span></span>
<span id="cb69-94"><a href="#cb69-94" tabindex="-1"></a><span class="co">//############################</span></span>
<span id="cb69-95"><a href="#cb69-95" tabindex="-1"></a></span>
<span id="cb69-96"><a href="#cb69-96" tabindex="-1"></a><span class="co">// Function to convert from dB</span></span>
<span id="cb69-97"><a href="#cb69-97" tabindex="-1"></a><span class="kw">function</span> <span class="fu">toNatural</span>(img) {</span>
<span id="cb69-98"><a href="#cb69-98" tabindex="-1"></a>  <span class="cf">return</span> ee<span class="op">.</span><span class="fu">Image</span>(<span class="fl">10.0</span>)<span class="op">.</span><span class="fu">pow</span>(img<span class="op">.</span><span class="fu">select</span>(<span class="dv">0</span>)<span class="op">.</span><span class="fu">divide</span>(<span class="fl">10.0</span>))<span class="op">;</span></span>
<span id="cb69-99"><a href="#cb69-99" tabindex="-1"></a>}</span>
<span id="cb69-100"><a href="#cb69-100" tabindex="-1"></a></span>
<span id="cb69-101"><a href="#cb69-101" tabindex="-1"></a><span class="co">//Function to convert to dB</span></span>
<span id="cb69-102"><a href="#cb69-102" tabindex="-1"></a><span class="kw">function</span> <span class="fu">toDB</span>(img) {</span>
<span id="cb69-103"><a href="#cb69-103" tabindex="-1"></a>  <span class="cf">return</span> ee<span class="op">.</span><span class="fu">Image</span>(img)<span class="op">.</span><span class="fu">log10</span>()<span class="op">.</span><span class="fu">multiply</span>(<span class="fl">10.0</span>)<span class="op">;</span></span>
<span id="cb69-104"><a href="#cb69-104" tabindex="-1"></a>}</span>
<span id="cb69-105"><a href="#cb69-105" tabindex="-1"></a></span>
<span id="cb69-106"><a href="#cb69-106" tabindex="-1"></a><span class="co">//Apllying a Refined Lee Speckle filter as coded in the SNAP 3.0 S1TBX:</span></span>
<span id="cb69-107"><a href="#cb69-107" tabindex="-1"></a></span>
<span id="cb69-108"><a href="#cb69-108" tabindex="-1"></a><span class="co">//https://github.com/senbox-org/s1tbx/blob/master/s1tbx-op-sar-processing/src/main/java/org/esa/s1tbx/sar/gpf/filtering/SpeckleFilters/RefinedLee.java</span></span>
<span id="cb69-109"><a href="#cb69-109" tabindex="-1"></a><span class="co">//Adapted by Guido Lemoine</span></span>
<span id="cb69-110"><a href="#cb69-110" tabindex="-1"></a></span>
<span id="cb69-111"><a href="#cb69-111" tabindex="-1"></a><span class="co">// by Guido Lemoine</span></span>
<span id="cb69-112"><a href="#cb69-112" tabindex="-1"></a><span class="kw">function</span> <span class="fu">RefinedLee</span>(img) {</span>
<span id="cb69-113"><a href="#cb69-113" tabindex="-1"></a>  <span class="co">// img must be in natural units, i.e. not in dB!</span></span>
<span id="cb69-114"><a href="#cb69-114" tabindex="-1"></a>  <span class="co">// Set up 3x3 kernels </span></span>
<span id="cb69-115"><a href="#cb69-115" tabindex="-1"></a>  <span class="kw">var</span> weights3 <span class="op">=</span> ee<span class="op">.</span><span class="at">List</span><span class="op">.</span><span class="fu">repeat</span>(ee<span class="op">.</span><span class="at">List</span><span class="op">.</span><span class="fu">repeat</span>(<span class="dv">1</span><span class="op">,</span><span class="dv">3</span>)<span class="op">,</span><span class="dv">3</span>)<span class="op">;</span></span>
<span id="cb69-116"><a href="#cb69-116" tabindex="-1"></a>  <span class="kw">var</span> kernel3 <span class="op">=</span> ee<span class="op">.</span><span class="at">Kernel</span><span class="op">.</span><span class="fu">fixed</span>(<span class="dv">3</span><span class="op">,</span><span class="dv">3</span><span class="op">,</span> weights3<span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span></span>
<span id="cb69-117"><a href="#cb69-117" tabindex="-1"></a></span>
<span id="cb69-118"><a href="#cb69-118" tabindex="-1"></a>  <span class="kw">var</span> mean3 <span class="op">=</span> img<span class="op">.</span><span class="fu">reduceNeighborhood</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">mean</span>()<span class="op">,</span> kernel3)<span class="op">;</span></span>
<span id="cb69-119"><a href="#cb69-119" tabindex="-1"></a>  <span class="kw">var</span> variance3 <span class="op">=</span> img<span class="op">.</span><span class="fu">reduceNeighborhood</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">variance</span>()<span class="op">,</span> kernel3)<span class="op">;</span></span>
<span id="cb69-120"><a href="#cb69-120" tabindex="-1"></a></span>
<span id="cb69-121"><a href="#cb69-121" tabindex="-1"></a>  <span class="co">// Use a sample of the 3x3 windows inside a 7x7 windows to determine gradients and directions</span></span>
<span id="cb69-122"><a href="#cb69-122" tabindex="-1"></a>  <span class="kw">var</span> sample_weights <span class="op">=</span> ee<span class="op">.</span><span class="fu">List</span>([[<span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span>]<span class="op">,</span> [<span class="dv">0</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span>]<span class="op">,</span>[<span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span>]<span class="op">,</span> [<span class="dv">0</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span>]<span class="op">,</span> [<span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span>]<span class="op">,</span> [<span class="dv">0</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span>]<span class="op">,</span>[<span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span>]])<span class="op">;</span></span>
<span id="cb69-123"><a href="#cb69-123" tabindex="-1"></a></span>
<span id="cb69-124"><a href="#cb69-124" tabindex="-1"></a>  <span class="kw">var</span> sample_kernel <span class="op">=</span> ee<span class="op">.</span><span class="at">Kernel</span><span class="op">.</span><span class="fu">fixed</span>(<span class="dv">7</span><span class="op">,</span><span class="dv">7</span><span class="op">,</span> sample_weights<span class="op">,</span> <span class="dv">3</span><span class="op">,</span><span class="dv">3</span><span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span></span>
<span id="cb69-125"><a href="#cb69-125" tabindex="-1"></a></span>
<span id="cb69-126"><a href="#cb69-126" tabindex="-1"></a>  <span class="co">// Calculate mean and variance for the sampled windows and store as 9 bands</span></span>
<span id="cb69-127"><a href="#cb69-127" tabindex="-1"></a>  <span class="kw">var</span> sample_mean <span class="op">=</span> mean3<span class="op">.</span><span class="fu">neighborhoodToBands</span>(sample_kernel)<span class="op">;</span> </span>
<span id="cb69-128"><a href="#cb69-128" tabindex="-1"></a>  <span class="kw">var</span> sample_var <span class="op">=</span> variance3<span class="op">.</span><span class="fu">neighborhoodToBands</span>(sample_kernel)<span class="op">;</span></span>
<span id="cb69-129"><a href="#cb69-129" tabindex="-1"></a></span>
<span id="cb69-130"><a href="#cb69-130" tabindex="-1"></a>  <span class="co">// Determine the 4 gradients for the sampled windows</span></span>
<span id="cb69-131"><a href="#cb69-131" tabindex="-1"></a>  <span class="kw">var</span> gradients <span class="op">=</span> sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">1</span>)<span class="op">.</span><span class="fu">subtract</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">7</span>))<span class="op">.</span><span class="fu">abs</span>()<span class="op">;</span></span>
<span id="cb69-132"><a href="#cb69-132" tabindex="-1"></a>  gradients <span class="op">=</span> gradients<span class="op">.</span><span class="fu">addBands</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">6</span>)<span class="op">.</span><span class="fu">subtract</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">2</span>))<span class="op">.</span><span class="fu">abs</span>())<span class="op">;</span></span>
<span id="cb69-133"><a href="#cb69-133" tabindex="-1"></a>  gradients <span class="op">=</span> gradients<span class="op">.</span><span class="fu">addBands</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">3</span>)<span class="op">.</span><span class="fu">subtract</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">5</span>))<span class="op">.</span><span class="fu">abs</span>())<span class="op">;</span></span>
<span id="cb69-134"><a href="#cb69-134" tabindex="-1"></a>  gradients <span class="op">=</span> gradients<span class="op">.</span><span class="fu">addBands</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">0</span>)<span class="op">.</span><span class="fu">subtract</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">8</span>))<span class="op">.</span><span class="fu">abs</span>())<span class="op">;</span></span>
<span id="cb69-135"><a href="#cb69-135" tabindex="-1"></a></span>
<span id="cb69-136"><a href="#cb69-136" tabindex="-1"></a>  <span class="co">// And find the maximum gradient amongst gradient bands</span></span>
<span id="cb69-137"><a href="#cb69-137" tabindex="-1"></a>  <span class="kw">var</span> max_gradient <span class="op">=</span> gradients<span class="op">.</span><span class="fu">reduce</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">max</span>())<span class="op">;</span></span>
<span id="cb69-138"><a href="#cb69-138" tabindex="-1"></a></span>
<span id="cb69-139"><a href="#cb69-139" tabindex="-1"></a>  <span class="co">// Create a mask for band pixels that are the maximum gradient</span></span>
<span id="cb69-140"><a href="#cb69-140" tabindex="-1"></a>  <span class="kw">var</span> gradmask <span class="op">=</span> gradients<span class="op">.</span><span class="fu">eq</span>(max_gradient)<span class="op">;</span></span>
<span id="cb69-141"><a href="#cb69-141" tabindex="-1"></a></span>
<span id="cb69-142"><a href="#cb69-142" tabindex="-1"></a>  <span class="co">// duplicate gradmask bands: each gradient represents 2 directions</span></span>
<span id="cb69-143"><a href="#cb69-143" tabindex="-1"></a>  gradmask <span class="op">=</span> gradmask<span class="op">.</span><span class="fu">addBands</span>(gradmask)<span class="op">;</span></span>
<span id="cb69-144"><a href="#cb69-144" tabindex="-1"></a></span>
<span id="cb69-145"><a href="#cb69-145" tabindex="-1"></a>  <span class="co">// Determine the 8 directions</span></span>
<span id="cb69-146"><a href="#cb69-146" tabindex="-1"></a>  <span class="kw">var</span> directions <span class="op">=</span> sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">1</span>)<span class="op">.</span><span class="fu">subtract</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">4</span>))<span class="op">.</span><span class="fu">gt</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">4</span>)<span class="op">.</span><span class="fu">subtract</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">7</span>)))<span class="op">.</span><span class="fu">multiply</span>(<span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb69-147"><a href="#cb69-147" tabindex="-1"></a>  directions <span class="op">=</span> directions<span class="op">.</span><span class="fu">addBands</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">6</span>)<span class="op">.</span><span class="fu">subtract</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">4</span>))<span class="op">.</span><span class="fu">gt</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">4</span>)<span class="op">.</span><span class="fu">subtract</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">2</span>)))<span class="op">.</span><span class="fu">multiply</span>(<span class="dv">2</span>))<span class="op">;</span></span>
<span id="cb69-148"><a href="#cb69-148" tabindex="-1"></a>  directions <span class="op">=</span> directions<span class="op">.</span><span class="fu">addBands</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">3</span>)<span class="op">.</span><span class="fu">subtract</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">4</span>))<span class="op">.</span><span class="fu">gt</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">4</span>)<span class="op">.</span><span class="fu">subtract</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">5</span>)))<span class="op">.</span><span class="fu">multiply</span>(<span class="dv">3</span>))<span class="op">;</span></span>
<span id="cb69-149"><a href="#cb69-149" tabindex="-1"></a>  directions <span class="op">=</span> directions<span class="op">.</span><span class="fu">addBands</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">0</span>)<span class="op">.</span><span class="fu">subtract</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">4</span>))<span class="op">.</span><span class="fu">gt</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">4</span>)<span class="op">.</span><span class="fu">subtract</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">8</span>)))<span class="op">.</span><span class="fu">multiply</span>(<span class="dv">4</span>))<span class="op">;</span></span>
<span id="cb69-150"><a href="#cb69-150" tabindex="-1"></a>  <span class="co">// The next 4 are the not() of the previous 4</span></span>
<span id="cb69-151"><a href="#cb69-151" tabindex="-1"></a>  directions <span class="op">=</span> directions<span class="op">.</span><span class="fu">addBands</span>(directions<span class="op">.</span><span class="fu">select</span>(<span class="dv">0</span>)<span class="op">.</span><span class="fu">not</span>()<span class="op">.</span><span class="fu">multiply</span>(<span class="dv">5</span>))<span class="op">;</span></span>
<span id="cb69-152"><a href="#cb69-152" tabindex="-1"></a>  directions <span class="op">=</span> directions<span class="op">.</span><span class="fu">addBands</span>(directions<span class="op">.</span><span class="fu">select</span>(<span class="dv">1</span>)<span class="op">.</span><span class="fu">not</span>()<span class="op">.</span><span class="fu">multiply</span>(<span class="dv">6</span>))<span class="op">;</span></span>
<span id="cb69-153"><a href="#cb69-153" tabindex="-1"></a>  directions <span class="op">=</span> directions<span class="op">.</span><span class="fu">addBands</span>(directions<span class="op">.</span><span class="fu">select</span>(<span class="dv">2</span>)<span class="op">.</span><span class="fu">not</span>()<span class="op">.</span><span class="fu">multiply</span>(<span class="dv">7</span>))<span class="op">;</span></span>
<span id="cb69-154"><a href="#cb69-154" tabindex="-1"></a>  directions <span class="op">=</span> directions<span class="op">.</span><span class="fu">addBands</span>(directions<span class="op">.</span><span class="fu">select</span>(<span class="dv">3</span>)<span class="op">.</span><span class="fu">not</span>()<span class="op">.</span><span class="fu">multiply</span>(<span class="dv">8</span>))<span class="op">;</span></span>
<span id="cb69-155"><a href="#cb69-155" tabindex="-1"></a></span>
<span id="cb69-156"><a href="#cb69-156" tabindex="-1"></a>  <span class="co">// Mask all values that are not 1-8</span></span>
<span id="cb69-157"><a href="#cb69-157" tabindex="-1"></a>  directions <span class="op">=</span> directions<span class="op">.</span><span class="fu">updateMask</span>(gradmask)<span class="op">;</span></span>
<span id="cb69-158"><a href="#cb69-158" tabindex="-1"></a></span>
<span id="cb69-159"><a href="#cb69-159" tabindex="-1"></a>  <span class="co">// &quot;collapse&quot; the stack into a singe band image (due to masking, each pixel has just one value (1-8) in it&#39;s directional band, and is otherwise masked)</span></span>
<span id="cb69-160"><a href="#cb69-160" tabindex="-1"></a>  directions <span class="op">=</span> directions<span class="op">.</span><span class="fu">reduce</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">sum</span>())<span class="op">;</span>  </span>
<span id="cb69-161"><a href="#cb69-161" tabindex="-1"></a></span>
<span id="cb69-162"><a href="#cb69-162" tabindex="-1"></a>  <span class="co">//var pal = [&#39;ffffff&#39;,&#39;ff0000&#39;,&#39;ffff00&#39;, &#39;00ff00&#39;, &#39;00ffff&#39;, &#39;0000ff&#39;, &#39;ff00ff&#39;, &#39;000000&#39;];</span></span>
<span id="cb69-163"><a href="#cb69-163" tabindex="-1"></a>  <span class="co">//Map.addLayer(directions.reduce(ee.Reducer.sum()), {min:1, max:8, palette: pal}, &#39;Directions&#39;, false);</span></span>
<span id="cb69-164"><a href="#cb69-164" tabindex="-1"></a></span>
<span id="cb69-165"><a href="#cb69-165" tabindex="-1"></a>  <span class="kw">var</span> sample_stats <span class="op">=</span> sample_var<span class="op">.</span><span class="fu">divide</span>(sample_mean<span class="op">.</span><span class="fu">multiply</span>(sample_mean))<span class="op">;</span></span>
<span id="cb69-166"><a href="#cb69-166" tabindex="-1"></a></span>
<span id="cb69-167"><a href="#cb69-167" tabindex="-1"></a>  <span class="co">// Calculate localNoiseVariance</span></span>
<span id="cb69-168"><a href="#cb69-168" tabindex="-1"></a>  <span class="kw">var</span> sigmaV <span class="op">=</span> sample_stats<span class="op">.</span><span class="fu">toArray</span>()<span class="op">.</span><span class="fu">arraySort</span>()<span class="op">.</span><span class="fu">arraySlice</span>(<span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">5</span>)<span class="op">.</span><span class="fu">arrayReduce</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">mean</span>()<span class="op">,</span> [<span class="dv">0</span>])<span class="op">;</span></span>
<span id="cb69-169"><a href="#cb69-169" tabindex="-1"></a></span>
<span id="cb69-170"><a href="#cb69-170" tabindex="-1"></a>  <span class="co">// Set up the 7*7 kernels for directional statistics</span></span>
<span id="cb69-171"><a href="#cb69-171" tabindex="-1"></a>  <span class="kw">var</span> rect_weights <span class="op">=</span> ee<span class="op">.</span><span class="at">List</span><span class="op">.</span><span class="fu">repeat</span>(ee<span class="op">.</span><span class="at">List</span><span class="op">.</span><span class="fu">repeat</span>(<span class="dv">0</span><span class="op">,</span><span class="dv">7</span>)<span class="op">,</span><span class="dv">3</span>)<span class="op">.</span><span class="fu">cat</span>(ee<span class="op">.</span><span class="at">List</span><span class="op">.</span><span class="fu">repeat</span>(ee<span class="op">.</span><span class="at">List</span><span class="op">.</span><span class="fu">repeat</span>(<span class="dv">1</span><span class="op">,</span><span class="dv">7</span>)<span class="op">,</span><span class="dv">4</span>))<span class="op">;</span></span>
<span id="cb69-172"><a href="#cb69-172" tabindex="-1"></a></span>
<span id="cb69-173"><a href="#cb69-173" tabindex="-1"></a>  <span class="kw">var</span> diag_weights <span class="op">=</span> ee<span class="op">.</span><span class="fu">List</span>([[<span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span>]<span class="op">,</span> [<span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span>]<span class="op">,</span> [<span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span>]<span class="op">,</span> </span>
<span id="cb69-174"><a href="#cb69-174" tabindex="-1"></a>    [<span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span>]<span class="op">,</span> [<span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span>]<span class="op">,</span> [<span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span>]<span class="op">,</span> [<span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span>]])<span class="op">;</span></span>
<span id="cb69-175"><a href="#cb69-175" tabindex="-1"></a></span>
<span id="cb69-176"><a href="#cb69-176" tabindex="-1"></a>  <span class="kw">var</span> rect_kernel <span class="op">=</span> ee<span class="op">.</span><span class="at">Kernel</span><span class="op">.</span><span class="fu">fixed</span>(<span class="dv">7</span><span class="op">,</span><span class="dv">7</span><span class="op">,</span> rect_weights<span class="op">,</span> <span class="dv">3</span><span class="op">,</span> <span class="dv">3</span><span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span></span>
<span id="cb69-177"><a href="#cb69-177" tabindex="-1"></a>  <span class="kw">var</span> diag_kernel <span class="op">=</span> ee<span class="op">.</span><span class="at">Kernel</span><span class="op">.</span><span class="fu">fixed</span>(<span class="dv">7</span><span class="op">,</span><span class="dv">7</span><span class="op">,</span> diag_weights<span class="op">,</span> <span class="dv">3</span><span class="op">,</span> <span class="dv">3</span><span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span></span>
<span id="cb69-178"><a href="#cb69-178" tabindex="-1"></a></span>
<span id="cb69-179"><a href="#cb69-179" tabindex="-1"></a>  <span class="co">// Create stacks for mean and variance using the original kernels. Mask with relevant direction.</span></span>
<span id="cb69-180"><a href="#cb69-180" tabindex="-1"></a>  <span class="kw">var</span> dir_mean <span class="op">=</span> img<span class="op">.</span><span class="fu">reduceNeighborhood</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">mean</span>()<span class="op">,</span> rect_kernel)<span class="op">.</span><span class="fu">updateMask</span>(directions<span class="op">.</span><span class="fu">eq</span>(<span class="dv">1</span>))<span class="op">;</span></span>
<span id="cb69-181"><a href="#cb69-181" tabindex="-1"></a>  <span class="kw">var</span> dir_var <span class="op">=</span> img<span class="op">.</span><span class="fu">reduceNeighborhood</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">variance</span>()<span class="op">,</span> rect_kernel)<span class="op">.</span><span class="fu">updateMask</span>(directions<span class="op">.</span><span class="fu">eq</span>(<span class="dv">1</span>))<span class="op">;</span></span>
<span id="cb69-182"><a href="#cb69-182" tabindex="-1"></a></span>
<span id="cb69-183"><a href="#cb69-183" tabindex="-1"></a>  dir_mean <span class="op">=</span> dir_mean<span class="op">.</span><span class="fu">addBands</span>(img<span class="op">.</span><span class="fu">reduceNeighborhood</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">mean</span>()<span class="op">,</span> diag_kernel)<span class="op">.</span><span class="fu">updateMask</span>(directions<span class="op">.</span><span class="fu">eq</span>(<span class="dv">2</span>)))<span class="op">;</span></span>
<span id="cb69-184"><a href="#cb69-184" tabindex="-1"></a>  dir_var <span class="op">=</span> dir_var<span class="op">.</span><span class="fu">addBands</span>(img<span class="op">.</span><span class="fu">reduceNeighborhood</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">variance</span>()<span class="op">,</span> diag_kernel)<span class="op">.</span><span class="fu">updateMask</span>(directions<span class="op">.</span><span class="fu">eq</span>(<span class="dv">2</span>)))<span class="op">;</span></span>
<span id="cb69-185"><a href="#cb69-185" tabindex="-1"></a></span>
<span id="cb69-186"><a href="#cb69-186" tabindex="-1"></a>  <span class="co">// and add the bands for rotated kernels</span></span>
<span id="cb69-187"><a href="#cb69-187" tabindex="-1"></a>  <span class="cf">for</span> (<span class="kw">var</span> i<span class="op">=</span><span class="dv">1</span><span class="op">;</span> i<span class="op">&lt;</span><span class="dv">4</span><span class="op">;</span> i<span class="op">++</span>) {</span>
<span id="cb69-188"><a href="#cb69-188" tabindex="-1"></a>    dir_mean <span class="op">=</span> dir_mean<span class="op">.</span><span class="fu">addBands</span>(img<span class="op">.</span><span class="fu">reduceNeighborhood</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">mean</span>()<span class="op">,</span> rect_kernel<span class="op">.</span><span class="fu">rotate</span>(i))<span class="op">.</span><span class="fu">updateMask</span>(directions<span class="op">.</span><span class="fu">eq</span>(<span class="dv">2</span><span class="op">*</span>i<span class="op">+</span><span class="dv">1</span>)))<span class="op">;</span></span>
<span id="cb69-189"><a href="#cb69-189" tabindex="-1"></a>    dir_var <span class="op">=</span> dir_var<span class="op">.</span><span class="fu">addBands</span>(img<span class="op">.</span><span class="fu">reduceNeighborhood</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">variance</span>()<span class="op">,</span> rect_kernel<span class="op">.</span><span class="fu">rotate</span>(i))<span class="op">.</span><span class="fu">updateMask</span>(directions<span class="op">.</span><span class="fu">eq</span>(<span class="dv">2</span><span class="op">*</span>i<span class="op">+</span><span class="dv">1</span>)))<span class="op">;</span></span>
<span id="cb69-190"><a href="#cb69-190" tabindex="-1"></a>    dir_mean <span class="op">=</span> dir_mean<span class="op">.</span><span class="fu">addBands</span>(img<span class="op">.</span><span class="fu">reduceNeighborhood</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">mean</span>()<span class="op">,</span> diag_kernel<span class="op">.</span><span class="fu">rotate</span>(i))<span class="op">.</span><span class="fu">updateMask</span>(directions<span class="op">.</span><span class="fu">eq</span>(<span class="dv">2</span><span class="op">*</span>i<span class="op">+</span><span class="dv">2</span>)))<span class="op">;</span></span>
<span id="cb69-191"><a href="#cb69-191" tabindex="-1"></a>    dir_var <span class="op">=</span> dir_var<span class="op">.</span><span class="fu">addBands</span>(img<span class="op">.</span><span class="fu">reduceNeighborhood</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">variance</span>()<span class="op">,</span> diag_kernel<span class="op">.</span><span class="fu">rotate</span>(i))<span class="op">.</span><span class="fu">updateMask</span>(directions<span class="op">.</span><span class="fu">eq</span>(<span class="dv">2</span><span class="op">*</span>i<span class="op">+</span><span class="dv">2</span>)))<span class="op">;</span></span>
<span id="cb69-192"><a href="#cb69-192" tabindex="-1"></a>  }</span>
<span id="cb69-193"><a href="#cb69-193" tabindex="-1"></a></span>
<span id="cb69-194"><a href="#cb69-194" tabindex="-1"></a>  <span class="co">// &quot;collapse&quot; the stack into a single band image (due to masking, each pixel has just one value in it&#39;s directional band, and is otherwise masked)</span></span>
<span id="cb69-195"><a href="#cb69-195" tabindex="-1"></a>  dir_mean <span class="op">=</span> dir_mean<span class="op">.</span><span class="fu">reduce</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">sum</span>())<span class="op">;</span></span>
<span id="cb69-196"><a href="#cb69-196" tabindex="-1"></a>  dir_var <span class="op">=</span> dir_var<span class="op">.</span><span class="fu">reduce</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">sum</span>())<span class="op">;</span></span>
<span id="cb69-197"><a href="#cb69-197" tabindex="-1"></a></span>
<span id="cb69-198"><a href="#cb69-198" tabindex="-1"></a>  <span class="co">// A finally generate the filtered value</span></span>
<span id="cb69-199"><a href="#cb69-199" tabindex="-1"></a>  <span class="kw">var</span> varX <span class="op">=</span> dir_var<span class="op">.</span><span class="fu">subtract</span>(dir_mean<span class="op">.</span><span class="fu">multiply</span>(dir_mean)<span class="op">.</span><span class="fu">multiply</span>(sigmaV))<span class="op">.</span><span class="fu">divide</span>(sigmaV<span class="op">.</span><span class="fu">add</span>(<span class="fl">1.0</span>))<span class="op">;</span></span>
<span id="cb69-200"><a href="#cb69-200" tabindex="-1"></a></span>
<span id="cb69-201"><a href="#cb69-201" tabindex="-1"></a>  <span class="kw">var</span> b <span class="op">=</span> varX<span class="op">.</span><span class="fu">divide</span>(dir_var)<span class="op">;</span></span>
<span id="cb69-202"><a href="#cb69-202" tabindex="-1"></a></span>
<span id="cb69-203"><a href="#cb69-203" tabindex="-1"></a>  <span class="kw">var</span> result <span class="op">=</span> dir_mean<span class="op">.</span><span class="fu">add</span>(b<span class="op">.</span><span class="fu">multiply</span>(img<span class="op">.</span><span class="fu">subtract</span>(dir_mean)))<span class="op">;</span></span>
<span id="cb69-204"><a href="#cb69-204" tabindex="-1"></a>  <span class="cf">return</span>(result<span class="op">.</span><span class="fu">arrayFlatten</span>([[<span class="st">&#39;sum&#39;</span>]]))<span class="op">;</span></span>
<span id="cb69-205"><a href="#cb69-205" tabindex="-1"></a>}</span></code></pre></div>
</div>
</div>
<div id="calculate-flooded-area" class="section level2">
<h2>06. Calculate Flooded Area</h2>
<p>We visually inspected the flooded regions in the previous exercise,
now lets us calculate the total flooded area in hectares and compute the
percentage of the area flooded. We have already discussed the technique
for <a href="(#calculating-area)">calculating area</a> in the earth
engine.</p>
<a
href="https://code.earthengine.google.com/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3A05-Flood_Mapping%2F06b_Calculate_Flooded_Area_(complete)"
target="_blank">Open in Code Editor ↗</a>
<div class="figure" style="text-align: center">
<img src="images/gee_water_resources_management/flood_area.png" alt="Flooded area" width="50%" />
<p class="caption">
Flooded area
</p>
</div>
<div class="sourceCode" id="cb70"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb70-1"><a href="#cb70-1" tabindex="-1"></a><span class="kw">var</span> admin2 <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">&#39;FAO/GAUL_SIMPLIFIED_500m/2015/level2&#39;</span>)</span>
<span id="cb70-2"><a href="#cb70-2" tabindex="-1"></a><span class="kw">var</span> hydrosheds <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(<span class="st">&#39;WWF/HydroSHEDS/03VFDEM&#39;</span>)</span>
<span id="cb70-3"><a href="#cb70-3" tabindex="-1"></a><span class="kw">var</span> gsw <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(<span class="st">&#39;JRC/GSW1_3/GlobalSurfaceWater&#39;</span>)</span>
<span id="cb70-4"><a href="#cb70-4" tabindex="-1"></a></span>
<span id="cb70-5"><a href="#cb70-5" tabindex="-1"></a><span class="kw">var</span> beforeStart <span class="op">=</span> <span class="st">&#39;2018-07-15&#39;</span></span>
<span id="cb70-6"><a href="#cb70-6" tabindex="-1"></a><span class="kw">var</span> beforeEnd <span class="op">=</span> <span class="st">&#39;2018-08-10&#39;</span></span>
<span id="cb70-7"><a href="#cb70-7" tabindex="-1"></a><span class="kw">var</span> afterStart <span class="op">=</span> <span class="st">&#39;2018-08-10&#39;</span></span>
<span id="cb70-8"><a href="#cb70-8" tabindex="-1"></a><span class="kw">var</span> afterEnd <span class="op">=</span> <span class="st">&#39;2018-08-23&#39;</span></span>
<span id="cb70-9"><a href="#cb70-9" tabindex="-1"></a></span>
<span id="cb70-10"><a href="#cb70-10" tabindex="-1"></a><span class="kw">var</span> ernakulam <span class="op">=</span> admin2<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;ADM2_NAME&#39;</span><span class="op">,</span> <span class="st">&#39;Ernakulam&#39;</span>))</span>
<span id="cb70-11"><a href="#cb70-11" tabindex="-1"></a><span class="kw">var</span> geometry <span class="op">=</span> ernakulam<span class="op">.</span><span class="fu">geometry</span>()</span>
<span id="cb70-12"><a href="#cb70-12" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(geometry<span class="op">,</span> {<span class="dt">color</span><span class="op">:</span> <span class="st">&#39;grey&#39;</span>}<span class="op">,</span> <span class="st">&#39;Ernakulam District&#39;</span>)</span>
<span id="cb70-13"><a href="#cb70-13" tabindex="-1"></a></span>
<span id="cb70-14"><a href="#cb70-14" tabindex="-1"></a><span class="kw">var</span> collection<span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&#39;COPERNICUS/S1_GRD&#39;</span>)</span>
<span id="cb70-15"><a href="#cb70-15" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;instrumentMode&#39;</span><span class="op">,</span><span class="st">&#39;IW&#39;</span>))</span>
<span id="cb70-16"><a href="#cb70-16" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">listContains</span>(<span class="st">&#39;transmitterReceiverPolarisation&#39;</span><span class="op">,</span> <span class="st">&#39;VH&#39;</span>))</span>
<span id="cb70-17"><a href="#cb70-17" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;orbitProperties_pass&#39;</span><span class="op">,</span> <span class="st">&#39;DESCENDING&#39;</span>)) </span>
<span id="cb70-18"><a href="#cb70-18" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;resolution_meters&#39;</span><span class="op">,</span><span class="dv">10</span>))</span>
<span id="cb70-19"><a href="#cb70-19" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">bounds</span>(geometry))</span>
<span id="cb70-20"><a href="#cb70-20" tabindex="-1"></a>  <span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;VH&#39;</span>)<span class="op">;</span></span>
<span id="cb70-21"><a href="#cb70-21" tabindex="-1"></a></span>
<span id="cb70-22"><a href="#cb70-22" tabindex="-1"></a><span class="kw">var</span> beforeCollection <span class="op">=</span> collection</span>
<span id="cb70-23"><a href="#cb70-23" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(beforeStart<span class="op">,</span> beforeEnd))</span>
<span id="cb70-24"><a href="#cb70-24" tabindex="-1"></a></span>
<span id="cb70-25"><a href="#cb70-25" tabindex="-1"></a><span class="kw">var</span> afterCollection <span class="op">=</span> collection</span>
<span id="cb70-26"><a href="#cb70-26" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(afterStart<span class="op">,</span> afterEnd))</span>
<span id="cb70-27"><a href="#cb70-27" tabindex="-1"></a>  </span>
<span id="cb70-28"><a href="#cb70-28" tabindex="-1"></a><span class="kw">var</span> before <span class="op">=</span> beforeCollection<span class="op">.</span><span class="fu">mosaic</span>()<span class="op">.</span><span class="fu">clip</span>(geometry)<span class="op">;</span></span>
<span id="cb70-29"><a href="#cb70-29" tabindex="-1"></a><span class="kw">var</span> after <span class="op">=</span> afterCollection<span class="op">.</span><span class="fu">mosaic</span>()<span class="op">.</span><span class="fu">clip</span>(geometry)<span class="op">;</span></span>
<span id="cb70-30"><a href="#cb70-30" tabindex="-1"></a></span>
<span id="cb70-31"><a href="#cb70-31" tabindex="-1"></a><span class="kw">var</span> beforeFiltered <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(<span class="fu">toDB</span>(<span class="fu">RefinedLee</span>(<span class="fu">toNatural</span>(before))))</span>
<span id="cb70-32"><a href="#cb70-32" tabindex="-1"></a><span class="kw">var</span> afterFiltered <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(<span class="fu">toDB</span>(<span class="fu">RefinedLee</span>(<span class="fu">toNatural</span>(after))))</span>
<span id="cb70-33"><a href="#cb70-33" tabindex="-1"></a></span>
<span id="cb70-34"><a href="#cb70-34" tabindex="-1"></a><span class="kw">var</span> difference <span class="op">=</span> afterFiltered<span class="op">.</span><span class="fu">divide</span>(beforeFiltered)<span class="op">;</span></span>
<span id="cb70-35"><a href="#cb70-35" tabindex="-1"></a></span>
<span id="cb70-36"><a href="#cb70-36" tabindex="-1"></a><span class="co">// Define a threshold</span></span>
<span id="cb70-37"><a href="#cb70-37" tabindex="-1"></a><span class="kw">var</span> diffThreshold <span class="op">=</span> <span class="fl">1.25</span><span class="op">;</span></span>
<span id="cb70-38"><a href="#cb70-38" tabindex="-1"></a><span class="co">// Initial estimate of flooded pixels</span></span>
<span id="cb70-39"><a href="#cb70-39" tabindex="-1"></a><span class="kw">var</span> flooded <span class="op">=</span> difference<span class="op">.</span><span class="fu">gt</span>(diffThreshold)<span class="op">.</span><span class="fu">rename</span>(<span class="st">&#39;water&#39;</span>)<span class="op">.</span><span class="fu">selfMask</span>()<span class="op">;</span></span>
<span id="cb70-40"><a href="#cb70-40" tabindex="-1"></a></span>
<span id="cb70-41"><a href="#cb70-41" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">centerObject</span>(geometry<span class="op">,</span> <span class="dv">10</span>)</span>
<span id="cb70-42"><a href="#cb70-42" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(before<span class="op">,</span> {<span class="dt">min</span><span class="op">:-</span><span class="dv">25</span><span class="op">,</span><span class="dt">max</span><span class="op">:</span><span class="dv">0</span>}<span class="op">,</span> <span class="st">&#39;Before Floods&#39;</span><span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span></span>
<span id="cb70-43"><a href="#cb70-43" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(after<span class="op">,</span> {<span class="dt">min</span><span class="op">:-</span><span class="dv">25</span><span class="op">,</span><span class="dt">max</span><span class="op">:</span><span class="dv">0</span>}<span class="op">,</span> <span class="st">&#39;After Floods&#39;</span><span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span> </span>
<span id="cb70-44"><a href="#cb70-44" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(beforeFiltered<span class="op">,</span> {<span class="dt">min</span><span class="op">:-</span><span class="dv">25</span><span class="op">,</span><span class="dt">max</span><span class="op">:</span><span class="dv">0</span>}<span class="op">,</span> <span class="st">&#39;Before Filtered&#39;</span><span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span></span>
<span id="cb70-45"><a href="#cb70-45" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(afterFiltered<span class="op">,</span> {<span class="dt">min</span><span class="op">:-</span><span class="dv">25</span><span class="op">,</span><span class="dt">max</span><span class="op">:</span><span class="dv">0</span>}<span class="op">,</span> <span class="st">&#39;After Filtered&#39;</span><span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span> </span>
<span id="cb70-46"><a href="#cb70-46" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(flooded<span class="op">,</span> {<span class="dt">min</span><span class="op">:</span><span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span><span class="dv">1</span><span class="op">,</span> <span class="dt">palette</span><span class="op">:</span> [<span class="st">&#39;orange&#39;</span>]}<span class="op">,</span> <span class="st">&#39;Initial Flood Area&#39;</span><span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span></span>
<span id="cb70-47"><a href="#cb70-47" tabindex="-1"></a></span>
<span id="cb70-48"><a href="#cb70-48" tabindex="-1"></a><span class="co">// Mask out area with permanent/semi-permanent water</span></span>
<span id="cb70-49"><a href="#cb70-49" tabindex="-1"></a><span class="kw">var</span> permanentWater <span class="op">=</span> gsw<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;seasonality&#39;</span>)<span class="op">.</span><span class="fu">gte</span>(<span class="dv">5</span>)<span class="op">.</span><span class="fu">clip</span>(geometry)</span>
<span id="cb70-50"><a href="#cb70-50" tabindex="-1"></a><span class="kw">var</span> permanentWaterMask <span class="op">=</span> permanentWater<span class="op">.</span><span class="fu">unmask</span>(<span class="dv">0</span>)<span class="op">.</span><span class="fu">not</span>()</span>
<span id="cb70-51"><a href="#cb70-51" tabindex="-1"></a><span class="kw">var</span> flooded <span class="op">=</span> flooded<span class="op">.</span><span class="fu">updateMask</span>(permanentWaterMask)</span>
<span id="cb70-52"><a href="#cb70-52" tabindex="-1"></a></span>
<span id="cb70-53"><a href="#cb70-53" tabindex="-1"></a><span class="co">// Mask out areas with more than 5 percent slope using the HydroSHEDS DEM</span></span>
<span id="cb70-54"><a href="#cb70-54" tabindex="-1"></a><span class="kw">var</span> slopeThreshold <span class="op">=</span> <span class="dv">5</span><span class="op">;</span></span>
<span id="cb70-55"><a href="#cb70-55" tabindex="-1"></a><span class="kw">var</span> terrain <span class="op">=</span> ee<span class="op">.</span><span class="at">Algorithms</span><span class="op">.</span><span class="fu">Terrain</span>(hydrosheds)<span class="op">;</span></span>
<span id="cb70-56"><a href="#cb70-56" tabindex="-1"></a><span class="kw">var</span> slope <span class="op">=</span> terrain<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;slope&#39;</span>)<span class="op">;</span></span>
<span id="cb70-57"><a href="#cb70-57" tabindex="-1"></a><span class="kw">var</span> steepAreas <span class="op">=</span> slope<span class="op">.</span><span class="fu">gt</span>(slopeThreshold)</span>
<span id="cb70-58"><a href="#cb70-58" tabindex="-1"></a><span class="kw">var</span> slopeMask <span class="op">=</span> steepAreas<span class="op">.</span><span class="fu">not</span>()</span>
<span id="cb70-59"><a href="#cb70-59" tabindex="-1"></a><span class="kw">var</span> flooded <span class="op">=</span> flooded<span class="op">.</span><span class="fu">updateMask</span>(slopeMask)</span>
<span id="cb70-60"><a href="#cb70-60" tabindex="-1"></a></span>
<span id="cb70-61"><a href="#cb70-61" tabindex="-1"></a><span class="co">// Remove isolated pixels</span></span>
<span id="cb70-62"><a href="#cb70-62" tabindex="-1"></a><span class="co">// connectedPixelCount is Zoom dependent, so visual result will vary</span></span>
<span id="cb70-63"><a href="#cb70-63" tabindex="-1"></a><span class="kw">var</span> connectedPixelThreshold <span class="op">=</span> <span class="dv">8</span><span class="op">;</span></span>
<span id="cb70-64"><a href="#cb70-64" tabindex="-1"></a><span class="kw">var</span> connections <span class="op">=</span> flooded<span class="op">.</span><span class="fu">connectedPixelCount</span>(<span class="dv">25</span>)</span>
<span id="cb70-65"><a href="#cb70-65" tabindex="-1"></a><span class="kw">var</span> disconnectedAreas <span class="op">=</span> connections<span class="op">.</span><span class="fu">lt</span>(connectedPixelThreshold)</span>
<span id="cb70-66"><a href="#cb70-66" tabindex="-1"></a><span class="kw">var</span> disconnectedAreasMask <span class="op">=</span> disconnectedAreas<span class="op">.</span><span class="fu">not</span>()</span>
<span id="cb70-67"><a href="#cb70-67" tabindex="-1"></a><span class="kw">var</span> flooded <span class="op">=</span> flooded<span class="op">.</span><span class="fu">updateMask</span>(disconnectedAreasMask)</span>
<span id="cb70-68"><a href="#cb70-68" tabindex="-1"></a></span>
<span id="cb70-69"><a href="#cb70-69" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(flooded<span class="op">,</span> {<span class="dt">min</span><span class="op">:</span><span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span><span class="dv">1</span><span class="op">,</span> <span class="dt">palette</span><span class="op">:</span> [<span class="st">&#39;red&#39;</span>]}<span class="op">,</span> <span class="st">&#39;Flooded Areas&#39;</span>)<span class="op">;</span></span>
<span id="cb70-70"><a href="#cb70-70" tabindex="-1"></a></span>
<span id="cb70-71"><a href="#cb70-71" tabindex="-1"></a><span class="co">// Calculate Affected Area</span></span>
<span id="cb70-72"><a href="#cb70-72" tabindex="-1"></a><span class="fu">print</span>(<span class="st">&#39;Total District Area (Ha)&#39;</span><span class="op">,</span> geometry<span class="op">.</span><span class="fu">area</span>()<span class="op">.</span><span class="fu">divide</span>(<span class="dv">10000</span>))</span>
<span id="cb70-73"><a href="#cb70-73" tabindex="-1"></a></span>
<span id="cb70-74"><a href="#cb70-74" tabindex="-1"></a><span class="kw">var</span> stats <span class="op">=</span> flooded<span class="op">.</span><span class="fu">multiply</span>(ee<span class="op">.</span><span class="at">Image</span><span class="op">.</span><span class="fu">pixelArea</span>())<span class="op">.</span><span class="fu">reduceRegion</span>({</span>
<span id="cb70-75"><a href="#cb70-75" tabindex="-1"></a>  <span class="dt">reducer</span><span class="op">:</span> ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">sum</span>()<span class="op">,</span></span>
<span id="cb70-76"><a href="#cb70-76" tabindex="-1"></a>  <span class="dt">geometry</span><span class="op">:</span> geometry<span class="op">,</span></span>
<span id="cb70-77"><a href="#cb70-77" tabindex="-1"></a>  <span class="dt">scale</span><span class="op">:</span> <span class="dv">10</span><span class="op">,</span></span>
<span id="cb70-78"><a href="#cb70-78" tabindex="-1"></a>  <span class="dt">maxPixels</span><span class="op">:</span> <span class="fl">1e10</span><span class="op">,</span></span>
<span id="cb70-79"><a href="#cb70-79" tabindex="-1"></a>  <span class="dt">tileScale</span><span class="op">:</span> <span class="dv">16</span></span>
<span id="cb70-80"><a href="#cb70-80" tabindex="-1"></a>})</span>
<span id="cb70-81"><a href="#cb70-81" tabindex="-1"></a><span class="fu">print</span>(<span class="st">&#39;Flooded Area (Ha)&#39;</span><span class="op">,</span> ee<span class="op">.</span><span class="fu">Number</span>(stats<span class="op">.</span><span class="fu">get</span>(<span class="st">&#39;water&#39;</span>))<span class="op">.</span><span class="fu">divide</span>(<span class="dv">10000</span>))</span>
<span id="cb70-82"><a href="#cb70-82" tabindex="-1"></a></span>
<span id="cb70-83"><a href="#cb70-83" tabindex="-1"></a><span class="co">//############################</span></span>
<span id="cb70-84"><a href="#cb70-84" tabindex="-1"></a><span class="co">// Speckle Filtering Functions</span></span>
<span id="cb70-85"><a href="#cb70-85" tabindex="-1"></a><span class="co">//############################</span></span>
<span id="cb70-86"><a href="#cb70-86" tabindex="-1"></a></span>
<span id="cb70-87"><a href="#cb70-87" tabindex="-1"></a><span class="co">// Function to convert from dB</span></span>
<span id="cb70-88"><a href="#cb70-88" tabindex="-1"></a><span class="kw">function</span> <span class="fu">toNatural</span>(img) {</span>
<span id="cb70-89"><a href="#cb70-89" tabindex="-1"></a>  <span class="cf">return</span> ee<span class="op">.</span><span class="fu">Image</span>(<span class="fl">10.0</span>)<span class="op">.</span><span class="fu">pow</span>(img<span class="op">.</span><span class="fu">select</span>(<span class="dv">0</span>)<span class="op">.</span><span class="fu">divide</span>(<span class="fl">10.0</span>))<span class="op">;</span></span>
<span id="cb70-90"><a href="#cb70-90" tabindex="-1"></a>}</span>
<span id="cb70-91"><a href="#cb70-91" tabindex="-1"></a></span>
<span id="cb70-92"><a href="#cb70-92" tabindex="-1"></a><span class="co">//Function to convert to dB</span></span>
<span id="cb70-93"><a href="#cb70-93" tabindex="-1"></a><span class="kw">function</span> <span class="fu">toDB</span>(img) {</span>
<span id="cb70-94"><a href="#cb70-94" tabindex="-1"></a>  <span class="cf">return</span> ee<span class="op">.</span><span class="fu">Image</span>(img)<span class="op">.</span><span class="fu">log10</span>()<span class="op">.</span><span class="fu">multiply</span>(<span class="fl">10.0</span>)<span class="op">;</span></span>
<span id="cb70-95"><a href="#cb70-95" tabindex="-1"></a>}</span>
<span id="cb70-96"><a href="#cb70-96" tabindex="-1"></a></span>
<span id="cb70-97"><a href="#cb70-97" tabindex="-1"></a><span class="co">//Apllying a Refined Lee Speckle filter as coded in the SNAP 3.0 S1TBX:</span></span>
<span id="cb70-98"><a href="#cb70-98" tabindex="-1"></a></span>
<span id="cb70-99"><a href="#cb70-99" tabindex="-1"></a><span class="co">//https://github.com/senbox-org/s1tbx/blob/master/s1tbx-op-sar-processing/src/main/java/org/esa/s1tbx/sar/gpf/filtering/SpeckleFilters/RefinedLee.java</span></span>
<span id="cb70-100"><a href="#cb70-100" tabindex="-1"></a><span class="co">//Adapted by Guido Lemoine</span></span>
<span id="cb70-101"><a href="#cb70-101" tabindex="-1"></a></span>
<span id="cb70-102"><a href="#cb70-102" tabindex="-1"></a><span class="co">// by Guido Lemoine</span></span>
<span id="cb70-103"><a href="#cb70-103" tabindex="-1"></a><span class="kw">function</span> <span class="fu">RefinedLee</span>(img) {</span>
<span id="cb70-104"><a href="#cb70-104" tabindex="-1"></a>  <span class="co">// img must be in natural units, i.e. not in dB!</span></span>
<span id="cb70-105"><a href="#cb70-105" tabindex="-1"></a>  <span class="co">// Set up 3x3 kernels </span></span>
<span id="cb70-106"><a href="#cb70-106" tabindex="-1"></a>  <span class="kw">var</span> weights3 <span class="op">=</span> ee<span class="op">.</span><span class="at">List</span><span class="op">.</span><span class="fu">repeat</span>(ee<span class="op">.</span><span class="at">List</span><span class="op">.</span><span class="fu">repeat</span>(<span class="dv">1</span><span class="op">,</span><span class="dv">3</span>)<span class="op">,</span><span class="dv">3</span>)<span class="op">;</span></span>
<span id="cb70-107"><a href="#cb70-107" tabindex="-1"></a>  <span class="kw">var</span> kernel3 <span class="op">=</span> ee<span class="op">.</span><span class="at">Kernel</span><span class="op">.</span><span class="fu">fixed</span>(<span class="dv">3</span><span class="op">,</span><span class="dv">3</span><span class="op">,</span> weights3<span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span></span>
<span id="cb70-108"><a href="#cb70-108" tabindex="-1"></a></span>
<span id="cb70-109"><a href="#cb70-109" tabindex="-1"></a>  <span class="kw">var</span> mean3 <span class="op">=</span> img<span class="op">.</span><span class="fu">reduceNeighborhood</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">mean</span>()<span class="op">,</span> kernel3)<span class="op">;</span></span>
<span id="cb70-110"><a href="#cb70-110" tabindex="-1"></a>  <span class="kw">var</span> variance3 <span class="op">=</span> img<span class="op">.</span><span class="fu">reduceNeighborhood</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">variance</span>()<span class="op">,</span> kernel3)<span class="op">;</span></span>
<span id="cb70-111"><a href="#cb70-111" tabindex="-1"></a></span>
<span id="cb70-112"><a href="#cb70-112" tabindex="-1"></a>  <span class="co">// Use a sample of the 3x3 windows inside a 7x7 windows to determine gradients and directions</span></span>
<span id="cb70-113"><a href="#cb70-113" tabindex="-1"></a>  <span class="kw">var</span> sample_weights <span class="op">=</span> ee<span class="op">.</span><span class="fu">List</span>([[<span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span>]<span class="op">,</span> [<span class="dv">0</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span>]<span class="op">,</span>[<span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span>]<span class="op">,</span> [<span class="dv">0</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span>]<span class="op">,</span> [<span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span>]<span class="op">,</span> [<span class="dv">0</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span>]<span class="op">,</span>[<span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span>]])<span class="op">;</span></span>
<span id="cb70-114"><a href="#cb70-114" tabindex="-1"></a></span>
<span id="cb70-115"><a href="#cb70-115" tabindex="-1"></a>  <span class="kw">var</span> sample_kernel <span class="op">=</span> ee<span class="op">.</span><span class="at">Kernel</span><span class="op">.</span><span class="fu">fixed</span>(<span class="dv">7</span><span class="op">,</span><span class="dv">7</span><span class="op">,</span> sample_weights<span class="op">,</span> <span class="dv">3</span><span class="op">,</span><span class="dv">3</span><span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span></span>
<span id="cb70-116"><a href="#cb70-116" tabindex="-1"></a></span>
<span id="cb70-117"><a href="#cb70-117" tabindex="-1"></a>  <span class="co">// Calculate mean and variance for the sampled windows and store as 9 bands</span></span>
<span id="cb70-118"><a href="#cb70-118" tabindex="-1"></a>  <span class="kw">var</span> sample_mean <span class="op">=</span> mean3<span class="op">.</span><span class="fu">neighborhoodToBands</span>(sample_kernel)<span class="op">;</span> </span>
<span id="cb70-119"><a href="#cb70-119" tabindex="-1"></a>  <span class="kw">var</span> sample_var <span class="op">=</span> variance3<span class="op">.</span><span class="fu">neighborhoodToBands</span>(sample_kernel)<span class="op">;</span></span>
<span id="cb70-120"><a href="#cb70-120" tabindex="-1"></a></span>
<span id="cb70-121"><a href="#cb70-121" tabindex="-1"></a>  <span class="co">// Determine the 4 gradients for the sampled windows</span></span>
<span id="cb70-122"><a href="#cb70-122" tabindex="-1"></a>  <span class="kw">var</span> gradients <span class="op">=</span> sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">1</span>)<span class="op">.</span><span class="fu">subtract</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">7</span>))<span class="op">.</span><span class="fu">abs</span>()<span class="op">;</span></span>
<span id="cb70-123"><a href="#cb70-123" tabindex="-1"></a>  gradients <span class="op">=</span> gradients<span class="op">.</span><span class="fu">addBands</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">6</span>)<span class="op">.</span><span class="fu">subtract</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">2</span>))<span class="op">.</span><span class="fu">abs</span>())<span class="op">;</span></span>
<span id="cb70-124"><a href="#cb70-124" tabindex="-1"></a>  gradients <span class="op">=</span> gradients<span class="op">.</span><span class="fu">addBands</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">3</span>)<span class="op">.</span><span class="fu">subtract</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">5</span>))<span class="op">.</span><span class="fu">abs</span>())<span class="op">;</span></span>
<span id="cb70-125"><a href="#cb70-125" tabindex="-1"></a>  gradients <span class="op">=</span> gradients<span class="op">.</span><span class="fu">addBands</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">0</span>)<span class="op">.</span><span class="fu">subtract</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">8</span>))<span class="op">.</span><span class="fu">abs</span>())<span class="op">;</span></span>
<span id="cb70-126"><a href="#cb70-126" tabindex="-1"></a></span>
<span id="cb70-127"><a href="#cb70-127" tabindex="-1"></a>  <span class="co">// And find the maximum gradient amongst gradient bands</span></span>
<span id="cb70-128"><a href="#cb70-128" tabindex="-1"></a>  <span class="kw">var</span> max_gradient <span class="op">=</span> gradients<span class="op">.</span><span class="fu">reduce</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">max</span>())<span class="op">;</span></span>
<span id="cb70-129"><a href="#cb70-129" tabindex="-1"></a></span>
<span id="cb70-130"><a href="#cb70-130" tabindex="-1"></a>  <span class="co">// Create a mask for band pixels that are the maximum gradient</span></span>
<span id="cb70-131"><a href="#cb70-131" tabindex="-1"></a>  <span class="kw">var</span> gradmask <span class="op">=</span> gradients<span class="op">.</span><span class="fu">eq</span>(max_gradient)<span class="op">;</span></span>
<span id="cb70-132"><a href="#cb70-132" tabindex="-1"></a></span>
<span id="cb70-133"><a href="#cb70-133" tabindex="-1"></a>  <span class="co">// duplicate gradmask bands: each gradient represents 2 directions</span></span>
<span id="cb70-134"><a href="#cb70-134" tabindex="-1"></a>  gradmask <span class="op">=</span> gradmask<span class="op">.</span><span class="fu">addBands</span>(gradmask)<span class="op">;</span></span>
<span id="cb70-135"><a href="#cb70-135" tabindex="-1"></a></span>
<span id="cb70-136"><a href="#cb70-136" tabindex="-1"></a>  <span class="co">// Determine the 8 directions</span></span>
<span id="cb70-137"><a href="#cb70-137" tabindex="-1"></a>  <span class="kw">var</span> directions <span class="op">=</span> sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">1</span>)<span class="op">.</span><span class="fu">subtract</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">4</span>))<span class="op">.</span><span class="fu">gt</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">4</span>)<span class="op">.</span><span class="fu">subtract</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">7</span>)))<span class="op">.</span><span class="fu">multiply</span>(<span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb70-138"><a href="#cb70-138" tabindex="-1"></a>  directions <span class="op">=</span> directions<span class="op">.</span><span class="fu">addBands</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">6</span>)<span class="op">.</span><span class="fu">subtract</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">4</span>))<span class="op">.</span><span class="fu">gt</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">4</span>)<span class="op">.</span><span class="fu">subtract</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">2</span>)))<span class="op">.</span><span class="fu">multiply</span>(<span class="dv">2</span>))<span class="op">;</span></span>
<span id="cb70-139"><a href="#cb70-139" tabindex="-1"></a>  directions <span class="op">=</span> directions<span class="op">.</span><span class="fu">addBands</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">3</span>)<span class="op">.</span><span class="fu">subtract</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">4</span>))<span class="op">.</span><span class="fu">gt</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">4</span>)<span class="op">.</span><span class="fu">subtract</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">5</span>)))<span class="op">.</span><span class="fu">multiply</span>(<span class="dv">3</span>))<span class="op">;</span></span>
<span id="cb70-140"><a href="#cb70-140" tabindex="-1"></a>  directions <span class="op">=</span> directions<span class="op">.</span><span class="fu">addBands</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">0</span>)<span class="op">.</span><span class="fu">subtract</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">4</span>))<span class="op">.</span><span class="fu">gt</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">4</span>)<span class="op">.</span><span class="fu">subtract</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">8</span>)))<span class="op">.</span><span class="fu">multiply</span>(<span class="dv">4</span>))<span class="op">;</span></span>
<span id="cb70-141"><a href="#cb70-141" tabindex="-1"></a>  <span class="co">// The next 4 are the not() of the previous 4</span></span>
<span id="cb70-142"><a href="#cb70-142" tabindex="-1"></a>  directions <span class="op">=</span> directions<span class="op">.</span><span class="fu">addBands</span>(directions<span class="op">.</span><span class="fu">select</span>(<span class="dv">0</span>)<span class="op">.</span><span class="fu">not</span>()<span class="op">.</span><span class="fu">multiply</span>(<span class="dv">5</span>))<span class="op">;</span></span>
<span id="cb70-143"><a href="#cb70-143" tabindex="-1"></a>  directions <span class="op">=</span> directions<span class="op">.</span><span class="fu">addBands</span>(directions<span class="op">.</span><span class="fu">select</span>(<span class="dv">1</span>)<span class="op">.</span><span class="fu">not</span>()<span class="op">.</span><span class="fu">multiply</span>(<span class="dv">6</span>))<span class="op">;</span></span>
<span id="cb70-144"><a href="#cb70-144" tabindex="-1"></a>  directions <span class="op">=</span> directions<span class="op">.</span><span class="fu">addBands</span>(directions<span class="op">.</span><span class="fu">select</span>(<span class="dv">2</span>)<span class="op">.</span><span class="fu">not</span>()<span class="op">.</span><span class="fu">multiply</span>(<span class="dv">7</span>))<span class="op">;</span></span>
<span id="cb70-145"><a href="#cb70-145" tabindex="-1"></a>  directions <span class="op">=</span> directions<span class="op">.</span><span class="fu">addBands</span>(directions<span class="op">.</span><span class="fu">select</span>(<span class="dv">3</span>)<span class="op">.</span><span class="fu">not</span>()<span class="op">.</span><span class="fu">multiply</span>(<span class="dv">8</span>))<span class="op">;</span></span>
<span id="cb70-146"><a href="#cb70-146" tabindex="-1"></a></span>
<span id="cb70-147"><a href="#cb70-147" tabindex="-1"></a>  <span class="co">// Mask all values that are not 1-8</span></span>
<span id="cb70-148"><a href="#cb70-148" tabindex="-1"></a>  directions <span class="op">=</span> directions<span class="op">.</span><span class="fu">updateMask</span>(gradmask)<span class="op">;</span></span>
<span id="cb70-149"><a href="#cb70-149" tabindex="-1"></a></span>
<span id="cb70-150"><a href="#cb70-150" tabindex="-1"></a>  <span class="co">// &quot;collapse&quot; the stack into a singe band image (due to masking, each pixel has just one value (1-8) in it&#39;s directional band, and is otherwise masked)</span></span>
<span id="cb70-151"><a href="#cb70-151" tabindex="-1"></a>  directions <span class="op">=</span> directions<span class="op">.</span><span class="fu">reduce</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">sum</span>())<span class="op">;</span>  </span>
<span id="cb70-152"><a href="#cb70-152" tabindex="-1"></a></span>
<span id="cb70-153"><a href="#cb70-153" tabindex="-1"></a>  <span class="co">//var pal = [&#39;ffffff&#39;,&#39;ff0000&#39;,&#39;ffff00&#39;, &#39;00ff00&#39;, &#39;00ffff&#39;, &#39;0000ff&#39;, &#39;ff00ff&#39;, &#39;000000&#39;];</span></span>
<span id="cb70-154"><a href="#cb70-154" tabindex="-1"></a>  <span class="co">//Map.addLayer(directions.reduce(ee.Reducer.sum()), {min:1, max:8, palette: pal}, &#39;Directions&#39;, false);</span></span>
<span id="cb70-155"><a href="#cb70-155" tabindex="-1"></a></span>
<span id="cb70-156"><a href="#cb70-156" tabindex="-1"></a>  <span class="kw">var</span> sample_stats <span class="op">=</span> sample_var<span class="op">.</span><span class="fu">divide</span>(sample_mean<span class="op">.</span><span class="fu">multiply</span>(sample_mean))<span class="op">;</span></span>
<span id="cb70-157"><a href="#cb70-157" tabindex="-1"></a></span>
<span id="cb70-158"><a href="#cb70-158" tabindex="-1"></a>  <span class="co">// Calculate localNoiseVariance</span></span>
<span id="cb70-159"><a href="#cb70-159" tabindex="-1"></a>  <span class="kw">var</span> sigmaV <span class="op">=</span> sample_stats<span class="op">.</span><span class="fu">toArray</span>()<span class="op">.</span><span class="fu">arraySort</span>()<span class="op">.</span><span class="fu">arraySlice</span>(<span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">5</span>)<span class="op">.</span><span class="fu">arrayReduce</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">mean</span>()<span class="op">,</span> [<span class="dv">0</span>])<span class="op">;</span></span>
<span id="cb70-160"><a href="#cb70-160" tabindex="-1"></a></span>
<span id="cb70-161"><a href="#cb70-161" tabindex="-1"></a>  <span class="co">// Set up the 7*7 kernels for directional statistics</span></span>
<span id="cb70-162"><a href="#cb70-162" tabindex="-1"></a>  <span class="kw">var</span> rect_weights <span class="op">=</span> ee<span class="op">.</span><span class="at">List</span><span class="op">.</span><span class="fu">repeat</span>(ee<span class="op">.</span><span class="at">List</span><span class="op">.</span><span class="fu">repeat</span>(<span class="dv">0</span><span class="op">,</span><span class="dv">7</span>)<span class="op">,</span><span class="dv">3</span>)<span class="op">.</span><span class="fu">cat</span>(ee<span class="op">.</span><span class="at">List</span><span class="op">.</span><span class="fu">repeat</span>(ee<span class="op">.</span><span class="at">List</span><span class="op">.</span><span class="fu">repeat</span>(<span class="dv">1</span><span class="op">,</span><span class="dv">7</span>)<span class="op">,</span><span class="dv">4</span>))<span class="op">;</span></span>
<span id="cb70-163"><a href="#cb70-163" tabindex="-1"></a></span>
<span id="cb70-164"><a href="#cb70-164" tabindex="-1"></a>  <span class="kw">var</span> diag_weights <span class="op">=</span> ee<span class="op">.</span><span class="fu">List</span>([[<span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span>]<span class="op">,</span> [<span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span>]<span class="op">,</span> [<span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span>]<span class="op">,</span> </span>
<span id="cb70-165"><a href="#cb70-165" tabindex="-1"></a>    [<span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span>]<span class="op">,</span> [<span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span>]<span class="op">,</span> [<span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span>]<span class="op">,</span> [<span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span>]])<span class="op">;</span></span>
<span id="cb70-166"><a href="#cb70-166" tabindex="-1"></a></span>
<span id="cb70-167"><a href="#cb70-167" tabindex="-1"></a>  <span class="kw">var</span> rect_kernel <span class="op">=</span> ee<span class="op">.</span><span class="at">Kernel</span><span class="op">.</span><span class="fu">fixed</span>(<span class="dv">7</span><span class="op">,</span><span class="dv">7</span><span class="op">,</span> rect_weights<span class="op">,</span> <span class="dv">3</span><span class="op">,</span> <span class="dv">3</span><span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span></span>
<span id="cb70-168"><a href="#cb70-168" tabindex="-1"></a>  <span class="kw">var</span> diag_kernel <span class="op">=</span> ee<span class="op">.</span><span class="at">Kernel</span><span class="op">.</span><span class="fu">fixed</span>(<span class="dv">7</span><span class="op">,</span><span class="dv">7</span><span class="op">,</span> diag_weights<span class="op">,</span> <span class="dv">3</span><span class="op">,</span> <span class="dv">3</span><span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span></span>
<span id="cb70-169"><a href="#cb70-169" tabindex="-1"></a></span>
<span id="cb70-170"><a href="#cb70-170" tabindex="-1"></a>  <span class="co">// Create stacks for mean and variance using the original kernels. Mask with relevant direction.</span></span>
<span id="cb70-171"><a href="#cb70-171" tabindex="-1"></a>  <span class="kw">var</span> dir_mean <span class="op">=</span> img<span class="op">.</span><span class="fu">reduceNeighborhood</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">mean</span>()<span class="op">,</span> rect_kernel)<span class="op">.</span><span class="fu">updateMask</span>(directions<span class="op">.</span><span class="fu">eq</span>(<span class="dv">1</span>))<span class="op">;</span></span>
<span id="cb70-172"><a href="#cb70-172" tabindex="-1"></a>  <span class="kw">var</span> dir_var <span class="op">=</span> img<span class="op">.</span><span class="fu">reduceNeighborhood</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">variance</span>()<span class="op">,</span> rect_kernel)<span class="op">.</span><span class="fu">updateMask</span>(directions<span class="op">.</span><span class="fu">eq</span>(<span class="dv">1</span>))<span class="op">;</span></span>
<span id="cb70-173"><a href="#cb70-173" tabindex="-1"></a></span>
<span id="cb70-174"><a href="#cb70-174" tabindex="-1"></a>  dir_mean <span class="op">=</span> dir_mean<span class="op">.</span><span class="fu">addBands</span>(img<span class="op">.</span><span class="fu">reduceNeighborhood</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">mean</span>()<span class="op">,</span> diag_kernel)<span class="op">.</span><span class="fu">updateMask</span>(directions<span class="op">.</span><span class="fu">eq</span>(<span class="dv">2</span>)))<span class="op">;</span></span>
<span id="cb70-175"><a href="#cb70-175" tabindex="-1"></a>  dir_var <span class="op">=</span> dir_var<span class="op">.</span><span class="fu">addBands</span>(img<span class="op">.</span><span class="fu">reduceNeighborhood</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">variance</span>()<span class="op">,</span> diag_kernel)<span class="op">.</span><span class="fu">updateMask</span>(directions<span class="op">.</span><span class="fu">eq</span>(<span class="dv">2</span>)))<span class="op">;</span></span>
<span id="cb70-176"><a href="#cb70-176" tabindex="-1"></a></span>
<span id="cb70-177"><a href="#cb70-177" tabindex="-1"></a>  <span class="co">// and add the bands for rotated kernels</span></span>
<span id="cb70-178"><a href="#cb70-178" tabindex="-1"></a>  <span class="cf">for</span> (<span class="kw">var</span> i<span class="op">=</span><span class="dv">1</span><span class="op">;</span> i<span class="op">&lt;</span><span class="dv">4</span><span class="op">;</span> i<span class="op">++</span>) {</span>
<span id="cb70-179"><a href="#cb70-179" tabindex="-1"></a>    dir_mean <span class="op">=</span> dir_mean<span class="op">.</span><span class="fu">addBands</span>(img<span class="op">.</span><span class="fu">reduceNeighborhood</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">mean</span>()<span class="op">,</span> rect_kernel<span class="op">.</span><span class="fu">rotate</span>(i))<span class="op">.</span><span class="fu">updateMask</span>(directions<span class="op">.</span><span class="fu">eq</span>(<span class="dv">2</span><span class="op">*</span>i<span class="op">+</span><span class="dv">1</span>)))<span class="op">;</span></span>
<span id="cb70-180"><a href="#cb70-180" tabindex="-1"></a>    dir_var <span class="op">=</span> dir_var<span class="op">.</span><span class="fu">addBands</span>(img<span class="op">.</span><span class="fu">reduceNeighborhood</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">variance</span>()<span class="op">,</span> rect_kernel<span class="op">.</span><span class="fu">rotate</span>(i))<span class="op">.</span><span class="fu">updateMask</span>(directions<span class="op">.</span><span class="fu">eq</span>(<span class="dv">2</span><span class="op">*</span>i<span class="op">+</span><span class="dv">1</span>)))<span class="op">;</span></span>
<span id="cb70-181"><a href="#cb70-181" tabindex="-1"></a>    dir_mean <span class="op">=</span> dir_mean<span class="op">.</span><span class="fu">addBands</span>(img<span class="op">.</span><span class="fu">reduceNeighborhood</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">mean</span>()<span class="op">,</span> diag_kernel<span class="op">.</span><span class="fu">rotate</span>(i))<span class="op">.</span><span class="fu">updateMask</span>(directions<span class="op">.</span><span class="fu">eq</span>(<span class="dv">2</span><span class="op">*</span>i<span class="op">+</span><span class="dv">2</span>)))<span class="op">;</span></span>
<span id="cb70-182"><a href="#cb70-182" tabindex="-1"></a>    dir_var <span class="op">=</span> dir_var<span class="op">.</span><span class="fu">addBands</span>(img<span class="op">.</span><span class="fu">reduceNeighborhood</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">variance</span>()<span class="op">,</span> diag_kernel<span class="op">.</span><span class="fu">rotate</span>(i))<span class="op">.</span><span class="fu">updateMask</span>(directions<span class="op">.</span><span class="fu">eq</span>(<span class="dv">2</span><span class="op">*</span>i<span class="op">+</span><span class="dv">2</span>)))<span class="op">;</span></span>
<span id="cb70-183"><a href="#cb70-183" tabindex="-1"></a>  }</span>
<span id="cb70-184"><a href="#cb70-184" tabindex="-1"></a></span>
<span id="cb70-185"><a href="#cb70-185" tabindex="-1"></a>  <span class="co">// &quot;collapse&quot; the stack into a single band image (due to masking, each pixel has just one value in it&#39;s directional band, and is otherwise masked)</span></span>
<span id="cb70-186"><a href="#cb70-186" tabindex="-1"></a>  dir_mean <span class="op">=</span> dir_mean<span class="op">.</span><span class="fu">reduce</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">sum</span>())<span class="op">;</span></span>
<span id="cb70-187"><a href="#cb70-187" tabindex="-1"></a>  dir_var <span class="op">=</span> dir_var<span class="op">.</span><span class="fu">reduce</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">sum</span>())<span class="op">;</span></span>
<span id="cb70-188"><a href="#cb70-188" tabindex="-1"></a></span>
<span id="cb70-189"><a href="#cb70-189" tabindex="-1"></a>  <span class="co">// A finally generate the filtered value</span></span>
<span id="cb70-190"><a href="#cb70-190" tabindex="-1"></a>  <span class="kw">var</span> varX <span class="op">=</span> dir_var<span class="op">.</span><span class="fu">subtract</span>(dir_mean<span class="op">.</span><span class="fu">multiply</span>(dir_mean)<span class="op">.</span><span class="fu">multiply</span>(sigmaV))<span class="op">.</span><span class="fu">divide</span>(sigmaV<span class="op">.</span><span class="fu">add</span>(<span class="fl">1.0</span>))<span class="op">;</span></span>
<span id="cb70-191"><a href="#cb70-191" tabindex="-1"></a></span>
<span id="cb70-192"><a href="#cb70-192" tabindex="-1"></a>  <span class="kw">var</span> b <span class="op">=</span> varX<span class="op">.</span><span class="fu">divide</span>(dir_var)<span class="op">;</span></span>
<span id="cb70-193"><a href="#cb70-193" tabindex="-1"></a></span>
<span id="cb70-194"><a href="#cb70-194" tabindex="-1"></a>  <span class="kw">var</span> result <span class="op">=</span> dir_mean<span class="op">.</span><span class="fu">add</span>(b<span class="op">.</span><span class="fu">multiply</span>(img<span class="op">.</span><span class="fu">subtract</span>(dir_mean)))<span class="op">;</span></span>
<span id="cb70-195"><a href="#cb70-195" tabindex="-1"></a>  <span class="cf">return</span>(result<span class="op">.</span><span class="fu">arrayFlatten</span>([[<span class="st">&#39;sum&#39;</span>]]))<span class="op">;</span></span>
<span id="cb70-196"><a href="#cb70-196" tabindex="-1"></a>}</span></code></pre></div>
<div id="exercise-33" class="section level3">
<h3>Exercise</h3>
<p><a
href="https://code.earthengine.google.com/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3A05-Flood_Mapping%2F06c_Calculate_Flooded_Area_(exercise)"
target="_blank">Try in Code Editor ↗</a></p>
<p>Printing the results in the console may timeout for more extensive
computations. Convert the flood area numeric value as Feature Collection
and export the area as a CSV file. The technique to export numeric
values is discussed in <a
href="#exporting-classification-results">Exporting Classified
Result.</a></p>
<div class="sourceCode" id="cb71"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb71-1"><a href="#cb71-1" tabindex="-1"></a><span class="co">// Export the result as a CSV</span></span>
<span id="cb71-2"><a href="#cb71-2" tabindex="-1"></a><span class="co">// Export the fc as a CSV</span></span></code></pre></div>
</div>
</div>
</div>
<div id="module-6-drought-monitoring" class="section level1">
<h1>Module 6: Drought Monitoring</h1>
<p>There are many definitions for drought, depending on the context
used. Monitoring and calculating the impact of drought in large sales is
quite tedious without remote sensing data. In this module, we will learn
how to monitor the impact of meteorological drought on natural
vegetation by implementing the Vegetation Condition Index (VCI) using
the MODIS dataset.</p>
<p><a
href="https://www.youtube.com/watch?v=Kx39XL7BfOA&amp;list=PLppGmFLhQ1HI0YeA5zQHxdNlmxihvBawF&amp;index=82"
target="_blank"><img
src="https://img.youtube.com/vi/Kx39XL7BfOA/mqdefault.jpg"
alt="Start Module 6 Videos" /></a></p>
<p><a
href="https://www.youtube.com/watch?v=Kx39XL7BfOA&amp;list=PLppGmFLhQ1HI0YeA5zQHxdNlmxihvBawF&amp;index=82"
target="_blank">Start Module 6 Videos ↗</a></p>
<p><a
href="https://docs.google.com/presentation/d/1xdq172hcxkcjlHNexxankLRx6q60Py6VepNB3M9nepM/edit?usp=sharing"
target="_blank">View the Presentation ↗</a></p>
<blockquote>
<p>Apart from <em>Hydrological drought</em>, another common drought is
the <em>Metrological drought</em>. To track the meteorological drought,
rainfall deviation should be calculated. To know more about it, visit <a
href="https://www.youtube.com/playlist?list=PLppGmFLhQ1HJ5VhW6BZfhPX6spUcTY7SR">Spatial
Thought YouTube.</a></p>
</blockquote>
<div id="load-modis-ndvi" class="section level2">
<h2>01. Load MODIS NDVI</h2>
<p><a href="https://modis.gsfc.nasa.gov/about/">MODIS Moderate
Resolution Imaging Spectroradiometer</a> has many derived products apart
from the raw imagery captured every day. There are 2 satellite sensors,
Terra and Aqua. The raw images from these satellites are used to produce
different data products categorized as <em>Atmospheric products, Land
products, Cryosphere products,</em> and <em>Ocean Products</em>. We will
use the 16-day composite NDVI data at 250m resolution for this exercise.
Also, MODIS follows a unique naming pattern, which helps identify the
data.</p>
<p>The product which we use in this exercise is
<code>MOD13Q1.061</code>.</p>
<table>
<colgroup>
<col width="9%" />
<col width="90%" />
</colgroup>
<thead>
<tr>
<th align="left">Name</th>
<th align="left">Meaning</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left">MOD</td>
<td align="left">Terra sensor</td>
</tr>
<tr>
<td align="left">13Q1</td>
<td align="left">Vegetation Index at 250m</td>
</tr>
<tr>
<td align="left">061</td>
<td align="left">Version number (<em>use the latest version available at
the time of computation</em>)</td>
</tr>
</tbody>
</table>
<p>Load the <em>Terra Vegetation Indices</em> at 250m resolution and
filter the collection from <em>2010</em> to <em>2020</em>. Each image
has 12 bands, in which <code>NDVI</code> and <code>EVI</code> are the
two vegetation indices bands, other bands contain additional information
about the data at pixel level. NDVI is used to monitor vegetation, but
for very thick vegetation like dense forest, NDVI value will saturate,
and no helpful information can be derived. EVI is used to track and
monitor thick vegetation cover.</p>
<p><a
href="https://code.earthengine.google.co.in/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3A06-Drought_Monitoring%2F01b_Load_MODIS_NDVI_(complete)"
target="_blank">Open in Code Editor ↗</a></p>
<div class="sourceCode" id="cb72"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb72-1"><a href="#cb72-1" tabindex="-1"></a><span class="kw">var</span> modis <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&quot;MODIS/061/MOD13Q1&quot;</span>)<span class="op">;</span></span>
<span id="cb72-2"><a href="#cb72-2" tabindex="-1"></a></span>
<span id="cb72-3"><a href="#cb72-3" tabindex="-1"></a><span class="kw">var</span> startYear <span class="op">=</span> <span class="dv">2010</span></span>
<span id="cb72-4"><a href="#cb72-4" tabindex="-1"></a><span class="kw">var</span> endYear <span class="op">=</span> <span class="dv">2020</span></span>
<span id="cb72-5"><a href="#cb72-5" tabindex="-1"></a><span class="kw">var</span> startDate <span class="op">=</span> ee<span class="op">.</span><span class="at">Date</span><span class="op">.</span><span class="fu">fromYMD</span>(startYear<span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">1</span>)</span>
<span id="cb72-6"><a href="#cb72-6" tabindex="-1"></a><span class="kw">var</span> endDate <span class="op">=</span> ee<span class="op">.</span><span class="at">Date</span><span class="op">.</span><span class="fu">fromYMD</span>(endYear<span class="op">,</span> <span class="dv">12</span><span class="op">,</span> <span class="dv">31</span>)</span>
<span id="cb72-7"><a href="#cb72-7" tabindex="-1"></a><span class="kw">var</span> filtered <span class="op">=</span> modis</span>
<span id="cb72-8"><a href="#cb72-8" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(startDate<span class="op">,</span> endDate))</span>
<span id="cb72-9"><a href="#cb72-9" tabindex="-1"></a></span>
<span id="cb72-10"><a href="#cb72-10" tabindex="-1"></a><span class="kw">var</span> modisNDVI <span class="op">=</span> filtered<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;NDVI&#39;</span>)</span>
<span id="cb72-11"><a href="#cb72-11" tabindex="-1"></a></span>
<span id="cb72-12"><a href="#cb72-12" tabindex="-1"></a><span class="fu">print</span>(modisNDVI)</span></code></pre></div>
<div id="exercise-34" class="section level3">
<h3>Exercise</h3>
<p><a
href="https://code.earthengine.google.co.in/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3A06-Drought_Monitoring%2F01c_Load_MODIS_NDVI_(exercise)"
target="_blank">Try in Code Editor ↗</a></p>
<p>Add the first image to the map be visualizing it using a suitable
color palette.</p>
<div class="figure" style="text-align: center">
<img src="images/gee_water_resources_management/vci_ndvi.png" alt="Visualized MODIS NDVI Image over Australia" width="50%" />
<p class="caption">
Visualized MODIS NDVI Image over Australia
</p>
</div>
<div class="sourceCode" id="cb73"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb73-1"><a href="#cb73-1" tabindex="-1"></a><span class="kw">var</span> modis <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&quot;MODIS/061/MOD13Q1&quot;</span>)<span class="op">;</span></span>
<span id="cb73-2"><a href="#cb73-2" tabindex="-1"></a></span>
<span id="cb73-3"><a href="#cb73-3" tabindex="-1"></a><span class="kw">var</span> startYear <span class="op">=</span> <span class="dv">2010</span></span>
<span id="cb73-4"><a href="#cb73-4" tabindex="-1"></a><span class="kw">var</span> endYear <span class="op">=</span> <span class="dv">2020</span></span>
<span id="cb73-5"><a href="#cb73-5" tabindex="-1"></a><span class="kw">var</span> startDate <span class="op">=</span> ee<span class="op">.</span><span class="at">Date</span><span class="op">.</span><span class="fu">fromYMD</span>(startYear<span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">1</span>)</span>
<span id="cb73-6"><a href="#cb73-6" tabindex="-1"></a><span class="kw">var</span> endDate <span class="op">=</span> ee<span class="op">.</span><span class="at">Date</span><span class="op">.</span><span class="fu">fromYMD</span>(endYear<span class="op">,</span> <span class="dv">12</span><span class="op">,</span> <span class="dv">31</span>)</span>
<span id="cb73-7"><a href="#cb73-7" tabindex="-1"></a><span class="kw">var</span> filtered <span class="op">=</span> modis</span>
<span id="cb73-8"><a href="#cb73-8" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(startDate<span class="op">,</span> endDate))</span>
<span id="cb73-9"><a href="#cb73-9" tabindex="-1"></a></span>
<span id="cb73-10"><a href="#cb73-10" tabindex="-1"></a><span class="kw">var</span> modisNDVI <span class="op">=</span> filtered<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;NDVI&#39;</span>)</span>
<span id="cb73-11"><a href="#cb73-11" tabindex="-1"></a></span>
<span id="cb73-12"><a href="#cb73-12" tabindex="-1"></a><span class="fu">print</span>(modisNDVI)</span>
<span id="cb73-13"><a href="#cb73-13" tabindex="-1"></a></span>
<span id="cb73-14"><a href="#cb73-14" tabindex="-1"></a><span class="co">// Exercise</span></span>
<span id="cb73-15"><a href="#cb73-15" tabindex="-1"></a></span>
<span id="cb73-16"><a href="#cb73-16" tabindex="-1"></a><span class="co">// Extract 1 image from the collection using the .first() function</span></span>
<span id="cb73-17"><a href="#cb73-17" tabindex="-1"></a><span class="kw">var</span> image <span class="op">=</span> modisNDVI<span class="op">.</span><span class="fu">first</span>()</span>
<span id="cb73-18"><a href="#cb73-18" tabindex="-1"></a></span>
<span id="cb73-19"><a href="#cb73-19" tabindex="-1"></a><span class="co">// We want to visualize and add the image to the Map</span></span>
<span id="cb73-20"><a href="#cb73-20" tabindex="-1"></a><span class="co">// Add suitable Visualization Parameters to the function below</span></span>
<span id="cb73-21"><a href="#cb73-21" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(image<span class="op">,</span> {}<span class="op">,</span> <span class="st">&#39;MODIS NDVI&#39;</span>) </span></code></pre></div>
</div>
</div>
<div id="apply-cloud-mask" class="section level2">
<h2>02. Apply Cloud Mask</h2>
<p>Every image has another band <code>Summary QA</code>, and this band
contains pixel-level information about the quality of data. We want to
keep only the pixels with bit values 0 or 1. We will use the
<code>.leftShift()</code> to create the bitmask for selecting good
quality data.</p>
<blockquote>
<p>Bitmasking itself is a complex topic of discussion. Read the blog on
<a
href="https://spatialthoughts.com/2021/08/19/qa-bands-bitmasks-gee/">Working
with QA Bands and Bitmasks</a> to know more about it.</p>
</blockquote>
<p><a
href="https://code.earthengine.google.co.in/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3A06-Drought_Monitoring%2F02b_Apply_Cloud_Mask_(complete)"
target="_blank">Open in Code Editor ↗</a>
<img src="images/gee_water_resources_management/drought_summaryQA.png" width="50%" style="display: block; margin: auto;" /></p>
<div class="sourceCode" id="cb74"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb74-1"><a href="#cb74-1" tabindex="-1"></a><span class="kw">var</span> modis <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&#39;MODIS/061/MOD13Q1&#39;</span>)<span class="op">;</span></span>
<span id="cb74-2"><a href="#cb74-2" tabindex="-1"></a></span>
<span id="cb74-3"><a href="#cb74-3" tabindex="-1"></a><span class="kw">var</span> startYear <span class="op">=</span> <span class="dv">2010</span></span>
<span id="cb74-4"><a href="#cb74-4" tabindex="-1"></a><span class="kw">var</span> endYear <span class="op">=</span> <span class="dv">2020</span></span>
<span id="cb74-5"><a href="#cb74-5" tabindex="-1"></a><span class="kw">var</span> startDate <span class="op">=</span> ee<span class="op">.</span><span class="at">Date</span><span class="op">.</span><span class="fu">fromYMD</span>(startYear<span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">1</span>)</span>
<span id="cb74-6"><a href="#cb74-6" tabindex="-1"></a><span class="kw">var</span> endDate <span class="op">=</span> ee<span class="op">.</span><span class="at">Date</span><span class="op">.</span><span class="fu">fromYMD</span>(endYear<span class="op">,</span> <span class="dv">12</span><span class="op">,</span> <span class="dv">31</span>)</span>
<span id="cb74-7"><a href="#cb74-7" tabindex="-1"></a><span class="kw">var</span> filtered <span class="op">=</span> modis</span>
<span id="cb74-8"><a href="#cb74-8" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(startDate<span class="op">,</span> endDate))</span>
<span id="cb74-9"><a href="#cb74-9" tabindex="-1"></a></span>
<span id="cb74-10"><a href="#cb74-10" tabindex="-1"></a></span>
<span id="cb74-11"><a href="#cb74-11" tabindex="-1"></a><span class="co">// Apply mask to remove low-quality or cloudy pixels</span></span>
<span id="cb74-12"><a href="#cb74-12" tabindex="-1"></a><span class="co">// The data comes with a SummaryQA band</span></span>
<span id="cb74-13"><a href="#cb74-13" tabindex="-1"></a><span class="co">// The values are stored in 2 bits - resulting in 4 possible values</span></span>
<span id="cb74-14"><a href="#cb74-14" tabindex="-1"></a><span class="co">// 0: Good data, use with confidence</span></span>
<span id="cb74-15"><a href="#cb74-15" tabindex="-1"></a><span class="co">// 1: Marginal data, useful but look at detailed QA for more information</span></span>
<span id="cb74-16"><a href="#cb74-16" tabindex="-1"></a><span class="co">// 2: Pixel covered with snow/ice</span></span>
<span id="cb74-17"><a href="#cb74-17" tabindex="-1"></a><span class="co">// 3: Pixel is cloudy</span></span>
<span id="cb74-18"><a href="#cb74-18" tabindex="-1"></a><span class="co">// We want to keep only the pixels with bit values 0 or 1</span></span>
<span id="cb74-19"><a href="#cb74-19" tabindex="-1"></a></span>
<span id="cb74-20"><a href="#cb74-20" tabindex="-1"></a><span class="co">// Learn about bitmasks</span></span>
<span id="cb74-21"><a href="#cb74-21" tabindex="-1"></a><span class="co">// https://spatialthoughts.com/2021/08/19/qa-bands-bitmasks-gee/</span></span>
<span id="cb74-22"><a href="#cb74-22" tabindex="-1"></a><span class="kw">var</span> bitwiseExtract <span class="op">=</span> <span class="kw">function</span>(input<span class="op">,</span> fromBit<span class="op">,</span> toBit) {</span>
<span id="cb74-23"><a href="#cb74-23" tabindex="-1"></a>  <span class="kw">var</span> maskSize <span class="op">=</span> ee<span class="op">.</span><span class="fu">Number</span>(<span class="dv">1</span>)<span class="op">.</span><span class="fu">add</span>(toBit)<span class="op">.</span><span class="fu">subtract</span>(fromBit)</span>
<span id="cb74-24"><a href="#cb74-24" tabindex="-1"></a>  <span class="kw">var</span> mask <span class="op">=</span> ee<span class="op">.</span><span class="fu">Number</span>(<span class="dv">1</span>)<span class="op">.</span><span class="fu">leftShift</span>(maskSize)<span class="op">.</span><span class="fu">subtract</span>(<span class="dv">1</span>)</span>
<span id="cb74-25"><a href="#cb74-25" tabindex="-1"></a>  <span class="cf">return</span> input<span class="op">.</span><span class="fu">rightShift</span>(fromBit)<span class="op">.</span><span class="fu">bitwiseAnd</span>(mask)</span>
<span id="cb74-26"><a href="#cb74-26" tabindex="-1"></a>}</span>
<span id="cb74-27"><a href="#cb74-27" tabindex="-1"></a></span>
<span id="cb74-28"><a href="#cb74-28" tabindex="-1"></a><span class="kw">var</span> maskSnowAndClouds <span class="op">=</span> <span class="kw">function</span>(image) {</span>
<span id="cb74-29"><a href="#cb74-29" tabindex="-1"></a>  <span class="kw">var</span> summaryQa <span class="op">=</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;SummaryQA&#39;</span>)</span>
<span id="cb74-30"><a href="#cb74-30" tabindex="-1"></a>  <span class="co">// Select pixels which are less than or equals to 1 (0 or 1)</span></span>
<span id="cb74-31"><a href="#cb74-31" tabindex="-1"></a>  <span class="kw">var</span> qaMask <span class="op">=</span> <span class="fu">bitwiseExtract</span>(summaryQa<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">1</span>)<span class="op">.</span><span class="fu">lte</span>(<span class="dv">1</span>)</span>
<span id="cb74-32"><a href="#cb74-32" tabindex="-1"></a>  <span class="kw">var</span> maskedImage <span class="op">=</span> image<span class="op">.</span><span class="fu">updateMask</span>(qaMask)</span>
<span id="cb74-33"><a href="#cb74-33" tabindex="-1"></a>  <span class="cf">return</span> maskedImage<span class="op">.</span><span class="fu">copyProperties</span>(image<span class="op">,</span> [<span class="st">&#39;system:index&#39;</span><span class="op">,</span> <span class="st">&#39;system:time_start&#39;</span>])</span>
<span id="cb74-34"><a href="#cb74-34" tabindex="-1"></a>}</span>
<span id="cb74-35"><a href="#cb74-35" tabindex="-1"></a></span>
<span id="cb74-36"><a href="#cb74-36" tabindex="-1"></a><span class="co">// Test the function</span></span>
<span id="cb74-37"><a href="#cb74-37" tabindex="-1"></a><span class="kw">var</span> image <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(filtered<span class="op">.</span><span class="fu">first</span>())</span>
<span id="cb74-38"><a href="#cb74-38" tabindex="-1"></a><span class="kw">var</span> imageMasked <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(<span class="fu">maskSnowAndClouds</span>(image))</span>
<span id="cb74-39"><a href="#cb74-39" tabindex="-1"></a></span>
<span id="cb74-40"><a href="#cb74-40" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(image<span class="op">,</span> {}<span class="op">,</span> <span class="st">&#39;MODIS NDVI&#39;</span>) </span>
<span id="cb74-41"><a href="#cb74-41" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(imageMasked<span class="op">,</span> {}<span class="op">,</span> <span class="st">&#39;MODIS NDVI (Masked)&#39;</span>) </span></code></pre></div>
<div class="figure" style="text-align: center">
<img src="images/gee_water_resources_management/vci_cloudmask.png" alt="Snow/Cloud Masked MODIS NDVI" width="50%" />
<p class="caption">
Snow/Cloud Masked MODIS NDVI
</p>
</div>
<div id="exercise-35" class="section level3">
<h3>Exercise</h3>
<p><a
href="https://code.earthengine.google.co.in/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3A06-Drought_Monitoring%2F02c_Apply_Cloud_Mask_(exercise)"
target="_blank">Try in Code Editor ↗</a></p>
<p>Use the cloud masking function, pass the filtered collection to get
good quality data.</p>
<div class="sourceCode" id="cb75"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb75-1"><a href="#cb75-1" tabindex="-1"></a><span class="co">// Apply cloud mask to all images in the filtered collection</span></span></code></pre></div>
</div>
</div>
<div id="extract-and-scale-ndvi-band" class="section level2">
<h2>03. Extract and Scale NDVI Band</h2>
<p>The <em>NDVI</em> value will be a decimal number ranging between
<code>-2</code> to <code>1</code>. But in GEE, each NDVI pixel value
ranges between <code>-20000</code> to <code>10000</code>. This is done
to use the storage effectively because an integer number will take less
storage when compared to a floating-point number. Hence, each pixel
value is multiplied by <code>10,000</code> and stored as int. Before
using these pixel values for analysis, we can divide each pixel with the
same scale factor as down-scaling to get the original pixel value. We
can find this scale factor information in the data catalog under the
band’s section.</p>
<p>To down-scale each image, we need to pass the image collection into a
function and compute the value for each image. Any computation on the
image will result in a new image with no metadata like
<em>system:timestart</em> of the original image without which timeseries
charting is impossible. So, before returning the image from the
function, we can carry over the required properties using the
<code>.copyProperties()</code> function.</p>
<p><a
href="https://code.earthengine.google.co.in/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3A06-Drought_Monitoring%2F03b_Extract_and_Scale_NDVI_Band_(complete)"
target="_blank">Open in Code Editor ↗</a></p>
<div class="sourceCode" id="cb76"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb76-1"><a href="#cb76-1" tabindex="-1"></a><span class="kw">var</span> modis <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&#39;MODIS/061/MOD13Q1&#39;</span>)<span class="op">;</span></span>
<span id="cb76-2"><a href="#cb76-2" tabindex="-1"></a></span>
<span id="cb76-3"><a href="#cb76-3" tabindex="-1"></a><span class="kw">var</span> startYear <span class="op">=</span> <span class="dv">2010</span></span>
<span id="cb76-4"><a href="#cb76-4" tabindex="-1"></a><span class="kw">var</span> endYear <span class="op">=</span> <span class="dv">2020</span></span>
<span id="cb76-5"><a href="#cb76-5" tabindex="-1"></a><span class="kw">var</span> startDate <span class="op">=</span> ee<span class="op">.</span><span class="at">Date</span><span class="op">.</span><span class="fu">fromYMD</span>(startYear<span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">1</span>)</span>
<span id="cb76-6"><a href="#cb76-6" tabindex="-1"></a><span class="kw">var</span> endDate <span class="op">=</span> ee<span class="op">.</span><span class="at">Date</span><span class="op">.</span><span class="fu">fromYMD</span>(endYear<span class="op">,</span> <span class="dv">12</span><span class="op">,</span> <span class="dv">31</span>)</span>
<span id="cb76-7"><a href="#cb76-7" tabindex="-1"></a><span class="kw">var</span> filtered <span class="op">=</span> modis</span>
<span id="cb76-8"><a href="#cb76-8" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(startDate<span class="op">,</span> endDate))</span>
<span id="cb76-9"><a href="#cb76-9" tabindex="-1"></a></span>
<span id="cb76-10"><a href="#cb76-10" tabindex="-1"></a><span class="co">// Cloud Masking</span></span>
<span id="cb76-11"><a href="#cb76-11" tabindex="-1"></a><span class="kw">var</span> bitwiseExtract <span class="op">=</span> <span class="kw">function</span>(input<span class="op">,</span> fromBit<span class="op">,</span> toBit) {</span>
<span id="cb76-12"><a href="#cb76-12" tabindex="-1"></a>  <span class="kw">var</span> maskSize <span class="op">=</span> ee<span class="op">.</span><span class="fu">Number</span>(<span class="dv">1</span>)<span class="op">.</span><span class="fu">add</span>(toBit)<span class="op">.</span><span class="fu">subtract</span>(fromBit)</span>
<span id="cb76-13"><a href="#cb76-13" tabindex="-1"></a>  <span class="kw">var</span> mask <span class="op">=</span> ee<span class="op">.</span><span class="fu">Number</span>(<span class="dv">1</span>)<span class="op">.</span><span class="fu">leftShift</span>(maskSize)<span class="op">.</span><span class="fu">subtract</span>(<span class="dv">1</span>)</span>
<span id="cb76-14"><a href="#cb76-14" tabindex="-1"></a>  <span class="cf">return</span> input<span class="op">.</span><span class="fu">rightShift</span>(fromBit)<span class="op">.</span><span class="fu">bitwiseAnd</span>(mask)</span>
<span id="cb76-15"><a href="#cb76-15" tabindex="-1"></a>}</span>
<span id="cb76-16"><a href="#cb76-16" tabindex="-1"></a></span>
<span id="cb76-17"><a href="#cb76-17" tabindex="-1"></a><span class="kw">var</span> maskSnowAndClouds <span class="op">=</span> <span class="kw">function</span>(image) {</span>
<span id="cb76-18"><a href="#cb76-18" tabindex="-1"></a>  <span class="kw">var</span> summaryQa <span class="op">=</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;SummaryQA&#39;</span>)</span>
<span id="cb76-19"><a href="#cb76-19" tabindex="-1"></a>  <span class="co">// Select pixels which are less than or equals to 1 (0 or 1)</span></span>
<span id="cb76-20"><a href="#cb76-20" tabindex="-1"></a>  <span class="kw">var</span> qaMask <span class="op">=</span> <span class="fu">bitwiseExtract</span>(summaryQa<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">1</span>)<span class="op">.</span><span class="fu">lte</span>(<span class="dv">1</span>)</span>
<span id="cb76-21"><a href="#cb76-21" tabindex="-1"></a>  <span class="kw">var</span> maskedImage <span class="op">=</span> image<span class="op">.</span><span class="fu">updateMask</span>(qaMask)</span>
<span id="cb76-22"><a href="#cb76-22" tabindex="-1"></a>  <span class="cf">return</span> maskedImage<span class="op">.</span><span class="fu">copyProperties</span>(image<span class="op">,</span> [<span class="st">&#39;system:index&#39;</span><span class="op">,</span> <span class="st">&#39;system:time_start&#39;</span>])</span>
<span id="cb76-23"><a href="#cb76-23" tabindex="-1"></a>}</span>
<span id="cb76-24"><a href="#cb76-24" tabindex="-1"></a></span>
<span id="cb76-25"><a href="#cb76-25" tabindex="-1"></a><span class="co">// Apply the function to all images in the collection</span></span>
<span id="cb76-26"><a href="#cb76-26" tabindex="-1"></a><span class="kw">var</span> maskedCol <span class="op">=</span> filtered<span class="op">.</span><span class="fu">map</span>(maskSnowAndClouds)</span>
<span id="cb76-27"><a href="#cb76-27" tabindex="-1"></a></span>
<span id="cb76-28"><a href="#cb76-28" tabindex="-1"></a><span class="kw">var</span> ndviCol <span class="op">=</span> maskedCol<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;NDVI&#39;</span>)</span>
<span id="cb76-29"><a href="#cb76-29" tabindex="-1"></a><span class="co">// MODIS NDVI values come as NDVI x 10000 that need to be scaled by 0.0001</span></span>
<span id="cb76-30"><a href="#cb76-30" tabindex="-1"></a><span class="kw">var</span> ndviScaled <span class="op">=</span> ndviCol<span class="op">.</span><span class="fu">map</span>(<span class="kw">function</span>(image) {</span>
<span id="cb76-31"><a href="#cb76-31" tabindex="-1"></a>  <span class="kw">var</span> scaled <span class="op">=</span> image<span class="op">.</span><span class="fu">divide</span>(<span class="dv">10000</span>)</span>
<span id="cb76-32"><a href="#cb76-32" tabindex="-1"></a>  <span class="cf">return</span> scaled<span class="op">.</span><span class="fu">copyProperties</span>(image<span class="op">,</span> [<span class="st">&#39;system:index&#39;</span><span class="op">,</span> <span class="st">&#39;system:time_start&#39;</span>])</span>
<span id="cb76-33"><a href="#cb76-33" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb76-34"><a href="#cb76-34" tabindex="-1"></a></span>
<span id="cb76-35"><a href="#cb76-35" tabindex="-1"></a><span class="fu">print</span>(ndviScaled)<span class="op">;</span></span></code></pre></div>
<div id="exercise-36" class="section level3">
<h3>Exercise</h3>
<p>Add the scaled image to the map canvas using a suitable visualization
parameter. Inspect any pixel and check the NDVI value.</p>
<a
href="https://code.earthengine.google.co.in/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3A06-Drought_Monitoring%2F03c_Extract_and_Scale_NDVI_Band_(exercise)"
target="_blank">Try in Code Editor ↗</a>
<div class="figure" style="text-align: center">
<img src="images/gee_water_resources_management/vci_ndviscaled.png" alt="Masked and Scaled MODIS NDVI" width="50%" />
<p class="caption">
Masked and Scaled MODIS NDVI
</p>
</div>
<div class="sourceCode" id="cb77"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb77-1"><a href="#cb77-1" tabindex="-1"></a><span class="co">// Extract 1 image from the ndviScaled collection</span></span>
<span id="cb77-2"><a href="#cb77-2" tabindex="-1"></a><span class="co">// Visualize it and add it to the map</span></span></code></pre></div>
</div>
</div>
<div id="create-monthly-images" class="section level2">
<h2>04. Create Monthly Images</h2>
<p>The MODIS Vegetation Indices is a 16-day composite, and it cannot be
standardized in a calendar unit. So let’s create one image per month by
aggregating all the images in the month as a <em>mean</em> composite. To
filter the collection for with <em>year, month, day</em> level
<code>ee.Filter.calenderRange()</code> function should be use.</p>
<p>We should use a nested map function to map the years first then the
months in the inner map function. The inner months map will return a
Feature Collection, which results in a <em>Feature collection of Feature
Collection</em> when returned by the outer years function. A Feature
collection can contain only Features but not Feature Collection. Hence
we can use the <code>.flatten()</code> algorithm with the outer years
map function to convert <em>Feature collection of Feature
Collection</em> to <em>Feature Collection with List of
Features</em>.</p>
<p>For an 11-year time series, we will create a final output of 132 (11
x 12) images.</p>
<p><a
href="https://code.earthengine.google.co.in/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3A06-Drought_Monitoring%2F04b_Create_Monthly_Images_(complete)"
target="_blank">Open in Code Editor ↗</a>
<img src="images/gee_water_resources_management/drought_monthlyImages.png" width="50%" style="display: block; margin: auto;" /></p>
<div class="sourceCode" id="cb78"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb78-1"><a href="#cb78-1" tabindex="-1"></a><span class="kw">var</span> modis <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&#39;MODIS/061/MOD13Q1&#39;</span>)<span class="op">;</span></span>
<span id="cb78-2"><a href="#cb78-2" tabindex="-1"></a></span>
<span id="cb78-3"><a href="#cb78-3" tabindex="-1"></a><span class="kw">var</span> startYear <span class="op">=</span> <span class="dv">2010</span></span>
<span id="cb78-4"><a href="#cb78-4" tabindex="-1"></a><span class="kw">var</span> endYear <span class="op">=</span> <span class="dv">2020</span></span>
<span id="cb78-5"><a href="#cb78-5" tabindex="-1"></a><span class="kw">var</span> startDate <span class="op">=</span> ee<span class="op">.</span><span class="at">Date</span><span class="op">.</span><span class="fu">fromYMD</span>(startYear<span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">1</span>)</span>
<span id="cb78-6"><a href="#cb78-6" tabindex="-1"></a><span class="kw">var</span> endDate <span class="op">=</span> ee<span class="op">.</span><span class="at">Date</span><span class="op">.</span><span class="fu">fromYMD</span>(endYear<span class="op">,</span> <span class="dv">12</span><span class="op">,</span> <span class="dv">31</span>)</span>
<span id="cb78-7"><a href="#cb78-7" tabindex="-1"></a><span class="kw">var</span> filtered <span class="op">=</span> modis</span>
<span id="cb78-8"><a href="#cb78-8" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(startDate<span class="op">,</span> endDate))</span>
<span id="cb78-9"><a href="#cb78-9" tabindex="-1"></a></span>
<span id="cb78-10"><a href="#cb78-10" tabindex="-1"></a><span class="co">// Cloud Masking</span></span>
<span id="cb78-11"><a href="#cb78-11" tabindex="-1"></a><span class="kw">var</span> bitwiseExtract <span class="op">=</span> <span class="kw">function</span>(input<span class="op">,</span> fromBit<span class="op">,</span> toBit) {</span>
<span id="cb78-12"><a href="#cb78-12" tabindex="-1"></a>  <span class="kw">var</span> maskSize <span class="op">=</span> ee<span class="op">.</span><span class="fu">Number</span>(<span class="dv">1</span>)<span class="op">.</span><span class="fu">add</span>(toBit)<span class="op">.</span><span class="fu">subtract</span>(fromBit)</span>
<span id="cb78-13"><a href="#cb78-13" tabindex="-1"></a>  <span class="kw">var</span> mask <span class="op">=</span> ee<span class="op">.</span><span class="fu">Number</span>(<span class="dv">1</span>)<span class="op">.</span><span class="fu">leftShift</span>(maskSize)<span class="op">.</span><span class="fu">subtract</span>(<span class="dv">1</span>)</span>
<span id="cb78-14"><a href="#cb78-14" tabindex="-1"></a>  <span class="cf">return</span> input<span class="op">.</span><span class="fu">rightShift</span>(fromBit)<span class="op">.</span><span class="fu">bitwiseAnd</span>(mask)</span>
<span id="cb78-15"><a href="#cb78-15" tabindex="-1"></a>}</span>
<span id="cb78-16"><a href="#cb78-16" tabindex="-1"></a></span>
<span id="cb78-17"><a href="#cb78-17" tabindex="-1"></a><span class="kw">var</span> maskSnowAndClouds <span class="op">=</span> <span class="kw">function</span>(image) {</span>
<span id="cb78-18"><a href="#cb78-18" tabindex="-1"></a>  <span class="kw">var</span> summaryQa <span class="op">=</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;SummaryQA&#39;</span>)</span>
<span id="cb78-19"><a href="#cb78-19" tabindex="-1"></a>  <span class="co">// Select pixels which are less than or equals to 1 (0 or 1)</span></span>
<span id="cb78-20"><a href="#cb78-20" tabindex="-1"></a>  <span class="kw">var</span> qaMask <span class="op">=</span> <span class="fu">bitwiseExtract</span>(summaryQa<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">1</span>)<span class="op">.</span><span class="fu">lte</span>(<span class="dv">1</span>)</span>
<span id="cb78-21"><a href="#cb78-21" tabindex="-1"></a>  <span class="kw">var</span> maskedImage <span class="op">=</span> image<span class="op">.</span><span class="fu">updateMask</span>(qaMask)</span>
<span id="cb78-22"><a href="#cb78-22" tabindex="-1"></a>  <span class="cf">return</span> maskedImage<span class="op">.</span><span class="fu">copyProperties</span>(image<span class="op">,</span> [<span class="st">&#39;system:index&#39;</span><span class="op">,</span> <span class="st">&#39;system:time_start&#39;</span>])</span>
<span id="cb78-23"><a href="#cb78-23" tabindex="-1"></a>}</span>
<span id="cb78-24"><a href="#cb78-24" tabindex="-1"></a></span>
<span id="cb78-25"><a href="#cb78-25" tabindex="-1"></a><span class="co">// Apply the function to all images in the collection</span></span>
<span id="cb78-26"><a href="#cb78-26" tabindex="-1"></a><span class="kw">var</span> maskedCol <span class="op">=</span> filtered<span class="op">.</span><span class="fu">map</span>(maskSnowAndClouds)</span>
<span id="cb78-27"><a href="#cb78-27" tabindex="-1"></a></span>
<span id="cb78-28"><a href="#cb78-28" tabindex="-1"></a><span class="kw">var</span> ndviCol <span class="op">=</span> maskedCol<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;NDVI&#39;</span>)</span>
<span id="cb78-29"><a href="#cb78-29" tabindex="-1"></a><span class="co">// MODIS NDVI values come as NDVI x 10000 that need to be scaled by 0.0001</span></span>
<span id="cb78-30"><a href="#cb78-30" tabindex="-1"></a><span class="kw">var</span> ndviScaled <span class="op">=</span> ndviCol<span class="op">.</span><span class="fu">map</span>(<span class="kw">function</span>(image) {</span>
<span id="cb78-31"><a href="#cb78-31" tabindex="-1"></a>  <span class="kw">var</span> scaled <span class="op">=</span> image<span class="op">.</span><span class="fu">divide</span>(<span class="dv">10000</span>)</span>
<span id="cb78-32"><a href="#cb78-32" tabindex="-1"></a>  <span class="cf">return</span> scaled<span class="op">.</span><span class="fu">copyProperties</span>(image<span class="op">,</span> [<span class="st">&#39;system:index&#39;</span><span class="op">,</span> <span class="st">&#39;system:time_start&#39;</span>])</span>
<span id="cb78-33"><a href="#cb78-33" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb78-34"><a href="#cb78-34" tabindex="-1"></a></span>
<span id="cb78-35"><a href="#cb78-35" tabindex="-1"></a><span class="fu">print</span>(ndviScaled)<span class="op">;</span></span>
<span id="cb78-36"><a href="#cb78-36" tabindex="-1"></a></span>
<span id="cb78-37"><a href="#cb78-37" tabindex="-1"></a></span>
<span id="cb78-38"><a href="#cb78-38" tabindex="-1"></a><span class="co">// Introducting calendarRange()</span></span>
<span id="cb78-39"><a href="#cb78-39" tabindex="-1"></a><span class="kw">var</span> mayImages <span class="op">=</span> ndviScaled</span>
<span id="cb78-40"><a href="#cb78-40" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">calendarRange</span>(<span class="dv">5</span><span class="op">,</span> <span class="dv">5</span><span class="op">,</span> <span class="st">&#39;month&#39;</span>))</span>
<span id="cb78-41"><a href="#cb78-41" tabindex="-1"></a><span class="fu">print</span>(mayImages)</span>
<span id="cb78-42"><a href="#cb78-42" tabindex="-1"></a></span>
<span id="cb78-43"><a href="#cb78-43" tabindex="-1"></a></span>
<span id="cb78-44"><a href="#cb78-44" tabindex="-1"></a><span class="co">// Introducting flatten()</span></span>
<span id="cb78-45"><a href="#cb78-45" tabindex="-1"></a></span>
<span id="cb78-46"><a href="#cb78-46" tabindex="-1"></a><span class="kw">var</span> nestedList <span class="op">=</span> ee<span class="op">.</span><span class="fu">List</span>([[<span class="st">&#39;a&#39;</span><span class="op">,</span> <span class="st">&#39;b&#39;</span>]<span class="op">,</span> [<span class="st">&#39;c&#39;</span><span class="op">,</span> <span class="st">&#39;d&#39;</span>]<span class="op">,</span> [<span class="st">&#39;e&#39;</span><span class="op">,</span> <span class="st">&#39;f&#39;</span>]])</span>
<span id="cb78-47"><a href="#cb78-47" tabindex="-1"></a><span class="fu">print</span>(nestedList)</span>
<span id="cb78-48"><a href="#cb78-48" tabindex="-1"></a><span class="fu">print</span>(nestedList<span class="op">.</span><span class="fu">flatten</span>())</span>
<span id="cb78-49"><a href="#cb78-49" tabindex="-1"></a></span>
<span id="cb78-50"><a href="#cb78-50" tabindex="-1"></a></span>
<span id="cb78-51"><a href="#cb78-51" tabindex="-1"></a><span class="co">// Create NDVI composite for every month</span></span>
<span id="cb78-52"><a href="#cb78-52" tabindex="-1"></a><span class="kw">var</span> years <span class="op">=</span> ee<span class="op">.</span><span class="at">List</span><span class="op">.</span><span class="fu">sequence</span>(startYear<span class="op">,</span>endYear)<span class="op">;</span></span>
<span id="cb78-53"><a href="#cb78-53" tabindex="-1"></a><span class="kw">var</span> months <span class="op">=</span> ee<span class="op">.</span><span class="at">List</span><span class="op">.</span><span class="fu">sequence</span>(<span class="dv">1</span><span class="op">,</span> <span class="dv">12</span>)<span class="op">;</span></span>
<span id="cb78-54"><a href="#cb78-54" tabindex="-1"></a></span>
<span id="cb78-55"><a href="#cb78-55" tabindex="-1"></a><span class="co">// Map over the years and create a monthly average collection</span></span>
<span id="cb78-56"><a href="#cb78-56" tabindex="-1"></a><span class="kw">var</span> monthlyImages <span class="op">=</span> years<span class="op">.</span><span class="fu">map</span>(<span class="kw">function</span>(year) {</span>
<span id="cb78-57"><a href="#cb78-57" tabindex="-1"></a>  <span class="cf">return</span> months<span class="op">.</span><span class="fu">map</span>(<span class="kw">function</span>(month) {</span>
<span id="cb78-58"><a href="#cb78-58" tabindex="-1"></a>    <span class="kw">var</span> filtered <span class="op">=</span> ndviScaled</span>
<span id="cb78-59"><a href="#cb78-59" tabindex="-1"></a>      <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">calendarRange</span>(year<span class="op">,</span> year<span class="op">,</span> <span class="st">&#39;year&#39;</span>))</span>
<span id="cb78-60"><a href="#cb78-60" tabindex="-1"></a>      <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">calendarRange</span>(month<span class="op">,</span> month<span class="op">,</span> <span class="st">&#39;month&#39;</span>))</span>
<span id="cb78-61"><a href="#cb78-61" tabindex="-1"></a>    <span class="kw">var</span> monthly <span class="op">=</span> filtered<span class="op">.</span><span class="fu">mean</span>()</span>
<span id="cb78-62"><a href="#cb78-62" tabindex="-1"></a>    <span class="cf">return</span> monthly<span class="op">.</span><span class="fu">set</span>({<span class="st">&#39;month&#39;</span><span class="op">:</span> month<span class="op">,</span> <span class="st">&#39;year&#39;</span><span class="op">:</span> year})</span>
<span id="cb78-63"><a href="#cb78-63" tabindex="-1"></a>  })</span>
<span id="cb78-64"><a href="#cb78-64" tabindex="-1"></a>})<span class="op">.</span><span class="fu">flatten</span>()</span>
<span id="cb78-65"><a href="#cb78-65" tabindex="-1"></a></span>
<span id="cb78-66"><a href="#cb78-66" tabindex="-1"></a><span class="co">// We now have 1 image per month for entire duratioon</span></span>
<span id="cb78-67"><a href="#cb78-67" tabindex="-1"></a><span class="fu">print</span>(monthlyImages)</span></code></pre></div>
<div id="exercise-37" class="section level3">
<h3>Exercise</h3>
<p><a
href="https://code.earthengine.google.co.in/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3A06-Drought_Monitoring%2F04c_Create_Monthly_Images_(exercise)"
target="_blank">Try in Code Editor ↗</a></p>
<p>The final output will be a list of images, convert this into an
ImageCollection.</p>
</div>
</div>
<div id="calculate-min-max-composites" class="section level2">
<h2>05. Calculate Min Max Composites</h2>
<p>To compute the VCI, we need to calculate each month’s minimum NDVI
and maximum NDVI values. The <code>min()</code> and <code>max()</code>
reducers are used to compute image collections for the creation of
minimum and maximum NDVI values.</p>
<p><a
href="https://code.earthengine.google.co.in/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3A06-Drought_Monitoring%2F05b_Calculate_Min_Max_Composites_(complete)"
target="_blank">Open in Code Editor ↗</a></p>
<div class="sourceCode" id="cb79"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb79-1"><a href="#cb79-1" tabindex="-1"></a><span class="kw">var</span> modis <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&#39;MODIS/061/MOD13Q1&#39;</span>)<span class="op">;</span></span>
<span id="cb79-2"><a href="#cb79-2" tabindex="-1"></a></span>
<span id="cb79-3"><a href="#cb79-3" tabindex="-1"></a><span class="kw">var</span> startYear <span class="op">=</span> <span class="dv">2010</span></span>
<span id="cb79-4"><a href="#cb79-4" tabindex="-1"></a><span class="kw">var</span> endYear <span class="op">=</span> <span class="dv">2020</span></span>
<span id="cb79-5"><a href="#cb79-5" tabindex="-1"></a><span class="kw">var</span> startDate <span class="op">=</span> ee<span class="op">.</span><span class="at">Date</span><span class="op">.</span><span class="fu">fromYMD</span>(startYear<span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">1</span>)</span>
<span id="cb79-6"><a href="#cb79-6" tabindex="-1"></a><span class="kw">var</span> endDate <span class="op">=</span> ee<span class="op">.</span><span class="at">Date</span><span class="op">.</span><span class="fu">fromYMD</span>(endYear<span class="op">,</span> <span class="dv">12</span><span class="op">,</span> <span class="dv">31</span>)</span>
<span id="cb79-7"><a href="#cb79-7" tabindex="-1"></a><span class="kw">var</span> filtered <span class="op">=</span> modis</span>
<span id="cb79-8"><a href="#cb79-8" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(startDate<span class="op">,</span> endDate))</span>
<span id="cb79-9"><a href="#cb79-9" tabindex="-1"></a></span>
<span id="cb79-10"><a href="#cb79-10" tabindex="-1"></a><span class="co">// Cloud Masking</span></span>
<span id="cb79-11"><a href="#cb79-11" tabindex="-1"></a><span class="kw">var</span> bitwiseExtract <span class="op">=</span> <span class="kw">function</span>(input<span class="op">,</span> fromBit<span class="op">,</span> toBit) {</span>
<span id="cb79-12"><a href="#cb79-12" tabindex="-1"></a>  <span class="kw">var</span> maskSize <span class="op">=</span> ee<span class="op">.</span><span class="fu">Number</span>(<span class="dv">1</span>)<span class="op">.</span><span class="fu">add</span>(toBit)<span class="op">.</span><span class="fu">subtract</span>(fromBit)</span>
<span id="cb79-13"><a href="#cb79-13" tabindex="-1"></a>  <span class="kw">var</span> mask <span class="op">=</span> ee<span class="op">.</span><span class="fu">Number</span>(<span class="dv">1</span>)<span class="op">.</span><span class="fu">leftShift</span>(maskSize)<span class="op">.</span><span class="fu">subtract</span>(<span class="dv">1</span>)</span>
<span id="cb79-14"><a href="#cb79-14" tabindex="-1"></a>  <span class="cf">return</span> input<span class="op">.</span><span class="fu">rightShift</span>(fromBit)<span class="op">.</span><span class="fu">bitwiseAnd</span>(mask)</span>
<span id="cb79-15"><a href="#cb79-15" tabindex="-1"></a>}</span>
<span id="cb79-16"><a href="#cb79-16" tabindex="-1"></a></span>
<span id="cb79-17"><a href="#cb79-17" tabindex="-1"></a><span class="kw">var</span> maskSnowAndClouds <span class="op">=</span> <span class="kw">function</span>(image) {</span>
<span id="cb79-18"><a href="#cb79-18" tabindex="-1"></a>  <span class="kw">var</span> summaryQa <span class="op">=</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;SummaryQA&#39;</span>)</span>
<span id="cb79-19"><a href="#cb79-19" tabindex="-1"></a>  <span class="co">// Select pixels which are less than or equals to 1 (0 or 1)</span></span>
<span id="cb79-20"><a href="#cb79-20" tabindex="-1"></a>  <span class="kw">var</span> qaMask <span class="op">=</span> <span class="fu">bitwiseExtract</span>(summaryQa<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">1</span>)<span class="op">.</span><span class="fu">lte</span>(<span class="dv">1</span>)</span>
<span id="cb79-21"><a href="#cb79-21" tabindex="-1"></a>  <span class="kw">var</span> maskedImage <span class="op">=</span> image<span class="op">.</span><span class="fu">updateMask</span>(qaMask)</span>
<span id="cb79-22"><a href="#cb79-22" tabindex="-1"></a>  <span class="cf">return</span> maskedImage<span class="op">.</span><span class="fu">copyProperties</span>(image<span class="op">,</span> [<span class="st">&#39;system:index&#39;</span><span class="op">,</span> <span class="st">&#39;system:time_start&#39;</span>])</span>
<span id="cb79-23"><a href="#cb79-23" tabindex="-1"></a>}</span>
<span id="cb79-24"><a href="#cb79-24" tabindex="-1"></a></span>
<span id="cb79-25"><a href="#cb79-25" tabindex="-1"></a><span class="co">// Apply the function to all images in the collection</span></span>
<span id="cb79-26"><a href="#cb79-26" tabindex="-1"></a><span class="kw">var</span> maskedCol <span class="op">=</span> filtered<span class="op">.</span><span class="fu">map</span>(maskSnowAndClouds)</span>
<span id="cb79-27"><a href="#cb79-27" tabindex="-1"></a></span>
<span id="cb79-28"><a href="#cb79-28" tabindex="-1"></a><span class="kw">var</span> ndviCol <span class="op">=</span> maskedCol<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;NDVI&#39;</span>)</span>
<span id="cb79-29"><a href="#cb79-29" tabindex="-1"></a><span class="co">// MODIS NDVI values come as NDVI x 10000 that need to be scaled by 0.0001</span></span>
<span id="cb79-30"><a href="#cb79-30" tabindex="-1"></a><span class="kw">var</span> ndviScaled <span class="op">=</span> ndviCol<span class="op">.</span><span class="fu">map</span>(<span class="kw">function</span>(image) {</span>
<span id="cb79-31"><a href="#cb79-31" tabindex="-1"></a>  <span class="kw">var</span> scaled <span class="op">=</span> image<span class="op">.</span><span class="fu">divide</span>(<span class="dv">10000</span>)</span>
<span id="cb79-32"><a href="#cb79-32" tabindex="-1"></a>  <span class="cf">return</span> scaled<span class="op">.</span><span class="fu">copyProperties</span>(image<span class="op">,</span> [<span class="st">&#39;system:index&#39;</span><span class="op">,</span> <span class="st">&#39;system:time_start&#39;</span>])</span>
<span id="cb79-33"><a href="#cb79-33" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb79-34"><a href="#cb79-34" tabindex="-1"></a></span>
<span id="cb79-35"><a href="#cb79-35" tabindex="-1"></a><span class="co">// Create NDVI composite for every month</span></span>
<span id="cb79-36"><a href="#cb79-36" tabindex="-1"></a><span class="kw">var</span> years <span class="op">=</span> ee<span class="op">.</span><span class="at">List</span><span class="op">.</span><span class="fu">sequence</span>(startYear<span class="op">,</span>endYear)<span class="op">;</span></span>
<span id="cb79-37"><a href="#cb79-37" tabindex="-1"></a><span class="kw">var</span> months <span class="op">=</span> ee<span class="op">.</span><span class="at">List</span><span class="op">.</span><span class="fu">sequence</span>(<span class="dv">1</span><span class="op">,</span> <span class="dv">12</span>)<span class="op">;</span></span>
<span id="cb79-38"><a href="#cb79-38" tabindex="-1"></a></span>
<span id="cb79-39"><a href="#cb79-39" tabindex="-1"></a><span class="co">// Map over the years and create a monthly average collection</span></span>
<span id="cb79-40"><a href="#cb79-40" tabindex="-1"></a><span class="kw">var</span> monthlyImages <span class="op">=</span> years<span class="op">.</span><span class="fu">map</span>(<span class="kw">function</span>(year) {</span>
<span id="cb79-41"><a href="#cb79-41" tabindex="-1"></a>  <span class="cf">return</span> months<span class="op">.</span><span class="fu">map</span>(<span class="kw">function</span>(month) {</span>
<span id="cb79-42"><a href="#cb79-42" tabindex="-1"></a>    <span class="kw">var</span> filtered <span class="op">=</span> ndviScaled</span>
<span id="cb79-43"><a href="#cb79-43" tabindex="-1"></a>      <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">calendarRange</span>(year<span class="op">,</span> year<span class="op">,</span> <span class="st">&#39;year&#39;</span>))</span>
<span id="cb79-44"><a href="#cb79-44" tabindex="-1"></a>      <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">calendarRange</span>(month<span class="op">,</span> month<span class="op">,</span> <span class="st">&#39;month&#39;</span>))</span>
<span id="cb79-45"><a href="#cb79-45" tabindex="-1"></a>    <span class="kw">var</span> monthly <span class="op">=</span> filtered<span class="op">.</span><span class="fu">mean</span>()</span>
<span id="cb79-46"><a href="#cb79-46" tabindex="-1"></a>    <span class="cf">return</span> monthly<span class="op">.</span><span class="fu">set</span>({<span class="st">&#39;month&#39;</span><span class="op">:</span> month<span class="op">,</span> <span class="st">&#39;year&#39;</span><span class="op">:</span> year})</span>
<span id="cb79-47"><a href="#cb79-47" tabindex="-1"></a>  })</span>
<span id="cb79-48"><a href="#cb79-48" tabindex="-1"></a>})<span class="op">.</span><span class="fu">flatten</span>()</span>
<span id="cb79-49"><a href="#cb79-49" tabindex="-1"></a></span>
<span id="cb79-50"><a href="#cb79-50" tabindex="-1"></a><span class="co">// We now have 1 image per month for entire duratioon</span></span>
<span id="cb79-51"><a href="#cb79-51" tabindex="-1"></a><span class="kw">var</span> monthlyCol <span class="op">=</span> ee<span class="op">.</span><span class="at">ImageCollection</span><span class="op">.</span><span class="fu">fromImages</span>(monthlyImages)</span>
<span id="cb79-52"><a href="#cb79-52" tabindex="-1"></a></span>
<span id="cb79-53"><a href="#cb79-53" tabindex="-1"></a></span>
<span id="cb79-54"><a href="#cb79-54" tabindex="-1"></a><span class="co">// We can compute Minimum NDVI for each month across all years</span></span>
<span id="cb79-55"><a href="#cb79-55" tabindex="-1"></a><span class="co">// i.e. Minimum NDVI for all May months in the collection</span></span>
<span id="cb79-56"><a href="#cb79-56" tabindex="-1"></a><span class="kw">var</span> monthlyMinImages <span class="op">=</span> months<span class="op">.</span><span class="fu">map</span>(<span class="kw">function</span>(month) {</span>
<span id="cb79-57"><a href="#cb79-57" tabindex="-1"></a>    <span class="kw">var</span> filtered <span class="op">=</span> monthlyCol<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;month&#39;</span><span class="op">,</span> month))</span>
<span id="cb79-58"><a href="#cb79-58" tabindex="-1"></a>    <span class="kw">var</span> monthlyMin <span class="op">=</span> filtered<span class="op">.</span><span class="fu">min</span>()</span>
<span id="cb79-59"><a href="#cb79-59" tabindex="-1"></a>    <span class="cf">return</span> monthlyMin<span class="op">.</span><span class="fu">set</span>(<span class="st">&#39;month&#39;</span><span class="op">,</span> month)</span>
<span id="cb79-60"><a href="#cb79-60" tabindex="-1"></a>})</span>
<span id="cb79-61"><a href="#cb79-61" tabindex="-1"></a><span class="kw">var</span> monthlyMin <span class="op">=</span> ee<span class="op">.</span><span class="at">ImageCollection</span><span class="op">.</span><span class="fu">fromImages</span>(monthlyMinImages)</span>
<span id="cb79-62"><a href="#cb79-62" tabindex="-1"></a><span class="fu">print</span>(monthlyMin)</span>
<span id="cb79-63"><a href="#cb79-63" tabindex="-1"></a><span class="co">// We can compute Maximum NDVI for each month across all years</span></span>
<span id="cb79-64"><a href="#cb79-64" tabindex="-1"></a><span class="co">// i.e. Maximum NDVI for all May months in the collection</span></span>
<span id="cb79-65"><a href="#cb79-65" tabindex="-1"></a><span class="kw">var</span> monthlyMaxImages <span class="op">=</span> months<span class="op">.</span><span class="fu">map</span>(<span class="kw">function</span>(month) {</span>
<span id="cb79-66"><a href="#cb79-66" tabindex="-1"></a>    <span class="kw">var</span> filtered <span class="op">=</span> monthlyCol<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;month&#39;</span><span class="op">,</span> month))</span>
<span id="cb79-67"><a href="#cb79-67" tabindex="-1"></a>    <span class="kw">var</span> monthlyMax <span class="op">=</span> filtered<span class="op">.</span><span class="fu">max</span>()</span>
<span id="cb79-68"><a href="#cb79-68" tabindex="-1"></a>    <span class="cf">return</span> monthlyMax<span class="op">.</span><span class="fu">set</span>(<span class="st">&#39;month&#39;</span><span class="op">,</span> month)</span>
<span id="cb79-69"><a href="#cb79-69" tabindex="-1"></a>})</span>
<span id="cb79-70"><a href="#cb79-70" tabindex="-1"></a><span class="kw">var</span> monthlyMax <span class="op">=</span> ee<span class="op">.</span><span class="at">ImageCollection</span><span class="op">.</span><span class="fu">fromImages</span>(monthlyMaxImages)</span>
<span id="cb79-71"><a href="#cb79-71" tabindex="-1"></a><span class="fu">print</span>(monthlyMax)</span></code></pre></div>
<div id="exercise-38" class="section level3">
<h3>Exercise</h3>
<p>Add the min and max NDVI images to map canvas using a suitable
visualization parameter for the month of <strong>May</strong>.</p>
<a
href="https://code.earthengine.google.co.in/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3A06-Drought_Monitoring%2F05c_Calculate_Min_Max_Composites_(exercise)"
target="_blank">Try in Code Editor ↗</a>
<div class="figure" style="text-align: center">
<img src="images/gee_water_resources_management/vci_ndviminmax.png" alt="Historic Minimum and Maximum NDVI for the Month of May" width="100%" />
<p class="caption">
Historic Minimum and Maximum NDVI for the Month of May
</p>
</div>
<div class="sourceCode" id="cb80"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb80-1"><a href="#cb80-1" tabindex="-1"></a><span class="co">// Extract 1 image from the ndviScaled collection</span></span>
<span id="cb80-2"><a href="#cb80-2" tabindex="-1"></a><span class="co">// Visualize it and add it to the map</span></span></code></pre></div>
</div>
</div>
<div id="calculate-vci" class="section level2">
<h2>06. Calculate VCI</h2>
<p>Vegetation Condition Index (VCI) is a drought monitoring index that
takes the previous year’s minimum and maximum NDVI values at a
particular area and compares it against the current NDVI value to
identify if the area is experiencing drought. As recommended by <a
href="https://un-spider.org/book/export/html/9206">Un-Spider - Drought
Monitoring Recommended Practice</a> VCI value of less than 40 % can be
considered as drought.</p>
<a
href="https://code.earthengine.google.co.in/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3A06-Drought_Monitoring%2F06b_Calculate_VCI_(complete)"
target="_blank">Open in Code Editor ↗</a>
<div class="figure" style="text-align: center">
<img src="images/gee_water_resources_management/vci_formula.png" alt="VCI Formula" width="50%" />
<p class="caption">
VCI Formula
</p>
</div>
<div class="sourceCode" id="cb81"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb81-1"><a href="#cb81-1" tabindex="-1"></a><span class="kw">var</span> modis <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&#39;MODIS/061/MOD13Q1&#39;</span>)<span class="op">;</span></span>
<span id="cb81-2"><a href="#cb81-2" tabindex="-1"></a></span>
<span id="cb81-3"><a href="#cb81-3" tabindex="-1"></a><span class="kw">var</span> startYear <span class="op">=</span> <span class="dv">2010</span></span>
<span id="cb81-4"><a href="#cb81-4" tabindex="-1"></a><span class="kw">var</span> endYear <span class="op">=</span> <span class="dv">2020</span></span>
<span id="cb81-5"><a href="#cb81-5" tabindex="-1"></a><span class="kw">var</span> startDate <span class="op">=</span> ee<span class="op">.</span><span class="at">Date</span><span class="op">.</span><span class="fu">fromYMD</span>(startYear<span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">1</span>)</span>
<span id="cb81-6"><a href="#cb81-6" tabindex="-1"></a><span class="kw">var</span> endDate <span class="op">=</span> ee<span class="op">.</span><span class="at">Date</span><span class="op">.</span><span class="fu">fromYMD</span>(endYear<span class="op">,</span> <span class="dv">12</span><span class="op">,</span> <span class="dv">31</span>)</span>
<span id="cb81-7"><a href="#cb81-7" tabindex="-1"></a><span class="kw">var</span> filtered <span class="op">=</span> modis</span>
<span id="cb81-8"><a href="#cb81-8" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(startDate<span class="op">,</span> endDate))</span>
<span id="cb81-9"><a href="#cb81-9" tabindex="-1"></a></span>
<span id="cb81-10"><a href="#cb81-10" tabindex="-1"></a><span class="co">// Cloud Masking</span></span>
<span id="cb81-11"><a href="#cb81-11" tabindex="-1"></a><span class="kw">var</span> bitwiseExtract <span class="op">=</span> <span class="kw">function</span>(input<span class="op">,</span> fromBit<span class="op">,</span> toBit) {</span>
<span id="cb81-12"><a href="#cb81-12" tabindex="-1"></a>  <span class="kw">var</span> maskSize <span class="op">=</span> ee<span class="op">.</span><span class="fu">Number</span>(<span class="dv">1</span>)<span class="op">.</span><span class="fu">add</span>(toBit)<span class="op">.</span><span class="fu">subtract</span>(fromBit)</span>
<span id="cb81-13"><a href="#cb81-13" tabindex="-1"></a>  <span class="kw">var</span> mask <span class="op">=</span> ee<span class="op">.</span><span class="fu">Number</span>(<span class="dv">1</span>)<span class="op">.</span><span class="fu">leftShift</span>(maskSize)<span class="op">.</span><span class="fu">subtract</span>(<span class="dv">1</span>)</span>
<span id="cb81-14"><a href="#cb81-14" tabindex="-1"></a>  <span class="cf">return</span> input<span class="op">.</span><span class="fu">rightShift</span>(fromBit)<span class="op">.</span><span class="fu">bitwiseAnd</span>(mask)</span>
<span id="cb81-15"><a href="#cb81-15" tabindex="-1"></a>}</span>
<span id="cb81-16"><a href="#cb81-16" tabindex="-1"></a></span>
<span id="cb81-17"><a href="#cb81-17" tabindex="-1"></a><span class="kw">var</span> maskSnowAndClouds <span class="op">=</span> <span class="kw">function</span>(image) {</span>
<span id="cb81-18"><a href="#cb81-18" tabindex="-1"></a>  <span class="kw">var</span> summaryQa <span class="op">=</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;SummaryQA&#39;</span>)</span>
<span id="cb81-19"><a href="#cb81-19" tabindex="-1"></a>  <span class="co">// Select pixels which are less than or equals to 1 (0 or 1)</span></span>
<span id="cb81-20"><a href="#cb81-20" tabindex="-1"></a>  <span class="kw">var</span> qaMask <span class="op">=</span> <span class="fu">bitwiseExtract</span>(summaryQa<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">1</span>)<span class="op">.</span><span class="fu">lte</span>(<span class="dv">1</span>)</span>
<span id="cb81-21"><a href="#cb81-21" tabindex="-1"></a>  <span class="kw">var</span> maskedImage <span class="op">=</span> image<span class="op">.</span><span class="fu">updateMask</span>(qaMask)</span>
<span id="cb81-22"><a href="#cb81-22" tabindex="-1"></a>  <span class="cf">return</span> maskedImage<span class="op">.</span><span class="fu">copyProperties</span>(image<span class="op">,</span> [<span class="st">&#39;system:index&#39;</span><span class="op">,</span> <span class="st">&#39;system:time_start&#39;</span>])</span>
<span id="cb81-23"><a href="#cb81-23" tabindex="-1"></a>}</span>
<span id="cb81-24"><a href="#cb81-24" tabindex="-1"></a></span>
<span id="cb81-25"><a href="#cb81-25" tabindex="-1"></a><span class="co">// Apply the function to all images in the collection</span></span>
<span id="cb81-26"><a href="#cb81-26" tabindex="-1"></a><span class="kw">var</span> maskedCol <span class="op">=</span> filtered<span class="op">.</span><span class="fu">map</span>(maskSnowAndClouds)</span>
<span id="cb81-27"><a href="#cb81-27" tabindex="-1"></a></span>
<span id="cb81-28"><a href="#cb81-28" tabindex="-1"></a><span class="kw">var</span> ndviCol <span class="op">=</span> maskedCol<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;NDVI&#39;</span>)</span>
<span id="cb81-29"><a href="#cb81-29" tabindex="-1"></a><span class="co">// MODIS NDVI values come as NDVI x 10000 that need to be scaled by 0.0001</span></span>
<span id="cb81-30"><a href="#cb81-30" tabindex="-1"></a><span class="kw">var</span> scaleNdvi <span class="op">=</span> <span class="kw">function</span>(image) {</span>
<span id="cb81-31"><a href="#cb81-31" tabindex="-1"></a>  <span class="kw">var</span> scaled <span class="op">=</span> image<span class="op">.</span><span class="fu">divide</span>(<span class="dv">10000</span>)</span>
<span id="cb81-32"><a href="#cb81-32" tabindex="-1"></a>  <span class="cf">return</span> scaled<span class="op">.</span><span class="fu">copyProperties</span>(image<span class="op">,</span> [<span class="st">&#39;system:index&#39;</span><span class="op">,</span> <span class="st">&#39;system:time_start&#39;</span>])</span>
<span id="cb81-33"><a href="#cb81-33" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb81-34"><a href="#cb81-34" tabindex="-1"></a></span>
<span id="cb81-35"><a href="#cb81-35" tabindex="-1"></a><span class="kw">var</span> ndviScaled <span class="op">=</span> ndviCol<span class="op">.</span><span class="fu">map</span>(scaleNdvi)</span>
<span id="cb81-36"><a href="#cb81-36" tabindex="-1"></a></span>
<span id="cb81-37"><a href="#cb81-37" tabindex="-1"></a><span class="co">// Create NDVI composite for every month</span></span>
<span id="cb81-38"><a href="#cb81-38" tabindex="-1"></a><span class="kw">var</span> years <span class="op">=</span> ee<span class="op">.</span><span class="at">List</span><span class="op">.</span><span class="fu">sequence</span>(startYear<span class="op">,</span>endYear)<span class="op">;</span></span>
<span id="cb81-39"><a href="#cb81-39" tabindex="-1"></a><span class="kw">var</span> months <span class="op">=</span> ee<span class="op">.</span><span class="at">List</span><span class="op">.</span><span class="fu">sequence</span>(<span class="dv">1</span><span class="op">,</span> <span class="dv">12</span>)<span class="op">;</span></span>
<span id="cb81-40"><a href="#cb81-40" tabindex="-1"></a></span>
<span id="cb81-41"><a href="#cb81-41" tabindex="-1"></a><span class="co">// Map over the years and create a monthly average collection</span></span>
<span id="cb81-42"><a href="#cb81-42" tabindex="-1"></a><span class="kw">var</span> monthlyImages <span class="op">=</span> years<span class="op">.</span><span class="fu">map</span>(<span class="kw">function</span>(year) {</span>
<span id="cb81-43"><a href="#cb81-43" tabindex="-1"></a>  <span class="cf">return</span> months<span class="op">.</span><span class="fu">map</span>(<span class="kw">function</span>(month) {</span>
<span id="cb81-44"><a href="#cb81-44" tabindex="-1"></a>    <span class="kw">var</span> filtered <span class="op">=</span> ndviScaled</span>
<span id="cb81-45"><a href="#cb81-45" tabindex="-1"></a>      <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">calendarRange</span>(year<span class="op">,</span> year<span class="op">,</span> <span class="st">&#39;year&#39;</span>))</span>
<span id="cb81-46"><a href="#cb81-46" tabindex="-1"></a>      <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">calendarRange</span>(month<span class="op">,</span> month<span class="op">,</span> <span class="st">&#39;month&#39;</span>))</span>
<span id="cb81-47"><a href="#cb81-47" tabindex="-1"></a>    <span class="kw">var</span> monthly <span class="op">=</span> filtered<span class="op">.</span><span class="fu">mean</span>()</span>
<span id="cb81-48"><a href="#cb81-48" tabindex="-1"></a>    <span class="cf">return</span> monthly<span class="op">.</span><span class="fu">set</span>({<span class="st">&#39;month&#39;</span><span class="op">:</span> month<span class="op">,</span> <span class="st">&#39;year&#39;</span><span class="op">:</span> year})</span>
<span id="cb81-49"><a href="#cb81-49" tabindex="-1"></a>  })</span>
<span id="cb81-50"><a href="#cb81-50" tabindex="-1"></a>})<span class="op">.</span><span class="fu">flatten</span>()</span>
<span id="cb81-51"><a href="#cb81-51" tabindex="-1"></a></span>
<span id="cb81-52"><a href="#cb81-52" tabindex="-1"></a><span class="co">// We now have 1 image per month for entire duratioon</span></span>
<span id="cb81-53"><a href="#cb81-53" tabindex="-1"></a><span class="kw">var</span> monthlyCol <span class="op">=</span> ee<span class="op">.</span><span class="at">ImageCollection</span><span class="op">.</span><span class="fu">fromImages</span>(monthlyImages)</span>
<span id="cb81-54"><a href="#cb81-54" tabindex="-1"></a></span>
<span id="cb81-55"><a href="#cb81-55" tabindex="-1"></a></span>
<span id="cb81-56"><a href="#cb81-56" tabindex="-1"></a><span class="co">// We can compute Minimum NDVI for each month across all years</span></span>
<span id="cb81-57"><a href="#cb81-57" tabindex="-1"></a><span class="co">// i.e. Minimum NDVI for all May months in the collection</span></span>
<span id="cb81-58"><a href="#cb81-58" tabindex="-1"></a><span class="kw">var</span> monthlyMinImages <span class="op">=</span> months<span class="op">.</span><span class="fu">map</span>(<span class="kw">function</span>(month) {</span>
<span id="cb81-59"><a href="#cb81-59" tabindex="-1"></a>    <span class="kw">var</span> filtered <span class="op">=</span> monthlyCol<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;month&#39;</span><span class="op">,</span> month))</span>
<span id="cb81-60"><a href="#cb81-60" tabindex="-1"></a>    <span class="kw">var</span> monthlyMin <span class="op">=</span> filtered<span class="op">.</span><span class="fu">min</span>()</span>
<span id="cb81-61"><a href="#cb81-61" tabindex="-1"></a>    <span class="cf">return</span> monthlyMin<span class="op">.</span><span class="fu">set</span>(<span class="st">&#39;month&#39;</span><span class="op">,</span> month)</span>
<span id="cb81-62"><a href="#cb81-62" tabindex="-1"></a>})</span>
<span id="cb81-63"><a href="#cb81-63" tabindex="-1"></a><span class="kw">var</span> monthlyMin <span class="op">=</span> ee<span class="op">.</span><span class="at">ImageCollection</span><span class="op">.</span><span class="fu">fromImages</span>(monthlyMinImages)</span>
<span id="cb81-64"><a href="#cb81-64" tabindex="-1"></a></span>
<span id="cb81-65"><a href="#cb81-65" tabindex="-1"></a><span class="co">// We can compute Maximum NDVI for each month across all years</span></span>
<span id="cb81-66"><a href="#cb81-66" tabindex="-1"></a><span class="co">// i.e. Maximum NDVI for all May months in the collection</span></span>
<span id="cb81-67"><a href="#cb81-67" tabindex="-1"></a><span class="kw">var</span> monthlyMaxImages <span class="op">=</span> months<span class="op">.</span><span class="fu">map</span>(<span class="kw">function</span>(month) {</span>
<span id="cb81-68"><a href="#cb81-68" tabindex="-1"></a>    <span class="kw">var</span> filtered <span class="op">=</span> monthlyCol<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;month&#39;</span><span class="op">,</span> month))</span>
<span id="cb81-69"><a href="#cb81-69" tabindex="-1"></a>    <span class="kw">var</span> monthlyMax <span class="op">=</span> filtered<span class="op">.</span><span class="fu">max</span>()</span>
<span id="cb81-70"><a href="#cb81-70" tabindex="-1"></a>    <span class="cf">return</span> monthlyMax<span class="op">.</span><span class="fu">set</span>(<span class="st">&#39;month&#39;</span><span class="op">,</span> month)</span>
<span id="cb81-71"><a href="#cb81-71" tabindex="-1"></a>})</span>
<span id="cb81-72"><a href="#cb81-72" tabindex="-1"></a><span class="kw">var</span> monthlyMax <span class="op">=</span> ee<span class="op">.</span><span class="at">ImageCollection</span><span class="op">.</span><span class="fu">fromImages</span>(monthlyMaxImages)</span>
<span id="cb81-73"><a href="#cb81-73" tabindex="-1"></a></span>
<span id="cb81-74"><a href="#cb81-74" tabindex="-1"></a><span class="co">// Calculate VCI for 2020</span></span>
<span id="cb81-75"><a href="#cb81-75" tabindex="-1"></a></span>
<span id="cb81-76"><a href="#cb81-76" tabindex="-1"></a><span class="co">// We are interested in calculating VCI for a particular month</span></span>
<span id="cb81-77"><a href="#cb81-77" tabindex="-1"></a><span class="kw">var</span> currentYear <span class="op">=</span> <span class="dv">2020</span></span>
<span id="cb81-78"><a href="#cb81-78" tabindex="-1"></a><span class="kw">var</span> currentMonth <span class="op">=</span> <span class="dv">5</span></span>
<span id="cb81-79"><a href="#cb81-79" tabindex="-1"></a></span>
<span id="cb81-80"><a href="#cb81-80" tabindex="-1"></a><span class="kw">var</span> filtered <span class="op">=</span> monthlyCol</span>
<span id="cb81-81"><a href="#cb81-81" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;year&#39;</span><span class="op">,</span> currentYear))</span>
<span id="cb81-82"><a href="#cb81-82" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;month&#39;</span><span class="op">,</span> currentMonth))</span>
<span id="cb81-83"><a href="#cb81-83" tabindex="-1"></a><span class="kw">var</span> currentMonthNdvi <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(filtered<span class="op">.</span><span class="fu">first</span>())</span>
<span id="cb81-84"><a href="#cb81-84" tabindex="-1"></a></span>
<span id="cb81-85"><a href="#cb81-85" tabindex="-1"></a><span class="kw">var</span> minNdvi <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(monthlyMin<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;month&#39;</span><span class="op">,</span> currentMonth))<span class="op">.</span><span class="fu">first</span>())</span>
<span id="cb81-86"><a href="#cb81-86" tabindex="-1"></a><span class="kw">var</span> maxNdvi <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(monthlyMax<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;month&#39;</span><span class="op">,</span> currentMonth))<span class="op">.</span><span class="fu">first</span>())</span>
<span id="cb81-87"><a href="#cb81-87" tabindex="-1"></a></span>
<span id="cb81-88"><a href="#cb81-88" tabindex="-1"></a><span class="co">// VCI = (NDVI - min) / (max - min)</span></span>
<span id="cb81-89"><a href="#cb81-89" tabindex="-1"></a><span class="kw">var</span> image <span class="op">=</span> ee<span class="op">.</span><span class="at">Image</span><span class="op">.</span><span class="fu">cat</span>([currentMonthNdvi<span class="op">,</span> minNdvi<span class="op">,</span> maxNdvi])<span class="op">.</span><span class="fu">rename</span>([<span class="st">&#39;ndvi&#39;</span><span class="op">,</span> <span class="st">&#39;min&#39;</span><span class="op">,</span> <span class="st">&#39;max&#39;</span>])</span>
<span id="cb81-90"><a href="#cb81-90" tabindex="-1"></a><span class="kw">var</span> vci <span class="op">=</span> image<span class="op">.</span><span class="fu">expression</span>(<span class="st">&#39;100* (ndvi - min) / (max - min)&#39;</span><span class="op">,</span></span>
<span id="cb81-91"><a href="#cb81-91" tabindex="-1"></a>    {<span class="st">&#39;ndvi&#39;</span><span class="op">:</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;ndvi&#39;</span>)<span class="op">,</span></span>
<span id="cb81-92"><a href="#cb81-92" tabindex="-1"></a>      <span class="st">&#39;min&#39;</span><span class="op">:</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;min&#39;</span>)<span class="op">,</span></span>
<span id="cb81-93"><a href="#cb81-93" tabindex="-1"></a>      <span class="st">&#39;max&#39;</span><span class="op">:</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;max&#39;</span>)</span>
<span id="cb81-94"><a href="#cb81-94" tabindex="-1"></a>    })<span class="op">.</span><span class="fu">rename</span>(<span class="st">&#39;vci&#39;</span>)</span>
<span id="cb81-95"><a href="#cb81-95" tabindex="-1"></a></span>
<span id="cb81-96"><a href="#cb81-96" tabindex="-1"></a></span>
<span id="cb81-97"><a href="#cb81-97" tabindex="-1"></a><span class="kw">var</span> visParams <span class="op">=</span> {<span class="dt">min</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span> <span class="dv">1</span><span class="op">,</span> <span class="dt">palette</span><span class="op">:</span> [<span class="st">&#39;white&#39;</span><span class="op">,</span> <span class="st">&#39;green&#39;</span>]}</span>
<span id="cb81-98"><a href="#cb81-98" tabindex="-1"></a><span class="kw">var</span> vciPalette <span class="op">=</span> [<span class="st">&#39;#a50026&#39;</span><span class="op">,</span><span class="st">&#39;#d73027&#39;</span><span class="op">,</span><span class="st">&#39;#f46d43&#39;</span><span class="op">,</span><span class="st">&#39;#fdae61&#39;</span><span class="op">,</span></span>
<span id="cb81-99"><a href="#cb81-99" tabindex="-1"></a>  <span class="st">&#39;#fee08b&#39;</span><span class="op">,</span><span class="st">&#39;#d9ef8b&#39;</span><span class="op">,</span><span class="st">&#39;#a6d96a&#39;</span><span class="op">,</span><span class="st">&#39;#66bd63&#39;</span><span class="op">,</span><span class="st">&#39;#1a9850&#39;</span><span class="op">,</span><span class="st">&#39;#006837&#39;</span>]<span class="op">;</span></span>
<span id="cb81-100"><a href="#cb81-100" tabindex="-1"></a><span class="kw">var</span> vciVisParams <span class="op">=</span> {<span class="dt">min</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span> <span class="dv">100</span><span class="op">,</span> <span class="dt">palette</span><span class="op">:</span> vciPalette}</span>
<span id="cb81-101"><a href="#cb81-101" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(minNdvi<span class="op">,</span> visParams<span class="op">,</span> <span class="st">&#39;Minimum May NDVI&#39;</span><span class="op">,</span> <span class="kw">false</span>)  </span>
<span id="cb81-102"><a href="#cb81-102" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(maxNdvi<span class="op">,</span> visParams<span class="op">,</span> <span class="st">&#39;Maximum May NDVI&#39;</span><span class="op">,</span> <span class="kw">false</span>)</span>
<span id="cb81-103"><a href="#cb81-103" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(currentMonthNdvi<span class="op">,</span> visParams<span class="op">,</span> <span class="st">&#39;Current May NDVI&#39;</span><span class="op">,</span> <span class="kw">false</span>)</span>
<span id="cb81-104"><a href="#cb81-104" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(vci<span class="op">,</span> vciVisParams<span class="op">,</span> <span class="st">&#39;VCI&#39;</span>)</span></code></pre></div>
<div class="figure" style="text-align: center">
<img src="images/gee_water_resources_management/vci_vci.png" alt="VCI for the Month of May" width="50%" />
<p class="caption">
VCI for the Month of May
</p>
</div>
<div id="exercise-39" class="section level3">
<h3>Exercise</h3>
<p><a
href="https://code.earthengine.google.co.in/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3A06-Drought_Monitoring%2F06c_Calculate_VCI_(exercise)"
target="_blank">Try in Code Editor ↗</a></p>
<p>As VCI uses the NDVI index to compute the impact on agriculture. NDVI
over non-croplands do not make sense and should be excluded from VCI
calculation. Use the <a
href="https://developers.google.com/earth-engine/datasets/catalog/USGS_GFSAD1000_V1">Global
Food-Support Analysis Data</a> and mask all non-cropland areas.</p>
</div>
</div>
<div id="classify-vci-image" class="section level2">
<h2>07. Classify VCI Image</h2>
<p>Let us classify the VCI image into 3 categories: Good, Fair, and
Poor. To select a range of values, we can use the <a
href="https://courses.spatialthoughts.com/gee-water-resources-management.html#computation-on-images">boolean
operators</a>. We can use the <code>.where()</code> function to perform
this over an image.</p>
<p><a
href="https://code.earthengine.google.co.in/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3A06-Drought_Monitoring%2F07b_Classify_VCI_Image_(complete)"
target="_blank">Open in Code Editor ↗</a></p>
<div class="sourceCode" id="cb82"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb82-1"><a href="#cb82-1" tabindex="-1"></a><span class="kw">var</span> modis <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&#39;MODIS/061/MOD13Q1&#39;</span>)<span class="op">;</span></span>
<span id="cb82-2"><a href="#cb82-2" tabindex="-1"></a><span class="kw">var</span> gcep30 <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&#39;projects/sat-io/open-datasets/GFSAD/GCEP30&#39;</span>)<span class="op">;</span></span>
<span id="cb82-3"><a href="#cb82-3" tabindex="-1"></a></span>
<span id="cb82-4"><a href="#cb82-4" tabindex="-1"></a><span class="kw">var</span> startYear <span class="op">=</span> <span class="dv">2010</span></span>
<span id="cb82-5"><a href="#cb82-5" tabindex="-1"></a><span class="kw">var</span> endYear <span class="op">=</span> <span class="dv">2020</span></span>
<span id="cb82-6"><a href="#cb82-6" tabindex="-1"></a><span class="kw">var</span> startDate <span class="op">=</span> ee<span class="op">.</span><span class="at">Date</span><span class="op">.</span><span class="fu">fromYMD</span>(startYear<span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">1</span>)</span>
<span id="cb82-7"><a href="#cb82-7" tabindex="-1"></a><span class="kw">var</span> endDate <span class="op">=</span> ee<span class="op">.</span><span class="at">Date</span><span class="op">.</span><span class="fu">fromYMD</span>(endYear<span class="op">,</span> <span class="dv">12</span><span class="op">,</span> <span class="dv">31</span>)</span>
<span id="cb82-8"><a href="#cb82-8" tabindex="-1"></a><span class="kw">var</span> filtered <span class="op">=</span> modis</span>
<span id="cb82-9"><a href="#cb82-9" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(startDate<span class="op">,</span> endDate))</span>
<span id="cb82-10"><a href="#cb82-10" tabindex="-1"></a></span>
<span id="cb82-11"><a href="#cb82-11" tabindex="-1"></a><span class="co">// Cloud Masking</span></span>
<span id="cb82-12"><a href="#cb82-12" tabindex="-1"></a><span class="kw">var</span> bitwiseExtract <span class="op">=</span> <span class="kw">function</span>(input<span class="op">,</span> fromBit<span class="op">,</span> toBit) {</span>
<span id="cb82-13"><a href="#cb82-13" tabindex="-1"></a>  <span class="kw">var</span> maskSize <span class="op">=</span> ee<span class="op">.</span><span class="fu">Number</span>(<span class="dv">1</span>)<span class="op">.</span><span class="fu">add</span>(toBit)<span class="op">.</span><span class="fu">subtract</span>(fromBit)</span>
<span id="cb82-14"><a href="#cb82-14" tabindex="-1"></a>  <span class="kw">var</span> mask <span class="op">=</span> ee<span class="op">.</span><span class="fu">Number</span>(<span class="dv">1</span>)<span class="op">.</span><span class="fu">leftShift</span>(maskSize)<span class="op">.</span><span class="fu">subtract</span>(<span class="dv">1</span>)</span>
<span id="cb82-15"><a href="#cb82-15" tabindex="-1"></a>  <span class="cf">return</span> input<span class="op">.</span><span class="fu">rightShift</span>(fromBit)<span class="op">.</span><span class="fu">bitwiseAnd</span>(mask)</span>
<span id="cb82-16"><a href="#cb82-16" tabindex="-1"></a>}</span>
<span id="cb82-17"><a href="#cb82-17" tabindex="-1"></a></span>
<span id="cb82-18"><a href="#cb82-18" tabindex="-1"></a><span class="kw">var</span> maskSnowAndClouds <span class="op">=</span> <span class="kw">function</span>(image) {</span>
<span id="cb82-19"><a href="#cb82-19" tabindex="-1"></a>  <span class="kw">var</span> summaryQa <span class="op">=</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;SummaryQA&#39;</span>)</span>
<span id="cb82-20"><a href="#cb82-20" tabindex="-1"></a>  <span class="co">// Select pixels which are less than or equals to 1 (0 or 1)</span></span>
<span id="cb82-21"><a href="#cb82-21" tabindex="-1"></a>  <span class="kw">var</span> qaMask <span class="op">=</span> <span class="fu">bitwiseExtract</span>(summaryQa<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">1</span>)<span class="op">.</span><span class="fu">lte</span>(<span class="dv">1</span>)</span>
<span id="cb82-22"><a href="#cb82-22" tabindex="-1"></a>  <span class="kw">var</span> maskedImage <span class="op">=</span> image<span class="op">.</span><span class="fu">updateMask</span>(qaMask)</span>
<span id="cb82-23"><a href="#cb82-23" tabindex="-1"></a>  <span class="cf">return</span> maskedImage<span class="op">.</span><span class="fu">copyProperties</span>(image<span class="op">,</span> [<span class="st">&#39;system:index&#39;</span><span class="op">,</span> <span class="st">&#39;system:time_start&#39;</span>])</span>
<span id="cb82-24"><a href="#cb82-24" tabindex="-1"></a>}</span>
<span id="cb82-25"><a href="#cb82-25" tabindex="-1"></a></span>
<span id="cb82-26"><a href="#cb82-26" tabindex="-1"></a><span class="co">// Apply the function to all images in the collection</span></span>
<span id="cb82-27"><a href="#cb82-27" tabindex="-1"></a><span class="kw">var</span> maskedCol <span class="op">=</span> filtered<span class="op">.</span><span class="fu">map</span>(maskSnowAndClouds)</span>
<span id="cb82-28"><a href="#cb82-28" tabindex="-1"></a></span>
<span id="cb82-29"><a href="#cb82-29" tabindex="-1"></a><span class="kw">var</span> ndviCol <span class="op">=</span> maskedCol<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;NDVI&#39;</span>)</span>
<span id="cb82-30"><a href="#cb82-30" tabindex="-1"></a><span class="co">// MODIS NDVI values come as NDVI x 10000 that need to be scaled by 0.0001</span></span>
<span id="cb82-31"><a href="#cb82-31" tabindex="-1"></a><span class="kw">var</span> scaleNdvi <span class="op">=</span> <span class="kw">function</span>(image) {</span>
<span id="cb82-32"><a href="#cb82-32" tabindex="-1"></a>  <span class="kw">var</span> scaled <span class="op">=</span> image<span class="op">.</span><span class="fu">divide</span>(<span class="dv">10000</span>)</span>
<span id="cb82-33"><a href="#cb82-33" tabindex="-1"></a>  <span class="cf">return</span> scaled<span class="op">.</span><span class="fu">copyProperties</span>(image<span class="op">,</span> [<span class="st">&#39;system:index&#39;</span><span class="op">,</span> <span class="st">&#39;system:time_start&#39;</span>])</span>
<span id="cb82-34"><a href="#cb82-34" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb82-35"><a href="#cb82-35" tabindex="-1"></a></span>
<span id="cb82-36"><a href="#cb82-36" tabindex="-1"></a><span class="kw">var</span> ndviScaled <span class="op">=</span> ndviCol<span class="op">.</span><span class="fu">map</span>(scaleNdvi)</span>
<span id="cb82-37"><a href="#cb82-37" tabindex="-1"></a></span>
<span id="cb82-38"><a href="#cb82-38" tabindex="-1"></a><span class="co">// Create NDVI composite for every month</span></span>
<span id="cb82-39"><a href="#cb82-39" tabindex="-1"></a><span class="kw">var</span> years <span class="op">=</span> ee<span class="op">.</span><span class="at">List</span><span class="op">.</span><span class="fu">sequence</span>(startYear<span class="op">,</span>endYear)<span class="op">;</span></span>
<span id="cb82-40"><a href="#cb82-40" tabindex="-1"></a><span class="kw">var</span> months <span class="op">=</span> ee<span class="op">.</span><span class="at">List</span><span class="op">.</span><span class="fu">sequence</span>(<span class="dv">1</span><span class="op">,</span> <span class="dv">12</span>)<span class="op">;</span></span>
<span id="cb82-41"><a href="#cb82-41" tabindex="-1"></a></span>
<span id="cb82-42"><a href="#cb82-42" tabindex="-1"></a><span class="co">// Map over the years and create a monthly average collection</span></span>
<span id="cb82-43"><a href="#cb82-43" tabindex="-1"></a><span class="kw">var</span> monthlyImages <span class="op">=</span> years<span class="op">.</span><span class="fu">map</span>(<span class="kw">function</span>(year) {</span>
<span id="cb82-44"><a href="#cb82-44" tabindex="-1"></a>  <span class="cf">return</span> months<span class="op">.</span><span class="fu">map</span>(<span class="kw">function</span>(month) {</span>
<span id="cb82-45"><a href="#cb82-45" tabindex="-1"></a>    <span class="kw">var</span> filtered <span class="op">=</span> ndviScaled</span>
<span id="cb82-46"><a href="#cb82-46" tabindex="-1"></a>      <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">calendarRange</span>(year<span class="op">,</span> year<span class="op">,</span> <span class="st">&#39;year&#39;</span>))</span>
<span id="cb82-47"><a href="#cb82-47" tabindex="-1"></a>      <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">calendarRange</span>(month<span class="op">,</span> month<span class="op">,</span> <span class="st">&#39;month&#39;</span>))</span>
<span id="cb82-48"><a href="#cb82-48" tabindex="-1"></a>    <span class="kw">var</span> monthly <span class="op">=</span> filtered<span class="op">.</span><span class="fu">mean</span>()</span>
<span id="cb82-49"><a href="#cb82-49" tabindex="-1"></a>    <span class="cf">return</span> monthly<span class="op">.</span><span class="fu">set</span>({<span class="st">&#39;month&#39;</span><span class="op">:</span> month<span class="op">,</span> <span class="st">&#39;year&#39;</span><span class="op">:</span> year})</span>
<span id="cb82-50"><a href="#cb82-50" tabindex="-1"></a>  })</span>
<span id="cb82-51"><a href="#cb82-51" tabindex="-1"></a>})<span class="op">.</span><span class="fu">flatten</span>()</span>
<span id="cb82-52"><a href="#cb82-52" tabindex="-1"></a></span>
<span id="cb82-53"><a href="#cb82-53" tabindex="-1"></a><span class="co">// We now have 1 image per month for entire duratioon</span></span>
<span id="cb82-54"><a href="#cb82-54" tabindex="-1"></a><span class="kw">var</span> monthlyCol <span class="op">=</span> ee<span class="op">.</span><span class="at">ImageCollection</span><span class="op">.</span><span class="fu">fromImages</span>(monthlyImages)</span>
<span id="cb82-55"><a href="#cb82-55" tabindex="-1"></a></span>
<span id="cb82-56"><a href="#cb82-56" tabindex="-1"></a></span>
<span id="cb82-57"><a href="#cb82-57" tabindex="-1"></a><span class="co">// We can compute Minimum NDVI for each month across all years</span></span>
<span id="cb82-58"><a href="#cb82-58" tabindex="-1"></a><span class="co">// i.e. Minimum NDVI for all May months in the collection</span></span>
<span id="cb82-59"><a href="#cb82-59" tabindex="-1"></a><span class="kw">var</span> monthlyMinImages <span class="op">=</span> months<span class="op">.</span><span class="fu">map</span>(<span class="kw">function</span>(month) {</span>
<span id="cb82-60"><a href="#cb82-60" tabindex="-1"></a>    <span class="kw">var</span> filtered <span class="op">=</span> monthlyCol<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;month&#39;</span><span class="op">,</span> month))</span>
<span id="cb82-61"><a href="#cb82-61" tabindex="-1"></a>    <span class="kw">var</span> monthlyMin <span class="op">=</span> filtered<span class="op">.</span><span class="fu">min</span>()</span>
<span id="cb82-62"><a href="#cb82-62" tabindex="-1"></a>    <span class="cf">return</span> monthlyMin<span class="op">.</span><span class="fu">set</span>(<span class="st">&#39;month&#39;</span><span class="op">,</span> month)</span>
<span id="cb82-63"><a href="#cb82-63" tabindex="-1"></a>})</span>
<span id="cb82-64"><a href="#cb82-64" tabindex="-1"></a><span class="kw">var</span> monthlyMin <span class="op">=</span> ee<span class="op">.</span><span class="at">ImageCollection</span><span class="op">.</span><span class="fu">fromImages</span>(monthlyMinImages)</span>
<span id="cb82-65"><a href="#cb82-65" tabindex="-1"></a></span>
<span id="cb82-66"><a href="#cb82-66" tabindex="-1"></a><span class="co">// We can compute Maximum NDVI for each month across all years</span></span>
<span id="cb82-67"><a href="#cb82-67" tabindex="-1"></a><span class="co">// i.e. Maximum NDVI for all May months in the collection</span></span>
<span id="cb82-68"><a href="#cb82-68" tabindex="-1"></a><span class="kw">var</span> monthlyMaxImages <span class="op">=</span> months<span class="op">.</span><span class="fu">map</span>(<span class="kw">function</span>(month) {</span>
<span id="cb82-69"><a href="#cb82-69" tabindex="-1"></a>    <span class="kw">var</span> filtered <span class="op">=</span> monthlyCol<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;month&#39;</span><span class="op">,</span> month))</span>
<span id="cb82-70"><a href="#cb82-70" tabindex="-1"></a>    <span class="kw">var</span> monthlyMax <span class="op">=</span> filtered<span class="op">.</span><span class="fu">max</span>()</span>
<span id="cb82-71"><a href="#cb82-71" tabindex="-1"></a>    <span class="cf">return</span> monthlyMax<span class="op">.</span><span class="fu">set</span>(<span class="st">&#39;month&#39;</span><span class="op">,</span> month)</span>
<span id="cb82-72"><a href="#cb82-72" tabindex="-1"></a>})</span>
<span id="cb82-73"><a href="#cb82-73" tabindex="-1"></a><span class="kw">var</span> monthlyMax <span class="op">=</span> ee<span class="op">.</span><span class="at">ImageCollection</span><span class="op">.</span><span class="fu">fromImages</span>(monthlyMaxImages)</span>
<span id="cb82-74"><a href="#cb82-74" tabindex="-1"></a></span>
<span id="cb82-75"><a href="#cb82-75" tabindex="-1"></a><span class="co">// Calculate VCI for 2020</span></span>
<span id="cb82-76"><a href="#cb82-76" tabindex="-1"></a></span>
<span id="cb82-77"><a href="#cb82-77" tabindex="-1"></a><span class="co">// We are interested in calculating VCI for a particular month</span></span>
<span id="cb82-78"><a href="#cb82-78" tabindex="-1"></a><span class="kw">var</span> currentYear <span class="op">=</span> <span class="dv">2020</span></span>
<span id="cb82-79"><a href="#cb82-79" tabindex="-1"></a><span class="kw">var</span> currentMonth <span class="op">=</span> <span class="dv">5</span></span>
<span id="cb82-80"><a href="#cb82-80" tabindex="-1"></a></span>
<span id="cb82-81"><a href="#cb82-81" tabindex="-1"></a><span class="kw">var</span> filtered <span class="op">=</span> monthlyCol</span>
<span id="cb82-82"><a href="#cb82-82" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;year&#39;</span><span class="op">,</span> currentYear))</span>
<span id="cb82-83"><a href="#cb82-83" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;month&#39;</span><span class="op">,</span> currentMonth))</span>
<span id="cb82-84"><a href="#cb82-84" tabindex="-1"></a><span class="kw">var</span> currentMonthNdvi <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(filtered<span class="op">.</span><span class="fu">first</span>())</span>
<span id="cb82-85"><a href="#cb82-85" tabindex="-1"></a></span>
<span id="cb82-86"><a href="#cb82-86" tabindex="-1"></a><span class="kw">var</span> minNdvi <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(monthlyMin<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;month&#39;</span><span class="op">,</span> currentMonth))<span class="op">.</span><span class="fu">first</span>())</span>
<span id="cb82-87"><a href="#cb82-87" tabindex="-1"></a><span class="kw">var</span> maxNdvi <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(monthlyMax<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;month&#39;</span><span class="op">,</span> currentMonth))<span class="op">.</span><span class="fu">first</span>())</span>
<span id="cb82-88"><a href="#cb82-88" tabindex="-1"></a></span>
<span id="cb82-89"><a href="#cb82-89" tabindex="-1"></a><span class="co">// VCI = (NDVI - min) / (max - min)</span></span>
<span id="cb82-90"><a href="#cb82-90" tabindex="-1"></a><span class="kw">var</span> image <span class="op">=</span> ee<span class="op">.</span><span class="at">Image</span><span class="op">.</span><span class="fu">cat</span>([currentMonthNdvi<span class="op">,</span> minNdvi<span class="op">,</span> maxNdvi])<span class="op">.</span><span class="fu">rename</span>([<span class="st">&#39;ndvi&#39;</span><span class="op">,</span> <span class="st">&#39;min&#39;</span><span class="op">,</span> <span class="st">&#39;max&#39;</span>])</span>
<span id="cb82-91"><a href="#cb82-91" tabindex="-1"></a><span class="kw">var</span> vci <span class="op">=</span> image<span class="op">.</span><span class="fu">expression</span>(<span class="st">&#39;100* (ndvi - min) / (max - min)&#39;</span><span class="op">,</span></span>
<span id="cb82-92"><a href="#cb82-92" tabindex="-1"></a>    {<span class="st">&#39;ndvi&#39;</span><span class="op">:</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;ndvi&#39;</span>)<span class="op">,</span></span>
<span id="cb82-93"><a href="#cb82-93" tabindex="-1"></a>      <span class="st">&#39;min&#39;</span><span class="op">:</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;min&#39;</span>)<span class="op">,</span></span>
<span id="cb82-94"><a href="#cb82-94" tabindex="-1"></a>      <span class="st">&#39;max&#39;</span><span class="op">:</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;max&#39;</span>)</span>
<span id="cb82-95"><a href="#cb82-95" tabindex="-1"></a>    })<span class="op">.</span><span class="fu">rename</span>(<span class="st">&#39;vci&#39;</span>)</span>
<span id="cb82-96"><a href="#cb82-96" tabindex="-1"></a></span>
<span id="cb82-97"><a href="#cb82-97" tabindex="-1"></a><span class="kw">var</span> cropLand <span class="op">=</span> gcep30<span class="op">.</span><span class="fu">mosaic</span>()<span class="op">.</span><span class="fu">eq</span>(<span class="dv">2</span>)<span class="op">;</span></span>
<span id="cb82-98"><a href="#cb82-98" tabindex="-1"></a><span class="kw">var</span> vciMasked <span class="op">=</span> vci<span class="op">.</span><span class="fu">updateMask</span>(cropLand)</span>
<span id="cb82-99"><a href="#cb82-99" tabindex="-1"></a></span>
<span id="cb82-100"><a href="#cb82-100" tabindex="-1"></a><span class="co">// Vegetation Condition Classification</span></span>
<span id="cb82-101"><a href="#cb82-101" tabindex="-1"></a></span>
<span id="cb82-102"><a href="#cb82-102" tabindex="-1"></a><span class="co">// | VCI    | Condition |</span></span>
<span id="cb82-103"><a href="#cb82-103" tabindex="-1"></a><span class="co">// | 60-100 | Good      |</span></span>
<span id="cb82-104"><a href="#cb82-104" tabindex="-1"></a><span class="co">// | 40-60  | Fair      |</span></span>
<span id="cb82-105"><a href="#cb82-105" tabindex="-1"></a><span class="co">// | 0-40   | Poor      |</span></span>
<span id="cb82-106"><a href="#cb82-106" tabindex="-1"></a></span>
<span id="cb82-107"><a href="#cb82-107" tabindex="-1"></a><span class="co">// Use .where() function to classify continuous images to</span></span>
<span id="cb82-108"><a href="#cb82-108" tabindex="-1"></a><span class="co">// discrete values</span></span>
<span id="cb82-109"><a href="#cb82-109" tabindex="-1"></a><span class="kw">var</span> condition <span class="op">=</span> vciMasked</span>
<span id="cb82-110"><a href="#cb82-110" tabindex="-1"></a>  <span class="op">.</span><span class="fu">where</span>(vciMasked<span class="op">.</span><span class="fu">lt</span>(<span class="dv">40</span>)<span class="op">,</span> <span class="dv">1</span>)</span>
<span id="cb82-111"><a href="#cb82-111" tabindex="-1"></a>  <span class="op">.</span><span class="fu">where</span>(vciMasked<span class="op">.</span><span class="fu">gte</span>(<span class="dv">40</span>)<span class="op">.</span><span class="fu">and</span>(vciMasked<span class="op">.</span><span class="fu">lt</span>(<span class="dv">60</span>))<span class="op">,</span> <span class="dv">2</span>)</span>
<span id="cb82-112"><a href="#cb82-112" tabindex="-1"></a>  <span class="op">.</span><span class="fu">where</span>(vciMasked<span class="op">.</span><span class="fu">gte</span>(<span class="dv">60</span>)<span class="op">,</span> <span class="dv">3</span>)</span>
<span id="cb82-113"><a href="#cb82-113" tabindex="-1"></a>  </span>
<span id="cb82-114"><a href="#cb82-114" tabindex="-1"></a><span class="kw">var</span> vciPalette <span class="op">=</span> [<span class="st">&#39;#a50026&#39;</span><span class="op">,</span><span class="st">&#39;#d73027&#39;</span><span class="op">,</span><span class="st">&#39;#f46d43&#39;</span><span class="op">,</span><span class="st">&#39;#fdae61&#39;</span><span class="op">,</span></span>
<span id="cb82-115"><a href="#cb82-115" tabindex="-1"></a>  <span class="st">&#39;#fee08b&#39;</span><span class="op">,</span><span class="st">&#39;#d9ef8b&#39;</span><span class="op">,</span><span class="st">&#39;#a6d96a&#39;</span><span class="op">,</span><span class="st">&#39;#66bd63&#39;</span><span class="op">,</span><span class="st">&#39;#1a9850&#39;</span><span class="op">,</span><span class="st">&#39;#006837&#39;</span>]<span class="op">;</span></span>
<span id="cb82-116"><a href="#cb82-116" tabindex="-1"></a><span class="kw">var</span> vciVisParams <span class="op">=</span> {<span class="dt">min</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span> <span class="dv">100</span><span class="op">,</span> <span class="dt">palette</span><span class="op">:</span> vciPalette}</span>
<span id="cb82-117"><a href="#cb82-117" tabindex="-1"></a><span class="kw">var</span> conditionParams <span class="op">=</span> {<span class="dt">min</span><span class="op">:</span><span class="dv">1</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span><span class="dv">3</span><span class="op">,</span> <span class="dt">palette</span><span class="op">:</span> [<span class="st">&#39;#d7191c&#39;</span><span class="op">,</span><span class="st">&#39;#fdae61&#39;</span><span class="op">,</span><span class="st">&#39;#91cf60&#39;</span>]}</span>
<span id="cb82-118"><a href="#cb82-118" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(vciMasked<span class="op">,</span> vciVisParams<span class="op">,</span> <span class="st">&#39;VCI&#39;</span><span class="op">,</span> <span class="kw">false</span>)</span>
<span id="cb82-119"><a href="#cb82-119" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(condition<span class="op">,</span> conditionParams<span class="op">,</span> <span class="st">&#39;Vegetation Condition&#39;</span>)</span>
<span id="cb82-120"><a href="#cb82-120" tabindex="-1"></a>  </span></code></pre></div>
<div class="figure" style="text-align: center">
<img src="images/gee_water_resources_management/vci_classified.png" alt="Masked and Classified VCI Image" width="50%" />
<p class="caption">
Masked and Classified VCI Image
</p>
</div>
<div id="exercise-40" class="section level3">
<h3>Exercise</h3>
<p><a
href="https://code.earthengine.google.co.in/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3A06-Drought_Monitoring%2F07c_Classify_VCI_Image_(exercise)"
target="_blank">Try in Code Editor ↗</a></p>
<p>Extract all pixels representing Poor VCI (Value = 1) from the
classified VCI image. Apply a Mask and display the regions in ‘red’
color.</p>
</div>
</div>
</div>
<div id="module-7-earth-engine-apps" class="section level1">
<h1>Module 7: Earth Engine Apps</h1>
<p>The Earth Engine Javascript API includes a <code>ui</code> module
that allows you to build interactive web-mapping apps easily. Earth
Engine also provides free cloud-hosting to host the app that can be
shared with stakeholders. This module will introduce you to GEE Apps by
creating a simple <a
href="https://ujavalgandhi.users.earthengine.app/view/surface-water-explorer">Surface
Water Explorer App</a>.</p>
<p><a
href="https://www.youtube.com/watch?v=gQKSoPpXf4k&amp;list=PLppGmFLhQ1HI0YeA5zQHxdNlmxihvBawF&amp;index=97"
target="_blank"><img
src="https://img.youtube.com/vi/gQKSoPpXf4k/mqdefault.jpg"
alt="Start Module 7 Videos" /></a></p>
<p><a
href="https://www.youtube.com/watch?v=gQKSoPpXf4k&amp;list=PLppGmFLhQ1HI0YeA5zQHxdNlmxihvBawF&amp;index=97"
target="_blank">Start Module 7 Videos ↗</a></p>
<p><a
href="https://docs.google.com/presentation/d/1B4NiKObQpmL29yLk7CHR5lVu706TVNkWjqOtngP1wl8/edit?usp=sharing"
target="_blank">View the Presentation ↗</a></p>
<div id="client-vs-server" class="section level2">
<h2>01. Client vs Server</h2>
<p>The User Interface elements in your Code Editor - Map View, Drawing
Tools etc. are ‘client-side’ elements. They run in YOUR browser. Image
Collections, feature collections, calculations on Earth Engine objects
etc. are ‘server-side’ elements. They run in Google’s data center. You
cannot mix both these objects. To learn more, visit the <a
href="https://developers.google.com/earth-engine/guides/client_server">Client
vs. Server</a> section of the Earth Engine User Guide.</p>
<ul>
<li>To convert client-side objects to server-side objects, you can use
the appropriate API function. Server-side functions start with
<code>ee.</code>, such <code>ee.Date()</code>, <code>ee.Image()</code>
etc.</li>
<li>To convert server-side objects to client-side objects, you can call
<code>.getInfo()</code> on am Earth Engine object. For the Python API,
this is the only way to extract information from a server-side object,
but the Javascript API provides a better (and preferred) - method for
bring server-side objects to client-side using the
<code>evaluate()</code> method. This method asynchronously retrieves the
value of the object, without blocking the user interface - meaning it
will let your code continue to execute while it fetches the value.</li>
</ul>
<p><a
href="https://code.earthengine.google.co.in/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3A07-Earth_Engine_Apps%2F01b_Client_vs_Server_(complete)"
target="_blank">Open in Code Editor ↗</a></p>
<div class="sourceCode" id="cb83"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb83-1"><a href="#cb83-1" tabindex="-1"></a><span class="co">// Client vs. Server</span></span>
<span id="cb83-2"><a href="#cb83-2" tabindex="-1"></a></span>
<span id="cb83-3"><a href="#cb83-3" tabindex="-1"></a><span class="co">// User Interface elements - Map View, Drawing Tools, Buttons, Sliders etc.</span></span>
<span id="cb83-4"><a href="#cb83-4" tabindex="-1"></a><span class="co">// are &#39;client-side&#39;. They run in YOUR browser</span></span>
<span id="cb83-5"><a href="#cb83-5" tabindex="-1"></a></span>
<span id="cb83-6"><a href="#cb83-6" tabindex="-1"></a><span class="co">// Image Collections, feature collections, calculations on Earth Engine objects</span></span>
<span id="cb83-7"><a href="#cb83-7" tabindex="-1"></a><span class="co">// etc. are &#39;server-side&#39;. They run in Google&#39;s data center.</span></span>
<span id="cb83-8"><a href="#cb83-8" tabindex="-1"></a></span>
<span id="cb83-9"><a href="#cb83-9" tabindex="-1"></a><span class="co">// You cannot mix both these objects.</span></span>
<span id="cb83-10"><a href="#cb83-10" tabindex="-1"></a></span>
<span id="cb83-11"><a href="#cb83-11" tabindex="-1"></a><span class="kw">var</span> date <span class="op">=</span> <span class="st">&#39;2020-01-01&#39;</span> <span class="co">// This is client-side</span></span>
<span id="cb83-12"><a href="#cb83-12" tabindex="-1"></a><span class="fu">print</span>(<span class="kw">typeof</span>(date))</span>
<span id="cb83-13"><a href="#cb83-13" tabindex="-1"></a></span>
<span id="cb83-14"><a href="#cb83-14" tabindex="-1"></a><span class="kw">var</span> eedate <span class="op">=</span> ee<span class="op">.</span><span class="fu">Date</span>(<span class="st">&#39;2020-01-01&#39;</span>)<span class="op">.</span><span class="fu">format</span>() <span class="co">// This is server-side</span></span>
<span id="cb83-15"><a href="#cb83-15" tabindex="-1"></a><span class="fu">print</span>(<span class="kw">typeof</span>(eedate)) </span>
<span id="cb83-16"><a href="#cb83-16" tabindex="-1"></a></span>
<span id="cb83-17"><a href="#cb83-17" tabindex="-1"></a><span class="co">// To bring server-side objects to client-side, you can call .getInfo()</span></span>
<span id="cb83-18"><a href="#cb83-18" tabindex="-1"></a></span>
<span id="cb83-19"><a href="#cb83-19" tabindex="-1"></a><span class="co">// var clientdate = eedate.getInfo()</span></span>
<span id="cb83-20"><a href="#cb83-20" tabindex="-1"></a><span class="co">// print(clientdate)</span></span>
<span id="cb83-21"><a href="#cb83-21" tabindex="-1"></a><span class="co">// print(typeof(clientdate)) </span></span>
<span id="cb83-22"><a href="#cb83-22" tabindex="-1"></a></span>
<span id="cb83-23"><a href="#cb83-23" tabindex="-1"></a><span class="co">// getInfo() blocks the execution of your code till the value is fetched</span></span>
<span id="cb83-24"><a href="#cb83-24" tabindex="-1"></a><span class="co">// If the value takes time to compute, your code editor will freeze</span></span>
<span id="cb83-25"><a href="#cb83-25" tabindex="-1"></a><span class="co">// This is not a good user experience</span></span>
<span id="cb83-26"><a href="#cb83-26" tabindex="-1"></a><span class="kw">var</span> s2 <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&quot;COPERNICUS/S2_SR_HARMONIZED&quot;</span>)</span>
<span id="cb83-27"><a href="#cb83-27" tabindex="-1"></a><span class="kw">var</span> filtered <span class="op">=</span> s2<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(<span class="st">&#39;2020-01-01&#39;</span><span class="op">,</span> <span class="st">&#39;2020-01-31&#39;</span>))</span>
<span id="cb83-28"><a href="#cb83-28" tabindex="-1"></a></span>
<span id="cb83-29"><a href="#cb83-29" tabindex="-1"></a><span class="co">//var numImages = filtered.size().getInfo()</span></span>
<span id="cb83-30"><a href="#cb83-30" tabindex="-1"></a><span class="co">//print(numImages)</span></span>
<span id="cb83-31"><a href="#cb83-31" tabindex="-1"></a></span>
<span id="cb83-32"><a href="#cb83-32" tabindex="-1"></a><span class="co">// A better approach is to use evaluate() function</span></span>
<span id="cb83-33"><a href="#cb83-33" tabindex="-1"></a><span class="co">// This is an &#39;ascynshronous&#39; function - meaning it will let your code</span></span>
<span id="cb83-34"><a href="#cb83-34" tabindex="-1"></a><span class="co">// continue to execute while it fetches the value</span></span>
<span id="cb83-35"><a href="#cb83-35" tabindex="-1"></a></span>
<span id="cb83-36"><a href="#cb83-36" tabindex="-1"></a><span class="co">// You need to define a &#39;callback&#39; function which will be called once the </span></span>
<span id="cb83-37"><a href="#cb83-37" tabindex="-1"></a><span class="co">// value has been computed and ready to be used.</span></span>
<span id="cb83-38"><a href="#cb83-38" tabindex="-1"></a></span>
<span id="cb83-39"><a href="#cb83-39" tabindex="-1"></a><span class="kw">var</span> myCallback <span class="op">=</span> <span class="kw">function</span>(object) {</span>
<span id="cb83-40"><a href="#cb83-40" tabindex="-1"></a>  <span class="fu">print</span>(object)</span>
<span id="cb83-41"><a href="#cb83-41" tabindex="-1"></a>}</span>
<span id="cb83-42"><a href="#cb83-42" tabindex="-1"></a><span class="fu">print</span>(<span class="st">&#39;Computing the size of the collection&#39;</span>)</span>
<span id="cb83-43"><a href="#cb83-43" tabindex="-1"></a><span class="kw">var</span> numImages <span class="op">=</span> filtered<span class="op">.</span><span class="fu">size</span>()<span class="op">.</span><span class="fu">evaluate</span>(myCallback)</span></code></pre></div>
</div>
<div id="building-an-app-with-ui-widgets" class="section level2">
<h2>02. Building an App with UI Widgets</h2>
<p>Earth Engine comes with a User Interface API that allows you to build
an interactive web application powered by Earth Engine. Building a web
mapping application typically requires the skills of a full stack
developer and are out of reach for most analysts and scientists. But the
Earth Engine User Interface API makes this process much more accessible
by providing ready-to-use widgets, such as Buttons, Drop-down Menus,
Sliders etc. - and free cloud hosting to allow anyone to publish an app
with just a few lines of code.</p>
<p>The apps run in your browser, so they need to use
<em>client-side</em> functions. All the user interface functions are
contained in the <code>ui.</code> package - such as
<code>ui.Select()</code>, <code>ui.Button()</code>. You can create those
elements by calling these functions with appropriate parameters. The
main container object is the <code>ui.Panel()</code> which can contain
different types of widgets. Learn more in the <a
href="https://developers.google.com/earth-engine/guides/ui">Earth Engine
User Interface API</a> section of the Earth Engine User Guide.</p>
<p>The code below shows how to build an app called Surface Water
Explorer that allows anyone to pick a district in Karnataka, India then
load the <em>JRC Yearly Water Classification History</em> of the
district. .</p>
<div id="publishing-the-app." class="section level3">
<h3>Publishing the App.</h3>
<p>We can publish the app to be viewed by anyone regardless of having an
account in the earth engine. Click the <em>Apps</em> button in the top
left of the script panel and click <em>New apps</em> in the <em>Manage
Apps</em> dialog. In the <em>Publish New App</em> dialog, give an app’s
name, a public URL will be generated by which we can access the app.
Then if you do not have a GCP account, create one and select a project
in which you should publish the app. Then with the default settings,
click <em>Publish.</em> It will take a few minutes for the earth engine
to process your request. After that, your Geo APP will be up and running
on the GCP server.</p>
<p><a
href="https://code.earthengine.google.co.in/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3A07-Earth_Engine_Apps%2F02b_Building_an_App_with_UI_Widgets_(complete)"
target="_blank">Open in Code Editor ↗</a>
<img src="images/gee_water_resources_management/apps_creation.png" width="75%" style="display: block; margin: auto;" /></p>
<div class="sourceCode" id="cb84"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb84-1"><a href="#cb84-1" tabindex="-1"></a><span class="co">/**** Start of imports. If edited, may not auto-convert in the playground. ****/</span></span>
<span id="cb84-2"><a href="#cb84-2" tabindex="-1"></a><span class="kw">var</span> gswYearly <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&quot;JRC/GSW1_3/YearlyHistory&quot;</span>)<span class="op">,</span></span>
<span id="cb84-3"><a href="#cb84-3" tabindex="-1"></a>    admin2 <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">&quot;FAO/GAUL_SIMPLIFIED_500m/2015/level2&quot;</span>)<span class="op">;</span></span>
<span id="cb84-4"><a href="#cb84-4" tabindex="-1"></a><span class="co">/***** End of imports. If edited, may not auto-convert in the playground. *****/</span></span>
<span id="cb84-5"><a href="#cb84-5" tabindex="-1"></a><span class="co">// Panels are the main container widgets</span></span>
<span id="cb84-6"><a href="#cb84-6" tabindex="-1"></a><span class="kw">var</span> mainPanel <span class="op">=</span> ui<span class="op">.</span><span class="fu">Panel</span>({</span>
<span id="cb84-7"><a href="#cb84-7" tabindex="-1"></a>  <span class="dt">style</span><span class="op">:</span> {<span class="dt">width</span><span class="op">:</span> <span class="st">&#39;300px&#39;</span>}</span>
<span id="cb84-8"><a href="#cb84-8" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb84-9"><a href="#cb84-9" tabindex="-1"></a></span>
<span id="cb84-10"><a href="#cb84-10" tabindex="-1"></a></span>
<span id="cb84-11"><a href="#cb84-11" tabindex="-1"></a><span class="kw">var</span> title <span class="op">=</span> ui<span class="op">.</span><span class="fu">Label</span>({</span>
<span id="cb84-12"><a href="#cb84-12" tabindex="-1"></a>  <span class="dt">value</span><span class="op">:</span> <span class="st">&#39;Surface Water Explorer&#39;</span><span class="op">,</span></span>
<span id="cb84-13"><a href="#cb84-13" tabindex="-1"></a>  <span class="dt">style</span><span class="op">:</span> {<span class="st">&#39;fontSize&#39;</span><span class="op">:</span> <span class="st">&#39;24px&#39;</span>}</span>
<span id="cb84-14"><a href="#cb84-14" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb84-15"><a href="#cb84-15" tabindex="-1"></a><span class="co">// You can add widgets to the panel</span></span>
<span id="cb84-16"><a href="#cb84-16" tabindex="-1"></a>mainPanel<span class="op">.</span><span class="fu">add</span>(title)</span>
<span id="cb84-17"><a href="#cb84-17" tabindex="-1"></a></span>
<span id="cb84-18"><a href="#cb84-18" tabindex="-1"></a><span class="co">// You can even add panels to other panels</span></span>
<span id="cb84-19"><a href="#cb84-19" tabindex="-1"></a><span class="kw">var</span> admin2Panel <span class="op">=</span> ui<span class="op">.</span><span class="fu">Panel</span>()</span>
<span id="cb84-20"><a href="#cb84-20" tabindex="-1"></a>mainPanel<span class="op">.</span><span class="fu">add</span>(admin2Panel)<span class="op">;</span></span>
<span id="cb84-21"><a href="#cb84-21" tabindex="-1"></a></span>
<span id="cb84-22"><a href="#cb84-22" tabindex="-1"></a><span class="co">// Let&#39;s add a dropdown with the names of admin2 regions</span></span>
<span id="cb84-23"><a href="#cb84-23" tabindex="-1"></a><span class="co">// We need to get all admin2 names and creat a ui.Select object</span></span>
<span id="cb84-24"><a href="#cb84-24" tabindex="-1"></a><span class="kw">var</span> filtered <span class="op">=</span> admin2<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;ADM1_NAME&#39;</span><span class="op">,</span> <span class="st">&#39;Karnataka&#39;</span>))</span>
<span id="cb84-25"><a href="#cb84-25" tabindex="-1"></a><span class="kw">var</span> admin2Names <span class="op">=</span> filtered<span class="op">.</span><span class="fu">aggregate_array</span>(<span class="st">&#39;ADM2_NAME&#39;</span>)</span>
<span id="cb84-26"><a href="#cb84-26" tabindex="-1"></a></span>
<span id="cb84-27"><a href="#cb84-27" tabindex="-1"></a><span class="co">// We define a function that will be called when the user selects a value</span></span>
<span id="cb84-28"><a href="#cb84-28" tabindex="-1"></a>admin2Names<span class="op">.</span><span class="fu">evaluate</span>(<span class="kw">function</span>(names){</span>
<span id="cb84-29"><a href="#cb84-29" tabindex="-1"></a>  <span class="kw">var</span> dropDown <span class="op">=</span> ui<span class="op">.</span><span class="fu">Select</span>({</span>
<span id="cb84-30"><a href="#cb84-30" tabindex="-1"></a>    <span class="dt">placeholder</span><span class="op">:</span> <span class="st">&#39;select a region&#39;</span><span class="op">,</span></span>
<span id="cb84-31"><a href="#cb84-31" tabindex="-1"></a>    <span class="dt">items</span><span class="op">:</span> names<span class="op">,</span></span>
<span id="cb84-32"><a href="#cb84-32" tabindex="-1"></a>    <span class="dt">onChange</span><span class="op">:</span> display</span>
<span id="cb84-33"><a href="#cb84-33" tabindex="-1"></a>  })</span>
<span id="cb84-34"><a href="#cb84-34" tabindex="-1"></a>  admin2Panel<span class="op">.</span><span class="fu">add</span>(dropDown)</span>
<span id="cb84-35"><a href="#cb84-35" tabindex="-1"></a>})</span>
<span id="cb84-36"><a href="#cb84-36" tabindex="-1"></a></span>
<span id="cb84-37"><a href="#cb84-37" tabindex="-1"></a><span class="co">// This function will be called when the user changes the value in the dropdown</span></span>
<span id="cb84-38"><a href="#cb84-38" tabindex="-1"></a><span class="kw">var</span> display <span class="op">=</span> <span class="kw">function</span>(admin2Name) {</span>
<span id="cb84-39"><a href="#cb84-39" tabindex="-1"></a>  <span class="kw">var</span> selected <span class="op">=</span> ee<span class="op">.</span><span class="fu">Feature</span>(</span>
<span id="cb84-40"><a href="#cb84-40" tabindex="-1"></a>    filtered<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;ADM2_NAME&#39;</span><span class="op">,</span> admin2Name))<span class="op">.</span><span class="fu">first</span>())</span>
<span id="cb84-41"><a href="#cb84-41" tabindex="-1"></a>  <span class="kw">var</span> geometry <span class="op">=</span> selected<span class="op">.</span><span class="fu">geometry</span>()</span>
<span id="cb84-42"><a href="#cb84-42" tabindex="-1"></a>  <span class="bu">Map</span><span class="op">.</span><span class="fu">clear</span>()</span>
<span id="cb84-43"><a href="#cb84-43" tabindex="-1"></a>  <span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(geometry<span class="op">,</span> {<span class="dt">color</span><span class="op">:</span> <span class="st">&#39;grey&#39;</span>}<span class="op">,</span> admin2Name)</span>
<span id="cb84-44"><a href="#cb84-44" tabindex="-1"></a>  <span class="bu">Map</span><span class="op">.</span><span class="fu">centerObject</span>(geometry<span class="op">,</span> <span class="dv">10</span>)</span>
<span id="cb84-45"><a href="#cb84-45" tabindex="-1"></a>  </span>
<span id="cb84-46"><a href="#cb84-46" tabindex="-1"></a>  <span class="kw">var</span> gswYearFiltered <span class="op">=</span> gswYearly<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;year&#39;</span><span class="op">,</span> <span class="dv">2020</span>))</span>
<span id="cb84-47"><a href="#cb84-47" tabindex="-1"></a>  <span class="kw">var</span> gsw2020 <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(gswYearFiltered<span class="op">.</span><span class="fu">first</span>())<span class="op">.</span><span class="fu">clip</span>(geometry)</span>
<span id="cb84-48"><a href="#cb84-48" tabindex="-1"></a>  <span class="kw">var</span> water2020 <span class="op">=</span> gsw2020<span class="op">.</span><span class="fu">eq</span>(<span class="dv">2</span>)<span class="op">.</span><span class="fu">or</span>(gsw2020<span class="op">.</span><span class="fu">eq</span>(<span class="dv">3</span>))<span class="op">.</span><span class="fu">rename</span>(<span class="st">&#39;water&#39;</span>)<span class="op">.</span><span class="fu">selfMask</span>()</span>
<span id="cb84-49"><a href="#cb84-49" tabindex="-1"></a>  </span>
<span id="cb84-50"><a href="#cb84-50" tabindex="-1"></a>  <span class="kw">var</span> visParams <span class="op">=</span> {<span class="dt">min</span><span class="op">:</span><span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span><span class="dv">1</span><span class="op">,</span> <span class="dt">palette</span><span class="op">:</span> [<span class="st">&#39;white&#39;</span><span class="op">,</span><span class="st">&#39;blue&#39;</span>]}</span>
<span id="cb84-51"><a href="#cb84-51" tabindex="-1"></a>  <span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(water2020<span class="op">,</span> visParams<span class="op">,</span> <span class="st">&#39;2020 Water&#39;</span>)</span>
<span id="cb84-52"><a href="#cb84-52" tabindex="-1"></a>}</span>
<span id="cb84-53"><a href="#cb84-53" tabindex="-1"></a></span>
<span id="cb84-54"><a href="#cb84-54" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">setCenter</span>(<span class="fl">76.43</span><span class="op">,</span> <span class="fl">12.41</span><span class="op">,</span> <span class="dv">8</span>)</span>
<span id="cb84-55"><a href="#cb84-55" tabindex="-1"></a>ui<span class="op">.</span><span class="at">root</span><span class="op">.</span><span class="fu">add</span>(mainPanel)<span class="op">;</span></span></code></pre></div>
</div>
<div id="exercise-41" class="section level3">
<h3>Exercise</h3>
<p><a
href="https://code.earthengine.google.co.in/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3A07-Earth_Engine_Apps%2F02c_Building_an_App_with_UI_Widgets_(exercise)"
target="_blank">Try in Code Editor ↗</a></p>
<p>Create the app for your location.</p>
<div class="sourceCode" id="cb85"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb85-1"><a href="#cb85-1" tabindex="-1"></a><span class="co">// Change the ADM2_NAME to a State/Province in your region</span></span>
<span id="cb85-2"><a href="#cb85-2" tabindex="-1"></a><span class="co">// Change the Map.setCenter to center the map on the chosen region</span></span>
<span id="cb85-3"><a href="#cb85-3" tabindex="-1"></a><span class="co">// Test the App</span></span></code></pre></div>
</div>
</div>
<div id="performing-calculations" class="section level2">
<h2>03. Performing Calculations</h2>
<p>We can also perform calculations based on user input, and we can do
this by using the <em>onChange</em> and <code>evaluate()</code>
function. Any UI algorithm that accepts user information will have an
option called <em>onChange</em>, and this will initiate a function if
the user changes the value. We need to perform calculations only after
the data is retrieved for user inputs, and this can be done using the
<em>evaluate</em> function, which works asynchronously without affecting
other computations.</p>
<p><a
href="https://code.earthengine.google.co.in/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3A07-Earth_Engine_Apps%2F03b_Performing_Calculations_(complete)"
target="_blank">Open in Code Editor ↗</a>
<img src="images/gee_water_resources_management/apps_calculation.png" width="70%" style="display: block; margin: auto auto auto 0;" /></p>
<p><a
href="https://santhosh-m.users.earthengine.app/view/surface-water-app"
target="_blank">Explore App ↗</a></p>
<div class="sourceCode" id="cb86"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb86-1"><a href="#cb86-1" tabindex="-1"></a><span class="co">/**** Start of imports. If edited, may not auto-convert in the playground. ****/</span></span>
<span id="cb86-2"><a href="#cb86-2" tabindex="-1"></a><span class="kw">var</span> admin2 <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">&quot;FAO/GAUL_SIMPLIFIED_500m/2015/level2&quot;</span>)<span class="op">,</span></span>
<span id="cb86-3"><a href="#cb86-3" tabindex="-1"></a>    gswYearly <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&quot;JRC/GSW1_3/YearlyHistory&quot;</span>)<span class="op">;</span></span>
<span id="cb86-4"><a href="#cb86-4" tabindex="-1"></a><span class="co">/***** End of imports. If edited, may not auto-convert in the playground. *****/</span></span>
<span id="cb86-5"><a href="#cb86-5" tabindex="-1"></a><span class="co">// Panels are the main container widgets</span></span>
<span id="cb86-6"><a href="#cb86-6" tabindex="-1"></a><span class="kw">var</span> mainPanel <span class="op">=</span> ui<span class="op">.</span><span class="fu">Panel</span>({</span>
<span id="cb86-7"><a href="#cb86-7" tabindex="-1"></a>  <span class="dt">style</span><span class="op">:</span> {<span class="dt">width</span><span class="op">:</span> <span class="st">&#39;300px&#39;</span>}</span>
<span id="cb86-8"><a href="#cb86-8" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb86-9"><a href="#cb86-9" tabindex="-1"></a></span>
<span id="cb86-10"><a href="#cb86-10" tabindex="-1"></a></span>
<span id="cb86-11"><a href="#cb86-11" tabindex="-1"></a><span class="kw">var</span> title <span class="op">=</span> ui<span class="op">.</span><span class="fu">Label</span>({</span>
<span id="cb86-12"><a href="#cb86-12" tabindex="-1"></a>  <span class="dt">value</span><span class="op">:</span> <span class="st">&#39;Surface Water Explorer&#39;</span><span class="op">,</span></span>
<span id="cb86-13"><a href="#cb86-13" tabindex="-1"></a>  <span class="dt">style</span><span class="op">:</span> {<span class="st">&#39;fontSize&#39;</span><span class="op">:</span> <span class="st">&#39;24px&#39;</span>}</span>
<span id="cb86-14"><a href="#cb86-14" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb86-15"><a href="#cb86-15" tabindex="-1"></a><span class="co">// You can add widgets to the panel</span></span>
<span id="cb86-16"><a href="#cb86-16" tabindex="-1"></a>mainPanel<span class="op">.</span><span class="fu">add</span>(title)</span>
<span id="cb86-17"><a href="#cb86-17" tabindex="-1"></a></span>
<span id="cb86-18"><a href="#cb86-18" tabindex="-1"></a><span class="co">// You can even add panels to other panels</span></span>
<span id="cb86-19"><a href="#cb86-19" tabindex="-1"></a><span class="kw">var</span> admin2Panel <span class="op">=</span> ui<span class="op">.</span><span class="fu">Panel</span>()</span>
<span id="cb86-20"><a href="#cb86-20" tabindex="-1"></a>mainPanel<span class="op">.</span><span class="fu">add</span>(admin2Panel)<span class="op">;</span></span>
<span id="cb86-21"><a href="#cb86-21" tabindex="-1"></a></span>
<span id="cb86-22"><a href="#cb86-22" tabindex="-1"></a><span class="co">// Let&#39;s add a dropdown with the names of admin2 regions</span></span>
<span id="cb86-23"><a href="#cb86-23" tabindex="-1"></a><span class="co">// We need to get all admin2 names and creat a ui.Select object</span></span>
<span id="cb86-24"><a href="#cb86-24" tabindex="-1"></a><span class="kw">var</span> filtered <span class="op">=</span> admin2<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;ADM1_NAME&#39;</span><span class="op">,</span> <span class="st">&#39;Karnataka&#39;</span>))</span>
<span id="cb86-25"><a href="#cb86-25" tabindex="-1"></a><span class="kw">var</span> admin2Names <span class="op">=</span> filtered<span class="op">.</span><span class="fu">aggregate_array</span>(<span class="st">&#39;ADM2_NAME&#39;</span>)</span>
<span id="cb86-26"><a href="#cb86-26" tabindex="-1"></a></span>
<span id="cb86-27"><a href="#cb86-27" tabindex="-1"></a><span class="co">// We define a function that will be called when the user selects a value</span></span>
<span id="cb86-28"><a href="#cb86-28" tabindex="-1"></a>admin2Names<span class="op">.</span><span class="fu">evaluate</span>(<span class="kw">function</span>(names){</span>
<span id="cb86-29"><a href="#cb86-29" tabindex="-1"></a>  <span class="kw">var</span> dropDown <span class="op">=</span> ui<span class="op">.</span><span class="fu">Select</span>({</span>
<span id="cb86-30"><a href="#cb86-30" tabindex="-1"></a>    <span class="dt">placeholder</span><span class="op">:</span> <span class="st">&#39;select a region&#39;</span><span class="op">,</span></span>
<span id="cb86-31"><a href="#cb86-31" tabindex="-1"></a>    <span class="dt">items</span><span class="op">:</span> names<span class="op">,</span></span>
<span id="cb86-32"><a href="#cb86-32" tabindex="-1"></a>    <span class="dt">onChange</span><span class="op">:</span> display</span>
<span id="cb86-33"><a href="#cb86-33" tabindex="-1"></a>  })</span>
<span id="cb86-34"><a href="#cb86-34" tabindex="-1"></a>  admin2Panel<span class="op">.</span><span class="fu">add</span>(dropDown)</span>
<span id="cb86-35"><a href="#cb86-35" tabindex="-1"></a>})</span>
<span id="cb86-36"><a href="#cb86-36" tabindex="-1"></a></span>
<span id="cb86-37"><a href="#cb86-37" tabindex="-1"></a><span class="kw">var</span> resultPanel <span class="op">=</span> ui<span class="op">.</span><span class="fu">Panel</span>()<span class="op">;</span></span>
<span id="cb86-38"><a href="#cb86-38" tabindex="-1"></a><span class="kw">var</span> areaLabel <span class="op">=</span> ui<span class="op">.</span><span class="fu">Label</span>()</span>
<span id="cb86-39"><a href="#cb86-39" tabindex="-1"></a>resultPanel<span class="op">.</span><span class="fu">add</span>(areaLabel)</span>
<span id="cb86-40"><a href="#cb86-40" tabindex="-1"></a></span>
<span id="cb86-41"><a href="#cb86-41" tabindex="-1"></a>mainPanel<span class="op">.</span><span class="fu">add</span>(resultPanel)<span class="op">;</span></span>
<span id="cb86-42"><a href="#cb86-42" tabindex="-1"></a></span>
<span id="cb86-43"><a href="#cb86-43" tabindex="-1"></a><span class="co">// This function will be called when the user changes the value in the dropdown</span></span>
<span id="cb86-44"><a href="#cb86-44" tabindex="-1"></a><span class="kw">var</span> display <span class="op">=</span> <span class="kw">function</span>(admin2Name) {</span>
<span id="cb86-45"><a href="#cb86-45" tabindex="-1"></a>  areaLabel<span class="op">.</span><span class="fu">setValue</span>(<span class="st">&#39;&#39;</span>)</span>
<span id="cb86-46"><a href="#cb86-46" tabindex="-1"></a>  <span class="kw">var</span> selected <span class="op">=</span> ee<span class="op">.</span><span class="fu">Feature</span>(</span>
<span id="cb86-47"><a href="#cb86-47" tabindex="-1"></a>    filtered<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;ADM2_NAME&#39;</span><span class="op">,</span> admin2Name))<span class="op">.</span><span class="fu">first</span>())</span>
<span id="cb86-48"><a href="#cb86-48" tabindex="-1"></a>  <span class="kw">var</span> geometry <span class="op">=</span> selected<span class="op">.</span><span class="fu">geometry</span>()</span>
<span id="cb86-49"><a href="#cb86-49" tabindex="-1"></a>  <span class="bu">Map</span><span class="op">.</span><span class="fu">clear</span>()</span>
<span id="cb86-50"><a href="#cb86-50" tabindex="-1"></a>  <span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(geometry<span class="op">,</span> {<span class="dt">color</span><span class="op">:</span> <span class="st">&#39;grey&#39;</span>}<span class="op">,</span> admin2Name)</span>
<span id="cb86-51"><a href="#cb86-51" tabindex="-1"></a>  <span class="bu">Map</span><span class="op">.</span><span class="fu">centerObject</span>(geometry<span class="op">,</span> <span class="dv">10</span>)</span>
<span id="cb86-52"><a href="#cb86-52" tabindex="-1"></a>  </span>
<span id="cb86-53"><a href="#cb86-53" tabindex="-1"></a>  <span class="kw">var</span> gswYearFiltered <span class="op">=</span> gswYearly<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;year&#39;</span><span class="op">,</span> <span class="dv">2020</span>))</span>
<span id="cb86-54"><a href="#cb86-54" tabindex="-1"></a>  <span class="kw">var</span> gsw2020 <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(gswYearFiltered<span class="op">.</span><span class="fu">first</span>())<span class="op">.</span><span class="fu">clip</span>(geometry)</span>
<span id="cb86-55"><a href="#cb86-55" tabindex="-1"></a>  <span class="kw">var</span> water2020 <span class="op">=</span> gsw2020<span class="op">.</span><span class="fu">eq</span>(<span class="dv">2</span>)<span class="op">.</span><span class="fu">or</span>(gsw2020<span class="op">.</span><span class="fu">eq</span>(<span class="dv">3</span>))<span class="op">.</span><span class="fu">rename</span>(<span class="st">&#39;water&#39;</span>)<span class="op">.</span><span class="fu">selfMask</span>()</span>
<span id="cb86-56"><a href="#cb86-56" tabindex="-1"></a>  </span>
<span id="cb86-57"><a href="#cb86-57" tabindex="-1"></a>  <span class="kw">var</span> visParams <span class="op">=</span> {<span class="dt">min</span><span class="op">:</span><span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span><span class="dv">1</span><span class="op">,</span> <span class="dt">palette</span><span class="op">:</span> [<span class="st">&#39;white&#39;</span><span class="op">,</span><span class="st">&#39;blue&#39;</span>]}</span>
<span id="cb86-58"><a href="#cb86-58" tabindex="-1"></a>  <span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(water2020<span class="op">,</span> visParams<span class="op">,</span> <span class="st">&#39;2020 Water&#39;</span>)</span>
<span id="cb86-59"><a href="#cb86-59" tabindex="-1"></a>  </span>
<span id="cb86-60"><a href="#cb86-60" tabindex="-1"></a>  <span class="kw">var</span> area <span class="op">=</span> water2020<span class="op">.</span><span class="fu">multiply</span>(ee<span class="op">.</span><span class="at">Image</span><span class="op">.</span><span class="fu">pixelArea</span>())<span class="op">.</span><span class="fu">reduceRegion</span>({</span>
<span id="cb86-61"><a href="#cb86-61" tabindex="-1"></a>    <span class="dt">reducer</span><span class="op">:</span> ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">sum</span>()<span class="op">,</span></span>
<span id="cb86-62"><a href="#cb86-62" tabindex="-1"></a>    <span class="dt">geometry</span><span class="op">:</span> geometry<span class="op">,</span></span>
<span id="cb86-63"><a href="#cb86-63" tabindex="-1"></a>    <span class="dt">scale</span><span class="op">:</span> <span class="dv">30</span><span class="op">,</span></span>
<span id="cb86-64"><a href="#cb86-64" tabindex="-1"></a>    <span class="dt">maxPixels</span><span class="op">:</span> <span class="fl">1e9</span></span>
<span id="cb86-65"><a href="#cb86-65" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb86-66"><a href="#cb86-66" tabindex="-1"></a>  </span>
<span id="cb86-67"><a href="#cb86-67" tabindex="-1"></a>  <span class="kw">var</span> waterArea <span class="op">=</span> ee<span class="op">.</span><span class="fu">Number</span>(area<span class="op">.</span><span class="fu">get</span>(<span class="st">&#39;water&#39;</span>))<span class="op">.</span><span class="fu">divide</span>(<span class="dv">10000</span>)<span class="op">.</span><span class="fu">round</span>()<span class="op">;</span></span>
<span id="cb86-68"><a href="#cb86-68" tabindex="-1"></a>  waterArea<span class="op">.</span><span class="fu">evaluate</span>(<span class="kw">function</span>(result) {</span>
<span id="cb86-69"><a href="#cb86-69" tabindex="-1"></a>    <span class="kw">var</span> text <span class="op">=</span> <span class="st">&#39;Surface Water Area 2020: &#39;</span> <span class="op">+</span> result <span class="op">+</span> <span class="st">&#39; Hectares&#39;</span></span>
<span id="cb86-70"><a href="#cb86-70" tabindex="-1"></a>    areaLabel<span class="op">.</span><span class="fu">setValue</span>(text)</span>
<span id="cb86-71"><a href="#cb86-71" tabindex="-1"></a>  })</span>
<span id="cb86-72"><a href="#cb86-72" tabindex="-1"></a>}</span>
<span id="cb86-73"><a href="#cb86-73" tabindex="-1"></a></span>
<span id="cb86-74"><a href="#cb86-74" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">setCenter</span>(<span class="fl">76.43</span><span class="op">,</span> <span class="fl">12.41</span><span class="op">,</span> <span class="dv">8</span>)</span>
<span id="cb86-75"><a href="#cb86-75" tabindex="-1"></a>ui<span class="op">.</span><span class="at">root</span><span class="op">.</span><span class="fu">add</span>(mainPanel)<span class="op">;</span></span></code></pre></div>
<div id="exercise-42" class="section level3">
<h3>Exercise</h3>
<p><a
href="https://code.earthengine.google.co.in/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3A07-Earth_Engine_Apps%2F03c_Performing_Calculations_(exercise)"
target="_blank">Try in Code Editor ↗</a></p>
<p>Before publishing your app, add your name as Author.</p>
<div class="sourceCode" id="cb87"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb87-1"><a href="#cb87-1" tabindex="-1"></a><span class="co">// Add a new panel called authorPanel</span></span>
<span id="cb87-2"><a href="#cb87-2" tabindex="-1"></a><span class="co">// Add a new label called authorLabel with your name</span></span>
<span id="cb87-3"><a href="#cb87-3" tabindex="-1"></a><span class="co">// Add the authorLabel to authorPanel</span></span>
<span id="cb87-4"><a href="#cb87-4" tabindex="-1"></a><span class="co">// Add the authorPanel to the mainPanel</span></span>
<span id="cb87-5"><a href="#cb87-5" tabindex="-1"></a><span class="co">// Test the app</span></span></code></pre></div>
</div>
</div>
</div>
<div id="supplement" class="section level1">
<h1>Supplement</h1>
<div id="drought-monitoring" class="section level2">
<h2>Drought Monitoring</h2>
<div id="pie-chart-group-statistics" class="section level3">
<h3>Pie Chart Group Statistics</h3>
<p>This section has been moved to the Supplement at <a
href="https://courses.spatialthoughts.com/gee-water-resources-management-supplement#pie-chart-group-statistics">Pie
Chart Group Statistics</a>.</p>
</div>
</div>
<div id="hydrology" class="section level2">
<h2>Hydrology</h2>
<div id="chart-cumulative-rainfall" class="section level3">
<h3>Chart Cumulative Rainfall</h3>
<p>This section has been moved to the Supplement at <a
href="https://courses.spatialthoughts.com/gee-water-resources-management-supplement#chart-cumulative-rainfall">Chart
Cumulative Rainfall</a>.</p>
</div>
<div id="exporting-precipitation-data" class="section level3">
<h3>Exporting Precipitation Data</h3>
<p>This section has been moved to the Supplement at <a
href="https://courses.spatialthoughts.com/gee-water-resources-management-supplement#exporting-precipitation-data">Exporting
Precipitation Data</a>.</p>
</div>
<div id="gpm-precipitation-time-series" class="section level3">
<h3>GPM Precipitation Time Series</h3>
<p>This section has been moved to the Supplement at <a
href="https://courses.spatialthoughts.com/gee-water-resources-management-supplement#gpm-precipitation-time-series">GPM
Precipitation Time Series</a>.</p>
</div>
<div id="imd-number-of-rainy-days" class="section level3">
<h3>IMD Number of Rainy Days</h3>
<p>This section has been moved to the Supplement at <a
href="https://courses.spatialthoughts.com/gee-water-resources-management-supplement#imd-number-of-rainy-days">IMD
Number of Rainy Days</a>.</p>
</div>
</div>
<div id="surface-water" class="section level2">
<h2>Surface Water</h2>
<div id="detect-first-year-of-water" class="section level3">
<h3>Detect First Year of Water</h3>
<p>This section has been moved to the Supplement at <a
href="https://courses.spatialthoughts.com/gee-water-resources-management-supplement#detect-first-year-of-water">Detect
First Year of Water</a>.</p>
</div>
<div id="otsu-dynamic-thresholding" class="section level3">
<h3>Otsu Dynamic Thresholding</h3>
<p>This section has been moved to the Supplement at <a
href="https://courses.spatialthoughts.com/gee-water-resources-management-supplement#otsu-dynamic-thresholding">Otsu
Dynamic Thresholding</a>.</p>
</div>
<div id="smoothing-vectors" class="section level3">
<h3>Smoothing Vectors</h3>
<p>This section has been moved to the Supplement at <a
href="https://courses.spatialthoughts.com/gee-water-resources-management-supplement#smoothing-vectors">Smoothing
Vectors</a>.</p>
</div>
<div id="surface-water-explorer-split-panel-app" class="section level3">
<h3>Surface Water Explorer Split Panel App</h3>
<p>This section has been moved to the Supplement at <a
href="https://courses.spatialthoughts.com/gee-water-resources-management-supplement#surface-water-explorer-split-panel-app">Surface
Water Explorer Split Panel App</a>.</p>
</div>
<div id="unsupervised-clustering-advanced" class="section level3">
<h3>Unsupervised Clustering Advanced</h3>
<p>This section has been moved to the Supplement at <a
href="https://courses.spatialthoughts.com/gee-water-resources-management-supplement#unsupervised-clustering-advanced">Unsupervised
Clustering Advanced</a>.</p>
</div>
</div>
<div id="sar" class="section level2">
<h2>SAR</h2>
<div id="sentinel-1-ard-pre-processing" class="section level3">
<h3>Sentinel-1 ARD Pre-Processing</h3>
<p>This section has been moved to the Supplement at <a
href="https://courses.spatialthoughts.com/gee-water-resources-management-supplement#sentinel-1-ard-pre-processing">Sentinel-1
ARD Pre-Processing</a>.</p>
</div>
</div>
<div id="time-series-analysis" class="section level2">
<h2>Time Series Analysis</h2>
<div id="mann-kendall-test" class="section level3">
<h3>Mann Kendall Test</h3>
<p>This section has been moved to the Supplement at <a
href="https://courses.spatialthoughts.com/gee-water-resources-management-supplement#mann-kendall-test">Mann
Kendall Test</a>.</p>
</div>
</div>
</div>
<div id="data-credits" class="section level1">
<h1>Data Credits</h1>
<ul>
<li><p><strong>Sentinel-2 Level-1C, Level-2A</strong> and
<strong>Sentinel-1 SAR GRD</strong>: Contains Copernicus Sentinel
data.</p></li>
<li><p><strong>TerraClimate: Monthly Climate and Climatic Water Balance
for Global Terrestrial Surfaces, University of Idaho</strong>:
Abatzoglou, J.T., S.Z. Dobrowski, S.A. Parks, K.C. Hegewisch, 2018,
Terraclimate, a high-resolution global dataset of monthly climate and
climatic water balance from 1958-2015, Scientific Data 5:170191, <a
href="doi:10.1038/sdata.2017.191"
class="uri">doi:10.1038/sdata.2017.191</a></p></li>
<li><p><strong>FAO GAUL 500m: Global Administrative Unit Layers 2015,
Second-Level Administrative Units</strong>: Source of Administrative
boundaries: The Global Administrative Unit Layers (GAUL) dataset,
implemented by FAO within the CountrySTAT and Agricultural Market
Information System (AMIS) projects.</p></li>
<li><p><strong>CHIRPS Pentad: Climate Hazards Group InfraRed
Precipitation with Station Data (version 2.0 final)</strong>: Funk,
Chris, Pete Peterson, Martin Landsfeld, Diego Pedreros, James Verdin,
Shraddhanand Shukla, Gregory Husak, James Rowland, Laura Harrison,
Andrew Hoell &amp; Joel Michaelsen. “The climate hazards infrared
precipitation with stations—a new environmental record for monitoring
extremes”. Scientific Data 2, 150066. <a
href="doi:10.1038/sdata.2015.66"
class="uri">doi:10.1038/sdata.2015.66</a> 2015.</p></li>
<li><p><strong>MOD13Q1.006 Terra Vegetation Indices 16-Day Global
250m</strong>: Didan, K. (2015). <i>MOD13Q1 MODIS/Terra Vegetation
Indices 16-Day L3 Global 250m SIN Grid V006</i> [Data set]. NASA EOSDIS
Land Processes DAAC. Accessed 2021-05-06 from <a
href="https://doi.org/10.5067/MODIS/MOD13Q1.006"
class="uri">https://doi.org/10.5067/MODIS/MOD13Q1.006</a></p></li>
</ul>
</div>
<div id="license" class="section level1">
<h1>License</h1>
<p>The course material (text, images, presentation, videos) is licensed
under a <a href="https://creativecommons.org/licenses/by/4.0/">Creative
Commons Attribution 4.0 International License</a>.</p>
<p>The code (scripts, Jupyter notebooks) is licensed under the MIT
License. For a copy, see <a href="https://opensource.org/licenses/MIT"
class="uri">https://opensource.org/licenses/MIT</a></p>
<p>Kindly give appropriate credit to the original author as below:</p>
<p>Copyright © 2021 Ujaval Gandhi <a
href="https://spatialthoughts.com">www.spatialthoughts.com</a></p>
</div>
<div id="citing-and-referencing" class="section level1">
<h1>Citing and Referencing</h1>
<p>You can cite the course materials as follows</p>
<ul>
<li>Gandhi, Ujaval, 2021. <em>Google Earth Engine for Water Resources
Management</em> Course. Spatial Thoughts. <a
href="https://courses.spatialthoughts.com/gee-water-resources-management.html"
class="uri">https://courses.spatialthoughts.com/gee-water-resources-management.html</a></li>
</ul>
<hr />
<p><strong>This course is offered as an instructor-led online class.
Visit <a href="https://spatialthoughts.com/events/">Spatial Thoughts</a>
to know details of upcoming sessions.</strong></p>
</div>

<!-- Comment Section Powered by utterances -->
<div id="comments">
  <hr />
  <p>If you want to report any issues with this page, please comment below.</p>
<script src="https://utteranc.es/client.js"
        repo="spatialthoughts/courses"
        issue-term="title"
        label="comment"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>
</div>



</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.odd').parent('tbody').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open');
  });
});
</script>

<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
