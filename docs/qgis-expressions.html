<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />


<meta name="author" content="Ujaval Gandhi" />


<title>QGIS Expressions Masterclass (Workshop Material)</title>

<script src="site_libs/header-attrs-2.29/header-attrs.js"></script>
<script src="site_libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/flatly.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<style>h1 {font-size: 34px;}
       h1.title {font-size: 38px;}
       h2 {font-size: 30px;}
       h3 {font-size: 24px;}
       h4 {font-size: 18px;}
       h5 {font-size: 16px;}
       h6 {font-size: 12px;}
       code {color: inherit; background-color: rgba(0, 0, 0, 0.04);}
       pre:not([class]) { background-color: white }</style>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<link href="site_libs/pagedtable-1.1/css/pagedtable.css" rel="stylesheet" />
<script src="site_libs/pagedtable-1.1/js/pagedtable.js"></script>
<style>
.copy-btn {
  position: absolute;
  top: 5px;
  right: 5px;
  padding: 4px 8px;
  font-size: 18px;
  background: #969696;
  color: white;
  border: none;
  border-radius: 3px;
  cursor: pointer;
  opacity: 0.7;
  transition: opacity 0.3s;
}

.copy-btn:hover {
  opacity: 1;
}

.copy-btn.copied {
  background: #636363;
}

pre {
  position: relative;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Find all code blocks
  const codeBlocks = document.querySelectorAll('pre code');
  
  codeBlocks.forEach(function(codeBlock) {
    const pre = codeBlock.parentElement;
    
    // Create copy button
    const button = document.createElement('button');
    button.className = 'copy-btn';
    button.textContent = '⎘';
    
    // Add button to pre element
    pre.appendChild(button);
    
    // Add click event
    button.addEventListener('click', function() {
      // Create temporary textarea to copy text
      const textarea = document.createElement('textarea');
      textarea.value = codeBlock.textContent;
      document.body.appendChild(textarea);
      textarea.select();
      document.execCommand('copy');
      document.body.removeChild(textarea);
      
      // Update button text
      button.textContent = 'Copied!';
      button.classList.add('copied');
      
      // Reset button after 2 seconds
      setTimeout(function() {
        button.textContent = '⎘';
        button.classList.remove('copied');
      }, 2000);
    });
  });
});
</script>

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>










<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
details > summary > p:only-child {
  display: inline;
}
pre code {
  padding: 0;
}
</style>


<style type="text/css">
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #adb5bd;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script type="text/javascript">
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark the anchor link active (and if it's in a dropdown, also mark that active)
  var dropdown = menuAnchor.closest('li.dropdown');
  if (window.bootstrap) { // Bootstrap 4+
    menuAnchor.addClass('active');
    dropdown.find('> .dropdown-toggle').addClass('active');
  } else { // Bootstrap 3
    menuAnchor.parent().addClass('active');
    dropdown.addClass('active');
  }

  // Navbar adjustments
  var navHeight = $(".navbar").first().height() + 15;
  var style = document.createElement('style');
  var pt = "padding-top: " + navHeight + "px; ";
  var mt = "margin-top: -" + navHeight + "px; ";
  var css = "";
  // offset scroll position for anchor links (for fixed navbar)
  for (var i = 1; i <= 6; i++) {
    css += ".section h" + i + "{ " + pt + mt + "}\n";
  }
  style.innerHTML = "body {" + pt + "padding-bottom: 40px; }\n" + css;
  document.head.appendChild(style);
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before, .tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "\e259";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "\e258";
  font-family: 'Glyphicons Halflings';
  border: none;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->




</head>

<body>


<div class="container-fluid main-container">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-bs-toggle="collapse" data-target="#navbar" data-bs-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">Courses</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="http://spatialthoughts.com">Back to Main Site</a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li>
  <a href="#">Back to Top</a>
</li>
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div id="header">



<h1 class="title toc-ignore">QGIS Expressions Masterclass (Workshop
Material)</h1>
<h3 class="subtitle">Learn QGIS expressions from the ground up.</h3>
<h4 class="author">Ujaval Gandhi</h4>

</div>

<div id="TOC">
<ul>
<li><a href="#introduction" id="toc-introduction">Introduction</a></li>
<li><a href="#software" id="toc-software">Software</a></li>
<li><a href="#get-the-data-package" id="toc-get-the-data-package">Get
the Data Package</a></li>
<li><a href="#get-the-workshop-video"
id="toc-get-the-workshop-video">Get the Workshop Video</a>
<ul>
<li><a href="#youtube" id="toc-youtube">YouTube</a></li>
<li><a href="#vimeo" id="toc-vimeo">Vimeo</a></li>
</ul></li>
<li><a href="#operators-and-conditionals"
id="toc-operators-and-conditionals">1. Operators and Conditionals</a>
<ul>
<li><a href="#challenge-1" id="toc-challenge-1">Challenge 1</a></li>
</ul></li>
<li><a href="#functions" id="toc-functions">2. Functions</a>
<ul>
<li><a href="#challenge-2" id="toc-challenge-2">Challenge 2</a></li>
</ul></li>
<li><a href="#geometries" id="toc-geometries">3. Geometries</a>
<ul>
<li><a href="#challenge-3" id="toc-challenge-3">Challenge 3</a></li>
</ul></li>
<li><a href="#iteration" id="toc-iteration">4. Iteration</a>
<ul>
<li><a href="#challenge-4" id="toc-challenge-4">Challenge 4</a></li>
</ul></li>
<li><a href="#quiz" id="toc-quiz">Quiz</a></li>
<li><a href="#supplement" id="toc-supplement">Supplement</a>
<ul>
<li><a href="#saving-and-sharing-expressions"
id="toc-saving-and-sharing-expressions">Saving and Sharing
Expressions</a></li>
</ul></li>
<li><a href="#data-credits" id="toc-data-credits">Data Credits</a></li>
<li><a href="#license" id="toc-license">License</a></li>
</ul>
</div>

<div style="page-break-after: always;"></div>
<hr />
<p><img src="images/spatial_thoughts_logo.png" width="250pt" style="display: block; margin: auto;" /></p>
<hr />
<div style="page-break-after: always;"></div>
<div id="introduction" class="section level1">
<h1>Introduction</h1>
<p>Expressions are one of the most powerful features of QGIS. In this
hands-on workshop, we will start from the basics of expression syntax
and you will learn how to solve complex problems by combining the basic
building blocks.</p>
<p>This workshop requires basic working knowledge of QGIS.</p>
<p><a href="https://www.youtube.com/watch?v=x3i9qyFGgcQ"
target="_blank"><img
src="https://img.youtube.com/vi/x3i9qyFGgcQ/mqdefault.jpg"
alt="Watch the video" /></a></p>
<p><a href="https://www.youtube.com/watch?v=x3i9qyFGgcQ"
target="_blank">Watch the Video ↗</a></p>
<p><a
href="https://docs.google.com/presentation/d/1Gv4jZpgMdGR4cvtQxCdf-509CRXNrxuDFW0IXmAug3k/edit?usp=sharing"
target="_blank">Access the Presentation ↗</a></p>
</div>
<div id="software" class="section level1">
<h1>Software</h1>
<p>This workshop requires QGIS LTR version 3.40.</p>
<p>Please review <a href="install-qgis-ltr.html">QGIS-LTR Installation
Guide</a> for step-by-step instructions.</p>
</div>
<div id="get-the-data-package" class="section level1">
<h1>Get the Data Package</h1>
<p>The code examples in this workshop use a variety of datasets. All the
required layers, project files etc. are supplied to you in the zip file
<code>qgis-expressions.zip</code>. Unzip this file to the
<code>Downloads</code> directory.</p>
<p>The data package also comes with a <code>solutions</code> folder that
contains model solutions for each section.</p>
<p>Download <a
href="https://github.com/spatialthoughts/courses/releases/download/data/qgis_expressions.zip">qgis-expressions.zip</a>.</p>
</div>
<div id="get-the-workshop-video" class="section level1">
<h1>Get the Workshop Video</h1>
<p>The course is accompanied by a video covering the all the sections
This video is recorded from our live webinar class and is edited to make
them easier to consume for self-study. We have 2 versions of the
videos:</p>
<div id="youtube" class="section level2">
<h2>YouTube</h2>
<p>The video on YouTube is ideal for online learning and sharing. You
may also turn on <em>Subtitles/closed-captions</em> and adjust the
playback speed to suit your preference. <a
href="https://youtu.be/x3i9qyFGgcQ" target="_blank">Access the YouTube
Video ↗</a></p>
</div>
<div id="vimeo" class="section level2">
<h2>Vimeo</h2>
<p>We have also made full-length video available on Vimeo. This video
can be downloaded for offline learning. <a
href="https://vimeo.com/1092994757?share=copy" target="_blank">Access
the Vimeo Video ↗</a></p>
</div>
</div>
<div id="operators-and-conditionals" class="section level1">
<h1>1. Operators and Conditionals</h1>
<p>In this section, we will learn about operators and conditions used in
QGIS expressions and learn how to use them to select and extract
features from layers.</p>
<ol style="list-style-type: decimal">
<li>Open QGIS. Navigate to the folder containing the data package.
Locate and open the <strong>Power_Plants</strong> project. This project
contains 2 data layers. A point layer named <code>power_plants</code>
containing locations of all power plants in the world and a polygon
layer named <code>admin1</code> with states/province boundaries for all
countries.</li>
</ol>
<p><img src="images/qgis_expressions/operator1.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="2" style="list-style-type: decimal">
<li>Select the <code>power_plants</code> layer and click <em>Open
Attribute Table</em> button. You will see that the layer as a column
named <code>primary_fuel</code> describing the primary energy source
used in electricity generation. We can use this to select different
types of power plants.</li>
</ol>
<p><img src="images/qgis_expressions/operator2.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="3" style="list-style-type: decimal">
<li>We will now use an expressions to select features from this layer.
From the <em>Selection Toolbar</em>, click the <em>Select Features by
Expression…</em> button.</li>
</ol>
<p><img src="images/qgis_expressions/operator3.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="4" style="list-style-type: decimal">
<li>In the <em>Expression</em> dialog, locate the
<strong>primary_fuel</strong> attribute under <em>Fields and Values</em>
group. Double-click to add it to the expression. While the field is
selected, click the <em>All Unique</em> button to show all unique values
contained in that field. Here we want to select all Coal power plants,
so enter the expression as below and click <em>Select
Features</em>.</li>
</ol>
<pre><code>&quot;primary_fuel&quot; = &#39;Coal&#39;</code></pre>
<p><img src="images/qgis_expressions/operator4.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="5" style="list-style-type: decimal">
<li>In the main QGIS window, you will see the features matching the
expression selected in yellow color. We could select all Coal power
plants. What if we want to select all power plants that use renewable
energy source? We need to be able to specify multiple fuel types for the
query. Let’s update the expression. From the <em>Selection Toolbar</em>,
click the <em>Select Features by Expression…</em> again.</li>
</ol>
<p><img src="images/qgis_expressions/operator5.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="6" style="list-style-type: decimal">
<li>We can use the <strong>IN</strong> operator to specify a list of
fuel types that we want to select. Enter the following expression and
click <em>Select Features</em>.</li>
</ol>
<pre><code>&quot;primary_fuel&quot; IN (&#39;Biomass&#39;, &#39;Geothermal&#39;, &#39;Hydro&#39;, &#39;Solar&#39;, &#39;Wind&#39;, &#39;Storage&#39;, &#39;Wave and Tidal&#39;)</code></pre>
<p><img src="images/qgis_expressions/operator6.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="7" style="list-style-type: decimal">
<li>You will now see all power plants with renewable fuel types
selected. Click the <em>Deselect Features from All Layers</em>
button.</li>
</ol>
<p><img src="images/qgis_expressions/operator7.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="8" style="list-style-type: decimal">
<li>Next, we will learn how we can use expressions to extract certain
features into a new layer. Open the Processing Toolbox from
<strong>Processing → Toolbox</strong>. Search and locate the algorithm
<strong>Vector selection → Extract by expression</strong> and
double-click to launch it.</li>
</ol>
<p><img src="images/qgis_expressions/operator8.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="9" style="list-style-type: decimal">
<li>In the <em>Vector Selection - Extract by Expression</em> dialog,
select <code>power_plants</code> as the <em>Input layer</em>. Click the
<em>Expression</em> button.</li>
</ol>
<p><img src="images/qgis_expressions/operator9.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="10" style="list-style-type: decimal">
<li>Enter the following expression to extract all hydro power plants and
click <em>OK</em>.</li>
</ol>
<pre><code>&quot;primary_fuel&quot; = &#39;Hydro&#39;</code></pre>
<p><img src="images/qgis_expressions/operator10.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="11" style="list-style-type: decimal">
<li>Click the <em>…</em> next to <em>Matching Features</em> and select
<strong>Save to File…</strong>. Enter the name of the output file as
<code>hydro_power_plants.gpkg</code> and click <em>Run</em>.</li>
</ol>
<p><img src="images/qgis_expressions/operator11.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="12" style="list-style-type: decimal">
<li>Once the processing finishes, a new layer
<code>hydro_power_plants</code> will be added to the <em>Layers</em>
panel. Open the attribute table and verify that all the power plants
have <em>Hydro</em> as the <code>primary_fuel</code>. Next, we will
learn how to classify these power plants based on their capacity. The
column <code>capacity_mw</code> has electrical generating capacity in
megawatts. You may now turn off the visibility of the
<code>power_plants</code> layer.</li>
</ol>
<p><img src="images/qgis_expressions/operator12.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="13" style="list-style-type: decimal">
<li>Select the <code>hydro_power_plants</code> layer. From the
Processing Toolbox, search and locate the algorithm <strong>Vector table
→ Field calculator</strong> and double-click to launch it.</li>
</ol>
<p><img src="images/qgis_expressions/operator13.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="14" style="list-style-type: decimal">
<li>In the <em>Vector Table - Field Calculator</em> dialog, select
<code>hydro_power_plants</code> as the <em>Input Layer</em>. Enter
<strong>classification</strong> as the <em>Field name</em>. Keep
<strong>Text (string)</strong> as the <em>Result field type</em>.</li>
</ol>
<p><img src="images/qgis_expressions/operator14.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="15" style="list-style-type: decimal">
<li>We want to assign one of the categories from Small, Medium and Large
to each power plant based on the capacity. We can use the
<code>CASE</code> statement to assign different values based on
different conditions. Enter the following expression.</li>
</ol>
<pre><code>CASE
WHEN  &quot;capacity_mw&quot; &lt; 25 THEN &#39;Small&#39;
WHEN  &quot;capacity_mw&quot; &gt;= 25 AND  &quot;capacity_mw&quot; &lt;= 100 THEN &#39;Medium&#39;
WHEN  &quot;capacity_mw&quot; &gt; 100 THEN &#39;Large&#39;
END</code></pre>
<p><img src="images/qgis_expressions/operator15.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="16" style="list-style-type: decimal">
<li>Click the <em>…</em> next to <em>Calculated</em> and select
<strong>Save to File…</strong>. Enter the name of the output file as
<code>hydro_power_plants_classification.gpkg</code> and click
<em>Run</em>.</li>
</ol>
<p><img src="images/qgis_expressions/operator16.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="17" style="list-style-type: decimal">
<li>Once the processing finishes, a new layer
<code>hydro_power_plants_classification</code> will be added to the
<em>Layers</em> panel. Open the attribute table and see the assigned
values in the <em>classification</em> column.</li>
</ol>
<p><img src="images/qgis_expressions/operator17.png" width="75%" style="display: block; margin: auto;" /></p>
<p>We have now finished the first part of this exercise. You can load
the <code>Power_Plants_CheckPoint1.qgz</code> project in the
<code>solutions</code> folder to catch up to this point and do the
challenge.</p>
<div id="challenge-1" class="section level2">
<h2>Challenge 1</h2>
<p>Create a new layer containing only the <strong>Large</strong> hydro
power plants in your country. The <code>country</code> column contains
3-digit ISO codes for each country. Pick a country and build an
expression to extract the features.</p>
<p><img src="images/qgis_expressions/challenge1.png" width="75%" style="display: block; margin: auto;" /></p>
</div>
</div>
<div id="functions" class="section level1">
<h1>2. Functions</h1>
<p>We will now learn how to use the expression functions for spatial
analysis. Our goal will be to get a list of hydro power plants and the
total installed capacity for each admin1 region in a country.</p>
<ol style="list-style-type: decimal">
<li>Continuing from the previous section, remove all layers except the
<code>admin1</code> and <code>hydro_power_plants_classification</code>
layers. We will now apply a filter to each of these layers to keep only
the features for our chosen country. Right=click the
<code>hydro_power_plants_classification</code> layer and choose
<em>Filter…</em>.</li>
</ol>
<p><img src="images/qgis_expressions/functions1.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="2" style="list-style-type: decimal">
<li>In the <em>Query Builder</em> dialog, enter the following expression
and click <em>OK</em>. You may replace <strong>SWE</strong> with the
3-digit ISO code for your country.</li>
</ol>
<pre><code>&quot;country&quot; = &#39;SWE&#39;</code></pre>
<p><img src="images/qgis_expressions/functions2.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="3" style="list-style-type: decimal">
<li>Next, right-click the <code>admin1</code> layer and select
<em>Filter…</em>.</li>
</ol>
<p><img src="images/qgis_expressions/functions3.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="4" style="list-style-type: decimal">
<li>In the <em>Query Builder</em> dialog, enter the following expression
and click <em>OK</em>.</li>
</ol>
<pre><code>&quot;adm0_a3&quot; = &#39;SWE&#39;</code></pre>
<p><img src="images/qgis_expressions/functions4.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="5" style="list-style-type: decimal">
<li>Both the layers now have an active filter applied to them and you
should only see features for the chosen country. Select the
<code>hydro_power_plants_classification</code> layer and open the
Attribute Table. Note that the column <code>name</code> contains the
name of the power plant and the column <code>capacity_mw</code> contains
the power generation capacity.</li>
</ol>
<p><img src="images/qgis_expressions/functions5.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="6" style="list-style-type: decimal">
<li>Select the <code>admin1</code> layer and open the Processing Toolbox
from <strong>Processing → Toolbox</strong>. Search and locate the
algorithm <strong>Vector table → Field calculator</strong> and
double-click to launch it.</li>
</ol>
<p><img src="images/qgis_expressions/functions6.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="7" style="list-style-type: decimal">
<li>In the <em>Vector Table - Field Calculator</em> dialog, select
<code>admin1</code> as the <em>Input Layer</em>. Enter
<strong>power_plants_list</strong> as the <em>Field name</em>. Select
<strong>Text (string)</strong> as the <em>Result field type</em>.</li>
</ol>
<p><img src="images/qgis_expressions/functions7.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="8" style="list-style-type: decimal">
<li>We want to find the names of all power plant features intersecting
each admin1 polygon. The <code>overlay_intersect()</code> function
allows you to locate intersecting features from another layer. Enter the
following expression.</li>
</ol>
<pre><code>overlay_intersects(
  layer:=&#39;hydro_power_plants_classification&#39;,
  expression:=&quot;name&quot;
)</code></pre>
<p><img src="images/qgis_expressions/functions8.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="9" style="list-style-type: decimal">
<li>In the <em>Preview</em> below the expression, you can see the output
is a list of matching power plants for admin1 region. To save this list
to the output layer, we need to convert it to a string. We can use the
<code>array_to_string()</code> function to turn the list into a string
with comma-separated values. Update the expression as follows.</li>
</ol>
<pre><code>array_to_string(
  overlay_intersects(
    layer:=&#39;hydro_power_plants_classification&#39;,
    expression:=&quot;name&quot;
  )
)</code></pre>
<p><img src="images/qgis_expressions/functions9.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="10" style="list-style-type: decimal">
<li>Click the <em>…</em> next to <em>Calculated</em> and select
<strong>Save to File…</strong>. Enter the name of the output file as
<code>admin1_power_plant_list.gpkg</code> and click <em>Run</em>.</li>
</ol>
<p><img src="images/qgis_expressions/functions10.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="11" style="list-style-type: decimal">
<li>Once the processing finishes, a new layer
<code>admin1_power_plant_list</code> will be added to the
<em>Layers</em> panel. Open the attribute table and verify that the
<em>power_plants_list</em> has the list of intersecting power plant
names. Next, we will add another column with the total capacity for each
region. Open the <strong>Vector table → Field calculator</strong>
algorithm from the Processing Toolbox.</li>
</ol>
<p><img src="images/qgis_expressions/functions11.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="12" style="list-style-type: decimal">
<li>In the <em>Vector Table - Field Calculator</em> dialog, select
<code>admin1_power_plant_list</code> as the <em>Input Layer</em>. Enter
<strong>total_hydro_capacity</strong> as the <em>Field name</em>. Select
<strong>Decimal (double)</strong> as the <em>Result field
type</em>.</li>
</ol>
<p><img src="images/qgis_expressions/functions12.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="13" style="list-style-type: decimal">
<li>Similar to the previous step, we can use the
<code>overlay_intersects()</code> function to get a list of values for
the <em>capacity_mw</em> attribute for all intersecting power plant
features. As we want to calculate the total capacity, we can use the
<code>array_sum()</code> function to calculate the total. Enter the
following expression.</li>
</ol>
<pre><code>array_sum(
  overlay_intersects(
    layer:=&#39;hydro_power_plants_classification&#39;,
    expression:=&quot;capacity_mw&quot;
  )
)</code></pre>
<p><img src="images/qgis_expressions/functions13.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="14" style="list-style-type: decimal">
<li>Click the <em>…</em> next to <em>Calculated</em> and select
<strong>Save to File…</strong>. Enter the name of the output file as
<code>admin1_power_plant_capacity.gpkg</code> and click
<em>Run</em>.</li>
</ol>
<p><img src="images/qgis_expressions/functions14.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="15" style="list-style-type: decimal">
<li>Once the processing finishes, a new layer
<code>hydro_power_plant_capacity</code> will be added to the
<em>Layers</em> panel. Open the attribute table and you will notice that
the <em>total_hydro_capacity</em> has the sum of the capacities of all
hydro power plants within each region.</li>
</ol>
<p><img src="images/qgis_expressions/functions15.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="16" style="list-style-type: decimal">
<li>We are done with the analysis, but often times it i desirable to
share the results with others in a non-spatial format. We will not clean
up our output and save the data as a spreadsheet. Search and locate the
<strong>Vector table → Refactor fields</strong> algorithm and
double-click to launch it.</li>
</ol>
<p><img src="images/qgis_expressions/functions16.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="17" style="list-style-type: decimal">
<li>Our attribute table contains over 100 columns. We can delete most of
them and only keep a few columns in the output. In the <em>Fields
mapping</em> section, hold the <em>Shift</em> key and click on the row
numbers to select them. Once selected, click the <em>Delete selected
field</em> button to remove it from the output.</li>
</ol>
<p><img src="images/qgis_expressions/functions17.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="18" style="list-style-type: decimal">
<li>For the final output, only keep the <code>name</code>,
<code>power_plants_list</code> and <code>total_hydro_capacity</code>
fields. Click the <em>…</em> next to <em>Refactored</em> and select
<strong>Save to File…</strong>.</li>
</ol>
<p><img src="images/qgis_expressions/functions18.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="19" style="list-style-type: decimal">
<li>In the <em>Save file</em> dialog, choose **XLSX files (*.xlsx)** as
the <em>Save as type</em>. Enter the name of the output file as
<code>admin1_hydro_power_plant_data</code> and click <em>Save</em>.</li>
</ol>
<p><img src="images/qgis_expressions/functions19.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="20" style="list-style-type: decimal">
<li>Un-check the <em>Open output file after running algorithm</em> box
and click <em>Run</em>.</li>
</ol>
<p><img src="images/qgis_expressions/functions20.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="21" style="list-style-type: decimal">
<li>Once the processing finishes, open the resulting spreadsheet in
Excel or Open Office Calc to see the output.</li>
</ol>
<p><img src="images/qgis_expressions/functions21.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="22" style="list-style-type: decimal">
<li>Back in QGIS, we are ready to do the next challenge.</li>
</ol>
<p><img src="images/qgis_expressions/functions22.png" width="75%" style="display: block; margin: auto;" /></p>
<p>You can load the <code>Power_Plants_CheckPoint2.qgz</code> project in
the <code>solutions</code> folder to catch up to this point and do the
challenge.</p>
<div id="challenge-2" class="section level2">
<h2>Challenge 2</h2>
<p>Add a new column <strong>power_plant_count</strong> with the total
number of hydro power plants in each admin1 region.</p>
<p>Hint: Look under the <code>array_</code> section to find a suitable
function for calculating number of items in a list.</p>
</div>
</div>
<div id="geometries" class="section level1">
<h1>3. Geometries</h1>
<p>In this section, we will learn how to create and manipulate feature
geometry using expressions. The QGIS expression engine comes with a
large number of functions that can be used to create, update, transform
geometries of features.</p>
<ol style="list-style-type: decimal">
<li>Locate and open the <strong>Nearest_Neighbor</strong> project. This
project contains 2 point layers. The layer <code>schools</code> has the
locations schools and the layer <code>colleges</code> has locations of
all the colleges in the state of Kerala, India. Our goal for this
section is to connect each school point to the nearest college point
with a line.</li>
</ol>
<p><img src="images/qgis_expressions/geometry1.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="2" style="list-style-type: decimal">
<li>Select the <code>schools</code> layer and click the <em>Open the
Layer Styling Panel</em> button. The layer is styled using the
<strong>Simple Marker</strong> symbol layer. Click the <em>Add symbol
layer</em> / <em>+</em> button.</li>
</ol>
<p><img src="images/qgis_expressions/geometry2.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="3" style="list-style-type: decimal">
<li>A new symbol layer of type <strong>Simple Marker</strong> will be
added. Click on the dropdown next to <em>Symbol layer type</em> and
choose <strong>Geometry Generator</strong> as the <em>Symbol layer
type</em>.</li>
</ol>
<p><img src="images/qgis_expressions/geometry3.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="4" style="list-style-type: decimal">
<li><em>Geometry Generator</em> is a special layer type that allows us
to write an expression to create new geometries and render them
on-the-fly with chosen symbology. As we want to create and render a
line, choose <strong>LineString / MultiLineString</strong> as the
<em>Geometry type</em>. Next, click the <em>Expression</em> button.</li>
</ol>
<p><img src="images/qgis_expressions/geometry4.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="5" style="list-style-type: decimal">
<li>We want to find the nearest college to each school feature. The
<code>overlay_nearest()</code> function allows us to find nearest
features from another layer. We build an expression to find the
<code>@geometry</code> of the nearest college and then use the
<code>make_line()</code> function to create a line from the school point
to the nearest college point. Enter the following expression and click
<em>OK</em>.</li>
</ol>
<pre><code>make_line(
    @geometry,
    overlay_nearest(
        layer:=&#39;colleges&#39;,
        expression:=@geometry,
        limit:=1
    )
)</code></pre>
<p><img src="images/qgis_expressions/geometry5.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="6" style="list-style-type: decimal">
<li>You will see the map update and show lines connecting each school
feature to the nearest college. These lines are being constructed and
rendered on-the-fly using the specified expression. The underlying
data-source does not change in any way. Geometry Generator symbol layers
are particularly useful for such applications to dynamically visualize
the data in a different way. Let’s update the expression. Click the
<em>Expression</em> button.</li>
</ol>
<p><img src="images/qgis_expressions/geometry6.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="7" style="list-style-type: decimal">
<li>The <code>overlay_nearest()</code> function has an optional
parameter <code>max_distance</code> that allows us to specify the
maximum search distance and only return the feature from another layer
within the specified distance. Let’s update the expression to find the
nearest college within 5km (5000 meters) distance.</li>
</ol>
<pre><code>make_line(
    @geometry,
    overlay_nearest(
        layer:=&#39;colleges&#39;,
        expression:=@geometry,
        limit:=1,
        max_distance:=5000
    )
)</code></pre>
<p><img src="images/qgis_expressions/geometry7.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="8" style="list-style-type: decimal">
<li>The map will update to show the line connections only between
schools and colleges within 5km distance.</li>
</ol>
<p><img src="images/qgis_expressions/geometry8.png" width="75%" style="display: block; margin: auto;" /></p>
<p>We have now finished this section. You can load the
<code>Nearest_Neighbor_CheckPoint1.qgz</code> project in the
<code>solutions</code> folder to catch up to this point and do the
challenge.</p>
<div id="challenge-3" class="section level2">
<h2>Challenge 3</h2>
<p>The Processing Toolbox comes with a handy tool called <em>Geometry by
expression</em>. This algorithm allows you to take an input layer and
create a new layer by transforming the geometries using expression. Use
this tool to create a new layer
<code>schools_with_nearest_college.gpkg</code> showing the connections
from school points to the nearest college.</p>
<p><img src="images/qgis_expressions/challenge3.png" width="75%" style="display: block; margin: auto;" /></p>
</div>
</div>
<div id="iteration" class="section level1">
<h1>4. Iteration</h1>
<p>The QGIS expression engine has array functions that allow you to
iterate and process each item from the array using expressions. This
enables some very powerful use-cases. In this section we will explore
the <code>array_foreach()</code> and <code>array_filter()</code>
functions.</p>
<ol style="list-style-type: decimal">
<li>Continuing from the previous section, select the
<code>schools</code> layer and open the <strong>Vector table → Field
calculator</strong> algorithm from the Processing Toolbox.</li>
</ol>
<p><img src="images/qgis_expressions/iteration1.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="2" style="list-style-type: decimal">
<li>In the <em>Vector Table - Field Calculator</em> dialog, select
<code>schools</code> as the <em>Input Layer</em>. Enter
<strong>colleges</strong> as the <em>Field name</em>. Select
<strong>Text (string)</strong> as the <em>Result field type</em>.</li>
</ol>
<p><img src="images/qgis_expressions/iteration2.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="3" style="list-style-type: decimal">
<li>We want to get the list of college names within 5km of each school.
Enter the following expression and see the output shown in the
<em>Preview</em>.</li>
</ol>
<pre><code>overlay_nearest(
    layer:=&#39;colleges&#39;,
    expression:=&quot;collegename&quot;,
    max_distance:=5000,
    limit:=-1
)</code></pre>
<p><img src="images/qgis_expressions/iteration3.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="4" style="list-style-type: decimal">
<li>Let’s say we want to convert each name to title case. We can use the
<code>array_foreach()</code> function which allows us to run an
expression on each item. Within the function, you refer to each item in
the array with the variable <code>@element</code>. Update the expression
as below.</li>
</ol>
<pre><code>array_foreach(
    overlay_nearest(
        layer:=&#39;colleges&#39;,
        expression:=&quot;collegename&quot;,
        max_distance:=5000,
        limit:=-1
    ),
    title(@element)
)</code></pre>
<p><img src="images/qgis_expressions/iteration4.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="5" style="list-style-type: decimal">
<li>Before saving the results, let’s convert the resulting array to a
comma-separated string. Update the expression as shown below and click
the <em>…</em> next to <em>Calculated</em> and select <strong>Save to
File…</strong>. Enter the name of the output file as
<code>nearest_colleges.gpkg</code> and click <em>Run</em>.</li>
</ol>
<pre><code>array_to_string(
    array_foreach(
        overlay_nearest(
            layer:=&#39;colleges&#39;,
            expression:=&quot;collegename&quot;,
            max_distance:=5000,
            limit:=-1
        ),
        title(@element)
    )
)</code></pre>
<p><img src="images/qgis_expressions/iteration5.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="6" style="list-style-type: decimal">
<li>Once the processing finishes, a new layer
<code>nearest_colleges</code> will be added to the <em>Layers</em>
panel. Open the attribute table and you will notice that the
<em>colleges</em> column has the list of colleges in title case. Open
the <strong>Vector table → Field calculator</strong> algorithm
again.</li>
</ol>
<p><img src="images/qgis_expressions/iteration6.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="7" style="list-style-type: decimal">
<li>In the <em>Vector Table - Field Calculator</em> dialog, select
<code>nearest_colleges</code> as the <em>Input Layer</em>. Enter
<strong>science_colleges</strong> as the <em>Field name</em>. Select
<strong>Text (string)</strong> as the <em>Result field type</em>.</li>
</ol>
<p><img src="images/qgis_expressions/iteration7.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="8" style="list-style-type: decimal">
<li>From our list of colleges, we want to select only the colleges with
the word <strong>Science</strong> in their names. To achieve this, we
can use the <code>array_filter()</code> function to iterate through each
item and check if the text is present. This can be achieved using the
<code>regexp_match()</code> function. Enter the expression as
below.</li>
</ol>
<pre><code>array_to_string(
  array_filter(
    array_foreach(
        overlay_nearest(
            layer:=&#39;colleges&#39;,
            expression:=&quot;collegename&quot;,
            max_distance:=5000,
            limit:=-1
        ),
        title(@element)
    ),
    regexp_match(@element, &#39;Science&#39;)
  )
)</code></pre>
<p><img src="images/qgis_expressions/iteration8.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="9" style="list-style-type: decimal">
<li>Click the <em>…</em> next to <em>Calculated</em> and select
<strong>Save to File…</strong>. Enter the name of the output file as
<code>nearest_science_colleges.gpkg</code> and click <em>Run</em>.</li>
</ol>
<p><img src="images/qgis_expressions/iteration9.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="10" style="list-style-type: decimal">
<li>Once the processing finishes, a new layer
<code>nearest_science_colleges</code> will be added to the
<em>Layers</em> panel. Open the attribute table and you will notice that
the <em>science_colleges</em> column has the list of colleges containing
the keyword <em>Science</em>.</li>
</ol>
<p><img src="images/qgis_expressions/iteration10.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="11" style="list-style-type: decimal">
<li>Select both the <code>nearest_colleges</code> and
<code>nearest_science_colleges</code> layers. Right-click and select
<em>Remove Layer</em>.</li>
</ol>
<p><img src="images/qgis_expressions/iteration11.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="12" style="list-style-type: decimal">
<li>We will now apply these concept of iteration and filtering to our
problem of connecting schools to the nearest college. We will apply an
additional criteria to connect each school to the nearest college that
<strong>belongs to the same district as the school</strong>. Let’s
update the expression to apply this filter. Select the
<code>schools</code> layer and click the <em>Open the Layer Styling
Panel</em> button. Select the <em>Geometry Generator</em> symbol
layer.</li>
</ol>
<p><img src="images/qgis_expressions/iteration12.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="13" style="list-style-type: decimal">
<li>We will update the <code>overlay_nearest()</code> function to return
us the list of <code>@feature</code> instead of <code>@geometry</code>.
This will allow us to run the filter on the attributes. We then use
<code>array_filter()</code> to select all college features where the
value of <em>district</em> is the same as the value of <em>district</em>
for the school. Finally we select the first matching feature using
<code>[0]</code> and use <code>geometry()</code> to extract the geometry
of the feature. The final expression for creating a line from the school
to the nearest college in the same district is as follows.</li>
</ol>
<pre><code>make_line(
    @geometry,
    geometry(array_filter(
        overlay_nearest(
            layer:=&#39;colleges&#39;,
            expression:=@feature,
            max_distance:=5000,
            limit:=-1
        ),
    &quot;district&quot;=attribute(@element, &#39;district&#39;))[0])
)</code></pre>
<p><img src="images/qgis_expressions/iteration13.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="14" style="list-style-type: decimal">
<li>Once you apply the expression, the map will update and you will see
that each school is now connected to the nearest college that belongs to
the same administrative area.</li>
</ol>
<p><img src="images/qgis_expressions/iteration14.png" width="75%" style="display: block; margin: auto;" /></p>
<p>You can now load the <code>Nearest_Neighbor_CheckPoint2.qgz</code>
project in the <code>solutions</code> folder to catch up to this point
and do the challenge.</p>
<div id="challenge-4" class="section level2">
<h2>Challenge 4</h2>
<p>You will notice that there are many schools with no connection to
colleges. The challenge is select all schools which have no nearby
college in the same district. You can use the <em>Select by
expression</em> algorithm in the Processing Toolbox to select features
using an expression.</p>
<p>Hint: Use the <code>array_filter()</code> expression from above and
build an expression to select features where <code>array_length()</code>
is 0.</p>
<p><img src="images/qgis_expressions/challenge4.png" width="75%" style="display: block; margin: auto;" /></p>
</div>
</div>
<div id="quiz" class="section level1">
<h1>Quiz</h1>
<p>Take this short quiz to test your understanding of the QGIS
expressions.</p>
<p><a href="https://forms.gle/FqVAh4SCfVMYm8dP9" target="_blank">Launch
Quiz ↗</a>.</p>
</div>
<div id="supplement" class="section level1">
<h1>Supplement</h1>
<div id="saving-and-sharing-expressions" class="section level2">
<h2>Saving and Sharing Expressions</h2>
<p>QGIS expression editor allows you to <a
href="https://docs.qgis.org/testing/en/docs/user_manual/expressions/expression.html#saving-expressions">save
expressions</a> that can be used later on. If you have an expression
that you want to save, click the <em>Add current expression to user
expressions</em> button in the expression editor. The expression will be
saved with your chosen name in a special group <strong>User
Expression</strong>. The saved expression can then be accessed anytime.
You can also share your saved expression with other QGIS users using the
<em>Export user expressions</em> button which they can import into their
QGIS installation.</p>
<p><img src="images/qgis_expressions/user_expression.png" width="75%" style="display: block; margin: auto;" /></p>
</div>
</div>
<div id="data-credits" class="section level1">
<h1>Data Credits</h1>
<ul>
<li>Admin 1 – States, Provinces: Made with Natural Earth. Free vector
and raster map data @ naturalearthdata.com. Admin1 boundaries were
edited and combined with countries (India POV) boundaries.</li>
<li>Global Power Plant Database: Global Energy Observatory, Google, KTH
Royal Institute of Technology in Stockholm, Enipedia, World Resources
Institute. 2021. Global Power Plant Database version 1.3.0. Accessed
through <a
href="https://datasets.wri.org/datasets/global-power-plant-database"
class="uri">https://datasets.wri.org/datasets/global-power-plant-database</a>
on <date></li>
<li>School and College locations: Data Copyright 2023 OpenStreetMap
Contributors. Downloaded using QuickOSM plugin in QGIS.</li>
<li>District boundaries: Downloaded from GeoBoundaries. Runfola, D. et
al. (2020) geoBoundaries: A global database of political administrative
boundaries. PLoS ONE 15(4): e0231866. <a
href="https://doi.org/10.1371/journal.pone.0231866"
class="uri">https://doi.org/10.1371/journal.pone.0231866</a></li>
</ul>
</div>
<div id="license" class="section level1">
<h1>License</h1>
<p>This workshop material is licensed under a <a
href="https://creativecommons.org/licenses/by/4.0/">Creative Commons
Attribution 4.0 International (CC BY 4.0)</a>. You are free to re-use
and adapt the material but are required to give appropriate credit to
the original author as below:</p>
<p><em>QGIS Expressions Masterclass</em> by Ujaval Gandhi <a
href="https://spatialthoughts.com">www.spatialthoughts.com</a></p>
<hr />
</div>

<!-- Comment Section Powered by utterances -->
<div id="comments">
  <hr />
  <p>If you want to report any issues with this page, please comment below.</p>
<script src="https://utteranc.es/client.js"
        repo="spatialthoughts/courses"
        issue-term="title"
        label="comment"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>
</div>



</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.odd').parent('tbody').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open');
  });
});
</script>

<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
