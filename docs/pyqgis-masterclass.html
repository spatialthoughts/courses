<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />


<meta name="author" content="Ujaval Gandhi" />


<title>PyQGIS Masterclass - Customizing QGIS with Python (Full Course)</title>

<script src="site_libs/header-attrs-2.29/header-attrs.js"></script>
<script src="site_libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/flatly.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<style>h1 {font-size: 34px;}
       h1.title {font-size: 38px;}
       h2 {font-size: 30px;}
       h3 {font-size: 24px;}
       h4 {font-size: 18px;}
       h5 {font-size: 16px;}
       h6 {font-size: 12px;}
       code {color: inherit; background-color: rgba(0, 0, 0, 0.04);}
       pre:not([class]) { background-color: white }</style>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<link href="site_libs/pagedtable-1.1/css/pagedtable.css" rel="stylesheet" />
<script src="site_libs/pagedtable-1.1/js/pagedtable.js"></script>
<style>
.copy-btn {
  position: absolute;
  top: 5px;
  right: 5px;
  padding: 4px 8px;
  font-size: 18px;
  background: #969696;
  color: white;
  border: none;
  border-radius: 3px;
  cursor: pointer;
  opacity: 0.7;
  transition: opacity 0.3s;
}

.copy-btn:hover {
  opacity: 1;
}

.copy-btn.copied {
  background: #636363;
}

pre {
  position: relative;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Find all code blocks
  const codeBlocks = document.querySelectorAll('pre code');
  
  codeBlocks.forEach(function(codeBlock) {
    const pre = codeBlock.parentElement;
    
    // Create copy button
    const button = document.createElement('button');
    button.className = 'copy-btn';
    button.textContent = '⎘';
    
    // Add button to pre element
    pre.appendChild(button);
    
    // Add click event
    button.addEventListener('click', function() {
      // Create temporary textarea to copy text
      const textarea = document.createElement('textarea');
      textarea.value = codeBlock.textContent;
      document.body.appendChild(textarea);
      textarea.select();
      document.execCommand('copy');
      document.body.removeChild(textarea);
      
      // Update button text
      button.textContent = 'Copied!';
      button.classList.add('copied');
      
      // Reset button after 2 seconds
      setTimeout(function() {
        button.textContent = '⎘';
        button.classList.remove('copied');
      }, 2000);
    });
  });
});
</script>

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>



<style type="text/css">
  code {
    white-space: pre;
  }
  .sourceCode {
    overflow: visible;
  }
</style>
<style type="text/css" data-origin="pandoc">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */

</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    var j = 0;
    while (j < rules.length) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") {
        j++;
        continue;
      }
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') {
        j++;
        continue;
      }
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>







<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
details > summary > p:only-child {
  display: inline;
}
pre code {
  padding: 0;
}
</style>


<style type="text/css">
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #adb5bd;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script type="text/javascript">
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark the anchor link active (and if it's in a dropdown, also mark that active)
  var dropdown = menuAnchor.closest('li.dropdown');
  if (window.bootstrap) { // Bootstrap 4+
    menuAnchor.addClass('active');
    dropdown.find('> .dropdown-toggle').addClass('active');
  } else { // Bootstrap 3
    menuAnchor.parent().addClass('active');
    dropdown.addClass('active');
  }

  // Navbar adjustments
  var navHeight = $(".navbar").first().height() + 15;
  var style = document.createElement('style');
  var pt = "padding-top: " + navHeight + "px; ";
  var mt = "margin-top: -" + navHeight + "px; ";
  var css = "";
  // offset scroll position for anchor links (for fixed navbar)
  for (var i = 1; i <= 6; i++) {
    css += ".section h" + i + "{ " + pt + mt + "}\n";
  }
  style.innerHTML = "body {" + pt + "padding-bottom: 40px; }\n" + css;
  document.head.appendChild(style);
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before, .tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "\e259";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "\e258";
  font-family: 'Glyphicons Halflings';
  border: none;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->




</head>

<body>


<div class="container-fluid main-container">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-bs-toggle="collapse" data-target="#navbar" data-bs-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">Courses</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="http://spatialthoughts.com">Back to Main Site</a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li>
  <a href="#">Back to Top</a>
</li>
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div id="header">



<h1 class="title toc-ignore">PyQGIS Masterclass - Customizing QGIS with
Python (Full Course)</h1>
<h3 class="subtitle">Learn the PyQGIS API from the Ground Up.</h3>
<h4 class="author">Ujaval Gandhi</h4>

</div>

<div id="TOC">
<ul>
<li><a href="#introduction" id="toc-introduction">Introduction</a></li>
<li><a href="#get-the-data-package" id="toc-get-the-data-package">Get
the Data Package</a></li>
<li><a href="#get-the-course-videos" id="toc-get-the-course-videos">Get
the Course Videos</a></li>
<li><a href="#installation-and-setting-up-the-environment"
id="toc-installation-and-setting-up-the-environment">Installation and
Setting up the Environment</a>
<ul>
<li><a href="#install-qgis" id="toc-install-qgis">Install QGIS</a></li>
<li><a href="#get-a-text-editor" id="toc-get-a-text-editor">Get a Text
Editor</a></li>
</ul></li>
<li><a href="#hello-world" id="toc-hello-world">1. Hello World!</a></li>
<li><a href="#hello-pyqgis" id="toc-hello-pyqgis">2. Hello
PyQGIS!</a></li>
<li><a href="#understanding-classes" id="toc-understanding-classes">3.
Understanding Classes</a></li>
<li><a href="#using-pyqgis-classes" id="toc-using-pyqgis-classes">4.
Using PyQGIS Classes</a>
<ul>
<li><a href="#calculating-distance-using-pyqgis"
id="toc-calculating-distance-using-pyqgis">4.1 Calculating distance
using PyQGIS</a></li>
<li><a href="#exercise-1" id="toc-exercise-1">Exercise 1</a></li>
<li><a href="#distance-conversion" id="toc-distance-conversion">4.2
Distance Conversion</a></li>
</ul></li>
<li><a href="#graphical-user-interface-gui-programming-basics"
id="toc-graphical-user-interface-gui-programming-basics">5. Graphical
User Interface (GUI) Programming Basics</a>
<ul>
<li><a href="#qt-and-pyqt" id="toc-qt-and-pyqt">5.1 Qt and PyQt</a></li>
<li><a href="#building-a-dialog-box" id="toc-building-a-dialog-box">5.2
Building a Dialog Box</a></li>
</ul></li>
<li><a href="#deep-dive-into-pyqgis" id="toc-deep-dive-into-pyqgis">6.
Deep Dive into PyQGIS</a>
<ul>
<li><a href="#qgis-interface-api-qgisinterface"
id="toc-qgis-interface-api-qgisinterface">6.1 QGIS Interface API
(QgisInterface)</a></li>
<li><a href="#exercise-2" id="toc-exercise-2">Exercise 2</a></li>
<li><a href="#exercise-3" id="toc-exercise-3">Exercise 3</a></li>
<li><a href="#qgis-project-api-qgsproject"
id="toc-qgis-project-api-qgsproject">6.2 QGIS Project API
(QgsProject)</a></li>
<li><a href="#exercise-4" id="toc-exercise-4">Exercise 4</a></li>
</ul></li>
<li><a href="#running-python-code-at-qgis-launch"
id="toc-running-python-code-at-qgis-launch">7. Running Python Code at
QGIS Launch</a>
<ul>
<li><a href="#exercise-5" id="toc-exercise-5">Exercise 5</a></li>
</ul></li>
<li><a href="#running-processing-algorithms"
id="toc-running-processing-algorithms">8. Running Processing
Algorithms</a>
<ul>
<li><a href="#creating-hillshade-from-a-dem"
id="toc-creating-hillshade-from-a-dem">8.1 Creating Hillshade from a
DEM</a></li>
<li><a href="#running-multiple-processing-algorithms"
id="toc-running-multiple-processing-algorithms">8.2 Running Multiple
Processing Algorithms</a></li>
<li><a href="#exercise-6" id="toc-exercise-6">Exercise 6</a></li>
</ul></li>
<li><a href="#assignment" id="toc-assignment">Assignment</a></li>
<li><a href="#writing-plugins" id="toc-writing-plugins">9. Writing
Plugins</a>
<ul>
<li><a href="#understanding-plugins" id="toc-understanding-plugins">9.1
Understanding Plugins</a></li>
<li><a href="#adding-functionality" id="toc-adding-functionality">9.2
Adding Functionality</a></li>
<li><a href="#exercise-7" id="toc-exercise-7">Exercise 7</a></li>
</ul></li>
<li><a href="#advanced-python-concepts"
id="toc-advanced-python-concepts">10. Advanced Python Concepts</a>
<ul>
<li><a href="#understanding-python-iterators"
id="toc-understanding-python-iterators">10.1 Understanding Python
Iterators</a></li>
<li><a href="#list-comprehensions" id="toc-list-comprehensions">10.2
List Comprehensions</a></li>
<li><a href="#exercise-8" id="toc-exercise-8">Exercise 8</a></li>
</ul></li>
<li><a href="#writing-processing-plugins"
id="toc-writing-processing-plugins">11. Writing Processing Plugins</a>
<ul>
<li><a href="#iterating-over-features"
id="toc-iterating-over-features">11.1 Iterating over Features</a></li>
<li><a href="#exercise-9" id="toc-exercise-9">Exercise 9</a></li>
<li><a href="#saving-vector-layers" id="toc-saving-vector-layers">11.2
Saving Vector Layers</a></li>
<li><a href="#writing-a-processing-script"
id="toc-writing-a-processing-script">11.3. Writing a Processing
Script</a></li>
<li><a href="#processing-plugin" id="toc-processing-plugin">11.4
Processing Plugin</a></li>
</ul></li>
<li><a href="#qgis-actions" id="toc-qgis-actions">12. QGIS Actions</a>
<ul>
<li><a href="#hello-world-1" id="toc-hello-world-1">12.1 Hello
World</a></li>
<li><a href="#exercise-10" id="toc-exercise-10">Exercise 10</a></li>
<li><a href="#selecting-neighbors" id="toc-selecting-neighbors">12.2
Selecting Neighbors</a></li>
<li><a href="#exercise-11" id="toc-exercise-11">Exercise 11</a></li>
<li><a href="#learn-more" id="toc-learn-more">12.3 Learn More</a></li>
</ul></li>
<li><a href="#writing-standalone-python-scripts"
id="toc-writing-standalone-python-scripts">13. Writing Standalone Python
Scripts</a>
<ul>
<li><a href="#windows-configuration"
id="toc-windows-configuration">Windows Configuration</a></li>
<li><a href="#macos-configuration" id="toc-macos-configuration">MacOS
Configuration</a></li>
<li><a href="#linuxconda-configuration"
id="toc-linuxconda-configuration">Linux/Conda Configuration</a></li>
</ul></li>
<li><a href="#integration-with-python-development-environments"
id="toc-integration-with-python-development-environments">14.
Integration with Python Development Environments</a>
<ul>
<li><a href="#using-pyqgis-api-in-a-jupyter-notebook"
id="toc-using-pyqgis-api-in-a-jupyter-notebook">Using PyQGIS API in a
Jupyter Notebook</a></li>
<li><a href="#using-pyqgis-api-in-vs-code"
id="toc-using-pyqgis-api-in-vs-code">Using PyQGIS API in VS
Code</a></li>
</ul></li>
<li><a href="#supplement" id="toc-supplement">Supplement</a>
<ul>
<li><a href="#save-map-rendering-as-an-image"
id="toc-save-map-rendering-as-an-image">Save Map Rendering as an
Image</a></li>
<li><a href="#search-for-a-layer" id="toc-search-for-a-layer">Search for
a layer</a></li>
<li><a href="#turn-a-layer-onoff" id="toc-turn-a-layer-onoff">Turn a
layer on/off</a></li>
<li><a href="#get-all-layers" id="toc-get-all-layers">Get all
Layers</a></li>
<li><a href="#get-only-checked-visible-layers"
id="toc-get-only-checked-visible-layers">Get only checked (visible)
Layers</a></li>
<li><a href="#get-only-selected-layers"
id="toc-get-only-selected-layers">Get only selected Layers</a></li>
<li><a href="#set-canvas-extent-to-a-layer-extent"
id="toc-set-canvas-extent-to-a-layer-extent">Set Canvas Extent to a
Layer Extent</a></li>
<li><a href="#get-layers-with-hierarchy"
id="toc-get-layers-with-hierarchy">Get Layers with Hierarchy</a></li>
<li><a href="#change-icon-of-qgis-main-window"
id="toc-change-icon-of-qgis-main-window">Change Icon of QGIS Main
Window</a></li>
<li><a href="#remove-a-specific-button-from-a-toolbar"
id="toc-remove-a-specific-button-from-a-toolbar">Remove a Specific
Button from a Toolbar</a></li>
<li><a href="#add-a-drop-down-menu-to-toolbar"
id="toc-add-a-drop-down-menu-to-toolbar">Add a Drop-down Menu to
Toolbar</a></li>
<li><a href="#adding-csv-layers" id="toc-adding-csv-layers">Adding CSV
Layers</a></li>
<li><a href="#inserting-layers-in-the-layer-tree"
id="toc-inserting-layers-in-the-layer-tree">Inserting Layers in the
Layer Tree</a></li>
<li><a href="#saving-layers-to-disk"
id="toc-saving-layers-to-disk">Saving Layers to Disk</a></li>
<li><a href="#displaying-a-label-with-a-background-color"
id="toc-displaying-a-label-with-a-background-color">Displaying a label
with a background color</a></li>
<li><a href="#edit-attribute-table-of-a-vector-layer"
id="toc-edit-attribute-table-of-a-vector-layer">Edit Attribute Table of
a Vector Layer</a></li>
<li><a href="#creating-a-pdf-with-title"
id="toc-creating-a-pdf-with-title">Creating a PDF with Title</a></li>
<li><a href="#create-a-geodesic-line"
id="toc-create-a-geodesic-line">Create a Geodesic Line</a></li>
<li><a href="#simplifying-processing-scripts"
id="toc-simplifying-processing-scripts">Simplifying Processing
Scripts</a></li>
<li><a href="#renaming-temporary-output-layers"
id="toc-renaming-temporary-output-layers">Renaming Temporary Output
Layers</a></li>
<li><a href="#select-connected-features-using-actions"
id="toc-select-connected-features-using-actions">Select Connected
Features using Actions</a></li>
<li><a href="#using-code-from-plugins"
id="toc-using-code-from-plugins">Using Code from Plugins</a></li>
<li><a href="#specifying-plugin-dependencies"
id="toc-specifying-plugin-dependencies">Specifying Plugin
Dependencies</a></li>
<li><a href="#using-symbolic-links-for-plugin-development"
id="toc-using-symbolic-links-for-plugin-development">Using Symbolic
Links for Plugin Development</a></li>
</ul></li>
<li><a href="#what-next" id="toc-what-next">What next?</a></li>
<li><a href="#resources" id="toc-resources">Resources</a></li>
<li><a href="#data-credits" id="toc-data-credits">Data Credits</a></li>
<li><a href="#license" id="toc-license">License</a></li>
</ul>
</div>

<div style="page-break-after: always;"></div>
<hr />
<p><img src="images/spatial_thoughts_logo.png" width="250pt" style="display: block; margin: auto;" /></p>
<hr />
<div style="page-break-after: always;"></div>
<div id="introduction" class="section level1">
<h1>Introduction</h1>
<p>This class introduces the concepts of Python programming within the
QGIS environment. We will cover the full breadth of topics that involve
everything from using the Python Console to building a fully functional
plugin. We will also explore GUI programming techniques for customizing
the QGIS interface using Qt widgets.</p>
<p>This course requires basic knowledge of Python. If you are not
familiar with Python, it is strongly recommended you complete our <a
href="https://spatialthoughts.com/training/python-foundation-for-spatial-analysis/">Python
Foundation for Spatial Analysis</a> course. We will build upon the
exercises covered in that course.</p>
<p><a
href="https://www.youtube.com/watch?v=-nJ_8Ph_yPE&amp;list=PLppGmFLhQ1HKKnk3riKNyOxb-3MTI-7zE"
target="_blank"><img
src="https://img.youtube.com/vi/-nJ_8Ph_yPE/mqdefault.jpg"
alt="Watch the video" /></a></p>
<p><a
href="https://www.youtube.com/watch?v=-nJ_8Ph_yPE&amp;list=PLppGmFLhQ1HKKnk3riKNyOxb-3MTI-7zE"
target="_blank">Watch the Video ↗</a></p>
<p><a
href="https://docs.google.com/presentation/d/1GT0c6jG3WmOZgsLuiIniEE9T1H8NJ5G6oemWX43VIUA/edit?usp=sharing"
target="_blank">Access the Presentation ↗</a></p>
</div>
<div id="get-the-data-package" class="section level1">
<h1>Get the Data Package</h1>
<p>The code examples in this class use a variety of datasets. All the
required layers, project files, icons etc. are supplied to you in the
<code>pyqgis_masterclass.zip</code> file. Unzip this file to the
<code>Downloads</code> directory. All scripts assume the data is
available in the
<code>&lt;home folder&gt;/Downloads/pyqgis_masterclass/</code>
directory.</p>
<p>Download <a
href="https://github.com/spatialthoughts/courses/releases/download/data/pyqgis_masterclass.zip">pyqgis_masterclass.zip</a>.</p>
<blockquote>
<p>Note: Certification and Support are only available for participants
in our paid instructor-led classes.</p>
</blockquote>
</div>
<div id="get-the-course-videos" class="section level1">
<h1>Get the Course Videos</h1>
<p>The course is accompanied by a set of videos covering the all the
modules. These videos are recorded from our live instructor-led classes
and are edited to make them easier to consume for self-study. We have 2
versions of the videos:</p>
<div id="youtube" class="section level3">
<h3>YouTube</h3>
<p>We have created a YouTube Playlist with separate videos for each
notebook and exercise to enable effective online-learning. <a
href="https://www.youtube.com/playlist?list=PLppGmFLhQ1HKKnk3riKNyOxb-3MTI-7zE"
target="_blank">Access the YouTube Playlist ↗</a></p>
</div>
<div id="vimeo" class="section level3">
<h3>Vimeo</h3>
<p>We are also making combined full-length video for each module
available on Vimeo. These videos can be downloaded for offline learning.
<a href="https://vimeo.com/showcase/11320340?share=copy"
target="_blank">Access the Vimeo Playlist ↗</a></p>
</div>
</div>
<div id="installation-and-setting-up-the-environment"
class="section level1">
<h1>Installation and Setting up the Environment</h1>
<div id="install-qgis" class="section level2">
<h2>Install QGIS</h2>
<p>This course requires QGIS LTR version 3.40. Please review <a
href="install-qgis-ltr.html">QGIS-LTR Installation Guide</a> for
step-by-step instructions.</p>
</div>
<div id="get-a-text-editor" class="section level2">
<h2>Get a Text Editor</h2>
<p>Any kind of software development requires a good text editor. If you
already have a favorite text editor or an IDE (Integrated Development
Environment), you may use it for this course. Otherwise, each platform
offers a wide variety of free or paid options for text editors. Choose
the one that fits your needs.</p>
<p>Below are my recommendations editors that are simple to use for
beginners.</p>
<ul>
<li>Windows: <a
href="https://notepad-plus-plus.org/downloads/">Notepad++</a> is a good
free editor for windows.</li>
<li>Mac: <a href="https://macromates.com/">TextMate</a> is an
open-source editor for Mac that is currently available for free.</li>
</ul>
</div>
</div>
<div id="hello-world" class="section level1">
<h1>1. Hello World!</h1>
<p><a
href="https://www.youtube.com/watch?v=p60q4uiCqI0&amp;list=PLppGmFLhQ1HKKnk3riKNyOxb-3MTI-7zE&amp;index=3"
target="_blank"><img
src="https://img.youtube.com/vi/p60q4uiCqI0/mqdefault.jpg"
alt="Watch the Video" /></a></p>
<p><a
href="https://www.youtube.com/watch?v=p60q4uiCqI0&amp;list=PLppGmFLhQ1HKKnk3riKNyOxb-3MTI-7zE&amp;index=3"
target="_blank">Watch the Video ↗</a></p>
<p>QGIS Comes with a built-in <strong>Python Console</strong> and a code
editor where you can write and run Python code.</p>
<p>Go to <strong>Plugins → Python Console</strong> to open the
console.</p>
<p><img src="images/pyqgis/console.png" width="75%" style="display: block; margin: auto;" /></p>
<p>At the <code>&gt;&gt;&gt;</code> prompt, type in the following
command and press Enter.</p>
<div class="sourceCode" id="cb1"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&#39;Hello World!&#39;</span>)</span></code></pre></div>
<p>Here you are running Python’s <em>print()</em> function with the text
‘Hello World’. The output of the statement will be printed below.</p>
<p><img src="images/pyqgis/helloworld.png" width="75%" style="display: block; margin: auto;" /></p>
<p>While console is useful for typing 1-2 lines of code or printing
information contained in a variable, you should use the built-in editor
for typing longer scripts or code snippets. Click the <em>Show
Editor</em> button to open the editor panel. Enter the code and click
the <em>Run Script</em> button to execute it. The results will appear in
the console as before. If you are working on a longer script, you can
also click the <em>Save</em> button in the editor to save the script for
future use.</p>
<p><img src="images/pyqgis/editor.png" width="75%" style="display: block; margin: auto;" /></p>
<p>All code snippets below should be run from the Editor.</p>
</div>
<div id="hello-pyqgis" class="section level1">
<h1>2. Hello PyQGIS!</h1>
<p><a
href="https://www.youtube.com/watch?v=7xNNpGoYK9Q&amp;list=PLppGmFLhQ1HKKnk3riKNyOxb-3MTI-7zE&amp;index=4"
target="_blank"><img
src="https://img.youtube.com/vi/7xNNpGoYK9Q/mqdefault.jpg"
alt="Watch the Video" /></a></p>
<p><a
href="https://www.youtube.com/watch?v=7xNNpGoYK9Q&amp;list=PLppGmFLhQ1HKKnk3riKNyOxb-3MTI-7zE&amp;index=4"
target="_blank">Watch the Video ↗</a></p>
<p>QGIS provides a Python API (Application Programming Interface),
commonly known as PyQGIS. The API is vast and very capable. Almost every
operation that you can do using QGIS - can be done using the API. This
allows developers to write code to build new tools, customize the
interface and automate workflows.</p>
<p>Let’s try out the API to perform some GIS data management tasks.</p>
<p>Browse to the data directory and load the <code>shoreline.shp</code>
layer. Open the <em>Attribute Table</em>. This layer has 6 attribute
columns. Let’s say we want to delete the 2nd column
(<code>SDE_SFGIS_</code>) from the layer.</p>
<p><img src="images/pyqgis/hellopyqgis1.png" width="75%" style="display: block; margin: auto;" /></p>
<p>This can be done using the QGIS GUI as follows</p>
<ol style="list-style-type: decimal">
<li>Right-click the <code>shoreline</code> layer and click <em>Open
Attribute Table</em>.</li>
<li>In the Attribute Table, click the <em>Toggle Editing mode</em>
button.</li>
<li>Click the <em>Delete field</em> button. Select the
<code>SDE_SFGIS_</code> column and click <em>OK</em>.</li>
<li>Click the <em>Save edits</em> button and click the <em>Toggle
Editing mode</em> to stop editing.</li>
</ol>
<p>QGIS Provides an API to accomplish all of this using Python code. We
will now do this task - but using only Python code. Open the
<em>Editor</em> and enter the following code. Click the <em>Run
Script</em> button to execute it.</p>
<blockquote>
<p>Make sure you have selected the <code>shoreline</code> layer in the
<em>Layers</em> panel before running the code.</p>
</blockquote>
<div class="sourceCode" id="cb2"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a>layer <span class="op">=</span> iface.activeLayer()</span>
<span id="cb2-2"><a href="#cb2-2" tabindex="-1"></a>layer.startEditing()</span>
<span id="cb2-3"><a href="#cb2-3" tabindex="-1"></a>layer.deleteAttribute(<span class="dv">1</span>)</span>
<span id="cb2-4"><a href="#cb2-4" tabindex="-1"></a>layer.commitChanges()</span></code></pre></div>
<p>You will see that the 2nd column is now deleted from the attribute
table.</p>
<p><img src="images/pyqgis/hellopyqgis2.png" width="75%" style="display: block; margin: auto;" /></p>
<p>Let’s understand the code step-by-step</p>
<ol style="list-style-type: decimal">
<li><code>layer = iface.activeLayer()</code>: This line uses the
<code>iface</code> object and runs the <code>activeLayer()</code> method
which returns the currently selected layer in QGIS. We will learn more
about <code>iface</code> in the <a
href="#qgis-interface-api-qgisinterface">QGIS Interface API</a> section.
The method returns the reference to the layer which is saved in the
<code>layer</code> variable.</li>
<li><code>layer.startEditing()</code>: This is equivalent to putting the
layer in the editing mode.</li>
<li><code>layer.deleteAttribute(1)</code>: The
<code>deleteAttribute()</code> is a method from
<code>QgsVectorLayer</code> class. It takes the index of the attribute
to be deleted. Here we pass on index <code>1</code> for the second
attribute. (index 0 is the first attribute)</li>
<li><code>layer.commitChanges()</code>: This method saves the edit
buffer and also disables the editing mode.</li>
</ol>
<p>This gives you a preview of the power of the API. To harness the full
power of the PyQGIS API, we must first understand how classes work.</p>
<p>Note that you can also trigger the Start Editing and Stop Editing
actions using the <a
href="https://qgis.org/pyqgis/3.40/core/QgsVectorLayerTools.html"><code>QgsVectorLayerTools</code></a>
class. Below is an alternative code that presents the confirmation
dialog to the user before committing changes.</p>
<div class="sourceCode" id="cb3"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a>layer <span class="op">=</span> iface.activeLayer()</span>
<span id="cb3-2"><a href="#cb3-2" tabindex="-1"></a>iface.vectorLayerTools().startEditing(layer)</span>
<span id="cb3-3"><a href="#cb3-3" tabindex="-1"></a>layer.deleteAttribute(<span class="dv">1</span>)</span>
<span id="cb3-4"><a href="#cb3-4" tabindex="-1"></a>iface.vectorLayerTools().stopEditing(layer)</span></code></pre></div>
</div>
<div id="understanding-classes" class="section level1">
<h1>3. Understanding Classes</h1>
<p>Before we dive it to PyQGIS, it is important to understand certain
concepts related to C++ and Python Classes. Qt as well as QGIS is
written in C++ language. Functionality of each Qt/QGIS Widget is
implemented as a class - having certain properties and functions. When
we use PyQt or PyQGIS classes, it is executing the code in the C++
classes via the python bindings.</p>
<p><a
href="https://www.youtube.com/watch?v=sUBnrV9McXk&amp;list=PLppGmFLhQ1HKKnk3riKNyOxb-3MTI-7zE&amp;index=5"
target="_blank"><img
src="https://img.youtube.com/vi/sUBnrV9McXk/mqdefault.jpg"
alt="Watch the Video" /></a></p>
<p><a
href="https://www.youtube.com/watch?v=sUBnrV9McXk&amp;list=PLppGmFLhQ1HKKnk3riKNyOxb-3MTI-7zE&amp;index=5"
target="_blank">Watch the Video ↗</a></p>
<p><a
href="https://docs.google.com/presentation/d/1b4i1nEDR_uKJVu0IIqjoqrxeFD2a-tnj88JRXQW0JiA/edit?usp=sharing"
target="_blank">View the Presentation ↗</a></p>
<p>Here’s the code to create a class called <code>Car</code>
demonstrating the example we covered in the <a
href="https://docs.google.com/presentation/d/1b4i1nEDR_uKJVu0IIqjoqrxeFD2a-tnj88JRXQW0JiA/edit?usp=sharing">Classes
and Objects</a> presentation. It creates a class, initializes it to
create new instances and demonstrates the concept of inheritance. A new
class is defined using the word <code>class</code>. All classes have a
function called<code>__init__()</code>, which is always executed when a
new object is being created. There is also the keyword <code>self</code>
which refers to the current instance of the class. The code uses the
<code>super</code> keyword to refer to the parent class.</p>
<div class="sourceCode" id="cb4"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a><span class="kw">class</span> Car:</span>
<span id="cb4-2"><a href="#cb4-2" tabindex="-1"></a>    </span>
<span id="cb4-3"><a href="#cb4-3" tabindex="-1"></a>    model <span class="op">=</span> <span class="st">&#39;Civic&#39;</span></span>
<span id="cb4-4"><a href="#cb4-4" tabindex="-1"></a>    </span>
<span id="cb4-5"><a href="#cb4-5" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, color, <span class="bu">type</span>):</span>
<span id="cb4-6"><a href="#cb4-6" tabindex="-1"></a>        <span class="va">self</span>.color <span class="op">=</span> color</span>
<span id="cb4-7"><a href="#cb4-7" tabindex="-1"></a>        <span class="va">self</span>.<span class="bu">type</span> <span class="op">=</span> <span class="bu">type</span></span>
<span id="cb4-8"><a href="#cb4-8" tabindex="-1"></a>        <span class="va">self</span>.started <span class="op">=</span> <span class="va">False</span></span>
<span id="cb4-9"><a href="#cb4-9" tabindex="-1"></a>        <span class="va">self</span>.stopped <span class="op">=</span> <span class="va">False</span></span>
<span id="cb4-10"><a href="#cb4-10" tabindex="-1"></a>    </span>
<span id="cb4-11"><a href="#cb4-11" tabindex="-1"></a>    <span class="kw">def</span> start(<span class="va">self</span>):</span>
<span id="cb4-12"><a href="#cb4-12" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&#39;Car Started&#39;</span>)</span>
<span id="cb4-13"><a href="#cb4-13" tabindex="-1"></a>        <span class="va">self</span>.started <span class="op">=</span> <span class="va">True</span></span>
<span id="cb4-14"><a href="#cb4-14" tabindex="-1"></a>        <span class="va">self</span>.stopped <span class="op">=</span> <span class="va">False</span></span>
<span id="cb4-15"><a href="#cb4-15" tabindex="-1"></a>        </span>
<span id="cb4-16"><a href="#cb4-16" tabindex="-1"></a>    <span class="kw">def</span> stop(<span class="va">self</span>):</span>
<span id="cb4-17"><a href="#cb4-17" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&#39;Car Stopped&#39;</span>)</span>
<span id="cb4-18"><a href="#cb4-18" tabindex="-1"></a>        <span class="va">self</span>.stopped <span class="op">=</span> <span class="va">True</span></span>
<span id="cb4-19"><a href="#cb4-19" tabindex="-1"></a>        sefl.started <span class="op">=</span> <span class="va">False</span></span>
<span id="cb4-20"><a href="#cb4-20" tabindex="-1"></a></span>
<span id="cb4-21"><a href="#cb4-21" tabindex="-1"></a><span class="co"># Instantiate the class      </span></span>
<span id="cb4-22"><a href="#cb4-22" tabindex="-1"></a>my_car <span class="op">=</span> Car(<span class="st">&#39;blue&#39;</span>, <span class="st">&#39;automatic&#39;</span>)</span>
<span id="cb4-23"><a href="#cb4-23" tabindex="-1"></a></span>
<span id="cb4-24"><a href="#cb4-24" tabindex="-1"></a><span class="bu">print</span>(my_car)</span>
<span id="cb4-25"><a href="#cb4-25" tabindex="-1"></a></span>
<span id="cb4-26"><a href="#cb4-26" tabindex="-1"></a><span class="co"># Call a method</span></span>
<span id="cb4-27"><a href="#cb4-27" tabindex="-1"></a>my_car.start()</span>
<span id="cb4-28"><a href="#cb4-28" tabindex="-1"></a></span>
<span id="cb4-29"><a href="#cb4-29" tabindex="-1"></a><span class="co"># Check the value of an instance variable</span></span>
<span id="cb4-30"><a href="#cb4-30" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&#39;Car Started?&#39;</span>, my_car.started)</span>
<span id="cb4-31"><a href="#cb4-31" tabindex="-1"></a></span>
<span id="cb4-32"><a href="#cb4-32" tabindex="-1"></a><span class="co"># Check the value of a class variable</span></span>
<span id="cb4-33"><a href="#cb4-33" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&#39;Car model&#39;</span>, Car.model)</span>
<span id="cb4-34"><a href="#cb4-34" tabindex="-1"></a></span>
<span id="cb4-35"><a href="#cb4-35" tabindex="-1"></a><span class="co"># Inheritance</span></span>
<span id="cb4-36"><a href="#cb4-36" tabindex="-1"></a></span>
<span id="cb4-37"><a href="#cb4-37" tabindex="-1"></a><span class="kw">class</span> Sedan(Car):</span>
<span id="cb4-38"><a href="#cb4-38" tabindex="-1"></a>        </span>
<span id="cb4-39"><a href="#cb4-39" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, color, <span class="bu">type</span>, seats):</span>
<span id="cb4-40"><a href="#cb4-40" tabindex="-1"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>(color, <span class="bu">type</span>)</span>
<span id="cb4-41"><a href="#cb4-41" tabindex="-1"></a>        <span class="va">self</span>.seats <span class="op">=</span> seats</span>
<span id="cb4-42"><a href="#cb4-42" tabindex="-1"></a>        </span>
<span id="cb4-43"><a href="#cb4-43" tabindex="-1"></a><span class="kw">class</span> ElectricSedan(Sedan):</span>
<span id="cb4-44"><a href="#cb4-44" tabindex="-1"></a></span>
<span id="cb4-45"><a href="#cb4-45" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, color, <span class="bu">type</span>, seats, range_km):</span>
<span id="cb4-46"><a href="#cb4-46" tabindex="-1"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>(color, <span class="bu">type</span>, seats)</span>
<span id="cb4-47"><a href="#cb4-47" tabindex="-1"></a>        <span class="va">self</span>.range_km <span class="op">=</span> range_km</span>
<span id="cb4-48"><a href="#cb4-48" tabindex="-1"></a>        </span>
<span id="cb4-49"><a href="#cb4-49" tabindex="-1"></a>my_car <span class="op">=</span> Sedan(<span class="st">&#39;blue&#39;</span>, <span class="st">&#39;automatic&#39;</span>, <span class="dv">5</span>)</span>
<span id="cb4-50"><a href="#cb4-50" tabindex="-1"></a><span class="bu">print</span>(my_car.color)</span>
<span id="cb4-51"><a href="#cb4-51" tabindex="-1"></a><span class="bu">print</span>(my_car.seats)</span>
<span id="cb4-52"><a href="#cb4-52" tabindex="-1"></a>my_car.start()</span>
<span id="cb4-53"><a href="#cb4-53" tabindex="-1"></a></span>
<span id="cb4-54"><a href="#cb4-54" tabindex="-1"></a></span>
<span id="cb4-55"><a href="#cb4-55" tabindex="-1"></a>my_future_car <span class="op">=</span> ElectricSedan(<span class="st">&#39;red&#39;</span>, <span class="st">&#39;automatic&#39;</span>, <span class="dv">5</span>, <span class="dv">500</span>)</span>
<span id="cb4-56"><a href="#cb4-56" tabindex="-1"></a><span class="bu">print</span>(my_future_car.color)</span>
<span id="cb4-57"><a href="#cb4-57" tabindex="-1"></a><span class="bu">print</span>(my_future_car.seats)</span>
<span id="cb4-58"><a href="#cb4-58" tabindex="-1"></a><span class="bu">print</span>(my_future_car.range_km)</span>
<span id="cb4-59"><a href="#cb4-59" tabindex="-1"></a>my_future_car.start()</span></code></pre></div>
</div>
<div id="using-pyqgis-classes" class="section level1">
<h1>4. Using PyQGIS Classes</h1>
<p>Let’s start working with PyQGIS classes now. QGIS has classes for the
whole range of operations - from building the user interface to doing
geoprocessing. We will see how to access these classes via the PyQGIS
API.</p>
<div id="calculating-distance-using-pyqgis" class="section level2">
<h2>4.1 Calculating distance using PyQGIS</h2>
<p>A basic but important operation in a GIS is the calculation of
distance and areas. We will see how you can use PyQGIS APIs to compute
distances.</p>
<p>We will compute distance between the following 2 coordinates</p>
<div class="sourceCode" id="cb5"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a>san_francisco <span class="op">=</span> (<span class="fl">37.7749</span>, <span class="op">-</span><span class="fl">122.4194</span>)</span>
<span id="cb5-2"><a href="#cb5-2" tabindex="-1"></a>new_york <span class="op">=</span> (<span class="fl">40.661</span>, <span class="op">-</span><span class="fl">73.944</span>)</span></code></pre></div>
<p>QGIS provides the class <code>QgsDistanceArea</code> that has methods
to compute distances and areas.</p>
<p>To use this class, we must create an object by instantiating it.
Looking at the <a
href="https://qgis.org/pyqgis/3.40/core/QgsDistanceArea.html">class
documentation</a>, the class constructor doesn’t take any arguments. We
can use the default constructor to create an object and assign it to the
<code>d</code> variable.</p>
<div class="sourceCode" id="cb6"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a>d <span class="op">=</span> QgsDistanceArea()</span></code></pre></div>
<p>The documentation mentions that if a valid ellipsoid has been set for
the QgsDistanceArea, all calculations will be performed using
ellipsoidal algorithms (e.g. using Vincenty’s formulas). As we want to
compute the distance between a pair of latitude/longitudes, we need to
use the ellipsoidal algorithms. Let’s set the ellipsoid
<code>WGS84</code> for our calculation. We can use the method
<code>setEllipsoid()</code>. Remember, methods should be applied on
objects, and not classes directly.</p>
<div class="sourceCode" id="cb7"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a>d.setEllipsoid(<span class="st">&#39;WGS84&#39;</span>)</span></code></pre></div>
<blockquote>
<p>Tip: All valid ellipsoids can be found by calling
<code>QgsEllipsoidUtils.acronyms()</code></p>
</blockquote>
<p>Now our object <code>d</code> is capable of performing ellipsoidal
distance computations. Browsing through the available methods in the
<code>QgsDistanceArea</code> class, we can see a
<code>measureLine()</code> method. This method takes a list <a
href="https://qgis.org/pyqgis/3.40/core/QgsPointXY.html">QgsPointXY</a>
objects. We can create these objects from our coordinate pairs and pass
them on to the <code>measureLine()</code> method to get the distance.
The output will be in meters. We divide it by 1000 to convert it to
kilometers.</p>
<div class="sourceCode" id="cb8"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a>lat1, lon1 <span class="op">=</span> san_francisco</span>
<span id="cb8-2"><a href="#cb8-2" tabindex="-1"></a>lat2, lon2 <span class="op">=</span> new_york</span>
<span id="cb8-3"><a href="#cb8-3" tabindex="-1"></a><span class="co"># Remember the order is X,Y</span></span>
<span id="cb8-4"><a href="#cb8-4" tabindex="-1"></a>point1 <span class="op">=</span> QgsPointXY(lon1, lat1)</span>
<span id="cb8-5"><a href="#cb8-5" tabindex="-1"></a>point2 <span class="op">=</span> QgsPointXY(lon2, lat2)</span>
<span id="cb8-6"><a href="#cb8-6" tabindex="-1"></a></span>
<span id="cb8-7"><a href="#cb8-7" tabindex="-1"></a>distance <span class="op">=</span> d.measureLine([point1, point2])</span>
<span id="cb8-8"><a href="#cb8-8" tabindex="-1"></a><span class="bu">print</span>(distance<span class="op">/</span><span class="dv">1000</span>)</span></code></pre></div>
<p>Putting it all together, below is the complete code to calculate the
distance between a pair of coordinates using PyQGIS. When you run the
code in the Python Console of QGIS, all the PyQGIS classes are already
imported. If you are running this code from a script or a plugin, you
must explicitly import the <code>QgsDistanceArea</code> class.</p>
<div class="sourceCode" id="cb9"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a><span class="im">from</span> qgis.core <span class="im">import</span> QgsDistanceArea, QgsPointXY</span>
<span id="cb9-2"><a href="#cb9-2" tabindex="-1"></a></span>
<span id="cb9-3"><a href="#cb9-3" tabindex="-1"></a>san_francisco <span class="op">=</span> (<span class="fl">37.7749</span>, <span class="op">-</span><span class="fl">122.4194</span>)</span>
<span id="cb9-4"><a href="#cb9-4" tabindex="-1"></a>new_york <span class="op">=</span> (<span class="fl">40.661</span>, <span class="op">-</span><span class="fl">73.944</span>)</span>
<span id="cb9-5"><a href="#cb9-5" tabindex="-1"></a></span>
<span id="cb9-6"><a href="#cb9-6" tabindex="-1"></a>d <span class="op">=</span> QgsDistanceArea()</span>
<span id="cb9-7"><a href="#cb9-7" tabindex="-1"></a>d.setEllipsoid(<span class="st">&#39;WGS84&#39;</span>)</span>
<span id="cb9-8"><a href="#cb9-8" tabindex="-1"></a></span>
<span id="cb9-9"><a href="#cb9-9" tabindex="-1"></a></span>
<span id="cb9-10"><a href="#cb9-10" tabindex="-1"></a>lat1, lon1 <span class="op">=</span> san_francisco</span>
<span id="cb9-11"><a href="#cb9-11" tabindex="-1"></a>lat2, lon2 <span class="op">=</span> new_york</span>
<span id="cb9-12"><a href="#cb9-12" tabindex="-1"></a><span class="co"># Remember the order is X,Y</span></span>
<span id="cb9-13"><a href="#cb9-13" tabindex="-1"></a>point1 <span class="op">=</span> QgsPointXY(lon1, lat1)</span>
<span id="cb9-14"><a href="#cb9-14" tabindex="-1"></a>point2 <span class="op">=</span> QgsPointXY(lon2, lat2)</span>
<span id="cb9-15"><a href="#cb9-15" tabindex="-1"></a></span>
<span id="cb9-16"><a href="#cb9-16" tabindex="-1"></a>distance <span class="op">=</span> d.measureLine([point1, point2])</span>
<span id="cb9-17"><a href="#cb9-17" tabindex="-1"></a><span class="bu">print</span>(distance<span class="op">/</span><span class="dv">1000</span>)</span></code></pre></div>
</div>
<div id="exercise-1" class="section level2">
<h2>Exercise 1</h2>
<p>Let’s say you want to make a stop at Las Vegas on the way from San
Francisco to New York.</p>
<p>Calculate the total ellipsoidal distance considering a stop at Las
Vegas.</p>
<div class="sourceCode" id="cb10"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" tabindex="-1"></a>san_francisco <span class="op">=</span> (<span class="fl">37.7749</span>, <span class="op">-</span><span class="fl">122.4194</span>)</span>
<span id="cb10-2"><a href="#cb10-2" tabindex="-1"></a>new_york <span class="op">=</span> (<span class="fl">40.661</span>, <span class="op">-</span><span class="fl">73.944</span>)</span>
<span id="cb10-3"><a href="#cb10-3" tabindex="-1"></a>las_vegas <span class="op">=</span> (<span class="fl">36.1699</span>, <span class="op">-</span><span class="fl">115.1398</span>)</span></code></pre></div>
<p>If your code is correct, you should see the output distance to be
<code>4271.02</code> kilometers.</p>
</div>
<div id="distance-conversion" class="section level2">
<h2>4.2 Distance Conversion</h2>
<p>The distance returned by the <code>measureLine()</code> method in the
previous section was in meters, and we divided it by 1000 to convert it
to kilometers. Rather than doing this conversion manually, we can use
the PyQGIS API. The <code>QgsDistanceArea</code> class has a method
<code>convertLengthMeasurement()</code> that can convert the measured
distance to any supported unit. The
<code>convertLengthMeasurement()</code> method takes 2 arguments - the
length measured by <code>measureLine()</code> method and the unit to
convert the measurement to. The unit should be a value of the type
<code>Qgis.DistanceUnit</code>. The permitted values are defined in the
<a
href="https://qgis.org/pyqgis/3.40/core/Qgis.html#qgis.core.Qgis.DistanceUnit">Qgis.DistanceUnit
documentation</a>. The code below shows how to convert the measured
distance to Kilometers and Miles.</p>
<blockquote>
<p>Prior to QGIS 3.40, the unit types were specified as
<code>QgsUnitTypes.DistanceKilometers</code>.</p>
</blockquote>
<div class="sourceCode" id="cb11"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" tabindex="-1"></a><span class="im">from</span> qgis.core <span class="im">import</span> QgsDistanceArea</span>
<span id="cb11-2"><a href="#cb11-2" tabindex="-1"></a><span class="im">from</span> qgis.core <span class="im">import</span> Qgis</span>
<span id="cb11-3"><a href="#cb11-3" tabindex="-1"></a></span>
<span id="cb11-4"><a href="#cb11-4" tabindex="-1"></a>san_francisco <span class="op">=</span> (<span class="fl">37.7749</span>, <span class="op">-</span><span class="fl">122.4194</span>)</span>
<span id="cb11-5"><a href="#cb11-5" tabindex="-1"></a>new_york <span class="op">=</span> (<span class="fl">40.661</span>, <span class="op">-</span><span class="fl">73.944</span>)</span>
<span id="cb11-6"><a href="#cb11-6" tabindex="-1"></a></span>
<span id="cb11-7"><a href="#cb11-7" tabindex="-1"></a>d <span class="op">=</span> QgsDistanceArea()</span>
<span id="cb11-8"><a href="#cb11-8" tabindex="-1"></a>d.setEllipsoid(<span class="st">&#39;WGS84&#39;</span>)</span>
<span id="cb11-9"><a href="#cb11-9" tabindex="-1"></a></span>
<span id="cb11-10"><a href="#cb11-10" tabindex="-1"></a></span>
<span id="cb11-11"><a href="#cb11-11" tabindex="-1"></a>lat1, lon1 <span class="op">=</span> san_francisco</span>
<span id="cb11-12"><a href="#cb11-12" tabindex="-1"></a>lat2, lon2 <span class="op">=</span> new_york</span>
<span id="cb11-13"><a href="#cb11-13" tabindex="-1"></a><span class="co"># Remember the order is X,Y</span></span>
<span id="cb11-14"><a href="#cb11-14" tabindex="-1"></a>point1 <span class="op">=</span> QgsPointXY(lon1, lat1)</span>
<span id="cb11-15"><a href="#cb11-15" tabindex="-1"></a>point2 <span class="op">=</span> QgsPointXY(lon2, lat2)</span>
<span id="cb11-16"><a href="#cb11-16" tabindex="-1"></a></span>
<span id="cb11-17"><a href="#cb11-17" tabindex="-1"></a>distance <span class="op">=</span> d.measureLine([point1, point2])</span>
<span id="cb11-18"><a href="#cb11-18" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&#39;Distance in meters&#39;</span>, distance)</span>
<span id="cb11-19"><a href="#cb11-19" tabindex="-1"></a></span>
<span id="cb11-20"><a href="#cb11-20" tabindex="-1"></a>distance_km <span class="op">=</span> d.convertLengthMeasurement(distance, Qgis.DistanceUnit.Kilometers)</span>
<span id="cb11-21"><a href="#cb11-21" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&#39;Distance in kilometers&#39;</span>, distance_km)</span>
<span id="cb11-22"><a href="#cb11-22" tabindex="-1"></a></span>
<span id="cb11-23"><a href="#cb11-23" tabindex="-1"></a>distance_mi <span class="op">=</span> d.convertLengthMeasurement(distance, Qgis.DistanceUnit.Miles)</span>
<span id="cb11-24"><a href="#cb11-24" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&#39;Distance in miles&#39;</span>, distance_mi)</span></code></pre></div>
<p><img src="images/pyqgis/distance.png" width="75%" style="display: block; margin: auto;" /></p>
</div>
</div>
<div id="graphical-user-interface-gui-programming-basics"
class="section level1">
<h1>5. Graphical User Interface (GUI) Programming Basics</h1>
<p><a
href="https://www.youtube.com/watch?v=g3Vwqg7WAHc&amp;list=PLppGmFLhQ1HKKnk3riKNyOxb-3MTI-7zE&amp;index=9"
target="_blank"><img
src="https://img.youtube.com/vi/g3Vwqg7WAHc/mqdefault.jpg"
alt="Watch the Video" /></a></p>
<p><a
href="https://www.youtube.com/watch?v=g3Vwqg7WAHc&amp;list=PLppGmFLhQ1HKKnk3riKNyOxb-3MTI-7zE&amp;index=9"
target="_blank">Watch the Video ↗</a></p>
<p><a
href="https://docs.google.com/presentation/d/1eK75jjfKx1IznIPrfcEljokLLQwkbNJ2DoStXDkF_f4/edit?usp=sharing"
target="_blank">View the Presentation ↗</a></p>
<div id="qt-and-pyqt" class="section level2">
<h2>5.1 Qt and PyQt</h2>
<p><a href="https://www.qt.io/">Qt</a> is a free and open-source widget
toolkit for creating graphical user interfaces as well as cross-platform
applications. QGIS is built using the Qt platform. Both Qt and QGIS
itself have well-documented APIs that should be used when writing Python
code to be run within QGIS.</p>
<p><a href="https://wiki.python.org/moin/PyQt">PyQt</a> is the Python
interface to Qt. PyQt provides classes and functions to interact with Qt
widgets.</p>
</div>
<div id="building-a-dialog-box" class="section level2">
<h2>5.2 Building a Dialog Box</h2>
<p>Let’s learn how to use PyQt classes to create and interact with GUI
elements. Here we will create a simple dialog box that prompts a user
for confirmation. You can type the code in the <strong>Editor</strong>
and click <strong>Run Script</strong>.</p>
<div class="sourceCode" id="cb12"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" tabindex="-1"></a>mb <span class="op">=</span> QMessageBox()</span></code></pre></div>
<p>The <code>QMessageBox</code> is a PyQt class for creating a dialog
with buttons. To use the class, you create an object by
<em>instantiating</em> the class. Here <code>mb</code> is an object,
which is an instance of the <code>QMessageBox</code> class, created
using the default parameters.</p>
<p><code>type()</code> tells you what is the class of the object</p>
<div class="sourceCode" id="cb13"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" tabindex="-1"></a><span class="bu">type</span>(mb)</span></code></pre></div>
<p><code>dir</code> returns list of the attributes and methods of any
object</p>
<div class="sourceCode" id="cb14"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" tabindex="-1"></a><span class="bu">dir</span>(mb)</span></code></pre></div>
<p>Classes have methods that provide functionality. You can run the
class methods on instance objects. For the <code>QMessageBox</code>
class, <code>setText()</code> method will add a text to the dialog.</p>
<div class="sourceCode" id="cb15"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" tabindex="-1"></a>mb <span class="op">=</span> QMessageBox()</span>
<span id="cb15-2"><a href="#cb15-2" tabindex="-1"></a>mb.setText(<span class="st">&#39;Click OK to confirm&#39;</span>)</span></code></pre></div>
<p>Classes also have class attributes which are shared across all
instances. The <code>QMessageBox</code> class has <code>Ok</code> and
<code>Cancel</code> attributes, which can be referred using
<code>QMessageBox.Ok</code> and <code>QMessageBox.Cancel</code>.</p>
<div class="sourceCode" id="cb16"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" tabindex="-1"></a>mb <span class="op">=</span> QMessageBox()</span>
<span id="cb16-2"><a href="#cb16-2" tabindex="-1"></a>mb.setText(<span class="st">&#39;Click OK to confirm&#39;</span>)</span>
<span id="cb16-3"><a href="#cb16-3" tabindex="-1"></a>mb.setStandardButtons(QMessageBox.Ok <span class="op">|</span> QMessageBox.Cancel)</span></code></pre></div>
<p>To see the dialog, we need to use the <code>exec()</code> method. The
user input is then captured and saved in the <code>return_value</code>
variable.</p>
<p>The complete code snippet is as follows.Try it out and see the result
of your action reflect in the Python Console.</p>
<div class="sourceCode" id="cb17"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" tabindex="-1"></a>mb <span class="op">=</span> QMessageBox()</span>
<span id="cb17-2"><a href="#cb17-2" tabindex="-1"></a>mb.setText(<span class="st">&#39;Click OK to confirm&#39;</span>)</span>
<span id="cb17-3"><a href="#cb17-3" tabindex="-1"></a>mb.setStandardButtons(QMessageBox.Ok <span class="op">|</span> QMessageBox.Cancel)</span>
<span id="cb17-4"><a href="#cb17-4" tabindex="-1"></a>return_value <span class="op">=</span> mb.<span class="bu">exec</span>()</span>
<span id="cb17-5"><a href="#cb17-5" tabindex="-1"></a><span class="cf">if</span> return_value <span class="op">==</span> QMessageBox.Ok:</span>
<span id="cb17-6"><a href="#cb17-6" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&#39;You pressed OK&#39;</span>)</span>
<span id="cb17-7"><a href="#cb17-7" tabindex="-1"></a><span class="cf">elif</span> return_value <span class="op">==</span> QMessageBox.Cancel:</span>
<span id="cb17-8"><a href="#cb17-8" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&#39;You pressed Cancel&#39;</span>)</span></code></pre></div>
<p><img src="images/pyqgis/messagebox.png" width="75%" style="display: block; margin: auto;" /></p>
</div>
</div>
<div id="deep-dive-into-pyqgis" class="section level1">
<h1>6. Deep Dive into PyQGIS</h1>
<p><a
href="https://docs.qgis.org/testing/en/docs/pyqgis_developer_cookbook/">PyQGIS</a>
is the Python interface to QGIS. It is created using SIP and integrates
with PyQt.</p>
<blockquote>
<p><strong><em>Fun Fact:</em></strong> Most QGIS class names start with
the prefix <em>Qgs</em>. <strong>Q</strong> is for Qt and
<strong>gs</strong> stands for Gary Sherman - the founder of the QGIS
project.</p>
</blockquote>
<p>QGIS C++ API documentation is available at <a
href="https://qgis.org/api/3.40/"
class="uri">https://qgis.org/api/3.40/</a></p>
<p>QGIS Python API documentation is available at <a
href="https://qgis.org/pyqgis/3.40/"
class="uri">https://qgis.org/pyqgis/3.40/</a></p>
<p>Both C++ and Python APIs are identical for most part, but certain
functions are not available in the Python API. <a href="#fn1"
class="footnote-ref" id="fnref1"><sup>1</sup></a></p>
<div id="qgis-interface-api-qgisinterface" class="section level2">
<h2>6.1 QGIS Interface API (QgisInterface)</h2>
<p>You are ready to dive into the PyQGIS API now. In this section, we
will focus on the <a
href="https://qgis.org/pyqgis/3.40/gui/QgisInterface.html"><code>QgisInterface</code></a>
class - which provides methods for interaction with the QGIS
environment. When QGIS is running, a variable called <code>iface</code>
is set up to provide an object of the class <code>QgisInterface</code>
to interact with the running QGIS environment. This interface allows
access to the map canvas, menus, toolbars and other parts of the QGIS
application. Python Console and Plugins can use <code>iface</code> to
access various parts of the QGIS interface.</p>
<p><a
href="https://www.youtube.com/watch?v=rgOu6Qq_6Jg&amp;list=PLppGmFLhQ1HKKnk3riKNyOxb-3MTI-7zE&amp;index=10"
target="_blank"><img
src="https://img.youtube.com/vi/rgOu6Qq_6Jg/mqdefault.jpg"
alt="Watch the Video" /></a></p>
<p><a
href="https://www.youtube.com/watch?v=rgOu6Qq_6Jg&amp;list=PLppGmFLhQ1HKKnk3riKNyOxb-3MTI-7zE&amp;index=10"
target="_blank">Watch the Video ↗</a></p>
<div id="change-title-of-qgis-main-window" class="section level3">
<h3>6.1.1 Change Title of QGIS Main Window</h3>
<div class="sourceCode" id="cb18"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" tabindex="-1"></a>title <span class="op">=</span> iface.mainWindow().windowTitle()</span>
<span id="cb18-2"><a href="#cb18-2" tabindex="-1"></a>new_title <span class="op">=</span> title.replace(<span class="st">&#39;QGIS&#39;</span>, <span class="st">&#39;My QGIS&#39;</span>)</span>
<span id="cb18-3"><a href="#cb18-3" tabindex="-1"></a>iface.mainWindow().setWindowTitle(new_title)</span></code></pre></div>
</div>
<div id="remove-raster-and-vector-menus" class="section level3">
<h3>6.1.2 Remove Raster and Vector Menus</h3>
<div class="sourceCode" id="cb19"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" tabindex="-1"></a>vector_menu <span class="op">=</span> iface.vectorMenu()</span>
<span id="cb19-2"><a href="#cb19-2" tabindex="-1"></a>raster_menu <span class="op">=</span> iface.rasterMenu()</span>
<span id="cb19-3"><a href="#cb19-3" tabindex="-1"></a>menubar <span class="op">=</span> vector_menu.parentWidget()</span>
<span id="cb19-4"><a href="#cb19-4" tabindex="-1"></a>menubar.removeAction(vector_menu.menuAction())</span>
<span id="cb19-5"><a href="#cb19-5" tabindex="-1"></a>menubar.removeAction(raster_menu.menuAction())</span></code></pre></div>
<p><img src="images/pyqgis/menu2.1.png" width="75%" style="display: block; margin: auto;" /></p>
<p><img src="images/pyqgis/menu2.2.png" width="75%" style="display: block; margin: auto;" /></p>
</div>
<div id="understanding-signals-and-slots" class="section level3">
<h3>6.1.3 Understanding Signals and Slots</h3>
<p>GUI programming requires responding to user’s actions. All objects in
Qt have a mechanism where they can emit a signal when there is a change
in status. i.e. when a user <em>clicks</em> a button, or a window is
<em>closed</em>. As a programmer, you can connect the signal to a slot
(i.e. a python function) which will be called when the signal is
emitted. The general syntax for connecting the signal to a slot is
<code>&lt;object&gt;.&lt;signal&gt;.connect(function)</code>.</p>
</div>
<div id="add-a-new-menu-item" class="section level3">
<h3>6.1.4 Add A New Menu Item</h3>
<p>A new button or menu item is created using <code>QAction()</code>.
Here we create an action and then connect the <em>click</em> signal to a
method that opens a website.</p>
<div class="sourceCode" id="cb20"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" tabindex="-1"></a><span class="im">import</span> webbrowser</span>
<span id="cb20-2"><a href="#cb20-2" tabindex="-1"></a></span>
<span id="cb20-3"><a href="#cb20-3" tabindex="-1"></a><span class="kw">def</span> open_website():</span>
<span id="cb20-4"><a href="#cb20-4" tabindex="-1"></a>    webbrowser.<span class="bu">open</span>(<span class="st">&#39;https://gis.stackexchange.com&#39;</span>)</span>
<span id="cb20-5"><a href="#cb20-5" tabindex="-1"></a></span>
<span id="cb20-6"><a href="#cb20-6" tabindex="-1"></a>website_action <span class="op">=</span> QAction(<span class="st">&#39;Go to gis.stackexchange&#39;</span>)</span>
<span id="cb20-7"><a href="#cb20-7" tabindex="-1"></a>website_action.triggered.<span class="ex">connect</span>(open_website)</span>
<span id="cb20-8"><a href="#cb20-8" tabindex="-1"></a>iface.helpMenu().addSeparator()</span>
<span id="cb20-9"><a href="#cb20-9" tabindex="-1"></a>iface.helpMenu().addAction(website_action)</span></code></pre></div>
<p><img src="images/pyqgis/menu3.png" width="50%" style="display: block; margin: auto;" /></p>
</div>
<div id="change-visibility-of-a-toolbar" class="section level3">
<h3>6.1.5 Change Visibility of a Toolbar</h3>
<div class="sourceCode" id="cb21"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" tabindex="-1"></a>iface.pluginToolBar().setVisible(<span class="va">True</span>)</span></code></pre></div>
</div>
<div id="add-a-button-to-a-toolbar" class="section level3">
<h3>6.1.6 Add a button to a toolbar</h3>
<blockquote>
<p><code>os.path.expanduser('~')</code> returns the path to the home
directory of the user.</p>
</blockquote>
<div class="sourceCode" id="cb22"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb22-2"><a href="#cb22-2" tabindex="-1"></a><span class="im">from</span> datetime <span class="im">import</span> datetime</span>
<span id="cb22-3"><a href="#cb22-3" tabindex="-1"></a></span>
<span id="cb22-4"><a href="#cb22-4" tabindex="-1"></a>icon <span class="op">=</span> <span class="st">&#39;question.svg&#39;</span></span>
<span id="cb22-5"><a href="#cb22-5" tabindex="-1"></a>data_dir <span class="op">=</span> os.path.join(os.path.expanduser(<span class="st">&#39;~&#39;</span>), <span class="st">&#39;Downloads&#39;</span>, <span class="st">&#39;pyqgis_masterclass&#39;</span>)</span>
<span id="cb22-6"><a href="#cb22-6" tabindex="-1"></a>icon_path <span class="op">=</span> os.path.join(data_dir, icon)</span>
<span id="cb22-7"><a href="#cb22-7" tabindex="-1"></a></span>
<span id="cb22-8"><a href="#cb22-8" tabindex="-1"></a><span class="kw">def</span> show_time():</span>
<span id="cb22-9"><a href="#cb22-9" tabindex="-1"></a>    now <span class="op">=</span> datetime.now()</span>
<span id="cb22-10"><a href="#cb22-10" tabindex="-1"></a>    current_time <span class="op">=</span> now.strftime(<span class="st">&quot;%H:%M:%S&quot;</span>)</span>
<span id="cb22-11"><a href="#cb22-11" tabindex="-1"></a>    iface.messageBar().pushInfo(<span class="st">&#39;Current Time&#39;</span>, current_time)</span>
<span id="cb22-12"><a href="#cb22-12" tabindex="-1"></a></span>
<span id="cb22-13"><a href="#cb22-13" tabindex="-1"></a>action <span class="op">=</span> QAction(<span class="st">&#39;Show Time&#39;</span>)</span>
<span id="cb22-14"><a href="#cb22-14" tabindex="-1"></a>action.triggered.<span class="ex">connect</span>(show_time)</span>
<span id="cb22-15"><a href="#cb22-15" tabindex="-1"></a>action.setIcon(QIcon(icon_path))</span>
<span id="cb22-16"><a href="#cb22-16" tabindex="-1"></a>iface.addToolBarIcon(action)</span></code></pre></div>
<p><img src="images/pyqgis/toolbar2.png" width="75%" style="display: block; margin: auto;" /></p>
</div>
</div>
<div id="exercise-2" class="section level2">
<h2>Exercise 2</h2>
<p>In the previous example, the alert is displayed in the QGIS message
bar as an <em>Info</em> message. Change the type of the message to a
<em>Warning</em> message.</p>
<p>Hint: Look at the appropriate method in the <a
href="https://qgis.org/pyqgis/3.40/gui/QgsMessageBar.html">QgsMessageBar</a>
class</p>
<p>Challenge: The warning message does not have a time out and needs to
be manually cleared. Can you change the your solution to display a
warning message with a 5 second time-out? Hint: Look at the
<code>pushMessage()</code> method.</p>
<div id="add-new-layers" class="section level3">
<h3>6.1.7 Add New Layers</h3>
<p>Data sources are identified by an URI (Uniform Resource
Identifier)</p>
<ul>
<li>For files on computer the URI is the file path</li>
<li>For databases, the URI is constructed using the
<code>QgsDataSourceUri</code> class and encodes,the database path,
table, username, password etc.</li>
<li>For web layers, such as WMF/WFS etc, the URI is the web URL</li>
</ul>
<p>Refer to the <a
href="https://docs.qgis.org/3.40/en/docs/pyqgis_developer_cookbook/loadlayer.html">PyQGIS
Developer Cookbook</a> for examples of how to construct the URI for
different types of data.</p>
<div class="sourceCode" id="cb23"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb23-2"><a href="#cb23-2" tabindex="-1"></a>data_dir <span class="op">=</span> os.path.join(os.path.expanduser(<span class="st">&#39;~&#39;</span>), <span class="st">&#39;Downloads&#39;</span>, <span class="st">&#39;pyqgis_masterclass&#39;</span>)</span>
<span id="cb23-3"><a href="#cb23-3" tabindex="-1"></a></span>
<span id="cb23-4"><a href="#cb23-4" tabindex="-1"></a>filename <span class="op">=</span> <span class="st">&#39;seismic_zones.shp&#39;</span></span>
<span id="cb23-5"><a href="#cb23-5" tabindex="-1"></a>uri <span class="op">=</span> os.path.join(data_dir, filename)</span>
<span id="cb23-6"><a href="#cb23-6" tabindex="-1"></a>iface.addVectorLayer(uri, <span class="st">&#39;seismic_zones&#39;</span>, <span class="st">&#39;ogr&#39;</span>)</span>
<span id="cb23-7"><a href="#cb23-7" tabindex="-1"></a></span>
<span id="cb23-8"><a href="#cb23-8" tabindex="-1"></a>filename <span class="op">=</span> <span class="st">&#39;sf.gpkg|layername=zoning&#39;</span></span>
<span id="cb23-9"><a href="#cb23-9" tabindex="-1"></a>uri <span class="op">=</span> os.path.join(data_dir, filename)</span>
<span id="cb23-10"><a href="#cb23-10" tabindex="-1"></a>iface.addVectorLayer(uri, <span class="st">&#39;zoning&#39;</span>, <span class="st">&#39;ogr&#39;</span>)</span></code></pre></div>
<p><img src="images/pyqgis/vectorlayer.png" width="50%" style="display: block; margin: auto;" /></p>
</div>
<div id="change-name-of-a-layer" class="section level3">
<h3>6.1.8 Change name of a Layer</h3>
<div class="sourceCode" id="cb24"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" tabindex="-1"></a>layer <span class="op">=</span> iface.activeLayer()</span>
<span id="cb24-2"><a href="#cb24-2" tabindex="-1"></a>name <span class="op">=</span> layer.name()</span>
<span id="cb24-3"><a href="#cb24-3" tabindex="-1"></a>layer.setName(<span class="st">&#39;sf_&#39;</span> <span class="op">+</span> name)</span></code></pre></div>
</div>
</div>
<div id="exercise-3" class="section level2">
<h2>Exercise 3</h2>
<p>Write a code snippet that checks the active layer selected by the
user. If the active layer is named <code>zoning</code>, display a
success message in the message bar, else display an error message.</p>
<p><img src="images/pyqgis/success.png" width="75%" style="display: block; margin: auto;" />
<img src="images/pyqgis/error.png" width="75%" style="display: block; margin: auto;" /></p>
</div>
<div id="qgis-project-api-qgsproject" class="section level2">
<h2>6.2 QGIS Project API (QgsProject)</h2>
<p>Another very important QGIS class is <a
href="https://qgis.org/pyqgis/3.40/core/QgsProject.html"><code>QgsProject</code></a>.
This class is used for all operations in a QGIS project - including
adding/removing map layers, styling, print layouts etc. The
<code>QgsProject</code> is a <strong>Singleton Class</strong> - meaning
it can have only 1 instance at a time. The instance refers to the
current QGIS project that is loaded. When QGIS starts, a blank project
is created. When you load another project, the existing project is
closed and a new project instance is created. You can get the current
instance of the QgsProject class by calling the
<strong><code>QgsProject.instance()</code></strong> method.</p>
<p><a
href="https://www.youtube.com/watch?v=32VVt60TO_A&amp;list=PLppGmFLhQ1HKKnk3riKNyOxb-3MTI-7zE&amp;index=14"
target="_blank"><img
src="https://img.youtube.com/vi/32VVt60TO_A/mqdefault.jpg"
alt="Watch the Video" /></a></p>
<p><a
href="https://www.youtube.com/watch?v=32VVt60TO_A&amp;list=PLppGmFLhQ1HKKnk3riKNyOxb-3MTI-7zE&amp;index=14"
target="_blank">Watch the Video ↗</a></p>
<div id="load-a-project" class="section level3">
<h3>6.2.1 Load a project</h3>
<div class="sourceCode" id="cb25"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb25-2"><a href="#cb25-2" tabindex="-1"></a>data_dir <span class="op">=</span> os.path.join(os.path.expanduser(<span class="st">&#39;~&#39;</span>), <span class="st">&#39;Downloads&#39;</span>, <span class="st">&#39;pyqgis_masterclass&#39;</span>)</span>
<span id="cb25-3"><a href="#cb25-3" tabindex="-1"></a></span>
<span id="cb25-4"><a href="#cb25-4" tabindex="-1"></a>project <span class="op">=</span> QgsProject.instance()</span>
<span id="cb25-5"><a href="#cb25-5" tabindex="-1"></a>project_name <span class="op">=</span> <span class="st">&#39;sf.qgz&#39;</span></span>
<span id="cb25-6"><a href="#cb25-6" tabindex="-1"></a>project_path <span class="op">=</span> os.path.join(data_dir, project_name)</span>
<span id="cb25-7"><a href="#cb25-7" tabindex="-1"></a>project.read(project_path)</span></code></pre></div>
<p><img src="images/pyqgis/project.png" width="75%" style="display: block; margin: auto;" /></p>
</div>
<div id="load-projects-using-a-dropdown-menu" class="section level3">
<h3>6.2.2 Load Projects using a Dropdown Menu</h3>
<p>The code snippet below shows how to create a new toolbar with a label
and a drop-down menu. Selecting an item will load the project with that
name.</p>
<p><img src="images/pyqgis/project_selector.png" width="266" style="display: block; margin: auto;" /></p>
<div class="sourceCode" id="cb26"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb26-2"><a href="#cb26-2" tabindex="-1"></a>data_dir <span class="op">=</span> os.path.join(os.path.expanduser(<span class="st">&#39;~&#39;</span>), <span class="st">&#39;Downloads&#39;</span>, <span class="st">&#39;pyqgis_masterclass&#39;</span>)</span>
<span id="cb26-3"><a href="#cb26-3" tabindex="-1"></a></span>
<span id="cb26-4"><a href="#cb26-4" tabindex="-1"></a>projectToolbar <span class="op">=</span> iface.addToolBar(<span class="st">&#39;Project Selector&#39;</span>)</span>
<span id="cb26-5"><a href="#cb26-5" tabindex="-1"></a></span>
<span id="cb26-6"><a href="#cb26-6" tabindex="-1"></a>label <span class="op">=</span> QLabel(<span class="st">&#39;Select a project to load&#39;</span>, parent<span class="op">=</span>projectToolbar)</span>
<span id="cb26-7"><a href="#cb26-7" tabindex="-1"></a>projectSelector <span class="op">=</span> QComboBox(parent<span class="op">=</span>projectToolbar)</span>
<span id="cb26-8"><a href="#cb26-8" tabindex="-1"></a>projectSelector.addItem(<span class="st">&#39;sf.qgz&#39;</span>)</span>
<span id="cb26-9"><a href="#cb26-9" tabindex="-1"></a>projectSelector.addItem(<span class="st">&#39;places.qgz&#39;</span>)</span>
<span id="cb26-10"><a href="#cb26-10" tabindex="-1"></a>projectSelector.setCurrentIndex(<span class="op">-</span><span class="dv">1</span>)</span>
<span id="cb26-11"><a href="#cb26-11" tabindex="-1"></a></span>
<span id="cb26-12"><a href="#cb26-12" tabindex="-1"></a><span class="kw">def</span> loadProject(projectName):</span>
<span id="cb26-13"><a href="#cb26-13" tabindex="-1"></a>    project <span class="op">=</span> QgsProject.instance()</span>
<span id="cb26-14"><a href="#cb26-14" tabindex="-1"></a>    project_path <span class="op">=</span> os.path.join(data_dir, projectName)</span>
<span id="cb26-15"><a href="#cb26-15" tabindex="-1"></a>    project.read(project_path)</span>
<span id="cb26-16"><a href="#cb26-16" tabindex="-1"></a></span>
<span id="cb26-17"><a href="#cb26-17" tabindex="-1"></a>projectSelector.currentTextChanged.<span class="ex">connect</span>(loadProject)</span>
<span id="cb26-18"><a href="#cb26-18" tabindex="-1"></a>projectToolbar.addWidget(label)</span>
<span id="cb26-19"><a href="#cb26-19" tabindex="-1"></a>projectToolbar.addWidget(projectSelector)</span></code></pre></div>
</div>
<div id="create-a-new-vector-layer" class="section level3">
<h3>6.2.3 Create a New Vector Layer</h3>
<p>We will now create a temporary memory layer using PyQGIS. Memory
layers are not saved to the disk and ideal to store intermediate
results. The code snippet below creates a polygon layer with the extent
of the current map canvas.</p>
<div class="sourceCode" id="cb27"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" tabindex="-1"></a>mc <span class="op">=</span> iface.mapCanvas()</span>
<span id="cb27-2"><a href="#cb27-2" tabindex="-1"></a>extent <span class="op">=</span> mc.extent()</span>
<span id="cb27-3"><a href="#cb27-3" tabindex="-1"></a></span>
<span id="cb27-4"><a href="#cb27-4" tabindex="-1"></a>vlayer <span class="op">=</span> QgsVectorLayer(<span class="st">&#39;Polygon&#39;</span>, <span class="st">&#39;extent&#39;</span>, <span class="st">&#39;memory&#39;</span>)</span>
<span id="cb27-5"><a href="#cb27-5" tabindex="-1"></a>crs <span class="op">=</span> QgsProject.instance().crs()</span>
<span id="cb27-6"><a href="#cb27-6" tabindex="-1"></a>vlayer.setCrs(crs)</span>
<span id="cb27-7"><a href="#cb27-7" tabindex="-1"></a></span>
<span id="cb27-8"><a href="#cb27-8" tabindex="-1"></a>provider <span class="op">=</span> vlayer.dataProvider()</span>
<span id="cb27-9"><a href="#cb27-9" tabindex="-1"></a></span>
<span id="cb27-10"><a href="#cb27-10" tabindex="-1"></a>f <span class="op">=</span> QgsFeature()</span>
<span id="cb27-11"><a href="#cb27-11" tabindex="-1"></a>geometry <span class="op">=</span> QgsGeometry.fromRect(extent)</span>
<span id="cb27-12"><a href="#cb27-12" tabindex="-1"></a>f.setGeometry(geometry)</span>
<span id="cb27-13"><a href="#cb27-13" tabindex="-1"></a></span>
<span id="cb27-14"><a href="#cb27-14" tabindex="-1"></a>provider.addFeature(f)</span>
<span id="cb27-15"><a href="#cb27-15" tabindex="-1"></a>vlayer.updateExtents() </span>
<span id="cb27-16"><a href="#cb27-16" tabindex="-1"></a></span>
<span id="cb27-17"><a href="#cb27-17" tabindex="-1"></a>QgsProject.instance().addMapLayer(vlayer)</span></code></pre></div>
</div>
</div>
<div id="exercise-4" class="section level2">
<h2>Exercise 4</h2>
<p>The following code snippet creates a toolbar called <em>CRS
Toolbar</em> with a label, textbox and a button. When the button is
clicked, the function <code>changeCRS</code> is called. Implement this
function so that it changes the CRS of the current project to the EPSG
code entered by the user.</p>
<p>Hint: Use <a
href="https://qgis.org/pyqgis/3.40/core/QgsProject.html"><code>QgsProject.instance().setCrs()</code></a>
method.</p>
<p><img src="images/pyqgis/crs_selector.png" width="75%" style="display: block; margin: auto;" /></p>
<div class="sourceCode" id="cb28"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" tabindex="-1"></a>crsToolbar <span class="op">=</span> iface.addToolBar(<span class="st">&#39;CRS Toolbar&#39;</span>)</span>
<span id="cb28-2"><a href="#cb28-2" tabindex="-1"></a></span>
<span id="cb28-3"><a href="#cb28-3" tabindex="-1"></a>label <span class="op">=</span> QLabel(<span class="st">&#39;Enter an EPSG Code&#39;</span>, parent<span class="op">=</span>crsToolbar)</span>
<span id="cb28-4"><a href="#cb28-4" tabindex="-1"></a>crsTextBox <span class="op">=</span> QLineEdit(<span class="st">&#39;4326&#39;</span>, parent<span class="op">=</span>crsToolbar)</span>
<span id="cb28-5"><a href="#cb28-5" tabindex="-1"></a>crsTextBox.setFixedWidth(<span class="dv">80</span>)</span>
<span id="cb28-6"><a href="#cb28-6" tabindex="-1"></a>button <span class="op">=</span> QPushButton(<span class="st">&#39;Go!&#39;</span>, parent<span class="op">=</span>crsToolbar)</span>
<span id="cb28-7"><a href="#cb28-7" tabindex="-1"></a></span>
<span id="cb28-8"><a href="#cb28-8" tabindex="-1"></a>crsToolbar.addWidget(label)</span>
<span id="cb28-9"><a href="#cb28-9" tabindex="-1"></a>crsToolbar.addWidget(crsTextBox)</span>
<span id="cb28-10"><a href="#cb28-10" tabindex="-1"></a>crsToolbar.addWidget(button)</span>
<span id="cb28-11"><a href="#cb28-11" tabindex="-1"></a></span>
<span id="cb28-12"><a href="#cb28-12" tabindex="-1"></a><span class="kw">def</span> changeCrs(crsText):</span>
<span id="cb28-13"><a href="#cb28-13" tabindex="-1"></a>    epsgCode <span class="op">=</span> <span class="bu">int</span>(crsTextBox.text())</span>
<span id="cb28-14"><a href="#cb28-14" tabindex="-1"></a>    iface.messageBar().pushInfo(<span class="st">&#39;Function called&#39;</span>, <span class="ss">f&#39;You entered </span><span class="sc">{</span>epsgCode<span class="sc">}</span><span class="ss">&#39;</span>)</span>
<span id="cb28-15"><a href="#cb28-15" tabindex="-1"></a>    <span class="co"># Add code to change the project CRS to the EPSG code</span></span>
<span id="cb28-16"><a href="#cb28-16" tabindex="-1"></a></span>
<span id="cb28-17"><a href="#cb28-17" tabindex="-1"></a>button.clicked.<span class="ex">connect</span>(changeCrs)</span></code></pre></div>
</div>
</div>
<div id="running-python-code-at-qgis-launch" class="section level1">
<h1>7. Running Python Code at QGIS Launch</h1>
<p><a
href="https://www.youtube.com/watch?v=ZQNTKS2y4cE&amp;list=PLppGmFLhQ1HKKnk3riKNyOxb-3MTI-7zE&amp;index=16"
target="_blank"><img
src="https://img.youtube.com/vi/ZQNTKS2y4cE/mqdefault.jpg"
alt="Watch the Video" /></a></p>
<p><a
href="https://www.youtube.com/watch?v=ZQNTKS2y4cE&amp;list=PLppGmFLhQ1HKKnk3riKNyOxb-3MTI-7zE&amp;index=16"
target="_blank">Watch the Video ↗</a></p>
<p>It is possible to execute some PyQGIS code every time QGIS starts.
QGIS looks for a file named <code>startup.py</code> in the user’s Python
home directory, and if it is found, executes it. This file is very
useful in customizing QGIS interface with techniques learnt in the
previous section.</p>
<p>If you are running multiple versions of QGIS, a very useful
customization is to display the QGIS version number and name in the main
window. The version name is stored in a global QGIS variable called
<code>qgis_version</code>. We can read that variable and set the main
window’s title with it. We connect this code to the signal
<code>iface.initializationCompleted</code> signal when the main window
is loaded.</p>
<p>Create a new file named <code>startup.py</code> with the following
code. Note the imports at the top - including <code>iface</code>. When
we ran the code snippets in the Python Console, we did not have to
import any modules since they are done automatically when the console
starts. For pyqgis scripts elsewhere, we have to explicitly import the
modules (classes) that we want to use.</p>
<div class="sourceCode" id="cb29"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" tabindex="-1"></a><span class="im">from</span> qgis.utils <span class="im">import</span> iface</span>
<span id="cb29-2"><a href="#cb29-2" tabindex="-1"></a><span class="im">from</span> qgis.core <span class="im">import</span> QgsExpressionContextUtils</span>
<span id="cb29-3"><a href="#cb29-3" tabindex="-1"></a></span>
<span id="cb29-4"><a href="#cb29-4" tabindex="-1"></a><span class="kw">def</span> customize():</span>
<span id="cb29-5"><a href="#cb29-5" tabindex="-1"></a>    version <span class="op">=</span> QgsExpressionContextUtils.globalScope().variable(<span class="st">&#39;qgis_version&#39;</span>)</span>
<span id="cb29-6"><a href="#cb29-6" tabindex="-1"></a>    title <span class="op">=</span> iface.mainWindow().windowTitle()</span>
<span id="cb29-7"><a href="#cb29-7" tabindex="-1"></a>    iface.mainWindow().setWindowTitle(<span class="ss">f&#39;</span><span class="sc">{</span>title<span class="sc">}</span><span class="ss"> | </span><span class="sc">{</span>version<span class="sc">}</span><span class="ss">&#39;</span>)</span>
<span id="cb29-8"><a href="#cb29-8" tabindex="-1"></a></span>
<span id="cb29-9"><a href="#cb29-9" tabindex="-1"></a></span>
<span id="cb29-10"><a href="#cb29-10" tabindex="-1"></a>iface.initializationCompleted.<span class="ex">connect</span>(customize)</span></code></pre></div>
<p>This file needs to be copied to the appropriate directory on your
system. See <a
href="https://docs.qgis.org/testing/en/docs/pyqgis_developer_cookbook/intro.html#running-python-code-when-qgis-starts">QGIS
documentation</a> for details on the path for your platform.</p>
<p><img src="images/pyqgis/startup.png" width="75%" style="display: block; margin: auto;" /></p>
<p>Once you copy the file at that location, restart QGIS. The title bar
should now have the QGIS version name in it.</p>
<p><img src="images/pyqgis/customtitle.png" width="75%" style="display: block; margin: auto;" /></p>
<blockquote>
<p>Pro Tip: It is possible to put the <code>startup.py</code> file on a
shared drive for enterprise deployment of QGIS customizations. <a
href="https://gis.stackexchange.com/questions/319224/central-deployment-of-startup-py-in-qgis/319225">Learn
more</a>.</p>
</blockquote>
<div id="exercise-5" class="section level2">
<h2>Exercise 5</h2>
<p>Trying opening a new project in QGIS after you have restarted GIS
with <code>startup.py</code> file in place. You will notice that the
custom title with the version name is replaced with the default
title.</p>
<p>Make a change to your <code>startup.py</code> so that the
customization is applied even when a new project is loaded.</p>
</div>
</div>
<div id="running-processing-algorithms" class="section level1">
<h1>8. Running Processing Algorithms</h1>
<p>While the PyQGIS API providers many functions to work with layers,
features, attributes and geometry - it is a much better practice to use
the built-in processing algorithms to alter the layers or do any
analysis. This will give you better performance and result in much
lesser code. Here are some examples on how to use processing algorithms
from Python to do vector and raster layer editing. You will find more
information about various options and techniques in the article <a
href="https://docs.qgis.org/testing/en/docs/user_manual/processing/console.html">Using
processing algorithms from the console</a> of the QGIS User Guide</p>
<p><a
href="https://www.youtube.com/watch?v=G4RfIsVAq4k&amp;list=PLppGmFLhQ1HKKnk3riKNyOxb-3MTI-7zE&amp;index=18"
target="_blank"><img
src="https://img.youtube.com/vi/G4RfIsVAq4k/mqdefault.jpg"
alt="Watch the Video" /></a></p>
<p><a
href="https://www.youtube.com/watch?v=G4RfIsVAq4k&amp;list=PLppGmFLhQ1HKKnk3riKNyOxb-3MTI-7zE&amp;index=18"
target="_blank">Watch the Video ↗</a></p>
<div id="creating-hillshade-from-a-dem" class="section level2">
<h2>8.1 Creating Hillshade from a DEM</h2>
<p>To use any Processing Algorithm via Python, you need to know how to
specify all the required parameters. This is easiest to obtain by
running the algorithm via the GUI first.</p>
<p>In this section we will learn how to create a hillshade raster from a
DEM. We will first carry out the task using QGIS.</p>
<ol style="list-style-type: decimal">
<li>Browse to the data directory and load the <code>srtm.tif</code>
layer. Search and locate the <strong>Processing Toolbox → Raster terrain
analysis → Hillshade</strong> algorithm from the <em>Processing
Toolbox</em>. Double-click to open it.</li>
</ol>
<p><img src="images/pyqgis/processing1.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="2" style="list-style-type: decimal">
<li>Select <code>srtm</code> as the <em>Elevation layer</em> and keep
all the other parameters to their default value. Click
<em>Run</em>.</li>
</ol>
<p><img src="images/pyqgis/processing2.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="3" style="list-style-type: decimal">
<li>A new <code>Hillshade</code> layer will be added to the
<em>Layers</em> panel. Now we will locate the Python command for this
operation from the <em>Processing History</em>. Go to <strong>Processing
→ History</strong>.</li>
</ol>
<p><img src="images/pyqgis/processing3.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="4" style="list-style-type: decimal">
<li>The first entry in the top panel will show the last algorithm that
was ran from the toolbox. Click on it to select it. The full Python
command will be shown at the bottom. Copy it.</li>
</ol>
<p><img src="images/pyqgis/processing4.png" width="75%" style="display: block; margin: auto;" /></p>
<p>You can now use the parameters in your Python code and replace the
path of the input. Below is the code snippet that runs the same
algorithm from a Python script. Note that we are using the
<code>processing.runAndLoadResults()</code> method that adds the
resulting layer to the canvas.</p>
<div class="sourceCode" id="cb30"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb30-2"><a href="#cb30-2" tabindex="-1"></a>data_dir <span class="op">=</span> os.path.join(os.path.expanduser(<span class="st">&#39;~&#39;</span>), <span class="st">&#39;Downloads&#39;</span>, <span class="st">&#39;pyqgis_masterclass&#39;</span>)</span>
<span id="cb30-3"><a href="#cb30-3" tabindex="-1"></a></span>
<span id="cb30-4"><a href="#cb30-4" tabindex="-1"></a>filename <span class="op">=</span> <span class="st">&#39;srtm.tif&#39;</span></span>
<span id="cb30-5"><a href="#cb30-5" tabindex="-1"></a>srtm <span class="op">=</span> os.path.join(data_dir, filename)</span>
<span id="cb30-6"><a href="#cb30-6" tabindex="-1"></a>iface.addRasterLayer(srtm, <span class="st">&#39;srtm&#39;</span>, <span class="st">&#39;gdal&#39;</span>)</span>
<span id="cb30-7"><a href="#cb30-7" tabindex="-1"></a></span>
<span id="cb30-8"><a href="#cb30-8" tabindex="-1"></a>results <span class="op">=</span> processing.runAndLoadResults(<span class="st">&quot;native:hillshade&quot;</span>, </span>
<span id="cb30-9"><a href="#cb30-9" tabindex="-1"></a>    {<span class="st">&#39;INPUT&#39;</span>: srtm, </span>
<span id="cb30-10"><a href="#cb30-10" tabindex="-1"></a>    <span class="st">&#39;Z_FACTOR&#39;</span>:<span class="dv">2</span>,</span>
<span id="cb30-11"><a href="#cb30-11" tabindex="-1"></a>    <span class="st">&#39;AZIMUTH&#39;</span>:<span class="dv">300</span>,</span>
<span id="cb30-12"><a href="#cb30-12" tabindex="-1"></a>    <span class="st">&#39;V_ANGLE&#39;</span>:<span class="dv">40</span>,</span>
<span id="cb30-13"><a href="#cb30-13" tabindex="-1"></a>    <span class="st">&#39;OUTPUT&#39;</span>: <span class="st">&#39;TEMPORARY_OUTPUT&#39;</span>})</span></code></pre></div>
</div>
<div id="running-multiple-processing-algorithms" class="section level2">
<h2>8.2 Running Multiple Processing Algorithms</h2>
<p>We can also <em>chain</em> multiple processing tools to build a
script to build a data processing pipeline. In the example below, we
will do 2 steps</p>
<ol style="list-style-type: decimal">
<li>Clip <code>srtm.tif</code> raster using the
<code>shoreline.shp</code> layer.</li>
<li>Calculate the hillshade on the clipped raster and load it in
QGIS.</li>
</ol>
<p>Note that we are using the <code>processing.run()</code> method for
the first step. This method calculates the output, but does not load the
result to QGIS. This allows us to carry out multiple processing steps
and not load intermediate layers.</p>
<div class="sourceCode" id="cb31"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb31-2"><a href="#cb31-2" tabindex="-1"></a>data_dir <span class="op">=</span> os.path.join(os.path.expanduser(<span class="st">&#39;~&#39;</span>), <span class="st">&#39;Downloads&#39;</span>, <span class="st">&#39;pyqgis_masterclass&#39;</span>)</span>
<span id="cb31-3"><a href="#cb31-3" tabindex="-1"></a></span>
<span id="cb31-4"><a href="#cb31-4" tabindex="-1"></a>filename <span class="op">=</span> <span class="st">&#39;srtm.tif&#39;</span></span>
<span id="cb31-5"><a href="#cb31-5" tabindex="-1"></a>srtm <span class="op">=</span> os.path.join(data_dir, filename)</span>
<span id="cb31-6"><a href="#cb31-6" tabindex="-1"></a>filename <span class="op">=</span> <span class="st">&#39;shoreline.shp&#39;</span></span>
<span id="cb31-7"><a href="#cb31-7" tabindex="-1"></a>shoreline <span class="op">=</span> os.path.join(data_dir, filename) </span>
<span id="cb31-8"><a href="#cb31-8" tabindex="-1"></a></span>
<span id="cb31-9"><a href="#cb31-9" tabindex="-1"></a>results <span class="op">=</span> processing.run(<span class="st">&quot;gdal:cliprasterbymasklayer&quot;</span>, </span>
<span id="cb31-10"><a href="#cb31-10" tabindex="-1"></a>    {<span class="st">&#39;INPUT&#39;</span>:srtm,</span>
<span id="cb31-11"><a href="#cb31-11" tabindex="-1"></a>    <span class="st">&#39;MASK&#39;</span>: shoreline,</span>
<span id="cb31-12"><a href="#cb31-12" tabindex="-1"></a>    <span class="st">&#39;OUTPUT&#39;</span>:<span class="st">&#39;TEMPORARY_OUTPUT&#39;</span>})</span>
<span id="cb31-13"><a href="#cb31-13" tabindex="-1"></a></span>
<span id="cb31-14"><a href="#cb31-14" tabindex="-1"></a>clipped_dem <span class="op">=</span> results[<span class="st">&#39;OUTPUT&#39;</span>]</span>
<span id="cb31-15"><a href="#cb31-15" tabindex="-1"></a>   </span>
<span id="cb31-16"><a href="#cb31-16" tabindex="-1"></a>results <span class="op">=</span> processing.runAndLoadResults(<span class="st">&quot;native:hillshade&quot;</span>, </span>
<span id="cb31-17"><a href="#cb31-17" tabindex="-1"></a>    {<span class="st">&#39;INPUT&#39;</span>: clipped_dem, </span>
<span id="cb31-18"><a href="#cb31-18" tabindex="-1"></a>    <span class="st">&#39;Z_FACTOR&#39;</span>:<span class="dv">2</span>,</span>
<span id="cb31-19"><a href="#cb31-19" tabindex="-1"></a>    <span class="st">&#39;AZIMUTH&#39;</span>:<span class="dv">300</span>,</span>
<span id="cb31-20"><a href="#cb31-20" tabindex="-1"></a>    <span class="st">&#39;V_ANGLE&#39;</span>:<span class="dv">40</span>,</span>
<span id="cb31-21"><a href="#cb31-21" tabindex="-1"></a>    <span class="st">&#39;OUTPUT&#39;</span>: <span class="st">&#39;TEMPORARY_OUTPUT&#39;</span>})</span></code></pre></div>
<p>You can also do batch-processing by iterating through multiple layers
and running the processing algorithm in a for-loop. Doing it via Python
allows you greater flexibility - such as combining the results into a
single layer. See <a
href="https://www.qgistutorials.com/en/docs/3/processing_algorithms_pyqgis.html"
target="_blank">Running Processing Algorithms via Python</a> tutorial
for a complete example.</p>
</div>
<div id="exercise-6" class="section level2">
<h2>Exercise 6</h2>
<p>Your data package contains a polygon layer of seismic zones in San
Francisco. We want to calculate the average elevation within each
seismic zone from this layer. The code below reads the vector layer
<code>seismic_zones.shp</code> of seismic zones and the raster layer
<code>srtm.tif</code> containing elevation values. The vector layer
contains some invalid polygons, so we run the
<code>native:fixgeometries</code> algorithm to fix them.</p>
<p>Use the resulting layer with the fixes geometries and calculate Zonal
Statistics algorithm <code>native:zonalstatisticsfb</code> to calculate
the average elevation from the raster layer.</p>
<div class="sourceCode" id="cb32"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb32-2"><a href="#cb32-2" tabindex="-1"></a>data_dir <span class="op">=</span> os.path.join(os.path.expanduser(<span class="st">&#39;~&#39;</span>), <span class="st">&#39;Downloads&#39;</span>, <span class="st">&#39;pyqgis_masterclass&#39;</span>)</span>
<span id="cb32-3"><a href="#cb32-3" tabindex="-1"></a></span>
<span id="cb32-4"><a href="#cb32-4" tabindex="-1"></a>vector_layer <span class="op">=</span> <span class="st">&#39;seismic_zones.shp&#39;</span></span>
<span id="cb32-5"><a href="#cb32-5" tabindex="-1"></a>vector_layer_path <span class="op">=</span> os.path.join(data_dir, vector_layer)</span>
<span id="cb32-6"><a href="#cb32-6" tabindex="-1"></a></span>
<span id="cb32-7"><a href="#cb32-7" tabindex="-1"></a>raster_layer <span class="op">=</span> <span class="st">&#39;srtm.tif&#39;</span></span>
<span id="cb32-8"><a href="#cb32-8" tabindex="-1"></a>raster_layer_path <span class="op">=</span> os.path.join(data_dir, raster_layer)</span>
<span id="cb32-9"><a href="#cb32-9" tabindex="-1"></a></span>
<span id="cb32-10"><a href="#cb32-10" tabindex="-1"></a><span class="co"># Input vector has invalid geometries</span></span>
<span id="cb32-11"><a href="#cb32-11" tabindex="-1"></a><span class="co"># Fix them first</span></span>
<span id="cb32-12"><a href="#cb32-12" tabindex="-1"></a>results <span class="op">=</span> processing.run(<span class="st">&quot;native:fixgeometries&quot;</span>, {</span>
<span id="cb32-13"><a href="#cb32-13" tabindex="-1"></a>  <span class="st">&#39;INPUT&#39;</span>:vector_layer_path,</span>
<span id="cb32-14"><a href="#cb32-14" tabindex="-1"></a>  <span class="st">&#39;METHOD&#39;</span>: <span class="dv">0</span>,</span>
<span id="cb32-15"><a href="#cb32-15" tabindex="-1"></a>  <span class="st">&#39;OUTPUT&#39;</span>:<span class="st">&#39;TEMPORARY_OUTPUT&#39;</span>})</span>
<span id="cb32-16"><a href="#cb32-16" tabindex="-1"></a></span>
<span id="cb32-17"><a href="#cb32-17" tabindex="-1"></a>fixed_vector_layer <span class="op">=</span> results[<span class="st">&#39;OUTPUT&#39;</span>]</span>
<span id="cb32-18"><a href="#cb32-18" tabindex="-1"></a></span>
<span id="cb32-19"><a href="#cb32-19" tabindex="-1"></a><span class="co"># Run Zonal Statistics and load the resulting layer</span></span></code></pre></div>
</div>
</div>
<div id="assignment" class="section level1">
<h1>Assignment</h1>
<p><a
href="https://www.youtube.com/watch?v=McwUHDxOTik&amp;list=PLppGmFLhQ1HKKnk3riKNyOxb-3MTI-7zE&amp;index=21"
target="_blank"><img
src="https://img.youtube.com/vi/McwUHDxOTik/mqdefault.jpg"
alt="Watch the Video" /></a></p>
<p><a
href="https://www.youtube.com/watch?v=McwUHDxOTik&amp;list=PLppGmFLhQ1HKKnk3riKNyOxb-3MTI-7zE&amp;index=21"
target="_blank">Watch the Video ↗</a></p>
<p>The following assignment is designed to help you practice the skills
learnt so far in the course and explore the PyQGIS API.</p>
<p>Your task is to write a PyQGIS Script to show the average value of
the selected raster layer within the current map extent. For example, if
you load the <code>srtm</code> layer from the data package, select it
and click the button - it should calculate and display the average
elevation within the canvas extent. If you zoom/pan the map and click
the button again - it should compute the display the average elevation
within the new extent. Here is the recommended structure for your
script.</p>
<ul>
<li>Add a button to the <em>Plugins Toolbar</em> called <em>Show Raster
Statistics</em> with an icon of your choice.</li>
<li>Write a function named <code>show_statistics()</code> that is called
when the button is clicked.</li>
<li>The function should obtain the current extent of the map canvas and
calculate the raster statistics.</li>
<li>Once the statistics are computed, it should display a message in the
message bar with the information.</li>
</ul>
<p>Hint: <a
href="https://qgis.org/pyqgis/3.40/core/QgsRasterInterface.html#module-QgsRasterInterface"><code>QgsRasterInterface</code></a>
class provides a <code>bandStatistics()</code> method for calculating
statistics from a raster band. You can get the reference to the instance
of this class for a raster layer using
<code>layer.dataProvider()</code>.</p>
<p><img src="images/pyqgis/assignment1.png" width="75%" style="display: block; margin: auto;" /></p>
<p>Extra credit if your script also does error checking and displays an
error message on the message bar for the following conditions:</p>
<ul>
<li>If the user has not selected any layer or the selected layer is not
a raster layer, display an error.</li>
<li>If the current map canvas extent does not have any valid pixels,
display an error.</li>
</ul>
<p><img src="images/pyqgis/assignment1_errors.png" width="75%" style="display: block; margin: auto;" /></p>
</div>
<div id="writing-plugins" class="section level1">
<h1>9. Writing Plugins</h1>
<p>Plugins are a great way to extend the functionality of QGIS. You can
write plugins using Python that can range from adding a simple button to
sophisticated tool-kits.</p>
<p><a
href="https://www.youtube.com/watch?v=gzwhSOfknck&amp;list=PLppGmFLhQ1HKKnk3riKNyOxb-3MTI-7zE&amp;index=22"
target="_blank"><img
src="https://img.youtube.com/vi/gzwhSOfknck/mqdefault.jpg"
alt="Watch the Video" /></a></p>
<p><a
href="https://www.youtube.com/watch?v=gzwhSOfknck&amp;list=PLppGmFLhQ1HKKnk3riKNyOxb-3MTI-7zE&amp;index=22"
target="_blank">Watch the Video ↗</a></p>
<p><a
href="https://docs.google.com/presentation/d/1wegCN-_aQ6G4-VyyN-lO4o0n7Kj9kU-xT2jSz1wL5Ec/edit?usp=sharing"
target="_blank">View the Presentation ↗</a></p>
<blockquote>
<p>There is a plugin named <a
href="https://plugins.qgis.org/plugins/pluginbuilder/">Plugin
Builder</a> that can help you generate a starter plugin. We have
published step-by-step instructions for both <a
href="https://www.qgistutorials.com/en/docs/3/building_a_python_plugin.html">GUI
plugins</a> and <a
href="https://www.qgistutorials.com/en/docs/3/processing_python_plugin.html">Processing
Plugins</a> using the Plugin Builder method. While this method gives you
an easy way to have a functional plugin, it is not the ideal way to
learn plugin development. We recommend starting from a minimal template
and adding elements as and when needed. Here we will learn the basics of
plugin framework using a minimal plugin and learn how to add various
element to make it a full plugin.</p>
</blockquote>
<div id="understanding-plugins" class="section level2">
<h2>9.1 Understanding Plugins</h2>
<p>Plugins are much more integrated into the QGIS system than Python
Scripts. They are managed by <strong>Plugin Manager</strong> and are
initialized when QGIS starts. To understand the required structure,
let’s see what a minimal plugin looks like. You can learn more about
this structure at <a
href="https://github.com/wonder-sk/qgis-minimal-plugin">QGIS Minimalist
Plugin Skeleton</a>.</p>
<p>We will now build a simple plugin named <strong>Basemap
Loader</strong> that adds a button in the <em>Plugin Toolbar</em> that
loads a basemap from OpenStreetMap to the current project.</p>
<p>The first requirement for plugins is a file called
<code>metadata.txt</code>. This file contains general info, version,
name and some other metadata used by plugins website and plugin
manager.</p>
<p><code>metadata.txt</code></p>
<div class="sourceCode" id="cb33"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" tabindex="-1"></a>[general]</span>
<span id="cb33-2"><a href="#cb33-2" tabindex="-1"></a>name<span class="op">=</span>Basemap Loader</span>
<span id="cb33-3"><a href="#cb33-3" tabindex="-1"></a>description<span class="op">=</span>This plugin adds a basemap layer to QGIS.</span>
<span id="cb33-4"><a href="#cb33-4" tabindex="-1"></a>version<span class="op">=</span><span class="fl">1.0</span></span>
<span id="cb33-5"><a href="#cb33-5" tabindex="-1"></a>qgisMinimumVersion<span class="op">=</span><span class="fl">3.0</span></span>
<span id="cb33-6"><a href="#cb33-6" tabindex="-1"></a>author<span class="op">=</span>Ujaval Gandhi</span>
<span id="cb33-7"><a href="#cb33-7" tabindex="-1"></a>email<span class="op">=</span>ujaval<span class="op">@</span>spatialthoughts.com</span>
<span id="cb33-8"><a href="#cb33-8" tabindex="-1"></a>icon<span class="op">=</span>logo.png</span></code></pre></div>
<p>Second is the file that contains the main logic of the plugin. It
must have <code>__init__()</code> method that gives the plugin access to
the QGIS Interface (iface). The <code>initGui()</code> method is called
when the plugin is loaded and <code>unload()</code> method which is
called when the plugin is unloaded. For now, we are creating a minimal
plugin that just add a button that displays message when clicked.</p>
<p><code>load_basemap.py</code></p>
<div class="sourceCode" id="cb34"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb34-2"><a href="#cb34-2" tabindex="-1"></a><span class="im">from</span> PyQt5.QtWidgets <span class="im">import</span> QAction</span>
<span id="cb34-3"><a href="#cb34-3" tabindex="-1"></a><span class="im">from</span> PyQt5.QtGui <span class="im">import</span> QIcon</span>
<span id="cb34-4"><a href="#cb34-4" tabindex="-1"></a></span>
<span id="cb34-5"><a href="#cb34-5" tabindex="-1"></a>plugin_dir <span class="op">=</span> os.path.dirname(<span class="va">__file__</span>)</span>
<span id="cb34-6"><a href="#cb34-6" tabindex="-1"></a></span>
<span id="cb34-7"><a href="#cb34-7" tabindex="-1"></a><span class="kw">class</span> BasemapLoaderPlugin:</span>
<span id="cb34-8"><a href="#cb34-8" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, iface):</span>
<span id="cb34-9"><a href="#cb34-9" tabindex="-1"></a>        <span class="va">self</span>.iface <span class="op">=</span> iface</span>
<span id="cb34-10"><a href="#cb34-10" tabindex="-1"></a></span>
<span id="cb34-11"><a href="#cb34-11" tabindex="-1"></a>    <span class="kw">def</span> initGui(<span class="va">self</span>):</span>
<span id="cb34-12"><a href="#cb34-12" tabindex="-1"></a>        icon <span class="op">=</span> os.path.join(os.path.join(plugin_dir, <span class="st">&#39;logo.png&#39;</span>))</span>
<span id="cb34-13"><a href="#cb34-13" tabindex="-1"></a>        <span class="va">self</span>.action <span class="op">=</span> QAction(QIcon(icon), <span class="st">&#39;Load Basemap&#39;</span>, <span class="va">self</span>.iface.mainWindow())</span>
<span id="cb34-14"><a href="#cb34-14" tabindex="-1"></a>        <span class="va">self</span>.iface.addToolBarIcon(<span class="va">self</span>.action)</span>
<span id="cb34-15"><a href="#cb34-15" tabindex="-1"></a>        <span class="va">self</span>.action.triggered.<span class="ex">connect</span>(<span class="va">self</span>.run)</span>
<span id="cb34-16"><a href="#cb34-16" tabindex="-1"></a>      </span>
<span id="cb34-17"><a href="#cb34-17" tabindex="-1"></a>    <span class="kw">def</span> unload(<span class="va">self</span>):</span>
<span id="cb34-18"><a href="#cb34-18" tabindex="-1"></a>        <span class="va">self</span>.iface.removeToolBarIcon(<span class="va">self</span>.action)</span>
<span id="cb34-19"><a href="#cb34-19" tabindex="-1"></a>        <span class="kw">del</span> <span class="va">self</span>.action</span>
<span id="cb34-20"><a href="#cb34-20" tabindex="-1"></a>        </span>
<span id="cb34-21"><a href="#cb34-21" tabindex="-1"></a>    <span class="kw">def</span> run(<span class="va">self</span>):</span>
<span id="cb34-22"><a href="#cb34-22" tabindex="-1"></a>        <span class="va">self</span>.iface.messageBar().pushMessage(<span class="st">&#39;Hello from Plugin&#39;</span>)</span></code></pre></div>
<p>Third file is called <code>__init__.py</code> which is the starting
point of the plugin. It imports the plugin class created in the second
file and creates an instance of it.</p>
<p><code>__init__.py</code></p>
<div class="sourceCode" id="cb35"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" tabindex="-1"></a><span class="im">from</span> .load_basemap <span class="im">import</span> BasemapLoaderPlugin</span>
<span id="cb35-2"><a href="#cb35-2" tabindex="-1"></a></span>
<span id="cb35-3"><a href="#cb35-3" tabindex="-1"></a><span class="kw">def</span> classFactory(iface):</span>
<span id="cb35-4"><a href="#cb35-4" tabindex="-1"></a>    <span class="cf">return</span> BasemapLoaderPlugin(iface)</span></code></pre></div>
<p>Create these 3 files and put them in a folder named
<code>basemap_loader</code>. Copy the <code>logo.png</code> file from
<code>&lt;home folder&gt;/Downloads/pyqgis_masterclass/logo.png</code>
to this folder. Copy the folder to the python plugins directory at
<code>{profile folder}/python/plugins</code>.</p>
<p><img src="images/pyqgis/pluginbasemapfiles.png" width="75%" style="display: block; margin: auto;" /></p>
<p>Restart QGIS. Go to <strong>Plugins → Manage and Install plugins… →
Installed</strong> and enable the <strong>Basemap Loader</strong>
plugin. You will the toolbar icon from the plugin. Click on the button
and the <em>Hello from Plugin</em> message is displayed.</p>
<p><img src="images/pyqgis/pluginbasemaphello.png" width="75%" style="display: block; margin: auto;" /></p>
</div>
<div id="adding-functionality" class="section level2">
<h2>9.2 Adding Functionality</h2>
<p>Now let’s build on the basic plugin structure and add the
functionality to load a XYZ Tile Layer when the button is clicked. We
will be using the <a
href="https://wiki.openstreetmap.org/wiki/Raster_tile_providers#Base_maps">OpenStreetMap
Standard</a> XYZ layer. The PyQGIS code to load a XYZ tile layer is
adapted from the <a
href="https://docs.qgis.org/3.40/en/docs/pyqgis_developer_cookbook/cheat_sheet.html">PyQGIS
Cookbook</a>. Modify the <code>load_basemap.py</code> file with the
content from below.</p>
<p><code>load_basemap.py</code></p>
<div class="sourceCode" id="cb36"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb36-2"><a href="#cb36-2" tabindex="-1"></a><span class="im">from</span> PyQt5.QtWidgets <span class="im">import</span> QAction</span>
<span id="cb36-3"><a href="#cb36-3" tabindex="-1"></a><span class="im">from</span> PyQt5.QtGui <span class="im">import</span> QIcon</span>
<span id="cb36-4"><a href="#cb36-4" tabindex="-1"></a><span class="im">from</span> qgis.core <span class="im">import</span> QgsRasterLayer, QgsProject, QgsCoordinateReferenceSystem</span>
<span id="cb36-5"><a href="#cb36-5" tabindex="-1"></a></span>
<span id="cb36-6"><a href="#cb36-6" tabindex="-1"></a>plugin_dir <span class="op">=</span> os.path.dirname(<span class="va">__file__</span>)</span>
<span id="cb36-7"><a href="#cb36-7" tabindex="-1"></a></span>
<span id="cb36-8"><a href="#cb36-8" tabindex="-1"></a><span class="kw">class</span> BasemapLoaderPlugin:</span>
<span id="cb36-9"><a href="#cb36-9" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, iface):</span>
<span id="cb36-10"><a href="#cb36-10" tabindex="-1"></a>        <span class="va">self</span>.iface <span class="op">=</span> iface</span>
<span id="cb36-11"><a href="#cb36-11" tabindex="-1"></a></span>
<span id="cb36-12"><a href="#cb36-12" tabindex="-1"></a>    <span class="kw">def</span> initGui(<span class="va">self</span>):</span>
<span id="cb36-13"><a href="#cb36-13" tabindex="-1"></a>        <span class="co"># Create an action (i.e. a button) with Logo</span></span>
<span id="cb36-14"><a href="#cb36-14" tabindex="-1"></a>        icon <span class="op">=</span> os.path.join(os.path.join(plugin_dir, <span class="st">&#39;logo.png&#39;</span>))</span>
<span id="cb36-15"><a href="#cb36-15" tabindex="-1"></a>        <span class="va">self</span>.action <span class="op">=</span> QAction(QIcon(icon), <span class="st">&#39;Load Basemap&#39;</span>, <span class="va">self</span>.iface.mainWindow())</span>
<span id="cb36-16"><a href="#cb36-16" tabindex="-1"></a>        <span class="co"># Add the action to the toolbar</span></span>
<span id="cb36-17"><a href="#cb36-17" tabindex="-1"></a>        <span class="va">self</span>.iface.addToolBarIcon(<span class="va">self</span>.action)</span>
<span id="cb36-18"><a href="#cb36-18" tabindex="-1"></a>        <span class="co"># Connect the run() method to the action</span></span>
<span id="cb36-19"><a href="#cb36-19" tabindex="-1"></a>        <span class="va">self</span>.action.triggered.<span class="ex">connect</span>(<span class="va">self</span>.run)</span>
<span id="cb36-20"><a href="#cb36-20" tabindex="-1"></a>      </span>
<span id="cb36-21"><a href="#cb36-21" tabindex="-1"></a>    <span class="kw">def</span> unload(<span class="va">self</span>):</span>
<span id="cb36-22"><a href="#cb36-22" tabindex="-1"></a>        <span class="va">self</span>.iface.removeToolBarIcon(<span class="va">self</span>.action)</span>
<span id="cb36-23"><a href="#cb36-23" tabindex="-1"></a>        <span class="kw">del</span> <span class="va">self</span>.action</span>
<span id="cb36-24"><a href="#cb36-24" tabindex="-1"></a></span>
<span id="cb36-25"><a href="#cb36-25" tabindex="-1"></a>    <span class="kw">def</span> run(<span class="va">self</span>):</span>
<span id="cb36-26"><a href="#cb36-26" tabindex="-1"></a>        basemap_url <span class="op">=</span> <span class="st">&#39;https://tile.openstreetmap.org/</span><span class="sc">{z}</span><span class="st">/</span><span class="sc">{x}</span><span class="st">/</span><span class="sc">{y}</span><span class="st">.png&#39;</span></span>
<span id="cb36-27"><a href="#cb36-27" tabindex="-1"></a>        zmin <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb36-28"><a href="#cb36-28" tabindex="-1"></a>        zmax <span class="op">=</span> <span class="dv">19</span></span>
<span id="cb36-29"><a href="#cb36-29" tabindex="-1"></a>        crs <span class="op">=</span> <span class="st">&#39;EPSG:3857&#39;</span></span>
<span id="cb36-30"><a href="#cb36-30" tabindex="-1"></a>        </span>
<span id="cb36-31"><a href="#cb36-31" tabindex="-1"></a>        <span class="co"># Replace &#39;=&#39; and &#39;&amp;&#39; in the URL to ensure it is properly encoded</span></span>
<span id="cb36-32"><a href="#cb36-32" tabindex="-1"></a>        encoded_url <span class="op">=</span> basemap_url.replace(<span class="st">&#39;=&#39;</span>, <span class="st">&#39;%3D&#39;</span>).replace(<span class="st">&#39;&amp;&#39;</span>, <span class="st">&#39;%26&#39;</span>)</span>
<span id="cb36-33"><a href="#cb36-33" tabindex="-1"></a>        uri <span class="op">=</span> <span class="ss">f&#39;type=xyz&amp;url=</span><span class="sc">{</span>encoded_url<span class="sc">}</span><span class="ss">&amp;zmax=</span><span class="sc">{</span>zmax<span class="sc">}</span><span class="ss">&amp;zmin=</span><span class="sc">{</span>zmin<span class="sc">}</span><span class="ss">$crs=</span><span class="sc">{</span>crs<span class="sc">}</span><span class="ss">&#39;</span></span>
<span id="cb36-34"><a href="#cb36-34" tabindex="-1"></a>        </span>
<span id="cb36-35"><a href="#cb36-35" tabindex="-1"></a>        <span class="co"># Create a QgsRasterLayer with the URI</span></span>
<span id="cb36-36"><a href="#cb36-36" tabindex="-1"></a>        rlayer <span class="op">=</span> QgsRasterLayer(uri, <span class="st">&#39;OpenStreetMap&#39;</span>, <span class="st">&#39;wms&#39;</span>)</span>
<span id="cb36-37"><a href="#cb36-37" tabindex="-1"></a>        <span class="cf">if</span> rlayer.isValid():</span>
<span id="cb36-38"><a href="#cb36-38" tabindex="-1"></a>            QgsProject.instance().addMapLayer(rlayer)</span>
<span id="cb36-39"><a href="#cb36-39" tabindex="-1"></a>            <span class="va">self</span>.iface.messageBar().pushSuccess(<span class="st">&#39;Success&#39;</span>, <span class="st">&#39;Basemap Layer Loaded&#39;</span>)</span>
<span id="cb36-40"><a href="#cb36-40" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb36-41"><a href="#cb36-41" tabindex="-1"></a>            <span class="va">self</span>.iface.messageBar().pushCritical(<span class="st">&#39;Error&#39;</span>, <span class="st">&#39;Invalid Basemap Layer&#39;</span>)</span></code></pre></div>
<p>To see the result of our changes, we must restart QGIS. This can be
quite tedious while developing plugins, so there is a handy plugin named
<strong>Plugin Reloader</strong> that can reload a selected plugin
without having to restart QGIS. Go to <em>Plugins → Manage and Install
plugins… → All</em> and search for the plugin named <strong>Plugin
Reloader</strong>. Click <em>Install Plugin</em>. Once the plugin is
installed, locate the <em>Configure</em> button from the <em>Plugin
Toolbar</em> and select the <strong>Basemap Loader</strong> plugin.
Click <em>Reload</em> to reload the plugin.</p>
<p><img src="images/pyqgis/pluginbasemapreload.png" width="75%" style="display: block; margin: auto;" /></p>
<p>Once reloaded, click the <em>Load Basemap</em> button from the
toolbar and you will see the basemap layer loaded in QGIS.</p>
<p><img src="images/pyqgis/pluginbasemapcomplete.png" width="75%" style="display: block; margin: auto;" /></p>
</div>
<div id="exercise-7" class="section level2">
<h2>Exercise 7</h2>
<p>Load the <code>places.qgz</code> project from your data package.</p>
<p>Modify the plugin to change the Project CRS to the crs of the tile
layer once the basemap is loaded.</p>
<p>Hint: Use <a
href="https://qgis.org/pyqgis/3.40/core/QgsProject.html"><code>QgsProject.instance().setCrs()</code></a>
method.</p>
<p>By default, the new layer will be inserted at the top of the layer
tree. If you want to insert the layer at a specific place, you can use
the code snippet below.</p>
<div class="sourceCode" id="cb37"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" tabindex="-1"></a><span class="co"># Add the layer, but not to the legend</span></span>
<span id="cb37-2"><a href="#cb37-2" tabindex="-1"></a>QgsProject.instance().addMapLayer(rlayer, <span class="va">False</span>)</span>
<span id="cb37-3"><a href="#cb37-3" tabindex="-1"></a><span class="co"># Insert layer at the bottom of Layer Tree</span></span>
<span id="cb37-4"><a href="#cb37-4" tabindex="-1"></a>root <span class="op">=</span> QgsProject.instance().layerTreeRoot()</span>
<span id="cb37-5"><a href="#cb37-5" tabindex="-1"></a>position <span class="op">=</span> <span class="bu">len</span>(root.children())</span>
<span id="cb37-6"><a href="#cb37-6" tabindex="-1"></a>root.insertLayer(position, rlayer)</span></code></pre></div>
</div>
</div>
<div id="advanced-python-concepts" class="section level1">
<h1>10. Advanced Python Concepts</h1>
<div id="understanding-python-iterators" class="section level2">
<h2>10.1 Understanding Python Iterators</h2>
<p>An <em>Iterator</em> is a type of Python object that contains items
that can be iterator upon. They are similar to other objects, like
<em>lists</em> - but with a key difference. When you create an iterator,
you don’t store all the items in memory. The iterator loads a single
item at a time and then fetches the next item when asked for it. This
makes it very efficient for reading large amounts of data without having
to read the entire dataset. QGIS implements iterators for many different
object types.</p>
<p>We will continue to work with the <code>sf.qgz</code> project. Open
the project and select the <code>blocks</code> layer. In the example
below, the result of calling <code>layer.getFeatures()</code> is an
iterator. You can call the <code>next()</code> function to fetch the
next item from the iterator.</p>
<div class="sourceCode" id="cb38"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" tabindex="-1"></a>layer <span class="op">=</span> iface.activeLayer()</span>
<span id="cb38-2"><a href="#cb38-2" tabindex="-1"></a>features <span class="op">=</span> layer.getFeatures()</span>
<span id="cb38-3"><a href="#cb38-3" tabindex="-1"></a>f <span class="op">=</span> <span class="bu">next</span>(features)</span>
<span id="cb38-4"><a href="#cb38-4" tabindex="-1"></a><span class="bu">print</span>(f.attributes())</span>
<span id="cb38-5"><a href="#cb38-5" tabindex="-1"></a>f <span class="op">=</span> <span class="bu">next</span>(features)</span>
<span id="cb38-6"><a href="#cb38-6" tabindex="-1"></a><span class="bu">print</span>(f.attributes())</span></code></pre></div>
<p>You can also use for-loops to iterate through an iterator. Here we
look up the <em>Feature ID</em> of each feature using the
<code>id()</code> method and store it in a list.</p>
<div class="sourceCode" id="cb39"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" tabindex="-1"></a>layer <span class="op">=</span> iface.activeLayer()</span>
<span id="cb39-2"><a href="#cb39-2" tabindex="-1"></a>features <span class="op">=</span> layer.getFeatures()</span>
<span id="cb39-3"><a href="#cb39-3" tabindex="-1"></a>ids <span class="op">=</span> []</span>
<span id="cb39-4"><a href="#cb39-4" tabindex="-1"></a><span class="cf">for</span> f <span class="kw">in</span> features:</span>
<span id="cb39-5"><a href="#cb39-5" tabindex="-1"></a>  <span class="bu">id</span> <span class="op">=</span> f.<span class="bu">id</span>()</span>
<span id="cb39-6"><a href="#cb39-6" tabindex="-1"></a>  ids.append(<span class="bu">id</span>)</span>
<span id="cb39-7"><a href="#cb39-7" tabindex="-1"></a></span>
<span id="cb39-8"><a href="#cb39-8" tabindex="-1"></a><span class="bu">print</span>(ids)</span></code></pre></div>
</div>
<div id="list-comprehensions" class="section level2">
<h2>10.2 List Comprehensions</h2>
<p>A common data processing task in Python is to read items from a list
or an iterator, doing some processing on each item and creating a new
list with the results. The regular way to do this is to first create an
empty list, iterate over each item of the existing list, and append the
results to the new empty list. Python provides a powerful alternative to
this workflow in the form of <em>List Comprehension</em>. The snippet
below shows the syntax.</p>
<div class="sourceCode" id="cb40"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" tabindex="-1"></a>my_list <span class="op">=</span> [<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">4</span>, <span class="dv">5</span>]</span>
<span id="cb40-2"><a href="#cb40-2" tabindex="-1"></a></span>
<span id="cb40-3"><a href="#cb40-3" tabindex="-1"></a><span class="co"># Create a new list by adding 1 to each element</span></span>
<span id="cb40-4"><a href="#cb40-4" tabindex="-1"></a>new_list <span class="op">=</span> []</span>
<span id="cb40-5"><a href="#cb40-5" tabindex="-1"></a><span class="cf">for</span> x <span class="kw">in</span> my_list:</span>
<span id="cb40-6"><a href="#cb40-6" tabindex="-1"></a>    new_list.append(x<span class="op">+</span><span class="dv">1</span>)</span>
<span id="cb40-7"><a href="#cb40-7" tabindex="-1"></a></span>
<span id="cb40-8"><a href="#cb40-8" tabindex="-1"></a><span class="bu">print</span>(new_list)</span>
<span id="cb40-9"><a href="#cb40-9" tabindex="-1"></a></span>
<span id="cb40-10"><a href="#cb40-10" tabindex="-1"></a><span class="co"># Use list comprehension syntax</span></span>
<span id="cb40-11"><a href="#cb40-11" tabindex="-1"></a></span>
<span id="cb40-12"><a href="#cb40-12" tabindex="-1"></a>new_list <span class="op">=</span> [x<span class="op">+</span><span class="dv">1</span> <span class="cf">for</span> x <span class="kw">in</span> my_list]</span>
<span id="cb40-13"><a href="#cb40-13" tabindex="-1"></a><span class="bu">print</span>(new_list)</span></code></pre></div>
</div>
<div id="exercise-8" class="section level2">
<h2>Exercise 8</h2>
<p>The following code creates a list of field names for the selected
layer. Convert the code to use a list comprehension.</p>
<div class="sourceCode" id="cb41"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" tabindex="-1"></a>layer <span class="op">=</span> iface.activeLayer()</span>
<span id="cb41-2"><a href="#cb41-2" tabindex="-1"></a>fields <span class="op">=</span> layer.fields()</span>
<span id="cb41-3"><a href="#cb41-3" tabindex="-1"></a>field_names <span class="op">=</span> []</span>
<span id="cb41-4"><a href="#cb41-4" tabindex="-1"></a></span>
<span id="cb41-5"><a href="#cb41-5" tabindex="-1"></a><span class="cf">for</span> field <span class="kw">in</span> fields:</span>
<span id="cb41-6"><a href="#cb41-6" tabindex="-1"></a>  field_names.append(field.name())</span>
<span id="cb41-7"><a href="#cb41-7" tabindex="-1"></a></span>
<span id="cb41-8"><a href="#cb41-8" tabindex="-1"></a><span class="bu">print</span>(field_names)</span></code></pre></div>
</div>
</div>
<div id="writing-processing-plugins" class="section level1">
<h1>11. Writing Processing Plugins</h1>
<p>The new and preferred way to write plugins in QGIS is using the
Processing Framework. It removes the need for you to design the user
interface. The resulting plugin integrates seamlessly in the Processing
Toolbox and is interoperable with other processing algorithms.</p>
<p>In this section, we will learn how to build a plugin called
<strong>Save Attributes</strong> that adds a new algorithm to iterate
over all features of a layer, extract their attribute values and save
the results as a CSV file. We will learn about different components of a
processing plugin and learn the skills required to create a functional
processing plugin.</p>
<div id="iterating-over-features" class="section level2">
<h2>11.1 Iterating over Features</h2>
<p>Let’s start by learning how to iterate over features of a vector
layer. We will iterate over each feature and extract the value of all
attributes. To keep things simple for now, we will use Pandas library to
create a DataFrame and save the results. We will later modify this code
to use native PyQGIS API.</p>
<p>Open the Python Console and click the <em>Show Editor</em> button.
Copy/paste the following code. Select the <code>blocks</code> layer and
run this script by clicking the <em>Run Script</em> button. The script
will process the layer and write the file at the given location.</p>
<div class="sourceCode" id="cb42"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb42-2"><a href="#cb42-2" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb42-3"><a href="#cb42-3" tabindex="-1"></a></span>
<span id="cb42-4"><a href="#cb42-4" tabindex="-1"></a>data_dir <span class="op">=</span> os.path.join(os.path.expanduser(<span class="st">&#39;~&#39;</span>), <span class="st">&#39;Downloads&#39;</span>, <span class="st">&#39;pyqgis_masterclass&#39;</span>)</span>
<span id="cb42-5"><a href="#cb42-5" tabindex="-1"></a></span>
<span id="cb42-6"><a href="#cb42-6" tabindex="-1"></a>output_name <span class="op">=</span> <span class="st">&#39;output.csv&#39;</span></span>
<span id="cb42-7"><a href="#cb42-7" tabindex="-1"></a>output_path <span class="op">=</span> os.path.join(data_dir, output_name)</span>
<span id="cb42-8"><a href="#cb42-8" tabindex="-1"></a></span>
<span id="cb42-9"><a href="#cb42-9" tabindex="-1"></a>layer <span class="op">=</span> iface.activeLayer()</span>
<span id="cb42-10"><a href="#cb42-10" tabindex="-1"></a></span>
<span id="cb42-11"><a href="#cb42-11" tabindex="-1"></a><span class="co"># Check if a layer is selected</span></span>
<span id="cb42-12"><a href="#cb42-12" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> layer:</span>
<span id="cb42-13"><a href="#cb42-13" tabindex="-1"></a>    iface.messageBar().pushMessage(</span>
<span id="cb42-14"><a href="#cb42-14" tabindex="-1"></a>      <span class="st">&#39;Please select a layer&#39;</span>,  level<span class="op">=</span>Qgis.Critical)</span>
<span id="cb42-15"><a href="#cb42-15" tabindex="-1"></a>      </span>
<span id="cb42-16"><a href="#cb42-16" tabindex="-1"></a><span class="co"># Check if the selected layer is a vector layer</span></span>
<span id="cb42-17"><a href="#cb42-17" tabindex="-1"></a><span class="cf">if</span> layer.<span class="bu">type</span>() <span class="op">!=</span> QgsMapLayer.VectorLayer:</span>
<span id="cb42-18"><a href="#cb42-18" tabindex="-1"></a>    iface.messageBar().pushMessage(</span>
<span id="cb42-19"><a href="#cb42-19" tabindex="-1"></a>      <span class="st">&#39;Please select a vector layer&#39;</span>,  level<span class="op">=</span>Qgis.Critical)</span>
<span id="cb42-20"><a href="#cb42-20" tabindex="-1"></a>    </span>
<span id="cb42-21"><a href="#cb42-21" tabindex="-1"></a>output_name <span class="op">=</span> <span class="st">&#39;output.csv&#39;</span></span>
<span id="cb42-22"><a href="#cb42-22" tabindex="-1"></a>output_path <span class="op">=</span> os.path.join(data_dir, output_name)</span>
<span id="cb42-23"><a href="#cb42-23" tabindex="-1"></a>fields <span class="op">=</span> layer.fields()</span>
<span id="cb42-24"><a href="#cb42-24" tabindex="-1"></a></span>
<span id="cb42-25"><a href="#cb42-25" tabindex="-1"></a><span class="co"># Get a list of field names</span></span>
<span id="cb42-26"><a href="#cb42-26" tabindex="-1"></a>fieldnames <span class="op">=</span> [field.name() <span class="cf">for</span> field <span class="kw">in</span> layer.fields()]</span>
<span id="cb42-27"><a href="#cb42-27" tabindex="-1"></a><span class="co"># Get a list of attributes for each feature</span></span>
<span id="cb42-28"><a href="#cb42-28" tabindex="-1"></a>data <span class="op">=</span> [f.attributes() <span class="cf">for</span> f <span class="kw">in</span> layer.getFeatures()]</span>
<span id="cb42-29"><a href="#cb42-29" tabindex="-1"></a></span>
<span id="cb42-30"><a href="#cb42-30" tabindex="-1"></a><span class="co"># Create a Pandas DataFrame</span></span>
<span id="cb42-31"><a href="#cb42-31" tabindex="-1"></a>df <span class="op">=</span> pd.DataFrame(data, columns<span class="op">=</span>fieldnames)</span>
<span id="cb42-32"><a href="#cb42-32" tabindex="-1"></a></span>
<span id="cb42-33"><a href="#cb42-33" tabindex="-1"></a><span class="co"># Save to file</span></span>
<span id="cb42-34"><a href="#cb42-34" tabindex="-1"></a>df.to_csv(output_path, index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb42-35"><a href="#cb42-35" tabindex="-1"></a></span>
<span id="cb42-36"><a href="#cb42-36" tabindex="-1"></a>iface.messageBar().pushMessage(</span>
<span id="cb42-37"><a href="#cb42-37" tabindex="-1"></a>      <span class="st">&#39;Success:&#39;</span>,<span class="st">&#39;Output file written at &#39;</span> <span class="op">+</span> output_path, level<span class="op">=</span>Qgis.Success)</span></code></pre></div>
</div>
<div id="exercise-9" class="section level2">
<h2>Exercise 9</h2>
<p>Modify the above code to save attributes of only selected features.
Bonus points if your script checks whether the user has selected any
features on the layer and display an error if no features are
selected.</p>
<p>Hint1: See the available methods for the <a
href="https://qgis.org/pyqgis/3.40/core/QgsVectorLayer.html"><code>QgsVectorLayer</code></a>
class.</p>
<p>Hint2: To check if the layer has any selected features, check for a
method that gives you the count of selected features.</p>
</div>
<div id="saving-vector-layers" class="section level2">
<h2>11.2 Saving Vector Layers</h2>
<p>Let’s take the script we wrote above and learn how to save the
results a vector layer as a file using PyQGIS classes. This is the
preferred method while developing scripts that can be used as Processing
algorithms or plugins. We will use the <a
href="https://qgis.org/pyqgis/3.40/core/QgsVectorFileWriter.html"><code>QgsVectorFileWriter</code></a>
class to create a file in any of the supported vector data formats.</p>
<p>We will use QgsVectorFileWriter.create() method which takes the
following parameters</p>
<ul>
<li><code>fileName</code>: Path to the file</li>
<li><code>fields</code>: Fields to write</li>
<li><code>geometryType</code>: geometry type of output file</li>
<li><code>srs</code>: CRS of the output file</li>
<li><code>transformContext</code>: Datum transformation settings</li>
<li><code>options</code>: Save Options such as format, encoding
etc.</li>
</ul>
<p>Once we initialize a <code>QgsVectorFileWriter</code> object, we
iterate over the original layer and call the <code>addFeature()</code>
method to add features to the writer.</p>
<p>Open the Python Console and click the <em>Show Editor</em> button.
Copy/paste the following code. Select the <code>blocks</code> layer and
run this script by clicking the <em>Run Script</em> button. The script
will process the layer and write the file at the given location.</p>
<div class="sourceCode" id="cb43"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb43-2"><a href="#cb43-2" tabindex="-1"></a><span class="im">import</span> time</span>
<span id="cb43-3"><a href="#cb43-3" tabindex="-1"></a></span>
<span id="cb43-4"><a href="#cb43-4" tabindex="-1"></a>data_dir <span class="op">=</span> os.path.join(os.path.expanduser(<span class="st">&#39;~&#39;</span>), <span class="st">&#39;Downloads&#39;</span>, <span class="st">&#39;pyqgis_masterclass&#39;</span>)</span>
<span id="cb43-5"><a href="#cb43-5" tabindex="-1"></a></span>
<span id="cb43-6"><a href="#cb43-6" tabindex="-1"></a>layer <span class="op">=</span> iface.activeLayer()</span>
<span id="cb43-7"><a href="#cb43-7" tabindex="-1"></a></span>
<span id="cb43-8"><a href="#cb43-8" tabindex="-1"></a><span class="co"># Check if a layer is selected</span></span>
<span id="cb43-9"><a href="#cb43-9" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> layer:</span>
<span id="cb43-10"><a href="#cb43-10" tabindex="-1"></a>    iface.messageBar().pushMessage(<span class="st">&#39;Please select a layer&#39;</span>,  level<span class="op">=</span>Qgis.Critical) </span>
<span id="cb43-11"><a href="#cb43-11" tabindex="-1"></a><span class="co"># Check if the selected layer is a vector layer</span></span>
<span id="cb43-12"><a href="#cb43-12" tabindex="-1"></a><span class="cf">if</span> layer.<span class="bu">type</span>() <span class="op">!=</span> QgsMapLayer.VectorLayer:</span>
<span id="cb43-13"><a href="#cb43-13" tabindex="-1"></a>    iface.messageBar().pushMessage(<span class="st">&#39;Please select a vector layer&#39;</span>,  level<span class="op">=</span>Qgis.Critical)</span>
<span id="cb43-14"><a href="#cb43-14" tabindex="-1"></a></span>
<span id="cb43-15"><a href="#cb43-15" tabindex="-1"></a><span class="co"># Define parameters for QgsVectorFileWriter</span></span>
<span id="cb43-16"><a href="#cb43-16" tabindex="-1"></a>output_name <span class="op">=</span> <span class="st">&#39;output.csv&#39;</span></span>
<span id="cb43-17"><a href="#cb43-17" tabindex="-1"></a>output_path <span class="op">=</span> os.path.join(data_dir, output_name)</span>
<span id="cb43-18"><a href="#cb43-18" tabindex="-1"></a></span>
<span id="cb43-19"><a href="#cb43-19" tabindex="-1"></a><span class="co"># Define the options for saving the layer</span></span>
<span id="cb43-20"><a href="#cb43-20" tabindex="-1"></a>save_options <span class="op">=</span> QgsVectorFileWriter.SaveVectorOptions()</span>
<span id="cb43-21"><a href="#cb43-21" tabindex="-1"></a>save_options.driverName <span class="op">=</span> <span class="st">&#39;CSV&#39;</span></span>
<span id="cb43-22"><a href="#cb43-22" tabindex="-1"></a>save_options.fileEncoding <span class="op">=</span> <span class="st">&#39;UTF-8&#39;</span></span>
<span id="cb43-23"><a href="#cb43-23" tabindex="-1"></a><span class="co"># We can also add some format-specific layer options </span></span>
<span id="cb43-24"><a href="#cb43-24" tabindex="-1"></a><span class="co"># These come from GDAL/OGR</span></span>
<span id="cb43-25"><a href="#cb43-25" tabindex="-1"></a><span class="co"># https://gdal.org/drivers/vector/csv.html</span></span>
<span id="cb43-26"><a href="#cb43-26" tabindex="-1"></a>save_options.layerOptions <span class="op">=</span> [<span class="st">&#39;SEPARATOR=COMMA&#39;</span>]</span>
<span id="cb43-27"><a href="#cb43-27" tabindex="-1"></a></span>
<span id="cb43-28"><a href="#cb43-28" tabindex="-1"></a><span class="co"># Create the writer</span></span>
<span id="cb43-29"><a href="#cb43-29" tabindex="-1"></a>writer <span class="op">=</span> QgsVectorFileWriter.create(</span>
<span id="cb43-30"><a href="#cb43-30" tabindex="-1"></a>    fileName<span class="op">=</span>output_path,</span>
<span id="cb43-31"><a href="#cb43-31" tabindex="-1"></a>    fields<span class="op">=</span>layer.fields(),</span>
<span id="cb43-32"><a href="#cb43-32" tabindex="-1"></a>    geometryType<span class="op">=</span>QgsWkbTypes.NoGeometry,</span>
<span id="cb43-33"><a href="#cb43-33" tabindex="-1"></a>    srs<span class="op">=</span>layer.crs(),</span>
<span id="cb43-34"><a href="#cb43-34" tabindex="-1"></a>    transformContext<span class="op">=</span>QgsProject.instance().transformContext(),</span>
<span id="cb43-35"><a href="#cb43-35" tabindex="-1"></a>    options<span class="op">=</span>save_options)</span>
<span id="cb43-36"><a href="#cb43-36" tabindex="-1"></a></span>
<span id="cb43-37"><a href="#cb43-37" tabindex="-1"></a><span class="co"># Check if we were able to create the writer</span></span>
<span id="cb43-38"><a href="#cb43-38" tabindex="-1"></a><span class="cf">if</span> writer.hasError() <span class="op">!=</span> QgsVectorFileWriter.NoError:</span>
<span id="cb43-39"><a href="#cb43-39" tabindex="-1"></a>    iface.messageBar().pushMessage(</span>
<span id="cb43-40"><a href="#cb43-40" tabindex="-1"></a>        <span class="st">&#39;Error:&#39;</span>, writer.errorMessage, level<span class="op">=</span>Qgis.Critical)</span>
<span id="cb43-41"><a href="#cb43-41" tabindex="-1"></a></span>
<span id="cb43-42"><a href="#cb43-42" tabindex="-1"></a><span class="co"># Add features</span></span>
<span id="cb43-43"><a href="#cb43-43" tabindex="-1"></a><span class="cf">for</span> f <span class="kw">in</span> layer.getFeatures():</span>
<span id="cb43-44"><a href="#cb43-44" tabindex="-1"></a>    writer.addFeature(f)</span>
<span id="cb43-45"><a href="#cb43-45" tabindex="-1"></a></span>
<span id="cb43-46"><a href="#cb43-46" tabindex="-1"></a><span class="co"># delete the writer to flush features to disk</span></span>
<span id="cb43-47"><a href="#cb43-47" tabindex="-1"></a><span class="kw">del</span> writer</span>
<span id="cb43-48"><a href="#cb43-48" tabindex="-1"></a></span>
<span id="cb43-49"><a href="#cb43-49" tabindex="-1"></a>iface.messageBar().pushMessage(</span>
<span id="cb43-50"><a href="#cb43-50" tabindex="-1"></a>    <span class="st">&#39;Success:&#39;</span>,<span class="st">&#39;Output file written at &#39;</span> <span class="op">+</span> output_path, level<span class="op">=</span>Qgis.Success)</span></code></pre></div>
<p><img src="images/pyqgis/consolescriptrun.png" width="75%" style="display: block; margin: auto;" /></p>
</div>
<div id="writing-a-processing-script" class="section level2">
<h2>11.3. Writing a Processing Script</h2>
<p>We saw how to write a Python script in the QGIS Python Console Code
Editor. But there is another way - and it is the preferred approach to
write scripts. Whenever you are writing a new script, consider using the
built-in <strong>Processing Framework</strong>. This has several
advantages. First, taking user input and writing output files is far
easier because Processing Framework offers standardized user interface
for these. Second, having your script in the Processing Toolbox also
allows it to be part of any Processing Model or be run as a Batch job
with multiple inputs. This tutorial will show how to write a custom
python script that can be part of the Processing Framework in QGIS.</p>
<p><a
href="https://www.youtube.com/watch?v=ABERbwS_5rQ&amp;list=PLppGmFLhQ1HKKnk3riKNyOxb-3MTI-7zE&amp;index=30"
target="_blank"><img
src="https://img.youtube.com/vi/ABERbwS_5rQ/mqdefault.jpg"
alt="Watch the Video" /></a></p>
<p><a
href="https://www.youtube.com/watch?v=ABERbwS_5rQ&amp;list=PLppGmFLhQ1HKKnk3riKNyOxb-3MTI-7zE&amp;index=30"
target="_blank">Watch the Video ↗</a></p>
<p><a
href="https://docs.google.com/presentation/d/1RraIdhQ0wv0ex66p_JGri7QzSYyLNU0elcxfxSGDS1Y/edit?usp=sharing"
target="_blank">View the Presentation ↗</a></p>
<p>You can review additional information and tips in the <a
href="https://docs.qgis.org/3.40/en/docs/user_manual/processing/scripts.html">Writing
new Processing algorithms as Python scripts</a> section of the QGIS User
Guide.</p>
<p>The Processing algorithms follow the structure as described
below:</p>
<ul>
<li>Processing scripts inherit from the base <a
href="https://qgis.org/pyqgis/3.40/core/QgsProcessingAlgorithm.html"><code>QgsProcessingAlgorithm</code></a>
class.</li>
<li>The <code>initAlgorithm()</code> method is called to set-up the
inputs and the outputs. The inputs and outputs to the processing
algorithms must be defined with appropriate class for the type of
parameter. You can see all the available classes for defining parameters
that inherit the <a
href="https://api.qgis.org/api/classQgsProcessingParameterDefinition.html"><code>QgsProcessingParameterDefinition</code></a>
class.</li>
<li>The <code>processAlgorithm()</code> method contains the main logic
of the script that gets executed when the user clicks the <em>Run</em>
button. You can get the references to the user selected inputs and
outputs using the methods from the <a
href="https://qgis.org/pyqgis/3.40/core/QgsProcessingAlgorithm.html"><code>QgsProcessingAlgorithm</code></a>
class.</li>
</ul>
<p>There is additional terminology and classes that you must understand
for writing Processing Scripts:</p>
<ul>
<li><strong>context</strong>: This is an object of the <a
href="https://qgis.org/pyqgis/3.40/core/QgsProcessingContext.html"><code>QgsProcessingContext</code></a>
class that contains information about the current project and settings.
Learn more at <a
href="https://gis.stackexchange.com/questions/419632/what-does-context-mean-in-pyqgis">what
does context mean in PyQGIS?</a>.</li>
<li><strong>feedback</strong>: This is an object of the <a
href="https://qgis.org/pyqgis/3.40/core/QgsProcessingFeedback.html"><code>QgsProcessingFeedback</code></a>
class that is used to communicate with the user during the execution of
the algorithm. This is used for updaitng the progress bar, displaying
error messages etc.</li>
<li><strong>source</strong> and <strong>sink</strong>: Processing
algorithms use specialized classes that make is simple to read and write
vector layers. The <a
href="https://qgis.org/pyqgis/3.40/core/QgsFeatureSource.html"><code>QgsFeatureSource</code></a>
class has methods to easily read features and <a
href="https://qgis.org/pyqgis/3.40/core/QgsFeatureSink.html"><code>QgsFeatureSink</code></a>
has methods to write features.</li>
</ul>
<p>We will now see how the Python Console script can be converted to a
Processing script.</p>
<p>To create a new processing script, go to <strong>Processing →
Processing Toolbox</strong>. Click the <em>Scripts</em> button and
select <em>Create New Script..</em>.</p>
<p><img src="images/pyqgis/processingscriptnew.png" width="75%" style="display: block; margin: auto;" /></p>
<p>Copy/paste the following code into the <em>Processing Script
Editor</em>.</p>
<p><code>save_attributes_processing.py</code></p>
<div class="sourceCode" id="cb44"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" tabindex="-1"></a><span class="im">from</span> PyQt5.QtCore <span class="im">import</span> QCoreApplication</span>
<span id="cb44-2"><a href="#cb44-2" tabindex="-1"></a><span class="im">from</span> qgis.core <span class="im">import</span> (Qgis,</span>
<span id="cb44-3"><a href="#cb44-3" tabindex="-1"></a>                       QgsProcessing,</span>
<span id="cb44-4"><a href="#cb44-4" tabindex="-1"></a>                       QgsProcessingAlgorithm,</span>
<span id="cb44-5"><a href="#cb44-5" tabindex="-1"></a>                       QgsProcessingParameterFeatureSource,</span>
<span id="cb44-6"><a href="#cb44-6" tabindex="-1"></a>                       QgsProcessingParameterFileDestination,</span>
<span id="cb44-7"><a href="#cb44-7" tabindex="-1"></a>                       QgsVectorFileWriter,</span>
<span id="cb44-8"><a href="#cb44-8" tabindex="-1"></a>                       QgsWkbTypes,</span>
<span id="cb44-9"><a href="#cb44-9" tabindex="-1"></a>                       QgsProject)</span>
<span id="cb44-10"><a href="#cb44-10" tabindex="-1"></a></span>
<span id="cb44-11"><a href="#cb44-11" tabindex="-1"></a></span>
<span id="cb44-12"><a href="#cb44-12" tabindex="-1"></a><span class="kw">class</span> SaveAttributesAlgorithm(QgsProcessingAlgorithm):</span>
<span id="cb44-13"><a href="#cb44-13" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;Saves the attributes of a vector layer to a CSV file.&quot;&quot;&quot;</span></span>
<span id="cb44-14"><a href="#cb44-14" tabindex="-1"></a></span>
<span id="cb44-15"><a href="#cb44-15" tabindex="-1"></a>    <span class="kw">def</span> initAlgorithm(<span class="va">self</span>, config<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb44-16"><a href="#cb44-16" tabindex="-1"></a>        <span class="va">self</span>.addParameter(</span>
<span id="cb44-17"><a href="#cb44-17" tabindex="-1"></a>            QgsProcessingParameterFeatureSource(</span>
<span id="cb44-18"><a href="#cb44-18" tabindex="-1"></a>                <span class="st">&#39;INPUT&#39;</span>,</span>
<span id="cb44-19"><a href="#cb44-19" tabindex="-1"></a>                <span class="st">&#39;Input layer&#39;</span>,</span>
<span id="cb44-20"><a href="#cb44-20" tabindex="-1"></a>                [Qgis.ProcessingSourceType.VectorAnyGeometry]</span>
<span id="cb44-21"><a href="#cb44-21" tabindex="-1"></a>            )</span>
<span id="cb44-22"><a href="#cb44-22" tabindex="-1"></a>        )</span>
<span id="cb44-23"><a href="#cb44-23" tabindex="-1"></a></span>
<span id="cb44-24"><a href="#cb44-24" tabindex="-1"></a>        <span class="co"># We add a file output of type CSV.</span></span>
<span id="cb44-25"><a href="#cb44-25" tabindex="-1"></a>        <span class="va">self</span>.addParameter(</span>
<span id="cb44-26"><a href="#cb44-26" tabindex="-1"></a>            QgsProcessingParameterFileDestination(</span>
<span id="cb44-27"><a href="#cb44-27" tabindex="-1"></a>                <span class="st">&#39;OUTPUT&#39;</span>,</span>
<span id="cb44-28"><a href="#cb44-28" tabindex="-1"></a>                <span class="st">&#39;Output File&#39;</span>,</span>
<span id="cb44-29"><a href="#cb44-29" tabindex="-1"></a>                <span class="st">&#39;CSV files (*.csv)&#39;</span>,</span>
<span id="cb44-30"><a href="#cb44-30" tabindex="-1"></a>            )</span>
<span id="cb44-31"><a href="#cb44-31" tabindex="-1"></a>        )</span>
<span id="cb44-32"><a href="#cb44-32" tabindex="-1"></a></span>
<span id="cb44-33"><a href="#cb44-33" tabindex="-1"></a>    <span class="kw">def</span> processAlgorithm(<span class="va">self</span>, parameters, context, feedback):</span>
<span id="cb44-34"><a href="#cb44-34" tabindex="-1"></a>        layer <span class="op">=</span> <span class="va">self</span>.parameterAsVectorLayer(</span>
<span id="cb44-35"><a href="#cb44-35" tabindex="-1"></a>            parameters,</span>
<span id="cb44-36"><a href="#cb44-36" tabindex="-1"></a>            <span class="st">&#39;INPUT&#39;</span>,</span>
<span id="cb44-37"><a href="#cb44-37" tabindex="-1"></a>            context)</span>
<span id="cb44-38"><a href="#cb44-38" tabindex="-1"></a></span>
<span id="cb44-39"><a href="#cb44-39" tabindex="-1"></a>        output <span class="op">=</span> <span class="va">self</span>.parameterAsFileOutput(</span>
<span id="cb44-40"><a href="#cb44-40" tabindex="-1"></a>            parameters,</span>
<span id="cb44-41"><a href="#cb44-41" tabindex="-1"></a>            <span class="st">&#39;OUTPUT&#39;</span>,</span>
<span id="cb44-42"><a href="#cb44-42" tabindex="-1"></a>            context)</span>
<span id="cb44-43"><a href="#cb44-43" tabindex="-1"></a></span>
<span id="cb44-44"><a href="#cb44-44" tabindex="-1"></a>        <span class="co"># get features from source</span></span>
<span id="cb44-45"><a href="#cb44-45" tabindex="-1"></a>        total <span class="op">=</span> layer.featureCount()</span>
<span id="cb44-46"><a href="#cb44-46" tabindex="-1"></a>        features <span class="op">=</span> layer.getFeatures()</span>
<span id="cb44-47"><a href="#cb44-47" tabindex="-1"></a>        </span>
<span id="cb44-48"><a href="#cb44-48" tabindex="-1"></a>        <span class="co"># Define the options for saving the layer</span></span>
<span id="cb44-49"><a href="#cb44-49" tabindex="-1"></a>        save_options <span class="op">=</span> QgsVectorFileWriter.SaveVectorOptions()</span>
<span id="cb44-50"><a href="#cb44-50" tabindex="-1"></a>        save_options.driverName <span class="op">=</span> <span class="st">&#39;CSV&#39;</span></span>
<span id="cb44-51"><a href="#cb44-51" tabindex="-1"></a>        save_options.fileEncoding <span class="op">=</span> <span class="st">&#39;UTF-8&#39;</span></span>
<span id="cb44-52"><a href="#cb44-52" tabindex="-1"></a></span>
<span id="cb44-53"><a href="#cb44-53" tabindex="-1"></a>        <span class="co"># Create the writer</span></span>
<span id="cb44-54"><a href="#cb44-54" tabindex="-1"></a>        writer <span class="op">=</span> QgsVectorFileWriter.create(</span>
<span id="cb44-55"><a href="#cb44-55" tabindex="-1"></a>            fileName<span class="op">=</span>output,</span>
<span id="cb44-56"><a href="#cb44-56" tabindex="-1"></a>            fields<span class="op">=</span>layer.fields(),</span>
<span id="cb44-57"><a href="#cb44-57" tabindex="-1"></a>            geometryType<span class="op">=</span>QgsWkbTypes.NoGeometry,</span>
<span id="cb44-58"><a href="#cb44-58" tabindex="-1"></a>            srs<span class="op">=</span>layer.crs(),</span>
<span id="cb44-59"><a href="#cb44-59" tabindex="-1"></a>            transformContext<span class="op">=</span>QgsProject.instance().transformContext(),</span>
<span id="cb44-60"><a href="#cb44-60" tabindex="-1"></a>            options<span class="op">=</span>save_options)</span>
<span id="cb44-61"><a href="#cb44-61" tabindex="-1"></a></span>
<span id="cb44-62"><a href="#cb44-62" tabindex="-1"></a>    </span>
<span id="cb44-63"><a href="#cb44-63" tabindex="-1"></a>        <span class="cf">for</span> current, f <span class="kw">in</span> <span class="bu">enumerate</span>(features):</span>
<span id="cb44-64"><a href="#cb44-64" tabindex="-1"></a>            <span class="co"># Stop the algorithm if cancel button has been clicked</span></span>
<span id="cb44-65"><a href="#cb44-65" tabindex="-1"></a>            <span class="cf">if</span> feedback.isCanceled():</span>
<span id="cb44-66"><a href="#cb44-66" tabindex="-1"></a>                <span class="cf">break</span></span>
<span id="cb44-67"><a href="#cb44-67" tabindex="-1"></a></span>
<span id="cb44-68"><a href="#cb44-68" tabindex="-1"></a>            <span class="co"># Add the feature</span></span>
<span id="cb44-69"><a href="#cb44-69" tabindex="-1"></a>            writer.addFeature(f)</span>
<span id="cb44-70"><a href="#cb44-70" tabindex="-1"></a></span>
<span id="cb44-71"><a href="#cb44-71" tabindex="-1"></a>            <span class="co"># Update the progress bar</span></span>
<span id="cb44-72"><a href="#cb44-72" tabindex="-1"></a>            <span class="cf">if</span> total <span class="op">!=</span> <span class="dv">0</span>:</span>
<span id="cb44-73"><a href="#cb44-73" tabindex="-1"></a>              progress <span class="op">=</span> <span class="bu">int</span>(<span class="dv">100</span><span class="op">*</span>(current<span class="op">/</span>total))</span>
<span id="cb44-74"><a href="#cb44-74" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb44-75"><a href="#cb44-75" tabindex="-1"></a>              progress <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb44-76"><a href="#cb44-76" tabindex="-1"></a>            feedback.setProgress(progress)</span>
<span id="cb44-77"><a href="#cb44-77" tabindex="-1"></a></span>
<span id="cb44-78"><a href="#cb44-78" tabindex="-1"></a>        <span class="cf">return</span> {<span class="st">&#39;OUTPUT&#39;</span>: output}</span>
<span id="cb44-79"><a href="#cb44-79" tabindex="-1"></a></span>
<span id="cb44-80"><a href="#cb44-80" tabindex="-1"></a>    <span class="kw">def</span> name(<span class="va">self</span>):</span>
<span id="cb44-81"><a href="#cb44-81" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">&#39;save_attributes&#39;</span></span>
<span id="cb44-82"><a href="#cb44-82" tabindex="-1"></a></span>
<span id="cb44-83"><a href="#cb44-83" tabindex="-1"></a>    <span class="kw">def</span> displayName(<span class="va">self</span>):</span>
<span id="cb44-84"><a href="#cb44-84" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>.tr(<span class="st">&#39;Save Attributes As CSV&#39;</span>)</span>
<span id="cb44-85"><a href="#cb44-85" tabindex="-1"></a> </span>
<span id="cb44-86"><a href="#cb44-86" tabindex="-1"></a>    <span class="kw">def</span> group(<span class="va">self</span>):</span>
<span id="cb44-87"><a href="#cb44-87" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>.tr(<span class="va">self</span>.groupId())</span>
<span id="cb44-88"><a href="#cb44-88" tabindex="-1"></a></span>
<span id="cb44-89"><a href="#cb44-89" tabindex="-1"></a>    <span class="kw">def</span> groupId(<span class="va">self</span>):</span>
<span id="cb44-90"><a href="#cb44-90" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">&#39;&#39;</span></span>
<span id="cb44-91"><a href="#cb44-91" tabindex="-1"></a></span>
<span id="cb44-92"><a href="#cb44-92" tabindex="-1"></a>    <span class="kw">def</span> tr(<span class="va">self</span>, string):</span>
<span id="cb44-93"><a href="#cb44-93" tabindex="-1"></a>        <span class="cf">return</span> QCoreApplication.translate(<span class="st">&#39;Processing&#39;</span>, string)</span>
<span id="cb44-94"><a href="#cb44-94" tabindex="-1"></a></span>
<span id="cb44-95"><a href="#cb44-95" tabindex="-1"></a>    <span class="kw">def</span> createInstance(<span class="va">self</span>):</span>
<span id="cb44-96"><a href="#cb44-96" tabindex="-1"></a>        <span class="cf">return</span> SaveAttributesAlgorithm()</span></code></pre></div>
<p><img src="images/pyqgis/processingscriptwrite.png" width="75%" style="display: block; margin: auto;" /></p>
<p>Click the <em>Save Script</em> button and save the script as
<code>save_attributes_algorithm.py</code>. This script must be saved
inside the <code>{profile folder}/processing/scripts/</code> directory
so it can be loaded when QGIS starts.</p>
<p>Once saved, the algorithm will appear in the <em>Processing
Toolbox</em> under <strong>Scripts → Save Attributes As CSV</strong>.
Double-click to launch it. You will see the standard processing
algorithm dialog where the user can select inputs and outputs easily.
Progress bar is shown correctly and the execution also stops if the user
presses the <em>Cancel</em> button. If the large is large and the
algorithm would take time to process it, the user can also close the
window and the algorithm will continue to run in the background.</p>
<p><img src="images/pyqgis/processingscriptrun.png" width="75%" style="display: block; margin: auto;" /></p>
</div>
<div id="processing-plugin" class="section level2">
<h2>11.4 Processing Plugin</h2>
<p>Let’s take the the processing script and package it in a processing
plugin. We will need to create the following files.</p>
<ul>
<li><code>metadata.txt</code>: Plugin information</li>
<li><code>__init__.py</code>: Initialization file</li>
<li><code>save_attributes.py</code>: The main file containing the
plugin’s class</li>
<li><code>save_attributes_algorithm.py</code>: The processing script.
This is identical to the script we wrote earlier.</li>
<li><code>save_attributes_provider.py</code>: Processing provider that
loads the algorithm.</li>
<li><code>logo.png</code>: Logo for the plugin action.</li>
</ul>
<p>Create these files with the content from below.</p>
<p><code>metadata.txt</code></p>
<div class="sourceCode" id="cb45"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" tabindex="-1"></a>[general]</span>
<span id="cb45-2"><a href="#cb45-2" tabindex="-1"></a>name<span class="op">=</span>Save Attributes</span>
<span id="cb45-3"><a href="#cb45-3" tabindex="-1"></a>description<span class="op">=</span>This plugin saves the attributes of the selected vector layer <span class="im">as</span> a CSV <span class="bu">file</span></span>
<span id="cb45-4"><a href="#cb45-4" tabindex="-1"></a>version<span class="op">=</span><span class="fl">1.0</span></span>
<span id="cb45-5"><a href="#cb45-5" tabindex="-1"></a>qgisMinimumVersion<span class="op">=</span><span class="fl">3.0</span></span>
<span id="cb45-6"><a href="#cb45-6" tabindex="-1"></a>author<span class="op">=</span>Ujaval Gandhi</span>
<span id="cb45-7"><a href="#cb45-7" tabindex="-1"></a>email<span class="op">=</span>ujaval<span class="op">@</span>spatialthoughts.com</span>
<span id="cb45-8"><a href="#cb45-8" tabindex="-1"></a>icon<span class="op">=</span>logo.png</span></code></pre></div>
<p><code>__init__.py</code></p>
<div class="sourceCode" id="cb46"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" tabindex="-1"></a><span class="im">from</span> .save_attributes <span class="im">import</span> SaveAttributesPlugin</span>
<span id="cb46-2"><a href="#cb46-2" tabindex="-1"></a></span>
<span id="cb46-3"><a href="#cb46-3" tabindex="-1"></a><span class="kw">def</span> classFactory(iface):</span>
<span id="cb46-4"><a href="#cb46-4" tabindex="-1"></a>    <span class="cf">return</span> SaveAttributesPlugin(iface)</span></code></pre></div>
<p><code>save_attributes_algorithm.py</code></p>
<div class="sourceCode" id="cb47"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" tabindex="-1"></a><span class="im">from</span> PyQt5.QtCore <span class="im">import</span> QCoreApplication</span>
<span id="cb47-2"><a href="#cb47-2" tabindex="-1"></a><span class="im">from</span> qgis.core <span class="im">import</span> (Qgis,</span>
<span id="cb47-3"><a href="#cb47-3" tabindex="-1"></a>                       QgsProcessing,</span>
<span id="cb47-4"><a href="#cb47-4" tabindex="-1"></a>                       QgsProcessingAlgorithm,</span>
<span id="cb47-5"><a href="#cb47-5" tabindex="-1"></a>                       QgsProcessingParameterFeatureSource,</span>
<span id="cb47-6"><a href="#cb47-6" tabindex="-1"></a>                       QgsProcessingParameterFileDestination,</span>
<span id="cb47-7"><a href="#cb47-7" tabindex="-1"></a>                       QgsVectorFileWriter,</span>
<span id="cb47-8"><a href="#cb47-8" tabindex="-1"></a>                       QgsWkbTypes,</span>
<span id="cb47-9"><a href="#cb47-9" tabindex="-1"></a>                       QgsProject)</span>
<span id="cb47-10"><a href="#cb47-10" tabindex="-1"></a></span>
<span id="cb47-11"><a href="#cb47-11" tabindex="-1"></a></span>
<span id="cb47-12"><a href="#cb47-12" tabindex="-1"></a><span class="kw">class</span> SaveAttributesAlgorithm(QgsProcessingAlgorithm):</span>
<span id="cb47-13"><a href="#cb47-13" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;Saves the attributes of a vector layer to a CSV file.&quot;&quot;&quot;</span></span>
<span id="cb47-14"><a href="#cb47-14" tabindex="-1"></a></span>
<span id="cb47-15"><a href="#cb47-15" tabindex="-1"></a>    <span class="kw">def</span> initAlgorithm(<span class="va">self</span>, config<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb47-16"><a href="#cb47-16" tabindex="-1"></a>        <span class="va">self</span>.addParameter(</span>
<span id="cb47-17"><a href="#cb47-17" tabindex="-1"></a>            QgsProcessingParameterFeatureSource(</span>
<span id="cb47-18"><a href="#cb47-18" tabindex="-1"></a>                <span class="st">&#39;INPUT&#39;</span>,</span>
<span id="cb47-19"><a href="#cb47-19" tabindex="-1"></a>                <span class="st">&#39;Input layer&#39;</span>,</span>
<span id="cb47-20"><a href="#cb47-20" tabindex="-1"></a>                [Qgis.ProcessingSourceType.VectorAnyGeometry]</span>
<span id="cb47-21"><a href="#cb47-21" tabindex="-1"></a>            )</span>
<span id="cb47-22"><a href="#cb47-22" tabindex="-1"></a>        )</span>
<span id="cb47-23"><a href="#cb47-23" tabindex="-1"></a></span>
<span id="cb47-24"><a href="#cb47-24" tabindex="-1"></a>        <span class="co"># We add a file output of type CSV.</span></span>
<span id="cb47-25"><a href="#cb47-25" tabindex="-1"></a>        <span class="va">self</span>.addParameter(</span>
<span id="cb47-26"><a href="#cb47-26" tabindex="-1"></a>            QgsProcessingParameterFileDestination(</span>
<span id="cb47-27"><a href="#cb47-27" tabindex="-1"></a>                <span class="st">&#39;OUTPUT&#39;</span>,</span>
<span id="cb47-28"><a href="#cb47-28" tabindex="-1"></a>                <span class="st">&#39;Output File&#39;</span>,</span>
<span id="cb47-29"><a href="#cb47-29" tabindex="-1"></a>                <span class="st">&#39;CSV files (*.csv)&#39;</span>,</span>
<span id="cb47-30"><a href="#cb47-30" tabindex="-1"></a>            )</span>
<span id="cb47-31"><a href="#cb47-31" tabindex="-1"></a>        )</span>
<span id="cb47-32"><a href="#cb47-32" tabindex="-1"></a></span>
<span id="cb47-33"><a href="#cb47-33" tabindex="-1"></a>    <span class="kw">def</span> processAlgorithm(<span class="va">self</span>, parameters, context, feedback):</span>
<span id="cb47-34"><a href="#cb47-34" tabindex="-1"></a>        layer <span class="op">=</span> <span class="va">self</span>.parameterAsVectorLayer(</span>
<span id="cb47-35"><a href="#cb47-35" tabindex="-1"></a>            parameters,</span>
<span id="cb47-36"><a href="#cb47-36" tabindex="-1"></a>            <span class="st">&#39;INPUT&#39;</span>,</span>
<span id="cb47-37"><a href="#cb47-37" tabindex="-1"></a>            context)</span>
<span id="cb47-38"><a href="#cb47-38" tabindex="-1"></a></span>
<span id="cb47-39"><a href="#cb47-39" tabindex="-1"></a>        output <span class="op">=</span> <span class="va">self</span>.parameterAsFileOutput(</span>
<span id="cb47-40"><a href="#cb47-40" tabindex="-1"></a>            parameters,</span>
<span id="cb47-41"><a href="#cb47-41" tabindex="-1"></a>            <span class="st">&#39;OUTPUT&#39;</span>,</span>
<span id="cb47-42"><a href="#cb47-42" tabindex="-1"></a>            context)</span>
<span id="cb47-43"><a href="#cb47-43" tabindex="-1"></a></span>
<span id="cb47-44"><a href="#cb47-44" tabindex="-1"></a>        <span class="co"># get features from source</span></span>
<span id="cb47-45"><a href="#cb47-45" tabindex="-1"></a>        total <span class="op">=</span> layer.featureCount()</span>
<span id="cb47-46"><a href="#cb47-46" tabindex="-1"></a>        features <span class="op">=</span> layer.getFeatures()</span>
<span id="cb47-47"><a href="#cb47-47" tabindex="-1"></a>        </span>
<span id="cb47-48"><a href="#cb47-48" tabindex="-1"></a>        <span class="co"># Define the options for saving the layer</span></span>
<span id="cb47-49"><a href="#cb47-49" tabindex="-1"></a>        save_options <span class="op">=</span> QgsVectorFileWriter.SaveVectorOptions()</span>
<span id="cb47-50"><a href="#cb47-50" tabindex="-1"></a>        save_options.driverName <span class="op">=</span> <span class="st">&#39;CSV&#39;</span></span>
<span id="cb47-51"><a href="#cb47-51" tabindex="-1"></a>        save_options.fileEncoding <span class="op">=</span> <span class="st">&#39;UTF-8&#39;</span></span>
<span id="cb47-52"><a href="#cb47-52" tabindex="-1"></a></span>
<span id="cb47-53"><a href="#cb47-53" tabindex="-1"></a>        <span class="co"># Create the writer</span></span>
<span id="cb47-54"><a href="#cb47-54" tabindex="-1"></a>        writer <span class="op">=</span> QgsVectorFileWriter.create(</span>
<span id="cb47-55"><a href="#cb47-55" tabindex="-1"></a>            fileName<span class="op">=</span>output,</span>
<span id="cb47-56"><a href="#cb47-56" tabindex="-1"></a>            fields<span class="op">=</span>layer.fields(),</span>
<span id="cb47-57"><a href="#cb47-57" tabindex="-1"></a>            geometryType<span class="op">=</span>QgsWkbTypes.NoGeometry,</span>
<span id="cb47-58"><a href="#cb47-58" tabindex="-1"></a>            srs<span class="op">=</span>layer.crs(),</span>
<span id="cb47-59"><a href="#cb47-59" tabindex="-1"></a>            transformContext<span class="op">=</span>QgsProject.instance().transformContext(),</span>
<span id="cb47-60"><a href="#cb47-60" tabindex="-1"></a>            options<span class="op">=</span>save_options)</span>
<span id="cb47-61"><a href="#cb47-61" tabindex="-1"></a></span>
<span id="cb47-62"><a href="#cb47-62" tabindex="-1"></a>    </span>
<span id="cb47-63"><a href="#cb47-63" tabindex="-1"></a>        <span class="cf">for</span> current, f <span class="kw">in</span> <span class="bu">enumerate</span>(features):</span>
<span id="cb47-64"><a href="#cb47-64" tabindex="-1"></a>            <span class="co"># Stop the algorithm if cancel button has been clicked</span></span>
<span id="cb47-65"><a href="#cb47-65" tabindex="-1"></a>            <span class="cf">if</span> feedback.isCanceled():</span>
<span id="cb47-66"><a href="#cb47-66" tabindex="-1"></a>                <span class="cf">break</span></span>
<span id="cb47-67"><a href="#cb47-67" tabindex="-1"></a></span>
<span id="cb47-68"><a href="#cb47-68" tabindex="-1"></a>            <span class="co"># Add the feature</span></span>
<span id="cb47-69"><a href="#cb47-69" tabindex="-1"></a>            writer.addFeature(f)</span>
<span id="cb47-70"><a href="#cb47-70" tabindex="-1"></a></span>
<span id="cb47-71"><a href="#cb47-71" tabindex="-1"></a>            <span class="co"># Update the progress bar</span></span>
<span id="cb47-72"><a href="#cb47-72" tabindex="-1"></a>            <span class="cf">if</span> total <span class="op">!=</span> <span class="dv">0</span>:</span>
<span id="cb47-73"><a href="#cb47-73" tabindex="-1"></a>              progress <span class="op">=</span> <span class="bu">int</span>(<span class="dv">100</span><span class="op">*</span>(current<span class="op">/</span>total))</span>
<span id="cb47-74"><a href="#cb47-74" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb47-75"><a href="#cb47-75" tabindex="-1"></a>              progress <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb47-76"><a href="#cb47-76" tabindex="-1"></a>            feedback.setProgress(progress)</span>
<span id="cb47-77"><a href="#cb47-77" tabindex="-1"></a></span>
<span id="cb47-78"><a href="#cb47-78" tabindex="-1"></a>        <span class="cf">return</span> {<span class="st">&#39;OUTPUT&#39;</span>: output}</span>
<span id="cb47-79"><a href="#cb47-79" tabindex="-1"></a></span>
<span id="cb47-80"><a href="#cb47-80" tabindex="-1"></a>    <span class="kw">def</span> name(<span class="va">self</span>):</span>
<span id="cb47-81"><a href="#cb47-81" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">&#39;save_attributes&#39;</span></span>
<span id="cb47-82"><a href="#cb47-82" tabindex="-1"></a></span>
<span id="cb47-83"><a href="#cb47-83" tabindex="-1"></a>    <span class="kw">def</span> displayName(<span class="va">self</span>):</span>
<span id="cb47-84"><a href="#cb47-84" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>.tr(<span class="st">&#39;Save Attributes As CSV&#39;</span>)</span>
<span id="cb47-85"><a href="#cb47-85" tabindex="-1"></a> </span>
<span id="cb47-86"><a href="#cb47-86" tabindex="-1"></a>    <span class="kw">def</span> group(<span class="va">self</span>):</span>
<span id="cb47-87"><a href="#cb47-87" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>.tr(<span class="va">self</span>.groupId())</span>
<span id="cb47-88"><a href="#cb47-88" tabindex="-1"></a></span>
<span id="cb47-89"><a href="#cb47-89" tabindex="-1"></a>    <span class="kw">def</span> groupId(<span class="va">self</span>):</span>
<span id="cb47-90"><a href="#cb47-90" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">&#39;&#39;</span></span>
<span id="cb47-91"><a href="#cb47-91" tabindex="-1"></a></span>
<span id="cb47-92"><a href="#cb47-92" tabindex="-1"></a>    <span class="kw">def</span> tr(<span class="va">self</span>, string):</span>
<span id="cb47-93"><a href="#cb47-93" tabindex="-1"></a>        <span class="cf">return</span> QCoreApplication.translate(<span class="st">&#39;Processing&#39;</span>, string)</span>
<span id="cb47-94"><a href="#cb47-94" tabindex="-1"></a></span>
<span id="cb47-95"><a href="#cb47-95" tabindex="-1"></a>    <span class="kw">def</span> createInstance(<span class="va">self</span>):</span>
<span id="cb47-96"><a href="#cb47-96" tabindex="-1"></a>        <span class="cf">return</span> SaveAttributesAlgorithm()</span></code></pre></div>
<p><code>save_attributes_provider.py</code></p>
<div class="sourceCode" id="cb48"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb48-2"><a href="#cb48-2" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb48-3"><a href="#cb48-3" tabindex="-1"></a><span class="im">from</span> PyQt5.QtGui <span class="im">import</span> QIcon</span>
<span id="cb48-4"><a href="#cb48-4" tabindex="-1"></a></span>
<span id="cb48-5"><a href="#cb48-5" tabindex="-1"></a><span class="im">from</span> qgis.core <span class="im">import</span> QgsProcessingProvider</span>
<span id="cb48-6"><a href="#cb48-6" tabindex="-1"></a><span class="im">from</span> .save_attributes_algorithm <span class="im">import</span> SaveAttributesAlgorithm</span>
<span id="cb48-7"><a href="#cb48-7" tabindex="-1"></a></span>
<span id="cb48-8"><a href="#cb48-8" tabindex="-1"></a>plugin_dir <span class="op">=</span> os.path.dirname(<span class="va">__file__</span>)</span>
<span id="cb48-9"><a href="#cb48-9" tabindex="-1"></a></span>
<span id="cb48-10"><a href="#cb48-10" tabindex="-1"></a><span class="kw">class</span> SaveAttributesProvider(QgsProcessingProvider):</span>
<span id="cb48-11"><a href="#cb48-11" tabindex="-1"></a></span>
<span id="cb48-12"><a href="#cb48-12" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>):</span>
<span id="cb48-13"><a href="#cb48-13" tabindex="-1"></a>        QgsProcessingProvider.<span class="fu">__init__</span>(<span class="va">self</span>)</span>
<span id="cb48-14"><a href="#cb48-14" tabindex="-1"></a></span>
<span id="cb48-15"><a href="#cb48-15" tabindex="-1"></a>    <span class="kw">def</span> unload(<span class="va">self</span>):</span>
<span id="cb48-16"><a href="#cb48-16" tabindex="-1"></a>        QgsProcessingProvider.unload(<span class="va">self</span>)</span>
<span id="cb48-17"><a href="#cb48-17" tabindex="-1"></a></span>
<span id="cb48-18"><a href="#cb48-18" tabindex="-1"></a>    <span class="kw">def</span> loadAlgorithms(<span class="va">self</span>):</span>
<span id="cb48-19"><a href="#cb48-19" tabindex="-1"></a>        <span class="va">self</span>.addAlgorithm(SaveAttributesAlgorithm())</span>
<span id="cb48-20"><a href="#cb48-20" tabindex="-1"></a></span>
<span id="cb48-21"><a href="#cb48-21" tabindex="-1"></a>    <span class="kw">def</span> <span class="bu">id</span>(<span class="va">self</span>):</span>
<span id="cb48-22"><a href="#cb48-22" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">&#39;save_attributes&#39;</span></span>
<span id="cb48-23"><a href="#cb48-23" tabindex="-1"></a></span>
<span id="cb48-24"><a href="#cb48-24" tabindex="-1"></a>    <span class="kw">def</span> name(<span class="va">self</span>):</span>
<span id="cb48-25"><a href="#cb48-25" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>.tr(<span class="st">&#39;Save Attributes&#39;</span>)</span>
<span id="cb48-26"><a href="#cb48-26" tabindex="-1"></a></span>
<span id="cb48-27"><a href="#cb48-27" tabindex="-1"></a>    <span class="kw">def</span> icon(<span class="va">self</span>):</span>
<span id="cb48-28"><a href="#cb48-28" tabindex="-1"></a>        icon <span class="op">=</span> QIcon(os.path.join(os.path.join(plugin_dir, <span class="st">&#39;logo.png&#39;</span>)))</span>
<span id="cb48-29"><a href="#cb48-29" tabindex="-1"></a>        <span class="cf">return</span> icon</span>
<span id="cb48-30"><a href="#cb48-30" tabindex="-1"></a></span>
<span id="cb48-31"><a href="#cb48-31" tabindex="-1"></a>    <span class="kw">def</span> longName(<span class="va">self</span>):</span>
<span id="cb48-32"><a href="#cb48-32" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>.name()</span></code></pre></div>
<p><code>save_attributes.py</code></p>
<div class="sourceCode" id="cb49"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb49-2"><a href="#cb49-2" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb49-3"><a href="#cb49-3" tabindex="-1"></a><span class="im">from</span> PyQt5.QtWidgets <span class="im">import</span> QAction</span>
<span id="cb49-4"><a href="#cb49-4" tabindex="-1"></a><span class="im">from</span> PyQt5.QtGui <span class="im">import</span> QIcon</span>
<span id="cb49-5"><a href="#cb49-5" tabindex="-1"></a></span>
<span id="cb49-6"><a href="#cb49-6" tabindex="-1"></a><span class="im">from</span> qgis.core <span class="im">import</span> QgsProcessingAlgorithm, QgsApplication</span>
<span id="cb49-7"><a href="#cb49-7" tabindex="-1"></a><span class="im">import</span> processing</span>
<span id="cb49-8"><a href="#cb49-8" tabindex="-1"></a><span class="im">from</span> .save_attributes_provider <span class="im">import</span> SaveAttributesProvider</span>
<span id="cb49-9"><a href="#cb49-9" tabindex="-1"></a></span>
<span id="cb49-10"><a href="#cb49-10" tabindex="-1"></a></span>
<span id="cb49-11"><a href="#cb49-11" tabindex="-1"></a>plugin_dir <span class="op">=</span> os.path.dirname(<span class="va">__file__</span>)</span>
<span id="cb49-12"><a href="#cb49-12" tabindex="-1"></a></span>
<span id="cb49-13"><a href="#cb49-13" tabindex="-1"></a><span class="kw">class</span> SaveAttributesPlugin:</span>
<span id="cb49-14"><a href="#cb49-14" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, iface):</span>
<span id="cb49-15"><a href="#cb49-15" tabindex="-1"></a>        <span class="va">self</span>.iface <span class="op">=</span> iface</span>
<span id="cb49-16"><a href="#cb49-16" tabindex="-1"></a></span>
<span id="cb49-17"><a href="#cb49-17" tabindex="-1"></a>    <span class="kw">def</span> initProcessing(<span class="va">self</span>):</span>
<span id="cb49-18"><a href="#cb49-18" tabindex="-1"></a>      <span class="va">self</span>.provider <span class="op">=</span> SaveAttributesProvider()</span>
<span id="cb49-19"><a href="#cb49-19" tabindex="-1"></a>      QgsApplication.processingRegistry().addProvider(<span class="va">self</span>.provider)</span>
<span id="cb49-20"><a href="#cb49-20" tabindex="-1"></a>        </span>
<span id="cb49-21"><a href="#cb49-21" tabindex="-1"></a>    <span class="kw">def</span> initGui(<span class="va">self</span>):</span>
<span id="cb49-22"><a href="#cb49-22" tabindex="-1"></a>      <span class="va">self</span>.initProcessing()</span>
<span id="cb49-23"><a href="#cb49-23" tabindex="-1"></a>      icon <span class="op">=</span> os.path.join(os.path.join(plugin_dir, <span class="st">&#39;logo.png&#39;</span>))</span>
<span id="cb49-24"><a href="#cb49-24" tabindex="-1"></a>      <span class="va">self</span>.action <span class="op">=</span> QAction(QIcon(icon), <span class="st">&#39;Save Attributes as CSV&#39;</span>, <span class="va">self</span>.iface.mainWindow())</span>
<span id="cb49-25"><a href="#cb49-25" tabindex="-1"></a>      <span class="va">self</span>.action.triggered.<span class="ex">connect</span>(<span class="va">self</span>.run)</span>
<span id="cb49-26"><a href="#cb49-26" tabindex="-1"></a>      <span class="va">self</span>.iface.addPluginToMenu(<span class="st">&#39;&amp;Save Attributes&#39;</span>, <span class="va">self</span>.action)</span>
<span id="cb49-27"><a href="#cb49-27" tabindex="-1"></a>      <span class="va">self</span>.iface.addToolBarIcon(<span class="va">self</span>.action)</span>
<span id="cb49-28"><a href="#cb49-28" tabindex="-1"></a></span>
<span id="cb49-29"><a href="#cb49-29" tabindex="-1"></a>    <span class="kw">def</span> unload(<span class="va">self</span>):</span>
<span id="cb49-30"><a href="#cb49-30" tabindex="-1"></a>      QgsApplication.processingRegistry().removeProvider(<span class="va">self</span>.provider)</span>
<span id="cb49-31"><a href="#cb49-31" tabindex="-1"></a>      <span class="va">self</span>.iface.removeToolBarIcon(<span class="va">self</span>.action)</span>
<span id="cb49-32"><a href="#cb49-32" tabindex="-1"></a>      <span class="va">self</span>.iface.removePluginMenu(<span class="st">&#39;&amp;Save Attributes&#39;</span>, <span class="va">self</span>.action)  </span>
<span id="cb49-33"><a href="#cb49-33" tabindex="-1"></a>      <span class="kw">del</span> <span class="va">self</span>.action</span>
<span id="cb49-34"><a href="#cb49-34" tabindex="-1"></a></span>
<span id="cb49-35"><a href="#cb49-35" tabindex="-1"></a>    <span class="kw">def</span> run(<span class="va">self</span>):</span>
<span id="cb49-36"><a href="#cb49-36" tabindex="-1"></a>      processing.execAlgorithmDialog(<span class="st">&#39;save_attributes:save_attributes&#39;</span>)</span></code></pre></div>
<p><code>logo.png</code></p>
<p>Copy the logo file from your data package.</p>
<p>The plugin folder should look like below.</p>
<p><img src="images/pyqgis/pluginprocessingfiles.png" width="75%" style="display: block; margin: auto;" /></p>
<p>Restart QGIS and enable the plugin from <strong>Plugins → Manage and
Install plugins… → Installed → Save Attributes</strong></p>
<p>Once loaded, you can click on the toolbar button or <strong>Plugin →
Save Attributes → Save Attributes As CSV</strong> to launch the
processing algorithm.</p>
<p><img src="images/pyqgis/pluginprocessingrun.png" width="75%" style="display: block; margin: auto;" /></p>
</div>
</div>
<div id="qgis-actions" class="section level1">
<h1>12. QGIS Actions</h1>
<p><a
href="https://docs.qgis.org/testing/en/docs/user_manual/working_with_vector/vector_properties.html#actions-properties">Actions</a>
in QGIS provide a quick and easy way to trigger custom behavior in
response to a user’s action - such as click on a feature in the canvas
or an attribute value in the attribute table. Actions are defined for a
layer and are saved in QGIS projects. This makes actions the easiest way
to add and distribute QGIS customizations without having to write
plugins.</p>
<p><a
href="https://www.youtube.com/watch?v=6LTTKjGabXM&amp;list=PLppGmFLhQ1HKKnk3riKNyOxb-3MTI-7zE&amp;index=33"
target="_blank"><img
src="https://img.youtube.com/vi/6LTTKjGabXM/mqdefault.jpg"
alt="Watch the Video" /></a></p>
<p><a
href="https://www.youtube.com/watch?v=6LTTKjGabXM&amp;list=PLppGmFLhQ1HKKnk3riKNyOxb-3MTI-7zE&amp;index=33"
target="_blank">Watch the Video ↗</a></p>
<p><a
href="https://docs.google.com/presentation/d/1wuGXVRBfZ2RxiiKY8zVs85JDKSgs0_NeZDS795hroCw/edit?usp=sharing"
target="_blank">View the Presentation ↗</a></p>
<div id="hello-world-1" class="section level2">
<h2>12.1 Hello World</h2>
<p>Let’s get started by learning the basics of QGIS Actions. We will
create an action that takes a layer of all countries in the world and
allows you to extract any country polygon by clicking on it.</p>
<ol style="list-style-type: decimal">
<li>Open QGIS. QGIS comes with a few hidden <em>Easter Eggs</em> that
can be triggered by typing a keyword in the <em>Coordinate</em> box at
the bottom of the main window. While many of these are for fun, some
provide useful functionality. One such hidden feature is the ability to
load a world map by typing a keyword. Enter the keyword
<strong>world</strong> into the coordinate box at the bottom of the QGIS
window rm and click <em>Enter</em>.</li>
</ol>
<p><img src="images/pyqgis/helloworld1.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="2" style="list-style-type: decimal">
<li>A new layer named <code>World Map</code> will be added to the
<em>Layers</em> panel. This layer is the <a
href="https://www.naturalearthdata.com/downloads/10m-cultural-vectors/">Admin0
- Countries</a> boundaries dataset from Natural Earth. Let’s define an
action on this layer. Right-click the layer and select
<em>Properties</em>.</li>
</ol>
<p><img src="images/pyqgis/helloworld2.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="3" style="list-style-type: decimal">
<li>Switch to the <em>Actions</em> tab and click the <em>Add a new
action</em> (<em>+</em>) button.</li>
</ol>
<p><img src="images/pyqgis/helloworld3.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="4" style="list-style-type: decimal">
<li>Select <strong>Python</strong> as the <em>Type</em>. Enter
<strong>Hello World</strong> as the <em>Description</em>. This will be
the name of the action as it appears in various menu items. Leave the
<em>Action Scopes</em> to the default selected values of
<strong>Feature</strong> and <strong>Canvas</strong>. Under the
<em>Action Text</em> enter the following Python code and click
<em>OK</em>.</li>
</ol>
<div class="sourceCode" id="cb50"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&#39;Hello World&#39;</span>)</span></code></pre></div>
<p><img src="images/pyqgis/helloworld4.png" width="60%" style="display: block; margin: auto;" /></p>
<ol start="5" style="list-style-type: decimal">
<li>Click <em>OK</em> again to get back to the main QGIS Canvas. We now
have an action that will print <code>Hello World</code> when we click on
a feature. To see the output, open the <em>Python Console</em> from
<strong>Plugins → Python Console</strong>. Locate the <em>Actions</em>
button on the <em>Attributes Toolbar</em>. Click the dropdown menu next
to it and select <em>Hello World</em>.</li>
</ol>
<p><img src="images/pyqgis/helloworld5.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="6" style="list-style-type: decimal">
<li>Once the action is selected, click on any feature from the layer.
You will see <em>Hello World</em> printed in the console.</li>
</ol>
<p><img src="images/pyqgis/helloworld6.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="7" style="list-style-type: decimal">
<li>You now know how to define and trigger a Python action. Let’s make
the action more useful. Instead of printing a static text, let’s modify
the action to print the name of the country where we clicked. Open the
<em>Attribute Table</em> of the <code>World Map</code> layer. You will
notice that the <strong>NAME</strong> attribute contains the country
names.</li>
</ol>
<p><img src="images/pyqgis/helloworld7.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="8" style="list-style-type: decimal">
<li>Right click the <code>World Map</code> layer and select
<em>Properties</em>. From the <em>Actions</em> tab, double click the
already defined <em>Hello World</em> action.</li>
</ol>
<p><img src="images/pyqgis/helloworld8.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="9" style="list-style-type: decimal">
<li>Our action is triggered by clicking on a feature and we can access
the attributes of that feature. Select the <strong>NAME</strong>
attribute and click <em>Insert</em>.</li>
</ol>
<p><img src="images/pyqgis/helloworld9.png" width="60%" style="display: block; margin: auto;" /></p>
<ol start="10" style="list-style-type: decimal">
<li>You will see the value <code>[%NAME%]</code> entered in the
<em>Action Text</em> text box. This is a special expression syntax which
indicates that the value surrounded by <code>[%</code> and
<code>%]</code> will be replaced with the value of the attribute from
the feature when the action is triggered.</li>
</ol>
<p><img src="images/pyqgis/helloworld10.png" width="60%" style="display: block; margin: auto;" /></p>
<ol start="11" style="list-style-type: decimal">
<li>Update the code to print the attribute value as below.</li>
</ol>
<div class="sourceCode" id="cb51"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb51-1"><a href="#cb51-1" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&#39;[%NAME%]&#39;</span>)</span></code></pre></div>
<p><img src="images/pyqgis/helloworld11.png" width="60%" style="display: block; margin: auto;" /></p>
<ol start="12" style="list-style-type: decimal">
<li>Click <em>OK</em> and get back to the main window. Select the action
and click on any feature. You will now see the name of the country
printed in the console.</li>
</ol>
<p><img src="images/pyqgis/helloworld12.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="13" style="list-style-type: decimal">
<li>Along with all the attributes of the clicked feature, we also have
access to other project and layer variables. Update the code as below to
print the values of the feature id and layer id along with the value of
the <code>NAME</code> attribute. Note that we are using the Python <a
href="https://realpython.com/python-string-formatting/#3-string-interpolation-f-strings-python-36">f-strings</a>
for formatting the output.</li>
</ol>
<div class="sourceCode" id="cb52"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1" tabindex="-1"></a>feature_name <span class="op">=</span> <span class="st">&#39;[%NAME%]&#39;</span></span>
<span id="cb52-2"><a href="#cb52-2" tabindex="-1"></a>feature_id <span class="op">=</span> [<span class="op">%</span>$id<span class="op">%</span>]</span>
<span id="cb52-3"><a href="#cb52-3" tabindex="-1"></a>layer_id <span class="op">=</span> <span class="st">&#39;[%@layer_id%]&#39;</span></span>
<span id="cb52-4"><a href="#cb52-4" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f&#39;feature name: </span><span class="sc">{</span>feature_name<span class="sc">}</span><span class="ss">&#39;</span>)</span>
<span id="cb52-5"><a href="#cb52-5" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f&#39;feature id: </span><span class="sc">{</span>feature_id<span class="sc">}</span><span class="ss">&#39;</span>)</span>
<span id="cb52-6"><a href="#cb52-6" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f&#39;layer id: </span><span class="sc">{</span>layer_id<span class="sc">}</span><span class="ss">&#39;</span>)</span></code></pre></div>
<p><img src="images/pyqgis/helloworld13.png" width="60%" style="display: block; margin: auto;" /></p>
<ol start="14" style="list-style-type: decimal">
<li>Click <em>OK</em> and try the action again. This time you will see
the feature id and layer id printed along with the feature name.</li>
</ol>
<p><img src="images/pyqgis/helloworld14.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="15" style="list-style-type: decimal">
<li>Now you know how to access the <code>@layer_id</code> and
<code>$id</code> values of the current feature. We can now use it to
extract the current feature and create a new layer from it. Replace the
<em>Action Text</em> with the following code which uses <a
href="https://qgis.org/pyqgis/3.40/core/QgsFeatureSource.html#qgis.core.QgsFeatureSource.materialize"><code>QgsFeatureSource.materialize()</code></a>
method to create a new memory based vector layer with the query
containing the feature id.</li>
</ol>
<div class="sourceCode" id="cb53"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb53-1"><a href="#cb53-1" tabindex="-1"></a>feature_name <span class="op">=</span> <span class="st">&#39;[%NAME%]&#39;</span></span>
<span id="cb53-2"><a href="#cb53-2" tabindex="-1"></a>feature_id <span class="op">=</span> [<span class="op">%</span>$id<span class="op">%</span>]</span>
<span id="cb53-3"><a href="#cb53-3" tabindex="-1"></a>layer_id <span class="op">=</span> <span class="st">&#39;[%@layer_id%]&#39;</span></span>
<span id="cb53-4"><a href="#cb53-4" tabindex="-1"></a></span>
<span id="cb53-5"><a href="#cb53-5" tabindex="-1"></a>layer <span class="op">=</span> QgsProject.instance().mapLayer(layer_id)</span>
<span id="cb53-6"><a href="#cb53-6" tabindex="-1"></a>new_layer <span class="op">=</span> layer.materialize(</span>
<span id="cb53-7"><a href="#cb53-7" tabindex="-1"></a>    QgsFeatureRequest().setFilterFids([feature_id]))</span>
<span id="cb53-8"><a href="#cb53-8" tabindex="-1"></a>new_layer.setName(feature_name)</span>
<span id="cb53-9"><a href="#cb53-9" tabindex="-1"></a>QgsProject.instance().addMapLayer(new_layer)</span></code></pre></div>
<p><img src="images/pyqgis/helloworld15.png" width="60%" style="display: block; margin: auto;" /></p>
<ol start="16" style="list-style-type: decimal">
<li>Go back to the main Canvas and close the <em>Python Console</em>.
Select the <em>Hello World</em> action and click on any feature. You
will see a new layer added to the <em>Layers</em> panel that contains
the feature. Really useful!</li>
</ol>
<p><img src="images/pyqgis/helloworld16.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="17" style="list-style-type: decimal">
<li>We have a small problem. As the new layer is created and added to
the <em>Layers</em> panel, it becomes the active layer. To trigger the
action again, we have to select the <code>World Map</code> layer again.
To prevent this, we can use <a
href="https://qgis.org/pyqgis/3.40/gui/QgisInterface.html#qgis.gui.QgisInterface.setActiveLayer"><code>QgisInterface.setActiveLayer()</code></a>
method to set the current layer as the active layer. We import
<code>iface</code> in the code to access the current instance of the
<code>QgisInterface</code> class.</li>
</ol>
<div class="sourceCode" id="cb54"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb54-1"><a href="#cb54-1" tabindex="-1"></a><span class="im">from</span> qgis.utils <span class="im">import</span> iface</span>
<span id="cb54-2"><a href="#cb54-2" tabindex="-1"></a></span>
<span id="cb54-3"><a href="#cb54-3" tabindex="-1"></a>feature_name <span class="op">=</span> <span class="st">&#39;[%NAME%]&#39;</span></span>
<span id="cb54-4"><a href="#cb54-4" tabindex="-1"></a>feature_id <span class="op">=</span> [<span class="op">%</span>$id<span class="op">%</span>]</span>
<span id="cb54-5"><a href="#cb54-5" tabindex="-1"></a>layer_id <span class="op">=</span> <span class="st">&#39;[%@layer_id%]&#39;</span></span>
<span id="cb54-6"><a href="#cb54-6" tabindex="-1"></a></span>
<span id="cb54-7"><a href="#cb54-7" tabindex="-1"></a>layer <span class="op">=</span> QgsProject.instance().mapLayer(layer_id)</span>
<span id="cb54-8"><a href="#cb54-8" tabindex="-1"></a>new_layer <span class="op">=</span> layer.materialize(</span>
<span id="cb54-9"><a href="#cb54-9" tabindex="-1"></a>    QgsFeatureRequest().setFilterFids([feature_id]))</span>
<span id="cb54-10"><a href="#cb54-10" tabindex="-1"></a>new_layer.setName(feature_name)</span>
<span id="cb54-11"><a href="#cb54-11" tabindex="-1"></a>QgsProject.instance().addMapLayer(new_layer)</span>
<span id="cb54-12"><a href="#cb54-12" tabindex="-1"></a>iface.setActiveLayer(layer)</span></code></pre></div>
<p><img src="images/pyqgis/helloworld17.png" width="60%" style="display: block; margin: auto;" /></p>
<ol start="18" style="list-style-type: decimal">
<li>Now you are able to click around and extract multiple countries
without having to manually switch layers.</li>
</ol>
<p><img src="images/pyqgis/helloworld18.png" width="75%" style="display: block; margin: auto;" /></p>
</div>
<div id="exercise-10" class="section level2">
<h2>Exercise 10</h2>
<p>Update the action to display an <em>Info</em> message on the QGIS
message bar as shown below.</p>
<p>Hint: You can use <a
href="https://qgis.org/pyqgis/3.0/gui/Message/QgsMessageBar.html#qgis.gui.QgsMessageBar.pushInfo">iface.messageBar().pushInfo()</a>
method to display a message.</p>
<p><img src="images/pyqgis/helloworld_exercise.png" width="75%" style="display: block; margin: auto;" /></p>
</div>
<div id="selecting-neighbors" class="section level2">
<h2>12.2 Selecting Neighbors</h2>
<p>In this section, we will work with a dataset of US States and
implement QGIS Actions for selecting easily selecting neighbors of any
state.</p>
<ol style="list-style-type: decimal">
<li>Locate the <code>neighbors.gpkg</code> from the data package in the
<em>Browser</em> panel. Expand it and click on the
<code>neighbors.qgz</code> project to open it.</li>
</ol>
<p><img src="images/pyqgis/neighbors1.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="2" style="list-style-type: decimal">
<li>Right-click the <code>states</code> layer and select
<em>Properties</em>.</li>
</ol>
<p><img src="images/pyqgis/neighbors2.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="3" style="list-style-type: decimal">
<li>Switch to the <em>Actions</em> tab and click the <em>Add a new
action (+)</em> button. Select <strong>Python</strong> as the Type.
Enter <strong>Select First-degree Neighbors</strong> as the Description.
Leave the Action Scopes to the default selected values of
<strong>Feature</strong> and <strong>Canvas</strong>. Under the Action
Text enter the following Python code and click <em>OK</em>. Click
<em>OK</em> again to get back to the main QGIS Canvas.</li>
</ol>
<p><img src="images/pyqgis/neighbors3.png" width="60%" style="display: block; margin: auto;" /></p>
<div class="sourceCode" id="cb55"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb55-1"><a href="#cb55-1" tabindex="-1"></a>layer_id <span class="op">=</span> <span class="st">&#39;[%@layer_id%]&#39;</span></span>
<span id="cb55-2"><a href="#cb55-2" tabindex="-1"></a>fid <span class="op">=</span> [<span class="op">%</span> $id <span class="op">%</span>]</span>
<span id="cb55-3"><a href="#cb55-3" tabindex="-1"></a></span>
<span id="cb55-4"><a href="#cb55-4" tabindex="-1"></a>layer <span class="op">=</span> QgsProject.instance().mapLayer(layer_id)</span>
<span id="cb55-5"><a href="#cb55-5" tabindex="-1"></a></span>
<span id="cb55-6"><a href="#cb55-6" tabindex="-1"></a><span class="kw">def</span> get_neighbors(fid):</span>
<span id="cb55-7"><a href="#cb55-7" tabindex="-1"></a>    f <span class="op">=</span> layer.getFeature(fid)</span>
<span id="cb55-8"><a href="#cb55-8" tabindex="-1"></a>    <span class="co"># Use list comprehension to get all intersecting features</span></span>
<span id="cb55-9"><a href="#cb55-9" tabindex="-1"></a>    <span class="co"># You may also use touches() if your data is topologically correct</span></span>
<span id="cb55-10"><a href="#cb55-10" tabindex="-1"></a>    <span class="co"># Supply the bounding box to getFeatures() to use Spatial Index</span></span>
<span id="cb55-11"><a href="#cb55-11" tabindex="-1"></a>    neighbors <span class="op">=</span> [</span>
<span id="cb55-12"><a href="#cb55-12" tabindex="-1"></a>        c.<span class="bu">id</span>()</span>
<span id="cb55-13"><a href="#cb55-13" tabindex="-1"></a>        <span class="cf">for</span> c <span class="kw">in</span> layer.getFeatures(f.geometry().boundingBox())</span>
<span id="cb55-14"><a href="#cb55-14" tabindex="-1"></a>        <span class="cf">if</span> c.geometry().intersects(f.geometry()) <span class="kw">and</span> c.<span class="bu">id</span>() <span class="op">!=</span> f.<span class="bu">id</span>()</span>
<span id="cb55-15"><a href="#cb55-15" tabindex="-1"></a>    ]</span>
<span id="cb55-16"><a href="#cb55-16" tabindex="-1"></a>    <span class="cf">return</span> neighbors</span>
<span id="cb55-17"><a href="#cb55-17" tabindex="-1"></a></span>
<span id="cb55-18"><a href="#cb55-18" tabindex="-1"></a></span>
<span id="cb55-19"><a href="#cb55-19" tabindex="-1"></a>first_degree_neighbors <span class="op">=</span> get_neighbors(fid)</span>
<span id="cb55-20"><a href="#cb55-20" tabindex="-1"></a></span>
<span id="cb55-21"><a href="#cb55-21" tabindex="-1"></a><span class="co"># Apply the selection</span></span>
<span id="cb55-22"><a href="#cb55-22" tabindex="-1"></a>layer.selectByIds(first_degree_neighbors)</span></code></pre></div>
<ol start="4" style="list-style-type: decimal">
<li>Locate the <em>Actions</em> button on the <em>Attributes
Toolbar</em>. Trigger the action <em>Select First-degree Neighbors</em>
and click on any states. You will see all the neighbors selected.</li>
</ol>
<p><img src="images/pyqgis/neighbors4.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="5" style="list-style-type: decimal">
<li>We can add one more action to select second-degree neighbors
(i.e. neighbors of neighbors). Right-click the <code>states</code> layer
and select Properties. Switch to the <em>Actions</em> tab and click the
<em>Add a new action (+)</em> button. Select <strong>Python</strong> as
the Type. Enter <strong>Select Second-degree Neighbors</strong> as the
Description. Leave the Action Scopes to the default selected values of
<strong>Feature</strong> and <strong>Canvas</strong>. Under the Action
Text enter the following Python code and click <em>OK</em>. Click
<em>OK</em> again to get back to the main QGIS Canvas.</li>
</ol>
<p><img src="images/pyqgis/neighbors5.png" width="60%" style="display: block; margin: auto;" /></p>
<div class="sourceCode" id="cb56"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb56-1"><a href="#cb56-1" tabindex="-1"></a>layer_id <span class="op">=</span> <span class="st">&#39;[%@layer_id%]&#39;</span></span>
<span id="cb56-2"><a href="#cb56-2" tabindex="-1"></a>fid <span class="op">=</span> [<span class="op">%</span> $id <span class="op">%</span>]</span>
<span id="cb56-3"><a href="#cb56-3" tabindex="-1"></a></span>
<span id="cb56-4"><a href="#cb56-4" tabindex="-1"></a>layer <span class="op">=</span> QgsProject.instance().mapLayer(layer_id)</span>
<span id="cb56-5"><a href="#cb56-5" tabindex="-1"></a></span>
<span id="cb56-6"><a href="#cb56-6" tabindex="-1"></a><span class="kw">def</span> get_neighbors(fid):</span>
<span id="cb56-7"><a href="#cb56-7" tabindex="-1"></a>    f <span class="op">=</span> layer.getFeature(fid)</span>
<span id="cb56-8"><a href="#cb56-8" tabindex="-1"></a>    <span class="co"># Use list comprehension to get all intersecting features</span></span>
<span id="cb56-9"><a href="#cb56-9" tabindex="-1"></a>    <span class="co"># You may also use touches() if your data is topologically correct</span></span>
<span id="cb56-10"><a href="#cb56-10" tabindex="-1"></a>    <span class="co"># Supply the bounding box to getFeatures() to use Spatial Index</span></span>
<span id="cb56-11"><a href="#cb56-11" tabindex="-1"></a>    neighbors <span class="op">=</span> [</span>
<span id="cb56-12"><a href="#cb56-12" tabindex="-1"></a>        c.<span class="bu">id</span>()</span>
<span id="cb56-13"><a href="#cb56-13" tabindex="-1"></a>        <span class="cf">for</span> c <span class="kw">in</span> layer.getFeatures(f.geometry().boundingBox())</span>
<span id="cb56-14"><a href="#cb56-14" tabindex="-1"></a>        <span class="cf">if</span> c.geometry().intersects(f.geometry()) <span class="kw">and</span> c.<span class="bu">id</span>() <span class="op">!=</span> f.<span class="bu">id</span>()</span>
<span id="cb56-15"><a href="#cb56-15" tabindex="-1"></a>    ]</span>
<span id="cb56-16"><a href="#cb56-16" tabindex="-1"></a>    <span class="cf">return</span> neighbors</span>
<span id="cb56-17"><a href="#cb56-17" tabindex="-1"></a></span>
<span id="cb56-18"><a href="#cb56-18" tabindex="-1"></a></span>
<span id="cb56-19"><a href="#cb56-19" tabindex="-1"></a>first_degree_neighbors <span class="op">=</span> get_neighbors(fid)</span>
<span id="cb56-20"><a href="#cb56-20" tabindex="-1"></a></span>
<span id="cb56-21"><a href="#cb56-21" tabindex="-1"></a>second_degree_neighbors <span class="op">=</span> <span class="bu">set</span>()</span>
<span id="cb56-22"><a href="#cb56-22" tabindex="-1"></a></span>
<span id="cb56-23"><a href="#cb56-23" tabindex="-1"></a><span class="cf">for</span> n <span class="kw">in</span> first_degree_neighbors:</span>
<span id="cb56-24"><a href="#cb56-24" tabindex="-1"></a>    neighbors <span class="op">=</span> get_neighbors(n)</span>
<span id="cb56-25"><a href="#cb56-25" tabindex="-1"></a>    second_degree_neighbors.update(neighbors)</span>
<span id="cb56-26"><a href="#cb56-26" tabindex="-1"></a></span>
<span id="cb56-27"><a href="#cb56-27" tabindex="-1"></a><span class="co"># Remove all first-degree neighbors from the set</span></span>
<span id="cb56-28"><a href="#cb56-28" tabindex="-1"></a>second_degree_neighbors <span class="op">=</span> second_degree_neighbors.difference(</span>
<span id="cb56-29"><a href="#cb56-29" tabindex="-1"></a>    <span class="bu">set</span>(first_degree_neighbors))</span>
<span id="cb56-30"><a href="#cb56-30" tabindex="-1"></a>    </span>
<span id="cb56-31"><a href="#cb56-31" tabindex="-1"></a><span class="co"># Remove the feature itself from the set if it exists</span></span>
<span id="cb56-32"><a href="#cb56-32" tabindex="-1"></a>second_degree_neighbors.discard(fid)</span>
<span id="cb56-33"><a href="#cb56-33" tabindex="-1"></a></span>
<span id="cb56-34"><a href="#cb56-34" tabindex="-1"></a><span class="co"># Apply the selection</span></span>
<span id="cb56-35"><a href="#cb56-35" tabindex="-1"></a>layer.selectByIds(<span class="bu">list</span>(second_degree_neighbors))</span></code></pre></div>
<ol start="6" style="list-style-type: decimal">
<li>Locate the <em>Actions</em> button on the <em>Attributes
Toolbar</em>. Trigger the action <em>Select Second-degree Neighbors</em>
and click on any states. You will see all the neighbors of neighbors
selected.</li>
</ol>
<p><img src="images/pyqgis/neighbors6.png" width="75%" style="display: block; margin: auto;" /></p>
</div>
<div id="exercise-11" class="section level2">
<h2>Exercise 11</h2>
<p>If you use the action again, the current selection will go away and a
new selection will be made. We want to change this behavior by adding to
the existing selection. Update the code for the action <em>Select
Second-degree Neighbors</em> so when used, it adds the second-degree
neighbors to already selected features.</p>
<p>Hint: Supply an additional behavior option for the <a
href="https://qgis.org/pyqgis/3.40/core/QgsVectorLayer.html#qgis.core.QgsVectorLayer.selectByIds"><code>QgsVectorLayer.selectByIds()</code></a>
method.</p>
<p><img src="images/pyqgis/neighbors_exercise.png" width="75%" style="display: block; margin: auto;" /></p>
</div>
<div id="learn-more" class="section level2">
<h2>12.3 Learn More</h2>
<p>If you are intrigued by the power of QGIS Actions, check out our
full-length <a
href="https://courses.spatialthoughts.com/qgis-actions.html">QGIS
Actions workshop</a> which cover many more practical examples of
automating tasks in QGIS using Actions.</p>
</div>
</div>
<div id="writing-standalone-python-scripts" class="section level1">
<h1>13. Writing Standalone Python Scripts</h1>
<p>Having the python script run within QGIS is useful and desired most
of the time. But there is a way to write python scripts that run on your
system without QGIS being open. Ability to run PyQGIS scripts in a
headless mode allows you to automate your workflow and run it on a
server without human intervention. Let’s use some QGIS processing
algorithms to carry out zonal statistics using a standalone python
script.</p>
<p><a
href="https://www.youtube.com/watch?v=qLgP_-BAwME&amp;list=PLppGmFLhQ1HKKnk3riKNyOxb-3MTI-7zE&amp;index=38"
target="_blank"><img
src="https://img.youtube.com/vi/qLgP_-BAwME/mqdefault.jpg"
alt="Watch the Video" /></a></p>
<p><a
href="https://www.youtube.com/watch?v=qLgP_-BAwME&amp;list=PLppGmFLhQ1HKKnk3riKNyOxb-3MTI-7zE&amp;index=38"
target="_blank">Watch the Video ↗</a></p>
<p>Create a new file with the code below and save it as
<code>zonal_stats.py</code>.</p>
<div class="sourceCode" id="cb57"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb57-1"><a href="#cb57-1" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb57-2"><a href="#cb57-2" tabindex="-1"></a><span class="im">from</span> qgis.core <span class="im">import</span> QgsApplication</span>
<span id="cb57-3"><a href="#cb57-3" tabindex="-1"></a></span>
<span id="cb57-4"><a href="#cb57-4" tabindex="-1"></a>qgs <span class="op">=</span> QgsApplication([], <span class="va">False</span>)</span>
<span id="cb57-5"><a href="#cb57-5" tabindex="-1"></a>qgs.initQgis()</span>
<span id="cb57-6"><a href="#cb57-6" tabindex="-1"></a></span>
<span id="cb57-7"><a href="#cb57-7" tabindex="-1"></a><span class="im">import</span> processing</span>
<span id="cb57-8"><a href="#cb57-8" tabindex="-1"></a><span class="im">from</span> processing.core.Processing <span class="im">import</span> Processing</span>
<span id="cb57-9"><a href="#cb57-9" tabindex="-1"></a>Processing.initialize()</span>
<span id="cb57-10"><a href="#cb57-10" tabindex="-1"></a></span>
<span id="cb57-11"><a href="#cb57-11" tabindex="-1"></a>data_dir <span class="op">=</span> os.path.join(os.path.expanduser(<span class="st">&#39;~&#39;</span>), <span class="st">&#39;Downloads&#39;</span>, <span class="st">&#39;pyqgis_masterclass&#39;</span>)</span>
<span id="cb57-12"><a href="#cb57-12" tabindex="-1"></a></span>
<span id="cb57-13"><a href="#cb57-13" tabindex="-1"></a>vector_layer <span class="op">=</span> <span class="st">&#39;seismic_zones.shp&#39;</span></span>
<span id="cb57-14"><a href="#cb57-14" tabindex="-1"></a>vector_layer_path <span class="op">=</span> os.path.join(data_dir, vector_layer)</span>
<span id="cb57-15"><a href="#cb57-15" tabindex="-1"></a></span>
<span id="cb57-16"><a href="#cb57-16" tabindex="-1"></a>raster_layer <span class="op">=</span> <span class="st">&#39;srtm.tif&#39;</span></span>
<span id="cb57-17"><a href="#cb57-17" tabindex="-1"></a>raster_layer_path <span class="op">=</span> os.path.join(data_dir, raster_layer)</span>
<span id="cb57-18"><a href="#cb57-18" tabindex="-1"></a></span>
<span id="cb57-19"><a href="#cb57-19" tabindex="-1"></a><span class="co"># Input vector has invalid geometries</span></span>
<span id="cb57-20"><a href="#cb57-20" tabindex="-1"></a><span class="co"># Fix them first</span></span>
<span id="cb57-21"><a href="#cb57-21" tabindex="-1"></a>results <span class="op">=</span> processing.run(<span class="st">&quot;native:fixgeometries&quot;</span>, {</span>
<span id="cb57-22"><a href="#cb57-22" tabindex="-1"></a>  <span class="st">&#39;INPUT&#39;</span>:vector_layer_path,</span>
<span id="cb57-23"><a href="#cb57-23" tabindex="-1"></a>  <span class="st">&#39;METHOD&#39;</span>: <span class="dv">0</span>,</span>
<span id="cb57-24"><a href="#cb57-24" tabindex="-1"></a>  <span class="st">&#39;OUTPUT&#39;</span>:<span class="st">&#39;TEMPORARY_OUTPUT&#39;</span>})</span>
<span id="cb57-25"><a href="#cb57-25" tabindex="-1"></a></span>
<span id="cb57-26"><a href="#cb57-26" tabindex="-1"></a>fixed_vector_layer <span class="op">=</span> results[<span class="st">&#39;OUTPUT&#39;</span>]</span>
<span id="cb57-27"><a href="#cb57-27" tabindex="-1"></a></span>
<span id="cb57-28"><a href="#cb57-28" tabindex="-1"></a><span class="co"># Run Zonal Statistics</span></span>
<span id="cb57-29"><a href="#cb57-29" tabindex="-1"></a></span>
<span id="cb57-30"><a href="#cb57-30" tabindex="-1"></a><span class="co"># Save output to a geopackage</span></span>
<span id="cb57-31"><a href="#cb57-31" tabindex="-1"></a>output_name <span class="op">=</span> <span class="st">&#39;seismic_zones_with_elevation.gpkg&#39;</span></span>
<span id="cb57-32"><a href="#cb57-32" tabindex="-1"></a>output_path <span class="op">=</span> os.path.join(data_dir, output_name)</span>
<span id="cb57-33"><a href="#cb57-33" tabindex="-1"></a></span>
<span id="cb57-34"><a href="#cb57-34" tabindex="-1"></a>processing.run(<span class="st">&quot;native:zonalstatisticsfb&quot;</span>, {</span>
<span id="cb57-35"><a href="#cb57-35" tabindex="-1"></a>  <span class="st">&#39;INPUT&#39;</span>: fixed_vector_layer,</span>
<span id="cb57-36"><a href="#cb57-36" tabindex="-1"></a>  <span class="st">&#39;INPUT_RASTER&#39;</span>: raster_layer_path,</span>
<span id="cb57-37"><a href="#cb57-37" tabindex="-1"></a>  <span class="st">&#39;RASTER_BAND&#39;</span>:<span class="dv">1</span>,</span>
<span id="cb57-38"><a href="#cb57-38" tabindex="-1"></a>  <span class="st">&#39;COLUMN_PREFIX&#39;</span>:<span class="st">&#39;elevation_&#39;</span>,</span>
<span id="cb57-39"><a href="#cb57-39" tabindex="-1"></a>  <span class="st">&#39;STATISTICS&#39;</span>:[<span class="dv">2</span>],</span>
<span id="cb57-40"><a href="#cb57-40" tabindex="-1"></a>  <span class="st">&#39;OUTPUT&#39;</span>:output_path})</span>
<span id="cb57-41"><a href="#cb57-41" tabindex="-1"></a></span>
<span id="cb57-42"><a href="#cb57-42" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&#39;Output Layer Created&#39;</span>, output_path)</span>
<span id="cb57-43"><a href="#cb57-43" tabindex="-1"></a>qgs.exitQgis()</span></code></pre></div>
<p>You will notice that the script has a few notable parts. First there
is the import statement at the top, to explicitly import the required
modules. Next, we create an instance of the <code>QgsApplication</code>
class and run <code>initQis()</code> method to load the QGIS data
providers and layer registry. We also import the <code>Processing</code>
module and initialize it. Finally we call <code>exitQgis()</code> to
remove them from memory. We have hard-coded the path to the input layers
but they can easily be taken as command-line flags using Python’s <a
href="https://docs.python.org/3/library/argparse.html">argparse</a>
module. Also we don’t have the QGIS GUI, we have no way of displaying
the messages, so we remove those statements.</p>
<p>When you run the script within QGIS, all the paths to QGIS libraries
and environment variables are already set and python is able to find and
use it. But when you run the script outside of QGIS, you need to set
them yourself. Also if you are using Processing Algorithms, you need to
make sure the path to core plugin folder is included in the PYTHONPATH
environment variable.</p>
<p>Our recommended environment setup takes care of all the requirements
and allows you to run PyQGIS scripts easily. The next sections describe
this setup and show you how to run the script on various platforms.</p>
<blockquote>
<p>You may need to change these paths slightly based on where QGIS is
installed. The following scripts assume you are running QGIS-LTR
installed at the default location.</p>
</blockquote>
<div id="windows-configuration" class="section level2">
<h2>Windows Configuration</h2>
<p>On Windows, you can do this using a batch file. Create a new file
named <code>run_script.bat</code> with the following code. Make sure to
save it in the same directory.</p>
<div class="sourceCode" id="cb58"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb58-1"><a href="#cb58-1" tabindex="-1"></a><span class="ex">@echo</span> off </span>
<span id="cb58-2"><a href="#cb58-2" tabindex="-1"></a></span>
<span id="cb58-3"><a href="#cb58-3" tabindex="-1"></a><span class="ex">::</span> If you get an error, check that the folder below exists.</span>
<span id="cb58-4"><a href="#cb58-4" tabindex="-1"></a></span>
<span id="cb58-5"><a href="#cb58-5" tabindex="-1"></a><span class="bu">set</span> OSGEO4W_ROOT=C:<span class="dt">\O</span>SGeo4W</span>
<span id="cb58-6"><a href="#cb58-6" tabindex="-1"></a></span>
<span id="cb58-7"><a href="#cb58-7" tabindex="-1"></a><span class="ex">::</span> The following script will set all the required environment variables.</span>
<span id="cb58-8"><a href="#cb58-8" tabindex="-1"></a></span>
<span id="cb58-9"><a href="#cb58-9" tabindex="-1"></a><span class="ex">call</span> <span class="st">&quot;%OSGEO4W_ROOT%\bin\o4w_env.bat&quot;</span> </span>
<span id="cb58-10"><a href="#cb58-10" tabindex="-1"></a></span>
<span id="cb58-11"><a href="#cb58-11" tabindex="-1"></a><span class="ex">::</span> If you are not using QGIS LTR version, change <span class="st">&#39;qgis-ltr&#39;</span> to <span class="st">&#39;qgis&#39;</span> in all lines below</span>
<span id="cb58-12"><a href="#cb58-12" tabindex="-1"></a></span>
<span id="cb58-13"><a href="#cb58-13" tabindex="-1"></a><span class="bu">set</span> PATH=%OSGEO4W_ROOT%<span class="dt">\b</span>in<span class="kw">;</span><span class="ex">%OSGEO4W_ROOT%\apps\qgis-ltr\bin</span><span class="kw">;</span><span class="ex">C:\OSGeo4W64\apps\Qt5\bin</span><span class="kw">;</span><span class="ex">%PATH%</span></span>
<span id="cb58-14"><a href="#cb58-14" tabindex="-1"></a><span class="bu">set</span> PYTHONPATH=%OSGEO4W_ROOT%<span class="dt">\a</span>pps<span class="dt">\q</span>gis-ltr<span class="dt">\p</span>ython<span class="kw">;</span><span class="ex">%OSGEO4W_ROOT%\apps\qgis-ltr\python\plugins</span><span class="kw">;</span><span class="ex">%PYTHONPATH%</span></span>
<span id="cb58-15"><a href="#cb58-15" tabindex="-1"></a><span class="bu">set</span> QGIS_PREFIX_PATH=%OSGEO4W_ROOT%<span class="dt">\a</span>pps<span class="dt">\q</span>gis-ltr</span>
<span id="cb58-16"><a href="#cb58-16" tabindex="-1"></a><span class="bu">set</span> QT_QPA_PLATFORM_PLUGIN_PATH=%OSGEO4W_ROOT%<span class="dt">\a</span>pps<span class="dt">\Q</span>t5<span class="dt">\p</span>lugins</span>
<span id="cb58-17"><a href="#cb58-17" tabindex="-1"></a></span>
<span id="cb58-18"><a href="#cb58-18" tabindex="-1"></a><span class="ex">::</span> Verify that the correct python3 binary is being used</span>
<span id="cb58-19"><a href="#cb58-19" tabindex="-1"></a></span>
<span id="cb58-20"><a href="#cb58-20" tabindex="-1"></a><span class="cf">for</span> <span class="ex">/f</span> %%i in <span class="er">(</span><span class="st">&#39;where python3&#39;</span><span class="kw">)</span> <span class="cf">do</span> <span class="bu">set</span> current_python=%%i</span>
<span id="cb58-21"><a href="#cb58-21" tabindex="-1"></a><span class="bu">echo</span> Using python3 from %current_python%</span>
<span id="cb58-22"><a href="#cb58-22" tabindex="-1"></a></span>
<span id="cb58-23"><a href="#cb58-23" tabindex="-1"></a><span class="ex">::</span> Finally run the script</span>
<span id="cb58-24"><a href="#cb58-24" tabindex="-1"></a><span class="ex">python3</span> zonal_stats.py</span></code></pre></div>
<p>Open the command prompt, browse to the directory with the above
files, type <code>run_script.bat</code> and press Enter.</p>
<blockquote>
<p>You can also just double-click the <code>run_script.bat</code> to run
it, but you will not see any error or success messages. So it is always
a good idea to run the script from the shell.</p>
</blockquote>
<p>The script will run and produce the output at the given path.</p>
<p><img src="images/pyqgis/cmd-zonal-stats.png" width="75%" style="display: block; margin: auto;" /></p>
<p>The resulting vector layer has an additional column containing the
statistics from the raster.</p>
<p><img src="images/pyqgis/qgis-zonal-stats.png" width="75%" style="display: block; margin: auto;" /></p>
</div>
<div id="macos-configuration" class="section level2">
<h2>MacOS Configuration</h2>
<p>On MacOS, you can set the required environment variables and run the
script using a shell script. Create a file named
<code>run_script.sh</code> and save it in the same directory as the
script.</p>
<div class="sourceCode" id="cb59"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb59-1"><a href="#cb59-1" tabindex="-1"></a>OLD_PATH<span class="op">=</span>$PATH</span>
<span id="cb59-2"><a href="#cb59-2" tabindex="-1"></a>OLD_PYTHONPATH<span class="op">=</span>$PYTHONPATH</span>
<span id="cb59-3"><a href="#cb59-3" tabindex="-1"></a></span>
<span id="cb59-4"><a href="#cb59-4" tabindex="-1"></a>QGIS_VERSION<span class="op">=</span><span class="st">&quot;QGIS-LTR&quot;</span></span>
<span id="cb59-5"><a href="#cb59-5" tabindex="-1"></a></span>
<span id="cb59-6"><a href="#cb59-6" tabindex="-1"></a>export PATH<span class="op">=/</span>Applications<span class="op">/</span>$QGIS_VERSION.app<span class="op">/</span>Contents<span class="op">/</span>MacOS<span class="op">/</span><span class="bu">bin</span>:$PATH</span>
<span id="cb59-7"><a href="#cb59-7" tabindex="-1"></a>export PYTHONPATH<span class="op">=/</span>Applications<span class="op">/</span>$QGIS_VERSION.app<span class="op">/</span>Contents<span class="op">/</span>Resources<span class="op">/</span>python<span class="op">/</span>:<span class="op">/</span>Applications<span class="op">/</span>$QGIS_VERSION.app<span class="op">/</span>Contents<span class="op">/</span>Resources<span class="op">/</span>python<span class="op">/</span>plugins</span>
<span id="cb59-8"><a href="#cb59-8" tabindex="-1"></a>export QGIS_PREFIX_PATH<span class="op">=/</span>Applications<span class="op">/</span>$QGIS_VERSION.app<span class="op">/</span>Contents<span class="op">/</span>MacOS</span>
<span id="cb59-9"><a href="#cb59-9" tabindex="-1"></a>export QT_QPA_PLATFORM_PLUGIN_PATH<span class="op">=/</span>Applications<span class="op">/</span>$QGIS_VERSION.app<span class="op">/</span>Contents<span class="op">/</span>PlugIns<span class="op">/</span>platforms<span class="op">/</span></span>
<span id="cb59-10"><a href="#cb59-10" tabindex="-1"></a>export DYLD_INSERT_LIBRARIES<span class="op">=/</span>Applications<span class="op">/</span>$QGIS_VERSION.app<span class="op">/</span>Contents<span class="op">/</span>MacOS<span class="op">/</span>lib<span class="op">/</span>libsqlite3.dylib</span>
<span id="cb59-11"><a href="#cb59-11" tabindex="-1"></a>echo <span class="st">&quot;Using python3 from $(which python3)&quot;</span></span>
<span id="cb59-12"><a href="#cb59-12" tabindex="-1"></a></span>
<span id="cb59-13"><a href="#cb59-13" tabindex="-1"></a>python3 zonal_stats.py</span>
<span id="cb59-14"><a href="#cb59-14" tabindex="-1"></a></span>
<span id="cb59-15"><a href="#cb59-15" tabindex="-1"></a><span class="co"># restore and clean up</span></span>
<span id="cb59-16"><a href="#cb59-16" tabindex="-1"></a>export PATH<span class="op">=</span>$OLD_PATH</span>
<span id="cb59-17"><a href="#cb59-17" tabindex="-1"></a>export PYTHONPATH<span class="op">=</span>$OLD_PYTHONPATH</span>
<span id="cb59-18"><a href="#cb59-18" tabindex="-1"></a>unset QT_QPA_PLATFORM_PLUGIN_PATH</span>
<span id="cb59-19"><a href="#cb59-19" tabindex="-1"></a>unset DYLD_INSERT_LIBRARIES</span></code></pre></div>
<p>Open a Terminal and browse to the directory with the script. Type
<code>bash run_script.sh</code> and press enter. The script will run and
produce the output at the given path.</p>
</div>
<div id="linuxconda-configuration" class="section level2">
<h2>Linux/Conda Configuration</h2>
<p>The easiest and preferred way to run a standalone PyQGIS script is
from a conda environment. This requires minimal configuration and setup.
You can follow our guide to <a
href="install-qgis-ltr.html#install-qgis-via-conda">Install QGIS via
Conda</a>.</p>
<blockquote>
<p>Note that conda packages are available on all platforms, so it can be
used on MacOS or Windows as well.</p>
</blockquote>
<p>Once installed, activate the environment and run the script as
follows.</p>
<pre><code>python3 zonal_stats.py</code></pre>
</div>
</div>
<div id="integration-with-python-development-environments"
class="section level1">
<h1>14. Integration with Python Development Environments</h1>
<div id="using-pyqgis-api-in-a-jupyter-notebook" class="section level2">
<h2>Using PyQGIS API in a Jupyter Notebook</h2>
<p>View <a
href="https://github.com/spatialthoughts/courses/blob/master/code/pyqgis/notebook.ipynb">notebook.ipynb</a></p>
<p><img src="images/pyqgis/notebook.png" width="75%" style="display: block; margin: auto;" /></p>
<p>This notebook shows how to use the PyQGIS API from a Jupyter
Notebook.</p>
<p>For the best experience, this notebook should be run from a Conda
environment with QGIS installed. See our guide to <a
href="https://courses.spatialthoughts.com/install-qgis-ltr.html#install-qgis-via-conda">Install
QGIS via Conda</a>. Once installed, you can launch Jupyter Lab from the
environment and can use the PyQGIS API after the following
initialization steps.</p>
<p>If you want to run this in another Python environment, you need to
ensure the environment variables are correctly configured before
starting the Jupyter Notebook. See the <a
href="https://courses.spatialthoughts.com/pyqgis-masterclass.html#windows-configuration">Windows</a>
and <a
href="https://courses.spatialthoughts.com/pyqgis-masterclass.html#macos-configuration">MacOS</a>
and <a
href="https://courses.spatialthoughts.com/pyqgis-masterclass.html#linuxconda-configuration">Linux</a>
configuration instructions.</p>
<div id="initialize-qgis" class="section level3">
<h3>Initialize QGIS</h3>
<div class="sourceCode" id="cb61"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb61-1"><a href="#cb61-1" tabindex="-1"></a><span class="im">from</span> qgis.core <span class="im">import</span> QgsApplication</span>
<span id="cb61-2"><a href="#cb61-2" tabindex="-1"></a></span>
<span id="cb61-3"><a href="#cb61-3" tabindex="-1"></a>qgs <span class="op">=</span> QgsApplication([], <span class="va">False</span>)</span>
<span id="cb61-4"><a href="#cb61-4" tabindex="-1"></a>qgs.initQgis()</span>
<span id="cb61-5"><a href="#cb61-5" tabindex="-1"></a></span>
<span id="cb61-6"><a href="#cb61-6" tabindex="-1"></a><span class="im">import</span> processing</span>
<span id="cb61-7"><a href="#cb61-7" tabindex="-1"></a><span class="im">from</span> processing.core.Processing <span class="im">import</span> Processing</span>
<span id="cb61-8"><a href="#cb61-8" tabindex="-1"></a>Processing.initialize()</span></code></pre></div>
</div>
<div id="use-pyqgis-api" class="section level3">
<h3>Use PyQGIS API</h3>
<p>Once the initialization is done, you can use all PyQGIS classes and
methods.</p>
<div class="sourceCode" id="cb62"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb62-1"><a href="#cb62-1" tabindex="-1"></a><span class="im">from</span> qgis.core <span class="im">import</span> QgsDistanceArea, QgsPointXY</span>
<span id="cb62-2"><a href="#cb62-2" tabindex="-1"></a></span>
<span id="cb62-3"><a href="#cb62-3" tabindex="-1"></a>san_francisco <span class="op">=</span> (<span class="fl">37.7749</span>, <span class="op">-</span><span class="fl">122.4194</span>)</span>
<span id="cb62-4"><a href="#cb62-4" tabindex="-1"></a>new_york <span class="op">=</span> (<span class="fl">40.661</span>, <span class="op">-</span><span class="fl">73.944</span>)</span>
<span id="cb62-5"><a href="#cb62-5" tabindex="-1"></a></span>
<span id="cb62-6"><a href="#cb62-6" tabindex="-1"></a>d <span class="op">=</span> QgsDistanceArea()</span>
<span id="cb62-7"><a href="#cb62-7" tabindex="-1"></a>d.setEllipsoid(<span class="st">&#39;WGS84&#39;</span>)</span>
<span id="cb62-8"><a href="#cb62-8" tabindex="-1"></a></span>
<span id="cb62-9"><a href="#cb62-9" tabindex="-1"></a></span>
<span id="cb62-10"><a href="#cb62-10" tabindex="-1"></a>lat1, lon1 <span class="op">=</span> san_francisco</span>
<span id="cb62-11"><a href="#cb62-11" tabindex="-1"></a>lat2, lon2 <span class="op">=</span> new_york</span>
<span id="cb62-12"><a href="#cb62-12" tabindex="-1"></a>point1 <span class="op">=</span> QgsPointXY(lon1, lat1)</span>
<span id="cb62-13"><a href="#cb62-13" tabindex="-1"></a>point2 <span class="op">=</span> QgsPointXY(lon2, lat2)</span>
<span id="cb62-14"><a href="#cb62-14" tabindex="-1"></a></span>
<span id="cb62-15"><a href="#cb62-15" tabindex="-1"></a>distance <span class="op">=</span> d.measureLine([point1, point2])</span>
<span id="cb62-16"><a href="#cb62-16" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&#39;Ellipsoid Distance&#39;</span>, distance<span class="op">/</span><span class="dv">1000</span>)</span></code></pre></div>
<pre><code>Ellipsoid Distance 4145.446977549562</code></pre>
</div>
<div id="exit-qgis" class="section level3">
<h3>Exit QGIS</h3>
<div class="sourceCode" id="cb64"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb64-1"><a href="#cb64-1" tabindex="-1"></a>qgs.exitQgis()</span></code></pre></div>
</div>
</div>
<div id="using-pyqgis-api-in-vs-code" class="section level2">
<h2>Using PyQGIS API in VS Code</h2>
<p>The easiest way to setup Visual Studio Code for PyQGIS development is
to launch the code editor from a conda environment with the required
packages installed. See our guide to <a
href="https://courses.spatialthoughts.com/install-qgis-ltr.html#install-qgis-via-conda">Install
QGIS via Conda</a>. Once installed, you can launch VS Code from the
environment and start using the PyQGIS API. Code completion works
out-of-the-box without any additional configuration. Alexandre Neto, who
is a co-maintainer of the QGIS conda packages, also has a good guide to
<a
href="https://aneto.pt/posts/tutorials/2024-05-11-create-easy-pyqgis-developement-environment-using-conda-and-vscode/">Create
a PyQGIS Development Environment Using Conda and VScode</a>.</p>
<ol style="list-style-type: decimal">
<li>Activate the conda environment where you have installed QGIS. Launch
Visual Studio Code from the conda environment by typing
<code>code</code>. You may have to <a
href="https://code.visualstudio.com/docs/setup/mac#_launch-vs-code-from-the-command-line">configure
the code command</a> for your shell.</li>
</ol>
<pre><code>conda activate qgis_ltr
code</code></pre>
<p><img src="images/pyqgis/vscode1.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="2" style="list-style-type: decimal">
<li>In Visual Studio Code, you can now import and use all PyQGIS
Classes. Since we are using PyQGIS classes outside of a running QGIS
instance, you need to add a few lines of initialization in the scripts
and remember to exit QGIS at the end. The following code snippet
demonstrates the required setup.</li>
</ol>
<div class="sourceCode" id="cb66"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb66-1"><a href="#cb66-1" tabindex="-1"></a><span class="co"># Initialize QGIS</span></span>
<span id="cb66-2"><a href="#cb66-2" tabindex="-1"></a><span class="im">from</span> qgis.core <span class="im">import</span> QgsApplication</span>
<span id="cb66-3"><a href="#cb66-3" tabindex="-1"></a></span>
<span id="cb66-4"><a href="#cb66-4" tabindex="-1"></a>qgs <span class="op">=</span> QgsApplication([], <span class="va">False</span>)</span>
<span id="cb66-5"><a href="#cb66-5" tabindex="-1"></a>qgs.initQgis()</span>
<span id="cb66-6"><a href="#cb66-6" tabindex="-1"></a></span>
<span id="cb66-7"><a href="#cb66-7" tabindex="-1"></a><span class="im">import</span> processing</span>
<span id="cb66-8"><a href="#cb66-8" tabindex="-1"></a><span class="im">from</span> processing.core.Processing <span class="im">import</span> Processing</span>
<span id="cb66-9"><a href="#cb66-9" tabindex="-1"></a>Processing.initialize()</span>
<span id="cb66-10"><a href="#cb66-10" tabindex="-1"></a></span>
<span id="cb66-11"><a href="#cb66-11" tabindex="-1"></a><span class="co"># Use PyQGIS APIs</span></span>
<span id="cb66-12"><a href="#cb66-12" tabindex="-1"></a><span class="im">from</span> qgis.core <span class="im">import</span> QgsDistanceArea, QgsPointXY</span>
<span id="cb66-13"><a href="#cb66-13" tabindex="-1"></a></span>
<span id="cb66-14"><a href="#cb66-14" tabindex="-1"></a>san_francisco <span class="op">=</span> (<span class="fl">37.7749</span>, <span class="op">-</span><span class="fl">122.4194</span>)</span>
<span id="cb66-15"><a href="#cb66-15" tabindex="-1"></a>new_york <span class="op">=</span> (<span class="fl">40.661</span>, <span class="op">-</span><span class="fl">73.944</span>)</span>
<span id="cb66-16"><a href="#cb66-16" tabindex="-1"></a></span>
<span id="cb66-17"><a href="#cb66-17" tabindex="-1"></a>d <span class="op">=</span> QgsDistanceArea()</span>
<span id="cb66-18"><a href="#cb66-18" tabindex="-1"></a>d.setEllipsoid(<span class="st">&#39;WGS84&#39;</span>)</span>
<span id="cb66-19"><a href="#cb66-19" tabindex="-1"></a></span>
<span id="cb66-20"><a href="#cb66-20" tabindex="-1"></a></span>
<span id="cb66-21"><a href="#cb66-21" tabindex="-1"></a>lat1, lon1 <span class="op">=</span> san_francisco</span>
<span id="cb66-22"><a href="#cb66-22" tabindex="-1"></a>lat2, lon2 <span class="op">=</span> new_york</span>
<span id="cb66-23"><a href="#cb66-23" tabindex="-1"></a>point1 <span class="op">=</span> QgsPointXY(lon1, lat1)</span>
<span id="cb66-24"><a href="#cb66-24" tabindex="-1"></a>point2 <span class="op">=</span> QgsPointXY(lon2, lat2)</span>
<span id="cb66-25"><a href="#cb66-25" tabindex="-1"></a></span>
<span id="cb66-26"><a href="#cb66-26" tabindex="-1"></a>distance <span class="op">=</span> d.measureLine([point1, point2])</span>
<span id="cb66-27"><a href="#cb66-27" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&#39;Ellipsoid Distance&#39;</span>, distance<span class="op">/</span><span class="dv">1000</span>)</span>
<span id="cb66-28"><a href="#cb66-28" tabindex="-1"></a></span>
<span id="cb66-29"><a href="#cb66-29" tabindex="-1"></a><span class="co"># Exit QGIS</span></span>
<span id="cb66-30"><a href="#cb66-30" tabindex="-1"></a>qgs.exitQgis()</span></code></pre></div>
<p><img src="images/pyqgis/vscode2.png" width="75%" style="display: block; margin: auto;" /></p>
</div>
</div>
<div id="supplement" class="section level1">
<h1>Supplement</h1>
<p>This section contains code snippets for common PyQGIS operations.</p>
<p>All code snipets assume you have loaded the <code>sf.qgz</code>
project. You can load the project using the code below.</p>
<div class="sourceCode" id="cb67"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb67-1"><a href="#cb67-1" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb67-2"><a href="#cb67-2" tabindex="-1"></a>data_dir <span class="op">=</span> os.path.join(os.path.expanduser(<span class="st">&#39;~&#39;</span>), <span class="st">&#39;Downloads&#39;</span>, <span class="st">&#39;pyqgis_masterclass&#39;</span>)</span>
<span id="cb67-3"><a href="#cb67-3" tabindex="-1"></a>project <span class="op">=</span> QgsProject.instance()</span>
<span id="cb67-4"><a href="#cb67-4" tabindex="-1"></a>project_name <span class="op">=</span> <span class="st">&#39;sf.qgz&#39;</span></span>
<span id="cb67-5"><a href="#cb67-5" tabindex="-1"></a>project_path <span class="op">=</span> os.path.join(data_dir, project_name)</span>
<span id="cb67-6"><a href="#cb67-6" tabindex="-1"></a>project.read(project_path)</span></code></pre></div>
<div id="save-map-rendering-as-an-image" class="section level2">
<h2>Save Map Rendering as an Image</h2>
<p><code>saveAsImage()</code> method is quick and easy, but you do not
have much control over the resulting image. You can’t control the
resolution, size or how each layer will be rendered. There is another
way to achieve this. You can look at the code for exporting map as an
image in QGIS and you will discover 2 classes
<code>QgsMapRendererParallelJob</code> and
<code>QgsMapRendererSequentialJob</code> that lets you achieve a better
result. The code snippet below exports a hi-resolution image of the
project.</p>
<div class="sourceCode" id="cb68"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb68-1"><a href="#cb68-1" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb68-2"><a href="#cb68-2" tabindex="-1"></a>data_dir <span class="op">=</span> os.path.join(os.path.expanduser(<span class="st">&#39;~&#39;</span>), <span class="st">&#39;Downloads&#39;</span>, <span class="st">&#39;pyqgis_masterclass&#39;</span>)</span>
<span id="cb68-3"><a href="#cb68-3" tabindex="-1"></a>image_name <span class="op">=</span> <span class="st">&#39;sf_hires.png&#39;</span></span>
<span id="cb68-4"><a href="#cb68-4" tabindex="-1"></a>image_path <span class="op">=</span> os.path.join(data_dir, image_name)</span>
<span id="cb68-5"><a href="#cb68-5" tabindex="-1"></a></span>
<span id="cb68-6"><a href="#cb68-6" tabindex="-1"></a>settings <span class="op">=</span> iface.mapCanvas().mapSettings()</span>
<span id="cb68-7"><a href="#cb68-7" tabindex="-1"></a>settings.setOutputSize(QSize(<span class="dv">1000</span>,<span class="dv">1000</span>))</span>
<span id="cb68-8"><a href="#cb68-8" tabindex="-1"></a></span>
<span id="cb68-9"><a href="#cb68-9" tabindex="-1"></a>settings.setFlag(QgsMapSettings.DrawLabeling, <span class="va">False</span>)</span>
<span id="cb68-10"><a href="#cb68-10" tabindex="-1"></a>settings.setFlag(QgsMapSettings.Antialiasing, <span class="va">True</span>)</span>
<span id="cb68-11"><a href="#cb68-11" tabindex="-1"></a></span>
<span id="cb68-12"><a href="#cb68-12" tabindex="-1"></a>job <span class="op">=</span> QgsMapRendererSequentialJob(settings)</span>
<span id="cb68-13"><a href="#cb68-13" tabindex="-1"></a>job.start()</span>
<span id="cb68-14"><a href="#cb68-14" tabindex="-1"></a>job.waitForFinished()</span>
<span id="cb68-15"><a href="#cb68-15" tabindex="-1"></a>image <span class="op">=</span> job.renderedImage()</span>
<span id="cb68-16"><a href="#cb68-16" tabindex="-1"></a>image.save(image_path)</span></code></pre></div>
<p><img src="images/pyqgis/sf_hires.png" width="75%" style="display: block; margin: auto;" /></p>
</div>
<div id="search-for-a-layer" class="section level2">
<h2>Search for a layer</h2>
<div class="sourceCode" id="cb69"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb69-1"><a href="#cb69-1" tabindex="-1"></a>blocks <span class="op">=</span> QgsProject.instance().mapLayersByName(<span class="st">&#39;blocks&#39;</span>)[<span class="dv">0</span>]</span></code></pre></div>
</div>
<div id="turn-a-layer-onoff" class="section level2">
<h2>Turn a layer on/off</h2>
<div class="sourceCode" id="cb70"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb70-1"><a href="#cb70-1" tabindex="-1"></a>blocks <span class="op">=</span> QgsProject.instance().mapLayersByName(<span class="st">&#39;blocks&#39;</span>)[<span class="dv">0</span>]</span>
<span id="cb70-2"><a href="#cb70-2" tabindex="-1"></a>QgsProject.instance().layerTreeRoot().findLayer(blocks.<span class="bu">id</span>()).setItemVisibilityChecked(<span class="va">True</span>)</span></code></pre></div>
</div>
<div id="get-all-layers" class="section level2">
<h2>Get all Layers</h2>
<div class="sourceCode" id="cb71"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb71-1"><a href="#cb71-1" tabindex="-1"></a><span class="cf">for</span> layer <span class="kw">in</span> QgsProject.instance().mapLayers().values():</span>
<span id="cb71-2"><a href="#cb71-2" tabindex="-1"></a>    <span class="bu">print</span>(layer.name())</span></code></pre></div>
</div>
<div id="get-only-checked-visible-layers" class="section level2">
<h2>Get only checked (visible) Layers</h2>
<div class="sourceCode" id="cb72"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb72-1"><a href="#cb72-1" tabindex="-1"></a><span class="cf">for</span> layer <span class="kw">in</span> iface.mapCanvas().layers():</span>
<span id="cb72-2"><a href="#cb72-2" tabindex="-1"></a>    <span class="bu">print</span>(layer.name())</span></code></pre></div>
</div>
<div id="get-only-selected-layers" class="section level2">
<h2>Get only selected Layers</h2>
<div class="sourceCode" id="cb73"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb73-1"><a href="#cb73-1" tabindex="-1"></a><span class="cf">for</span> layer <span class="kw">in</span> iface.layerTreeView().selectedLayers():</span>
<span id="cb73-2"><a href="#cb73-2" tabindex="-1"></a>  <span class="bu">print</span>(layer.name())</span></code></pre></div>
</div>
<div id="set-canvas-extent-to-a-layer-extent" class="section level2">
<h2>Set Canvas Extent to a Layer Extent</h2>
<p>Select one of the layers in the <em>Layers</em> panel and run the
following code.</p>
<div class="sourceCode" id="cb74"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb74-1"><a href="#cb74-1" tabindex="-1"></a>layer <span class="op">=</span> iface.activeLayer()</span>
<span id="cb74-2"><a href="#cb74-2" tabindex="-1"></a>mc <span class="op">=</span> iface.mapCanvas()</span>
<span id="cb74-3"><a href="#cb74-3" tabindex="-1"></a>mc.setExtent(layer.extent())</span>
<span id="cb74-4"><a href="#cb74-4" tabindex="-1"></a>mc.refresh()</span></code></pre></div>
</div>
<div id="get-layers-with-hierarchy" class="section level2">
<h2>Get Layers with Hierarchy</h2>
<p>This code snippet is taken from the <a
href="https://docs.qgis.org/testing/en/docs/pyqgis_developer_cookbook/cheat_sheet.html">Cheat
Sheet for PyQGIS</a> , but contains an important modification. If you
notice carefully, the function <code>getGroupLayers</code> is called
recursively from within <code>getGroupLayers</code>. This allows one to
even get layers that have sub-groups within layer groups.</p>
<div class="sourceCode" id="cb75"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb75-1"><a href="#cb75-1" tabindex="-1"></a><span class="kw">def</span> getGroupLayers(group):</span>
<span id="cb75-2"><a href="#cb75-2" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&#39;- group:&#39;</span> <span class="op">+</span> group.name())</span>
<span id="cb75-3"><a href="#cb75-3" tabindex="-1"></a>    <span class="cf">for</span> child <span class="kw">in</span> group.children():</span>
<span id="cb75-4"><a href="#cb75-4" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">isinstance</span>(child, QgsLayerTreeGroup):</span>
<span id="cb75-5"><a href="#cb75-5" tabindex="-1"></a>            getGroupLayers(child)</span>
<span id="cb75-6"><a href="#cb75-6" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb75-7"><a href="#cb75-7" tabindex="-1"></a>            <span class="bu">print</span>(<span class="st">&#39;  - layer:&#39;</span> <span class="op">+</span> child.name())</span>
<span id="cb75-8"><a href="#cb75-8" tabindex="-1"></a></span>
<span id="cb75-9"><a href="#cb75-9" tabindex="-1"></a></span>
<span id="cb75-10"><a href="#cb75-10" tabindex="-1"></a>root <span class="op">=</span> QgsProject.instance().layerTreeRoot()</span>
<span id="cb75-11"><a href="#cb75-11" tabindex="-1"></a><span class="cf">for</span> child <span class="kw">in</span> root.children():</span>
<span id="cb75-12"><a href="#cb75-12" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">isinstance</span>(child, QgsLayerTreeGroup):</span>
<span id="cb75-13"><a href="#cb75-13" tabindex="-1"></a>        getGroupLayers(child)</span>
<span id="cb75-14"><a href="#cb75-14" tabindex="-1"></a>    <span class="cf">elif</span> <span class="bu">isinstance</span>(child, QgsLayerTreeLayer):</span>
<span id="cb75-15"><a href="#cb75-15" tabindex="-1"></a>        <span class="bu">print</span> (<span class="st">&quot;- layer: &quot;</span> <span class="op">+</span> child.name())</span></code></pre></div>
<p><img src="images/pyqgis/layergroup.png" width="50%" style="display: block; margin: auto;" /></p>
</div>
<div id="change-icon-of-qgis-main-window" class="section level2">
<h2>Change Icon of QGIS Main Window</h2>
<div class="sourceCode" id="cb76"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb76-1"><a href="#cb76-1" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb76-2"><a href="#cb76-2" tabindex="-1"></a></span>
<span id="cb76-3"><a href="#cb76-3" tabindex="-1"></a>icon_image <span class="op">=</span> <span class="st">&#39;qgis-black.png&#39;</span></span>
<span id="cb76-4"><a href="#cb76-4" tabindex="-1"></a>data_dir <span class="op">=</span> os.path.join(os.path.expanduser(<span class="st">&#39;~&#39;</span>), <span class="st">&#39;Downloads&#39;</span>, <span class="st">&#39;pyqgis_masterclass&#39;</span>)</span>
<span id="cb76-5"><a href="#cb76-5" tabindex="-1"></a>icon_path <span class="op">=</span> os.path.join(data_dir, icon_image)</span>
<span id="cb76-6"><a href="#cb76-6" tabindex="-1"></a>icon <span class="op">=</span> QIcon(icon_path)</span>
<span id="cb76-7"><a href="#cb76-7" tabindex="-1"></a>iface.mainWindow().setWindowIcon(icon)</span></code></pre></div>
<p><img src="images/pyqgis/mainwindow2.png" width="50%" style="display: block; margin: auto;" /></p>
</div>
<div id="remove-a-specific-button-from-a-toolbar"
class="section level2">
<h2>Remove a Specific Button from a Toolbar</h2>
<p>The following code snippet shows how once can find names of different
widget in the QGIS Application and locate specific toolbars and buttons.
The following code will disable to <em>Deselect All Features from
Layers</em> button from the <em>Selection Toolbar</em>.</p>
<div class="sourceCode" id="cb77"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb77-1"><a href="#cb77-1" tabindex="-1"></a><span class="co"># Find all child objects of the mainWindow that are type QToolbar</span></span>
<span id="cb77-2"><a href="#cb77-2" tabindex="-1"></a><span class="cf">for</span> x <span class="kw">in</span> iface.mainWindow().findChildren(QToolBar): </span>
<span id="cb77-3"><a href="#cb77-3" tabindex="-1"></a>    <span class="bu">print</span>(x.objectName())</span>
<span id="cb77-4"><a href="#cb77-4" tabindex="-1"></a>    </span>
<span id="cb77-5"><a href="#cb77-5" tabindex="-1"></a><span class="co"># In the printed list, we observe that </span></span>
<span id="cb77-6"><a href="#cb77-6" tabindex="-1"></a><span class="co"># the selection toolbar is named mSelectionToolBar</span></span>
<span id="cb77-7"><a href="#cb77-7" tabindex="-1"></a><span class="co"># Get a reference to it by name</span></span>
<span id="cb77-8"><a href="#cb77-8" tabindex="-1"></a>selectionToolbar <span class="op">=</span> iface.mainWindow().findChild(QToolBar,<span class="st">&#39;mSelectionToolBar&#39;</span>)</span>
<span id="cb77-9"><a href="#cb77-9" tabindex="-1"></a></span>
<span id="cb77-10"><a href="#cb77-10" tabindex="-1"></a><span class="co"># Find the buttons on the toolbar</span></span>
<span id="cb77-11"><a href="#cb77-11" tabindex="-1"></a><span class="cf">for</span> x <span class="kw">in</span> selectionToolbar.findChildren(QAction):</span>
<span id="cb77-12"><a href="#cb77-12" tabindex="-1"></a>    <span class="bu">print</span>(x.objectName())</span>
<span id="cb77-13"><a href="#cb77-13" tabindex="-1"></a></span>
<span id="cb77-14"><a href="#cb77-14" tabindex="-1"></a><span class="co"># Alternatively, you can also use the following</span></span>
<span id="cb77-15"><a href="#cb77-15" tabindex="-1"></a><span class="cf">for</span> x <span class="kw">in</span> selectionToolbar.actions():</span>
<span id="cb77-16"><a href="#cb77-16" tabindex="-1"></a>    <span class="bu">print</span>(x.objectName())</span>
<span id="cb77-17"><a href="#cb77-17" tabindex="-1"></a></span>
<span id="cb77-18"><a href="#cb77-18" tabindex="-1"></a><span class="co"># If the toolbar button is not an action, you</span></span>
<span id="cb77-19"><a href="#cb77-19" tabindex="-1"></a><span class="co"># We know the name of the deselection button </span></span>
<span id="cb77-20"><a href="#cb77-20" tabindex="-1"></a><span class="co"># Get a reference to it by name</span></span>
<span id="cb77-21"><a href="#cb77-21" tabindex="-1"></a>deselection <span class="op">=</span> selectionToolbar.findChild(QAction,<span class="st">&#39;ActionDeselection&#39;</span>)</span>
<span id="cb77-22"><a href="#cb77-22" tabindex="-1"></a></span>
<span id="cb77-23"><a href="#cb77-23" tabindex="-1"></a><span class="co"># We can disable a widget by calling setEnabled(False)</span></span>
<span id="cb77-24"><a href="#cb77-24" tabindex="-1"></a>deselection.setEnabled(<span class="va">False</span>)</span>
<span id="cb77-25"><a href="#cb77-25" tabindex="-1"></a></span>
<span id="cb77-26"><a href="#cb77-26" tabindex="-1"></a><span class="co"># We can remove it completely by calling removeAction()</span></span>
<span id="cb77-27"><a href="#cb77-27" tabindex="-1"></a>selectionToolbar.removeAction(deselection)</span></code></pre></div>
</div>
<div id="add-a-drop-down-menu-to-toolbar" class="section level2">
<h2>Add a Drop-down Menu to Toolbar</h2>
<p>This example shows how to add a <code>QCombobox</code> widget to a
toolbar and populate it with attribute values from a layer. On click of
the button, the selection is read from the combo box and used to apply a
filter to the layer</p>
<blockquote>
<p>You must have a layer with an attribute called <strong>NAME</strong>
for this example to work. Tested with the <a
href="https://www.naturalearthdata.com/downloads/10m-cultural-vectors/">Natural
Earth Admin 0 - Countries</a> layer.</p>
</blockquote>
<div class="sourceCode" id="cb78"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb78-1"><a href="#cb78-1" tabindex="-1"></a>toolBar <span class="op">=</span> iface.addToolBar(<span class="st">&quot;My Toolbar&quot;</span>)</span>
<span id="cb78-2"><a href="#cb78-2" tabindex="-1"></a>toolBar.setObjectName(<span class="st">&quot;My Toolbar&quot;</span>)</span>
<span id="cb78-3"><a href="#cb78-3" tabindex="-1"></a></span>
<span id="cb78-4"><a href="#cb78-4" tabindex="-1"></a>countryCombo <span class="op">=</span> QComboBox(toolBar)</span>
<span id="cb78-5"><a href="#cb78-5" tabindex="-1"></a>toolBar.addWidget(countryCombo)</span>
<span id="cb78-6"><a href="#cb78-6" tabindex="-1"></a>countryCombo.setToolTip(<span class="st">&quot;Select a country&quot;</span>)</span>
<span id="cb78-7"><a href="#cb78-7" tabindex="-1"></a></span>
<span id="cb78-8"><a href="#cb78-8" tabindex="-1"></a></span>
<span id="cb78-9"><a href="#cb78-9" tabindex="-1"></a>filterButton <span class="op">=</span> QPushButton(<span class="st">&#39;Filter&#39;</span>)</span>
<span id="cb78-10"><a href="#cb78-10" tabindex="-1"></a>filterButton.setToolTip(<span class="st">&#39;Filter&#39;</span>)</span>
<span id="cb78-11"><a href="#cb78-11" tabindex="-1"></a>toolBar.addWidget(filterButton)</span>
<span id="cb78-12"><a href="#cb78-12" tabindex="-1"></a></span>
<span id="cb78-13"><a href="#cb78-13" tabindex="-1"></a>resetButton <span class="op">=</span> QPushButton(<span class="st">&#39;Reset&#39;</span>)</span>
<span id="cb78-14"><a href="#cb78-14" tabindex="-1"></a>resetButton.setToolTip(<span class="st">&#39;Reset&#39;</span>)</span>
<span id="cb78-15"><a href="#cb78-15" tabindex="-1"></a>toolBar.addWidget(resetButton)</span>
<span id="cb78-16"><a href="#cb78-16" tabindex="-1"></a></span>
<span id="cb78-17"><a href="#cb78-17" tabindex="-1"></a><span class="co"># We want to sort the layer by country names</span></span>
<span id="cb78-18"><a href="#cb78-18" tabindex="-1"></a><span class="co"># configure QgsFeatureRequest and use it with getFeatures()</span></span>
<span id="cb78-19"><a href="#cb78-19" tabindex="-1"></a>request <span class="op">=</span> QgsFeatureRequest()</span>
<span id="cb78-20"><a href="#cb78-20" tabindex="-1"></a>clause <span class="op">=</span> QgsFeatureRequest.OrderByClause(<span class="st">&#39;NAME&#39;</span>)</span>
<span id="cb78-21"><a href="#cb78-21" tabindex="-1"></a>orderby <span class="op">=</span> QgsFeatureRequest.OrderBy([clause])</span>
<span id="cb78-22"><a href="#cb78-22" tabindex="-1"></a>request.setOrderBy(orderby)</span>
<span id="cb78-23"><a href="#cb78-23" tabindex="-1"></a>layer <span class="op">=</span> iface.activeLayer()</span>
<span id="cb78-24"><a href="#cb78-24" tabindex="-1"></a></span>
<span id="cb78-25"><a href="#cb78-25" tabindex="-1"></a><span class="co"># Read the country names and save in a list</span></span>
<span id="cb78-26"><a href="#cb78-26" tabindex="-1"></a>countries <span class="op">=</span> []</span>
<span id="cb78-27"><a href="#cb78-27" tabindex="-1"></a><span class="cf">for</span> f <span class="kw">in</span> layer.getFeatures(request):</span>
<span id="cb78-28"><a href="#cb78-28" tabindex="-1"></a>  name <span class="op">=</span> f[<span class="st">&#39;NAME&#39;</span>]</span>
<span id="cb78-29"><a href="#cb78-29" tabindex="-1"></a>  <span class="cf">if</span> name:</span>
<span id="cb78-30"><a href="#cb78-30" tabindex="-1"></a>    countries.append(name)</span>
<span id="cb78-31"><a href="#cb78-31" tabindex="-1"></a></span>
<span id="cb78-32"><a href="#cb78-32" tabindex="-1"></a><span class="co"># Add items to the combobox</span></span>
<span id="cb78-33"><a href="#cb78-33" tabindex="-1"></a><span class="cf">for</span> country <span class="kw">in</span> countries:</span>
<span id="cb78-34"><a href="#cb78-34" tabindex="-1"></a>    countryCombo.addItem(country)</span>
<span id="cb78-35"><a href="#cb78-35" tabindex="-1"></a></span>
<span id="cb78-36"><a href="#cb78-36" tabindex="-1"></a><span class="co"># Define functions to apply and reset filters</span></span>
<span id="cb78-37"><a href="#cb78-37" tabindex="-1"></a><span class="kw">def</span> filter_layer():</span>
<span id="cb78-38"><a href="#cb78-38" tabindex="-1"></a>    layer <span class="op">=</span> iface.activeLayer()</span>
<span id="cb78-39"><a href="#cb78-39" tabindex="-1"></a>    country <span class="op">=</span> countryCombo.currentText()</span>
<span id="cb78-40"><a href="#cb78-40" tabindex="-1"></a>    expression <span class="op">=</span> <span class="st">&#39;</span><span class="ch">\&quot;</span><span class="st">NAME</span><span class="ch">\&quot;</span><span class="st"> = </span><span class="ch">\&#39;</span><span class="sc">{}</span><span class="ch">\&#39;</span><span class="st">&#39;</span>.<span class="bu">format</span>(country)</span>
<span id="cb78-41"><a href="#cb78-41" tabindex="-1"></a>    layer.setSubsetString(expression)</span>
<span id="cb78-42"><a href="#cb78-42" tabindex="-1"></a></span>
<span id="cb78-43"><a href="#cb78-43" tabindex="-1"></a><span class="kw">def</span> reset_layer():</span>
<span id="cb78-44"><a href="#cb78-44" tabindex="-1"></a>    layer <span class="op">=</span> iface.activeLayer()</span>
<span id="cb78-45"><a href="#cb78-45" tabindex="-1"></a>    layer.setSubsetString(<span class="st">&#39;&#39;</span>)</span>
<span id="cb78-46"><a href="#cb78-46" tabindex="-1"></a>    countryCombo.clear()</span>
<span id="cb78-47"><a href="#cb78-47" tabindex="-1"></a>    <span class="cf">for</span> country <span class="kw">in</span> countries:</span>
<span id="cb78-48"><a href="#cb78-48" tabindex="-1"></a>      countryCombo.addItem(country)</span>
<span id="cb78-49"><a href="#cb78-49" tabindex="-1"></a>      </span>
<span id="cb78-50"><a href="#cb78-50" tabindex="-1"></a>filterButton.clicked.<span class="ex">connect</span>(filter_layer)</span>
<span id="cb78-51"><a href="#cb78-51" tabindex="-1"></a>resetButton.clicked.<span class="ex">connect</span>(reset_layer)</span></code></pre></div>
</div>
<div id="adding-csv-layers" class="section level2">
<h2>Adding CSV Layers</h2>
<div class="sourceCode" id="cb79"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb79-1"><a href="#cb79-1" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb79-2"><a href="#cb79-2" tabindex="-1"></a>data_dir <span class="op">=</span> os.path.join(os.path.expanduser(<span class="st">&#39;~&#39;</span>), <span class="st">&#39;Downloads&#39;</span>, <span class="st">&#39;pyqgis_masterclass&#39;</span>)</span>
<span id="cb79-3"><a href="#cb79-3" tabindex="-1"></a></span>
<span id="cb79-4"><a href="#cb79-4" tabindex="-1"></a>filename <span class="op">=</span> <span class="st">&#39;trees.csv&#39;</span></span>
<span id="cb79-5"><a href="#cb79-5" tabindex="-1"></a>csvpath <span class="op">=</span> <span class="st">&#39;file:///&#39;</span> <span class="op">+</span> data_dir <span class="op">+</span> filename</span>
<span id="cb79-6"><a href="#cb79-6" tabindex="-1"></a>uri <span class="op">=</span> <span class="st">&#39;</span><span class="sc">{}</span><span class="st">?type=csv&amp;xField=</span><span class="sc">{}</span><span class="st">&amp;yField=</span><span class="sc">{}</span><span class="st">&amp;crs=</span><span class="sc">{}</span><span class="st">&#39;</span>.<span class="bu">format</span>(</span>
<span id="cb79-7"><a href="#cb79-7" tabindex="-1"></a>  csvpath, <span class="st">&#39;Longitude&#39;</span>, <span class="st">&#39;Latitude&#39;</span>, <span class="st">&#39;EPSG:4326&#39;</span>)</span>
<span id="cb79-8"><a href="#cb79-8" tabindex="-1"></a>iface.addVectorLayer(uri, <span class="st">&#39;trees&#39;</span>, <span class="st">&#39;delimitedtext&#39;</span>)</span></code></pre></div>
</div>
<div id="inserting-layers-in-the-layer-tree" class="section level2">
<h2>Inserting Layers in the Layer Tree</h2>
<p>We can use the <code>QgsLayerTree</code> class to insert the layer at
an appropriate place.</p>
<div class="sourceCode" id="cb80"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb80-1"><a href="#cb80-1" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb80-2"><a href="#cb80-2" tabindex="-1"></a>data_dir <span class="op">=</span> os.path.join(os.path.expanduser(<span class="st">&#39;~&#39;</span>), <span class="st">&#39;Downloads&#39;</span>, <span class="st">&#39;pyqgis_masterclass&#39;</span>)</span>
<span id="cb80-3"><a href="#cb80-3" tabindex="-1"></a></span>
<span id="cb80-4"><a href="#cb80-4" tabindex="-1"></a>filename <span class="op">=</span> <span class="st">&#39;srtm.tif&#39;</span></span>
<span id="cb80-5"><a href="#cb80-5" tabindex="-1"></a>uri <span class="op">=</span> os.path.join(data_dir, filename)</span>
<span id="cb80-6"><a href="#cb80-6" tabindex="-1"></a>rlayer <span class="op">=</span> QgsRasterLayer(uri, <span class="st">&#39;srtm&#39;</span>, <span class="st">&#39;gdal&#39;</span>)</span>
<span id="cb80-7"><a href="#cb80-7" tabindex="-1"></a></span>
<span id="cb80-8"><a href="#cb80-8" tabindex="-1"></a>rastergroup <span class="op">=</span> QgsLayerTreeGroup(<span class="st">&#39;raster layers&#39;</span>)</span>
<span id="cb80-9"><a href="#cb80-9" tabindex="-1"></a>treelayer <span class="op">=</span> QgsLayerTreeLayer(rlayer)</span>
<span id="cb80-10"><a href="#cb80-10" tabindex="-1"></a>rastergroup.insertChildNode(<span class="dv">0</span>, treelayer)</span>
<span id="cb80-11"><a href="#cb80-11" tabindex="-1"></a></span>
<span id="cb80-12"><a href="#cb80-12" tabindex="-1"></a>root <span class="op">=</span> QgsProject.instance().layerTreeRoot()</span>
<span id="cb80-13"><a href="#cb80-13" tabindex="-1"></a>root.insertChildNode(<span class="dv">1</span>, rastergroup)</span></code></pre></div>
<p><img src="images/pyqgis/rasterlayer.png" width="50%" style="display: block; margin: auto;" /></p>
</div>
<div id="saving-layers-to-disk" class="section level2">
<h2>Saving Layers to Disk</h2>
<p>Use the <code>QgsRasterFileWriter</code> or
<code>QgsVectorFileWriter</code> classes for writing layers to disk.</p>
<div class="sourceCode" id="cb81"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb81-1"><a href="#cb81-1" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb81-2"><a href="#cb81-2" tabindex="-1"></a>data_dir <span class="op">=</span> os.path.join(os.path.expanduser(<span class="st">&#39;~&#39;</span>), <span class="st">&#39;Downloads&#39;</span>, <span class="st">&#39;pyqgis_masterclass&#39;</span>)</span>
<span id="cb81-3"><a href="#cb81-3" tabindex="-1"></a></span>
<span id="cb81-4"><a href="#cb81-4" tabindex="-1"></a>options <span class="op">=</span> QgsVectorFileWriter.SaveVectorOptions()</span>
<span id="cb81-5"><a href="#cb81-5" tabindex="-1"></a>options.actionOnExistingFile <span class="op">=</span> QgsVectorFileWriter.CreateOrOverwriteLayer </span>
<span id="cb81-6"><a href="#cb81-6" tabindex="-1"></a>options.layerName <span class="op">=</span> <span class="st">&#39;point&#39;</span></span>
<span id="cb81-7"><a href="#cb81-7" tabindex="-1"></a></span>
<span id="cb81-8"><a href="#cb81-8" tabindex="-1"></a>filename <span class="op">=</span> <span class="st">&#39;sf.gpkg&#39;</span></span>
<span id="cb81-9"><a href="#cb81-9" tabindex="-1"></a>path <span class="op">=</span> os.path.join(data_dir, filename)</span>
<span id="cb81-10"><a href="#cb81-10" tabindex="-1"></a>QgsVectorFileWriter.writeAsVectorFormat(vlayer, path, options)</span></code></pre></div>
</div>
<div id="displaying-a-label-with-a-background-color"
class="section level2">
<h2>Displaying a label with a background color</h2>
<p>This is a vast topic, but you can get a taste of the flexibility
offered by the API to control all aspects of labeling. Notice the class
name <code>QgsPalLayerSettings</code> - this is because QGIS uses a
labeling library called <a
href="http://pal.heig-vd.ch/index.php?page=about-pal">PAL</a> for
labels. The code snippet below shows how to create a label for a point
layer with a background color. [^8]</p>
<div class="sourceCode" id="cb82"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb82-1"><a href="#cb82-1" tabindex="-1"></a>vlayer <span class="op">=</span> QgsProject.instance().mapLayersByName(<span class="st">&#39;point&#39;</span>)[<span class="dv">0</span>]</span>
<span id="cb82-2"><a href="#cb82-2" tabindex="-1"></a>symbol <span class="op">=</span> QgsMarkerSymbol.createSimple({<span class="st">&#39;name&#39;</span>: <span class="st">&#39;square&#39;</span>, <span class="st">&#39;color&#39;</span>: <span class="st">&#39;red&#39;</span>})</span>
<span id="cb82-3"><a href="#cb82-3" tabindex="-1"></a>vlayer.renderer().setSymbol(symbol)</span>
<span id="cb82-4"><a href="#cb82-4" tabindex="-1"></a></span>
<span id="cb82-5"><a href="#cb82-5" tabindex="-1"></a>label_settings <span class="op">=</span> QgsPalLayerSettings()</span>
<span id="cb82-6"><a href="#cb82-6" tabindex="-1"></a><span class="co">#label_settings.drawBackground = True</span></span>
<span id="cb82-7"><a href="#cb82-7" tabindex="-1"></a>label_settings.fieldName <span class="op">=</span> <span class="st">&#39;name&#39;</span></span>
<span id="cb82-8"><a href="#cb82-8" tabindex="-1"></a></span>
<span id="cb82-9"><a href="#cb82-9" tabindex="-1"></a>text_format <span class="op">=</span> QgsTextFormat()</span>
<span id="cb82-10"><a href="#cb82-10" tabindex="-1"></a>background_color <span class="op">=</span> QgsTextBackgroundSettings()</span>
<span id="cb82-11"><a href="#cb82-11" tabindex="-1"></a>background_color.setFillColor(QColor(<span class="st">&#39;white&#39;</span>))</span>
<span id="cb82-12"><a href="#cb82-12" tabindex="-1"></a>background_color.setEnabled(<span class="va">True</span>)</span>
<span id="cb82-13"><a href="#cb82-13" tabindex="-1"></a>text_format.setBackground(background_color )</span>
<span id="cb82-14"><a href="#cb82-14" tabindex="-1"></a>label_settings.setFormat(text_format)</span>
<span id="cb82-15"><a href="#cb82-15" tabindex="-1"></a></span>
<span id="cb82-16"><a href="#cb82-16" tabindex="-1"></a>vlayer.setLabeling(QgsVectorLayerSimpleLabeling(label_settings))</span>
<span id="cb82-17"><a href="#cb82-17" tabindex="-1"></a>vlayer.setLabelsEnabled(<span class="va">True</span>)</span>
<span id="cb82-18"><a href="#cb82-18" tabindex="-1"></a>vlayer.triggerRepaint()</span></code></pre></div>
<p><img src="images/pyqgis/label.png" width="75%" style="display: block; margin: auto;" /></p>
</div>
<div id="edit-attribute-table-of-a-vector-layer" class="section level2">
<h2>Edit Attribute Table of a Vector Layer</h2>
<p>When you use processing, a new layer is created by each algorithm.
This example shows, how to use processing to overwrite the original
layer with the results of processing.</p>
<div class="sourceCode" id="cb83"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb83-1"><a href="#cb83-1" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb83-2"><a href="#cb83-2" tabindex="-1"></a>data_dir <span class="op">=</span> os.path.join(os.path.expanduser(<span class="st">&#39;~&#39;</span>), <span class="st">&#39;Downloads&#39;</span>, <span class="st">&#39;pyqgis_masterclass&#39;</span>)</span>
<span id="cb83-3"><a href="#cb83-3" tabindex="-1"></a></span>
<span id="cb83-4"><a href="#cb83-4" tabindex="-1"></a>filename <span class="op">=</span> <span class="st">&#39;sf.gpkg|layername=blocks&#39;</span></span>
<span id="cb83-5"><a href="#cb83-5" tabindex="-1"></a>uri <span class="op">=</span> os.path.join(data_dir, filename)</span>
<span id="cb83-6"><a href="#cb83-6" tabindex="-1"></a>blocks <span class="op">=</span> QgsVectorLayer(uri, <span class="st">&#39;blocks&#39;</span>, <span class="st">&#39;ogr&#39;</span>)</span>
<span id="cb83-7"><a href="#cb83-7" tabindex="-1"></a></span>
<span id="cb83-8"><a href="#cb83-8" tabindex="-1"></a>output <span class="op">=</span> processing.run(</span>
<span id="cb83-9"><a href="#cb83-9" tabindex="-1"></a>    <span class="st">&quot;qgis:deletecolumn&quot;</span>, </span>
<span id="cb83-10"><a href="#cb83-10" tabindex="-1"></a>    {<span class="st">&#39;INPUT&#39;</span>: blocks,<span class="st">&#39;COLUMN&#39;</span>:[<span class="st">&#39;multigeom&#39;</span>],<span class="st">&#39;OUTPUT&#39;</span>:<span class="st">&#39;memory:&#39;</span>})</span>
<span id="cb83-11"><a href="#cb83-11" tabindex="-1"></a>outputlayer <span class="op">=</span> output[<span class="st">&#39;OUTPUT&#39;</span>]</span>
<span id="cb83-12"><a href="#cb83-12" tabindex="-1"></a></span>
<span id="cb83-13"><a href="#cb83-13" tabindex="-1"></a>final <span class="op">=</span> processing.run(<span class="st">&quot;qgis:fieldcalculator&quot;</span>,</span>
<span id="cb83-14"><a href="#cb83-14" tabindex="-1"></a>    {<span class="st">&#39;INPUT&#39;</span>:outputlayer,</span>
<span id="cb83-15"><a href="#cb83-15" tabindex="-1"></a>    <span class="st">&#39;FIELD_NAME&#39;</span>:<span class="st">&#39;area&#39;</span>,</span>
<span id="cb83-16"><a href="#cb83-16" tabindex="-1"></a>    <span class="st">&#39;FIELD_TYPE&#39;</span>:<span class="dv">0</span>,</span>
<span id="cb83-17"><a href="#cb83-17" tabindex="-1"></a>    <span class="st">&#39;FIELD_LENGTH&#39;</span>:<span class="dv">10</span>,</span>
<span id="cb83-18"><a href="#cb83-18" tabindex="-1"></a>    <span class="st">&#39;FIELD_PRECISION&#39;</span>:<span class="dv">3</span>,</span>
<span id="cb83-19"><a href="#cb83-19" tabindex="-1"></a>    <span class="st">&#39;NEW_FIELD&#39;</span>:<span class="va">True</span>,</span>
<span id="cb83-20"><a href="#cb83-20" tabindex="-1"></a>    <span class="st">&#39;FORMULA&#39;</span>:<span class="st">&#39;$area&#39;</span>,</span>
<span id="cb83-21"><a href="#cb83-21" tabindex="-1"></a>    <span class="st">&#39;OUTPUT&#39;</span>:<span class="st">&#39;memory:&#39;</span>})</span>
<span id="cb83-22"><a href="#cb83-22" tabindex="-1"></a>finallayer <span class="op">=</span> final[<span class="st">&#39;OUTPUT&#39;</span>]</span>
<span id="cb83-23"><a href="#cb83-23" tabindex="-1"></a></span>
<span id="cb83-24"><a href="#cb83-24" tabindex="-1"></a>options <span class="op">=</span> QgsVectorFileWriter.SaveVectorOptions()</span>
<span id="cb83-25"><a href="#cb83-25" tabindex="-1"></a><span class="co"># We overwrite the original layer</span></span>
<span id="cb83-26"><a href="#cb83-26" tabindex="-1"></a>options.layerName <span class="op">=</span> <span class="st">&#39;blocks&#39;</span></span>
<span id="cb83-27"><a href="#cb83-27" tabindex="-1"></a>options.actionOnExistingFile <span class="op">=</span> QgsVectorFileWriter.CreateOrOverwriteLayer </span>
<span id="cb83-28"><a href="#cb83-28" tabindex="-1"></a></span>
<span id="cb83-29"><a href="#cb83-29" tabindex="-1"></a>output_file <span class="op">=</span> <span class="st">&#39;sf.gpkg&#39;</span></span>
<span id="cb83-30"><a href="#cb83-30" tabindex="-1"></a>output_path <span class="op">=</span> os.path.join(data_dir, output_file)</span>
<span id="cb83-31"><a href="#cb83-31" tabindex="-1"></a>QgsVectorFileWriter.writeAsVectorFormat(finallayer, output_path, options)</span>
<span id="cb83-32"><a href="#cb83-32" tabindex="-1"></a>QgsProject.instance().reloadAllLayers()</span></code></pre></div>
</div>
<div id="creating-a-pdf-with-title" class="section level2">
<h2>Creating a PDF with Title</h2>
<p><img src="images/pyqgis/layout.png" width="75%" style="display: block; margin: auto;" /></p>
<div class="sourceCode" id="cb84"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb84-1"><a href="#cb84-1" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb84-2"><a href="#cb84-2" tabindex="-1"></a>data_dir <span class="op">=</span> os.path.join(os.path.expanduser(<span class="st">&#39;~&#39;</span>), <span class="st">&#39;Downloads&#39;</span>, <span class="st">&#39;pyqgis_masterclass&#39;</span>)</span>
<span id="cb84-3"><a href="#cb84-3" tabindex="-1"></a></span>
<span id="cb84-4"><a href="#cb84-4" tabindex="-1"></a>project <span class="op">=</span> QgsProject.instance()</span>
<span id="cb84-5"><a href="#cb84-5" tabindex="-1"></a>extent <span class="op">=</span> QgsRectangle(<span class="op">-</span><span class="fl">122.52</span>, <span class="fl">37.71</span>, <span class="op">-</span><span class="fl">122.35</span>, <span class="fl">37.83</span>)</span>
<span id="cb84-6"><a href="#cb84-6" tabindex="-1"></a></span>
<span id="cb84-7"><a href="#cb84-7" tabindex="-1"></a>layout <span class="op">=</span> QgsPrintLayout(project)</span>
<span id="cb84-8"><a href="#cb84-8" tabindex="-1"></a>layout.initializeDefaults()</span>
<span id="cb84-9"><a href="#cb84-9" tabindex="-1"></a></span>
<span id="cb84-10"><a href="#cb84-10" tabindex="-1"></a>pages <span class="op">=</span> layout.pageCollection()</span>
<span id="cb84-11"><a href="#cb84-11" tabindex="-1"></a>pages.beginPageSizeChange()</span>
<span id="cb84-12"><a href="#cb84-12" tabindex="-1"></a>page <span class="op">=</span> pages.page(<span class="dv">0</span>)</span>
<span id="cb84-13"><a href="#cb84-13" tabindex="-1"></a>page.setPageSize(<span class="st">&#39;A4&#39;</span>,  QgsLayoutItemPage.Landscape)</span>
<span id="cb84-14"><a href="#cb84-14" tabindex="-1"></a>pages.endPageSizeChange()</span>
<span id="cb84-15"><a href="#cb84-15" tabindex="-1"></a>page_center <span class="op">=</span> page.pageSize().width() <span class="op">/</span> <span class="dv">2</span></span>
<span id="cb84-16"><a href="#cb84-16" tabindex="-1"></a></span>
<span id="cb84-17"><a href="#cb84-17" tabindex="-1"></a></span>
<span id="cb84-18"><a href="#cb84-18" tabindex="-1"></a><span class="bu">map</span> <span class="op">=</span> QgsLayoutItemMap(layout)</span>
<span id="cb84-19"><a href="#cb84-19" tabindex="-1"></a><span class="bu">map</span>.setRect(QRectF(<span class="op">-</span><span class="fl">122.52</span>, <span class="fl">37.71</span>, <span class="op">-</span><span class="fl">122.35</span>, <span class="fl">37.83</span>))</span>
<span id="cb84-20"><a href="#cb84-20" tabindex="-1"></a><span class="bu">map</span>.setExtent(extent)</span>
<span id="cb84-21"><a href="#cb84-21" tabindex="-1"></a>a4 <span class="op">=</span> QPageSize().size(QPageSize.A4, QPageSize.Millimeter)</span>
<span id="cb84-22"><a href="#cb84-22" tabindex="-1"></a><span class="bu">map</span>.attemptResize(QgsLayoutSize(a4.height(),  a4.width()))</span>
<span id="cb84-23"><a href="#cb84-23" tabindex="-1"></a></span>
<span id="cb84-24"><a href="#cb84-24" tabindex="-1"></a>layout.addItem(<span class="bu">map</span>)</span>
<span id="cb84-25"><a href="#cb84-25" tabindex="-1"></a>title <span class="op">=</span> QgsLayoutItemLabel(layout)</span>
<span id="cb84-26"><a href="#cb84-26" tabindex="-1"></a>title.setText(<span class="st">&#39;San Francisco&#39;</span>)</span>
<span id="cb84-27"><a href="#cb84-27" tabindex="-1"></a>title.setFont(QFont(<span class="st">&#39;Arial&#39;</span>, <span class="dv">36</span>))</span>
<span id="cb84-28"><a href="#cb84-28" tabindex="-1"></a>title.adjustSizeToText()</span>
<span id="cb84-29"><a href="#cb84-29" tabindex="-1"></a>title.setReferencePoint(QgsLayoutItem.UpperMiddle)</span>
<span id="cb84-30"><a href="#cb84-30" tabindex="-1"></a>title.attemptMove(QgsLayoutPoint(page_center, <span class="dv">10</span>))</span>
<span id="cb84-31"><a href="#cb84-31" tabindex="-1"></a>layout.addItem(title)</span>
<span id="cb84-32"><a href="#cb84-32" tabindex="-1"></a></span>
<span id="cb84-33"><a href="#cb84-33" tabindex="-1"></a>output_file <span class="op">=</span> <span class="st">&#39;sf.pdf&#39;</span></span>
<span id="cb84-34"><a href="#cb84-34" tabindex="-1"></a>output_path <span class="op">=</span> os.path.join(data_dir, output_file)</span>
<span id="cb84-35"><a href="#cb84-35" tabindex="-1"></a></span>
<span id="cb84-36"><a href="#cb84-36" tabindex="-1"></a>exporter <span class="op">=</span> QgsLayoutExporter(layout)</span>
<span id="cb84-37"><a href="#cb84-37" tabindex="-1"></a>exporter.exportToPdf(</span>
<span id="cb84-38"><a href="#cb84-38" tabindex="-1"></a>    output_path, QgsLayoutExporter.PdfExportSettings())</span></code></pre></div>
<p><img src="images/pyqgis/layoutpdf.png" width="75%" style="display: block; margin: auto;" /></p>
</div>
<div id="create-a-geodesic-line" class="section level2">
<h2>Create a Geodesic Line</h2>
<p>Connects 2 points using the great circle arc along an ellipsoid. Uses
the <code>geodesicLine()</code> method provided by the
<code>QgsDistanceArea()</code> class for the computation.</p>
<p><img src="images/pyqgis/geodesic_line.png" width="75%" style="display: block; margin: auto;" /></p>
<div class="sourceCode" id="cb85"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb85-1"><a href="#cb85-1" tabindex="-1"></a><span class="im">from</span> qgis.core <span class="im">import</span> QgsDistanceArea</span>
<span id="cb85-2"><a href="#cb85-2" tabindex="-1"></a></span>
<span id="cb85-3"><a href="#cb85-3" tabindex="-1"></a>new_york <span class="op">=</span> (<span class="fl">40.661</span>, <span class="op">-</span><span class="fl">73.944</span>)</span>
<span id="cb85-4"><a href="#cb85-4" tabindex="-1"></a>london <span class="op">=</span> (<span class="fl">51.5072</span>, <span class="fl">0.1276</span>)</span>
<span id="cb85-5"><a href="#cb85-5" tabindex="-1"></a></span>
<span id="cb85-6"><a href="#cb85-6" tabindex="-1"></a>lat1, lon1 <span class="op">=</span> new_york</span>
<span id="cb85-7"><a href="#cb85-7" tabindex="-1"></a>lat2, lon2 <span class="op">=</span> london</span>
<span id="cb85-8"><a href="#cb85-8" tabindex="-1"></a></span>
<span id="cb85-9"><a href="#cb85-9" tabindex="-1"></a><span class="co"># Remember the order is X,Y</span></span>
<span id="cb85-10"><a href="#cb85-10" tabindex="-1"></a>point1 <span class="op">=</span> QgsPointXY(lon1, lat1)</span>
<span id="cb85-11"><a href="#cb85-11" tabindex="-1"></a>point2 <span class="op">=</span> QgsPointXY(lon2, lat2)</span>
<span id="cb85-12"><a href="#cb85-12" tabindex="-1"></a></span>
<span id="cb85-13"><a href="#cb85-13" tabindex="-1"></a>d <span class="op">=</span> QgsDistanceArea()</span>
<span id="cb85-14"><a href="#cb85-14" tabindex="-1"></a>d.setEllipsoid(<span class="st">&#39;WGS84&#39;</span>)</span>
<span id="cb85-15"><a href="#cb85-15" tabindex="-1"></a></span>
<span id="cb85-16"><a href="#cb85-16" tabindex="-1"></a><span class="co"># Create a geodesic line with vertices every 100km</span></span>
<span id="cb85-17"><a href="#cb85-17" tabindex="-1"></a>vertices <span class="op">=</span> d.geodesicLine(point1, point2, <span class="dv">100000</span>)</span>
<span id="cb85-18"><a href="#cb85-18" tabindex="-1"></a></span>
<span id="cb85-19"><a href="#cb85-19" tabindex="-1"></a><span class="co"># Create a polyline from the vertices</span></span>
<span id="cb85-20"><a href="#cb85-20" tabindex="-1"></a><span class="co"># The method returns 1 geometry unless the line crosses antimeridien</span></span>
<span id="cb85-21"><a href="#cb85-21" tabindex="-1"></a>geodesic_line <span class="op">=</span> QgsGeometry.fromPolylineXY(vertices[<span class="dv">0</span>])</span>
<span id="cb85-22"><a href="#cb85-22" tabindex="-1"></a></span>
<span id="cb85-23"><a href="#cb85-23" tabindex="-1"></a><span class="co"># Create a line layer to display the route</span></span>
<span id="cb85-24"><a href="#cb85-24" tabindex="-1"></a>vlayer <span class="op">=</span> QgsVectorLayer(<span class="st">&#39;LineString?crs=EPSG:4326&#39;</span>, <span class="st">&#39;route&#39;</span>, <span class="st">&#39;memory&#39;</span>)</span>
<span id="cb85-25"><a href="#cb85-25" tabindex="-1"></a>provider <span class="op">=</span> vlayer.dataProvider()</span>
<span id="cb85-26"><a href="#cb85-26" tabindex="-1"></a></span>
<span id="cb85-27"><a href="#cb85-27" tabindex="-1"></a>f <span class="op">=</span> QgsFeature()</span>
<span id="cb85-28"><a href="#cb85-28" tabindex="-1"></a>f.setGeometry(geodesic_line)</span>
<span id="cb85-29"><a href="#cb85-29" tabindex="-1"></a>provider.addFeature(f)</span>
<span id="cb85-30"><a href="#cb85-30" tabindex="-1"></a>vlayer.updateExtents() </span>
<span id="cb85-31"><a href="#cb85-31" tabindex="-1"></a>QgsProject.instance().addMapLayer(vlayer)</span></code></pre></div>
</div>
<div id="simplifying-processing-scripts" class="section level2">
<h2>Simplifying Processing Scripts</h2>
<p>The Processing Framework providers a simpler way to write processing
scripts by using the <code>@alg</code> decorator. Using this approach,
you are able to remove a lot of <em>boilerplate</em> code and focus on
just writing the main algorithm function. There are some limitations of
this approach - the main one being that scripts written using the
<code>@alg</code> decorator cannot be used in plugins. But if your goal
is to create a processing scripts, this is a much simpler style.</p>
<blockquote>
<p>Note: the <code>@alg</code> decorator cannot be used in plugins. If
you are writing processing algorithms for a plugin, use the full script
template shown in the previous section.</p>
</blockquote>
<p>Let’s modify the <code>save_attributes_algorithm.py</code> script
covered in the <a href="#writing-a-processing-script">previous
section</a> to use the built-in <code>@alg</code> decorator. Locate the
script in <em>Processing Toolbox</em> under <strong>Scripts → Save
Attributes As CSV</strong>. Right-click on it and select <em>Edit
Script…</em>. Replace all the code in the <em>Processing Script
Editor</em> with the following and click the <em>Save Script</em>
button</p>
<div class="sourceCode" id="cb86"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb86-1"><a href="#cb86-1" tabindex="-1"></a><span class="im">from</span> qgis.processing <span class="im">import</span> alg</span>
<span id="cb86-2"><a href="#cb86-2" tabindex="-1"></a></span>
<span id="cb86-3"><a href="#cb86-3" tabindex="-1"></a><span class="at">@alg</span>(name<span class="op">=</span><span class="st">&#39;save_attributes&#39;</span>, label<span class="op">=</span><span class="st">&#39;Save Attributes As CSV&#39;</span>,</span>
<span id="cb86-4"><a href="#cb86-4" tabindex="-1"></a>    group<span class="op">=</span><span class="st">&#39;&#39;</span>, group_label<span class="op">=</span><span class="st">&#39;&#39;</span>)</span>
<span id="cb86-5"><a href="#cb86-5" tabindex="-1"></a><span class="at">@alg.input</span>(<span class="bu">type</span><span class="op">=</span>alg.SOURCE, name<span class="op">=</span><span class="st">&#39;INPUT&#39;</span>, label<span class="op">=</span><span class="st">&#39;Input Layer&#39;</span>)</span>
<span id="cb86-6"><a href="#cb86-6" tabindex="-1"></a><span class="at">@alg.input</span>(<span class="bu">type</span><span class="op">=</span>alg.FILE_DEST, name<span class="op">=</span><span class="st">&#39;OUTPUT&#39;</span>, label<span class="op">=</span><span class="st">&#39;Output File&#39;</span>)</span>
<span id="cb86-7"><a href="#cb86-7" tabindex="-1"></a><span class="kw">def</span> processAlgorithm(instance, parameters, context, feedback, inputs):</span>
<span id="cb86-8"><a href="#cb86-8" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;Saves the attributes of a vector layer to a CSV file.&quot;&quot;&quot;</span></span>
<span id="cb86-9"><a href="#cb86-9" tabindex="-1"></a>    source <span class="op">=</span> instance.parameterAsSource(parameters, <span class="st">&#39;INPUT&#39;</span>, context)</span>
<span id="cb86-10"><a href="#cb86-10" tabindex="-1"></a>    csv <span class="op">=</span> instance.parameterAsFileOutput(parameters, <span class="st">&#39;OUTPUT&#39;</span>, context)</span>
<span id="cb86-11"><a href="#cb86-11" tabindex="-1"></a></span>
<span id="cb86-12"><a href="#cb86-12" tabindex="-1"></a>    fieldnames <span class="op">=</span> [field.name() <span class="cf">for</span> field <span class="kw">in</span> source.fields()]</span>
<span id="cb86-13"><a href="#cb86-13" tabindex="-1"></a></span>
<span id="cb86-14"><a href="#cb86-14" tabindex="-1"></a>    <span class="co"># Compute the number of steps to display within the progress bar and</span></span>
<span id="cb86-15"><a href="#cb86-15" tabindex="-1"></a>    <span class="co"># get features from source</span></span>
<span id="cb86-16"><a href="#cb86-16" tabindex="-1"></a>    total <span class="op">=</span> <span class="fl">100.0</span> <span class="op">/</span> source.featureCount() <span class="cf">if</span> source.featureCount() <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb86-17"><a href="#cb86-17" tabindex="-1"></a>    features <span class="op">=</span> source.getFeatures()</span>
<span id="cb86-18"><a href="#cb86-18" tabindex="-1"></a></span>
<span id="cb86-19"><a href="#cb86-19" tabindex="-1"></a>    <span class="cf">with</span> <span class="bu">open</span>(csv, <span class="st">&#39;w&#39;</span>) <span class="im">as</span> output_file:</span>
<span id="cb86-20"><a href="#cb86-20" tabindex="-1"></a>      <span class="co"># write header</span></span>
<span id="cb86-21"><a href="#cb86-21" tabindex="-1"></a>      line <span class="op">=</span> <span class="st">&#39;,&#39;</span>.join(name <span class="cf">for</span> name <span class="kw">in</span> fieldnames) <span class="op">+</span> <span class="st">&#39;</span><span class="ch">\n</span><span class="st">&#39;</span></span>
<span id="cb86-22"><a href="#cb86-22" tabindex="-1"></a>      output_file.write(line)</span>
<span id="cb86-23"><a href="#cb86-23" tabindex="-1"></a>      <span class="cf">for</span> current, f <span class="kw">in</span> <span class="bu">enumerate</span>(features):</span>
<span id="cb86-24"><a href="#cb86-24" tabindex="-1"></a>          <span class="co"># Stop the algorithm if cancel button has been clicked</span></span>
<span id="cb86-25"><a href="#cb86-25" tabindex="-1"></a>          <span class="cf">if</span> feedback.isCanceled():</span>
<span id="cb86-26"><a href="#cb86-26" tabindex="-1"></a>              <span class="cf">break</span></span>
<span id="cb86-27"><a href="#cb86-27" tabindex="-1"></a></span>
<span id="cb86-28"><a href="#cb86-28" tabindex="-1"></a>          <span class="co"># Add a feature in the sink</span></span>
<span id="cb86-29"><a href="#cb86-29" tabindex="-1"></a>          line <span class="op">=</span> <span class="st">&#39;,&#39;</span>.join(<span class="bu">str</span>(f[name]) <span class="cf">for</span> name <span class="kw">in</span> fieldnames) <span class="op">+</span> <span class="st">&#39;</span><span class="ch">\n</span><span class="st">&#39;</span></span>
<span id="cb86-30"><a href="#cb86-30" tabindex="-1"></a>          output_file.write(line)</span>
<span id="cb86-31"><a href="#cb86-31" tabindex="-1"></a></span>
<span id="cb86-32"><a href="#cb86-32" tabindex="-1"></a>          <span class="co"># Update the progress bar</span></span>
<span id="cb86-33"><a href="#cb86-33" tabindex="-1"></a>          feedback.setProgress(<span class="bu">int</span>(current <span class="op">*</span> total))</span>
<span id="cb86-34"><a href="#cb86-34" tabindex="-1"></a></span>
<span id="cb86-35"><a href="#cb86-35" tabindex="-1"></a>    <span class="cf">return</span> {<span class="st">&#39;OUTPUT&#39;</span>: csv}</span></code></pre></div>
<p>You can run the script and see that the behavior is almost identical
but the code is much simpler. The code uses the <code>@alg</code>
decorator for defining algorithm name, group, inputs and outputs in a
more concise way.</p>
<p>Another important thing to note is that to create a processing
algorithm, one must create a class that inherits from
<code>QgsProcessingAlgorithm</code>. When you write a class, you refer
to the current instance of the class with the keyword <code>self</code>.
Here you are just writing a function, and the decorator will create a
class for you. So we are using a parameter named <code>instance</code>.
When the decorator will create a class, the reference to the instance
will be passed on to our function as this parameter.</p>
</div>
<div id="renaming-temporary-output-layers" class="section level2">
<h2>Renaming Temporary Output Layers</h2>
<p>When you run a processing algorithm and choose to generate temporary
oupput layer, the resulting layer has a default name set by the
algorithm. If you want to assign a different name to the temporary
output layer, we can adopt an alternative approach. The code snippet
below shows how to rename the output layer to include the input layer
name. As a result, the output hillshade layer to be named
<code>srtm_hillshade</code> instead of the default
<code>Hillshade</code>.</p>
<div class="sourceCode" id="cb87"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb87-1"><a href="#cb87-1" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb87-2"><a href="#cb87-2" tabindex="-1"></a>data_dir <span class="op">=</span> os.path.join(os.path.expanduser(<span class="st">&#39;~&#39;</span>), <span class="st">&#39;Downloads&#39;</span>, <span class="st">&#39;pyqgis_masterclass&#39;</span>)</span>
<span id="cb87-3"><a href="#cb87-3" tabindex="-1"></a></span>
<span id="cb87-4"><a href="#cb87-4" tabindex="-1"></a>filename <span class="op">=</span> <span class="st">&#39;srtm.tif&#39;</span></span>
<span id="cb87-5"><a href="#cb87-5" tabindex="-1"></a>srtm <span class="op">=</span> os.path.join(data_dir, filename)</span>
<span id="cb87-6"><a href="#cb87-6" tabindex="-1"></a></span>
<span id="cb87-7"><a href="#cb87-7" tabindex="-1"></a>results <span class="op">=</span> processing.run(<span class="st">&quot;native:hillshade&quot;</span>, </span>
<span id="cb87-8"><a href="#cb87-8" tabindex="-1"></a>    {<span class="st">&#39;INPUT&#39;</span>: srtm, </span>
<span id="cb87-9"><a href="#cb87-9" tabindex="-1"></a>    <span class="st">&#39;Z_FACTOR&#39;</span>:<span class="dv">2</span>,</span>
<span id="cb87-10"><a href="#cb87-10" tabindex="-1"></a>    <span class="st">&#39;AZIMUTH&#39;</span>:<span class="dv">300</span>,</span>
<span id="cb87-11"><a href="#cb87-11" tabindex="-1"></a>    <span class="st">&#39;V_ANGLE&#39;</span>:<span class="dv">40</span>,</span>
<span id="cb87-12"><a href="#cb87-12" tabindex="-1"></a>    <span class="st">&#39;OUTPUT&#39;</span>: <span class="st">&#39;TEMPORARY_OUTPUT&#39;</span>})</span>
<span id="cb87-13"><a href="#cb87-13" tabindex="-1"></a><span class="co"># Get the path to the generated layer</span></span>
<span id="cb87-14"><a href="#cb87-14" tabindex="-1"></a>output <span class="op">=</span> results[<span class="st">&#39;OUTPUT&#39;</span>]</span>
<span id="cb87-15"><a href="#cb87-15" tabindex="-1"></a><span class="co"># Extract the name of the file</span></span>
<span id="cb87-16"><a href="#cb87-16" tabindex="-1"></a>input_layer_name <span class="op">=</span> os.path.splitext(os.path.basename(srtm))[<span class="dv">0</span>]</span>
<span id="cb87-17"><a href="#cb87-17" tabindex="-1"></a>output_layer <span class="op">=</span> QgsRasterLayer(output)</span>
<span id="cb87-18"><a href="#cb87-18" tabindex="-1"></a><span class="co"># Set the layer name to include the input file name</span></span>
<span id="cb87-19"><a href="#cb87-19" tabindex="-1"></a>output_layer.setName(<span class="ss">f&#39;</span><span class="sc">{</span>input_layer_name<span class="sc">}</span><span class="ss">_hillshade&#39;</span>)</span>
<span id="cb87-20"><a href="#cb87-20" tabindex="-1"></a>QgsProject.instance().addMapLayer(output_layer)</span></code></pre></div>
</div>
<div id="select-connected-features-using-actions"
class="section level2">
<h2>Select Connected Features using Actions</h2>
<p>In the <a href="#selecting-neighbors">Selecting Neighbors</a>
section, we saw you to create an action that can select the first- and
second-degree neighbors of a feature. We can extend this code to select
nth-degree neighbors which allows us to quick select contiguous regions
in a layer. You can create a Python Action <em>Select Connected
Features</em> with the code below. Using the action on a feature will
select all connected features in a single-click.</p>
<p><img src="images/pyqgis/select_connected.png" width="75%" style="display: block; margin: auto;" /></p>
<div class="sourceCode" id="cb88"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb88-1"><a href="#cb88-1" tabindex="-1"></a>layer_id <span class="op">=</span> <span class="st">&#39;[%@layer_id%]&#39;</span></span>
<span id="cb88-2"><a href="#cb88-2" tabindex="-1"></a>fid <span class="op">=</span> [<span class="op">%</span> $id <span class="op">%</span>]</span>
<span id="cb88-3"><a href="#cb88-3" tabindex="-1"></a></span>
<span id="cb88-4"><a href="#cb88-4" tabindex="-1"></a>layer <span class="op">=</span> QgsProject.instance().mapLayer(layer_id)</span>
<span id="cb88-5"><a href="#cb88-5" tabindex="-1"></a></span>
<span id="cb88-6"><a href="#cb88-6" tabindex="-1"></a><span class="kw">def</span> get_neighbors(feature):</span>
<span id="cb88-7"><a href="#cb88-7" tabindex="-1"></a>    bbox <span class="op">=</span> feature.geometry().boundingBox()</span>
<span id="cb88-8"><a href="#cb88-8" tabindex="-1"></a>    neighbors <span class="op">=</span> []</span>
<span id="cb88-9"><a href="#cb88-9" tabindex="-1"></a>    <span class="cf">for</span> f <span class="kw">in</span> layer.getFeatures(bbox):</span>
<span id="cb88-10"><a href="#cb88-10" tabindex="-1"></a>        <span class="cf">if</span> f.<span class="bu">id</span>() <span class="op">!=</span> feature.<span class="bu">id</span>() <span class="kw">and</span> f.geometry().intersects(feature.geometry()):</span>
<span id="cb88-11"><a href="#cb88-11" tabindex="-1"></a>            neighbors.append(f.<span class="bu">id</span>())</span>
<span id="cb88-12"><a href="#cb88-12" tabindex="-1"></a>    <span class="cf">return</span> neighbors</span>
<span id="cb88-13"><a href="#cb88-13" tabindex="-1"></a></span>
<span id="cb88-14"><a href="#cb88-14" tabindex="-1"></a><span class="co"># Initialize selection with the clicked feature</span></span>
<span id="cb88-15"><a href="#cb88-15" tabindex="-1"></a>visited <span class="op">=</span> <span class="bu">set</span>()</span>
<span id="cb88-16"><a href="#cb88-16" tabindex="-1"></a>to_visit <span class="op">=</span> <span class="bu">set</span>([fid])</span>
<span id="cb88-17"><a href="#cb88-17" tabindex="-1"></a></span>
<span id="cb88-18"><a href="#cb88-18" tabindex="-1"></a><span class="cf">while</span> to_visit:</span>
<span id="cb88-19"><a href="#cb88-19" tabindex="-1"></a>    current_id <span class="op">=</span> to_visit.pop()</span>
<span id="cb88-20"><a href="#cb88-20" tabindex="-1"></a>    <span class="cf">if</span> current_id <span class="kw">in</span> visited:</span>
<span id="cb88-21"><a href="#cb88-21" tabindex="-1"></a>        <span class="cf">continue</span></span>
<span id="cb88-22"><a href="#cb88-22" tabindex="-1"></a></span>
<span id="cb88-23"><a href="#cb88-23" tabindex="-1"></a>    visited.add(current_id)</span>
<span id="cb88-24"><a href="#cb88-24" tabindex="-1"></a>    current_feature <span class="op">=</span> layer.getFeature(current_id)</span>
<span id="cb88-25"><a href="#cb88-25" tabindex="-1"></a>    neighbors <span class="op">=</span> get_neighbors(current_feature)</span>
<span id="cb88-26"><a href="#cb88-26" tabindex="-1"></a></span>
<span id="cb88-27"><a href="#cb88-27" tabindex="-1"></a>    <span class="co"># Add unvisited neighbors to the queue</span></span>
<span id="cb88-28"><a href="#cb88-28" tabindex="-1"></a>    new_neighbors <span class="op">=</span> <span class="bu">set</span>(neighbors) <span class="op">-</span> visited</span>
<span id="cb88-29"><a href="#cb88-29" tabindex="-1"></a>    to_visit.update(new_neighbors)</span>
<span id="cb88-30"><a href="#cb88-30" tabindex="-1"></a></span>
<span id="cb88-31"><a href="#cb88-31" tabindex="-1"></a><span class="co"># Apply the final selection</span></span>
<span id="cb88-32"><a href="#cb88-32" tabindex="-1"></a>layer.selectByIds(<span class="bu">list</span>(visited))</span></code></pre></div>
</div>
<div id="using-code-from-plugins" class="section level2">
<h2>Using Code from Plugins</h2>
<p>It is possible to access classes and methods from plugins using
PyQGIS. You can access all installed plugins using the
<code>qgis.utils</code> module and use code from them as shown
below.</p>
<p>Print the list of installed plugins.</p>
<div class="sourceCode" id="cb89"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb89-1"><a href="#cb89-1" tabindex="-1"></a><span class="bu">print</span>(qgis.utils.plugins.keys())</span></code></pre></div>
<p>Access the method from a plugin. Replace <code>PluginName</code> with
the name from the list above.</p>
<div class="sourceCode" id="cb90"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb90-1"><a href="#cb90-1" tabindex="-1"></a>myPlugin <span class="op">=</span> qgis.utils.plugins[<span class="st">&#39;PluginName&#39;</span>]</span>
<span id="cb90-2"><a href="#cb90-2" tabindex="-1"></a>A <span class="op">=</span> myPlugin.A()</span>
<span id="cb90-3"><a href="#cb90-3" tabindex="-1"></a>A.my_method()</span></code></pre></div>
</div>
<div id="specifying-plugin-dependencies" class="section level2">
<h2>Specifying Plugin Dependencies</h2>
<p>QGIS Plugin Manager supports installation of other plugin
dependencies through the <code>plugin_dependencies</code> metadata in
the <a
href="https://docs.qgis.org/3.40/en/docs/pyqgis_developer_cookbook/plugins/plugins.html#metadata-txt"><code>metadata.txt</code></a>
file. The QGIS Plugin Manager will prompt the user to install these when
the plugin is installed. There is a newer plugin called <a
href="https://github.com/opengisch/qpip"><code>qpip</code></a> that
leverages this functionality and allows you to specify additional Python
packages that your plugin requires. This is the most elegant way to
include additional Python packages required by your plugin. You need to
make 2 changes to your plugin to use this.</p>
<ol style="list-style-type: decimal">
<li>Add <strong>qpip</strong> in the <code>plugin_dependencies</code> in
<code>metadata.txt</code>.</li>
<li>Add a <code>requirements.txt</code> file with the list of packages
to be installed with your plugin in the standard <a
href="https://pip.pypa.io/en/stable/reference/requirements-file-format/">pip
supported format</a>.</li>
</ol>
<p>For example, if we wanted the package <code>prettyprint</code> to be
installed along with the plugin, you will need to make the following
changes</p>
<p>Modify the <code>metadata.txt</code> to include
<code>plugin_dependencies</code> metadata.</p>
<pre><code>[general]
name=Save Attributes
description=This plugin saves the attributes of the selected vector layer as a CSV file
version=1.0
qgisMinimumVersion=3.0
author=Ujaval Gandhi
email=ujaval@spatialthoughts.com
icon=logo.png
plugin_dependencies=qpip</code></pre>
<p>Add a new file in the plugin directory named
<code>requirements.txt</code> with the following content.</p>
<pre><code>prettyprint</code></pre>
<p>This will now prompt the user to first install the <code>qpip</code>
plugin and then present a dialog to install the Python package if it is
missing.</p>
</div>
<div id="using-symbolic-links-for-plugin-development"
class="section level2">
<h2>Using Symbolic Links for Plugin Development</h2>
<p>QGIS Plugin Manager loads plugins from the plugin directory in the
current profile. When developing QGIS plugins, you are typically working
in a different directory (mostly in a git repo) and you will have to
manually copy the code from your development directory to the plugin
directory for testing. <a
href="Creating%20Symbolic%20Links%20on%20Windows">Symbolic Links</a> are
a good solution which allow you to create soft links in the plugin
directory that point to your development directory.</p>
<div id="windows" class="section level3">
<h3>Windows</h3>
<p>You can use the <a
href="https://www.geeksforgeeks.org/creating-symbolic-links-on-windows/">MKLINK
command</a> from the Windows Command Prompt to create a link.</p>
<p>The following command will create a symbolic link folder in your
profile that points to an actual folder on the computer.</p>
<div class="sourceCode" id="cb93"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb93-1"><a href="#cb93-1" tabindex="-1"></a><span class="ex">mklink</span> /d <span class="op">&lt;</span>plugin folder path in profile<span class="op">&gt;</span> <span class="op">&lt;</span>plugin folder path in your dev environment<span class="op">&gt;</span> </span></code></pre></div>
</div>
<div id="linuxmac" class="section level3">
<h3>Linux/Mac</h3>
<p>The <a
href="https://www.hostinger.in/tutorials/how-to-create-symbolic-links-in-linux">ln
command</a> can be used to create symbolic links from a terminal.</p>
<blockquote>
<p>Note that the <code>ln</code> command is notorious for using a <a
href="https://unix.stackexchange.com/questions/541795/tips-for-remembering-the-order-of-parameters-for-ln">non-intuitive
order of the parameters</a>.</p>
</blockquote>
<div class="sourceCode" id="cb94"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb94-1"><a href="#cb94-1" tabindex="-1"></a><span class="fu">ln</span> <span class="at">-s</span> <span class="op">&lt;</span>plugin folder path in your dev environment<span class="op">&gt;</span> <span class="op">&lt;</span>plugin folder path in profile<span class="op">&gt;</span></span></code></pre></div>
<p>For example the command below creates a symlink in the plugin folder
in the default profile that points to a folder on the Desktop.</p>
<div class="sourceCode" id="cb95"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb95-1"><a href="#cb95-1" tabindex="-1"></a><span class="va">PROFILE_FOLDER</span><span class="op">=</span>/Users/ujavalgandhi/Library/Application\ Support/QGIS/QGIS3/profiles/default</span>
<span id="cb95-2"><a href="#cb95-2" tabindex="-1"></a><span class="fu">ln</span> <span class="at">-s</span> ~/Desktop/basemap_loader <span class="va">$PROFILE_FOLDER</span>/python/plugins/basemap_loader</span></code></pre></div>
<p><em><a href="#" style="float:right">Back to Top</a></em></p>
</div>
</div>
</div>
<div id="what-next" class="section level1">
<h1>What next?</h1>
<p>We have several step-by-step tutorials and guides on PyQGIS
development. You can do those tutorials to practice your skills and
build confidence.</p>
<p><strong>Tutorials</strong></p>
<ul>
<li><a
href="https://www.qgistutorials.com/en/docs/3/getting_started_with_pyqgis.html"
target="_blank">Getting Started With Python Programming</a></li>
<li><a
href="https://www.qgistutorials.com/en/docs/3/processing_algorithms_pyqgis.html"
target="_blank">Running Processing Algorithms via Python</a></li>
<li><a
href="https://www.qgistutorials.com/en/docs/3/custom_python_functions.html"
target="_blank">Using Custom Python Expression Functions</a></li>
<li><a
href="https://www.qgistutorials.com/en/docs/3/processing_python_scripts.html"
target="_blank">Writing Python Scripts for Processing Framework</a></li>
<li><a
href="https://www.qgistutorials.com/en/docs/3/building_a_python_plugin.html"
target="_blank">Building a Python Plugin</a></li>
<li><a
href="https://www.qgistutorials.com/en/docs/3/processing_python_plugin.html"
target="_blank">Building a Processing Plugin</a></li>
</ul>
<p><strong>Guides</strong></p>
<ul>
<li><a
href="https://spatialthoughts.com/2020/02/22/snap-to-roads-qgis-and-osrm/"
target="_blank">Snapping GPS tracks to Roads using PyQGIS and
OSRM</a></li>
<li><a
href="https://spatialthoughts.com/2019/04/05/geodesic-buffers-in-qgis/"
target="_blank">Approximating Geodesic Buffers with PyQGIS</a></li>
<li><a
href="https://spatialthoughts.com/2020/02/09/exporting-map-layouts/"
target="_blank">Exporting Print Layouts from Processing Scripts</a></li>
<li><a
href="https://spatialthoughts.com/2021/01/31/equal-sized-kmeans-qgis/"
target="_blank">K-Means Clustering with Equal Sized Clusters in
QGIS</a></li>
<li><a
href="https://spatialthoughts.com/2020/04/04/ndvi-time-series-gee-qgis/"
target="_blank">Creating Maps with Google Earth Engine and
PyQGIS</a></li>
</ul>
</div>
<div id="resources" class="section level1">
<h1>Resources</h1>
<ul>
<li>Official QGIS Documentation - <a
href="https://docs.qgis.org/testing/en/docs/pyqgis_developer_cookbook/"
target="_blank">PyQGIS Developer Cookbook</a></li>
<li><a
href="https://anitagraser.com/pyqgis-101-introduction-to-qgis-python-programming-for-non-programmers/"
target="_blank">PyQGIS 101: Introduction to QGIS Python programming for
non-programmers</a> by Anita Graser</li>
<li><a href="https://webgeodatavore.github.io/pyqgis-samples/"
target="_blank">PyQGIS Samples</a> by Thomas Gratier</li>
<li><a href="https://github.com/haubourg/custom-osgeo4w-qgis"
target="_blank">Deploying a Customized Version of QGIS</a> by Régis
Haubourg</li>
</ul>
</div>
<div id="data-credits" class="section level1">
<h1>Data Credits</h1>
<ul>
<li><code>blocks</code>, <code>parcels</code>, <code>streets</code>,
<code>zoning</code>, <code>trees</code>, <code>seasmic_zones</code>,
<code>shoreline</code>. Downloaded from <a
href="https://datasf.org/opendata/">DataSF Open Data Portal</a></li>
<li><code>srtm</code> NASA Shuttle Radar Topography Mission Global 1 arc
second provided by The Land Processes Distributed Active Archive Center
(LP DAAC). Downloaded using <a
href="https://dwtkns.com/srtm30m/">30-Meter SRTM Tile
Downloader</a></li>
<li><code>aoi</code>: CA Places Boundaries from 2016 TIGER/Line
Shapefiles. Downloaded from <a
href="https://data.ca.gov/dataset/ca-geographic-boundaries">California
Open Data Portal</a></li>
<li><code>populated_places</code>: Made with Natural Earth. Free vector
and raster map data @ <a
href="https://www.naturalearthdata.com/">naturalearthdata.com</a></li>
</ul>
</div>
<div id="license" class="section level1">
<h1>License</h1>
<p>This course material is licensed under a <a
href="https://creativecommons.org/licenses/by/4.0/">Creative Commons
Attribution 4.0 International (CC BY 4.0)</a>. You are free to re-use
and adapt the material but are required to give appropriate credit to
the original author as below:</p>
<p><em>Customizing QGIS with Python Course</em> by Ujaval Gandhi <a
href="https://spatialthoughts.com">www.spatialthoughts.com</a></p>
<!--
If you would like to white-label these materials as part of a commercial offering, you can purchase a *Trainer License* for a small fee. Please [contact us](https://spatialthoughts.com/contact/) for pricing and terms.


This material is part of the *Trainer's Package* and the buyer gets a non-exclusive, non-transferable, perpetual license to the material. You can fully customize and brand the materials to your requirements.
-->
<hr />
<p><strong>This course is offered as an instructor-led online class.
Visit <a href="https://spatialthoughts.com/events/">Spatial Thoughts</a>
to know details of upcoming sessions.</strong></p>
<hr />
<p>© 2020 Spatial Thoughts <a
href="https://spatialthoughts.com">www.spatialthoughts.com</a></p>
</div>
<div class="footnotes footnotes-end-of-document">
<hr />
<ol>
<li id="fn1"><p>See <a
href="https://qgis.org/api/3.4/classQgsProject.html"
class="uri">https://qgis.org/api/3.4/classQgsProject.html</a><a
href="#fnref1" class="footnote-back">↩︎</a></p></li>
</ol>
</div>

<!-- Comment Section Powered by utterances -->
<div id="comments">
  <hr />
  <p>If you want to report any issues with this page, please comment below.</p>
<script src="https://utteranc.es/client.js"
        repo="spatialthoughts/courses"
        issue-term="title"
        label="comment"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>
</div>



</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.odd').parent('tbody').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open');
  });
});
</script>

<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
