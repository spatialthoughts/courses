<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />


<meta name="author" content="Ujaval Gandhi" />


<title>End-to-End Google Earth Engine (Supplementary Course)</title>

<script src="site_libs/header-attrs-2.10/header-attrs.js"></script>
<script src="site_libs/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/flatly.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<style>h1 {font-size: 34px;}
       h1.title {font-size: 38px;}
       h2 {font-size: 30px;}
       h3 {font-size: 24px;}
       h4 {font-size: 18px;}
       h5 {font-size: 16px;}
       h6 {font-size: 12px;}
       code {color: inherit; background-color: rgba(0, 0, 0, 0.04);}
       pre:not([class]) { background-color: white }</style>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<link href="site_libs/pagedtable-1.1/css/pagedtable.css" rel="stylesheet" />
<script src="site_libs/pagedtable-1.1/js/pagedtable.js"></script>
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-PDGF11RK4Z"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-PDGF11RK4Z');
</script>

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>


<style type="text/css">
  code {
    white-space: pre;
  }
  .sourceCode {
    overflow: visible;
  }
</style>
<style type="text/css" data-origin="pandoc">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */

</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    for (var j = 0; j < rules.length; j++) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") continue;
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') continue;
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>







<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
pre code {
  padding: 0;
}
</style>


<style type="text/css">
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #adb5bd;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script type="text/javascript">
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.tab('show');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');

  // Navbar adjustments
  var navHeight = $(".navbar").first().height() + 15;
  var style = document.createElement('style');
  var pt = "padding-top: " + navHeight + "px; ";
  var mt = "margin-top: -" + navHeight + "px; ";
  var css = "";
  // offset scroll position for anchor links (for fixed navbar)
  for (var i = 1; i <= 6; i++) {
    css += ".section h" + i + "{ " + pt + mt + "}\n";
  }
  style.innerHTML = "body {" + pt + "padding-bottom: 40px; }\n" + css;
  document.head.appendChild(style);
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "&#xe258;";
  border: none;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->




</head>

<body>


<div class="container-fluid main-container">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">Courses</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="http://spatialthoughts.com">Back to Main Site</a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li>
  <a href="#">Back to Top</a>
</li>
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div id="header">



<h1 class="title toc-ignore">End-to-End Google Earth Engine
(Supplementary Course)</h1>
<h4 class="author">Ujaval Gandhi</h4>

</div>

<div id="TOC">
<ul>
<li><a href="#introduction" id="toc-introduction">Introduction</a></li>
<li><a href="#advanced-supervised-classification-techniques"
id="toc-advanced-supervised-classification-techniques">Advanced
Supervised Classification Techniques</a>
<ul>
<li><a href="#k-fold-cross-validation"
id="toc-k-fold-cross-validation">k-Fold Cross Validation</a></li>
<li><a href="#hyperparameter-tuning"
id="toc-hyperparameter-tuning">Hyperparameter Tuning</a></li>
<li><a href="#post-processing-classification-results"
id="toc-post-processing-classification-results">Post-Processing
Classification Results</a></li>
<li><a href="#principal-component-analysis-pca"
id="toc-principal-component-analysis-pca">Principal Component Analysis
(PCA)</a></li>
<li><a href="#multi-temporal-composites-for-crop-classification"
id="toc-multi-temporal-composites-for-crop-classification">Multi-temporal
Composites for Crop Classification</a></li>
<li><a href="#computing-correlation"
id="toc-computing-correlation">Computing Correlation</a></li>
<li><a href="#calculating-band-correlation-matrix"
id="toc-calculating-band-correlation-matrix">Calculating Band
Correlation Matrix</a></li>
<li><a href="#calculating-area-by-class"
id="toc-calculating-area-by-class">Calculating Area by Class</a></li>
<li><a href="#spectral-signature-plots"
id="toc-spectral-signature-plots">Spectral Signature Plots</a></li>
<li><a href="#using-polygons-for-training-data"
id="toc-using-polygons-for-training-data">Using Polygons for Training
Data</a></li>
<li><a href="#stratified-sampling-of-gcps"
id="toc-stratified-sampling-of-gcps">Stratified Sampling of
GCPs</a></li>
<li><a href="#identify-misclassified-gcps"
id="toc-identify-misclassified-gcps">Identify Misclassified
GCPs</a></li>
<li><a href="#image-normalization-and-standardization"
id="toc-image-normalization-and-standardization">Image Normalization and
Standardization</a></li>
<li><a href="#calculate-feature-importance"
id="toc-calculate-feature-importance">Calculate Feature
Importance</a></li>
<li><a href="#classification-with-migrated-training-samples"
id="toc-classification-with-migrated-training-samples">Classification
with Migrated Training Samples</a></li>
<li><a href="#time-series-modeling" id="toc-time-series-modeling">Time
Series Modeling</a></li>
<li><a href="#using-sar-data" id="toc-using-sar-data">Using SAR
data</a></li>
<li><a href="#adding-spatial-context"
id="toc-adding-spatial-context">Adding Spatial Context</a></li>
</ul></li>
<li><a href="#advanced-change-detection-techniques"
id="toc-advanced-change-detection-techniques">Advanced Change Detection
Techniques</a>
<ul>
<li><a href="#dynamic-world-time-series-chart"
id="toc-dynamic-world-time-series-chart">Dynamic World Time Series
Chart</a></li>
<li><a href="#landslide-detection-using-dynamic-world"
id="toc-landslide-detection-using-dynamic-world">Landslide Detection
using Dynamic World</a></li>
<li><a href="#urban-growth-detection-using-dynamic-world"
id="toc-urban-growth-detection-using-dynamic-world">Urban Growth
Detection using Dynamic World</a></li>
<li><a href="#conflict-mapping" id="toc-conflict-mapping">Conflict
Mapping</a></li>
</ul></li>
<li><a href="#image-collection-processing"
id="toc-image-collection-processing">Image Collection Processing</a>
<ul>
<li><a href="#aggregating-and-visualizing-imagecollections"
id="toc-aggregating-and-visualizing-imagecollections">Aggregating and
Visualizing ImageCollections</a></li>
<li><a href="#exporting-imagecollections"
id="toc-exporting-imagecollections">Exporting ImageCollections</a></li>
<li><a href="#create-composites-at-regular-intervals"
id="toc-create-composites-at-regular-intervals">Create Composites at
Regular Intervals</a></li>
<li><a href="#export-imagecollection-metadata"
id="toc-export-imagecollection-metadata">Export ImageCollection
Metadata</a></li>
<li><a href="#get-pixelwise-dates-for-composites"
id="toc-get-pixelwise-dates-for-composites">Get Pixelwise Dates for
Composites</a></li>
<li><a href="#filter-images-by-cloud-cover-in-a-region"
id="toc-filter-images-by-cloud-cover-in-a-region">Filter Images by Cloud
Cover in a Region</a></li>
<li><a href="#harmonized-landsat-time-series"
id="toc-harmonized-landsat-time-series">Harmonized Landsat Time
Series</a></li>
<li><a href="#landsat-timelapse-animation-with-text"
id="toc-landsat-timelapse-animation-with-text">Landsat Timelapse
Animation with Text</a></li>
<li><a href="#percentile-composites"
id="toc-percentile-composites">Percentile Composites</a></li>
<li><a href="#medoid-composites" id="toc-medoid-composites">Medoid
Composites</a></li>
<li><a href="#visualize-number-of-images-in-composites"
id="toc-visualize-number-of-images-in-composites">Visualize Number of
Images in Composites</a></li>
<li><a href="#visualizing-bands-of-an-image"
id="toc-visualizing-bands-of-an-image">Visualizing Bands of an
Image</a></li>
</ul></li>
<li><a href="#advanced-image-processing"
id="toc-advanced-image-processing">Advanced Image Processing</a>
<ul>
<li><a href="#working-with-landsat-collection-2"
id="toc-working-with-landsat-collection-2">Working with Landsat
Collection 2</a></li>
<li><a href="#derive-lst-from-landsat-images"
id="toc-derive-lst-from-landsat-images">Derive LST from Landsat
Images</a></li>
<li><a href="#gap-filling-of-landsat-7-slc-off-images"
id="toc-gap-filling-of-landsat-7-slc-off-images">Gap-filling of Landsat
7 SLC-Off Images</a></li>
</ul></li>
<li><a href="#user-interface-templates"
id="toc-user-interface-templates">User Interface Templates</a>
<ul>
<li><a href="#adding-a-discrete-legend"
id="toc-adding-a-discrete-legend">Adding a Discrete Legend</a></li>
<li><a href="#adding-a-continous-legend"
id="toc-adding-a-continous-legend">Adding a Continous Legend</a></li>
<li><a href="#change-visualization-ui-app"
id="toc-change-visualization-ui-app">Change Visualization UI
App</a></li>
<li><a href="#ndvi-explorer-ui-app" id="toc-ndvi-explorer-ui-app">NDVI
Explorer UI App</a></li>
<li><a href="#app-with-layer-control"
id="toc-app-with-layer-control">App with Layer Control</a></li>
</ul></li>
<li><a href="#code-sharing-and-script-modules"
id="toc-code-sharing-and-script-modules">Code Sharing and Script
Modules</a>
<ul>
<li><a href="#sharing-a-single-script"
id="toc-sharing-a-single-script">Sharing a Single Script</a></li>
<li><a href="#sharing-multiple-scripts"
id="toc-sharing-multiple-scripts">Sharing Multiple Scripts</a></li>
<li><a href="#sharing-code-between-scripts"
id="toc-sharing-code-between-scripts">Sharing Code between
Scripts</a></li>
</ul></li>
<li><a href="#license" id="toc-license">License</a></li>
<li><a href="#citing-and-referencing"
id="toc-citing-and-referencing">Citing and Referencing</a></li>
</ul>
</div>

<div style="page-break-after: always;"></div>
<hr />
<p><img src="images/spatial_thoughts_logo.png" width="250pt" style="display: block; margin: auto;" /></p>
<hr />
<div style="page-break-after: always;"></div>
<div id="introduction" class="section level1">
<h1>Introduction</h1>
<p>This page contains Supplementary Materials for the End-to-End Google
Earth Engine course. It is a collection useful scripts and code snippets
that can be adapted for your projects.</p>
<p>Please visit the <a
href="https://courses.spatialthoughts.com/end-to-end-gee.html">End-to-End
Google Earth Engine</a> course page for the full course material.</p>
</div>
<div id="advanced-supervised-classification-techniques"
class="section level1">
<h1>Advanced Supervised Classification Techniques</h1>
<div id="k-fold-cross-validation" class="section level2">
<h2>k-Fold Cross Validation</h2>
<p>In regular accuracy assessment we split the samples into 2 fractions
of training and validation. In k-fold cross validation, this step is
repeated multiple times by splitting the data into multiple subsets (i.e
folds), using one of these folds as a validation set, and training the
model on the remaining folds. This process is repeated multiple times
and the accuracy metric from each validation step is averaged to produce
a more robust estimate of the model’s performance.</p>
<div class="figure" style="text-align: center">
<img src="images/end_to_end_gee/kfold.png" alt="k-Fold Cross-Validation" width="75%" />
<p class="caption">
k-Fold Cross-Validation
</p>
</div>
<p><a
href="https://code.earthengine.google.co.in/?scriptPath=users%2Fujavalgandhi%2FEnd-to-End-GEE%3ASupplement%2FSupervised_Classification%2FKFold_Cross_Validation"
target="_blank">Open in Code Editor ↗</a></p>
<div class="sourceCode" id="cb1"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="co">// Example script for k-Fold Cross Validation </span></span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a><span class="co">// of Supervised Classification</span></span>
<span id="cb1-3"><a href="#cb1-3" tabindex="-1"></a><span class="kw">var</span> s2 <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&#39;COPERNICUS/S2_SR_HARMONIZED&#39;</span>)<span class="op">;</span></span>
<span id="cb1-4"><a href="#cb1-4" tabindex="-1"></a><span class="kw">var</span> basin <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">&quot;WWF/HydroSHEDS/v1/Basins/hybas_7&quot;</span>)<span class="op">;</span></span>
<span id="cb1-5"><a href="#cb1-5" tabindex="-1"></a><span class="kw">var</span> gcp <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">&quot;users/ujavalgandhi/e2e/arkavathy_gcps&quot;</span>)<span class="op">;</span></span>
<span id="cb1-6"><a href="#cb1-6" tabindex="-1"></a><span class="kw">var</span> composite <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(<span class="st">&#39;users/ujavalgandhi/e2e/arkavathy_multiband_composite&#39;</span>)<span class="op">;</span></span>
<span id="cb1-7"><a href="#cb1-7" tabindex="-1"></a></span>
<span id="cb1-8"><a href="#cb1-8" tabindex="-1"></a><span class="co">// Function to split a featurecollection into k-folds</span></span>
<span id="cb1-9"><a href="#cb1-9" tabindex="-1"></a><span class="kw">var</span> kFoldSplit <span class="op">=</span> <span class="kw">function</span>(features<span class="op">,</span> folds) {</span>
<span id="cb1-10"><a href="#cb1-10" tabindex="-1"></a>    <span class="kw">var</span> step <span class="op">=</span> ee<span class="op">.</span><span class="fu">Number</span>(<span class="dv">1</span>)<span class="op">.</span><span class="fu">divide</span>(folds)<span class="op">;</span></span>
<span id="cb1-11"><a href="#cb1-11" tabindex="-1"></a>    <span class="kw">var</span> thresholds <span class="op">=</span> ee<span class="op">.</span><span class="at">List</span><span class="op">.</span><span class="fu">sequence</span>(</span>
<span id="cb1-12"><a href="#cb1-12" tabindex="-1"></a>        <span class="dv">0</span><span class="op">,</span> ee<span class="op">.</span><span class="fu">Number</span>(<span class="dv">1</span>)<span class="op">.</span><span class="fu">subtract</span>(step)<span class="op">,</span> step)<span class="op">;</span></span>
<span id="cb1-13"><a href="#cb1-13" tabindex="-1"></a></span>
<span id="cb1-14"><a href="#cb1-14" tabindex="-1"></a>    <span class="co">// Use seed so the distribution is stable across</span></span>
<span id="cb1-15"><a href="#cb1-15" tabindex="-1"></a>    <span class="co">// all calls of the function</span></span>
<span id="cb1-16"><a href="#cb1-16" tabindex="-1"></a>    features <span class="op">=</span> features<span class="op">.</span><span class="fu">randomColumn</span>({<span class="dt">seed</span><span class="op">:</span> <span class="dv">0</span>})<span class="op">;</span></span>
<span id="cb1-17"><a href="#cb1-17" tabindex="-1"></a></span>
<span id="cb1-18"><a href="#cb1-18" tabindex="-1"></a>    <span class="kw">var</span> splits <span class="op">=</span> thresholds<span class="op">.</span><span class="fu">map</span>(<span class="kw">function</span> (threshold) {</span>
<span id="cb1-19"><a href="#cb1-19" tabindex="-1"></a>      <span class="kw">var</span> trainingSplit <span class="op">=</span> features<span class="op">.</span><span class="fu">filter</span>(</span>
<span id="cb1-20"><a href="#cb1-20" tabindex="-1"></a>          ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">or</span>(</span>
<span id="cb1-21"><a href="#cb1-21" tabindex="-1"></a>            ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">lt</span>(<span class="st">&#39;random&#39;</span><span class="op">,</span> threshold)<span class="op">,</span></span>
<span id="cb1-22"><a href="#cb1-22" tabindex="-1"></a>            ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">gte</span>(<span class="st">&#39;random&#39;</span><span class="op">,</span> ee<span class="op">.</span><span class="fu">Number</span>(threshold)<span class="op">.</span><span class="fu">add</span>(step))</span>
<span id="cb1-23"><a href="#cb1-23" tabindex="-1"></a>            )</span>
<span id="cb1-24"><a href="#cb1-24" tabindex="-1"></a>        )<span class="op">;</span></span>
<span id="cb1-25"><a href="#cb1-25" tabindex="-1"></a>      <span class="kw">var</span> validationSplit <span class="op">=</span> features<span class="op">.</span><span class="fu">filter</span>(</span>
<span id="cb1-26"><a href="#cb1-26" tabindex="-1"></a>          ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">and</span>(</span>
<span id="cb1-27"><a href="#cb1-27" tabindex="-1"></a>            ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">gt</span>(<span class="st">&#39;random&#39;</span><span class="op">,</span> threshold)<span class="op">,</span></span>
<span id="cb1-28"><a href="#cb1-28" tabindex="-1"></a>            ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">lte</span>(<span class="st">&#39;random&#39;</span><span class="op">,</span> ee<span class="op">.</span><span class="fu">Number</span>(threshold)<span class="op">.</span><span class="fu">add</span>(step))</span>
<span id="cb1-29"><a href="#cb1-29" tabindex="-1"></a>            )</span>
<span id="cb1-30"><a href="#cb1-30" tabindex="-1"></a>      )</span>
<span id="cb1-31"><a href="#cb1-31" tabindex="-1"></a>      <span class="cf">return</span> ee<span class="op">.</span><span class="fu">Feature</span>(<span class="kw">null</span><span class="op">,</span> {</span>
<span id="cb1-32"><a href="#cb1-32" tabindex="-1"></a>        <span class="st">&#39;training&#39;</span><span class="op">:</span> trainingSplit<span class="op">,</span></span>
<span id="cb1-33"><a href="#cb1-33" tabindex="-1"></a>        <span class="st">&#39;validation&#39;</span><span class="op">:</span> validationSplit</span>
<span id="cb1-34"><a href="#cb1-34" tabindex="-1"></a>      })<span class="op">;</span></span>
<span id="cb1-35"><a href="#cb1-35" tabindex="-1"></a>    </span>
<span id="cb1-36"><a href="#cb1-36" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb1-37"><a href="#cb1-37" tabindex="-1"></a>    <span class="cf">return</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(splits)<span class="op">;</span></span>
<span id="cb1-38"><a href="#cb1-38" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb1-39"><a href="#cb1-39" tabindex="-1"></a></span>
<span id="cb1-40"><a href="#cb1-40" tabindex="-1"></a><span class="co">// Use k=10</span></span>
<span id="cb1-41"><a href="#cb1-41" tabindex="-1"></a><span class="kw">var</span> folds <span class="op">=</span> <span class="fu">kFoldSplit</span>(gcp<span class="op">,</span> <span class="dv">10</span>)<span class="op">;</span></span>
<span id="cb1-42"><a href="#cb1-42" tabindex="-1"></a></span>
<span id="cb1-43"><a href="#cb1-43" tabindex="-1"></a><span class="co">// Check the split</span></span>
<span id="cb1-44"><a href="#cb1-44" tabindex="-1"></a><span class="fu">print</span>(<span class="st">&#39;Fold 0 Training Samples&#39;</span><span class="op">,</span> folds<span class="op">.</span><span class="fu">first</span>()<span class="op">.</span><span class="fu">get</span>(<span class="st">&#39;training&#39;</span>))<span class="op">;</span></span>
<span id="cb1-45"><a href="#cb1-45" tabindex="-1"></a><span class="fu">print</span>(<span class="st">&#39;Fold 0 Validation Samples&#39;</span><span class="op">,</span> folds<span class="op">.</span><span class="fu">first</span>()<span class="op">.</span><span class="fu">get</span>(<span class="st">&#39;validation&#39;</span>))<span class="op">;</span></span>
<span id="cb1-46"><a href="#cb1-46" tabindex="-1"></a></span>
<span id="cb1-47"><a href="#cb1-47" tabindex="-1"></a><span class="co">// Assess the accuracy for each pair of training and validation</span></span>
<span id="cb1-48"><a href="#cb1-48" tabindex="-1"></a></span>
<span id="cb1-49"><a href="#cb1-49" tabindex="-1"></a><span class="kw">var</span> accuracies <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(folds<span class="op">.</span><span class="fu">map</span>(<span class="kw">function</span>(fold) {</span>
<span id="cb1-50"><a href="#cb1-50" tabindex="-1"></a>  <span class="kw">var</span> trainingGcp <span class="op">=</span> fold<span class="op">.</span><span class="fu">get</span>(<span class="st">&#39;training&#39;</span>)<span class="op">;</span></span>
<span id="cb1-51"><a href="#cb1-51" tabindex="-1"></a>  <span class="kw">var</span> validationGcp <span class="op">=</span> fold<span class="op">.</span><span class="fu">get</span>(<span class="st">&#39;validation&#39;</span>)<span class="op">;</span></span>
<span id="cb1-52"><a href="#cb1-52" tabindex="-1"></a>  <span class="co">// Overlay the point on the image to get training data.</span></span>
<span id="cb1-53"><a href="#cb1-53" tabindex="-1"></a>  <span class="kw">var</span> training <span class="op">=</span> composite<span class="op">.</span><span class="fu">sampleRegions</span>({</span>
<span id="cb1-54"><a href="#cb1-54" tabindex="-1"></a>    <span class="dt">collection</span><span class="op">:</span> trainingGcp<span class="op">,</span></span>
<span id="cb1-55"><a href="#cb1-55" tabindex="-1"></a>    <span class="dt">properties</span><span class="op">:</span> [<span class="st">&#39;landcover&#39;</span>]<span class="op">,</span></span>
<span id="cb1-56"><a href="#cb1-56" tabindex="-1"></a>    <span class="dt">scale</span><span class="op">:</span> <span class="dv">10</span><span class="op">,</span></span>
<span id="cb1-57"><a href="#cb1-57" tabindex="-1"></a>    <span class="dt">tileScale</span><span class="op">:</span> <span class="dv">16</span></span>
<span id="cb1-58"><a href="#cb1-58" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb1-59"><a href="#cb1-59" tabindex="-1"></a></span>
<span id="cb1-60"><a href="#cb1-60" tabindex="-1"></a>  <span class="co">// Train a classifier.</span></span>
<span id="cb1-61"><a href="#cb1-61" tabindex="-1"></a>  <span class="kw">var</span> classifier <span class="op">=</span> ee<span class="op">.</span><span class="at">Classifier</span><span class="op">.</span><span class="fu">smileRandomForest</span>(<span class="dv">50</span>)</span>
<span id="cb1-62"><a href="#cb1-62" tabindex="-1"></a>  <span class="op">.</span><span class="fu">train</span>({</span>
<span id="cb1-63"><a href="#cb1-63" tabindex="-1"></a>    <span class="dt">features</span><span class="op">:</span> training<span class="op">,</span>  </span>
<span id="cb1-64"><a href="#cb1-64" tabindex="-1"></a>    <span class="dt">classProperty</span><span class="op">:</span> <span class="st">&#39;landcover&#39;</span><span class="op">,</span></span>
<span id="cb1-65"><a href="#cb1-65" tabindex="-1"></a>    <span class="dt">inputProperties</span><span class="op">:</span> composite<span class="op">.</span><span class="fu">bandNames</span>()</span>
<span id="cb1-66"><a href="#cb1-66" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb1-67"><a href="#cb1-67" tabindex="-1"></a>  </span>
<span id="cb1-68"><a href="#cb1-68" tabindex="-1"></a>  <span class="kw">var</span> test <span class="op">=</span> composite<span class="op">.</span><span class="fu">sampleRegions</span>({</span>
<span id="cb1-69"><a href="#cb1-69" tabindex="-1"></a>    <span class="dt">collection</span><span class="op">:</span> validationGcp<span class="op">,</span></span>
<span id="cb1-70"><a href="#cb1-70" tabindex="-1"></a>    <span class="dt">properties</span><span class="op">:</span> [<span class="st">&#39;landcover&#39;</span>]<span class="op">,</span></span>
<span id="cb1-71"><a href="#cb1-71" tabindex="-1"></a>    <span class="dt">scale</span><span class="op">:</span> <span class="dv">10</span><span class="op">,</span></span>
<span id="cb1-72"><a href="#cb1-72" tabindex="-1"></a>    <span class="dt">tileScale</span><span class="op">:</span> <span class="dv">16</span></span>
<span id="cb1-73"><a href="#cb1-73" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb1-74"><a href="#cb1-74" tabindex="-1"></a>  </span>
<span id="cb1-75"><a href="#cb1-75" tabindex="-1"></a>  <span class="kw">var</span> accuracy <span class="op">=</span> test</span>
<span id="cb1-76"><a href="#cb1-76" tabindex="-1"></a>    <span class="op">.</span><span class="fu">classify</span>(classifier)</span>
<span id="cb1-77"><a href="#cb1-77" tabindex="-1"></a>    <span class="op">.</span><span class="fu">errorMatrix</span>(<span class="st">&#39;landcover&#39;</span><span class="op">,</span> <span class="st">&#39;classification&#39;</span>)</span>
<span id="cb1-78"><a href="#cb1-78" tabindex="-1"></a>    <span class="op">.</span><span class="fu">accuracy</span>()<span class="op">;</span></span>
<span id="cb1-79"><a href="#cb1-79" tabindex="-1"></a>  </span>
<span id="cb1-80"><a href="#cb1-80" tabindex="-1"></a>  <span class="cf">return</span> ee<span class="op">.</span><span class="fu">Feature</span>(<span class="kw">null</span><span class="op">,</span> {<span class="st">&#39;accuracy&#39;</span><span class="op">:</span> accuracy})<span class="op">;</span></span>
<span id="cb1-81"><a href="#cb1-81" tabindex="-1"></a>}))<span class="op">;</span></span>
<span id="cb1-82"><a href="#cb1-82" tabindex="-1"></a></span>
<span id="cb1-83"><a href="#cb1-83" tabindex="-1"></a><span class="fu">print</span>(<span class="st">&#39;K-fold Validation Results&#39;</span><span class="op">,</span> </span>
<span id="cb1-84"><a href="#cb1-84" tabindex="-1"></a>  accuracies<span class="op">.</span><span class="fu">aggregate_array</span>(<span class="st">&#39;accuracy&#39;</span>))<span class="op">;</span></span>
<span id="cb1-85"><a href="#cb1-85" tabindex="-1"></a></span>
<span id="cb1-86"><a href="#cb1-86" tabindex="-1"></a><span class="kw">var</span> meanAccuracy <span class="op">=</span> accuracies<span class="op">.</span><span class="fu">reduceColumns</span>({</span>
<span id="cb1-87"><a href="#cb1-87" tabindex="-1"></a>  <span class="dt">reducer</span><span class="op">:</span> ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">mean</span>()<span class="op">,</span></span>
<span id="cb1-88"><a href="#cb1-88" tabindex="-1"></a>  <span class="dt">selectors</span><span class="op">:</span> [<span class="st">&#39;accuracy&#39;</span>]})<span class="op">;</span></span>
<span id="cb1-89"><a href="#cb1-89" tabindex="-1"></a><span class="fu">print</span>(<span class="st">&#39;Mean Accuracy&#39;</span><span class="op">,</span> meanAccuracy<span class="op">.</span><span class="fu">get</span>(<span class="st">&#39;mean&#39;</span>))<span class="op">;</span></span></code></pre></div>
</div>
<div id="hyperparameter-tuning" class="section level2">
<h2>Hyperparameter Tuning</h2>
<p>A recommended best practice for improving the accuracy of your
machine learning model is to tune different parameters. For example,
when using the <code>ee.Classifier.smileRandomForest()</code>
classifier, we must specify the <em>Number of Trees</em>. We know that
higher number of trees result in more computation requirement, but it
doesn’t necessarily result in better results. Instead of guessing, we
programmatically try a range of values and choose the smallest value
possible that results in the highest accuracy.</p>
<div class="figure" style="text-align: center">
<img src="images/end_to_end_gee/hyperparameter_tuning.png" alt="Supervised Classification Output" width="75%" />
<p class="caption">
Supervised Classification Output
</p>
</div>
<p><a
href="https://code.earthengine.google.co.in/?scriptPath=users%2Fujavalgandhi%2FEnd-to-End-GEE%3ASupplement%2FSupervised_Classification%2FHyperparameter_Tuning"
target="_blank">Open in Code Editor ↗</a></p>
<div class="sourceCode" id="cb2"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a><span class="kw">var</span> s2 <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&#39;COPERNICUS/S2_SR_HARMONIZED&#39;</span>)<span class="op">;</span></span>
<span id="cb2-2"><a href="#cb2-2" tabindex="-1"></a><span class="kw">var</span> basin <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">&#39;WWF/HydroSHEDS/v1/Basins/hybas_7&#39;</span>)<span class="op">;</span></span>
<span id="cb2-3"><a href="#cb2-3" tabindex="-1"></a><span class="kw">var</span> gcp <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">&#39;users/ujavalgandhi/e2e/arkavathy_gcps&#39;</span>)<span class="op">;</span></span>
<span id="cb2-4"><a href="#cb2-4" tabindex="-1"></a><span class="kw">var</span> alos <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&#39;JAXA/ALOS/AW3D30/V3_2&#39;</span>)<span class="op">;</span></span>
<span id="cb2-5"><a href="#cb2-5" tabindex="-1"></a></span>
<span id="cb2-6"><a href="#cb2-6" tabindex="-1"></a><span class="kw">var</span> arkavathy <span class="op">=</span> basin<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;HYBAS_ID&#39;</span><span class="op">,</span> <span class="dv">4071139640</span>))<span class="op">;</span></span>
<span id="cb2-7"><a href="#cb2-7" tabindex="-1"></a><span class="kw">var</span> geometry <span class="op">=</span> arkavathy<span class="op">.</span><span class="fu">geometry</span>()<span class="op">;</span></span>
<span id="cb2-8"><a href="#cb2-8" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">centerObject</span>(geometry)<span class="op">;</span></span>
<span id="cb2-9"><a href="#cb2-9" tabindex="-1"></a></span>
<span id="cb2-10"><a href="#cb2-10" tabindex="-1"></a><span class="co">// Load the Composite</span></span>
<span id="cb2-11"><a href="#cb2-11" tabindex="-1"></a><span class="co">// This was Exported as an Asset previously</span></span>
<span id="cb2-12"><a href="#cb2-12" tabindex="-1"></a><span class="kw">var</span> composite <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(<span class="st">&#39;users/ujavalgandhi/e2e/arkavathy_multiband_composite&#39;</span>)<span class="op">;</span></span>
<span id="cb2-13"><a href="#cb2-13" tabindex="-1"></a><span class="kw">var</span> visParams <span class="op">=</span> {<span class="dt">bands</span><span class="op">:</span> [<span class="st">&#39;B4&#39;</span><span class="op">,</span> <span class="st">&#39;B3&#39;</span><span class="op">,</span> <span class="st">&#39;B2&#39;</span>]<span class="op">,</span> <span class="dt">min</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span> <span class="dv">3000</span><span class="op">,</span> <span class="dt">gamma</span><span class="op">:</span> <span class="fl">1.2</span>}<span class="op">;</span></span>
<span id="cb2-14"><a href="#cb2-14" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(composite<span class="op">.</span><span class="fu">clip</span>(geometry)<span class="op">,</span> visParams<span class="op">,</span> <span class="st">&#39;RGB&#39;</span>)<span class="op">;</span></span>
<span id="cb2-15"><a href="#cb2-15" tabindex="-1"></a></span>
<span id="cb2-16"><a href="#cb2-16" tabindex="-1"></a><span class="co">// Normalize the image </span></span>
<span id="cb2-17"><a href="#cb2-17" tabindex="-1"></a></span>
<span id="cb2-18"><a href="#cb2-18" tabindex="-1"></a><span class="co">// Machine learning algorithms work best on images when all features have</span></span>
<span id="cb2-19"><a href="#cb2-19" tabindex="-1"></a><span class="co">// the same range</span></span>
<span id="cb2-20"><a href="#cb2-20" tabindex="-1"></a></span>
<span id="cb2-21"><a href="#cb2-21" tabindex="-1"></a><span class="co">// Function to Normalize Image</span></span>
<span id="cb2-22"><a href="#cb2-22" tabindex="-1"></a><span class="co">// Pixel Values should be between 0 and 1</span></span>
<span id="cb2-23"><a href="#cb2-23" tabindex="-1"></a><span class="co">// Formula is (x - xmin) / (xmax - xmin)</span></span>
<span id="cb2-24"><a href="#cb2-24" tabindex="-1"></a><span class="co">//************************************************************************** </span></span>
<span id="cb2-25"><a href="#cb2-25" tabindex="-1"></a><span class="kw">function</span> <span class="fu">normalize</span>(image){</span>
<span id="cb2-26"><a href="#cb2-26" tabindex="-1"></a>  <span class="kw">var</span> bandNames <span class="op">=</span> image<span class="op">.</span><span class="fu">bandNames</span>()<span class="op">;</span></span>
<span id="cb2-27"><a href="#cb2-27" tabindex="-1"></a>  <span class="co">// Compute min and max of the image</span></span>
<span id="cb2-28"><a href="#cb2-28" tabindex="-1"></a>  <span class="kw">var</span> minDict <span class="op">=</span> image<span class="op">.</span><span class="fu">reduceRegion</span>({</span>
<span id="cb2-29"><a href="#cb2-29" tabindex="-1"></a>    <span class="dt">reducer</span><span class="op">:</span> ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">min</span>()<span class="op">,</span></span>
<span id="cb2-30"><a href="#cb2-30" tabindex="-1"></a>    <span class="dt">geometry</span><span class="op">:</span> geometry<span class="op">,</span></span>
<span id="cb2-31"><a href="#cb2-31" tabindex="-1"></a>    <span class="dt">scale</span><span class="op">:</span> <span class="dv">10</span><span class="op">,</span></span>
<span id="cb2-32"><a href="#cb2-32" tabindex="-1"></a>    <span class="dt">maxPixels</span><span class="op">:</span> <span class="fl">1e9</span><span class="op">,</span></span>
<span id="cb2-33"><a href="#cb2-33" tabindex="-1"></a>    <span class="dt">bestEffort</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb2-34"><a href="#cb2-34" tabindex="-1"></a>    <span class="dt">tileScale</span><span class="op">:</span> <span class="dv">16</span></span>
<span id="cb2-35"><a href="#cb2-35" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb2-36"><a href="#cb2-36" tabindex="-1"></a>  <span class="kw">var</span> maxDict <span class="op">=</span> image<span class="op">.</span><span class="fu">reduceRegion</span>({</span>
<span id="cb2-37"><a href="#cb2-37" tabindex="-1"></a>    <span class="dt">reducer</span><span class="op">:</span> ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">max</span>()<span class="op">,</span></span>
<span id="cb2-38"><a href="#cb2-38" tabindex="-1"></a>    <span class="dt">geometry</span><span class="op">:</span> geometry<span class="op">,</span></span>
<span id="cb2-39"><a href="#cb2-39" tabindex="-1"></a>    <span class="dt">scale</span><span class="op">:</span> <span class="dv">10</span><span class="op">,</span></span>
<span id="cb2-40"><a href="#cb2-40" tabindex="-1"></a>    <span class="dt">maxPixels</span><span class="op">:</span> <span class="fl">1e9</span><span class="op">,</span></span>
<span id="cb2-41"><a href="#cb2-41" tabindex="-1"></a>    <span class="dt">bestEffort</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb2-42"><a href="#cb2-42" tabindex="-1"></a>    <span class="dt">tileScale</span><span class="op">:</span> <span class="dv">16</span></span>
<span id="cb2-43"><a href="#cb2-43" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb2-44"><a href="#cb2-44" tabindex="-1"></a>  <span class="kw">var</span> mins <span class="op">=</span> ee<span class="op">.</span><span class="at">Image</span><span class="op">.</span><span class="fu">constant</span>(minDict<span class="op">.</span><span class="fu">values</span>(bandNames))<span class="op">;</span></span>
<span id="cb2-45"><a href="#cb2-45" tabindex="-1"></a>  <span class="kw">var</span> maxs <span class="op">=</span> ee<span class="op">.</span><span class="at">Image</span><span class="op">.</span><span class="fu">constant</span>(maxDict<span class="op">.</span><span class="fu">values</span>(bandNames))<span class="op">;</span></span>
<span id="cb2-46"><a href="#cb2-46" tabindex="-1"></a></span>
<span id="cb2-47"><a href="#cb2-47" tabindex="-1"></a>  <span class="kw">var</span> normalized <span class="op">=</span> image<span class="op">.</span><span class="fu">subtract</span>(mins)<span class="op">.</span><span class="fu">divide</span>(maxs<span class="op">.</span><span class="fu">subtract</span>(mins))<span class="op">;</span></span>
<span id="cb2-48"><a href="#cb2-48" tabindex="-1"></a>  <span class="cf">return</span> normalized<span class="op">;</span></span>
<span id="cb2-49"><a href="#cb2-49" tabindex="-1"></a>}</span>
<span id="cb2-50"><a href="#cb2-50" tabindex="-1"></a></span>
<span id="cb2-51"><a href="#cb2-51" tabindex="-1"></a><span class="kw">var</span> composite <span class="op">=</span> <span class="fu">normalize</span>(composite)<span class="op">;</span></span>
<span id="cb2-52"><a href="#cb2-52" tabindex="-1"></a><span class="co">// Add a random column and split the GCPs into training and validation set</span></span>
<span id="cb2-53"><a href="#cb2-53" tabindex="-1"></a><span class="kw">var</span> gcp <span class="op">=</span> gcp<span class="op">.</span><span class="fu">randomColumn</span>()<span class="op">;</span></span>
<span id="cb2-54"><a href="#cb2-54" tabindex="-1"></a></span>
<span id="cb2-55"><a href="#cb2-55" tabindex="-1"></a><span class="co">// This being a simpler classification, we take 60% points</span></span>
<span id="cb2-56"><a href="#cb2-56" tabindex="-1"></a><span class="co">// for validation. Normal recommended ratio is</span></span>
<span id="cb2-57"><a href="#cb2-57" tabindex="-1"></a><span class="co">// 70% training, 30% validation</span></span>
<span id="cb2-58"><a href="#cb2-58" tabindex="-1"></a><span class="kw">var</span> trainingGcp <span class="op">=</span> gcp<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">lt</span>(<span class="st">&#39;random&#39;</span><span class="op">,</span> <span class="fl">0.6</span>))<span class="op">;</span></span>
<span id="cb2-59"><a href="#cb2-59" tabindex="-1"></a><span class="kw">var</span> validationGcp <span class="op">=</span> gcp<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">gte</span>(<span class="st">&#39;random&#39;</span><span class="op">,</span> <span class="fl">0.6</span>))<span class="op">;</span></span>
<span id="cb2-60"><a href="#cb2-60" tabindex="-1"></a></span>
<span id="cb2-61"><a href="#cb2-61" tabindex="-1"></a><span class="co">// Overlay the point on the image to get training data.</span></span>
<span id="cb2-62"><a href="#cb2-62" tabindex="-1"></a><span class="kw">var</span> training <span class="op">=</span> composite<span class="op">.</span><span class="fu">sampleRegions</span>({</span>
<span id="cb2-63"><a href="#cb2-63" tabindex="-1"></a>  <span class="dt">collection</span><span class="op">:</span> trainingGcp<span class="op">,</span></span>
<span id="cb2-64"><a href="#cb2-64" tabindex="-1"></a>  <span class="dt">properties</span><span class="op">:</span> [<span class="st">&#39;landcover&#39;</span>]<span class="op">,</span></span>
<span id="cb2-65"><a href="#cb2-65" tabindex="-1"></a>  <span class="dt">scale</span><span class="op">:</span> <span class="dv">10</span><span class="op">,</span></span>
<span id="cb2-66"><a href="#cb2-66" tabindex="-1"></a>  <span class="dt">tileScale</span><span class="op">:</span> <span class="dv">16</span></span>
<span id="cb2-67"><a href="#cb2-67" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb2-68"><a href="#cb2-68" tabindex="-1"></a><span class="fu">print</span>(training)<span class="op">;</span></span>
<span id="cb2-69"><a href="#cb2-69" tabindex="-1"></a></span>
<span id="cb2-70"><a href="#cb2-70" tabindex="-1"></a><span class="co">// Train a classifier.</span></span>
<span id="cb2-71"><a href="#cb2-71" tabindex="-1"></a><span class="kw">var</span> classifier <span class="op">=</span> ee<span class="op">.</span><span class="at">Classifier</span><span class="op">.</span><span class="fu">smileRandomForest</span>(<span class="dv">50</span>)</span>
<span id="cb2-72"><a href="#cb2-72" tabindex="-1"></a><span class="op">.</span><span class="fu">train</span>({</span>
<span id="cb2-73"><a href="#cb2-73" tabindex="-1"></a>  <span class="dt">features</span><span class="op">:</span> training<span class="op">,</span>  </span>
<span id="cb2-74"><a href="#cb2-74" tabindex="-1"></a>  <span class="dt">classProperty</span><span class="op">:</span> <span class="st">&#39;landcover&#39;</span><span class="op">,</span></span>
<span id="cb2-75"><a href="#cb2-75" tabindex="-1"></a>  <span class="dt">inputProperties</span><span class="op">:</span> composite<span class="op">.</span><span class="fu">bandNames</span>()</span>
<span id="cb2-76"><a href="#cb2-76" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb2-77"><a href="#cb2-77" tabindex="-1"></a></span>
<span id="cb2-78"><a href="#cb2-78" tabindex="-1"></a></span>
<span id="cb2-79"><a href="#cb2-79" tabindex="-1"></a><span class="co">//************************************************************************** </span></span>
<span id="cb2-80"><a href="#cb2-80" tabindex="-1"></a><span class="co">// Feature Importance</span></span>
<span id="cb2-81"><a href="#cb2-81" tabindex="-1"></a><span class="co">//************************************************************************** </span></span>
<span id="cb2-82"><a href="#cb2-82" tabindex="-1"></a></span>
<span id="cb2-83"><a href="#cb2-83" tabindex="-1"></a><span class="co">// Run .explain() to see what the classifer looks like</span></span>
<span id="cb2-84"><a href="#cb2-84" tabindex="-1"></a><span class="fu">print</span>(classifier<span class="op">.</span><span class="fu">explain</span>())<span class="op">;</span></span>
<span id="cb2-85"><a href="#cb2-85" tabindex="-1"></a></span>
<span id="cb2-86"><a href="#cb2-86" tabindex="-1"></a><span class="co">// Calculate variable importance</span></span>
<span id="cb2-87"><a href="#cb2-87" tabindex="-1"></a><span class="kw">var</span> importance <span class="op">=</span> ee<span class="op">.</span><span class="fu">Dictionary</span>(classifier<span class="op">.</span><span class="fu">explain</span>()<span class="op">.</span><span class="fu">get</span>(<span class="st">&#39;importance&#39;</span>))<span class="op">;</span></span>
<span id="cb2-88"><a href="#cb2-88" tabindex="-1"></a></span>
<span id="cb2-89"><a href="#cb2-89" tabindex="-1"></a><span class="co">// Calculate relative importance</span></span>
<span id="cb2-90"><a href="#cb2-90" tabindex="-1"></a><span class="kw">var</span> sum <span class="op">=</span> importance<span class="op">.</span><span class="fu">values</span>()<span class="op">.</span><span class="fu">reduce</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">sum</span>())<span class="op">;</span></span>
<span id="cb2-91"><a href="#cb2-91" tabindex="-1"></a></span>
<span id="cb2-92"><a href="#cb2-92" tabindex="-1"></a><span class="kw">var</span> relativeImportance <span class="op">=</span> importance<span class="op">.</span><span class="fu">map</span>(<span class="kw">function</span>(key<span class="op">,</span> val) {</span>
<span id="cb2-93"><a href="#cb2-93" tabindex="-1"></a>   <span class="cf">return</span> (ee<span class="op">.</span><span class="fu">Number</span>(val)<span class="op">.</span><span class="fu">multiply</span>(<span class="dv">100</span>))<span class="op">.</span><span class="fu">divide</span>(sum)<span class="op">;</span></span>
<span id="cb2-94"><a href="#cb2-94" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb2-95"><a href="#cb2-95" tabindex="-1"></a><span class="fu">print</span>(relativeImportance)<span class="op">;</span></span>
<span id="cb2-96"><a href="#cb2-96" tabindex="-1"></a></span>
<span id="cb2-97"><a href="#cb2-97" tabindex="-1"></a><span class="co">// Create a FeatureCollection so we can chart it</span></span>
<span id="cb2-98"><a href="#cb2-98" tabindex="-1"></a><span class="kw">var</span> importanceFc <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>([</span>
<span id="cb2-99"><a href="#cb2-99" tabindex="-1"></a>  ee<span class="op">.</span><span class="fu">Feature</span>(<span class="kw">null</span><span class="op">,</span> relativeImportance)</span>
<span id="cb2-100"><a href="#cb2-100" tabindex="-1"></a>])<span class="op">;</span></span>
<span id="cb2-101"><a href="#cb2-101" tabindex="-1"></a></span>
<span id="cb2-102"><a href="#cb2-102" tabindex="-1"></a><span class="kw">var</span> chart <span class="op">=</span> ui<span class="op">.</span><span class="at">Chart</span><span class="op">.</span><span class="at">feature</span><span class="op">.</span><span class="fu">byProperty</span>({</span>
<span id="cb2-103"><a href="#cb2-103" tabindex="-1"></a>  <span class="dt">features</span><span class="op">:</span> importanceFc</span>
<span id="cb2-104"><a href="#cb2-104" tabindex="-1"></a>})<span class="op">.</span><span class="fu">setOptions</span>({</span>
<span id="cb2-105"><a href="#cb2-105" tabindex="-1"></a>      <span class="dt">title</span><span class="op">:</span> <span class="st">&#39;Feature Importance&#39;</span><span class="op">,</span></span>
<span id="cb2-106"><a href="#cb2-106" tabindex="-1"></a>      <span class="dt">vAxis</span><span class="op">:</span> {<span class="dt">title</span><span class="op">:</span> <span class="st">&#39;Importance&#39;</span>}<span class="op">,</span></span>
<span id="cb2-107"><a href="#cb2-107" tabindex="-1"></a>      <span class="dt">hAxis</span><span class="op">:</span> {<span class="dt">title</span><span class="op">:</span> <span class="st">&#39;Feature&#39;</span>}</span>
<span id="cb2-108"><a href="#cb2-108" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb2-109"><a href="#cb2-109" tabindex="-1"></a><span class="fu">print</span>(chart)<span class="op">;</span></span>
<span id="cb2-110"><a href="#cb2-110" tabindex="-1"></a></span>
<span id="cb2-111"><a href="#cb2-111" tabindex="-1"></a><span class="co">//************************************************************************** </span></span>
<span id="cb2-112"><a href="#cb2-112" tabindex="-1"></a><span class="co">// Hyperparameter Tuning</span></span>
<span id="cb2-113"><a href="#cb2-113" tabindex="-1"></a><span class="co">//************************************************************************** </span></span>
<span id="cb2-114"><a href="#cb2-114" tabindex="-1"></a></span>
<span id="cb2-115"><a href="#cb2-115" tabindex="-1"></a><span class="kw">var</span> test <span class="op">=</span> composite<span class="op">.</span><span class="fu">sampleRegions</span>({</span>
<span id="cb2-116"><a href="#cb2-116" tabindex="-1"></a>  <span class="dt">collection</span><span class="op">:</span> validationGcp<span class="op">,</span></span>
<span id="cb2-117"><a href="#cb2-117" tabindex="-1"></a>  <span class="dt">properties</span><span class="op">:</span> [<span class="st">&#39;landcover&#39;</span>]<span class="op">,</span></span>
<span id="cb2-118"><a href="#cb2-118" tabindex="-1"></a>  <span class="dt">scale</span><span class="op">:</span> <span class="dv">10</span><span class="op">,</span></span>
<span id="cb2-119"><a href="#cb2-119" tabindex="-1"></a>  <span class="dt">tileScale</span><span class="op">:</span> <span class="dv">16</span></span>
<span id="cb2-120"><a href="#cb2-120" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb2-121"><a href="#cb2-121" tabindex="-1"></a></span>
<span id="cb2-122"><a href="#cb2-122" tabindex="-1"></a></span>
<span id="cb2-123"><a href="#cb2-123" tabindex="-1"></a><span class="co">// Tune the numberOfTrees parameter.</span></span>
<span id="cb2-124"><a href="#cb2-124" tabindex="-1"></a><span class="kw">var</span> numTreesList <span class="op">=</span> ee<span class="op">.</span><span class="at">List</span><span class="op">.</span><span class="fu">sequence</span>(<span class="dv">10</span><span class="op">,</span> <span class="dv">150</span><span class="op">,</span> <span class="dv">10</span>)<span class="op">;</span></span>
<span id="cb2-125"><a href="#cb2-125" tabindex="-1"></a></span>
<span id="cb2-126"><a href="#cb2-126" tabindex="-1"></a><span class="kw">var</span> accuracies <span class="op">=</span> numTreesList<span class="op">.</span><span class="fu">map</span>(<span class="kw">function</span>(numTrees) {</span>
<span id="cb2-127"><a href="#cb2-127" tabindex="-1"></a>  <span class="kw">var</span> classifier <span class="op">=</span> ee<span class="op">.</span><span class="at">Classifier</span><span class="op">.</span><span class="fu">smileRandomForest</span>(numTrees)</span>
<span id="cb2-128"><a href="#cb2-128" tabindex="-1"></a>      <span class="op">.</span><span class="fu">train</span>({</span>
<span id="cb2-129"><a href="#cb2-129" tabindex="-1"></a>        <span class="dt">features</span><span class="op">:</span> training<span class="op">,</span></span>
<span id="cb2-130"><a href="#cb2-130" tabindex="-1"></a>        <span class="dt">classProperty</span><span class="op">:</span> <span class="st">&#39;landcover&#39;</span><span class="op">,</span></span>
<span id="cb2-131"><a href="#cb2-131" tabindex="-1"></a>        <span class="dt">inputProperties</span><span class="op">:</span> composite<span class="op">.</span><span class="fu">bandNames</span>()</span>
<span id="cb2-132"><a href="#cb2-132" tabindex="-1"></a>      })<span class="op">;</span></span>
<span id="cb2-133"><a href="#cb2-133" tabindex="-1"></a></span>
<span id="cb2-134"><a href="#cb2-134" tabindex="-1"></a>  <span class="co">// Here we are classifying a table instead of an image</span></span>
<span id="cb2-135"><a href="#cb2-135" tabindex="-1"></a>  <span class="co">// Classifiers work on both images and tables</span></span>
<span id="cb2-136"><a href="#cb2-136" tabindex="-1"></a>  <span class="cf">return</span> test</span>
<span id="cb2-137"><a href="#cb2-137" tabindex="-1"></a>    <span class="op">.</span><span class="fu">classify</span>(classifier)</span>
<span id="cb2-138"><a href="#cb2-138" tabindex="-1"></a>    <span class="op">.</span><span class="fu">errorMatrix</span>(<span class="st">&#39;landcover&#39;</span><span class="op">,</span> <span class="st">&#39;classification&#39;</span>)</span>
<span id="cb2-139"><a href="#cb2-139" tabindex="-1"></a>    <span class="op">.</span><span class="fu">accuracy</span>()<span class="op">;</span></span>
<span id="cb2-140"><a href="#cb2-140" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb2-141"><a href="#cb2-141" tabindex="-1"></a></span>
<span id="cb2-142"><a href="#cb2-142" tabindex="-1"></a><span class="kw">var</span> chart <span class="op">=</span> ui<span class="op">.</span><span class="at">Chart</span><span class="op">.</span><span class="at">array</span><span class="op">.</span><span class="fu">values</span>({</span>
<span id="cb2-143"><a href="#cb2-143" tabindex="-1"></a>  <span class="dt">array</span><span class="op">:</span> ee<span class="op">.</span><span class="fu">Array</span>(accuracies)<span class="op">,</span></span>
<span id="cb2-144"><a href="#cb2-144" tabindex="-1"></a>  <span class="dt">axis</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb2-145"><a href="#cb2-145" tabindex="-1"></a>  <span class="dt">xLabels</span><span class="op">:</span> numTreesList</span>
<span id="cb2-146"><a href="#cb2-146" tabindex="-1"></a>  })<span class="op">.</span><span class="fu">setOptions</span>({</span>
<span id="cb2-147"><a href="#cb2-147" tabindex="-1"></a>      <span class="dt">title</span><span class="op">:</span> <span class="st">&#39;Hyperparameter Tuning for the numberOfTrees Parameters&#39;</span><span class="op">,</span></span>
<span id="cb2-148"><a href="#cb2-148" tabindex="-1"></a>      <span class="dt">vAxis</span><span class="op">:</span> {<span class="dt">title</span><span class="op">:</span> <span class="st">&#39;Validation Accuracy&#39;</span>}<span class="op">,</span></span>
<span id="cb2-149"><a href="#cb2-149" tabindex="-1"></a>      <span class="dt">hAxis</span><span class="op">:</span> {<span class="dt">title</span><span class="op">:</span> <span class="st">&#39;Number of Tress&#39;</span><span class="op">,</span> <span class="dt">gridlines</span><span class="op">:</span> {<span class="dt">count</span><span class="op">:</span> <span class="dv">15</span>}}</span>
<span id="cb2-150"><a href="#cb2-150" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb2-151"><a href="#cb2-151" tabindex="-1"></a><span class="fu">print</span>(chart)<span class="op">;</span></span>
<span id="cb2-152"><a href="#cb2-152" tabindex="-1"></a></span>
<span id="cb2-153"><a href="#cb2-153" tabindex="-1"></a><span class="co">// Tuning Multiple Parameters</span></span>
<span id="cb2-154"><a href="#cb2-154" tabindex="-1"></a><span class="co">// We can tune many parameters together using</span></span>
<span id="cb2-155"><a href="#cb2-155" tabindex="-1"></a><span class="co">// nested map() functions</span></span>
<span id="cb2-156"><a href="#cb2-156" tabindex="-1"></a><span class="co">// Let&#39;s tune 2 parameters</span></span>
<span id="cb2-157"><a href="#cb2-157" tabindex="-1"></a><span class="co">// numTrees and bagFraction </span></span>
<span id="cb2-158"><a href="#cb2-158" tabindex="-1"></a><span class="kw">var</span> numTreesList <span class="op">=</span> ee<span class="op">.</span><span class="at">List</span><span class="op">.</span><span class="fu">sequence</span>(<span class="dv">10</span><span class="op">,</span> <span class="dv">150</span><span class="op">,</span> <span class="dv">10</span>)<span class="op">;</span></span>
<span id="cb2-159"><a href="#cb2-159" tabindex="-1"></a><span class="kw">var</span> bagFractionList <span class="op">=</span> ee<span class="op">.</span><span class="at">List</span><span class="op">.</span><span class="fu">sequence</span>(<span class="fl">0.1</span><span class="op">,</span> <span class="fl">0.9</span><span class="op">,</span> <span class="fl">0.1</span>)<span class="op">;</span></span>
<span id="cb2-160"><a href="#cb2-160" tabindex="-1"></a></span>
<span id="cb2-161"><a href="#cb2-161" tabindex="-1"></a><span class="kw">var</span> accuracies <span class="op">=</span> numTreesList<span class="op">.</span><span class="fu">map</span>(<span class="kw">function</span>(numTrees) {</span>
<span id="cb2-162"><a href="#cb2-162" tabindex="-1"></a>  <span class="cf">return</span> bagFractionList<span class="op">.</span><span class="fu">map</span>(<span class="kw">function</span>(bagFraction) {</span>
<span id="cb2-163"><a href="#cb2-163" tabindex="-1"></a>     <span class="kw">var</span> classifier <span class="op">=</span> ee<span class="op">.</span><span class="at">Classifier</span><span class="op">.</span><span class="fu">smileRandomForest</span>({</span>
<span id="cb2-164"><a href="#cb2-164" tabindex="-1"></a>       <span class="dt">numberOfTrees</span><span class="op">:</span> numTrees<span class="op">,</span></span>
<span id="cb2-165"><a href="#cb2-165" tabindex="-1"></a>       <span class="dt">bagFraction</span><span class="op">:</span> bagFraction</span>
<span id="cb2-166"><a href="#cb2-166" tabindex="-1"></a>     })</span>
<span id="cb2-167"><a href="#cb2-167" tabindex="-1"></a>      <span class="op">.</span><span class="fu">train</span>({</span>
<span id="cb2-168"><a href="#cb2-168" tabindex="-1"></a>        <span class="dt">features</span><span class="op">:</span> training<span class="op">,</span></span>
<span id="cb2-169"><a href="#cb2-169" tabindex="-1"></a>        <span class="dt">classProperty</span><span class="op">:</span> <span class="st">&#39;landcover&#39;</span><span class="op">,</span></span>
<span id="cb2-170"><a href="#cb2-170" tabindex="-1"></a>        <span class="dt">inputProperties</span><span class="op">:</span> composite<span class="op">.</span><span class="fu">bandNames</span>()</span>
<span id="cb2-171"><a href="#cb2-171" tabindex="-1"></a>      })<span class="op">;</span></span>
<span id="cb2-172"><a href="#cb2-172" tabindex="-1"></a></span>
<span id="cb2-173"><a href="#cb2-173" tabindex="-1"></a>    <span class="co">// Here we are classifying a table instead of an image</span></span>
<span id="cb2-174"><a href="#cb2-174" tabindex="-1"></a>    <span class="co">// Classifiers work on both images and tables</span></span>
<span id="cb2-175"><a href="#cb2-175" tabindex="-1"></a>    <span class="kw">var</span> accuracy <span class="op">=</span> test</span>
<span id="cb2-176"><a href="#cb2-176" tabindex="-1"></a>      <span class="op">.</span><span class="fu">classify</span>(classifier)</span>
<span id="cb2-177"><a href="#cb2-177" tabindex="-1"></a>      <span class="op">.</span><span class="fu">errorMatrix</span>(<span class="st">&#39;landcover&#39;</span><span class="op">,</span> <span class="st">&#39;classification&#39;</span>)</span>
<span id="cb2-178"><a href="#cb2-178" tabindex="-1"></a>      <span class="op">.</span><span class="fu">accuracy</span>()<span class="op">;</span></span>
<span id="cb2-179"><a href="#cb2-179" tabindex="-1"></a>    <span class="cf">return</span> ee<span class="op">.</span><span class="fu">Feature</span>(<span class="kw">null</span><span class="op">,</span> {<span class="st">&#39;accuracy&#39;</span><span class="op">:</span> accuracy<span class="op">,</span></span>
<span id="cb2-180"><a href="#cb2-180" tabindex="-1"></a>      <span class="st">&#39;numberOfTrees&#39;</span><span class="op">:</span> numTrees<span class="op">,</span></span>
<span id="cb2-181"><a href="#cb2-181" tabindex="-1"></a>      <span class="st">&#39;bagFraction&#39;</span><span class="op">:</span> bagFraction})<span class="op">;</span></span>
<span id="cb2-182"><a href="#cb2-182" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb2-183"><a href="#cb2-183" tabindex="-1"></a>})<span class="op">.</span><span class="fu">flatten</span>()<span class="op">;</span></span>
<span id="cb2-184"><a href="#cb2-184" tabindex="-1"></a><span class="kw">var</span> resultFc <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(accuracies)<span class="op">;</span></span>
<span id="cb2-185"><a href="#cb2-185" tabindex="-1"></a></span>
<span id="cb2-186"><a href="#cb2-186" tabindex="-1"></a><span class="co">// Export the result as CSV</span></span>
<span id="cb2-187"><a href="#cb2-187" tabindex="-1"></a>Export<span class="op">.</span><span class="at">table</span><span class="op">.</span><span class="fu">toDrive</span>({</span>
<span id="cb2-188"><a href="#cb2-188" tabindex="-1"></a>  <span class="dt">collection</span><span class="op">:</span> resultFc<span class="op">,</span></span>
<span id="cb2-189"><a href="#cb2-189" tabindex="-1"></a>  <span class="dt">description</span><span class="op">:</span> <span class="st">&#39;Multiple_Parameter_Tuning_Results&#39;</span><span class="op">,</span></span>
<span id="cb2-190"><a href="#cb2-190" tabindex="-1"></a>  <span class="dt">folder</span><span class="op">:</span> <span class="st">&#39;earthengine&#39;</span><span class="op">,</span></span>
<span id="cb2-191"><a href="#cb2-191" tabindex="-1"></a>  <span class="dt">fileNamePrefix</span><span class="op">:</span> <span class="st">&#39;numtrees_bagfraction&#39;</span><span class="op">,</span></span>
<span id="cb2-192"><a href="#cb2-192" tabindex="-1"></a>  <span class="dt">fileFormat</span><span class="op">:</span> <span class="st">&#39;CSV&#39;</span>})<span class="op">;</span></span>
<span id="cb2-193"><a href="#cb2-193" tabindex="-1"></a></span>
<span id="cb2-194"><a href="#cb2-194" tabindex="-1"></a><span class="co">// Alternatively we can automatically pick the parameters</span></span>
<span id="cb2-195"><a href="#cb2-195" tabindex="-1"></a><span class="co">// that result in the highest accuracy</span></span>
<span id="cb2-196"><a href="#cb2-196" tabindex="-1"></a><span class="kw">var</span> resultFcSorted <span class="op">=</span> resultFc<span class="op">.</span><span class="fu">sort</span>(<span class="st">&#39;accuracy&#39;</span><span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span></span>
<span id="cb2-197"><a href="#cb2-197" tabindex="-1"></a><span class="kw">var</span> highestAccuracyFeature <span class="op">=</span> resultFcSorted<span class="op">.</span><span class="fu">first</span>()<span class="op">;</span></span>
<span id="cb2-198"><a href="#cb2-198" tabindex="-1"></a><span class="kw">var</span> highestAccuracy <span class="op">=</span> highestAccuracyFeature<span class="op">.</span><span class="fu">getNumber</span>(<span class="st">&#39;accuracy&#39;</span>)<span class="op">;</span></span>
<span id="cb2-199"><a href="#cb2-199" tabindex="-1"></a><span class="kw">var</span> optimalNumTrees <span class="op">=</span> highestAccuracyFeature<span class="op">.</span><span class="fu">getNumber</span>(<span class="st">&#39;numberOfTrees&#39;</span>)<span class="op">;</span></span>
<span id="cb2-200"><a href="#cb2-200" tabindex="-1"></a><span class="kw">var</span> optimalBagFraction <span class="op">=</span> highestAccuracyFeature<span class="op">.</span><span class="fu">getNumber</span>(<span class="st">&#39;bagFraction&#39;</span>)<span class="op">;</span></span>
<span id="cb2-201"><a href="#cb2-201" tabindex="-1"></a></span>
<span id="cb2-202"><a href="#cb2-202" tabindex="-1"></a><span class="co">// Use the optimal parameters in a model and perform final classification</span></span>
<span id="cb2-203"><a href="#cb2-203" tabindex="-1"></a><span class="kw">var</span> optimalModel <span class="op">=</span> ee<span class="op">.</span><span class="at">Classifier</span><span class="op">.</span><span class="fu">smileRandomForest</span>({</span>
<span id="cb2-204"><a href="#cb2-204" tabindex="-1"></a>  <span class="dt">numberOfTrees</span><span class="op">:</span> optimalNumTrees<span class="op">,</span></span>
<span id="cb2-205"><a href="#cb2-205" tabindex="-1"></a>  <span class="dt">bagFraction</span><span class="op">:</span> optimalBagFraction</span>
<span id="cb2-206"><a href="#cb2-206" tabindex="-1"></a>})<span class="op">.</span><span class="fu">train</span>({</span>
<span id="cb2-207"><a href="#cb2-207" tabindex="-1"></a>  <span class="dt">features</span><span class="op">:</span> training<span class="op">,</span>  </span>
<span id="cb2-208"><a href="#cb2-208" tabindex="-1"></a>  <span class="dt">classProperty</span><span class="op">:</span> <span class="st">&#39;landcover&#39;</span><span class="op">,</span></span>
<span id="cb2-209"><a href="#cb2-209" tabindex="-1"></a>  <span class="dt">inputProperties</span><span class="op">:</span> composite<span class="op">.</span><span class="fu">bandNames</span>()</span>
<span id="cb2-210"><a href="#cb2-210" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb2-211"><a href="#cb2-211" tabindex="-1"></a></span>
<span id="cb2-212"><a href="#cb2-212" tabindex="-1"></a><span class="kw">var</span> finalClassification <span class="op">=</span> composite<span class="op">.</span><span class="fu">classify</span>(optimalModel)<span class="op">;</span></span>
<span id="cb2-213"><a href="#cb2-213" tabindex="-1"></a></span>
<span id="cb2-214"><a href="#cb2-214" tabindex="-1"></a><span class="co">// Printing or Displaying the image may time out as it requires</span></span>
<span id="cb2-215"><a href="#cb2-215" tabindex="-1"></a><span class="co">// extensive computation to find the optimal parameters</span></span>
<span id="cb2-216"><a href="#cb2-216" tabindex="-1"></a></span>
<span id="cb2-217"><a href="#cb2-217" tabindex="-1"></a><span class="co">// Export the &#39;finalClassification&#39; to Asset and import the</span></span>
<span id="cb2-218"><a href="#cb2-218" tabindex="-1"></a><span class="co">// result to view it.</span></span></code></pre></div>
</div>
<div id="post-processing-classification-results" class="section level2">
<h2>Post-Processing Classification Results</h2>
<p>Supervised classification results often contain salt-and-pepper noise
caused by mis-classified pixels. It is usually preferable to apply some
post-processing techniques to remove such noise. The following script
contains the code for two popular techniques for post-processing
classification results.</p>
<ul>
<li>Using un-supervised clustering to replacing classified value by
majority value in each cluster.</li>
<li>Replacing isolated pixels with surrounding value with a majority
filter.</li>
</ul>
<blockquote>
<p>Remember that the neighborhood methods are scale-dependent so the
results will change as you zoom in/out. Export the results at the
desired scale to see the effect of post-processing.</p>
</blockquote>
<p><img src="images/end_to_end_gee/post_processing.png" width="100%" style="display: block; margin: auto;" /></p>
<p><a
href="https://code.earthengine.google.co.in/?scriptPath=users%2Fujavalgandhi%2FEnd-to-End-GEE%3ASupplement%2FSupervised_Classification%2FPost_Processing_Classification_Results"
target="_blank">Open in Code Editor ↗</a></p>
<div class="sourceCode" id="cb3"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a><span class="co">// Sentinel-2 Median Composite</span></span>
<span id="cb3-2"><a href="#cb3-2" tabindex="-1"></a><span class="kw">var</span> composite <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(<span class="st">&#39;users/ujavalgandhi/e2e/arkavathy_2019_composite&#39;</span>)<span class="op">;</span></span>
<span id="cb3-3"><a href="#cb3-3" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(composite<span class="op">,</span> {<span class="dt">min</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span> <span class="dv">3000</span><span class="op">,</span>   <span class="dt">bands</span><span class="op">:</span> [<span class="st">&#39;B4&#39;</span><span class="op">,</span> <span class="st">&#39;B3&#39;</span><span class="op">,</span> <span class="st">&#39;B2&#39;</span>]}<span class="op">,</span> <span class="st">&#39;RGB Composite&#39;</span>)<span class="op">;</span></span>
<span id="cb3-4"><a href="#cb3-4" tabindex="-1"></a></span>
<span id="cb3-5"><a href="#cb3-5" tabindex="-1"></a><span class="co">// Raw Supervised Classification Results</span></span>
<span id="cb3-6"><a href="#cb3-6" tabindex="-1"></a><span class="kw">var</span> classified <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(<span class="st">&#39;users/ujavalgandhi/e2e/arkavathy_final_classification&#39;</span>)<span class="op">;</span></span>
<span id="cb3-7"><a href="#cb3-7" tabindex="-1"></a><span class="kw">var</span> palette <span class="op">=</span> [<span class="st">&#39;#cc6d8f&#39;</span><span class="op">,</span> <span class="st">&#39;#ffc107&#39;</span><span class="op">,</span> <span class="st">&#39;#1e88e5&#39;</span><span class="op">,</span> <span class="st">&#39;#004d40&#39;</span> ]<span class="op">;</span></span>
<span id="cb3-8"><a href="#cb3-8" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(classified<span class="op">,</span> {<span class="dt">min</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span> <span class="dv">3</span><span class="op">,</span> <span class="dt">palette</span><span class="op">:</span> palette}<span class="op">,</span> <span class="st">&#39;Original&#39;</span>)<span class="op">;</span></span>
<span id="cb3-9"><a href="#cb3-9" tabindex="-1"></a></span>
<span id="cb3-10"><a href="#cb3-10" tabindex="-1"></a><span class="kw">var</span> basin <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">&#39;WWF/HydroSHEDS/v1/Basins/hybas_7&#39;</span>)<span class="op">;</span></span>
<span id="cb3-11"><a href="#cb3-11" tabindex="-1"></a><span class="kw">var</span> arkavathy <span class="op">=</span> basin<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;HYBAS_ID&#39;</span><span class="op">,</span> <span class="dv">4071139640</span>))<span class="op">;</span></span>
<span id="cb3-12"><a href="#cb3-12" tabindex="-1"></a><span class="kw">var</span> geometry <span class="op">=</span> arkavathy<span class="op">.</span><span class="fu">geometry</span>()<span class="op">;</span></span>
<span id="cb3-13"><a href="#cb3-13" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">centerObject</span>(geometry)<span class="op">;</span></span>
<span id="cb3-14"><a href="#cb3-14" tabindex="-1"></a></span>
<span id="cb3-15"><a href="#cb3-15" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">centerObject</span>(geometry<span class="op">,</span> <span class="dv">10</span>)<span class="op">;</span></span>
<span id="cb3-16"><a href="#cb3-16" tabindex="-1"></a></span>
<span id="cb3-17"><a href="#cb3-17" tabindex="-1"></a><span class="co">//************************************************************************** </span></span>
<span id="cb3-18"><a href="#cb3-18" tabindex="-1"></a><span class="co">// Post process by clustering</span></span>
<span id="cb3-19"><a href="#cb3-19" tabindex="-1"></a><span class="co">//************************************************************************** </span></span>
<span id="cb3-20"><a href="#cb3-20" tabindex="-1"></a></span>
<span id="cb3-21"><a href="#cb3-21" tabindex="-1"></a><span class="co">// Cluster using Unsupervised Clustering methods</span></span>
<span id="cb3-22"><a href="#cb3-22" tabindex="-1"></a><span class="kw">var</span> seeds <span class="op">=</span> ee<span class="op">.</span><span class="at">Algorithms</span><span class="op">.</span><span class="at">Image</span><span class="op">.</span><span class="at">Segmentation</span><span class="op">.</span><span class="fu">seedGrid</span>(<span class="dv">5</span>)<span class="op">;</span></span>
<span id="cb3-23"><a href="#cb3-23" tabindex="-1"></a></span>
<span id="cb3-24"><a href="#cb3-24" tabindex="-1"></a><span class="kw">var</span> snic <span class="op">=</span> ee<span class="op">.</span><span class="at">Algorithms</span><span class="op">.</span><span class="at">Image</span><span class="op">.</span><span class="at">Segmentation</span><span class="op">.</span><span class="fu">SNIC</span>({</span>
<span id="cb3-25"><a href="#cb3-25" tabindex="-1"></a>  <span class="dt">image</span><span class="op">:</span> composite<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;B.*&#39;</span>)<span class="op">,</span> </span>
<span id="cb3-26"><a href="#cb3-26" tabindex="-1"></a>  <span class="dt">compactness</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb3-27"><a href="#cb3-27" tabindex="-1"></a>  <span class="dt">connectivity</span><span class="op">:</span> <span class="dv">4</span><span class="op">,</span></span>
<span id="cb3-28"><a href="#cb3-28" tabindex="-1"></a>  <span class="dt">neighborhoodSize</span><span class="op">:</span> <span class="dv">10</span><span class="op">,</span></span>
<span id="cb3-29"><a href="#cb3-29" tabindex="-1"></a>  <span class="dt">size</span><span class="op">:</span> <span class="dv">2</span><span class="op">,</span></span>
<span id="cb3-30"><a href="#cb3-30" tabindex="-1"></a>  <span class="dt">seeds</span><span class="op">:</span> seeds</span>
<span id="cb3-31"><a href="#cb3-31" tabindex="-1"></a>})</span>
<span id="cb3-32"><a href="#cb3-32" tabindex="-1"></a><span class="kw">var</span> clusters <span class="op">=</span> snic<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;clusters&#39;</span>)</span>
<span id="cb3-33"><a href="#cb3-33" tabindex="-1"></a></span>
<span id="cb3-34"><a href="#cb3-34" tabindex="-1"></a><span class="co">// Assign class to each cluster based on &#39;majority&#39; voting (using ee.Reducer.mode()</span></span>
<span id="cb3-35"><a href="#cb3-35" tabindex="-1"></a><span class="kw">var</span> smoothed <span class="op">=</span> classified<span class="op">.</span><span class="fu">addBands</span>(clusters)<span class="op">;</span></span>
<span id="cb3-36"><a href="#cb3-36" tabindex="-1"></a></span>
<span id="cb3-37"><a href="#cb3-37" tabindex="-1"></a><span class="kw">var</span> clusterMajority <span class="op">=</span> smoothed<span class="op">.</span><span class="fu">reduceConnectedComponents</span>({</span>
<span id="cb3-38"><a href="#cb3-38" tabindex="-1"></a>  <span class="dt">reducer</span><span class="op">:</span> ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">mode</span>()<span class="op">,</span></span>
<span id="cb3-39"><a href="#cb3-39" tabindex="-1"></a>  <span class="dt">labelBand</span><span class="op">:</span> <span class="st">&#39;clusters&#39;</span></span>
<span id="cb3-40"><a href="#cb3-40" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb3-41"><a href="#cb3-41" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(clusterMajority<span class="op">,</span> {<span class="dt">min</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span> <span class="dv">3</span><span class="op">,</span> <span class="dt">palette</span><span class="op">:</span> palette}<span class="op">,</span> </span>
<span id="cb3-42"><a href="#cb3-42" tabindex="-1"></a>  <span class="st">&#39;Processed using Clusters&#39;</span>)<span class="op">;</span></span>
<span id="cb3-43"><a href="#cb3-43" tabindex="-1"></a></span>
<span id="cb3-44"><a href="#cb3-44" tabindex="-1"></a></span>
<span id="cb3-45"><a href="#cb3-45" tabindex="-1"></a><span class="co">//************************************************************************** </span></span>
<span id="cb3-46"><a href="#cb3-46" tabindex="-1"></a><span class="co">// Post process by replacing isolated pixels with surrounding value</span></span>
<span id="cb3-47"><a href="#cb3-47" tabindex="-1"></a><span class="co">//************************************************************************** </span></span>
<span id="cb3-48"><a href="#cb3-48" tabindex="-1"></a></span>
<span id="cb3-49"><a href="#cb3-49" tabindex="-1"></a><span class="co">// count patch sizes</span></span>
<span id="cb3-50"><a href="#cb3-50" tabindex="-1"></a><span class="kw">var</span> patchsize <span class="op">=</span> classified<span class="op">.</span><span class="fu">connectedPixelCount</span>(<span class="dv">40</span><span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span></span>
<span id="cb3-51"><a href="#cb3-51" tabindex="-1"></a></span>
<span id="cb3-52"><a href="#cb3-52" tabindex="-1"></a><span class="co">// run a majority filter</span></span>
<span id="cb3-53"><a href="#cb3-53" tabindex="-1"></a><span class="kw">var</span> filtered <span class="op">=</span> classified<span class="op">.</span><span class="fu">focal_mode</span>({</span>
<span id="cb3-54"><a href="#cb3-54" tabindex="-1"></a>    <span class="dt">radius</span><span class="op">:</span> <span class="dv">10</span><span class="op">,</span></span>
<span id="cb3-55"><a href="#cb3-55" tabindex="-1"></a>    <span class="dt">kernelType</span><span class="op">:</span> <span class="st">&#39;square&#39;</span><span class="op">,</span></span>
<span id="cb3-56"><a href="#cb3-56" tabindex="-1"></a>    <span class="dt">units</span><span class="op">:</span> <span class="st">&#39;meters&#39;</span><span class="op">,</span></span>
<span id="cb3-57"><a href="#cb3-57" tabindex="-1"></a>})<span class="op">;</span> </span>
<span id="cb3-58"><a href="#cb3-58" tabindex="-1"></a>  </span>
<span id="cb3-59"><a href="#cb3-59" tabindex="-1"></a><span class="co">// updated image with majority filter where patch size is small</span></span>
<span id="cb3-60"><a href="#cb3-60" tabindex="-1"></a><span class="kw">var</span> connectedClassified <span class="op">=</span>  classified<span class="op">.</span><span class="fu">where</span>(patchsize<span class="op">.</span><span class="fu">lt</span>(<span class="dv">25</span>)<span class="op">,</span>filtered)<span class="op">;</span></span>
<span id="cb3-61"><a href="#cb3-61" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(connectedClassified<span class="op">,</span> {<span class="dt">min</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span> <span class="dv">3</span><span class="op">,</span> <span class="dt">palette</span><span class="op">:</span> palette}<span class="op">,</span> </span>
<span id="cb3-62"><a href="#cb3-62" tabindex="-1"></a>  <span class="st">&#39;Processed using Connected Pixels&#39;</span>)<span class="op">;</span></span>
<span id="cb3-63"><a href="#cb3-63" tabindex="-1"></a></span>
<span id="cb3-64"><a href="#cb3-64" tabindex="-1"></a><span class="co">//************************************************************************** </span></span>
<span id="cb3-65"><a href="#cb3-65" tabindex="-1"></a><span class="co">// Export the Results</span></span>
<span id="cb3-66"><a href="#cb3-66" tabindex="-1"></a><span class="co">//************************************************************************** </span></span>
<span id="cb3-67"><a href="#cb3-67" tabindex="-1"></a><span class="co">// Pixel-based methods are scale dependent</span></span>
<span id="cb3-68"><a href="#cb3-68" tabindex="-1"></a><span class="co">// Zooming in or out will change the results</span></span>
<span id="cb3-69"><a href="#cb3-69" tabindex="-1"></a><span class="co">// Export the results at the required scale to see the final result.</span></span>
<span id="cb3-70"><a href="#cb3-70" tabindex="-1"></a>Export<span class="op">.</span><span class="at">image</span><span class="op">.</span><span class="fu">toDrive</span>({</span>
<span id="cb3-71"><a href="#cb3-71" tabindex="-1"></a>  <span class="dt">image</span><span class="op">:</span> clusterMajority<span class="op">,</span></span>
<span id="cb3-72"><a href="#cb3-72" tabindex="-1"></a>  <span class="dt">description</span><span class="op">:</span> <span class="st">&#39;Post_Processed_with_Clusters&#39;</span><span class="op">,</span></span>
<span id="cb3-73"><a href="#cb3-73" tabindex="-1"></a>  <span class="dt">folder</span><span class="op">:</span> <span class="st">&#39;earthengine&#39;</span><span class="op">,</span></span>
<span id="cb3-74"><a href="#cb3-74" tabindex="-1"></a>  <span class="dt">fileNamePrefix</span><span class="op">:</span> <span class="st">&#39;classification_clusters&#39;</span><span class="op">,</span></span>
<span id="cb3-75"><a href="#cb3-75" tabindex="-1"></a>  <span class="dt">region</span><span class="op">:</span> geometry<span class="op">,</span></span>
<span id="cb3-76"><a href="#cb3-76" tabindex="-1"></a>  <span class="dt">scale</span><span class="op">:</span> <span class="dv">10</span><span class="op">,</span></span>
<span id="cb3-77"><a href="#cb3-77" tabindex="-1"></a>  <span class="dt">maxPixels</span><span class="op">:</span> <span class="fl">1e10</span></span>
<span id="cb3-78"><a href="#cb3-78" tabindex="-1"></a>})</span>
<span id="cb3-79"><a href="#cb3-79" tabindex="-1"></a></span>
<span id="cb3-80"><a href="#cb3-80" tabindex="-1"></a>Export<span class="op">.</span><span class="at">image</span><span class="op">.</span><span class="fu">toDrive</span>({</span>
<span id="cb3-81"><a href="#cb3-81" tabindex="-1"></a>  <span class="dt">image</span><span class="op">:</span> connectedClassified<span class="op">,</span></span>
<span id="cb3-82"><a href="#cb3-82" tabindex="-1"></a>  <span class="dt">description</span><span class="op">:</span> <span class="st">&#39;Post_Processed_with_ConnectedPixels&#39;</span><span class="op">,</span></span>
<span id="cb3-83"><a href="#cb3-83" tabindex="-1"></a>  <span class="dt">folder</span><span class="op">:</span> <span class="st">&#39;earthengine&#39;</span><span class="op">,</span></span>
<span id="cb3-84"><a href="#cb3-84" tabindex="-1"></a>  <span class="dt">fileNamePrefix</span><span class="op">:</span> <span class="st">&#39;classification_connected&#39;</span><span class="op">,</span></span>
<span id="cb3-85"><a href="#cb3-85" tabindex="-1"></a>  <span class="dt">region</span><span class="op">:</span> geometry<span class="op">,</span></span>
<span id="cb3-86"><a href="#cb3-86" tabindex="-1"></a>  <span class="dt">scale</span><span class="op">:</span> <span class="dv">10</span><span class="op">,</span></span>
<span id="cb3-87"><a href="#cb3-87" tabindex="-1"></a>  <span class="dt">maxPixels</span><span class="op">:</span> <span class="fl">1e10</span></span>
<span id="cb3-88"><a href="#cb3-88" tabindex="-1"></a>})</span></code></pre></div>
</div>
<div id="principal-component-analysis-pca" class="section level2">
<h2>Principal Component Analysis (PCA)</h2>
<p>PCA is a very useful technique in improving your supervised
classification results. This is a statistical technique that compresses
data from a large number of bands into fewer uncorrelated bands. You can
run PCA on your image and add the first few (typically 3) principal
component bands to the original composite before sampling training
points. In the example below, you will notice that 97% of the variance
from the 13-band original image is captured in the 3-band PCA image.
This sends a stronger signal to the classifier and improves accuracy by
allowing it to distinguish different classes better.</p>
<p><img src="images/end_to_end_gee/pca.png" width="75%" style="display: block; margin: auto;" /></p>
<p><a
href="https://code.earthengine.google.co.in/?scriptPath=users%2Fujavalgandhi%2FEnd-to-End-GEE%3ASupplement%2FSupervised_Classification%2FPrincipal_Components_Analysis"
target="_blank">Open in Code Editor ↗</a></p>
<div class="sourceCode" id="cb4"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a><span class="co">// Script showing how to do Principal Component Analysis on images</span></span>
<span id="cb4-2"><a href="#cb4-2" tabindex="-1"></a><span class="kw">var</span> composite <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(<span class="st">&quot;users/ujavalgandhi/e2e/arkavathy_2019_composite&quot;</span>)<span class="op">;</span></span>
<span id="cb4-3"><a href="#cb4-3" tabindex="-1"></a><span class="kw">var</span> boundary <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">&quot;users/ujavalgandhi/e2e/arkavathy_boundary&quot;</span>)<span class="op">;</span></span>
<span id="cb4-4"><a href="#cb4-4" tabindex="-1"></a></span>
<span id="cb4-5"><a href="#cb4-5" tabindex="-1"></a><span class="fu">print</span>(<span class="st">&#39;Input Composite&#39;</span><span class="op">,</span> composite)<span class="op">;</span></span>
<span id="cb4-6"><a href="#cb4-6" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">centerObject</span>(composite)</span>
<span id="cb4-7"><a href="#cb4-7" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(composite<span class="op">,</span> {<span class="dt">bands</span><span class="op">:</span> [<span class="st">&#39;B4&#39;</span><span class="op">,</span> <span class="st">&#39;B3&#39;</span><span class="op">,</span> <span class="st">&#39;B2&#39;</span>]<span class="op">,</span> <span class="dt">min</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span> <span class="dv">3000</span><span class="op">,</span> <span class="dt">gamma</span><span class="op">:</span> <span class="fl">1.2</span>}<span class="op">,</span> <span class="st">&#39;RGB&#39;</span>)<span class="op">;</span></span>
<span id="cb4-8"><a href="#cb4-8" tabindex="-1"></a></span>
<span id="cb4-9"><a href="#cb4-9" tabindex="-1"></a><span class="co">// Define the geometry and scale parameters</span></span>
<span id="cb4-10"><a href="#cb4-10" tabindex="-1"></a><span class="kw">var</span> geometry <span class="op">=</span> boundary<span class="op">.</span><span class="fu">geometry</span>()<span class="op">;</span></span>
<span id="cb4-11"><a href="#cb4-11" tabindex="-1"></a><span class="kw">var</span> scale <span class="op">=</span> <span class="dv">20</span><span class="op">;</span></span>
<span id="cb4-12"><a href="#cb4-12" tabindex="-1"></a></span>
<span id="cb4-13"><a href="#cb4-13" tabindex="-1"></a><span class="co">// Run the PCA function</span></span>
<span id="cb4-14"><a href="#cb4-14" tabindex="-1"></a><span class="kw">var</span> pca <span class="op">=</span> <span class="fu">PCA</span>(composite)</span>
<span id="cb4-15"><a href="#cb4-15" tabindex="-1"></a></span>
<span id="cb4-16"><a href="#cb4-16" tabindex="-1"></a><span class="co">// Extract the properties of the pca image</span></span>
<span id="cb4-17"><a href="#cb4-17" tabindex="-1"></a><span class="kw">var</span> variance <span class="op">=</span> pca<span class="op">.</span><span class="fu">toDictionary</span>()</span>
<span id="cb4-18"><a href="#cb4-18" tabindex="-1"></a><span class="fu">print</span>(<span class="st">&#39;Variance of Principal Components&#39;</span><span class="op">,</span> variance)</span>
<span id="cb4-19"><a href="#cb4-19" tabindex="-1"></a></span>
<span id="cb4-20"><a href="#cb4-20" tabindex="-1"></a><span class="co">// As you see from the printed results, ~97% of the variance</span></span>
<span id="cb4-21"><a href="#cb4-21" tabindex="-1"></a><span class="co">// from the original image is captured in the first 3 principal components</span></span>
<span id="cb4-22"><a href="#cb4-22" tabindex="-1"></a><span class="co">// We select those and discard others</span></span>
<span id="cb4-23"><a href="#cb4-23" tabindex="-1"></a><span class="kw">var</span> pca <span class="op">=</span> <span class="fu">PCA</span>(composite)<span class="op">.</span><span class="fu">select</span>([<span class="st">&#39;pc1&#39;</span><span class="op">,</span> <span class="st">&#39;pc2&#39;</span><span class="op">,</span> <span class="st">&#39;pc3&#39;</span>])</span>
<span id="cb4-24"><a href="#cb4-24" tabindex="-1"></a><span class="fu">print</span>(<span class="st">&#39;First 3 PCA Bands&#39;</span><span class="op">,</span> pca)<span class="op">;</span></span>
<span id="cb4-25"><a href="#cb4-25" tabindex="-1"></a></span>
<span id="cb4-26"><a href="#cb4-26" tabindex="-1"></a><span class="co">// PCA computation is expensive and can time out when displaying on the map</span></span>
<span id="cb4-27"><a href="#cb4-27" tabindex="-1"></a><span class="co">// Export the results and import them back</span></span>
<span id="cb4-28"><a href="#cb4-28" tabindex="-1"></a>Export<span class="op">.</span><span class="at">image</span><span class="op">.</span><span class="fu">toAsset</span>({</span>
<span id="cb4-29"><a href="#cb4-29" tabindex="-1"></a>  <span class="dt">image</span><span class="op">:</span> pca<span class="op">,</span></span>
<span id="cb4-30"><a href="#cb4-30" tabindex="-1"></a>  <span class="dt">description</span><span class="op">:</span> <span class="st">&#39;Principal_Components_Image&#39;</span><span class="op">,</span></span>
<span id="cb4-31"><a href="#cb4-31" tabindex="-1"></a>  <span class="dt">assetId</span><span class="op">:</span> <span class="st">&#39;users/ujavalgandhi/e2e/arkavathy_pca&#39;</span><span class="op">,</span></span>
<span id="cb4-32"><a href="#cb4-32" tabindex="-1"></a>  <span class="dt">region</span><span class="op">:</span> geometry<span class="op">,</span></span>
<span id="cb4-33"><a href="#cb4-33" tabindex="-1"></a>  <span class="dt">scale</span><span class="op">:</span> scale<span class="op">,</span></span>
<span id="cb4-34"><a href="#cb4-34" tabindex="-1"></a>  <span class="dt">maxPixels</span><span class="op">:</span> <span class="fl">1e10</span>})</span>
<span id="cb4-35"><a href="#cb4-35" tabindex="-1"></a><span class="co">// Once the export finishes, import the asset and display</span></span>
<span id="cb4-36"><a href="#cb4-36" tabindex="-1"></a><span class="kw">var</span> pcaImported <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(<span class="st">&#39;users/ujavalgandhi/e2e/arkavathy_pca&#39;</span>)</span>
<span id="cb4-37"><a href="#cb4-37" tabindex="-1"></a><span class="kw">var</span> pcaVisParams <span class="op">=</span> {<span class="dt">bands</span><span class="op">:</span> [<span class="st">&#39;pc1&#39;</span><span class="op">,</span> <span class="st">&#39;pc2&#39;</span><span class="op">,</span> <span class="st">&#39;pc3&#39;</span>]<span class="op">,</span> <span class="dt">min</span><span class="op">:</span> <span class="op">-</span><span class="dv">2</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span> <span class="dv">2</span>}<span class="op">;</span></span>
<span id="cb4-38"><a href="#cb4-38" tabindex="-1"></a></span>
<span id="cb4-39"><a href="#cb4-39" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(pcaImported<span class="op">,</span> pcaVisParams<span class="op">,</span> <span class="st">&#39;Principal Components&#39;</span>)<span class="op">;</span></span>
<span id="cb4-40"><a href="#cb4-40" tabindex="-1"></a></span>
<span id="cb4-41"><a href="#cb4-41" tabindex="-1"></a></span>
<span id="cb4-42"><a href="#cb4-42" tabindex="-1"></a><span class="co">//************************************************************************** </span></span>
<span id="cb4-43"><a href="#cb4-43" tabindex="-1"></a><span class="co">// Function to calculate Principal Components</span></span>
<span id="cb4-44"><a href="#cb4-44" tabindex="-1"></a><span class="co">// Code adapted from https://developers.google.com/earth-engine/guides/arrays_eigen_analysis</span></span>
<span id="cb4-45"><a href="#cb4-45" tabindex="-1"></a><span class="co">//************************************************************************** </span></span>
<span id="cb4-46"><a href="#cb4-46" tabindex="-1"></a><span class="kw">function</span> <span class="fu">PCA</span>(maskedImage){</span>
<span id="cb4-47"><a href="#cb4-47" tabindex="-1"></a>  <span class="kw">var</span> image <span class="op">=</span> maskedImage<span class="op">.</span><span class="fu">unmask</span>()</span>
<span id="cb4-48"><a href="#cb4-48" tabindex="-1"></a>  <span class="kw">var</span> scale <span class="op">=</span> scale<span class="op">;</span></span>
<span id="cb4-49"><a href="#cb4-49" tabindex="-1"></a>  <span class="kw">var</span> region <span class="op">=</span> geometry<span class="op">;</span></span>
<span id="cb4-50"><a href="#cb4-50" tabindex="-1"></a>  <span class="kw">var</span> bandNames <span class="op">=</span> image<span class="op">.</span><span class="fu">bandNames</span>()<span class="op">;</span></span>
<span id="cb4-51"><a href="#cb4-51" tabindex="-1"></a>  <span class="co">// Mean center the data to enable a faster covariance reducer</span></span>
<span id="cb4-52"><a href="#cb4-52" tabindex="-1"></a>  <span class="co">// and an SD stretch of the principal components.</span></span>
<span id="cb4-53"><a href="#cb4-53" tabindex="-1"></a>  <span class="kw">var</span> meanDict <span class="op">=</span> image<span class="op">.</span><span class="fu">reduceRegion</span>({</span>
<span id="cb4-54"><a href="#cb4-54" tabindex="-1"></a>    <span class="dt">reducer</span><span class="op">:</span> ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">mean</span>()<span class="op">,</span></span>
<span id="cb4-55"><a href="#cb4-55" tabindex="-1"></a>    <span class="dt">geometry</span><span class="op">:</span> region<span class="op">,</span></span>
<span id="cb4-56"><a href="#cb4-56" tabindex="-1"></a>    <span class="dt">scale</span><span class="op">:</span> scale<span class="op">,</span></span>
<span id="cb4-57"><a href="#cb4-57" tabindex="-1"></a>    <span class="dt">maxPixels</span><span class="op">:</span> <span class="fl">1e13</span><span class="op">,</span></span>
<span id="cb4-58"><a href="#cb4-58" tabindex="-1"></a>    <span class="dt">tileScale</span><span class="op">:</span> <span class="dv">16</span></span>
<span id="cb4-59"><a href="#cb4-59" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb4-60"><a href="#cb4-60" tabindex="-1"></a>  <span class="kw">var</span> means <span class="op">=</span> ee<span class="op">.</span><span class="at">Image</span><span class="op">.</span><span class="fu">constant</span>(meanDict<span class="op">.</span><span class="fu">values</span>(bandNames))<span class="op">;</span></span>
<span id="cb4-61"><a href="#cb4-61" tabindex="-1"></a>  <span class="kw">var</span> centered <span class="op">=</span> image<span class="op">.</span><span class="fu">subtract</span>(means)<span class="op">;</span></span>
<span id="cb4-62"><a href="#cb4-62" tabindex="-1"></a>  <span class="co">// This helper function returns a list of new band names.</span></span>
<span id="cb4-63"><a href="#cb4-63" tabindex="-1"></a>  <span class="kw">var</span> getNewBandNames <span class="op">=</span> <span class="kw">function</span>(prefix) {</span>
<span id="cb4-64"><a href="#cb4-64" tabindex="-1"></a>    <span class="kw">var</span> seq <span class="op">=</span> ee<span class="op">.</span><span class="at">List</span><span class="op">.</span><span class="fu">sequence</span>(<span class="dv">1</span><span class="op">,</span> bandNames<span class="op">.</span><span class="fu">length</span>())<span class="op">;</span></span>
<span id="cb4-65"><a href="#cb4-65" tabindex="-1"></a>    <span class="cf">return</span> seq<span class="op">.</span><span class="fu">map</span>(<span class="kw">function</span>(b) {</span>
<span id="cb4-66"><a href="#cb4-66" tabindex="-1"></a>      <span class="cf">return</span> ee<span class="op">.</span><span class="fu">String</span>(prefix)<span class="op">.</span><span class="fu">cat</span>(ee<span class="op">.</span><span class="fu">Number</span>(b)<span class="op">.</span><span class="fu">int</span>())<span class="op">;</span></span>
<span id="cb4-67"><a href="#cb4-67" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb4-68"><a href="#cb4-68" tabindex="-1"></a>  }<span class="op">;</span></span>
<span id="cb4-69"><a href="#cb4-69" tabindex="-1"></a>  <span class="co">// This function accepts mean centered imagery, a scale and</span></span>
<span id="cb4-70"><a href="#cb4-70" tabindex="-1"></a>  <span class="co">// a region in which to perform the analysis.  It returns the</span></span>
<span id="cb4-71"><a href="#cb4-71" tabindex="-1"></a>  <span class="co">// Principal Components (PC) in the region as a new image.</span></span>
<span id="cb4-72"><a href="#cb4-72" tabindex="-1"></a>  <span class="kw">var</span> getPrincipalComponents <span class="op">=</span> <span class="kw">function</span>(centered<span class="op">,</span> scale<span class="op">,</span> region) {</span>
<span id="cb4-73"><a href="#cb4-73" tabindex="-1"></a>    <span class="co">// Collapse the bands of the image into a 1D array per pixel.</span></span>
<span id="cb4-74"><a href="#cb4-74" tabindex="-1"></a>    <span class="kw">var</span> arrays <span class="op">=</span> centered<span class="op">.</span><span class="fu">toArray</span>()<span class="op">;</span></span>
<span id="cb4-75"><a href="#cb4-75" tabindex="-1"></a>    </span>
<span id="cb4-76"><a href="#cb4-76" tabindex="-1"></a>    <span class="co">// Compute the covariance of the bands within the region.</span></span>
<span id="cb4-77"><a href="#cb4-77" tabindex="-1"></a>    <span class="kw">var</span> covar <span class="op">=</span> arrays<span class="op">.</span><span class="fu">reduceRegion</span>({</span>
<span id="cb4-78"><a href="#cb4-78" tabindex="-1"></a>      <span class="dt">reducer</span><span class="op">:</span> ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">centeredCovariance</span>()<span class="op">,</span></span>
<span id="cb4-79"><a href="#cb4-79" tabindex="-1"></a>      <span class="dt">geometry</span><span class="op">:</span> region<span class="op">,</span></span>
<span id="cb4-80"><a href="#cb4-80" tabindex="-1"></a>      <span class="dt">scale</span><span class="op">:</span> scale<span class="op">,</span></span>
<span id="cb4-81"><a href="#cb4-81" tabindex="-1"></a>      <span class="dt">maxPixels</span><span class="op">:</span> <span class="fl">1e13</span><span class="op">,</span></span>
<span id="cb4-82"><a href="#cb4-82" tabindex="-1"></a>      <span class="dt">tileScale</span><span class="op">:</span> <span class="dv">16</span></span>
<span id="cb4-83"><a href="#cb4-83" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb4-84"><a href="#cb4-84" tabindex="-1"></a></span>
<span id="cb4-85"><a href="#cb4-85" tabindex="-1"></a>    <span class="co">// Get the &#39;array&#39; covariance result and cast to an array.</span></span>
<span id="cb4-86"><a href="#cb4-86" tabindex="-1"></a>    <span class="co">// This represents the band-to-band covariance within the region.</span></span>
<span id="cb4-87"><a href="#cb4-87" tabindex="-1"></a>    <span class="kw">var</span> covarArray <span class="op">=</span> ee<span class="op">.</span><span class="fu">Array</span>(covar<span class="op">.</span><span class="fu">get</span>(<span class="st">&#39;array&#39;</span>))<span class="op">;</span></span>
<span id="cb4-88"><a href="#cb4-88" tabindex="-1"></a></span>
<span id="cb4-89"><a href="#cb4-89" tabindex="-1"></a>    <span class="co">// Perform an eigen analysis and slice apart the values and vectors.</span></span>
<span id="cb4-90"><a href="#cb4-90" tabindex="-1"></a>    <span class="kw">var</span> eigens <span class="op">=</span> covarArray<span class="op">.</span><span class="fu">eigen</span>()<span class="op">;</span></span>
<span id="cb4-91"><a href="#cb4-91" tabindex="-1"></a></span>
<span id="cb4-92"><a href="#cb4-92" tabindex="-1"></a>    <span class="co">// This is a P-length vector of Eigenvalues.</span></span>
<span id="cb4-93"><a href="#cb4-93" tabindex="-1"></a>    <span class="kw">var</span> eigenValues <span class="op">=</span> eigens<span class="op">.</span><span class="fu">slice</span>(<span class="dv">1</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb4-94"><a href="#cb4-94" tabindex="-1"></a>    </span>
<span id="cb4-95"><a href="#cb4-95" tabindex="-1"></a>    <span class="co">// Compute Percentage Variance of each component</span></span>
<span id="cb4-96"><a href="#cb4-96" tabindex="-1"></a>    <span class="co">// This will allow us to decide how many components capture</span></span>
<span id="cb4-97"><a href="#cb4-97" tabindex="-1"></a>    <span class="co">// most of the variance in the input</span></span>
<span id="cb4-98"><a href="#cb4-98" tabindex="-1"></a>    <span class="kw">var</span> eigenValuesList <span class="op">=</span> eigenValues<span class="op">.</span><span class="fu">toList</span>()<span class="op">.</span><span class="fu">flatten</span>()</span>
<span id="cb4-99"><a href="#cb4-99" tabindex="-1"></a>    <span class="kw">var</span> total <span class="op">=</span> eigenValuesList<span class="op">.</span><span class="fu">reduce</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">sum</span>())</span>
<span id="cb4-100"><a href="#cb4-100" tabindex="-1"></a></span>
<span id="cb4-101"><a href="#cb4-101" tabindex="-1"></a>    <span class="kw">var</span> percentageVariance <span class="op">=</span> eigenValuesList<span class="op">.</span><span class="fu">map</span>(<span class="kw">function</span>(item) {</span>
<span id="cb4-102"><a href="#cb4-102" tabindex="-1"></a>      <span class="kw">var</span> component <span class="op">=</span> eigenValuesList<span class="op">.</span><span class="fu">indexOf</span>(item)<span class="op">.</span><span class="fu">add</span>(<span class="dv">1</span>)<span class="op">.</span><span class="fu">format</span>(<span class="st">&#39;%02d&#39;</span>)</span>
<span id="cb4-103"><a href="#cb4-103" tabindex="-1"></a>      <span class="kw">var</span> variance <span class="op">=</span> ee<span class="op">.</span><span class="fu">Number</span>(item)<span class="op">.</span><span class="fu">divide</span>(total)<span class="op">.</span><span class="fu">multiply</span>(<span class="dv">100</span>)<span class="op">.</span><span class="fu">format</span>(<span class="st">&#39;%.2f&#39;</span>)</span>
<span id="cb4-104"><a href="#cb4-104" tabindex="-1"></a>      <span class="cf">return</span> ee<span class="op">.</span><span class="fu">List</span>([component<span class="op">,</span> variance])</span>
<span id="cb4-105"><a href="#cb4-105" tabindex="-1"></a>    })</span>
<span id="cb4-106"><a href="#cb4-106" tabindex="-1"></a>    <span class="co">// Create a dictionary that will be used to set properties on final image</span></span>
<span id="cb4-107"><a href="#cb4-107" tabindex="-1"></a>    <span class="kw">var</span> varianceDict <span class="op">=</span> ee<span class="op">.</span><span class="fu">Dictionary</span>(percentageVariance<span class="op">.</span><span class="fu">flatten</span>())</span>
<span id="cb4-108"><a href="#cb4-108" tabindex="-1"></a>    <span class="co">// This is a PxP matrix with eigenvectors in rows.</span></span>
<span id="cb4-109"><a href="#cb4-109" tabindex="-1"></a>    <span class="kw">var</span> eigenVectors <span class="op">=</span> eigens<span class="op">.</span><span class="fu">slice</span>(<span class="dv">1</span><span class="op">,</span> <span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb4-110"><a href="#cb4-110" tabindex="-1"></a>    <span class="co">// Convert the array image to 2D arrays for matrix computations.</span></span>
<span id="cb4-111"><a href="#cb4-111" tabindex="-1"></a>    <span class="kw">var</span> arrayImage <span class="op">=</span> arrays<span class="op">.</span><span class="fu">toArray</span>(<span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb4-112"><a href="#cb4-112" tabindex="-1"></a></span>
<span id="cb4-113"><a href="#cb4-113" tabindex="-1"></a>    <span class="co">// Left multiply the image array by the matrix of eigenvectors.</span></span>
<span id="cb4-114"><a href="#cb4-114" tabindex="-1"></a>    <span class="kw">var</span> principalComponents <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(eigenVectors)<span class="op">.</span><span class="fu">matrixMultiply</span>(arrayImage)<span class="op">;</span></span>
<span id="cb4-115"><a href="#cb4-115" tabindex="-1"></a></span>
<span id="cb4-116"><a href="#cb4-116" tabindex="-1"></a>    <span class="co">// Turn the square roots of the Eigenvalues into a P-band image.</span></span>
<span id="cb4-117"><a href="#cb4-117" tabindex="-1"></a>    <span class="co">// Call abs() to turn negative eigenvalues to positive before</span></span>
<span id="cb4-118"><a href="#cb4-118" tabindex="-1"></a>    <span class="co">// taking the square root</span></span>
<span id="cb4-119"><a href="#cb4-119" tabindex="-1"></a>    <span class="kw">var</span> sdImage <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(eigenValues<span class="op">.</span><span class="fu">abs</span>()<span class="op">.</span><span class="fu">sqrt</span>())</span>
<span id="cb4-120"><a href="#cb4-120" tabindex="-1"></a>      <span class="op">.</span><span class="fu">arrayProject</span>([<span class="dv">0</span>])<span class="op">.</span><span class="fu">arrayFlatten</span>([<span class="fu">getNewBandNames</span>(<span class="st">&#39;sd&#39;</span>)])<span class="op">;</span></span>
<span id="cb4-121"><a href="#cb4-121" tabindex="-1"></a></span>
<span id="cb4-122"><a href="#cb4-122" tabindex="-1"></a>    <span class="co">// Turn the PCs into a P-band image, normalized by SD.</span></span>
<span id="cb4-123"><a href="#cb4-123" tabindex="-1"></a>    <span class="cf">return</span> principalComponents</span>
<span id="cb4-124"><a href="#cb4-124" tabindex="-1"></a>      <span class="co">// Throw out an an unneeded dimension, [[]] -&gt; [].</span></span>
<span id="cb4-125"><a href="#cb4-125" tabindex="-1"></a>      <span class="op">.</span><span class="fu">arrayProject</span>([<span class="dv">0</span>])</span>
<span id="cb4-126"><a href="#cb4-126" tabindex="-1"></a>      <span class="co">// Make the one band array image a multi-band image, [] -&gt; image.</span></span>
<span id="cb4-127"><a href="#cb4-127" tabindex="-1"></a>      <span class="op">.</span><span class="fu">arrayFlatten</span>([<span class="fu">getNewBandNames</span>(<span class="st">&#39;pc&#39;</span>)])</span>
<span id="cb4-128"><a href="#cb4-128" tabindex="-1"></a>      <span class="co">// Normalize the PCs by their SDs.</span></span>
<span id="cb4-129"><a href="#cb4-129" tabindex="-1"></a>      <span class="op">.</span><span class="fu">divide</span>(sdImage)</span>
<span id="cb4-130"><a href="#cb4-130" tabindex="-1"></a>      <span class="op">.</span><span class="fu">set</span>(varianceDict)<span class="op">;</span></span>
<span id="cb4-131"><a href="#cb4-131" tabindex="-1"></a>  }<span class="op">;</span></span>
<span id="cb4-132"><a href="#cb4-132" tabindex="-1"></a>  <span class="kw">var</span> pcImage <span class="op">=</span> <span class="fu">getPrincipalComponents</span>(centered<span class="op">,</span> scale<span class="op">,</span> region)<span class="op">;</span></span>
<span id="cb4-133"><a href="#cb4-133" tabindex="-1"></a>  <span class="cf">return</span> pcImage<span class="op">.</span><span class="fu">mask</span>(maskedImage<span class="op">.</span><span class="fu">mask</span>())<span class="op">;</span></span>
<span id="cb4-134"><a href="#cb4-134" tabindex="-1"></a>}</span></code></pre></div>
</div>
<div id="multi-temporal-composites-for-crop-classification"
class="section level2">
<h2>Multi-temporal Composites for Crop Classification</h2>
<p>Crop classification is a difficult problem. A useful technique that
aids in clear distinction of crops is to account for crop phenology.
This technique can be applied to detect a specific type of crop or
distinguish crops from other forms of vegetation. You can create
composite images for different periods of the cropping cycle and create
a stacked image to be used for classification. This allows the
classifier to learn the temporal pattern and detect pixels that exhibit
similar patterns.</p>
<div class="figure" style="text-align: center">
<img src="images/end_to_end_gee/seasonal_composite.png" alt="Capturing Crop Phenology through Seasonal Composites" width="100%" />
<p class="caption">
Capturing Crop Phenology through Seasonal Composites
</p>
</div>
<p><a
href="https://code.earthengine.google.co.in/?scriptPath=users%2Fujavalgandhi%2FEnd-to-End-GEE%3ASupplement%2FSupervised_Classification%2FSeasonal_Composites_for_Crop_Classification"
target="_blank">Open in Code Editor ↗</a></p>
<div class="sourceCode" id="cb5"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a><span class="kw">var</span> s2 <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&quot;COPERNICUS/S2_SR_HARMONIZED&quot;</span>)</span>
<span id="cb5-2"><a href="#cb5-2" tabindex="-1"></a><span class="kw">var</span> basin <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">&quot;WWF/HydroSHEDS/v1/Basins/hybas_7&quot;</span>)</span>
<span id="cb5-3"><a href="#cb5-3" tabindex="-1"></a></span>
<span id="cb5-4"><a href="#cb5-4" tabindex="-1"></a><span class="kw">var</span> arkavathy <span class="op">=</span> basin<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;HYBAS_ID&#39;</span><span class="op">,</span> <span class="dv">4071139640</span>))<span class="op">;</span></span>
<span id="cb5-5"><a href="#cb5-5" tabindex="-1"></a><span class="kw">var</span> geometry <span class="op">=</span> arkavathy<span class="op">.</span><span class="fu">geometry</span>()<span class="op">;</span></span>
<span id="cb5-6"><a href="#cb5-6" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">centerObject</span>(geometry)<span class="op">;</span></span>
<span id="cb5-7"><a href="#cb5-7" tabindex="-1"></a></span>
<span id="cb5-8"><a href="#cb5-8" tabindex="-1"></a><span class="kw">var</span> filtered <span class="op">=</span> s2</span>
<span id="cb5-9"><a href="#cb5-9" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(<span class="st">&#39;2019-01-01&#39;</span><span class="op">,</span> <span class="st">&#39;2020-01-01&#39;</span>))</span>
<span id="cb5-10"><a href="#cb5-10" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">bounds</span>(geometry))<span class="op">;</span></span>
<span id="cb5-11"><a href="#cb5-11" tabindex="-1"></a></span>
<span id="cb5-12"><a href="#cb5-12" tabindex="-1"></a><span class="co">// Load the Cloud Score+ collection</span></span>
<span id="cb5-13"><a href="#cb5-13" tabindex="-1"></a><span class="kw">var</span> csPlus <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&#39;GOOGLE/CLOUD_SCORE_PLUS/V1/S2_HARMONIZED&#39;</span>)<span class="op">;</span></span>
<span id="cb5-14"><a href="#cb5-14" tabindex="-1"></a><span class="kw">var</span> csPlusBands <span class="op">=</span> csPlus<span class="op">.</span><span class="fu">first</span>()<span class="op">.</span><span class="fu">bandNames</span>()<span class="op">;</span></span>
<span id="cb5-15"><a href="#cb5-15" tabindex="-1"></a></span>
<span id="cb5-16"><a href="#cb5-16" tabindex="-1"></a><span class="co">// We need to add Cloud Score + bands to each Sentinel-2</span></span>
<span id="cb5-17"><a href="#cb5-17" tabindex="-1"></a><span class="co">// image in the collection</span></span>
<span id="cb5-18"><a href="#cb5-18" tabindex="-1"></a><span class="co">// This is done using the linkCollection() function</span></span>
<span id="cb5-19"><a href="#cb5-19" tabindex="-1"></a><span class="kw">var</span> filteredS2WithCs <span class="op">=</span> filtered<span class="op">.</span><span class="fu">linkCollection</span>(csPlus<span class="op">,</span> csPlusBands)<span class="op">;</span></span>
<span id="cb5-20"><a href="#cb5-20" tabindex="-1"></a></span>
<span id="cb5-21"><a href="#cb5-21" tabindex="-1"></a><span class="co">// Function to mask pixels with low CS+ QA scores.</span></span>
<span id="cb5-22"><a href="#cb5-22" tabindex="-1"></a><span class="kw">function</span> <span class="fu">maskLowQA</span>(image) {</span>
<span id="cb5-23"><a href="#cb5-23" tabindex="-1"></a>  <span class="kw">var</span> qaBand <span class="op">=</span> <span class="st">&#39;cs&#39;</span><span class="op">;</span></span>
<span id="cb5-24"><a href="#cb5-24" tabindex="-1"></a>  <span class="kw">var</span> clearThreshold <span class="op">=</span> <span class="fl">0.5</span><span class="op">;</span></span>
<span id="cb5-25"><a href="#cb5-25" tabindex="-1"></a>  <span class="kw">var</span> mask <span class="op">=</span> image<span class="op">.</span><span class="fu">select</span>(qaBand)<span class="op">.</span><span class="fu">gte</span>(clearThreshold)<span class="op">;</span></span>
<span id="cb5-26"><a href="#cb5-26" tabindex="-1"></a>  <span class="cf">return</span> image<span class="op">.</span><span class="fu">updateMask</span>(mask)<span class="op">;</span></span>
<span id="cb5-27"><a href="#cb5-27" tabindex="-1"></a>}</span>
<span id="cb5-28"><a href="#cb5-28" tabindex="-1"></a></span>
<span id="cb5-29"><a href="#cb5-29" tabindex="-1"></a><span class="kw">var</span> filteredMasked <span class="op">=</span> filteredS2WithCs</span>
<span id="cb5-30"><a href="#cb5-30" tabindex="-1"></a>  <span class="op">.</span><span class="fu">map</span>(maskLowQA)</span>
<span id="cb5-31"><a href="#cb5-31" tabindex="-1"></a>  <span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;B.*&#39;</span>)<span class="op">;</span></span>
<span id="cb5-32"><a href="#cb5-32" tabindex="-1"></a>  </span>
<span id="cb5-33"><a href="#cb5-33" tabindex="-1"></a><span class="co">// There are 3 distinct crop seasons in the area of interest</span></span>
<span id="cb5-34"><a href="#cb5-34" tabindex="-1"></a><span class="co">// Jan-March = Winter (Rabi) Crops</span></span>
<span id="cb5-35"><a href="#cb5-35" tabindex="-1"></a><span class="co">// April-June  = Summer Crops / Harvest</span></span>
<span id="cb5-36"><a href="#cb5-36" tabindex="-1"></a><span class="co">// July-December = Monsoon (Kharif) Crops</span></span>
<span id="cb5-37"><a href="#cb5-37" tabindex="-1"></a><span class="kw">var</span> cropCalendar <span class="op">=</span> ee<span class="op">.</span><span class="fu">List</span>([[<span class="dv">1</span><span class="op">,</span><span class="dv">3</span>]<span class="op">,</span> [<span class="dv">4</span><span class="op">,</span><span class="dv">6</span>]<span class="op">,</span> [<span class="dv">7</span><span class="op">,</span><span class="dv">12</span>]])<span class="op">;</span></span>
<span id="cb5-38"><a href="#cb5-38" tabindex="-1"></a></span>
<span id="cb5-39"><a href="#cb5-39" tabindex="-1"></a><span class="co">// We create different composites for each season</span></span>
<span id="cb5-40"><a href="#cb5-40" tabindex="-1"></a><span class="kw">var</span> createSeasonComposites <span class="op">=</span> <span class="kw">function</span>(months) {</span>
<span id="cb5-41"><a href="#cb5-41" tabindex="-1"></a>  <span class="kw">var</span> startMonth <span class="op">=</span> ee<span class="op">.</span><span class="fu">List</span>(months)<span class="op">.</span><span class="fu">get</span>(<span class="dv">0</span>)<span class="op">;</span></span>
<span id="cb5-42"><a href="#cb5-42" tabindex="-1"></a>  <span class="kw">var</span> endMonth <span class="op">=</span> ee<span class="op">.</span><span class="fu">List</span>(months)<span class="op">.</span><span class="fu">get</span>(<span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb5-43"><a href="#cb5-43" tabindex="-1"></a>  <span class="kw">var</span> monthFilter <span class="op">=</span> ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">calendarRange</span>(startMonth<span class="op">,</span> endMonth<span class="op">,</span> <span class="st">&#39;month&#39;</span>)<span class="op">;</span></span>
<span id="cb5-44"><a href="#cb5-44" tabindex="-1"></a>  <span class="kw">var</span> seasonFiltered <span class="op">=</span> filteredMasked<span class="op">.</span><span class="fu">filter</span>(monthFilter)<span class="op">;</span></span>
<span id="cb5-45"><a href="#cb5-45" tabindex="-1"></a>  <span class="kw">var</span> composite <span class="op">=</span> seasonFiltered<span class="op">.</span><span class="fu">median</span>()<span class="op">;</span></span>
<span id="cb5-46"><a href="#cb5-46" tabindex="-1"></a>  <span class="cf">return</span> composite<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;B.*&#39;</span>)<span class="op">;</span></span>
<span id="cb5-47"><a href="#cb5-47" tabindex="-1"></a>}</span>
<span id="cb5-48"><a href="#cb5-48" tabindex="-1"></a></span>
<span id="cb5-49"><a href="#cb5-49" tabindex="-1"></a><span class="kw">var</span> compositeList <span class="op">=</span> cropCalendar<span class="op">.</span><span class="fu">map</span>(createSeasonComposites)<span class="op">;</span></span>
<span id="cb5-50"><a href="#cb5-50" tabindex="-1"></a></span>
<span id="cb5-51"><a href="#cb5-51" tabindex="-1"></a><span class="kw">var</span> rabi <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(compositeList<span class="op">.</span><span class="fu">get</span>(<span class="dv">0</span>))<span class="op">;</span></span>
<span id="cb5-52"><a href="#cb5-52" tabindex="-1"></a><span class="kw">var</span> harvest <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(compositeList<span class="op">.</span><span class="fu">get</span>(<span class="dv">1</span>))<span class="op">;</span></span>
<span id="cb5-53"><a href="#cb5-53" tabindex="-1"></a><span class="kw">var</span> kharif <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(compositeList<span class="op">.</span><span class="fu">get</span>(<span class="dv">2</span>))<span class="op">;</span></span>
<span id="cb5-54"><a href="#cb5-54" tabindex="-1"></a></span>
<span id="cb5-55"><a href="#cb5-55" tabindex="-1"></a><span class="kw">var</span> visParams <span class="op">=</span> {<span class="dt">bands</span><span class="op">:</span> [<span class="st">&#39;B4&#39;</span><span class="op">,</span> <span class="st">&#39;B3&#39;</span><span class="op">,</span> <span class="st">&#39;B2&#39;</span>]<span class="op">,</span> <span class="dt">min</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span> <span class="dv">3000</span><span class="op">,</span> <span class="dt">gamma</span><span class="op">:</span> <span class="fl">1.2</span>}<span class="op">;</span></span>
<span id="cb5-56"><a href="#cb5-56" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(rabi<span class="op">.</span><span class="fu">clip</span>(geometry)<span class="op">,</span> visParams<span class="op">,</span> <span class="st">&#39;Rabi&#39;</span>)<span class="op">;</span></span>
<span id="cb5-57"><a href="#cb5-57" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(harvest<span class="op">.</span><span class="fu">clip</span>(geometry)<span class="op">,</span> visParams<span class="op">,</span> <span class="st">&#39;Harvest&#39;</span>)<span class="op">;</span></span>
<span id="cb5-58"><a href="#cb5-58" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(kharif<span class="op">.</span><span class="fu">clip</span>(geometry)<span class="op">,</span> visParams<span class="op">,</span> <span class="st">&#39;Kharif&#39;</span>)<span class="op">;</span></span>
<span id="cb5-59"><a href="#cb5-59" tabindex="-1"></a></span>
<span id="cb5-60"><a href="#cb5-60" tabindex="-1"></a><span class="co">// Create a stacked image with composites from all seasons</span></span>
<span id="cb5-61"><a href="#cb5-61" tabindex="-1"></a><span class="co">// This multi-temporal image is able capture the crop phenology</span></span>
<span id="cb5-62"><a href="#cb5-62" tabindex="-1"></a><span class="co">// Classifier will be able to detect crop-pixels from non-crop pixels</span></span>
<span id="cb5-63"><a href="#cb5-63" tabindex="-1"></a><span class="kw">var</span> composite <span class="op">=</span> rabi<span class="op">.</span><span class="fu">addBands</span>(harvest)<span class="op">.</span><span class="fu">addBands</span>(kharif)</span>
<span id="cb5-64"><a href="#cb5-64" tabindex="-1"></a></span>
<span id="cb5-65"><a href="#cb5-65" tabindex="-1"></a><span class="co">// This is a 36-band image</span></span>
<span id="cb5-66"><a href="#cb5-66" tabindex="-1"></a><span class="co">// Use this image for sampling training points for</span></span>
<span id="cb5-67"><a href="#cb5-67" tabindex="-1"></a><span class="co">// to train a crop classifier </span></span>
<span id="cb5-68"><a href="#cb5-68" tabindex="-1"></a><span class="fu">print</span>(composite)</span></code></pre></div>
</div>
<div id="computing-correlation" class="section level2">
<h2>Computing Correlation</h2>
<p>A useful technique to aid crop classification is to model the
correlation between precipitation and changes in vegetation. This allows
the model to capture differentiated responses to rainfall (i.e. raid-fed
crops vs permanent forests). We first prepare an image collection where
each image consists of 2 bands - cumulative rainfall for each month and
average NDVI for the next month. This will create 11 images per year
which show precipitation and 1-month lagged NDVI at each pixels. The
collection is then reduced using the
<code>ee.Reducer.pearsonsCorrelation()</code> which outputs a
<code>correlation</code> band. Positive values will show regions where
precipitation caused an increase in NDVI. Adding this band to your input
image for classification will greatly aid the classifier in separating
different types of vegetation.</p>
<p><a
href="https://code.earthengine.google.com/?scriptPath=users%2Fujavalgandhi%2FEnd-to-End-GEE%3ASupplement%2FSupervised_Classification%2FRainfall_NDVI_Correlation"
target="_blank">Open in Code Editor ↗</a></p>
<div class="sourceCode" id="cb6"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a><span class="co">// Calculate Rainfall-NDVI Correlation</span></span>
<span id="cb6-2"><a href="#cb6-2" tabindex="-1"></a></span>
<span id="cb6-3"><a href="#cb6-3" tabindex="-1"></a><span class="co">// We want to know whether there exists a correlation between</span></span>
<span id="cb6-4"><a href="#cb6-4" tabindex="-1"></a><span class="co">// rainfall and NDVI</span></span>
<span id="cb6-5"><a href="#cb6-5" tabindex="-1"></a><span class="co">// We build a collection containing monthly total rainfall for a year</span></span>
<span id="cb6-6"><a href="#cb6-6" tabindex="-1"></a><span class="co">// and the next month&#39;s average NDVI.</span></span>
<span id="cb6-7"><a href="#cb6-7" tabindex="-1"></a><span class="co">// We then use ee.Reducer.pearsonsCorrelation() to compute pixel-wise</span></span>
<span id="cb6-8"><a href="#cb6-8" tabindex="-1"></a><span class="co">// correlation between rainfall and NDVI response.</span></span>
<span id="cb6-9"><a href="#cb6-9" tabindex="-1"></a></span>
<span id="cb6-10"><a href="#cb6-10" tabindex="-1"></a><span class="co">// Positive values will indicate vegetation growth in response to</span></span>
<span id="cb6-11"><a href="#cb6-11" tabindex="-1"></a><span class="co">// precipitation and generally rainfed agriculture.</span></span>
<span id="cb6-12"><a href="#cb6-12" tabindex="-1"></a></span>
<span id="cb6-13"><a href="#cb6-13" tabindex="-1"></a><span class="kw">var</span> geometry <span class="op">=</span> ee<span class="op">.</span><span class="at">Geometry</span><span class="op">.</span><span class="fu">Point</span>([<span class="fl">75.71168046831512</span><span class="op">,</span> <span class="fl">13.30751919691132</span>])<span class="op">;</span></span>
<span id="cb6-14"><a href="#cb6-14" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">centerObject</span>(geometry<span class="op">,</span> <span class="dv">10</span>)</span>
<span id="cb6-15"><a href="#cb6-15" tabindex="-1"></a><span class="kw">var</span> s2 <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&quot;COPERNICUS/S2_SR_HARMONIZED&quot;</span>)<span class="op">;</span></span>
<span id="cb6-16"><a href="#cb6-16" tabindex="-1"></a></span>
<span id="cb6-17"><a href="#cb6-17" tabindex="-1"></a></span>
<span id="cb6-18"><a href="#cb6-18" tabindex="-1"></a><span class="kw">var</span> filtered <span class="op">=</span> s2</span>
<span id="cb6-19"><a href="#cb6-19" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(<span class="st">&#39;2020-01-01&#39;</span><span class="op">,</span> <span class="st">&#39;2021-01-01&#39;</span>))</span>
<span id="cb6-20"><a href="#cb6-20" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">bounds</span>(geometry))<span class="op">;</span></span>
<span id="cb6-21"><a href="#cb6-21" tabindex="-1"></a></span>
<span id="cb6-22"><a href="#cb6-22" tabindex="-1"></a><span class="co">// Load the Cloud Score+ collection</span></span>
<span id="cb6-23"><a href="#cb6-23" tabindex="-1"></a><span class="kw">var</span> csPlus <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&#39;GOOGLE/CLOUD_SCORE_PLUS/V1/S2_HARMONIZED&#39;</span>)<span class="op">;</span></span>
<span id="cb6-24"><a href="#cb6-24" tabindex="-1"></a><span class="kw">var</span> csPlusBands <span class="op">=</span> csPlus<span class="op">.</span><span class="fu">first</span>()<span class="op">.</span><span class="fu">bandNames</span>()<span class="op">;</span></span>
<span id="cb6-25"><a href="#cb6-25" tabindex="-1"></a></span>
<span id="cb6-26"><a href="#cb6-26" tabindex="-1"></a><span class="co">// We need to add Cloud Score + bands to each Sentinel-2</span></span>
<span id="cb6-27"><a href="#cb6-27" tabindex="-1"></a><span class="co">// image in the collection</span></span>
<span id="cb6-28"><a href="#cb6-28" tabindex="-1"></a><span class="co">// This is done using the linkCollection() function</span></span>
<span id="cb6-29"><a href="#cb6-29" tabindex="-1"></a><span class="kw">var</span> filteredS2WithCs <span class="op">=</span> filtered<span class="op">.</span><span class="fu">linkCollection</span>(csPlus<span class="op">,</span> csPlusBands)<span class="op">;</span></span>
<span id="cb6-30"><a href="#cb6-30" tabindex="-1"></a></span>
<span id="cb6-31"><a href="#cb6-31" tabindex="-1"></a><span class="co">// Function to mask pixels with low CS+ QA scores.</span></span>
<span id="cb6-32"><a href="#cb6-32" tabindex="-1"></a><span class="kw">function</span> <span class="fu">maskLowQA</span>(image) {</span>
<span id="cb6-33"><a href="#cb6-33" tabindex="-1"></a>  <span class="kw">var</span> qaBand <span class="op">=</span> <span class="st">&#39;cs&#39;</span><span class="op">;</span></span>
<span id="cb6-34"><a href="#cb6-34" tabindex="-1"></a>  <span class="kw">var</span> clearThreshold <span class="op">=</span> <span class="fl">0.5</span><span class="op">;</span></span>
<span id="cb6-35"><a href="#cb6-35" tabindex="-1"></a>  <span class="kw">var</span> mask <span class="op">=</span> image<span class="op">.</span><span class="fu">select</span>(qaBand)<span class="op">.</span><span class="fu">gte</span>(clearThreshold)<span class="op">;</span></span>
<span id="cb6-36"><a href="#cb6-36" tabindex="-1"></a>  <span class="cf">return</span> image<span class="op">.</span><span class="fu">updateMask</span>(mask)<span class="op">;</span></span>
<span id="cb6-37"><a href="#cb6-37" tabindex="-1"></a>}</span>
<span id="cb6-38"><a href="#cb6-38" tabindex="-1"></a></span>
<span id="cb6-39"><a href="#cb6-39" tabindex="-1"></a></span>
<span id="cb6-40"><a href="#cb6-40" tabindex="-1"></a><span class="co">// Write a function that computes NDVI for an image and adds it as a band</span></span>
<span id="cb6-41"><a href="#cb6-41" tabindex="-1"></a><span class="kw">function</span> <span class="fu">addNDVI</span>(image) {</span>
<span id="cb6-42"><a href="#cb6-42" tabindex="-1"></a>  <span class="kw">var</span> ndvi <span class="op">=</span> image<span class="op">.</span><span class="fu">normalizedDifference</span>([<span class="st">&#39;B8&#39;</span><span class="op">,</span> <span class="st">&#39;B4&#39;</span>])<span class="op">.</span><span class="fu">rename</span>(<span class="st">&#39;ndvi&#39;</span>)<span class="op">;</span></span>
<span id="cb6-43"><a href="#cb6-43" tabindex="-1"></a>  <span class="cf">return</span> image<span class="op">.</span><span class="fu">addBands</span>(ndvi)<span class="op">;</span></span>
<span id="cb6-44"><a href="#cb6-44" tabindex="-1"></a>}</span>
<span id="cb6-45"><a href="#cb6-45" tabindex="-1"></a></span>
<span id="cb6-46"><a href="#cb6-46" tabindex="-1"></a><span class="kw">var</span> filteredMasked <span class="op">=</span> filteredS2WithCs</span>
<span id="cb6-47"><a href="#cb6-47" tabindex="-1"></a>  <span class="op">.</span><span class="fu">map</span>(maskLowQA)</span>
<span id="cb6-48"><a href="#cb6-48" tabindex="-1"></a>  <span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;B.*&#39;</span>)<span class="op">;</span></span>
<span id="cb6-49"><a href="#cb6-49" tabindex="-1"></a>  </span>
<span id="cb6-50"><a href="#cb6-50" tabindex="-1"></a><span class="kw">var</span> filteredWithNdvi <span class="op">=</span> filteredMasked</span>
<span id="cb6-51"><a href="#cb6-51" tabindex="-1"></a>  <span class="op">.</span><span class="fu">map</span>(addNDVI)</span>
<span id="cb6-52"><a href="#cb6-52" tabindex="-1"></a>  </span>
<span id="cb6-53"><a href="#cb6-53" tabindex="-1"></a><span class="kw">var</span> composite <span class="op">=</span> filteredWithNdvi<span class="op">.</span><span class="fu">median</span>()<span class="op">;</span></span>
<span id="cb6-54"><a href="#cb6-54" tabindex="-1"></a><span class="kw">var</span> rgbVis <span class="op">=</span> {<span class="dt">bands</span><span class="op">:</span> [<span class="st">&#39;B4&#39;</span><span class="op">,</span> <span class="st">&#39;B3&#39;</span><span class="op">,</span> <span class="st">&#39;B2&#39;</span>]<span class="op">,</span> <span class="dt">min</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span> <span class="dv">3000</span><span class="op">,</span> <span class="dt">gamma</span><span class="op">:</span> <span class="fl">1.2</span>}<span class="op">;</span></span>
<span id="cb6-55"><a href="#cb6-55" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(composite<span class="op">,</span> rgbVis<span class="op">,</span> <span class="st">&#39;Composite&#39;</span>)  </span>
<span id="cb6-56"><a href="#cb6-56" tabindex="-1"></a></span>
<span id="cb6-57"><a href="#cb6-57" tabindex="-1"></a></span>
<span id="cb6-58"><a href="#cb6-58" tabindex="-1"></a><span class="co">// Rainfall</span></span>
<span id="cb6-59"><a href="#cb6-59" tabindex="-1"></a><span class="kw">var</span> chirps <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&quot;UCSB-CHG/CHIRPS/PENTAD&quot;</span>)<span class="op">;</span></span>
<span id="cb6-60"><a href="#cb6-60" tabindex="-1"></a><span class="kw">var</span> chirpsFiltered <span class="op">=</span> chirps</span>
<span id="cb6-61"><a href="#cb6-61" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(<span class="st">&#39;2020-01-01&#39;</span><span class="op">,</span> <span class="st">&#39;2021-01-01&#39;</span>))</span>
<span id="cb6-62"><a href="#cb6-62" tabindex="-1"></a></span>
<span id="cb6-63"><a href="#cb6-63" tabindex="-1"></a></span>
<span id="cb6-64"><a href="#cb6-64" tabindex="-1"></a><span class="co">// Create a collection of monthly images</span></span>
<span id="cb6-65"><a href="#cb6-65" tabindex="-1"></a><span class="kw">var</span> months <span class="op">=</span> ee<span class="op">.</span><span class="at">List</span><span class="op">.</span><span class="fu">sequence</span>(<span class="dv">1</span><span class="op">,</span> <span class="dv">11</span>)</span>
<span id="cb6-66"><a href="#cb6-66" tabindex="-1"></a></span>
<span id="cb6-67"><a href="#cb6-67" tabindex="-1"></a><span class="kw">var</span> byMonth <span class="op">=</span> months<span class="op">.</span><span class="fu">map</span>(<span class="kw">function</span>(month) {</span>
<span id="cb6-68"><a href="#cb6-68" tabindex="-1"></a>    <span class="co">// Total monthly rainfall</span></span>
<span id="cb6-69"><a href="#cb6-69" tabindex="-1"></a>    <span class="kw">var</span> monthlyRain <span class="op">=</span> chirpsFiltered</span>
<span id="cb6-70"><a href="#cb6-70" tabindex="-1"></a>      <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">calendarRange</span>(month<span class="op">,</span> month<span class="op">,</span> <span class="st">&#39;month&#39;</span>))</span>
<span id="cb6-71"><a href="#cb6-71" tabindex="-1"></a>    <span class="kw">var</span> totalRain <span class="op">=</span> monthlyRain<span class="op">.</span><span class="fu">sum</span>()</span>
<span id="cb6-72"><a href="#cb6-72" tabindex="-1"></a>    <span class="co">// Next month&#39;s average NDVI</span></span>
<span id="cb6-73"><a href="#cb6-73" tabindex="-1"></a>    <span class="kw">var</span> nextMonth <span class="op">=</span> ee<span class="op">.</span><span class="fu">Number</span>(month)<span class="op">.</span><span class="fu">add</span>(<span class="dv">1</span>)</span>
<span id="cb6-74"><a href="#cb6-74" tabindex="-1"></a>    <span class="kw">var</span> monthly <span class="op">=</span> filteredWithNdvi</span>
<span id="cb6-75"><a href="#cb6-75" tabindex="-1"></a>      <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">calendarRange</span>(nextMonth<span class="op">,</span> nextMonth<span class="op">,</span> <span class="st">&#39;month&#39;</span>))</span>
<span id="cb6-76"><a href="#cb6-76" tabindex="-1"></a>    <span class="kw">var</span> medianComposite <span class="op">=</span> monthly<span class="op">.</span><span class="fu">median</span>()<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;ndvi&#39;</span>)</span>
<span id="cb6-77"><a href="#cb6-77" tabindex="-1"></a>  </span>
<span id="cb6-78"><a href="#cb6-78" tabindex="-1"></a>    <span class="cf">return</span> totalRain<span class="op">.</span><span class="fu">addBands</span>(medianComposite)<span class="op">.</span><span class="fu">set</span>({<span class="st">&#39;month&#39;</span><span class="op">:</span> month})</span>
<span id="cb6-79"><a href="#cb6-79" tabindex="-1"></a>})</span>
<span id="cb6-80"><a href="#cb6-80" tabindex="-1"></a></span>
<span id="cb6-81"><a href="#cb6-81" tabindex="-1"></a><span class="kw">var</span> monthlyCol <span class="op">=</span> ee<span class="op">.</span><span class="at">ImageCollection</span><span class="op">.</span><span class="fu">fromImages</span>(byMonth)<span class="op">;</span></span>
<span id="cb6-82"><a href="#cb6-82" tabindex="-1"></a></span>
<span id="cb6-83"><a href="#cb6-83" tabindex="-1"></a><span class="co">// Compute Correlation</span></span>
<span id="cb6-84"><a href="#cb6-84" tabindex="-1"></a><span class="kw">var</span> correlationCol <span class="op">=</span> monthlyCol<span class="op">.</span><span class="fu">select</span>([<span class="st">&#39;precipitation&#39;</span><span class="op">,</span> <span class="st">&#39;ndvi&#39;</span>])<span class="op">;</span></span>
<span id="cb6-85"><a href="#cb6-85" tabindex="-1"></a><span class="kw">var</span> correlation <span class="op">=</span> correlationCol<span class="op">.</span><span class="fu">reduce</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">pearsonsCorrelation</span>())<span class="op">;</span></span>
<span id="cb6-86"><a href="#cb6-86" tabindex="-1"></a></span>
<span id="cb6-87"><a href="#cb6-87" tabindex="-1"></a><span class="co">// Select all pixels with positive correlation</span></span>
<span id="cb6-88"><a href="#cb6-88" tabindex="-1"></a><span class="kw">var</span> positive <span class="op">=</span> correlation<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;correlation&#39;</span>)<span class="op">.</span><span class="fu">gt</span>(<span class="fl">0.5</span>)</span>
<span id="cb6-89"><a href="#cb6-89" tabindex="-1"></a></span>
<span id="cb6-90"><a href="#cb6-90" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(correlation<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;correlation&#39;</span>)<span class="op">,</span> </span>
<span id="cb6-91"><a href="#cb6-91" tabindex="-1"></a>  {<span class="dt">min</span><span class="op">:-</span><span class="dv">1</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span><span class="dv">1</span><span class="op">,</span> <span class="dt">palette</span><span class="op">:</span> [<span class="st">&#39;red&#39;</span><span class="op">,</span> <span class="st">&#39;white&#39;</span><span class="op">,</span> <span class="st">&#39;green&#39;</span>]}<span class="op">,</span> <span class="st">&#39;Correlation&#39;</span>)<span class="op">;</span></span>
<span id="cb6-92"><a href="#cb6-92" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(positive<span class="op">.</span><span class="fu">selfMask</span>()<span class="op">,</span> </span>
<span id="cb6-93"><a href="#cb6-93" tabindex="-1"></a>  {<span class="dt">palette</span><span class="op">:</span> [<span class="st">&#39;yellow&#39;</span>]}<span class="op">,</span> <span class="st">&#39;Positive Correlation&#39;</span><span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span>   </span></code></pre></div>
</div>
<div id="calculating-band-correlation-matrix" class="section level2">
<h2>Calculating Band Correlation Matrix</h2>
<p>When selecting features for your machine learning model, it is
important to have features which are not correlated with each other.
Correlated features makes it difficult for machine learning models to
discover the interactions between different features. A commonly used
technique to aid in removing redundant variables is to create a
Correlation Matrix. In Earth Engine, you can take a multi-band image and
calculate pair-wise correlation between the bands using either
<code>ee.Reducer.pearsonsCorrelation()</code> or
<code>ee.Reducer.spearmansCorrelation()</code>. The correlation matrix
helps you identify variables that are redundant and can be removed. The
code below also shows how to export the table of features that can be
used in other software to compute correlation.</p>
<div class="figure" style="text-align: center">
<img src="images/end_to_end_gee/correlation_matrix.png" alt="Correlation Matrix created in Python using data exported from GEE" width="80%" />
<p class="caption">
Correlation Matrix created in Python using data exported from GEE
</p>
</div>
<p><a
href="https://code.earthengine.google.co.in/?scriptPath=users%2Fujavalgandhi%2FEnd-to-End-GEE%3ASupplement%2FSupervised_Classification%2FCorrelation_Matrix"
target="_blank">Open in Code Editor ↗</a></p>
<div class="sourceCode" id="cb7"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a><span class="co">// Calculate Pair-wise Correlation Between Bands of an Image</span></span>
<span id="cb7-2"><a href="#cb7-2" tabindex="-1"></a></span>
<span id="cb7-3"><a href="#cb7-3" tabindex="-1"></a><span class="co">// We take a multi-band composite image created in the previous sections</span></span>
<span id="cb7-4"><a href="#cb7-4" tabindex="-1"></a><span class="kw">var</span> composite <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(<span class="st">&#39;users/ujavalgandhi/e2e/arkavathy_multiband_composite&#39;</span>)<span class="op">;</span></span>
<span id="cb7-5"><a href="#cb7-5" tabindex="-1"></a><span class="kw">var</span> visParams <span class="op">=</span> {<span class="dt">bands</span><span class="op">:</span> [<span class="st">&#39;B4&#39;</span><span class="op">,</span> <span class="st">&#39;B3&#39;</span><span class="op">,</span> <span class="st">&#39;B2&#39;</span>]<span class="op">,</span> <span class="dt">min</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span> <span class="dv">3000</span><span class="op">,</span> <span class="dt">gamma</span><span class="op">:</span> <span class="fl">1.2</span>}<span class="op">;</span></span>
<span id="cb7-6"><a href="#cb7-6" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(composite<span class="op">,</span> visParams<span class="op">,</span> <span class="st">&#39;RGB&#39;</span>)<span class="op">;</span></span>
<span id="cb7-7"><a href="#cb7-7" tabindex="-1"></a></span>
<span id="cb7-8"><a href="#cb7-8" tabindex="-1"></a><span class="kw">var</span> basin <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">&#39;WWF/HydroSHEDS/v1/Basins/hybas_7&#39;</span>)<span class="op">;</span></span>
<span id="cb7-9"><a href="#cb7-9" tabindex="-1"></a><span class="kw">var</span> arkavathy <span class="op">=</span> basin<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;HYBAS_ID&#39;</span><span class="op">,</span> <span class="dv">4071139640</span>))<span class="op">;</span></span>
<span id="cb7-10"><a href="#cb7-10" tabindex="-1"></a><span class="kw">var</span> geometry <span class="op">=</span> arkavathy<span class="op">.</span><span class="fu">geometry</span>()<span class="op">;</span></span>
<span id="cb7-11"><a href="#cb7-11" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">centerObject</span>(geometry)<span class="op">;</span></span>
<span id="cb7-12"><a href="#cb7-12" tabindex="-1"></a></span>
<span id="cb7-13"><a href="#cb7-13" tabindex="-1"></a><span class="co">// This image has 18 bands and we want to compute correlation between them.</span></span>
<span id="cb7-14"><a href="#cb7-14" tabindex="-1"></a><span class="co">// Get the band names</span></span>
<span id="cb7-15"><a href="#cb7-15" tabindex="-1"></a><span class="co">// These bands will be the input variables to the model</span></span>
<span id="cb7-16"><a href="#cb7-16" tabindex="-1"></a><span class="kw">var</span> bands <span class="op">=</span> composite<span class="op">.</span><span class="fu">bandNames</span>()<span class="op">;</span></span>
<span id="cb7-17"><a href="#cb7-17" tabindex="-1"></a><span class="fu">print</span>(bands)<span class="op">;</span></span>
<span id="cb7-18"><a href="#cb7-18" tabindex="-1"></a></span>
<span id="cb7-19"><a href="#cb7-19" tabindex="-1"></a></span>
<span id="cb7-20"><a href="#cb7-20" tabindex="-1"></a><span class="co">// Generate random points to sample from the image</span></span>
<span id="cb7-21"><a href="#cb7-21" tabindex="-1"></a><span class="kw">var</span> numPoints <span class="op">=</span> <span class="dv">5000</span></span>
<span id="cb7-22"><a href="#cb7-22" tabindex="-1"></a><span class="kw">var</span> samples <span class="op">=</span> composite<span class="op">.</span><span class="fu">sample</span>({ </span>
<span id="cb7-23"><a href="#cb7-23" tabindex="-1"></a>  <span class="dt">region</span><span class="op">:</span> geometry<span class="op">,</span></span>
<span id="cb7-24"><a href="#cb7-24" tabindex="-1"></a>  <span class="dt">scale</span><span class="op">:</span> <span class="dv">10</span><span class="op">,</span> </span>
<span id="cb7-25"><a href="#cb7-25" tabindex="-1"></a>  <span class="dt">numPixels</span><span class="op">:</span> numPoints<span class="op">,</span></span>
<span id="cb7-26"><a href="#cb7-26" tabindex="-1"></a>  <span class="dt">tileScale</span><span class="op">:</span> <span class="dv">16</span></span>
<span id="cb7-27"><a href="#cb7-27" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb7-28"><a href="#cb7-28" tabindex="-1"></a><span class="fu">print</span>(samples<span class="op">.</span><span class="fu">first</span>())<span class="op">;</span></span>
<span id="cb7-29"><a href="#cb7-29" tabindex="-1"></a></span>
<span id="cb7-30"><a href="#cb7-30" tabindex="-1"></a><span class="co">// Calculate pairwise-correlation between each pair of bands</span></span>
<span id="cb7-31"><a href="#cb7-31" tabindex="-1"></a><span class="co">// Use ee.Reducer.pearsonsCorrelation() for Pearson&#39;s Correlation</span></span>
<span id="cb7-32"><a href="#cb7-32" tabindex="-1"></a><span class="co">// Use ee.Reducer.spearmansCorrelation() for Spearman&#39;s Correlation</span></span>
<span id="cb7-33"><a href="#cb7-33" tabindex="-1"></a><span class="kw">var</span> pairwiseCorr <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(bands<span class="op">.</span><span class="fu">map</span>(<span class="kw">function</span>(i){</span>
<span id="cb7-34"><a href="#cb7-34" tabindex="-1"></a>  <span class="cf">return</span> bands<span class="op">.</span><span class="fu">map</span>(<span class="kw">function</span>(j){</span>
<span id="cb7-35"><a href="#cb7-35" tabindex="-1"></a>    <span class="kw">var</span> stats <span class="op">=</span> samples<span class="op">.</span><span class="fu">reduceColumns</span>({</span>
<span id="cb7-36"><a href="#cb7-36" tabindex="-1"></a>      <span class="dt">reducer</span><span class="op">:</span> ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">pearsonsCorrelation</span>()<span class="op">,</span></span>
<span id="cb7-37"><a href="#cb7-37" tabindex="-1"></a>      <span class="dt">selectors</span><span class="op">:</span> [i<span class="op">,</span>j]</span>
<span id="cb7-38"><a href="#cb7-38" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb7-39"><a href="#cb7-39" tabindex="-1"></a>    <span class="kw">var</span> bandNames <span class="op">=</span> ee<span class="op">.</span><span class="fu">String</span>(i)<span class="op">.</span><span class="fu">cat</span>(<span class="st">&#39;_&#39;</span>)<span class="op">.</span><span class="fu">cat</span>(j)<span class="op">;</span></span>
<span id="cb7-40"><a href="#cb7-40" tabindex="-1"></a>    <span class="cf">return</span> ee<span class="op">.</span><span class="fu">Feature</span>(<span class="kw">null</span><span class="op">,</span> {<span class="st">&#39;correlation&#39;</span><span class="op">:</span> stats<span class="op">.</span><span class="fu">get</span>(<span class="st">&#39;correlation&#39;</span>)<span class="op">,</span> <span class="st">&#39;band&#39;</span><span class="op">:</span> bandNames})<span class="op">;</span>  </span>
<span id="cb7-41"><a href="#cb7-41" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb7-42"><a href="#cb7-42" tabindex="-1"></a>})<span class="op">.</span><span class="fu">flatten</span>())<span class="op">;</span></span>
<span id="cb7-43"><a href="#cb7-43" tabindex="-1"></a></span>
<span id="cb7-44"><a href="#cb7-44" tabindex="-1"></a><span class="co">// Export the table as a CSV file</span></span>
<span id="cb7-45"><a href="#cb7-45" tabindex="-1"></a>Export<span class="op">.</span><span class="at">table</span><span class="op">.</span><span class="fu">toDrive</span>({</span>
<span id="cb7-46"><a href="#cb7-46" tabindex="-1"></a>  <span class="dt">collection</span><span class="op">:</span> pairwiseCorr<span class="op">,</span></span>
<span id="cb7-47"><a href="#cb7-47" tabindex="-1"></a>  <span class="dt">description</span><span class="op">:</span> <span class="st">&#39;Pairwise_Correlation&#39;</span><span class="op">,</span></span>
<span id="cb7-48"><a href="#cb7-48" tabindex="-1"></a>  <span class="dt">folder</span><span class="op">:</span> <span class="st">&#39;earthengine&#39;</span><span class="op">,</span></span>
<span id="cb7-49"><a href="#cb7-49" tabindex="-1"></a>  <span class="dt">fileNamePrefix</span><span class="op">:</span> <span class="st">&#39;pairwise_correlation&#39;</span><span class="op">,</span></span>
<span id="cb7-50"><a href="#cb7-50" tabindex="-1"></a>  <span class="dt">fileFormat</span><span class="op">:</span> <span class="st">&#39;CSV&#39;</span><span class="op">,</span></span>
<span id="cb7-51"><a href="#cb7-51" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb7-52"><a href="#cb7-52" tabindex="-1"></a></span>
<span id="cb7-53"><a href="#cb7-53" tabindex="-1"></a><span class="co">// You can also export the sampled points and calculate correlation</span></span>
<span id="cb7-54"><a href="#cb7-54" tabindex="-1"></a><span class="co">// in Python or R. Reference Python implementation is at</span></span>
<span id="cb7-55"><a href="#cb7-55" tabindex="-1"></a><span class="co">// https://courses.spatialthoughts.com/python-dataviz.html#feature-correlation-matrix</span></span>
<span id="cb7-56"><a href="#cb7-56" tabindex="-1"></a>Export<span class="op">.</span><span class="at">table</span><span class="op">.</span><span class="fu">toDrive</span>({</span>
<span id="cb7-57"><a href="#cb7-57" tabindex="-1"></a>  <span class="dt">collection</span><span class="op">:</span> samples<span class="op">,</span></span>
<span id="cb7-58"><a href="#cb7-58" tabindex="-1"></a>  <span class="dt">description</span><span class="op">:</span> <span class="st">&#39;Feature_Sample_Data&#39;</span><span class="op">,</span></span>
<span id="cb7-59"><a href="#cb7-59" tabindex="-1"></a>  <span class="dt">folder</span><span class="op">:</span> <span class="st">&#39;earthengine&#39;</span><span class="op">,</span></span>
<span id="cb7-60"><a href="#cb7-60" tabindex="-1"></a>  <span class="dt">fileNamePrefix</span><span class="op">:</span> <span class="st">&#39;feature_sample_data&#39;</span><span class="op">,</span></span>
<span id="cb7-61"><a href="#cb7-61" tabindex="-1"></a>  <span class="dt">fileFormat</span><span class="op">:</span> <span class="st">&#39;CSV&#39;</span><span class="op">,</span></span>
<span id="cb7-62"><a href="#cb7-62" tabindex="-1"></a>  <span class="dt">selectors</span><span class="op">:</span> bands<span class="op">.</span><span class="fu">getInfo</span>()</span>
<span id="cb7-63"><a href="#cb7-63" tabindex="-1"></a>})<span class="op">;</span></span></code></pre></div>
</div>
<div id="calculating-area-by-class" class="section level2">
<h2>Calculating Area by Class</h2>
<p>This code snippet shows how to use a <a
href="https://developers.google.com/earth-engine/guides/reducers_grouping">Grouped
Reducer</a> to calculate area covered by each class in a classified
image. It also shows how to use the
<code>ui.Chart.feature.byProperty()</code> function to create a column
chart and the <code>ui.Chart.feature.byFeature()</code> function to
create a pie chart with areas of each class.</p>
<p><img src="images/end_to_end_gee/area_by_class_bar.png" width="50%" style="display: block; margin: auto;" /></p>
<p><img src="images/end_to_end_gee/area_by_class_pie.png" width="50%" style="display: block; margin: auto;" /></p>
<p><a
href="https://code.earthengine.google.co.in/?scriptPath=users%2Fujavalgandhi%2FEnd-to-End-GEE%3ASupplement%2FSupervised_Classification%2FCalculating_Area_by_Class"
target="_blank">Open in Code Editor ↗</a></p>
<div class="sourceCode" id="cb8"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a><span class="kw">var</span> classified <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(<span class="st">&quot;users/ujavalgandhi/e2e/bangalore_classified&quot;</span>)<span class="op">;</span></span>
<span id="cb8-2"><a href="#cb8-2" tabindex="-1"></a><span class="kw">var</span> bangalore <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">&quot;users/ujavalgandhi/public/bangalore_boundary&quot;</span>)<span class="op">;</span></span>
<span id="cb8-3"><a href="#cb8-3" tabindex="-1"></a><span class="kw">var</span> geometry <span class="op">=</span> bangalore<span class="op">.</span><span class="fu">geometry</span>()<span class="op">;</span></span>
<span id="cb8-4"><a href="#cb8-4" tabindex="-1"></a></span>
<span id="cb8-5"><a href="#cb8-5" tabindex="-1"></a><span class="kw">var</span> palette <span class="op">=</span> [<span class="st">&#39;#cc6d8f&#39;</span><span class="op">,</span> <span class="st">&#39;#ffc107&#39;</span><span class="op">,</span> <span class="st">&#39;#1e88e5&#39;</span><span class="op">,</span> <span class="st">&#39;#004d40&#39;</span> ]<span class="op">;</span></span>
<span id="cb8-6"><a href="#cb8-6" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(classified<span class="op">,</span> {<span class="dt">min</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span> <span class="dv">3</span><span class="op">,</span> <span class="dt">palette</span><span class="op">:</span> palette}<span class="op">,</span> <span class="st">&#39;2019&#39;</span>)<span class="op">;</span></span>
<span id="cb8-7"><a href="#cb8-7" tabindex="-1"></a></span>
<span id="cb8-8"><a href="#cb8-8" tabindex="-1"></a><span class="co">// We can calculate the areas of all classes in a single pass</span></span>
<span id="cb8-9"><a href="#cb8-9" tabindex="-1"></a><span class="co">// using a Grouped Reducer. Learn more at </span></span>
<span id="cb8-10"><a href="#cb8-10" tabindex="-1"></a><span class="co">// https://spatialthoughts.com/2020/06/19/calculating-area-gee/</span></span>
<span id="cb8-11"><a href="#cb8-11" tabindex="-1"></a></span>
<span id="cb8-12"><a href="#cb8-12" tabindex="-1"></a><span class="co">// First create a 2 band image with the area image and the classified image</span></span>
<span id="cb8-13"><a href="#cb8-13" tabindex="-1"></a><span class="co">// Divide the area image by 1e6 so area results are in Sq Km</span></span>
<span id="cb8-14"><a href="#cb8-14" tabindex="-1"></a><span class="kw">var</span> areaImage <span class="op">=</span> ee<span class="op">.</span><span class="at">Image</span><span class="op">.</span><span class="fu">pixelArea</span>()<span class="op">.</span><span class="fu">divide</span>(<span class="fl">1e6</span>)<span class="op">.</span><span class="fu">addBands</span>(classified)<span class="op">;</span></span>
<span id="cb8-15"><a href="#cb8-15" tabindex="-1"></a></span>
<span id="cb8-16"><a href="#cb8-16" tabindex="-1"></a><span class="co">// Calculate areas</span></span>
<span id="cb8-17"><a href="#cb8-17" tabindex="-1"></a><span class="kw">var</span> areas <span class="op">=</span> areaImage<span class="op">.</span><span class="fu">reduceRegion</span>({</span>
<span id="cb8-18"><a href="#cb8-18" tabindex="-1"></a>      <span class="dt">reducer</span><span class="op">:</span> ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">sum</span>()<span class="op">.</span><span class="fu">group</span>({</span>
<span id="cb8-19"><a href="#cb8-19" tabindex="-1"></a>      <span class="dt">groupField</span><span class="op">:</span> <span class="dv">1</span><span class="op">,</span></span>
<span id="cb8-20"><a href="#cb8-20" tabindex="-1"></a>      <span class="dt">groupName</span><span class="op">:</span> <span class="st">&#39;classification&#39;</span><span class="op">,</span></span>
<span id="cb8-21"><a href="#cb8-21" tabindex="-1"></a>    })<span class="op">,</span></span>
<span id="cb8-22"><a href="#cb8-22" tabindex="-1"></a>    <span class="dt">geometry</span><span class="op">:</span> geometry<span class="op">,</span></span>
<span id="cb8-23"><a href="#cb8-23" tabindex="-1"></a>    <span class="dt">scale</span><span class="op">:</span> <span class="dv">10</span><span class="op">,</span></span>
<span id="cb8-24"><a href="#cb8-24" tabindex="-1"></a>    <span class="dt">maxPixels</span><span class="op">:</span> <span class="fl">1e10</span></span>
<span id="cb8-25"><a href="#cb8-25" tabindex="-1"></a>    })<span class="op">;</span> </span>
<span id="cb8-26"><a href="#cb8-26" tabindex="-1"></a> </span>
<span id="cb8-27"><a href="#cb8-27" tabindex="-1"></a><span class="kw">var</span> classAreas <span class="op">=</span> ee<span class="op">.</span><span class="fu">List</span>(areas<span class="op">.</span><span class="fu">get</span>(<span class="st">&#39;groups&#39;</span>))</span>
<span id="cb8-28"><a href="#cb8-28" tabindex="-1"></a></span>
<span id="cb8-29"><a href="#cb8-29" tabindex="-1"></a><span class="co">// Process results to extract the areas and</span></span>
<span id="cb8-30"><a href="#cb8-30" tabindex="-1"></a><span class="co">// create a FeatureCollection</span></span>
<span id="cb8-31"><a href="#cb8-31" tabindex="-1"></a></span>
<span id="cb8-32"><a href="#cb8-32" tabindex="-1"></a><span class="co">// We can define a dictionary with class names</span></span>
<span id="cb8-33"><a href="#cb8-33" tabindex="-1"></a><span class="kw">var</span> classNames <span class="op">=</span> ee<span class="op">.</span><span class="fu">Dictionary</span>({</span>
<span id="cb8-34"><a href="#cb8-34" tabindex="-1"></a>  <span class="st">&#39;0&#39;</span><span class="op">:</span> <span class="st">&#39;urban&#39;</span><span class="op">,</span></span>
<span id="cb8-35"><a href="#cb8-35" tabindex="-1"></a>  <span class="st">&#39;1&#39;</span><span class="op">:</span> <span class="st">&#39;bare&#39;</span><span class="op">,</span></span>
<span id="cb8-36"><a href="#cb8-36" tabindex="-1"></a>  <span class="st">&#39;2&#39;</span><span class="op">:</span> <span class="st">&#39;water&#39;</span><span class="op">,</span></span>
<span id="cb8-37"><a href="#cb8-37" tabindex="-1"></a>  <span class="st">&#39;3&#39;</span><span class="op">:</span> <span class="st">&#39;vegetation&#39;</span></span>
<span id="cb8-38"><a href="#cb8-38" tabindex="-1"></a>})</span>
<span id="cb8-39"><a href="#cb8-39" tabindex="-1"></a></span>
<span id="cb8-40"><a href="#cb8-40" tabindex="-1"></a><span class="kw">var</span> classAreas <span class="op">=</span> classAreas<span class="op">.</span><span class="fu">map</span>(<span class="kw">function</span>(item) {</span>
<span id="cb8-41"><a href="#cb8-41" tabindex="-1"></a>  <span class="kw">var</span> areaDict <span class="op">=</span> ee<span class="op">.</span><span class="fu">Dictionary</span>(item)</span>
<span id="cb8-42"><a href="#cb8-42" tabindex="-1"></a>  <span class="kw">var</span> classNumber <span class="op">=</span> ee<span class="op">.</span><span class="fu">Number</span>(areaDict<span class="op">.</span><span class="fu">get</span>(<span class="st">&#39;classification&#39;</span>))<span class="op">.</span><span class="fu">format</span>()<span class="op">;</span></span>
<span id="cb8-43"><a href="#cb8-43" tabindex="-1"></a>  <span class="kw">var</span> className <span class="op">=</span> classNames<span class="op">.</span><span class="fu">get</span>(classNumber)<span class="op">;</span></span>
<span id="cb8-44"><a href="#cb8-44" tabindex="-1"></a>  <span class="kw">var</span> area <span class="op">=</span> ee<span class="op">.</span><span class="fu">Number</span>(</span>
<span id="cb8-45"><a href="#cb8-45" tabindex="-1"></a>    areaDict<span class="op">.</span><span class="fu">get</span>(<span class="st">&#39;sum&#39;</span>))</span>
<span id="cb8-46"><a href="#cb8-46" tabindex="-1"></a>  <span class="cf">return</span> ee<span class="op">.</span><span class="fu">Feature</span>(<span class="kw">null</span><span class="op">,</span> {<span class="st">&#39;class&#39;</span><span class="op">:</span> classNumber<span class="op">,</span> <span class="st">&#39;class_name&#39;</span><span class="op">:</span> className<span class="op">,</span> <span class="st">&#39;area&#39;</span><span class="op">:</span> area})</span>
<span id="cb8-47"><a href="#cb8-47" tabindex="-1"></a>})</span>
<span id="cb8-48"><a href="#cb8-48" tabindex="-1"></a></span>
<span id="cb8-49"><a href="#cb8-49" tabindex="-1"></a><span class="kw">var</span> classAreaFc <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(classAreas)<span class="op">;</span></span>
<span id="cb8-50"><a href="#cb8-50" tabindex="-1"></a></span>
<span id="cb8-51"><a href="#cb8-51" tabindex="-1"></a><span class="co">// We can now chart the resulting FeatureCollection</span></span>
<span id="cb8-52"><a href="#cb8-52" tabindex="-1"></a><span class="co">// If your area is large, it is advisable to first Export</span></span>
<span id="cb8-53"><a href="#cb8-53" tabindex="-1"></a><span class="co">// the FeatureCollection as an Asset and import it once</span></span>
<span id="cb8-54"><a href="#cb8-54" tabindex="-1"></a><span class="co">// the export is finished.</span></span>
<span id="cb8-55"><a href="#cb8-55" tabindex="-1"></a><span class="co">// Let&#39;s create a Bar Chart</span></span>
<span id="cb8-56"><a href="#cb8-56" tabindex="-1"></a><span class="kw">var</span> areaChart <span class="op">=</span> ui<span class="op">.</span><span class="at">Chart</span><span class="op">.</span><span class="at">feature</span><span class="op">.</span><span class="fu">byProperty</span>({</span>
<span id="cb8-57"><a href="#cb8-57" tabindex="-1"></a>  <span class="dt">features</span><span class="op">:</span> classAreaFc<span class="op">,</span></span>
<span id="cb8-58"><a href="#cb8-58" tabindex="-1"></a>  <span class="dt">xProperties</span><span class="op">:</span> [<span class="st">&#39;area&#39;</span>]<span class="op">,</span></span>
<span id="cb8-59"><a href="#cb8-59" tabindex="-1"></a>  <span class="dt">seriesProperty</span><span class="op">:</span> <span class="st">&#39;class_name&#39;</span><span class="op">,</span></span>
<span id="cb8-60"><a href="#cb8-60" tabindex="-1"></a>})<span class="op">.</span><span class="fu">setChartType</span>(<span class="st">&#39;ColumnChart&#39;</span>)</span>
<span id="cb8-61"><a href="#cb8-61" tabindex="-1"></a>  <span class="op">.</span><span class="fu">setOptions</span>({</span>
<span id="cb8-62"><a href="#cb8-62" tabindex="-1"></a>    <span class="dt">hAxis</span><span class="op">:</span> {<span class="dt">title</span><span class="op">:</span> <span class="st">&#39;Classes&#39;</span>}<span class="op">,</span></span>
<span id="cb8-63"><a href="#cb8-63" tabindex="-1"></a>    <span class="dt">vAxis</span><span class="op">:</span> {<span class="dt">title</span><span class="op">:</span> <span class="st">&#39;Area Km^2&#39;</span>}<span class="op">,</span></span>
<span id="cb8-64"><a href="#cb8-64" tabindex="-1"></a>    <span class="dt">title</span><span class="op">:</span> <span class="st">&#39;Area by class&#39;</span><span class="op">,</span></span>
<span id="cb8-65"><a href="#cb8-65" tabindex="-1"></a>    <span class="dt">series</span><span class="op">:</span> {</span>
<span id="cb8-66"><a href="#cb8-66" tabindex="-1"></a>      <span class="dv">0</span><span class="op">:</span> { <span class="dt">color</span><span class="op">:</span> <span class="st">&#39;#cc6d8f&#39;</span> }<span class="op">,</span></span>
<span id="cb8-67"><a href="#cb8-67" tabindex="-1"></a>      <span class="dv">1</span><span class="op">:</span> { <span class="dt">color</span><span class="op">:</span> <span class="st">&#39;#ffc107&#39;</span> }<span class="op">,</span></span>
<span id="cb8-68"><a href="#cb8-68" tabindex="-1"></a>      <span class="dv">2</span><span class="op">:</span> { <span class="dt">color</span><span class="op">:</span> <span class="st">&#39;#1e88e5&#39;</span> }<span class="op">,</span></span>
<span id="cb8-69"><a href="#cb8-69" tabindex="-1"></a>      <span class="dv">3</span><span class="op">:</span> { <span class="dt">color</span><span class="op">:</span> <span class="st">&#39;#004d40&#39;</span> }</span>
<span id="cb8-70"><a href="#cb8-70" tabindex="-1"></a>    }</span>
<span id="cb8-71"><a href="#cb8-71" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb8-72"><a href="#cb8-72" tabindex="-1"></a><span class="fu">print</span>(areaChart)<span class="op">;</span> </span>
<span id="cb8-73"><a href="#cb8-73" tabindex="-1"></a></span>
<span id="cb8-74"><a href="#cb8-74" tabindex="-1"></a><span class="co">// We can also create a Pie-Chart</span></span>
<span id="cb8-75"><a href="#cb8-75" tabindex="-1"></a><span class="kw">var</span> areaChart <span class="op">=</span> ui<span class="op">.</span><span class="at">Chart</span><span class="op">.</span><span class="at">feature</span><span class="op">.</span><span class="fu">byFeature</span>({</span>
<span id="cb8-76"><a href="#cb8-76" tabindex="-1"></a>  <span class="dt">features</span><span class="op">:</span> classAreaFc<span class="op">,</span></span>
<span id="cb8-77"><a href="#cb8-77" tabindex="-1"></a>  <span class="dt">xProperty</span><span class="op">:</span> <span class="st">&#39;class_name&#39;</span><span class="op">,</span></span>
<span id="cb8-78"><a href="#cb8-78" tabindex="-1"></a>  <span class="dt">yProperties</span><span class="op">:</span> [<span class="st">&#39;area&#39;</span>]</span>
<span id="cb8-79"><a href="#cb8-79" tabindex="-1"></a>})<span class="op">.</span><span class="fu">setChartType</span>(<span class="st">&#39;PieChart&#39;</span>)</span>
<span id="cb8-80"><a href="#cb8-80" tabindex="-1"></a>  <span class="op">.</span><span class="fu">setOptions</span>({</span>
<span id="cb8-81"><a href="#cb8-81" tabindex="-1"></a>    <span class="dt">hAxis</span><span class="op">:</span> {<span class="dt">title</span><span class="op">:</span> <span class="st">&#39;Classes&#39;</span>}<span class="op">,</span></span>
<span id="cb8-82"><a href="#cb8-82" tabindex="-1"></a>    <span class="dt">vAxis</span><span class="op">:</span> {<span class="dt">title</span><span class="op">:</span> <span class="st">&#39;Area Km^2&#39;</span>}<span class="op">,</span></span>
<span id="cb8-83"><a href="#cb8-83" tabindex="-1"></a>    <span class="dt">title</span><span class="op">:</span> <span class="st">&#39;Area by class&#39;</span><span class="op">,</span></span>
<span id="cb8-84"><a href="#cb8-84" tabindex="-1"></a>    <span class="dt">colors</span><span class="op">:</span> palette</span>
<span id="cb8-85"><a href="#cb8-85" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb8-86"><a href="#cb8-86" tabindex="-1"></a><span class="fu">print</span>(areaChart)<span class="op">;</span> </span></code></pre></div>
</div>
<div id="spectral-signature-plots" class="section level2">
<h2>Spectral Signature Plots</h2>
<p>For supervised classification, it is useful to visualize average
spectral responses for each band for each class. Such charts are called
<em>Spectral Response Curves</em> or <em>Spectral Signatures</em>. Such
charts helps determine separability of classes. If classes have very
different signatures, a classifier will be able to separate them
well.</p>
<p>We can also plot spectral signatures of all training samples for a
class and check the quality of the training dataset. If all training
samples show similar signatures - it indicates that you have done a good
job of collecting appropriate samples. You can also catch potential
outliers from these plots.</p>
<p>These charts provide a qualitative and visual methods for checking
separability of classes. For quantitative methods, one can apply
measures such as Spectral Distance, Mahalanobis distance, Bhattacharyya
distance , Jeffreys-Matusita (JM) distance etc. You can find the code
for these in <a href="https://gis.stackexchange.com/a/323778/5160">this
Stack Exchange answer</a>.</p>
<div class="figure" style="text-align: center">
<img src="images/end_to_end_gee/mean_signatures.png" alt="Mean Signatures for All Classes" width="100%" />
<p class="caption">
Mean Signatures for All Classes
</p>
</div>
<div class="figure" style="text-align: center">
<img src="images/end_to_end_gee/spectral_signatures.png" alt="Spectral Signatures for All Training Points by Class" width="100%" />
<p class="caption">
Spectral Signatures for All Training Points by Class
</p>
</div>
<p><a
href="https://code.earthengine.google.co.in/?scriptPath=users%2Fujavalgandhi%2FEnd-to-End-GEE%3ASupplement%2FSupervised_Classification%2FSpectral_Signatures"
target="_blank">Open in Code Editor ↗</a></p>
<div class="sourceCode" id="cb9"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a><span class="kw">var</span> gcps <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">&quot;users/ujavalgandhi/e2e/bangalore_gcps&quot;</span>)<span class="op">;</span></span>
<span id="cb9-2"><a href="#cb9-2" tabindex="-1"></a><span class="kw">var</span> composite <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(<span class="st">&#39;users/ujavalgandhi/e2e/bangalore_composite&#39;</span>)<span class="op">;</span></span>
<span id="cb9-3"><a href="#cb9-3" tabindex="-1"></a></span>
<span id="cb9-4"><a href="#cb9-4" tabindex="-1"></a><span class="co">// Overlay the point on the image to get bands data.</span></span>
<span id="cb9-5"><a href="#cb9-5" tabindex="-1"></a><span class="kw">var</span> training <span class="op">=</span> composite<span class="op">.</span><span class="fu">sampleRegions</span>({</span>
<span id="cb9-6"><a href="#cb9-6" tabindex="-1"></a>  <span class="dt">collection</span><span class="op">:</span> gcps<span class="op">,</span> </span>
<span id="cb9-7"><a href="#cb9-7" tabindex="-1"></a>  <span class="dt">properties</span><span class="op">:</span> [<span class="st">&#39;landcover&#39;</span>]<span class="op">,</span> </span>
<span id="cb9-8"><a href="#cb9-8" tabindex="-1"></a>  <span class="dt">scale</span><span class="op">:</span> <span class="dv">10</span></span>
<span id="cb9-9"><a href="#cb9-9" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb9-10"><a href="#cb9-10" tabindex="-1"></a></span>
<span id="cb9-11"><a href="#cb9-11" tabindex="-1"></a></span>
<span id="cb9-12"><a href="#cb9-12" tabindex="-1"></a><span class="co">// We will create a chart of spectral signature for all classes</span></span>
<span id="cb9-13"><a href="#cb9-13" tabindex="-1"></a></span>
<span id="cb9-14"><a href="#cb9-14" tabindex="-1"></a><span class="co">// We have multiple GCPs for each class</span></span>
<span id="cb9-15"><a href="#cb9-15" tabindex="-1"></a><span class="co">// Use a grouped reducer to calculate the average reflectance</span></span>
<span id="cb9-16"><a href="#cb9-16" tabindex="-1"></a><span class="co">// for each band for each class</span></span>
<span id="cb9-17"><a href="#cb9-17" tabindex="-1"></a></span>
<span id="cb9-18"><a href="#cb9-18" tabindex="-1"></a><span class="co">// We have 12 bands so need to repeat the reducer 12 times</span></span>
<span id="cb9-19"><a href="#cb9-19" tabindex="-1"></a><span class="co">// We also need to group the results by class</span></span>
<span id="cb9-20"><a href="#cb9-20" tabindex="-1"></a><span class="co">// So we find the index of the landcover property and use it</span></span>
<span id="cb9-21"><a href="#cb9-21" tabindex="-1"></a><span class="co">// to group the results</span></span>
<span id="cb9-22"><a href="#cb9-22" tabindex="-1"></a><span class="kw">var</span> bands <span class="op">=</span> composite<span class="op">.</span><span class="fu">bandNames</span>()</span>
<span id="cb9-23"><a href="#cb9-23" tabindex="-1"></a><span class="kw">var</span> numBands <span class="op">=</span> bands<span class="op">.</span><span class="fu">length</span>()</span>
<span id="cb9-24"><a href="#cb9-24" tabindex="-1"></a><span class="kw">var</span> bandsWithClass <span class="op">=</span> bands<span class="op">.</span><span class="fu">add</span>(<span class="st">&#39;landcover&#39;</span>)</span>
<span id="cb9-25"><a href="#cb9-25" tabindex="-1"></a><span class="kw">var</span> classIndex <span class="op">=</span> bandsWithClass<span class="op">.</span><span class="fu">indexOf</span>(<span class="st">&#39;landcover&#39;</span>)</span>
<span id="cb9-26"><a href="#cb9-26" tabindex="-1"></a></span>
<span id="cb9-27"><a href="#cb9-27" tabindex="-1"></a><span class="co">// Use .combine() to get a reducer capable of </span></span>
<span id="cb9-28"><a href="#cb9-28" tabindex="-1"></a><span class="co">// computing multiple stats on the input</span></span>
<span id="cb9-29"><a href="#cb9-29" tabindex="-1"></a><span class="kw">var</span> combinedReducer <span class="op">=</span> ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">mean</span>()<span class="op">.</span><span class="fu">combine</span>({</span>
<span id="cb9-30"><a href="#cb9-30" tabindex="-1"></a>  <span class="dt">reducer2</span><span class="op">:</span> ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">stdDev</span>()<span class="op">,</span></span>
<span id="cb9-31"><a href="#cb9-31" tabindex="-1"></a>  <span class="dt">sharedInputs</span><span class="op">:</span> <span class="kw">true</span>})</span>
<span id="cb9-32"><a href="#cb9-32" tabindex="-1"></a></span>
<span id="cb9-33"><a href="#cb9-33" tabindex="-1"></a><span class="co">// Use .repeat() to get a reducer for each band</span></span>
<span id="cb9-34"><a href="#cb9-34" tabindex="-1"></a><span class="co">// We then use .group() to get stats by class</span></span>
<span id="cb9-35"><a href="#cb9-35" tabindex="-1"></a><span class="kw">var</span> repeatedReducer <span class="op">=</span> combinedReducer<span class="op">.</span><span class="fu">repeat</span>(numBands)<span class="op">.</span><span class="fu">group</span>(classIndex)</span>
<span id="cb9-36"><a href="#cb9-36" tabindex="-1"></a></span>
<span id="cb9-37"><a href="#cb9-37" tabindex="-1"></a><span class="kw">var</span> gcpStats <span class="op">=</span> training<span class="op">.</span><span class="fu">reduceColumns</span>({</span>
<span id="cb9-38"><a href="#cb9-38" tabindex="-1"></a>    <span class="dt">selectors</span><span class="op">:</span> bands<span class="op">.</span><span class="fu">add</span>(<span class="st">&#39;landcover&#39;</span>)<span class="op">,</span></span>
<span id="cb9-39"><a href="#cb9-39" tabindex="-1"></a>    <span class="dt">reducer</span><span class="op">:</span> repeatedReducer<span class="op">,</span></span>
<span id="cb9-40"><a href="#cb9-40" tabindex="-1"></a>})</span>
<span id="cb9-41"><a href="#cb9-41" tabindex="-1"></a></span>
<span id="cb9-42"><a href="#cb9-42" tabindex="-1"></a><span class="co">// Result is a dictionary, we do some post-processing to</span></span>
<span id="cb9-43"><a href="#cb9-43" tabindex="-1"></a><span class="co">// extract the results</span></span>
<span id="cb9-44"><a href="#cb9-44" tabindex="-1"></a><span class="kw">var</span> groups <span class="op">=</span> ee<span class="op">.</span><span class="fu">List</span>(gcpStats<span class="op">.</span><span class="fu">get</span>(<span class="st">&#39;groups&#39;</span>))</span>
<span id="cb9-45"><a href="#cb9-45" tabindex="-1"></a></span>
<span id="cb9-46"><a href="#cb9-46" tabindex="-1"></a><span class="kw">var</span> classNames <span class="op">=</span> ee<span class="op">.</span><span class="fu">List</span>([<span class="st">&#39;urban&#39;</span><span class="op">,</span> <span class="st">&#39;bare&#39;</span><span class="op">,</span> <span class="st">&#39;water&#39;</span><span class="op">,</span> <span class="st">&#39;vegetation&#39;</span>])</span>
<span id="cb9-47"><a href="#cb9-47" tabindex="-1"></a></span>
<span id="cb9-48"><a href="#cb9-48" tabindex="-1"></a><span class="kw">var</span> fc <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(groups<span class="op">.</span><span class="fu">map</span>(<span class="kw">function</span>(item) {</span>
<span id="cb9-49"><a href="#cb9-49" tabindex="-1"></a>  <span class="co">// Extract the means</span></span>
<span id="cb9-50"><a href="#cb9-50" tabindex="-1"></a>  <span class="kw">var</span> values <span class="op">=</span> ee<span class="op">.</span><span class="fu">Dictionary</span>(item)<span class="op">.</span><span class="fu">get</span>(<span class="st">&#39;mean&#39;</span>)</span>
<span id="cb9-51"><a href="#cb9-51" tabindex="-1"></a>  <span class="kw">var</span> groupNumber <span class="op">=</span> ee<span class="op">.</span><span class="fu">Dictionary</span>(item)<span class="op">.</span><span class="fu">get</span>(<span class="st">&#39;group&#39;</span>)</span>
<span id="cb9-52"><a href="#cb9-52" tabindex="-1"></a>  <span class="kw">var</span> properties <span class="op">=</span> ee<span class="op">.</span><span class="at">Dictionary</span><span class="op">.</span><span class="fu">fromLists</span>(bands<span class="op">,</span> values)</span>
<span id="cb9-53"><a href="#cb9-53" tabindex="-1"></a>  <span class="kw">var</span> withClass <span class="op">=</span> properties<span class="op">.</span><span class="fu">set</span>(<span class="st">&#39;class&#39;</span><span class="op">,</span> classNames<span class="op">.</span><span class="fu">get</span>(groupNumber))</span>
<span id="cb9-54"><a href="#cb9-54" tabindex="-1"></a>  <span class="cf">return</span> ee<span class="op">.</span><span class="fu">Feature</span>(<span class="kw">null</span><span class="op">,</span> withClass)</span>
<span id="cb9-55"><a href="#cb9-55" tabindex="-1"></a>}))</span>
<span id="cb9-56"><a href="#cb9-56" tabindex="-1"></a></span>
<span id="cb9-57"><a href="#cb9-57" tabindex="-1"></a><span class="co">// Chart spectral signatures of training data</span></span>
<span id="cb9-58"><a href="#cb9-58" tabindex="-1"></a><span class="kw">var</span> options <span class="op">=</span> {</span>
<span id="cb9-59"><a href="#cb9-59" tabindex="-1"></a>  <span class="dt">title</span><span class="op">:</span> <span class="st">&#39;Average Spectral Signatures&#39;</span><span class="op">,</span></span>
<span id="cb9-60"><a href="#cb9-60" tabindex="-1"></a>  <span class="dt">hAxis</span><span class="op">:</span> {<span class="dt">title</span><span class="op">:</span> <span class="st">&#39;Bands&#39;</span>}<span class="op">,</span></span>
<span id="cb9-61"><a href="#cb9-61" tabindex="-1"></a>  <span class="dt">vAxis</span><span class="op">:</span> {<span class="dt">title</span><span class="op">:</span> <span class="st">&#39;Reflectance&#39;</span>}<span class="op">,</span></span>
<span id="cb9-62"><a href="#cb9-62" tabindex="-1"></a>  <span class="dt">lineWidth</span><span class="op">:</span> <span class="dv">1</span><span class="op">,</span></span>
<span id="cb9-63"><a href="#cb9-63" tabindex="-1"></a>  <span class="dt">pointSize</span><span class="op">:</span> <span class="dv">4</span><span class="op">,</span></span>
<span id="cb9-64"><a href="#cb9-64" tabindex="-1"></a>  <span class="dt">series</span><span class="op">:</span> {</span>
<span id="cb9-65"><a href="#cb9-65" tabindex="-1"></a>    <span class="dv">0</span><span class="op">:</span> {<span class="dt">color</span><span class="op">:</span> <span class="st">&#39;grey&#39;</span>}<span class="op">,</span> </span>
<span id="cb9-66"><a href="#cb9-66" tabindex="-1"></a>    <span class="dv">1</span><span class="op">:</span> {<span class="dt">color</span><span class="op">:</span> <span class="st">&#39;brown&#39;</span>}<span class="op">,</span> </span>
<span id="cb9-67"><a href="#cb9-67" tabindex="-1"></a>    <span class="dv">2</span><span class="op">:</span> {<span class="dt">color</span><span class="op">:</span> <span class="st">&#39;blue&#39;</span>}<span class="op">,</span> </span>
<span id="cb9-68"><a href="#cb9-68" tabindex="-1"></a>    <span class="dv">3</span><span class="op">:</span> {<span class="dt">color</span><span class="op">:</span> <span class="st">&#39;green&#39;</span>}<span class="op">,</span></span>
<span id="cb9-69"><a href="#cb9-69" tabindex="-1"></a>}}<span class="op">;</span></span>
<span id="cb9-70"><a href="#cb9-70" tabindex="-1"></a></span>
<span id="cb9-71"><a href="#cb9-71" tabindex="-1"></a><span class="co">// Default band names don&#39;t sort propertly</span></span>
<span id="cb9-72"><a href="#cb9-72" tabindex="-1"></a><span class="co">// Instead, we can give a dictionary with</span></span>
<span id="cb9-73"><a href="#cb9-73" tabindex="-1"></a><span class="co">// labels for each band in the X-Axis</span></span>
<span id="cb9-74"><a href="#cb9-74" tabindex="-1"></a><span class="kw">var</span> bandDescriptions <span class="op">=</span> {</span>
<span id="cb9-75"><a href="#cb9-75" tabindex="-1"></a>  <span class="st">&#39;B2&#39;</span><span class="op">:</span> <span class="st">&#39;B02/Blue&#39;</span><span class="op">,</span></span>
<span id="cb9-76"><a href="#cb9-76" tabindex="-1"></a>  <span class="st">&#39;B3&#39;</span><span class="op">:</span> <span class="st">&#39;B03/Green&#39;</span><span class="op">,</span></span>
<span id="cb9-77"><a href="#cb9-77" tabindex="-1"></a>  <span class="st">&#39;B4&#39;</span><span class="op">:</span> <span class="st">&#39;B04/Red&#39;</span><span class="op">,</span></span>
<span id="cb9-78"><a href="#cb9-78" tabindex="-1"></a>  <span class="st">&#39;B8&#39;</span><span class="op">:</span> <span class="st">&#39;B08/NIR&#39;</span><span class="op">,</span></span>
<span id="cb9-79"><a href="#cb9-79" tabindex="-1"></a>  <span class="st">&#39;B11&#39;</span><span class="op">:</span> <span class="st">&#39;B11/SWIR-1&#39;</span><span class="op">,</span></span>
<span id="cb9-80"><a href="#cb9-80" tabindex="-1"></a>  <span class="st">&#39;B12&#39;</span><span class="op">:</span> <span class="st">&#39;B12/SWIR-2&#39;</span></span>
<span id="cb9-81"><a href="#cb9-81" tabindex="-1"></a>}</span>
<span id="cb9-82"><a href="#cb9-82" tabindex="-1"></a><span class="co">// Create the chart and set options.</span></span>
<span id="cb9-83"><a href="#cb9-83" tabindex="-1"></a><span class="kw">var</span> chart <span class="op">=</span> ui<span class="op">.</span><span class="at">Chart</span><span class="op">.</span><span class="at">feature</span><span class="op">.</span><span class="fu">byProperty</span>({</span>
<span id="cb9-84"><a href="#cb9-84" tabindex="-1"></a>  <span class="dt">features</span><span class="op">:</span> fc<span class="op">,</span></span>
<span id="cb9-85"><a href="#cb9-85" tabindex="-1"></a>  <span class="dt">xProperties</span><span class="op">:</span> bandDescriptions<span class="op">,</span></span>
<span id="cb9-86"><a href="#cb9-86" tabindex="-1"></a>  <span class="dt">seriesProperty</span><span class="op">:</span> <span class="st">&#39;class&#39;</span></span>
<span id="cb9-87"><a href="#cb9-87" tabindex="-1"></a>})</span>
<span id="cb9-88"><a href="#cb9-88" tabindex="-1"></a><span class="op">.</span><span class="fu">setChartType</span>(<span class="st">&#39;ScatterChart&#39;</span>)</span>
<span id="cb9-89"><a href="#cb9-89" tabindex="-1"></a><span class="op">.</span><span class="fu">setOptions</span>(options)<span class="op">;</span></span>
<span id="cb9-90"><a href="#cb9-90" tabindex="-1"></a></span>
<span id="cb9-91"><a href="#cb9-91" tabindex="-1"></a><span class="fu">print</span>(chart)</span>
<span id="cb9-92"><a href="#cb9-92" tabindex="-1"></a></span>
<span id="cb9-93"><a href="#cb9-93" tabindex="-1"></a><span class="kw">var</span> classChart <span class="op">=</span> <span class="kw">function</span>(landcover<span class="op">,</span> label<span class="op">,</span> color) {</span>
<span id="cb9-94"><a href="#cb9-94" tabindex="-1"></a>  <span class="kw">var</span> options <span class="op">=</span> {</span>
<span id="cb9-95"><a href="#cb9-95" tabindex="-1"></a>  <span class="dt">title</span><span class="op">:</span> <span class="st">&#39;Spectral Signatures for &#39;</span> <span class="op">+</span> label <span class="op">+</span> <span class="st">&#39; Class&#39;</span><span class="op">,</span></span>
<span id="cb9-96"><a href="#cb9-96" tabindex="-1"></a>  <span class="dt">hAxis</span><span class="op">:</span> {<span class="dt">title</span><span class="op">:</span> <span class="st">&#39;Bands&#39;</span>}<span class="op">,</span></span>
<span id="cb9-97"><a href="#cb9-97" tabindex="-1"></a>  <span class="dt">vAxis</span><span class="op">:</span> {<span class="dt">title</span><span class="op">:</span> <span class="st">&#39;Reflectance&#39;</span>}<span class="op">,</span></span>
<span id="cb9-98"><a href="#cb9-98" tabindex="-1"></a>  <span class="dt">lineWidth</span><span class="op">:</span> <span class="dv">1</span><span class="op">,</span></span>
<span id="cb9-99"><a href="#cb9-99" tabindex="-1"></a>  <span class="dt">pointSize</span><span class="op">:</span> <span class="dv">4</span><span class="op">,</span></span>
<span id="cb9-100"><a href="#cb9-100" tabindex="-1"></a>  }<span class="op">;</span></span>
<span id="cb9-101"><a href="#cb9-101" tabindex="-1"></a></span>
<span id="cb9-102"><a href="#cb9-102" tabindex="-1"></a>  <span class="kw">var</span> fc <span class="op">=</span> training<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;landcover&#39;</span><span class="op">,</span> landcover))</span>
<span id="cb9-103"><a href="#cb9-103" tabindex="-1"></a>  <span class="kw">var</span> chart <span class="op">=</span> ui<span class="op">.</span><span class="at">Chart</span><span class="op">.</span><span class="at">feature</span><span class="op">.</span><span class="fu">byProperty</span>({</span>
<span id="cb9-104"><a href="#cb9-104" tabindex="-1"></a>  <span class="dt">features</span><span class="op">:</span> fc<span class="op">,</span></span>
<span id="cb9-105"><a href="#cb9-105" tabindex="-1"></a>  <span class="dt">xProperties</span><span class="op">:</span> bandDescriptions<span class="op">,</span></span>
<span id="cb9-106"><a href="#cb9-106" tabindex="-1"></a>  })</span>
<span id="cb9-107"><a href="#cb9-107" tabindex="-1"></a><span class="op">.</span><span class="fu">setChartType</span>(<span class="st">&#39;ScatterChart&#39;</span>)</span>
<span id="cb9-108"><a href="#cb9-108" tabindex="-1"></a><span class="op">.</span><span class="fu">setOptions</span>(options)<span class="op">;</span></span>
<span id="cb9-109"><a href="#cb9-109" tabindex="-1"></a></span>
<span id="cb9-110"><a href="#cb9-110" tabindex="-1"></a><span class="fu">print</span>(chart)</span>
<span id="cb9-111"><a href="#cb9-111" tabindex="-1"></a>}</span>
<span id="cb9-112"><a href="#cb9-112" tabindex="-1"></a><span class="fu">classChart</span>(<span class="dv">0</span><span class="op">,</span> <span class="st">&#39;Urban&#39;</span>)</span>
<span id="cb9-113"><a href="#cb9-113" tabindex="-1"></a><span class="fu">classChart</span>(<span class="dv">1</span><span class="op">,</span> <span class="st">&#39;Bare&#39;</span>)</span>
<span id="cb9-114"><a href="#cb9-114" tabindex="-1"></a><span class="fu">classChart</span>(<span class="dv">2</span><span class="op">,</span> <span class="st">&#39;Water&#39;</span>)</span>
<span id="cb9-115"><a href="#cb9-115" tabindex="-1"></a><span class="fu">classChart</span>(<span class="dv">3</span><span class="op">,</span> <span class="st">&#39;Vegetation&#39;</span>)</span></code></pre></div>
</div>
<div id="using-polygons-for-training-data" class="section level2">
<h2>Using Polygons for Training Data</h2>
<div class="figure" style="text-align: center">
<img src="images/end_to_end_gee/points_vs_polygons.png" alt="Tips for Using Polygons for Training Data" width="100%" />
<p class="caption">
Tips for Using Polygons for Training Data
</p>
</div>
<p><a
href="https://code.earthengine.google.co.in/?scriptPath=users%2Fujavalgandhi%2FEnd-to-End-GEE%3ASupplement%2FSupervised_Classification%2FUsing_Polygons_for_Training_Data"
target="_blank">Open in Code Editor ↗</a></p>
<div class="sourceCode" id="cb10"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb10-1"><a href="#cb10-1" tabindex="-1"></a><span class="kw">var</span> s2 <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&#39;COPERNICUS/S2_SR_HARMONIZED&#39;</span>)<span class="op">;</span></span>
<span id="cb10-2"><a href="#cb10-2" tabindex="-1"></a><span class="kw">var</span> geometry <span class="op">=</span> bangalore<span class="op">.</span><span class="fu">geometry</span>()<span class="op">;</span></span>
<span id="cb10-3"><a href="#cb10-3" tabindex="-1"></a><span class="kw">var</span> rgbVis <span class="op">=</span> {</span>
<span id="cb10-4"><a href="#cb10-4" tabindex="-1"></a>  <span class="dt">min</span><span class="op">:</span> <span class="fl">0.0</span><span class="op">,</span></span>
<span id="cb10-5"><a href="#cb10-5" tabindex="-1"></a>  <span class="dt">max</span><span class="op">:</span> <span class="dv">3000</span><span class="op">,</span></span>
<span id="cb10-6"><a href="#cb10-6" tabindex="-1"></a>  <span class="dt">bands</span><span class="op">:</span> [<span class="st">&#39;B4&#39;</span><span class="op">,</span> <span class="st">&#39;B3&#39;</span><span class="op">,</span> <span class="st">&#39;B2&#39;</span>]<span class="op">,</span></span>
<span id="cb10-7"><a href="#cb10-7" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb10-8"><a href="#cb10-8" tabindex="-1"></a> </span>
<span id="cb10-9"><a href="#cb10-9" tabindex="-1"></a><span class="kw">var</span> filtered <span class="op">=</span> s2</span>
<span id="cb10-10"><a href="#cb10-10" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">lt</span>(<span class="st">&#39;CLOUDY_PIXEL_PERCENTAGE&#39;</span><span class="op">,</span> <span class="dv">30</span>))</span>
<span id="cb10-11"><a href="#cb10-11" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(<span class="st">&#39;2019-01-01&#39;</span><span class="op">,</span> <span class="st">&#39;2020-01-01&#39;</span>))</span>
<span id="cb10-12"><a href="#cb10-12" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">bounds</span>(geometry))</span>
<span id="cb10-13"><a href="#cb10-13" tabindex="-1"></a>  <span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;B.*&#39;</span>)<span class="op">;</span></span>
<span id="cb10-14"><a href="#cb10-14" tabindex="-1"></a></span>
<span id="cb10-15"><a href="#cb10-15" tabindex="-1"></a><span class="kw">var</span> composite <span class="op">=</span> filtered<span class="op">.</span><span class="fu">median</span>()<span class="op">;</span></span>
<span id="cb10-16"><a href="#cb10-16" tabindex="-1"></a></span>
<span id="cb10-17"><a href="#cb10-17" tabindex="-1"></a><span class="co">// Display the input composite.</span></span>
<span id="cb10-18"><a href="#cb10-18" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(composite<span class="op">.</span><span class="fu">clip</span>(geometry)<span class="op">,</span> rgbVis<span class="op">,</span> <span class="st">&#39;image&#39;</span>)<span class="op">;</span></span>
<span id="cb10-19"><a href="#cb10-19" tabindex="-1"></a></span>
<span id="cb10-20"><a href="#cb10-20" tabindex="-1"></a><span class="co">// Function to get exact number of random samples</span></span>
<span id="cb10-21"><a href="#cb10-21" tabindex="-1"></a><span class="co">// from polygons</span></span>
<span id="cb10-22"><a href="#cb10-22" tabindex="-1"></a><span class="kw">var</span> getPoints <span class="op">=</span> <span class="kw">function</span>(polygons<span class="op">,</span> nPoints<span class="op">,</span> classProperty){</span>
<span id="cb10-23"><a href="#cb10-23" tabindex="-1"></a>  <span class="co">// Generate N random points inside the polygons</span></span>
<span id="cb10-24"><a href="#cb10-24" tabindex="-1"></a>  <span class="kw">var</span> points <span class="op">=</span> ee<span class="op">.</span><span class="at">FeatureCollection</span><span class="op">.</span><span class="fu">randomPoints</span>(polygons<span class="op">,</span> nPoints)<span class="op">;</span></span>
<span id="cb10-25"><a href="#cb10-25" tabindex="-1"></a>  <span class="co">// Get the class value propertie</span></span>
<span id="cb10-26"><a href="#cb10-26" tabindex="-1"></a>  <span class="kw">var</span> classValue <span class="op">=</span> polygons<span class="op">.</span><span class="fu">first</span>()<span class="op">.</span><span class="fu">get</span>(classProperty)<span class="op">;</span></span>
<span id="cb10-27"><a href="#cb10-27" tabindex="-1"></a>  <span class="co">// Iterate over points and assign the class value</span></span>
<span id="cb10-28"><a href="#cb10-28" tabindex="-1"></a>  <span class="kw">var</span> pointsWithClassProperty <span class="op">=</span> points<span class="op">.</span><span class="fu">map</span>(<span class="kw">function</span>(point){</span>
<span id="cb10-29"><a href="#cb10-29" tabindex="-1"></a>    <span class="cf">return</span> point<span class="op">.</span><span class="fu">set</span>(classProperty<span class="op">,</span> classValue)<span class="op">;</span></span>
<span id="cb10-30"><a href="#cb10-30" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb10-31"><a href="#cb10-31" tabindex="-1"></a>  <span class="cf">return</span> pointsWithClassProperty<span class="op">;</span></span>
<span id="cb10-32"><a href="#cb10-32" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb10-33"><a href="#cb10-33" tabindex="-1"></a></span>
<span id="cb10-34"><a href="#cb10-34" tabindex="-1"></a><span class="co">// Extract random samples from each polygon</span></span>
<span id="cb10-35"><a href="#cb10-35" tabindex="-1"></a><span class="co">// This helps us get balanced samples for each class</span></span>
<span id="cb10-36"><a href="#cb10-36" tabindex="-1"></a><span class="kw">var</span> urbanPoints <span class="op">=</span> <span class="fu">getPoints</span>(urban<span class="op">,</span> <span class="dv">10</span><span class="op">,</span> <span class="st">&#39;landcover&#39;</span>)<span class="op">;</span></span>
<span id="cb10-37"><a href="#cb10-37" tabindex="-1"></a><span class="kw">var</span> barePoints <span class="op">=</span> <span class="fu">getPoints</span>(bare<span class="op">,</span> <span class="dv">10</span><span class="op">,</span> <span class="st">&#39;landcover&#39;</span>)<span class="op">;</span></span>
<span id="cb10-38"><a href="#cb10-38" tabindex="-1"></a><span class="kw">var</span> waterPoints <span class="op">=</span> <span class="fu">getPoints</span>(water<span class="op">,</span> <span class="dv">10</span><span class="op">,</span> <span class="st">&#39;landcover&#39;</span>)<span class="op">;</span></span>
<span id="cb10-39"><a href="#cb10-39" tabindex="-1"></a><span class="kw">var</span> vegetationPoints <span class="op">=</span> <span class="fu">getPoints</span>(vegetation<span class="op">,</span> <span class="dv">10</span><span class="op">,</span> <span class="st">&#39;landcover&#39;</span>)<span class="op">;</span></span>
<span id="cb10-40"><a href="#cb10-40" tabindex="-1"></a></span>
<span id="cb10-41"><a href="#cb10-41" tabindex="-1"></a><span class="kw">var</span> gcps <span class="op">=</span> urbanPoints</span>
<span id="cb10-42"><a href="#cb10-42" tabindex="-1"></a>  <span class="op">.</span><span class="fu">merge</span>(barePoints)</span>
<span id="cb10-43"><a href="#cb10-43" tabindex="-1"></a>  <span class="op">.</span><span class="fu">merge</span>(waterPoints)</span>
<span id="cb10-44"><a href="#cb10-44" tabindex="-1"></a>  <span class="op">.</span><span class="fu">merge</span>(vegetationPoints)<span class="op">;</span></span>
<span id="cb10-45"><a href="#cb10-45" tabindex="-1"></a></span>
<span id="cb10-46"><a href="#cb10-46" tabindex="-1"></a><span class="co">// Overlay the point on the image to get training data.</span></span>
<span id="cb10-47"><a href="#cb10-47" tabindex="-1"></a><span class="kw">var</span> training <span class="op">=</span> composite<span class="op">.</span><span class="fu">sampleRegions</span>({</span>
<span id="cb10-48"><a href="#cb10-48" tabindex="-1"></a>  <span class="dt">collection</span><span class="op">:</span> gcps<span class="op">,</span> </span>
<span id="cb10-49"><a href="#cb10-49" tabindex="-1"></a>  <span class="dt">properties</span><span class="op">:</span> [<span class="st">&#39;landcover&#39;</span>]<span class="op">,</span> </span>
<span id="cb10-50"><a href="#cb10-50" tabindex="-1"></a>  <span class="dt">scale</span><span class="op">:</span> <span class="dv">10</span></span>
<span id="cb10-51"><a href="#cb10-51" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb10-52"><a href="#cb10-52" tabindex="-1"></a></span>
<span id="cb10-53"><a href="#cb10-53" tabindex="-1"></a></span>
<span id="cb10-54"><a href="#cb10-54" tabindex="-1"></a><span class="co">// Train a classifier.</span></span>
<span id="cb10-55"><a href="#cb10-55" tabindex="-1"></a><span class="kw">var</span> classifier <span class="op">=</span> ee<span class="op">.</span><span class="at">Classifier</span><span class="op">.</span><span class="fu">smileRandomForest</span>(<span class="dv">50</span>)<span class="op">.</span><span class="fu">train</span>({</span>
<span id="cb10-56"><a href="#cb10-56" tabindex="-1"></a>  <span class="dt">features</span><span class="op">:</span> training<span class="op">,</span>  </span>
<span id="cb10-57"><a href="#cb10-57" tabindex="-1"></a>  <span class="dt">classProperty</span><span class="op">:</span> <span class="st">&#39;landcover&#39;</span><span class="op">,</span> </span>
<span id="cb10-58"><a href="#cb10-58" tabindex="-1"></a>  <span class="dt">inputProperties</span><span class="op">:</span> composite<span class="op">.</span><span class="fu">bandNames</span>()</span>
<span id="cb10-59"><a href="#cb10-59" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb10-60"><a href="#cb10-60" tabindex="-1"></a><span class="co">// // Classify the image.</span></span>
<span id="cb10-61"><a href="#cb10-61" tabindex="-1"></a><span class="kw">var</span> classified <span class="op">=</span> composite<span class="op">.</span><span class="fu">classify</span>(classifier)<span class="op">;</span></span>
<span id="cb10-62"><a href="#cb10-62" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">centerObject</span>(geometry)<span class="op">;</span></span>
<span id="cb10-63"><a href="#cb10-63" tabindex="-1"></a><span class="co">// Choose a 4-color palette</span></span>
<span id="cb10-64"><a href="#cb10-64" tabindex="-1"></a><span class="co">// Assign a color for each class in the following order</span></span>
<span id="cb10-65"><a href="#cb10-65" tabindex="-1"></a><span class="co">// Urban, Bare, Water, Vegetation</span></span>
<span id="cb10-66"><a href="#cb10-66" tabindex="-1"></a><span class="kw">var</span> palette <span class="op">=</span> [<span class="st">&#39;#cc6d8f&#39;</span><span class="op">,</span> <span class="st">&#39;#ffc107&#39;</span><span class="op">,</span> <span class="st">&#39;#1e88e5&#39;</span><span class="op">,</span> <span class="st">&#39;#004d40&#39;</span> ]<span class="op">;</span></span>
<span id="cb10-67"><a href="#cb10-67" tabindex="-1"></a></span>
<span id="cb10-68"><a href="#cb10-68" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(classified<span class="op">.</span><span class="fu">clip</span>(geometry)<span class="op">,</span> {<span class="dt">min</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span> <span class="dv">3</span><span class="op">,</span> <span class="dt">palette</span><span class="op">:</span> palette}<span class="op">,</span> <span class="st">&#39;2019&#39;</span>)<span class="op">;</span></span>
<span id="cb10-69"><a href="#cb10-69" tabindex="-1"></a></span>
<span id="cb10-70"><a href="#cb10-70" tabindex="-1"></a><span class="co">// Display the chosen random samples</span></span>
<span id="cb10-71"><a href="#cb10-71" tabindex="-1"></a><span class="co">// We use the style() function to style the GCPs</span></span>
<span id="cb10-72"><a href="#cb10-72" tabindex="-1"></a><span class="kw">var</span> palette <span class="op">=</span> ee<span class="op">.</span><span class="fu">List</span>(palette)<span class="op">;</span></span>
<span id="cb10-73"><a href="#cb10-73" tabindex="-1"></a><span class="kw">var</span> landcover <span class="op">=</span> ee<span class="op">.</span><span class="fu">List</span>([<span class="dv">0</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">3</span>])<span class="op">;</span></span>
<span id="cb10-74"><a href="#cb10-74" tabindex="-1"></a></span>
<span id="cb10-75"><a href="#cb10-75" tabindex="-1"></a><span class="kw">var</span> gcpsStyled <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(</span>
<span id="cb10-76"><a href="#cb10-76" tabindex="-1"></a>  landcover<span class="op">.</span><span class="fu">map</span>(<span class="kw">function</span>(lc){</span>
<span id="cb10-77"><a href="#cb10-77" tabindex="-1"></a>    <span class="kw">var</span> color <span class="op">=</span> palette<span class="op">.</span><span class="fu">get</span>(landcover<span class="op">.</span><span class="fu">indexOf</span>(lc))<span class="op">;</span></span>
<span id="cb10-78"><a href="#cb10-78" tabindex="-1"></a>    <span class="kw">var</span> markerStyle <span class="op">=</span> { <span class="dt">color</span><span class="op">:</span> <span class="st">&#39;white&#39;</span><span class="op">,</span> <span class="dt">pointShape</span><span class="op">:</span> <span class="st">&#39;diamond&#39;</span><span class="op">,</span> </span>
<span id="cb10-79"><a href="#cb10-79" tabindex="-1"></a>      <span class="dt">pointSize</span><span class="op">:</span> <span class="dv">4</span><span class="op">,</span> <span class="dt">width</span><span class="op">:</span> <span class="dv">1</span><span class="op">,</span> <span class="dt">fillColor</span><span class="op">:</span> color}<span class="op">;</span></span>
<span id="cb10-80"><a href="#cb10-80" tabindex="-1"></a>    <span class="cf">return</span> gcps<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;landcover&#39;</span><span class="op">,</span> lc))</span>
<span id="cb10-81"><a href="#cb10-81" tabindex="-1"></a>                <span class="op">.</span><span class="fu">map</span>(<span class="kw">function</span>(point){</span>
<span id="cb10-82"><a href="#cb10-82" tabindex="-1"></a>                  <span class="cf">return</span> point<span class="op">.</span><span class="fu">set</span>(<span class="st">&#39;style&#39;</span><span class="op">,</span> markerStyle)<span class="op">;</span></span>
<span id="cb10-83"><a href="#cb10-83" tabindex="-1"></a>                })<span class="op">;</span></span>
<span id="cb10-84"><a href="#cb10-84" tabindex="-1"></a>      }))<span class="op">.</span><span class="fu">flatten</span>()<span class="op">;</span></span>
<span id="cb10-85"><a href="#cb10-85" tabindex="-1"></a>      </span>
<span id="cb10-86"><a href="#cb10-86" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(gcpsStyled<span class="op">.</span><span class="fu">style</span>({<span class="dt">styleProperty</span><span class="op">:</span><span class="st">&#39;style&#39;</span>})<span class="op">,</span> {}<span class="op">,</span> <span class="st">&#39;Point Samples&#39;</span>)<span class="op">;</span></span></code></pre></div>
</div>
<div id="stratified-sampling-of-gcps" class="section level2">
<h2>Stratified Sampling of GCPs</h2>
<p><a
href="https://code.earthengine.google.co.in/?scriptPath=users%2Fujavalgandhi%2FEnd-to-End-GEE%3ASupplement%2FSupervised_Classification%2FStratified_Sampling"
target="_blank">Open in Code Editor ↗</a></p>
<div class="sourceCode" id="cb11"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb11-1"><a href="#cb11-1" tabindex="-1"></a><span class="co">// Example script for stratified sampling of</span></span>
<span id="cb11-2"><a href="#cb11-2" tabindex="-1"></a><span class="co">// training samples for supervised classification</span></span>
<span id="cb11-3"><a href="#cb11-3" tabindex="-1"></a><span class="co">// The script demonstrates the difference between</span></span>
<span id="cb11-4"><a href="#cb11-4" tabindex="-1"></a><span class="co">// a simple random split of training features vs.</span></span>
<span id="cb11-5"><a href="#cb11-5" tabindex="-1"></a><span class="co">// a random split of training features by by class</span></span>
<span id="cb11-6"><a href="#cb11-6" tabindex="-1"></a><span class="kw">var</span> gcp <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">&quot;users/ujavalgandhi/e2e/arkavathy_gcps&quot;</span>)<span class="op">;</span></span>
<span id="cb11-7"><a href="#cb11-7" tabindex="-1"></a></span>
<span id="cb11-8"><a href="#cb11-8" tabindex="-1"></a><span class="co">// Simple Random Split</span></span>
<span id="cb11-9"><a href="#cb11-9" tabindex="-1"></a><span class="kw">var</span> gcp <span class="op">=</span> gcp<span class="op">.</span><span class="fu">randomColumn</span>()<span class="op">;</span></span>
<span id="cb11-10"><a href="#cb11-10" tabindex="-1"></a><span class="kw">var</span> trainingGcpSimple <span class="op">=</span> gcp<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">lt</span>(<span class="st">&#39;random&#39;</span><span class="op">,</span> <span class="fl">0.6</span>))<span class="op">;</span></span>
<span id="cb11-11"><a href="#cb11-11" tabindex="-1"></a><span class="kw">var</span> validationGcpSimple <span class="op">=</span> gcp<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">gte</span>(<span class="st">&#39;random&#39;</span><span class="op">,</span> <span class="fl">0.6</span>))<span class="op">;</span></span>
<span id="cb11-12"><a href="#cb11-12" tabindex="-1"></a></span>
<span id="cb11-13"><a href="#cb11-13" tabindex="-1"></a><span class="co">// Split with Stratified Random Sampling</span></span>
<span id="cb11-14"><a href="#cb11-14" tabindex="-1"></a><span class="co">// Split features into training / validation sets, per class</span></span>
<span id="cb11-15"><a href="#cb11-15" tabindex="-1"></a><span class="kw">var</span> classes <span class="op">=</span> ee<span class="op">.</span><span class="fu">List</span>(gcp<span class="op">.</span><span class="fu">aggregate_array</span>(<span class="st">&#39;landcover&#39;</span>)<span class="op">.</span><span class="fu">distinct</span>())<span class="op">;</span></span>
<span id="cb11-16"><a href="#cb11-16" tabindex="-1"></a><span class="fu">print</span>(<span class="st">&#39;Classes&#39;</span><span class="op">,</span> classes)<span class="op">;</span></span>
<span id="cb11-17"><a href="#cb11-17" tabindex="-1"></a></span>
<span id="cb11-18"><a href="#cb11-18" tabindex="-1"></a><span class="kw">var</span> getSplitSamples <span class="op">=</span> <span class="kw">function</span>(classNumber) {</span>
<span id="cb11-19"><a href="#cb11-19" tabindex="-1"></a>  <span class="kw">var</span> classSamples <span class="op">=</span> gcp</span>
<span id="cb11-20"><a href="#cb11-20" tabindex="-1"></a>    <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;landcover&#39;</span><span class="op">,</span> classNumber))</span>
<span id="cb11-21"><a href="#cb11-21" tabindex="-1"></a>    <span class="op">.</span><span class="fu">randomColumn</span>(<span class="st">&#39;random&#39;</span>)<span class="op">;</span></span>
<span id="cb11-22"><a href="#cb11-22" tabindex="-1"></a></span>
<span id="cb11-23"><a href="#cb11-23" tabindex="-1"></a>  <span class="co">// Split the samples, 60% for training, 40% for validation</span></span>
<span id="cb11-24"><a href="#cb11-24" tabindex="-1"></a>  <span class="kw">var</span> classTrainingGcp <span class="op">=</span> classSamples</span>
<span id="cb11-25"><a href="#cb11-25" tabindex="-1"></a>    <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">lt</span>(<span class="st">&#39;random&#39;</span><span class="op">,</span> <span class="fl">0.6</span>))</span>
<span id="cb11-26"><a href="#cb11-26" tabindex="-1"></a>    <span class="co">// Set a property to identify the fraction</span></span>
<span id="cb11-27"><a href="#cb11-27" tabindex="-1"></a>    <span class="op">.</span><span class="fu">map</span>(<span class="kw">function</span>(f) {<span class="cf">return</span> f<span class="op">.</span><span class="fu">set</span>(<span class="st">&#39;fraction&#39;</span><span class="op">,</span> <span class="st">&#39;training&#39;</span>)})<span class="op">;</span></span>
<span id="cb11-28"><a href="#cb11-28" tabindex="-1"></a>    </span>
<span id="cb11-29"><a href="#cb11-29" tabindex="-1"></a>  <span class="kw">var</span> classValidationGcp <span class="op">=</span> classSamples</span>
<span id="cb11-30"><a href="#cb11-30" tabindex="-1"></a>    <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">gte</span>(<span class="st">&#39;random&#39;</span><span class="op">,</span> <span class="fl">0.6</span>))</span>
<span id="cb11-31"><a href="#cb11-31" tabindex="-1"></a>    <span class="op">.</span><span class="fu">map</span>(<span class="kw">function</span>(f) {<span class="cf">return</span> f<span class="op">.</span><span class="fu">set</span>(<span class="st">&#39;fraction&#39;</span><span class="op">,</span> <span class="st">&#39;validation&#39;</span>)})<span class="op">;</span></span>
<span id="cb11-32"><a href="#cb11-32" tabindex="-1"></a>  <span class="cf">return</span> classTrainingGcp<span class="op">.</span><span class="fu">merge</span>(classValidationGcp)<span class="op">;</span></span>
<span id="cb11-33"><a href="#cb11-33" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb11-34"><a href="#cb11-34" tabindex="-1"></a></span>
<span id="cb11-35"><a href="#cb11-35" tabindex="-1"></a><span class="co">// map() the function on the list of classes</span></span>
<span id="cb11-36"><a href="#cb11-36" tabindex="-1"></a><span class="kw">var</span> splitSamples <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(classes<span class="op">.</span><span class="fu">map</span>(getSplitSamples))</span>
<span id="cb11-37"><a href="#cb11-37" tabindex="-1"></a>  <span class="op">.</span><span class="fu">flatten</span>()<span class="op">;</span></span>
<span id="cb11-38"><a href="#cb11-38" tabindex="-1"></a></span>
<span id="cb11-39"><a href="#cb11-39" tabindex="-1"></a><span class="co">// Filter using the &#39;fraction&#39; property</span></span>
<span id="cb11-40"><a href="#cb11-40" tabindex="-1"></a><span class="kw">var</span> trainingGcpStratified <span class="op">=</span> splitSamples<span class="op">.</span><span class="fu">filter</span>(</span>
<span id="cb11-41"><a href="#cb11-41" tabindex="-1"></a>  ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;fraction&#39;</span><span class="op">,</span> <span class="st">&#39;training&#39;</span>))<span class="op">;</span></span>
<span id="cb11-42"><a href="#cb11-42" tabindex="-1"></a><span class="kw">var</span> validationGcpStratified <span class="op">=</span> splitSamples<span class="op">.</span><span class="fu">filter</span>(</span>
<span id="cb11-43"><a href="#cb11-43" tabindex="-1"></a>  ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;fraction&#39;</span><span class="op">,</span> <span class="st">&#39;validation&#39;</span>))<span class="op">;</span></span>
<span id="cb11-44"><a href="#cb11-44" tabindex="-1"></a></span>
<span id="cb11-45"><a href="#cb11-45" tabindex="-1"></a><span class="co">// Validate the results</span></span>
<span id="cb11-46"><a href="#cb11-46" tabindex="-1"></a></span>
<span id="cb11-47"><a href="#cb11-47" tabindex="-1"></a><span class="co">// Function to calculate distribution of samples</span></span>
<span id="cb11-48"><a href="#cb11-48" tabindex="-1"></a><span class="kw">var</span> getDistribution <span class="op">=</span> <span class="kw">function</span>(fc) {</span>
<span id="cb11-49"><a href="#cb11-49" tabindex="-1"></a>  <span class="cf">return</span> fc<span class="op">.</span><span class="fu">reduceColumns</span>({</span>
<span id="cb11-50"><a href="#cb11-50" tabindex="-1"></a>    <span class="dt">reducer</span><span class="op">:</span> ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">frequencyHistogram</span>()<span class="op">,</span></span>
<span id="cb11-51"><a href="#cb11-51" tabindex="-1"></a>    <span class="dt">selectors</span><span class="op">:</span> [<span class="st">&#39;landcover&#39;</span>]})<span class="op">.</span><span class="fu">get</span>(<span class="st">&#39;histogram&#39;</span>)<span class="op">;</span></span>
<span id="cb11-52"><a href="#cb11-52" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb11-53"><a href="#cb11-53" tabindex="-1"></a></span>
<span id="cb11-54"><a href="#cb11-54" tabindex="-1"></a><span class="fu">print</span>(<span class="st">&#39;Distribution of All Samples by Class&#39;</span><span class="op">,</span> <span class="fu">getDistribution</span>(gcp))<span class="op">;</span></span>
<span id="cb11-55"><a href="#cb11-55" tabindex="-1"></a></span>
<span id="cb11-56"><a href="#cb11-56" tabindex="-1"></a><span class="fu">print</span>(<span class="st">&#39;Training (Simple Split)&#39;</span><span class="op">,</span></span>
<span id="cb11-57"><a href="#cb11-57" tabindex="-1"></a>  <span class="fu">getDistribution</span>(trainingGcpSimple))<span class="op">;</span></span>
<span id="cb11-58"><a href="#cb11-58" tabindex="-1"></a></span>
<span id="cb11-59"><a href="#cb11-59" tabindex="-1"></a><span class="fu">print</span>(<span class="st">&#39;Training (Stratified Split)&#39;</span><span class="op">,</span></span>
<span id="cb11-60"><a href="#cb11-60" tabindex="-1"></a>  <span class="fu">getDistribution</span>(trainingGcpStratified))<span class="op">;</span></span>
<span id="cb11-61"><a href="#cb11-61" tabindex="-1"></a>    </span>
<span id="cb11-62"><a href="#cb11-62" tabindex="-1"></a><span class="fu">print</span>(<span class="st">&#39;Validation (Simple Split)&#39;</span><span class="op">,</span></span>
<span id="cb11-63"><a href="#cb11-63" tabindex="-1"></a>  <span class="fu">getDistribution</span>(validationGcpSimple))<span class="op">;</span></span>
<span id="cb11-64"><a href="#cb11-64" tabindex="-1"></a></span>
<span id="cb11-65"><a href="#cb11-65" tabindex="-1"></a><span class="fu">print</span>(<span class="st">&#39;Validation (Stratified Split)&#39;</span><span class="op">,</span></span>
<span id="cb11-66"><a href="#cb11-66" tabindex="-1"></a>  <span class="fu">getDistribution</span>(validationGcpStratified))<span class="op">;</span></span>
<span id="cb11-67"><a href="#cb11-67" tabindex="-1"></a>  </span></code></pre></div>
</div>
<div id="identify-misclassified-gcps" class="section level2">
<h2>Identify Misclassified GCPs</h2>
<p>While doing accuracy assessment, you will see the validation features
that were not classified correctly. It is useful to visually see the
points that were misclassified. We can use <code>ee.Filter.eq()</code>
and <code>ee.Filter.neq()</code> filters to filter the features where
the actual and predicted classes were different. The code below shows
how to implement this and also use the <code>style()</code> function
visualize them effectively.</p>
<p><a
href="https://code.earthengine.google.com/?scriptPath=users%2Fujavalgandhi%2FEnd-to-End-GEE%3ASupplement%2FSupervised_Classification%2FIdentify_Misclassified_Data"
target="_blank">Open in Code Editor ↗</a></p>
<div class="sourceCode" id="cb12"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb12-1"><a href="#cb12-1" tabindex="-1"></a><span class="co">// Script that shows how to apply filters to identify</span></span>
<span id="cb12-2"><a href="#cb12-2" tabindex="-1"></a><span class="co">// validation points that were misclassified</span></span>
<span id="cb12-3"><a href="#cb12-3" tabindex="-1"></a><span class="kw">var</span> s2 <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&quot;COPERNICUS/S2_SR_HARMONIZED&quot;</span>)<span class="op">;</span></span>
<span id="cb12-4"><a href="#cb12-4" tabindex="-1"></a><span class="kw">var</span> basin <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">&quot;WWF/HydroSHEDS/v1/Basins/hybas_7&quot;</span>)<span class="op">;</span></span>
<span id="cb12-5"><a href="#cb12-5" tabindex="-1"></a><span class="kw">var</span> gcp <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">&quot;users/ujavalgandhi/e2e/arkavathy_gcps&quot;</span>)<span class="op">;</span></span>
<span id="cb12-6"><a href="#cb12-6" tabindex="-1"></a></span>
<span id="cb12-7"><a href="#cb12-7" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">centerObject</span>(gcp)</span>
<span id="cb12-8"><a href="#cb12-8" tabindex="-1"></a><span class="kw">var</span> arkavathy <span class="op">=</span> basin<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;HYBAS_ID&#39;</span><span class="op">,</span> <span class="dv">4071139640</span>))</span>
<span id="cb12-9"><a href="#cb12-9" tabindex="-1"></a><span class="kw">var</span> boundary <span class="op">=</span> arkavathy<span class="op">.</span><span class="fu">geometry</span>()</span>
<span id="cb12-10"><a href="#cb12-10" tabindex="-1"></a><span class="kw">var</span> rgbVis <span class="op">=</span> {</span>
<span id="cb12-11"><a href="#cb12-11" tabindex="-1"></a>  <span class="dt">min</span><span class="op">:</span> <span class="fl">0.0</span><span class="op">,</span></span>
<span id="cb12-12"><a href="#cb12-12" tabindex="-1"></a>  <span class="dt">max</span><span class="op">:</span> <span class="dv">3000</span><span class="op">,</span></span>
<span id="cb12-13"><a href="#cb12-13" tabindex="-1"></a>  <span class="dt">bands</span><span class="op">:</span> [<span class="st">&#39;B4&#39;</span><span class="op">,</span> <span class="st">&#39;B3&#39;</span><span class="op">,</span> <span class="st">&#39;B2&#39;</span>]<span class="op">,</span></span>
<span id="cb12-14"><a href="#cb12-14" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb12-15"><a href="#cb12-15" tabindex="-1"></a> </span>
<span id="cb12-16"><a href="#cb12-16" tabindex="-1"></a><span class="kw">var</span> filtered <span class="op">=</span> s2</span>
<span id="cb12-17"><a href="#cb12-17" tabindex="-1"></a><span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">lt</span>(<span class="st">&#39;CLOUDY_PIXEL_PERCENTAGE&#39;</span><span class="op">,</span> <span class="dv">30</span>))</span>
<span id="cb12-18"><a href="#cb12-18" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(<span class="st">&#39;2019-01-01&#39;</span><span class="op">,</span> <span class="st">&#39;2020-01-01&#39;</span>))</span>
<span id="cb12-19"><a href="#cb12-19" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">bounds</span>(boundary))</span>
<span id="cb12-20"><a href="#cb12-20" tabindex="-1"></a>  <span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;B.*&#39;</span>)</span>
<span id="cb12-21"><a href="#cb12-21" tabindex="-1"></a></span>
<span id="cb12-22"><a href="#cb12-22" tabindex="-1"></a><span class="kw">var</span> composite <span class="op">=</span> filtered<span class="op">.</span><span class="fu">median</span>()<span class="op">.</span><span class="fu">clip</span>(boundary) </span>
<span id="cb12-23"><a href="#cb12-23" tabindex="-1"></a></span>
<span id="cb12-24"><a href="#cb12-24" tabindex="-1"></a><span class="co">// Display the input composite.</span></span>
<span id="cb12-25"><a href="#cb12-25" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(composite<span class="op">,</span> rgbVis<span class="op">,</span> <span class="st">&#39;image&#39;</span>)<span class="op">;</span></span>
<span id="cb12-26"><a href="#cb12-26" tabindex="-1"></a></span>
<span id="cb12-27"><a href="#cb12-27" tabindex="-1"></a></span>
<span id="cb12-28"><a href="#cb12-28" tabindex="-1"></a><span class="co">// Add a random column and split the GCPs into training and validation set</span></span>
<span id="cb12-29"><a href="#cb12-29" tabindex="-1"></a><span class="kw">var</span> gcp <span class="op">=</span> gcp<span class="op">.</span><span class="fu">randomColumn</span>()</span>
<span id="cb12-30"><a href="#cb12-30" tabindex="-1"></a><span class="kw">var</span> trainingGcp <span class="op">=</span> gcp<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">lt</span>(<span class="st">&#39;random&#39;</span><span class="op">,</span> <span class="fl">0.6</span>))<span class="op">;</span></span>
<span id="cb12-31"><a href="#cb12-31" tabindex="-1"></a><span class="kw">var</span> validationGcp <span class="op">=</span> gcp<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">gte</span>(<span class="st">&#39;random&#39;</span><span class="op">,</span> <span class="fl">0.6</span>))<span class="op">;</span></span>
<span id="cb12-32"><a href="#cb12-32" tabindex="-1"></a></span>
<span id="cb12-33"><a href="#cb12-33" tabindex="-1"></a><span class="co">// Overlay the point on the image to get training data.</span></span>
<span id="cb12-34"><a href="#cb12-34" tabindex="-1"></a><span class="kw">var</span> training <span class="op">=</span> composite<span class="op">.</span><span class="fu">sampleRegions</span>({</span>
<span id="cb12-35"><a href="#cb12-35" tabindex="-1"></a>  <span class="dt">collection</span><span class="op">:</span> trainingGcp<span class="op">,</span></span>
<span id="cb12-36"><a href="#cb12-36" tabindex="-1"></a>  <span class="dt">properties</span><span class="op">:</span> [<span class="st">&#39;landcover&#39;</span>]<span class="op">,</span></span>
<span id="cb12-37"><a href="#cb12-37" tabindex="-1"></a>  <span class="dt">scale</span><span class="op">:</span> <span class="dv">10</span><span class="op">,</span></span>
<span id="cb12-38"><a href="#cb12-38" tabindex="-1"></a>  <span class="dt">tileScale</span><span class="op">:</span> <span class="dv">16</span><span class="op">,</span></span>
<span id="cb12-39"><a href="#cb12-39" tabindex="-1"></a>  <span class="dt">geometries</span><span class="op">:</span><span class="kw">true</span></span>
<span id="cb12-40"><a href="#cb12-40" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb12-41"><a href="#cb12-41" tabindex="-1"></a><span class="co">// Train a classifier.</span></span>
<span id="cb12-42"><a href="#cb12-42" tabindex="-1"></a><span class="kw">var</span> classifier <span class="op">=</span> ee<span class="op">.</span><span class="at">Classifier</span><span class="op">.</span><span class="fu">smileRandomForest</span>(<span class="dv">50</span>)</span>
<span id="cb12-43"><a href="#cb12-43" tabindex="-1"></a><span class="op">.</span><span class="fu">train</span>({</span>
<span id="cb12-44"><a href="#cb12-44" tabindex="-1"></a>  <span class="dt">features</span><span class="op">:</span> training<span class="op">,</span>  </span>
<span id="cb12-45"><a href="#cb12-45" tabindex="-1"></a>  <span class="dt">classProperty</span><span class="op">:</span> <span class="st">&#39;landcover&#39;</span><span class="op">,</span></span>
<span id="cb12-46"><a href="#cb12-46" tabindex="-1"></a>  <span class="dt">inputProperties</span><span class="op">:</span> composite<span class="op">.</span><span class="fu">bandNames</span>()</span>
<span id="cb12-47"><a href="#cb12-47" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb12-48"><a href="#cb12-48" tabindex="-1"></a></span>
<span id="cb12-49"><a href="#cb12-49" tabindex="-1"></a><span class="co">// Classify the image.</span></span>
<span id="cb12-50"><a href="#cb12-50" tabindex="-1"></a><span class="kw">var</span> classified <span class="op">=</span> composite<span class="op">.</span><span class="fu">classify</span>(classifier)<span class="op">;</span></span>
<span id="cb12-51"><a href="#cb12-51" tabindex="-1"></a></span>
<span id="cb12-52"><a href="#cb12-52" tabindex="-1"></a><span class="kw">var</span> palette <span class="op">=</span> [<span class="st">&#39;#cc6d8f&#39;</span><span class="op">,</span> <span class="st">&#39;#ffc107&#39;</span><span class="op">,</span> <span class="st">&#39;#1e88e5&#39;</span><span class="op">,</span> <span class="st">&#39;#004d40&#39;</span> ]<span class="op">;</span></span>
<span id="cb12-53"><a href="#cb12-53" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(classified<span class="op">,</span> {<span class="dt">min</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span> <span class="dv">3</span><span class="op">,</span> <span class="dt">palette</span><span class="op">:</span> palette}<span class="op">,</span> <span class="st">&#39;2019&#39;</span>)<span class="op">;</span></span>
<span id="cb12-54"><a href="#cb12-54" tabindex="-1"></a></span>
<span id="cb12-55"><a href="#cb12-55" tabindex="-1"></a><span class="kw">var</span> test <span class="op">=</span> classified<span class="op">.</span><span class="fu">sampleRegions</span>({</span>
<span id="cb12-56"><a href="#cb12-56" tabindex="-1"></a>  <span class="dt">collection</span><span class="op">:</span> validationGcp<span class="op">,</span></span>
<span id="cb12-57"><a href="#cb12-57" tabindex="-1"></a>  <span class="dt">properties</span><span class="op">:</span> [<span class="st">&#39;landcover&#39;</span>]<span class="op">,</span></span>
<span id="cb12-58"><a href="#cb12-58" tabindex="-1"></a>  <span class="dt">tileScale</span><span class="op">:</span> <span class="dv">16</span><span class="op">,</span></span>
<span id="cb12-59"><a href="#cb12-59" tabindex="-1"></a>  <span class="dt">scale</span><span class="op">:</span> <span class="dv">10</span><span class="op">,</span></span>
<span id="cb12-60"><a href="#cb12-60" tabindex="-1"></a>  <span class="dt">geometries</span><span class="op">:</span><span class="kw">true</span> <span class="co">// This is requires to visualize the locations</span></span>
<span id="cb12-61"><a href="#cb12-61" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb12-62"><a href="#cb12-62" tabindex="-1"></a></span>
<span id="cb12-63"><a href="#cb12-63" tabindex="-1"></a><span class="kw">var</span> testConfusionMatrix <span class="op">=</span> test<span class="op">.</span><span class="fu">errorMatrix</span>(<span class="st">&#39;landcover&#39;</span><span class="op">,</span> <span class="st">&#39;classification&#39;</span>)</span>
<span id="cb12-64"><a href="#cb12-64" tabindex="-1"></a><span class="fu">print</span>(<span class="st">&#39;Confusion Matrix&#39;</span><span class="op">,</span> testConfusionMatrix)<span class="op">;</span></span>
<span id="cb12-65"><a href="#cb12-65" tabindex="-1"></a></span>
<span id="cb12-66"><a href="#cb12-66" tabindex="-1"></a><span class="co">// Let&#39;s apply filters to find misclassified points</span></span>
<span id="cb12-67"><a href="#cb12-67" tabindex="-1"></a><span class="co">// We can find all points which are labeled landcover=0 (urban) </span></span>
<span id="cb12-68"><a href="#cb12-68" tabindex="-1"></a><span class="co">// but were not classified correctly</span></span>
<span id="cb12-69"><a href="#cb12-69" tabindex="-1"></a></span>
<span id="cb12-70"><a href="#cb12-70" tabindex="-1"></a><span class="kw">var</span> urbanMisclassified <span class="op">=</span> test</span>
<span id="cb12-71"><a href="#cb12-71" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;landcover&#39;</span><span class="op">,</span> <span class="dv">0</span>))</span>
<span id="cb12-72"><a href="#cb12-72" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">neq</span>(<span class="st">&#39;classification&#39;</span><span class="op">,</span> <span class="dv">0</span>))</span>
<span id="cb12-73"><a href="#cb12-73" tabindex="-1"></a><span class="fu">print</span>(<span class="st">&#39;Urban Misclassified Points&#39;</span><span class="op">,</span> urbanMisclassified)</span>
<span id="cb12-74"><a href="#cb12-74" tabindex="-1"></a></span>
<span id="cb12-75"><a href="#cb12-75" tabindex="-1"></a><span class="co">// We can also apply a filter to select all misclassified points</span></span>
<span id="cb12-76"><a href="#cb12-76" tabindex="-1"></a><span class="co">// Since we are comparing 2 properties agaist each-other,</span></span>
<span id="cb12-77"><a href="#cb12-77" tabindex="-1"></a><span class="co">// we need to use a binary filter</span></span>
<span id="cb12-78"><a href="#cb12-78" tabindex="-1"></a><span class="kw">var</span> misClassified <span class="op">=</span> test<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">notEquals</span>({</span>
<span id="cb12-79"><a href="#cb12-79" tabindex="-1"></a>  <span class="dt">leftField</span><span class="op">:</span><span class="st">&#39;classification&#39;</span><span class="op">,</span> <span class="dt">rightField</span><span class="op">:</span><span class="st">&#39;landcover&#39;</span>}))</span>
<span id="cb12-80"><a href="#cb12-80" tabindex="-1"></a>  </span>
<span id="cb12-81"><a href="#cb12-81" tabindex="-1"></a><span class="fu">print</span>(<span class="st">&#39;All Misclassified Points&#39;</span><span class="op">,</span> misClassified)</span>
<span id="cb12-82"><a href="#cb12-82" tabindex="-1"></a></span>
<span id="cb12-83"><a href="#cb12-83" tabindex="-1"></a><span class="co">// Display the misclassified points by styling them</span></span>
<span id="cb12-84"><a href="#cb12-84" tabindex="-1"></a><span class="kw">var</span> landcover <span class="op">=</span> ee<span class="op">.</span><span class="fu">List</span>([<span class="dv">0</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">3</span>])</span>
<span id="cb12-85"><a href="#cb12-85" tabindex="-1"></a><span class="kw">var</span> palette <span class="op">=</span> ee<span class="op">.</span><span class="fu">List</span>([<span class="st">&#39;gray&#39;</span><span class="op">,</span><span class="st">&#39;brown&#39;</span><span class="op">,</span><span class="st">&#39;blue&#39;</span><span class="op">,</span><span class="st">&#39;green&#39;</span>])</span>
<span id="cb12-86"><a href="#cb12-86" tabindex="-1"></a><span class="kw">var</span> misclassStyled <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(</span>
<span id="cb12-87"><a href="#cb12-87" tabindex="-1"></a>  landcover<span class="op">.</span><span class="fu">map</span>(<span class="kw">function</span>(lc){</span>
<span id="cb12-88"><a href="#cb12-88" tabindex="-1"></a>    <span class="kw">var</span> feature <span class="op">=</span> misClassified<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;landcover&#39;</span><span class="op">,</span> lc))</span>
<span id="cb12-89"><a href="#cb12-89" tabindex="-1"></a>    <span class="kw">var</span> color <span class="op">=</span> palette<span class="op">.</span><span class="fu">get</span>(landcover<span class="op">.</span><span class="fu">indexOf</span>(lc))<span class="op">;</span></span>
<span id="cb12-90"><a href="#cb12-90" tabindex="-1"></a>    <span class="kw">var</span> markerStyle <span class="op">=</span> {<span class="dt">color</span><span class="op">:</span>color}</span>
<span id="cb12-91"><a href="#cb12-91" tabindex="-1"></a>    <span class="cf">return</span> feature<span class="op">.</span><span class="fu">map</span>(<span class="kw">function</span>(point){</span>
<span id="cb12-92"><a href="#cb12-92" tabindex="-1"></a>       <span class="cf">return</span> point<span class="op">.</span><span class="fu">set</span>(<span class="st">&#39;style&#39;</span><span class="op">,</span> markerStyle)</span>
<span id="cb12-93"><a href="#cb12-93" tabindex="-1"></a>       })</span>
<span id="cb12-94"><a href="#cb12-94" tabindex="-1"></a>    }))<span class="op">.</span><span class="fu">flatten</span>()<span class="op">;</span></span>
<span id="cb12-95"><a href="#cb12-95" tabindex="-1"></a>      </span>
<span id="cb12-96"><a href="#cb12-96" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(misclassStyled<span class="op">.</span><span class="fu">style</span>({<span class="dt">styleProperty</span><span class="op">:</span><span class="st">&quot;style&quot;</span>})<span class="op">,</span> {}<span class="op">,</span> <span class="st">&#39;Misclassified Points&#39;</span>)</span></code></pre></div>
</div>
<div id="image-normalization-and-standardization"
class="section level2">
<h2>Image Normalization and Standardization</h2>
<p>For machine learning, it is a recommended practice to either
normalize or standardize your features. The code below shows how to
implement these feature scaling techniques.</p>
<p><a
href="https://code.earthengine.google.co.in/?scriptPath=users%2Fujavalgandhi%2FEnd-to-End-GEE%3ASupplement%2FSupervised_Classification%2FImage_Normalization_and_Standardization"
target="_blank">Open in Code Editor ↗</a></p>
<div class="sourceCode" id="cb13"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb13-1"><a href="#cb13-1" tabindex="-1"></a><span class="kw">var</span> image <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(<span class="st">&quot;users/ujavalgandhi/e2e/arkavathy_2019_composite&quot;</span>)<span class="op">;</span></span>
<span id="cb13-2"><a href="#cb13-2" tabindex="-1"></a><span class="kw">var</span> boundary <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">&quot;users/ujavalgandhi/e2e/arkavathy_boundary&quot;</span>)</span>
<span id="cb13-3"><a href="#cb13-3" tabindex="-1"></a><span class="kw">var</span> geometry <span class="op">=</span> boundary<span class="op">.</span><span class="fu">geometry</span>()</span>
<span id="cb13-4"><a href="#cb13-4" tabindex="-1"></a></span>
<span id="cb13-5"><a href="#cb13-5" tabindex="-1"></a><span class="co">//************************************************************************** </span></span>
<span id="cb13-6"><a href="#cb13-6" tabindex="-1"></a><span class="co">// Function to Normalize Image</span></span>
<span id="cb13-7"><a href="#cb13-7" tabindex="-1"></a><span class="co">// Pixel Values should be between 0 and 1</span></span>
<span id="cb13-8"><a href="#cb13-8" tabindex="-1"></a><span class="co">// Formula is (x - xmin) / (xmax - xmin)</span></span>
<span id="cb13-9"><a href="#cb13-9" tabindex="-1"></a><span class="co">//************************************************************************** </span></span>
<span id="cb13-10"><a href="#cb13-10" tabindex="-1"></a><span class="kw">function</span> <span class="fu">normalize</span>(image){</span>
<span id="cb13-11"><a href="#cb13-11" tabindex="-1"></a>  <span class="kw">var</span> bandNames <span class="op">=</span> image<span class="op">.</span><span class="fu">bandNames</span>()<span class="op">;</span></span>
<span id="cb13-12"><a href="#cb13-12" tabindex="-1"></a>  <span class="co">// Compute min and max of the image</span></span>
<span id="cb13-13"><a href="#cb13-13" tabindex="-1"></a>  <span class="kw">var</span> minDict <span class="op">=</span> image<span class="op">.</span><span class="fu">reduceRegion</span>({</span>
<span id="cb13-14"><a href="#cb13-14" tabindex="-1"></a>    <span class="dt">reducer</span><span class="op">:</span> ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">min</span>()<span class="op">,</span></span>
<span id="cb13-15"><a href="#cb13-15" tabindex="-1"></a>    <span class="dt">geometry</span><span class="op">:</span> geometry<span class="op">,</span></span>
<span id="cb13-16"><a href="#cb13-16" tabindex="-1"></a>    <span class="dt">scale</span><span class="op">:</span> <span class="dv">10</span><span class="op">,</span></span>
<span id="cb13-17"><a href="#cb13-17" tabindex="-1"></a>    <span class="dt">maxPixels</span><span class="op">:</span> <span class="fl">1e9</span><span class="op">,</span></span>
<span id="cb13-18"><a href="#cb13-18" tabindex="-1"></a>    <span class="dt">bestEffort</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb13-19"><a href="#cb13-19" tabindex="-1"></a>    <span class="dt">tileScale</span><span class="op">:</span> <span class="dv">16</span></span>
<span id="cb13-20"><a href="#cb13-20" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb13-21"><a href="#cb13-21" tabindex="-1"></a>  <span class="kw">var</span> maxDict <span class="op">=</span> image<span class="op">.</span><span class="fu">reduceRegion</span>({</span>
<span id="cb13-22"><a href="#cb13-22" tabindex="-1"></a>    <span class="dt">reducer</span><span class="op">:</span> ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">max</span>()<span class="op">,</span></span>
<span id="cb13-23"><a href="#cb13-23" tabindex="-1"></a>    <span class="dt">geometry</span><span class="op">:</span> geometry<span class="op">,</span></span>
<span id="cb13-24"><a href="#cb13-24" tabindex="-1"></a>    <span class="dt">scale</span><span class="op">:</span> <span class="dv">10</span><span class="op">,</span></span>
<span id="cb13-25"><a href="#cb13-25" tabindex="-1"></a>    <span class="dt">maxPixels</span><span class="op">:</span> <span class="fl">1e9</span><span class="op">,</span></span>
<span id="cb13-26"><a href="#cb13-26" tabindex="-1"></a>    <span class="dt">bestEffort</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb13-27"><a href="#cb13-27" tabindex="-1"></a>    <span class="dt">tileScale</span><span class="op">:</span> <span class="dv">16</span></span>
<span id="cb13-28"><a href="#cb13-28" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb13-29"><a href="#cb13-29" tabindex="-1"></a>  <span class="kw">var</span> mins <span class="op">=</span> ee<span class="op">.</span><span class="at">Image</span><span class="op">.</span><span class="fu">constant</span>(minDict<span class="op">.</span><span class="fu">values</span>(bandNames))<span class="op">;</span></span>
<span id="cb13-30"><a href="#cb13-30" tabindex="-1"></a>  <span class="kw">var</span> maxs <span class="op">=</span> ee<span class="op">.</span><span class="at">Image</span><span class="op">.</span><span class="fu">constant</span>(maxDict<span class="op">.</span><span class="fu">values</span>(bandNames))<span class="op">;</span></span>
<span id="cb13-31"><a href="#cb13-31" tabindex="-1"></a></span>
<span id="cb13-32"><a href="#cb13-32" tabindex="-1"></a>  <span class="kw">var</span> normalized <span class="op">=</span> image<span class="op">.</span><span class="fu">subtract</span>(mins)<span class="op">.</span><span class="fu">divide</span>(maxs<span class="op">.</span><span class="fu">subtract</span>(mins))</span>
<span id="cb13-33"><a href="#cb13-33" tabindex="-1"></a>  <span class="cf">return</span> normalized</span>
<span id="cb13-34"><a href="#cb13-34" tabindex="-1"></a>}</span>
<span id="cb13-35"><a href="#cb13-35" tabindex="-1"></a></span>
<span id="cb13-36"><a href="#cb13-36" tabindex="-1"></a><span class="co">//************************************************************************** </span></span>
<span id="cb13-37"><a href="#cb13-37" tabindex="-1"></a><span class="co">// Function to Standardize Image</span></span>
<span id="cb13-38"><a href="#cb13-38" tabindex="-1"></a><span class="co">// (Mean Centered Imagery with Unit Standard Deviation)</span></span>
<span id="cb13-39"><a href="#cb13-39" tabindex="-1"></a><span class="co">// https://365datascience.com/tutorials/statistics-tutorials/standardization/</span></span>
<span id="cb13-40"><a href="#cb13-40" tabindex="-1"></a><span class="co">//************************************************************************** </span></span>
<span id="cb13-41"><a href="#cb13-41" tabindex="-1"></a><span class="kw">function</span> <span class="fu">standardize</span>(image){</span>
<span id="cb13-42"><a href="#cb13-42" tabindex="-1"></a>  <span class="kw">var</span> bandNames <span class="op">=</span> image<span class="op">.</span><span class="fu">bandNames</span>()<span class="op">;</span></span>
<span id="cb13-43"><a href="#cb13-43" tabindex="-1"></a>  <span class="co">// Mean center the data to enable a faster covariance reducer</span></span>
<span id="cb13-44"><a href="#cb13-44" tabindex="-1"></a>  <span class="co">// and an SD stretch of the principal components.</span></span>
<span id="cb13-45"><a href="#cb13-45" tabindex="-1"></a>  <span class="kw">var</span> meanDict <span class="op">=</span> image<span class="op">.</span><span class="fu">reduceRegion</span>({</span>
<span id="cb13-46"><a href="#cb13-46" tabindex="-1"></a>    <span class="dt">reducer</span><span class="op">:</span> ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">mean</span>()<span class="op">,</span></span>
<span id="cb13-47"><a href="#cb13-47" tabindex="-1"></a>    <span class="dt">geometry</span><span class="op">:</span> geometry<span class="op">,</span></span>
<span id="cb13-48"><a href="#cb13-48" tabindex="-1"></a>    <span class="dt">scale</span><span class="op">:</span> <span class="dv">10</span><span class="op">,</span></span>
<span id="cb13-49"><a href="#cb13-49" tabindex="-1"></a>    <span class="dt">maxPixels</span><span class="op">:</span> <span class="fl">1e9</span><span class="op">,</span></span>
<span id="cb13-50"><a href="#cb13-50" tabindex="-1"></a>    <span class="dt">bestEffort</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb13-51"><a href="#cb13-51" tabindex="-1"></a>    <span class="dt">tileScale</span><span class="op">:</span> <span class="dv">16</span></span>
<span id="cb13-52"><a href="#cb13-52" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb13-53"><a href="#cb13-53" tabindex="-1"></a>  <span class="kw">var</span> means <span class="op">=</span> ee<span class="op">.</span><span class="at">Image</span><span class="op">.</span><span class="fu">constant</span>(meanDict<span class="op">.</span><span class="fu">values</span>(bandNames))<span class="op">;</span></span>
<span id="cb13-54"><a href="#cb13-54" tabindex="-1"></a>  <span class="kw">var</span> centered <span class="op">=</span> image<span class="op">.</span><span class="fu">subtract</span>(means)</span>
<span id="cb13-55"><a href="#cb13-55" tabindex="-1"></a>  </span>
<span id="cb13-56"><a href="#cb13-56" tabindex="-1"></a>  <span class="kw">var</span> stdDevDict <span class="op">=</span> image<span class="op">.</span><span class="fu">reduceRegion</span>({</span>
<span id="cb13-57"><a href="#cb13-57" tabindex="-1"></a>    <span class="dt">reducer</span><span class="op">:</span> ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">stdDev</span>()<span class="op">,</span></span>
<span id="cb13-58"><a href="#cb13-58" tabindex="-1"></a>    <span class="dt">geometry</span><span class="op">:</span> geometry<span class="op">,</span></span>
<span id="cb13-59"><a href="#cb13-59" tabindex="-1"></a>    <span class="dt">scale</span><span class="op">:</span> <span class="dv">10</span><span class="op">,</span></span>
<span id="cb13-60"><a href="#cb13-60" tabindex="-1"></a>    <span class="dt">maxPixels</span><span class="op">:</span> <span class="fl">1e9</span><span class="op">,</span></span>
<span id="cb13-61"><a href="#cb13-61" tabindex="-1"></a>    <span class="dt">bestEffort</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb13-62"><a href="#cb13-62" tabindex="-1"></a>    <span class="dt">tileScale</span><span class="op">:</span> <span class="dv">16</span></span>
<span id="cb13-63"><a href="#cb13-63" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb13-64"><a href="#cb13-64" tabindex="-1"></a>  <span class="kw">var</span> stddevs <span class="op">=</span> ee<span class="op">.</span><span class="at">Image</span><span class="op">.</span><span class="fu">constant</span>(stdDevDict<span class="op">.</span><span class="fu">values</span>(bandNames))<span class="op">;</span></span>
<span id="cb13-65"><a href="#cb13-65" tabindex="-1"></a></span>
<span id="cb13-66"><a href="#cb13-66" tabindex="-1"></a>  <span class="kw">var</span> standardized <span class="op">=</span> centered<span class="op">.</span><span class="fu">divide</span>(stddevs)<span class="op">;</span></span>
<span id="cb13-67"><a href="#cb13-67" tabindex="-1"></a>   </span>
<span id="cb13-68"><a href="#cb13-68" tabindex="-1"></a>  <span class="cf">return</span> standardized</span>
<span id="cb13-69"><a href="#cb13-69" tabindex="-1"></a>}</span>
<span id="cb13-70"><a href="#cb13-70" tabindex="-1"></a></span>
<span id="cb13-71"><a href="#cb13-71" tabindex="-1"></a><span class="kw">var</span> standardizedImage <span class="op">=</span> <span class="fu">standardize</span>(image)</span>
<span id="cb13-72"><a href="#cb13-72" tabindex="-1"></a><span class="kw">var</span> normalizedImage <span class="op">=</span> <span class="fu">normalize</span>(image)</span>
<span id="cb13-73"><a href="#cb13-73" tabindex="-1"></a></span>
<span id="cb13-74"><a href="#cb13-74" tabindex="-1"></a></span>
<span id="cb13-75"><a href="#cb13-75" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(image<span class="op">,</span> </span>
<span id="cb13-76"><a href="#cb13-76" tabindex="-1"></a>  {<span class="dt">bands</span><span class="op">:</span> [<span class="st">&#39;B4&#39;</span><span class="op">,</span> <span class="st">&#39;B3&#39;</span><span class="op">,</span> <span class="st">&#39;B2&#39;</span>]<span class="op">,</span> <span class="dt">min</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span> <span class="fl">0.3</span><span class="op">,</span> <span class="dt">gamma</span><span class="op">:</span> <span class="fl">1.2</span>}<span class="op">,</span> <span class="st">&#39;Original Image&#39;</span>)<span class="op">;</span></span>
<span id="cb13-77"><a href="#cb13-77" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(normalizedImage<span class="op">,</span></span>
<span id="cb13-78"><a href="#cb13-78" tabindex="-1"></a>  {<span class="dt">bands</span><span class="op">:</span> [<span class="st">&#39;B4&#39;</span><span class="op">,</span> <span class="st">&#39;B3&#39;</span><span class="op">,</span> <span class="st">&#39;B2&#39;</span>]<span class="op">,</span> <span class="dt">min</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span> <span class="dv">1</span><span class="op">,</span> <span class="dt">gamma</span><span class="op">:</span> <span class="fl">1.2</span>}<span class="op">,</span> <span class="st">&#39;Normalized Image&#39;</span>)<span class="op">;</span></span>
<span id="cb13-79"><a href="#cb13-79" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(standardizedImage<span class="op">,</span></span>
<span id="cb13-80"><a href="#cb13-80" tabindex="-1"></a>  {<span class="dt">bands</span><span class="op">:</span> [<span class="st">&#39;B4&#39;</span><span class="op">,</span> <span class="st">&#39;B3&#39;</span><span class="op">,</span> <span class="st">&#39;B2&#39;</span>]<span class="op">,</span> <span class="dt">min</span><span class="op">:</span> <span class="op">-</span><span class="dv">1</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span> <span class="dv">2</span><span class="op">,</span> <span class="dt">gamma</span><span class="op">:</span> <span class="fl">1.2</span>}<span class="op">,</span> <span class="st">&#39;Standarized Image&#39;</span>)<span class="op">;</span></span>
<span id="cb13-81"><a href="#cb13-81" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">centerObject</span>(geometry)</span>
<span id="cb13-82"><a href="#cb13-82" tabindex="-1"></a></span>
<span id="cb13-83"><a href="#cb13-83" tabindex="-1"></a><span class="co">// Verify Normalization</span></span>
<span id="cb13-84"><a href="#cb13-84" tabindex="-1"></a></span>
<span id="cb13-85"><a href="#cb13-85" tabindex="-1"></a><span class="kw">var</span> beforeDict <span class="op">=</span> image<span class="op">.</span><span class="fu">reduceRegion</span>({</span>
<span id="cb13-86"><a href="#cb13-86" tabindex="-1"></a>  <span class="dt">reducer</span><span class="op">:</span> ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">minMax</span>()<span class="op">,</span></span>
<span id="cb13-87"><a href="#cb13-87" tabindex="-1"></a>  <span class="dt">geometry</span><span class="op">:</span> geometry<span class="op">,</span></span>
<span id="cb13-88"><a href="#cb13-88" tabindex="-1"></a>  <span class="dt">scale</span><span class="op">:</span> <span class="dv">10</span><span class="op">,</span></span>
<span id="cb13-89"><a href="#cb13-89" tabindex="-1"></a>  <span class="dt">maxPixels</span><span class="op">:</span> <span class="fl">1e9</span><span class="op">,</span></span>
<span id="cb13-90"><a href="#cb13-90" tabindex="-1"></a>  <span class="dt">bestEffort</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb13-91"><a href="#cb13-91" tabindex="-1"></a>  <span class="dt">tileScale</span><span class="op">:</span> <span class="dv">16</span></span>
<span id="cb13-92"><a href="#cb13-92" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb13-93"><a href="#cb13-93" tabindex="-1"></a></span>
<span id="cb13-94"><a href="#cb13-94" tabindex="-1"></a><span class="kw">var</span> afterDict <span class="op">=</span> normalizedImage<span class="op">.</span><span class="fu">reduceRegion</span>({</span>
<span id="cb13-95"><a href="#cb13-95" tabindex="-1"></a>  <span class="dt">reducer</span><span class="op">:</span> ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">minMax</span>()<span class="op">,</span></span>
<span id="cb13-96"><a href="#cb13-96" tabindex="-1"></a>  <span class="dt">geometry</span><span class="op">:</span> geometry<span class="op">,</span></span>
<span id="cb13-97"><a href="#cb13-97" tabindex="-1"></a>  <span class="dt">scale</span><span class="op">:</span> <span class="dv">10</span><span class="op">,</span></span>
<span id="cb13-98"><a href="#cb13-98" tabindex="-1"></a>  <span class="dt">maxPixels</span><span class="op">:</span> <span class="fl">1e9</span><span class="op">,</span></span>
<span id="cb13-99"><a href="#cb13-99" tabindex="-1"></a>  <span class="dt">bestEffort</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb13-100"><a href="#cb13-100" tabindex="-1"></a>  <span class="dt">tileScale</span><span class="op">:</span> <span class="dv">16</span></span>
<span id="cb13-101"><a href="#cb13-101" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb13-102"><a href="#cb13-102" tabindex="-1"></a></span>
<span id="cb13-103"><a href="#cb13-103" tabindex="-1"></a><span class="fu">print</span>(<span class="st">&#39;Original Image Min/Max&#39;</span><span class="op">,</span> beforeDict)</span>
<span id="cb13-104"><a href="#cb13-104" tabindex="-1"></a><span class="fu">print</span>(<span class="st">&#39;Normalized Image Min/Max&#39;</span><span class="op">,</span> afterDict)</span>
<span id="cb13-105"><a href="#cb13-105" tabindex="-1"></a></span>
<span id="cb13-106"><a href="#cb13-106" tabindex="-1"></a><span class="co">// Verify Standadization</span></span>
<span id="cb13-107"><a href="#cb13-107" tabindex="-1"></a><span class="co">// Verify that the means are 0 and standard deviations are 1</span></span>
<span id="cb13-108"><a href="#cb13-108" tabindex="-1"></a><span class="kw">var</span> beforeDict <span class="op">=</span> image<span class="op">.</span><span class="fu">reduceRegion</span>({</span>
<span id="cb13-109"><a href="#cb13-109" tabindex="-1"></a>  <span class="dt">reducer</span><span class="op">:</span> ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">mean</span>()<span class="op">.</span><span class="fu">combine</span>({</span>
<span id="cb13-110"><a href="#cb13-110" tabindex="-1"></a>      <span class="dt">reducer2</span><span class="op">:</span> ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">stdDev</span>()<span class="op">,</span> <span class="dt">sharedInputs</span><span class="op">:</span> <span class="kw">true</span>})<span class="op">,</span></span>
<span id="cb13-111"><a href="#cb13-111" tabindex="-1"></a>  <span class="dt">geometry</span><span class="op">:</span> geometry<span class="op">,</span></span>
<span id="cb13-112"><a href="#cb13-112" tabindex="-1"></a>  <span class="dt">scale</span><span class="op">:</span> <span class="dv">10</span><span class="op">,</span></span>
<span id="cb13-113"><a href="#cb13-113" tabindex="-1"></a>  <span class="dt">maxPixels</span><span class="op">:</span> <span class="fl">1e9</span><span class="op">,</span></span>
<span id="cb13-114"><a href="#cb13-114" tabindex="-1"></a>  <span class="dt">bestEffort</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb13-115"><a href="#cb13-115" tabindex="-1"></a>  <span class="dt">tileScale</span><span class="op">:</span> <span class="dv">16</span></span>
<span id="cb13-116"><a href="#cb13-116" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb13-117"><a href="#cb13-117" tabindex="-1"></a></span>
<span id="cb13-118"><a href="#cb13-118" tabindex="-1"></a><span class="kw">var</span> resultDict <span class="op">=</span> standardizedImage<span class="op">.</span><span class="fu">reduceRegion</span>({</span>
<span id="cb13-119"><a href="#cb13-119" tabindex="-1"></a>  <span class="dt">reducer</span><span class="op">:</span> ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">mean</span>()<span class="op">.</span><span class="fu">combine</span>({</span>
<span id="cb13-120"><a href="#cb13-120" tabindex="-1"></a>      <span class="dt">reducer2</span><span class="op">:</span> ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">stdDev</span>()<span class="op">,</span> <span class="dt">sharedInputs</span><span class="op">:</span> <span class="kw">true</span>})<span class="op">,</span></span>
<span id="cb13-121"><a href="#cb13-121" tabindex="-1"></a>  <span class="dt">geometry</span><span class="op">:</span> geometry<span class="op">,</span></span>
<span id="cb13-122"><a href="#cb13-122" tabindex="-1"></a>  <span class="dt">scale</span><span class="op">:</span> <span class="dv">10</span><span class="op">,</span></span>
<span id="cb13-123"><a href="#cb13-123" tabindex="-1"></a>  <span class="dt">maxPixels</span><span class="op">:</span> <span class="fl">1e9</span><span class="op">,</span></span>
<span id="cb13-124"><a href="#cb13-124" tabindex="-1"></a>  <span class="dt">bestEffort</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb13-125"><a href="#cb13-125" tabindex="-1"></a>  <span class="dt">tileScale</span><span class="op">:</span> <span class="dv">16</span></span>
<span id="cb13-126"><a href="#cb13-126" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb13-127"><a href="#cb13-127" tabindex="-1"></a><span class="co">// Means are very small franctions close to 0</span></span>
<span id="cb13-128"><a href="#cb13-128" tabindex="-1"></a><span class="co">// Round them off to 2 decimals</span></span>
<span id="cb13-129"><a href="#cb13-129" tabindex="-1"></a><span class="kw">var</span> afterDict <span class="op">=</span> resultDict<span class="op">.</span><span class="fu">map</span>(<span class="kw">function</span>(key<span class="op">,</span> value) {</span>
<span id="cb13-130"><a href="#cb13-130" tabindex="-1"></a>  <span class="cf">return</span> ee<span class="op">.</span><span class="fu">Number</span>(value)<span class="op">.</span><span class="fu">format</span>(<span class="st">&#39;%.2f&#39;</span>)</span>
<span id="cb13-131"><a href="#cb13-131" tabindex="-1"></a>})</span>
<span id="cb13-132"><a href="#cb13-132" tabindex="-1"></a></span>
<span id="cb13-133"><a href="#cb13-133" tabindex="-1"></a><span class="fu">print</span>(<span class="st">&#39;Original Image Mean/StdDev&#39;</span><span class="op">,</span> beforeDict)</span>
<span id="cb13-134"><a href="#cb13-134" tabindex="-1"></a><span class="fu">print</span>(<span class="st">&#39;Standadized Image Mean/StdDev&#39;</span><span class="op">,</span> afterDict)</span></code></pre></div>
</div>
<div id="calculate-feature-importance" class="section level2">
<h2>Calculate Feature Importance</h2>
<p>Many classifiers in GEE have a <code>explain()</code> method that
calculates feature importances. The classifier will assign a score to
each input variable on how useful they were at predicting the correct
value. The script below shows how to extract the feature importance and
create a chart to visualize it.</p>
<div class="figure" style="text-align: center">
<img src="images/end_to_end_gee/feature_importance.png" alt="Relative Feature Importance" width="100%" />
<p class="caption">
Relative Feature Importance
</p>
</div>
<p><a
href="https://code.earthengine.google.com/?scriptPath=users%2Fujavalgandhi%2FEnd-to-End-GEE%3ASupplement%2FSupervised_Classification%2FFeature_Importance"
target="_blank">Open in Code Editor ↗</a></p>
<div class="sourceCode" id="cb14"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb14-1"><a href="#cb14-1" tabindex="-1"></a><span class="kw">var</span> bangalore <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">&#39;users/ujavalgandhi/public/bangalore_boundary&#39;</span>)</span>
<span id="cb14-2"><a href="#cb14-2" tabindex="-1"></a><span class="kw">var</span> s2 <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&#39;COPERNICUS/S2_SR_HARMONIZED&#39;</span>)</span>
<span id="cb14-3"><a href="#cb14-3" tabindex="-1"></a><span class="kw">var</span> gcps <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">&#39;users/ujavalgandhi/e2e/bangalore_gcps&#39;</span>)</span>
<span id="cb14-4"><a href="#cb14-4" tabindex="-1"></a></span>
<span id="cb14-5"><a href="#cb14-5" tabindex="-1"></a><span class="kw">var</span> filtered <span class="op">=</span> s2</span>
<span id="cb14-6"><a href="#cb14-6" tabindex="-1"></a><span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">lt</span>(<span class="st">&#39;CLOUDY_PIXEL_PERCENTAGE&#39;</span><span class="op">,</span> <span class="dv">30</span>))</span>
<span id="cb14-7"><a href="#cb14-7" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(<span class="st">&#39;2019-01-01&#39;</span><span class="op">,</span> <span class="st">&#39;2020-01-01&#39;</span>))</span>
<span id="cb14-8"><a href="#cb14-8" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">bounds</span>(bangalore))</span>
<span id="cb14-9"><a href="#cb14-9" tabindex="-1"></a>  <span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;B.*&#39;</span>)</span>
<span id="cb14-10"><a href="#cb14-10" tabindex="-1"></a></span>
<span id="cb14-11"><a href="#cb14-11" tabindex="-1"></a><span class="kw">var</span> composite <span class="op">=</span> filtered<span class="op">.</span><span class="fu">median</span>()<span class="op">.</span><span class="fu">clip</span>(bangalore) </span>
<span id="cb14-12"><a href="#cb14-12" tabindex="-1"></a></span>
<span id="cb14-13"><a href="#cb14-13" tabindex="-1"></a></span>
<span id="cb14-14"><a href="#cb14-14" tabindex="-1"></a><span class="kw">var</span> addIndices <span class="op">=</span> <span class="kw">function</span>(image) {</span>
<span id="cb14-15"><a href="#cb14-15" tabindex="-1"></a>  <span class="kw">var</span> ndvi <span class="op">=</span> image<span class="op">.</span><span class="fu">normalizedDifference</span>([<span class="st">&#39;B8&#39;</span><span class="op">,</span> <span class="st">&#39;B4&#39;</span>])<span class="op">.</span><span class="fu">rename</span>([<span class="st">&#39;ndvi&#39;</span>])<span class="op">;</span></span>
<span id="cb14-16"><a href="#cb14-16" tabindex="-1"></a>  <span class="kw">var</span> ndbi <span class="op">=</span> image<span class="op">.</span><span class="fu">normalizedDifference</span>([<span class="st">&#39;B11&#39;</span><span class="op">,</span> <span class="st">&#39;B8&#39;</span>])<span class="op">.</span><span class="fu">rename</span>([<span class="st">&#39;ndbi&#39;</span>])<span class="op">;</span></span>
<span id="cb14-17"><a href="#cb14-17" tabindex="-1"></a>  <span class="kw">var</span> mndwi <span class="op">=</span> image<span class="op">.</span><span class="fu">normalizedDifference</span>([<span class="st">&#39;B3&#39;</span><span class="op">,</span> <span class="st">&#39;B11&#39;</span>])<span class="op">.</span><span class="fu">rename</span>([<span class="st">&#39;mndwi&#39;</span>])<span class="op">;</span> </span>
<span id="cb14-18"><a href="#cb14-18" tabindex="-1"></a>  <span class="kw">var</span> bsi <span class="op">=</span> image<span class="op">.</span><span class="fu">expression</span>(</span>
<span id="cb14-19"><a href="#cb14-19" tabindex="-1"></a>      <span class="st">&#39;(( X + Y ) - (A + B)) /(( X + Y ) + (A + B)) &#39;</span><span class="op">,</span> {</span>
<span id="cb14-20"><a href="#cb14-20" tabindex="-1"></a>        <span class="st">&#39;X&#39;</span><span class="op">:</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;B11&#39;</span>)<span class="op">,</span> <span class="co">//swir1</span></span>
<span id="cb14-21"><a href="#cb14-21" tabindex="-1"></a>        <span class="st">&#39;Y&#39;</span><span class="op">:</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;B4&#39;</span>)<span class="op">,</span>  <span class="co">//red</span></span>
<span id="cb14-22"><a href="#cb14-22" tabindex="-1"></a>        <span class="st">&#39;A&#39;</span><span class="op">:</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;B8&#39;</span>)<span class="op">,</span> <span class="co">// nir</span></span>
<span id="cb14-23"><a href="#cb14-23" tabindex="-1"></a>        <span class="st">&#39;B&#39;</span><span class="op">:</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;B2&#39;</span>)<span class="op">,</span> <span class="co">// blue</span></span>
<span id="cb14-24"><a href="#cb14-24" tabindex="-1"></a>  })<span class="op">.</span><span class="fu">rename</span>(<span class="st">&#39;bsi&#39;</span>)<span class="op">;</span></span>
<span id="cb14-25"><a href="#cb14-25" tabindex="-1"></a>  <span class="cf">return</span> image<span class="op">.</span><span class="fu">addBands</span>(ndvi)<span class="op">.</span><span class="fu">addBands</span>(ndbi)<span class="op">.</span><span class="fu">addBands</span>(mndwi)<span class="op">.</span><span class="fu">addBands</span>(bsi)</span>
<span id="cb14-26"><a href="#cb14-26" tabindex="-1"></a>}</span>
<span id="cb14-27"><a href="#cb14-27" tabindex="-1"></a></span>
<span id="cb14-28"><a href="#cb14-28" tabindex="-1"></a>composite <span class="op">=</span> <span class="fu">addIndices</span>(composite)</span>
<span id="cb14-29"><a href="#cb14-29" tabindex="-1"></a></span>
<span id="cb14-30"><a href="#cb14-30" tabindex="-1"></a></span>
<span id="cb14-31"><a href="#cb14-31" tabindex="-1"></a><span class="co">// Display the input composite.</span></span>
<span id="cb14-32"><a href="#cb14-32" tabindex="-1"></a><span class="kw">var</span> rgbVis <span class="op">=</span> {</span>
<span id="cb14-33"><a href="#cb14-33" tabindex="-1"></a>  <span class="dt">min</span><span class="op">:</span> <span class="fl">0.0</span><span class="op">,</span></span>
<span id="cb14-34"><a href="#cb14-34" tabindex="-1"></a>  <span class="dt">max</span><span class="op">:</span> <span class="dv">3000</span><span class="op">,</span></span>
<span id="cb14-35"><a href="#cb14-35" tabindex="-1"></a>  <span class="dt">bands</span><span class="op">:</span> [<span class="st">&#39;B4&#39;</span><span class="op">,</span> <span class="st">&#39;B3&#39;</span><span class="op">,</span> <span class="st">&#39;B2&#39;</span>]<span class="op">,</span></span>
<span id="cb14-36"><a href="#cb14-36" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb14-37"><a href="#cb14-37" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(composite<span class="op">,</span> rgbVis<span class="op">,</span> <span class="st">&#39;image&#39;</span>)<span class="op">;</span></span>
<span id="cb14-38"><a href="#cb14-38" tabindex="-1"></a></span>
<span id="cb14-39"><a href="#cb14-39" tabindex="-1"></a></span>
<span id="cb14-40"><a href="#cb14-40" tabindex="-1"></a><span class="co">// Overlay the point on the image to get training data.</span></span>
<span id="cb14-41"><a href="#cb14-41" tabindex="-1"></a><span class="kw">var</span> training <span class="op">=</span> composite<span class="op">.</span><span class="fu">sampleRegions</span>({</span>
<span id="cb14-42"><a href="#cb14-42" tabindex="-1"></a>  <span class="dt">collection</span><span class="op">:</span> gcps<span class="op">,</span> </span>
<span id="cb14-43"><a href="#cb14-43" tabindex="-1"></a>  <span class="dt">properties</span><span class="op">:</span> [<span class="st">&#39;landcover&#39;</span>]<span class="op">,</span> </span>
<span id="cb14-44"><a href="#cb14-44" tabindex="-1"></a>  <span class="dt">scale</span><span class="op">:</span> <span class="dv">10</span></span>
<span id="cb14-45"><a href="#cb14-45" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb14-46"><a href="#cb14-46" tabindex="-1"></a></span>
<span id="cb14-47"><a href="#cb14-47" tabindex="-1"></a></span>
<span id="cb14-48"><a href="#cb14-48" tabindex="-1"></a><span class="co">// Train a classifier.</span></span>
<span id="cb14-49"><a href="#cb14-49" tabindex="-1"></a><span class="kw">var</span> classifier <span class="op">=</span> ee<span class="op">.</span><span class="at">Classifier</span><span class="op">.</span><span class="fu">smileRandomForest</span>(<span class="dv">50</span>)<span class="op">.</span><span class="fu">train</span>({</span>
<span id="cb14-50"><a href="#cb14-50" tabindex="-1"></a>  <span class="dt">features</span><span class="op">:</span> training<span class="op">,</span>  </span>
<span id="cb14-51"><a href="#cb14-51" tabindex="-1"></a>  <span class="dt">classProperty</span><span class="op">:</span> <span class="st">&#39;landcover&#39;</span><span class="op">,</span> </span>
<span id="cb14-52"><a href="#cb14-52" tabindex="-1"></a>  <span class="dt">inputProperties</span><span class="op">:</span> composite<span class="op">.</span><span class="fu">bandNames</span>()</span>
<span id="cb14-53"><a href="#cb14-53" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb14-54"><a href="#cb14-54" tabindex="-1"></a><span class="co">// // Classify the image.</span></span>
<span id="cb14-55"><a href="#cb14-55" tabindex="-1"></a><span class="kw">var</span> classified <span class="op">=</span> composite<span class="op">.</span><span class="fu">classify</span>(classifier)<span class="op">;</span></span>
<span id="cb14-56"><a href="#cb14-56" tabindex="-1"></a><span class="kw">var</span> palette <span class="op">=</span> [<span class="st">&#39;#cc6d8f&#39;</span><span class="op">,</span> <span class="st">&#39;#ffc107&#39;</span><span class="op">,</span> <span class="st">&#39;#1e88e5&#39;</span><span class="op">,</span> <span class="st">&#39;#004d40&#39;</span> ]<span class="op">;</span></span>
<span id="cb14-57"><a href="#cb14-57" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(classified<span class="op">,</span> {<span class="dt">min</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span> <span class="dv">3</span><span class="op">,</span> <span class="dt">palette</span><span class="op">:</span> palette}<span class="op">,</span> <span class="st">&#39;2019&#39;</span>)<span class="op">;</span></span>
<span id="cb14-58"><a href="#cb14-58" tabindex="-1"></a></span>
<span id="cb14-59"><a href="#cb14-59" tabindex="-1"></a></span>
<span id="cb14-60"><a href="#cb14-60" tabindex="-1"></a><span class="co">//************************************************************************** </span></span>
<span id="cb14-61"><a href="#cb14-61" tabindex="-1"></a><span class="co">// Calculate Feature Importance</span></span>
<span id="cb14-62"><a href="#cb14-62" tabindex="-1"></a><span class="co">//************************************************************************** </span></span>
<span id="cb14-63"><a href="#cb14-63" tabindex="-1"></a>    </span>
<span id="cb14-64"><a href="#cb14-64" tabindex="-1"></a><span class="co">// Run .explain() to see what the classifer looks like</span></span>
<span id="cb14-65"><a href="#cb14-65" tabindex="-1"></a><span class="fu">print</span>(classifier<span class="op">.</span><span class="fu">explain</span>())</span>
<span id="cb14-66"><a href="#cb14-66" tabindex="-1"></a></span>
<span id="cb14-67"><a href="#cb14-67" tabindex="-1"></a><span class="co">// Calculate variable importance</span></span>
<span id="cb14-68"><a href="#cb14-68" tabindex="-1"></a><span class="kw">var</span> importance <span class="op">=</span> ee<span class="op">.</span><span class="fu">Dictionary</span>(classifier<span class="op">.</span><span class="fu">explain</span>()<span class="op">.</span><span class="fu">get</span>(<span class="st">&#39;importance&#39;</span>))</span>
<span id="cb14-69"><a href="#cb14-69" tabindex="-1"></a></span>
<span id="cb14-70"><a href="#cb14-70" tabindex="-1"></a></span>
<span id="cb14-71"><a href="#cb14-71" tabindex="-1"></a><span class="co">// Calculate relative importance</span></span>
<span id="cb14-72"><a href="#cb14-72" tabindex="-1"></a><span class="kw">var</span> sum <span class="op">=</span> importance<span class="op">.</span><span class="fu">values</span>()<span class="op">.</span><span class="fu">reduce</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">sum</span>())</span>
<span id="cb14-73"><a href="#cb14-73" tabindex="-1"></a></span>
<span id="cb14-74"><a href="#cb14-74" tabindex="-1"></a><span class="kw">var</span> relativeImportance <span class="op">=</span> importance<span class="op">.</span><span class="fu">map</span>(<span class="kw">function</span>(key<span class="op">,</span> val) {</span>
<span id="cb14-75"><a href="#cb14-75" tabindex="-1"></a>   <span class="cf">return</span> (ee<span class="op">.</span><span class="fu">Number</span>(val)<span class="op">.</span><span class="fu">multiply</span>(<span class="dv">100</span>))<span class="op">.</span><span class="fu">divide</span>(sum)</span>
<span id="cb14-76"><a href="#cb14-76" tabindex="-1"></a>  })</span>
<span id="cb14-77"><a href="#cb14-77" tabindex="-1"></a><span class="fu">print</span>(relativeImportance)</span>
<span id="cb14-78"><a href="#cb14-78" tabindex="-1"></a></span>
<span id="cb14-79"><a href="#cb14-79" tabindex="-1"></a><span class="co">// Create a FeatureCollection so we can chart it</span></span>
<span id="cb14-80"><a href="#cb14-80" tabindex="-1"></a><span class="kw">var</span> importanceFc <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>([</span>
<span id="cb14-81"><a href="#cb14-81" tabindex="-1"></a>  ee<span class="op">.</span><span class="fu">Feature</span>(<span class="kw">null</span><span class="op">,</span> relativeImportance)</span>
<span id="cb14-82"><a href="#cb14-82" tabindex="-1"></a>])</span>
<span id="cb14-83"><a href="#cb14-83" tabindex="-1"></a></span>
<span id="cb14-84"><a href="#cb14-84" tabindex="-1"></a><span class="kw">var</span> chart <span class="op">=</span> ui<span class="op">.</span><span class="at">Chart</span><span class="op">.</span><span class="at">feature</span><span class="op">.</span><span class="fu">byProperty</span>({</span>
<span id="cb14-85"><a href="#cb14-85" tabindex="-1"></a>  <span class="dt">features</span><span class="op">:</span> importanceFc</span>
<span id="cb14-86"><a href="#cb14-86" tabindex="-1"></a>})<span class="op">.</span><span class="fu">setOptions</span>({</span>
<span id="cb14-87"><a href="#cb14-87" tabindex="-1"></a>      <span class="dt">title</span><span class="op">:</span> <span class="st">&#39;Feature Importance&#39;</span><span class="op">,</span></span>
<span id="cb14-88"><a href="#cb14-88" tabindex="-1"></a>      <span class="dt">vAxis</span><span class="op">:</span> {<span class="dt">title</span><span class="op">:</span> <span class="st">&#39;Importance&#39;</span>}<span class="op">,</span></span>
<span id="cb14-89"><a href="#cb14-89" tabindex="-1"></a>      <span class="dt">hAxis</span><span class="op">:</span> {<span class="dt">title</span><span class="op">:</span> <span class="st">&#39;Feature&#39;</span>}<span class="op">,</span></span>
<span id="cb14-90"><a href="#cb14-90" tabindex="-1"></a>      <span class="dt">legend</span><span class="op">:</span> {<span class="dt">position</span><span class="op">:</span> <span class="st">&#39;none&#39;</span>}</span>
<span id="cb14-91"><a href="#cb14-91" tabindex="-1"></a>  })</span>
<span id="cb14-92"><a href="#cb14-92" tabindex="-1"></a><span class="fu">print</span>(chart)</span></code></pre></div>
</div>
<div id="classification-with-migrated-training-samples"
class="section level2">
<h2>Classification with Migrated Training Samples</h2>
<p><a
href="https://code.earthengine.google.co.in/?scriptPath=users%2Fujavalgandhi%2FEnd-to-End-GEE%3ASupplement%2FSupervised_Classification%2FClassification_with_Migrated_Training_Samples"
target="_blank">Open in Code Editor ↗</a></p>
<div class="sourceCode" id="cb15"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb15-1"><a href="#cb15-1" tabindex="-1"></a><span class="co">// Script showing how to use migrated training samples</span></span>
<span id="cb15-2"><a href="#cb15-2" tabindex="-1"></a><span class="co">// for multi-year classification</span></span>
<span id="cb15-3"><a href="#cb15-3" tabindex="-1"></a></span>
<span id="cb15-4"><a href="#cb15-4" tabindex="-1"></a><span class="co">// Training samples are collected on a 2019 Sentinel-2 composite</span></span>
<span id="cb15-5"><a href="#cb15-5" tabindex="-1"></a><span class="co">// and are used to classify a 2020 Sentinel-2 composite</span></span>
<span id="cb15-6"><a href="#cb15-6" tabindex="-1"></a><span class="co">// We use spectral distance measure to discard samples that show</span></span>
<span id="cb15-7"><a href="#cb15-7" tabindex="-1"></a><span class="co">// large change between the target and reference years.</span></span>
<span id="cb15-8"><a href="#cb15-8" tabindex="-1"></a><span class="kw">var</span> s2 <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&#39;COPERNICUS/S2_SR_HARMONIZED&#39;</span>)<span class="op">;</span></span>
<span id="cb15-9"><a href="#cb15-9" tabindex="-1"></a><span class="kw">var</span> basin <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">&quot;WWF/HydroSHEDS/v1/Basins/hybas_7&quot;</span>)<span class="op">;</span></span>
<span id="cb15-10"><a href="#cb15-10" tabindex="-1"></a><span class="kw">var</span> gcp <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">&quot;users/ujavalgandhi/e2e/arkavathy_gcps&quot;</span>)<span class="op">;</span></span>
<span id="cb15-11"><a href="#cb15-11" tabindex="-1"></a>    </span>
<span id="cb15-12"><a href="#cb15-12" tabindex="-1"></a><span class="kw">var</span> arkavathy <span class="op">=</span> basin<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;HYBAS_ID&#39;</span><span class="op">,</span> <span class="dv">4071139640</span>))<span class="op">;</span></span>
<span id="cb15-13"><a href="#cb15-13" tabindex="-1"></a><span class="kw">var</span> geometry <span class="op">=</span> arkavathy<span class="op">.</span><span class="fu">geometry</span>()<span class="op">;</span></span>
<span id="cb15-14"><a href="#cb15-14" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">centerObject</span>(geometry)<span class="op">;</span></span>
<span id="cb15-15"><a href="#cb15-15" tabindex="-1"></a></span>
<span id="cb15-16"><a href="#cb15-16" tabindex="-1"></a><span class="kw">var</span> rgbVis <span class="op">=</span> {</span>
<span id="cb15-17"><a href="#cb15-17" tabindex="-1"></a>  <span class="dt">min</span><span class="op">:</span> <span class="fl">0.0</span><span class="op">,</span></span>
<span id="cb15-18"><a href="#cb15-18" tabindex="-1"></a>  <span class="dt">max</span><span class="op">:</span> <span class="fl">0.3</span><span class="op">,</span></span>
<span id="cb15-19"><a href="#cb15-19" tabindex="-1"></a>  <span class="dt">bands</span><span class="op">:</span> [<span class="st">&#39;B4&#39;</span><span class="op">,</span> <span class="st">&#39;B3&#39;</span><span class="op">,</span> <span class="st">&#39;B2&#39;</span>]<span class="op">,</span></span>
<span id="cb15-20"><a href="#cb15-20" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb15-21"><a href="#cb15-21" tabindex="-1"></a></span>
<span id="cb15-22"><a href="#cb15-22" tabindex="-1"></a><span class="kw">var</span> scaleValues <span class="op">=</span> <span class="kw">function</span>(image) {</span>
<span id="cb15-23"><a href="#cb15-23" tabindex="-1"></a>  <span class="cf">return</span> image<span class="op">.</span><span class="fu">multiply</span>(<span class="fl">0.0001</span>)<span class="op">.</span><span class="fu">copyProperties</span>(image<span class="op">,</span> [<span class="st">&#39;system:time_start&#39;</span>])<span class="op">;</span></span>
<span id="cb15-24"><a href="#cb15-24" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb15-25"><a href="#cb15-25" tabindex="-1"></a></span>
<span id="cb15-26"><a href="#cb15-26" tabindex="-1"></a><span class="co">// Prepare 2019 composite</span></span>
<span id="cb15-27"><a href="#cb15-27" tabindex="-1"></a><span class="kw">var</span> filtered <span class="op">=</span> s2</span>
<span id="cb15-28"><a href="#cb15-28" tabindex="-1"></a><span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">lt</span>(<span class="st">&#39;CLOUDY_PIXEL_PERCENTAGE&#39;</span><span class="op">,</span> <span class="dv">30</span>))</span>
<span id="cb15-29"><a href="#cb15-29" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(<span class="st">&#39;2019-01-01&#39;</span><span class="op">,</span> <span class="st">&#39;2020-01-01&#39;</span>))</span>
<span id="cb15-30"><a href="#cb15-30" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">bounds</span>(geometry))</span>
<span id="cb15-31"><a href="#cb15-31" tabindex="-1"></a>  <span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;B.*&#39;</span>)</span>
<span id="cb15-32"><a href="#cb15-32" tabindex="-1"></a>  <span class="op">.</span><span class="fu">map</span>(scaleValues)<span class="op">;</span></span>
<span id="cb15-33"><a href="#cb15-33" tabindex="-1"></a></span>
<span id="cb15-34"><a href="#cb15-34" tabindex="-1"></a><span class="kw">var</span> composite2019 <span class="op">=</span> filtered<span class="op">.</span><span class="fu">median</span>()<span class="op">.</span><span class="fu">clip</span>(geometry)<span class="op">;</span></span>
<span id="cb15-35"><a href="#cb15-35" tabindex="-1"></a></span>
<span id="cb15-36"><a href="#cb15-36" tabindex="-1"></a></span>
<span id="cb15-37"><a href="#cb15-37" tabindex="-1"></a><span class="co">// Prepare 2020 Composite</span></span>
<span id="cb15-38"><a href="#cb15-38" tabindex="-1"></a><span class="kw">var</span> filtered <span class="op">=</span> s2</span>
<span id="cb15-39"><a href="#cb15-39" tabindex="-1"></a><span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">lt</span>(<span class="st">&#39;CLOUDY_PIXEL_PERCENTAGE&#39;</span><span class="op">,</span> <span class="dv">30</span>))</span>
<span id="cb15-40"><a href="#cb15-40" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(<span class="st">&#39;2020-01-01&#39;</span><span class="op">,</span> <span class="st">&#39;2021-01-01&#39;</span>))</span>
<span id="cb15-41"><a href="#cb15-41" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">bounds</span>(geometry))</span>
<span id="cb15-42"><a href="#cb15-42" tabindex="-1"></a>  <span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;B.*&#39;</span>)</span>
<span id="cb15-43"><a href="#cb15-43" tabindex="-1"></a>  <span class="op">.</span><span class="fu">map</span>(scaleValues)<span class="op">;</span></span>
<span id="cb15-44"><a href="#cb15-44" tabindex="-1"></a></span>
<span id="cb15-45"><a href="#cb15-45" tabindex="-1"></a><span class="kw">var</span> composite2020 <span class="op">=</span> filtered<span class="op">.</span><span class="fu">median</span>()<span class="op">.</span><span class="fu">clip</span>(geometry)<span class="op">;</span></span>
<span id="cb15-46"><a href="#cb15-46" tabindex="-1"></a></span>
<span id="cb15-47"><a href="#cb15-47" tabindex="-1"></a><span class="co">// Display the 2020 composite.</span></span>
<span id="cb15-48"><a href="#cb15-48" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(composite2019<span class="op">,</span> rgbVis<span class="op">,</span> <span class="st">&#39;Composite 2019&#39;</span>)<span class="op">;</span></span>
<span id="cb15-49"><a href="#cb15-49" tabindex="-1"></a><span class="co">// Display the 2021 composite.</span></span>
<span id="cb15-50"><a href="#cb15-50" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(composite2020<span class="op">,</span> rgbVis<span class="op">,</span> <span class="st">&#39;Composite 2020&#39;</span>)<span class="op">;</span></span>
<span id="cb15-51"><a href="#cb15-51" tabindex="-1"></a></span>
<span id="cb15-52"><a href="#cb15-52" tabindex="-1"></a></span>
<span id="cb15-53"><a href="#cb15-53" tabindex="-1"></a><span class="co">// Compute Spectral Distance between 2019 and 2020 images</span></span>
<span id="cb15-54"><a href="#cb15-54" tabindex="-1"></a><span class="kw">var</span> distance <span class="op">=</span> composite2019<span class="op">.</span><span class="fu">spectralDistance</span>(composite2020<span class="op">,</span> <span class="st">&#39;sam&#39;</span>)<span class="op">;</span></span>
<span id="cb15-55"><a href="#cb15-55" tabindex="-1"></a><span class="co">// GCPs were collected on 2020 image</span></span>
<span id="cb15-56"><a href="#cb15-56" tabindex="-1"></a><span class="co">// Find out which GCPs are still unchanged in 2021</span></span>
<span id="cb15-57"><a href="#cb15-57" tabindex="-1"></a></span>
<span id="cb15-58"><a href="#cb15-58" tabindex="-1"></a><span class="co">// Get the distance at the training points</span></span>
<span id="cb15-59"><a href="#cb15-59" tabindex="-1"></a><span class="kw">var</span> gcpWithDistance <span class="op">=</span> distance<span class="op">.</span><span class="fu">sampleRegions</span>({</span>
<span id="cb15-60"><a href="#cb15-60" tabindex="-1"></a>  <span class="dt">collection</span><span class="op">:</span> gcp<span class="op">,</span></span>
<span id="cb15-61"><a href="#cb15-61" tabindex="-1"></a>  <span class="dt">scale</span><span class="op">:</span> <span class="dv">10</span><span class="op">,</span></span>
<span id="cb15-62"><a href="#cb15-62" tabindex="-1"></a>  <span class="dt">tileScale</span><span class="op">:</span> <span class="dv">16</span><span class="op">,</span></span>
<span id="cb15-63"><a href="#cb15-63" tabindex="-1"></a>  <span class="dt">geometries</span><span class="op">:</span> <span class="kw">true</span></span>
<span id="cb15-64"><a href="#cb15-64" tabindex="-1"></a>})</span>
<span id="cb15-65"><a href="#cb15-65" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(gcpWithDistance<span class="op">,</span> {<span class="dt">color</span><span class="op">:</span> <span class="st">&#39;red&#39;</span>}<span class="op">,</span> <span class="st">&#39;GCPs with Distance&#39;</span><span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span></span>
<span id="cb15-66"><a href="#cb15-66" tabindex="-1"></a></span>
<span id="cb15-67"><a href="#cb15-67" tabindex="-1"></a><span class="co">// Adjust the threshold to discard GCPs are changed locations</span></span>
<span id="cb15-68"><a href="#cb15-68" tabindex="-1"></a><span class="co">// Threshold is determined manually</span></span>
<span id="cb15-69"><a href="#cb15-69" tabindex="-1"></a><span class="kw">var</span> threshold <span class="op">=</span> <span class="fl">0.2</span></span>
<span id="cb15-70"><a href="#cb15-70" tabindex="-1"></a><span class="kw">var</span> newGcp <span class="op">=</span> gcpWithDistance<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">lt</span>(<span class="st">&#39;distance&#39;</span><span class="op">,</span> threshold))<span class="op">;</span></span>
<span id="cb15-71"><a href="#cb15-71" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(newGcp<span class="op">,</span> {<span class="dt">color</span><span class="op">:</span> <span class="st">&#39;blue&#39;</span>}<span class="op">,</span> <span class="st">&#39;Filtered GCPs&#39;</span>)<span class="op">;</span></span>
<span id="cb15-72"><a href="#cb15-72" tabindex="-1"></a></span>
<span id="cb15-73"><a href="#cb15-73" tabindex="-1"></a><span class="fu">print</span>(<span class="st">&#39;Total GCPs&#39;</span><span class="op">,</span> gcp<span class="op">.</span><span class="fu">size</span>())<span class="op">;</span></span>
<span id="cb15-74"><a href="#cb15-74" tabindex="-1"></a><span class="fu">print</span>(<span class="st">&#39;Migrated GCPs&#39;</span><span class="op">,</span> newGcp<span class="op">.</span><span class="fu">size</span>())<span class="op">;</span></span>
<span id="cb15-75"><a href="#cb15-75" tabindex="-1"></a><span class="co">// We wrap the classification workflow in a function</span></span>
<span id="cb15-76"><a href="#cb15-76" tabindex="-1"></a><span class="co">// and call the function with the different composites and GCPs</span></span>
<span id="cb15-77"><a href="#cb15-77" tabindex="-1"></a><span class="fu">performClassification</span>(composite2019<span class="op">,</span> gcp<span class="op">,</span> <span class="st">&#39;2019&#39;</span>)<span class="op">;</span></span>
<span id="cb15-78"><a href="#cb15-78" tabindex="-1"></a><span class="fu">performClassification</span>(composite2020<span class="op">,</span> newGcp<span class="op">,</span> <span class="st">&#39;2020&#39;</span>)<span class="op">;</span></span>
<span id="cb15-79"><a href="#cb15-79" tabindex="-1"></a></span>
<span id="cb15-80"><a href="#cb15-80" tabindex="-1"></a><span class="co">//************************************************************************** </span></span>
<span id="cb15-81"><a href="#cb15-81" tabindex="-1"></a><span class="co">// Classification and Accuracy Assessment</span></span>
<span id="cb15-82"><a href="#cb15-82" tabindex="-1"></a><span class="co">//************************************************************************** </span></span>
<span id="cb15-83"><a href="#cb15-83" tabindex="-1"></a><span class="kw">function</span> <span class="fu">performClassification</span>(image<span class="op">,</span> gcp<span class="op">,</span> year) {</span>
<span id="cb15-84"><a href="#cb15-84" tabindex="-1"></a>  <span class="kw">var</span> gcp <span class="op">=</span> gcp<span class="op">.</span><span class="fu">randomColumn</span>()<span class="op">;</span></span>
<span id="cb15-85"><a href="#cb15-85" tabindex="-1"></a>  <span class="kw">var</span> trainingGcp <span class="op">=</span> gcp<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">lt</span>(<span class="st">&#39;random&#39;</span><span class="op">,</span> <span class="fl">0.6</span>))<span class="op">;</span></span>
<span id="cb15-86"><a href="#cb15-86" tabindex="-1"></a>  <span class="kw">var</span> validationGcp <span class="op">=</span> gcp<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">gte</span>(<span class="st">&#39;random&#39;</span><span class="op">,</span> <span class="fl">0.6</span>))<span class="op">;</span></span>
<span id="cb15-87"><a href="#cb15-87" tabindex="-1"></a>  </span>
<span id="cb15-88"><a href="#cb15-88" tabindex="-1"></a>  <span class="co">// Overlay the point on the image to get training data.</span></span>
<span id="cb15-89"><a href="#cb15-89" tabindex="-1"></a>  <span class="kw">var</span> training <span class="op">=</span> image<span class="op">.</span><span class="fu">sampleRegions</span>({</span>
<span id="cb15-90"><a href="#cb15-90" tabindex="-1"></a>    <span class="dt">collection</span><span class="op">:</span> trainingGcp<span class="op">,</span></span>
<span id="cb15-91"><a href="#cb15-91" tabindex="-1"></a>    <span class="dt">properties</span><span class="op">:</span> [<span class="st">&#39;landcover&#39;</span>]<span class="op">,</span></span>
<span id="cb15-92"><a href="#cb15-92" tabindex="-1"></a>    <span class="dt">scale</span><span class="op">:</span> <span class="dv">10</span><span class="op">,</span></span>
<span id="cb15-93"><a href="#cb15-93" tabindex="-1"></a>    <span class="dt">tileScale</span><span class="op">:</span> <span class="dv">16</span></span>
<span id="cb15-94"><a href="#cb15-94" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb15-95"><a href="#cb15-95" tabindex="-1"></a>  </span>
<span id="cb15-96"><a href="#cb15-96" tabindex="-1"></a>  <span class="co">// Train a classifier.</span></span>
<span id="cb15-97"><a href="#cb15-97" tabindex="-1"></a>  <span class="kw">var</span> classifier <span class="op">=</span> ee<span class="op">.</span><span class="at">Classifier</span><span class="op">.</span><span class="fu">smileRandomForest</span>(<span class="dv">50</span>)</span>
<span id="cb15-98"><a href="#cb15-98" tabindex="-1"></a>  <span class="op">.</span><span class="fu">train</span>({</span>
<span id="cb15-99"><a href="#cb15-99" tabindex="-1"></a>    <span class="dt">features</span><span class="op">:</span> training<span class="op">,</span>  </span>
<span id="cb15-100"><a href="#cb15-100" tabindex="-1"></a>    <span class="dt">classProperty</span><span class="op">:</span> <span class="st">&#39;landcover&#39;</span><span class="op">,</span></span>
<span id="cb15-101"><a href="#cb15-101" tabindex="-1"></a>    <span class="dt">inputProperties</span><span class="op">:</span> image<span class="op">.</span><span class="fu">bandNames</span>()</span>
<span id="cb15-102"><a href="#cb15-102" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb15-103"><a href="#cb15-103" tabindex="-1"></a>  </span>
<span id="cb15-104"><a href="#cb15-104" tabindex="-1"></a>  <span class="co">// Classify the image.</span></span>
<span id="cb15-105"><a href="#cb15-105" tabindex="-1"></a>  <span class="kw">var</span> classified <span class="op">=</span> image<span class="op">.</span><span class="fu">classify</span>(classifier)<span class="op">;</span></span>
<span id="cb15-106"><a href="#cb15-106" tabindex="-1"></a>  </span>
<span id="cb15-107"><a href="#cb15-107" tabindex="-1"></a>  <span class="kw">var</span> palette <span class="op">=</span> [<span class="st">&#39;#cc6d8f&#39;</span><span class="op">,</span> <span class="st">&#39;#ffc107&#39;</span><span class="op">,</span> <span class="st">&#39;#1e88e5&#39;</span><span class="op">,</span> <span class="st">&#39;#004d40&#39;</span> ]<span class="op">;</span></span>
<span id="cb15-108"><a href="#cb15-108" tabindex="-1"></a>  <span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(classified<span class="op">,</span> {<span class="dt">min</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span> <span class="dv">3</span><span class="op">,</span> <span class="dt">palette</span><span class="op">:</span> palette}<span class="op">,</span> year)<span class="op">;</span></span>
<span id="cb15-109"><a href="#cb15-109" tabindex="-1"></a>  </span>
<span id="cb15-110"><a href="#cb15-110" tabindex="-1"></a>  <span class="co">// Use classification map to assess accuracy using the validation fraction</span></span>
<span id="cb15-111"><a href="#cb15-111" tabindex="-1"></a>  <span class="co">// of the overall training set created above.</span></span>
<span id="cb15-112"><a href="#cb15-112" tabindex="-1"></a>  <span class="kw">var</span> test <span class="op">=</span> classified<span class="op">.</span><span class="fu">sampleRegions</span>({</span>
<span id="cb15-113"><a href="#cb15-113" tabindex="-1"></a>    <span class="dt">collection</span><span class="op">:</span> validationGcp<span class="op">,</span></span>
<span id="cb15-114"><a href="#cb15-114" tabindex="-1"></a>    <span class="dt">properties</span><span class="op">:</span> [<span class="st">&#39;landcover&#39;</span>]<span class="op">,</span></span>
<span id="cb15-115"><a href="#cb15-115" tabindex="-1"></a>    <span class="dt">tileScale</span><span class="op">:</span> <span class="dv">16</span><span class="op">,</span></span>
<span id="cb15-116"><a href="#cb15-116" tabindex="-1"></a>    <span class="dt">scale</span><span class="op">:</span> <span class="dv">10</span><span class="op">,</span></span>
<span id="cb15-117"><a href="#cb15-117" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb15-118"><a href="#cb15-118" tabindex="-1"></a>  </span>
<span id="cb15-119"><a href="#cb15-119" tabindex="-1"></a>  <span class="kw">var</span> testConfusionMatrix <span class="op">=</span> test<span class="op">.</span><span class="fu">errorMatrix</span>(<span class="st">&#39;landcover&#39;</span><span class="op">,</span> <span class="st">&#39;classification&#39;</span>)</span>
<span id="cb15-120"><a href="#cb15-120" tabindex="-1"></a>  <span class="co">// Printing of confusion matrix may time out. Alternatively, you can export it as CSV</span></span>
<span id="cb15-121"><a href="#cb15-121" tabindex="-1"></a>  <span class="fu">print</span>(<span class="st">&#39;Confusion Matrix &#39;</span> <span class="op">+</span> year<span class="op">,</span> testConfusionMatrix)<span class="op">;</span></span>
<span id="cb15-122"><a href="#cb15-122" tabindex="-1"></a>  <span class="fu">print</span>(<span class="st">&#39;Test Accuracy &#39;</span> <span class="op">+</span> year<span class="op">,</span> testConfusionMatrix<span class="op">.</span><span class="fu">accuracy</span>())<span class="op">;</span></span>
<span id="cb15-123"><a href="#cb15-123" tabindex="-1"></a></span>
<span id="cb15-124"><a href="#cb15-124" tabindex="-1"></a>}</span></code></pre></div>
</div>
<div id="time-series-modeling" class="section level2">
<h2>Time Series Modeling</h2>
<p><a
href="https://code.earthengine.google.co.in/?scriptPath=users%2Fujavalgandhi%2FEnd-to-End-GEE%3ASupplement%2FSupervised_Classification%2FTime_Series_Modeling"
target="_blank">Open in Code Editor ↗</a></p>
<div class="sourceCode" id="cb16"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb16-1"><a href="#cb16-1" tabindex="-1"></a><span class="co">// Example script showing how to fit a harmonic model </span></span>
<span id="cb16-2"><a href="#cb16-2" tabindex="-1"></a><span class="co">// to a NDVI time-series</span></span>
<span id="cb16-3"><a href="#cb16-3" tabindex="-1"></a><span class="co">// This is largely adapted from</span></span>
<span id="cb16-4"><a href="#cb16-4" tabindex="-1"></a><span class="co">// https://developers.google.com/earth-engine/tutorials/community/time-series-modeling</span></span>
<span id="cb16-5"><a href="#cb16-5" tabindex="-1"></a></span>
<span id="cb16-6"><a href="#cb16-6" tabindex="-1"></a><span class="kw">var</span> s2 <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&#39;COPERNICUS/S2_SR_HARMONIZED&#39;</span>)<span class="op">;</span></span>
<span id="cb16-7"><a href="#cb16-7" tabindex="-1"></a></span>
<span id="cb16-8"><a href="#cb16-8" tabindex="-1"></a><span class="co">// We define 2 polygons for adjacent farms</span></span>
<span id="cb16-9"><a href="#cb16-9" tabindex="-1"></a><span class="kw">var</span> farms <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>([</span>
<span id="cb16-10"><a href="#cb16-10" tabindex="-1"></a>  ee<span class="op">.</span><span class="fu">Feature</span>(</span>
<span id="cb16-11"><a href="#cb16-11" tabindex="-1"></a>    ee<span class="op">.</span><span class="at">Geometry</span><span class="op">.</span><span class="fu">Polygon</span>(</span>
<span id="cb16-12"><a href="#cb16-12" tabindex="-1"></a>      [[[<span class="fl">82.55407706060632</span><span class="op">,</span> <span class="fl">27.135887938359975</span>]<span class="op">,</span></span>
<span id="cb16-13"><a href="#cb16-13" tabindex="-1"></a>        [<span class="fl">82.55605116644128</span><span class="op">,</span> <span class="fl">27.135085913223808</span>]<span class="op">,</span></span>
<span id="cb16-14"><a href="#cb16-14" tabindex="-1"></a>        [<span class="fl">82.55613699712976</span><span class="op">,</span> <span class="fl">27.13527687211144</span>]<span class="op">,</span></span>
<span id="cb16-15"><a href="#cb16-15" tabindex="-1"></a>        [<span class="fl">82.55418434896691</span><span class="op">,</span> <span class="fl">27.136117087342033</span>]]])<span class="op">,</span></span>
<span id="cb16-16"><a href="#cb16-16" tabindex="-1"></a>      {<span class="st">&#39;system:index&#39;</span><span class="op">:</span> <span class="st">&#39;0&#39;</span>})<span class="op">,</span></span>
<span id="cb16-17"><a href="#cb16-17" tabindex="-1"></a>    ee<span class="op">.</span><span class="fu">Feature</span>(</span>
<span id="cb16-18"><a href="#cb16-18" tabindex="-1"></a>      ee<span class="op">.</span><span class="at">Geometry</span><span class="op">.</span><span class="fu">Polygon</span>(</span>
<span id="cb16-19"><a href="#cb16-19" tabindex="-1"></a>        [[[<span class="fl">82.54973858752477</span><span class="op">,</span> <span class="fl">27.137188234050676</span>]<span class="op">,</span></span>
<span id="cb16-20"><a href="#cb16-20" tabindex="-1"></a>          [<span class="fl">82.55046814837682</span><span class="op">,</span> <span class="fl">27.136806322479018</span>]<span class="op">,</span></span>
<span id="cb16-21"><a href="#cb16-21" tabindex="-1"></a>          [<span class="fl">82.55033940234411</span><span class="op">,</span> <span class="fl">27.136500792282273</span>]<span class="op">,</span></span>
<span id="cb16-22"><a href="#cb16-22" tabindex="-1"></a>          [<span class="fl">82.5508973018192</span><span class="op">,</span> <span class="fl">27.136328931179623</span>]<span class="op">,</span></span>
<span id="cb16-23"><a href="#cb16-23" tabindex="-1"></a>          [<span class="fl">82.55119770922887</span><span class="op">,</span> <span class="fl">27.13688270489774</span>]<span class="op">,</span></span>
<span id="cb16-24"><a href="#cb16-24" tabindex="-1"></a>          [<span class="fl">82.5498887912296</span><span class="op">,</span> <span class="fl">27.137455571374517</span>]]])<span class="op">,</span></span>
<span id="cb16-25"><a href="#cb16-25" tabindex="-1"></a>        {<span class="st">&#39;system:index&#39;</span><span class="op">:</span> <span class="st">&#39;1&#39;</span>})</span>
<span id="cb16-26"><a href="#cb16-26" tabindex="-1"></a>])<span class="op">;</span></span>
<span id="cb16-27"><a href="#cb16-27" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">centerObject</span>(farms)</span>
<span id="cb16-28"><a href="#cb16-28" tabindex="-1"></a></span>
<span id="cb16-29"><a href="#cb16-29" tabindex="-1"></a><span class="kw">var</span> geometry <span class="op">=</span> farms<span class="op">.</span><span class="fu">geometry</span>()<span class="op">;</span></span>
<span id="cb16-30"><a href="#cb16-30" tabindex="-1"></a><span class="co">//Map.addLayer(geometry, {color: &#39;grey&#39;}, &#39;Boundary&#39;);</span></span>
<span id="cb16-31"><a href="#cb16-31" tabindex="-1"></a><span class="co">//Map.centerObject(geometry);</span></span>
<span id="cb16-32"><a href="#cb16-32" tabindex="-1"></a></span>
<span id="cb16-33"><a href="#cb16-33" tabindex="-1"></a><span class="kw">var</span> filtered <span class="op">=</span> s2</span>
<span id="cb16-34"><a href="#cb16-34" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(<span class="st">&#39;2017-01-01&#39;</span><span class="op">,</span> <span class="st">&#39;2023-01-01&#39;</span>))</span>
<span id="cb16-35"><a href="#cb16-35" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">bounds</span>(geometry))<span class="op">;</span></span>
<span id="cb16-36"><a href="#cb16-36" tabindex="-1"></a></span>
<span id="cb16-37"><a href="#cb16-37" tabindex="-1"></a><span class="co">// Load the Cloud Score+ collection</span></span>
<span id="cb16-38"><a href="#cb16-38" tabindex="-1"></a><span class="kw">var</span> csPlus <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&#39;GOOGLE/CLOUD_SCORE_PLUS/V1/S2_HARMONIZED&#39;</span>)<span class="op">;</span></span>
<span id="cb16-39"><a href="#cb16-39" tabindex="-1"></a><span class="kw">var</span> csPlusBands <span class="op">=</span> csPlus<span class="op">.</span><span class="fu">first</span>()<span class="op">.</span><span class="fu">bandNames</span>()<span class="op">;</span></span>
<span id="cb16-40"><a href="#cb16-40" tabindex="-1"></a></span>
<span id="cb16-41"><a href="#cb16-41" tabindex="-1"></a><span class="co">// We need to add Cloud Score + bands to each Sentinel-2</span></span>
<span id="cb16-42"><a href="#cb16-42" tabindex="-1"></a><span class="co">// image in the collection</span></span>
<span id="cb16-43"><a href="#cb16-43" tabindex="-1"></a><span class="co">// This is done using the linkCollection() function</span></span>
<span id="cb16-44"><a href="#cb16-44" tabindex="-1"></a><span class="kw">var</span> filteredS2WithCs <span class="op">=</span> filtered<span class="op">.</span><span class="fu">linkCollection</span>(csPlus<span class="op">,</span> csPlusBands)<span class="op">;</span></span>
<span id="cb16-45"><a href="#cb16-45" tabindex="-1"></a></span>
<span id="cb16-46"><a href="#cb16-46" tabindex="-1"></a><span class="co">// Function to mask pixels with low CS+ QA scores.</span></span>
<span id="cb16-47"><a href="#cb16-47" tabindex="-1"></a><span class="kw">function</span> <span class="fu">maskLowQA</span>(image) {</span>
<span id="cb16-48"><a href="#cb16-48" tabindex="-1"></a>  <span class="kw">var</span> qaBand <span class="op">=</span> <span class="st">&#39;cs&#39;</span><span class="op">;</span></span>
<span id="cb16-49"><a href="#cb16-49" tabindex="-1"></a>  <span class="kw">var</span> clearThreshold <span class="op">=</span> <span class="fl">0.5</span><span class="op">;</span></span>
<span id="cb16-50"><a href="#cb16-50" tabindex="-1"></a>  <span class="kw">var</span> mask <span class="op">=</span> image<span class="op">.</span><span class="fu">select</span>(qaBand)<span class="op">.</span><span class="fu">gte</span>(clearThreshold)<span class="op">;</span></span>
<span id="cb16-51"><a href="#cb16-51" tabindex="-1"></a>  <span class="cf">return</span> image<span class="op">.</span><span class="fu">updateMask</span>(mask)<span class="op">;</span></span>
<span id="cb16-52"><a href="#cb16-52" tabindex="-1"></a>}</span>
<span id="cb16-53"><a href="#cb16-53" tabindex="-1"></a></span>
<span id="cb16-54"><a href="#cb16-54" tabindex="-1"></a><span class="kw">var</span> filteredMasked <span class="op">=</span> filteredS2WithCs</span>
<span id="cb16-55"><a href="#cb16-55" tabindex="-1"></a>  <span class="op">.</span><span class="fu">map</span>(maskLowQA)</span>
<span id="cb16-56"><a href="#cb16-56" tabindex="-1"></a>  <span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;B.*&#39;</span>)<span class="op">;</span></span>
<span id="cb16-57"><a href="#cb16-57" tabindex="-1"></a>  </span>
<span id="cb16-58"><a href="#cb16-58" tabindex="-1"></a></span>
<span id="cb16-59"><a href="#cb16-59" tabindex="-1"></a><span class="co">// Function to add NDVI, time, and constant variables</span></span>
<span id="cb16-60"><a href="#cb16-60" tabindex="-1"></a><span class="kw">var</span> addVariables <span class="op">=</span> <span class="kw">function</span>(image) {</span>
<span id="cb16-61"><a href="#cb16-61" tabindex="-1"></a>  <span class="co">// Compute time in fractional years since the epoch.</span></span>
<span id="cb16-62"><a href="#cb16-62" tabindex="-1"></a>  <span class="kw">var</span> date <span class="op">=</span> image<span class="op">.</span><span class="fu">date</span>()<span class="op">;</span></span>
<span id="cb16-63"><a href="#cb16-63" tabindex="-1"></a>  <span class="kw">var</span> years <span class="op">=</span> date<span class="op">.</span><span class="fu">difference</span>(ee<span class="op">.</span><span class="fu">Date</span>(<span class="st">&#39;1970-01-01&#39;</span>)<span class="op">,</span> <span class="st">&#39;year&#39;</span>)<span class="op">;</span></span>
<span id="cb16-64"><a href="#cb16-64" tabindex="-1"></a>  <span class="kw">var</span> timeRadians <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(years<span class="op">.</span><span class="fu">multiply</span>(<span class="dv">2</span> <span class="op">*</span> <span class="bu">Math</span><span class="op">.</span><span class="cn">PI</span>))<span class="op">;</span></span>
<span id="cb16-65"><a href="#cb16-65" tabindex="-1"></a></span>
<span id="cb16-66"><a href="#cb16-66" tabindex="-1"></a>  <span class="co">// Return the image with the added bands.</span></span>
<span id="cb16-67"><a href="#cb16-67" tabindex="-1"></a>  <span class="kw">var</span> ndvi <span class="op">=</span> image<span class="op">.</span><span class="fu">normalizedDifference</span>([<span class="st">&#39;B8&#39;</span><span class="op">,</span> <span class="st">&#39;B4&#39;</span>])<span class="op">.</span><span class="fu">rename</span>([<span class="st">&#39;ndvi&#39;</span>])<span class="op">;</span></span>
<span id="cb16-68"><a href="#cb16-68" tabindex="-1"></a>  <span class="kw">var</span> t <span class="op">=</span> timeRadians<span class="op">.</span><span class="fu">rename</span>(<span class="st">&#39;t&#39;</span>)<span class="op">.</span><span class="fu">float</span>()<span class="op">;</span></span>
<span id="cb16-69"><a href="#cb16-69" tabindex="-1"></a>  <span class="kw">var</span> constant <span class="op">=</span> ee<span class="op">.</span><span class="at">Image</span><span class="op">.</span><span class="fu">constant</span>(<span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb16-70"><a href="#cb16-70" tabindex="-1"></a>  <span class="cf">return</span> image<span class="op">.</span><span class="fu">addBands</span>([ndvi<span class="op">,</span> t<span class="op">,</span> constant])<span class="op">;</span></span>
<span id="cb16-71"><a href="#cb16-71" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb16-72"><a href="#cb16-72" tabindex="-1"></a></span>
<span id="cb16-73"><a href="#cb16-73" tabindex="-1"></a><span class="kw">var</span> filteredWithVariables <span class="op">=</span> filteredMasked<span class="op">.</span><span class="fu">map</span>(addVariables)<span class="op">;</span></span>
<span id="cb16-74"><a href="#cb16-74" tabindex="-1"></a><span class="fu">print</span>(filteredWithVariables<span class="op">.</span><span class="fu">first</span>())<span class="op">;</span></span>
<span id="cb16-75"><a href="#cb16-75" tabindex="-1"></a></span>
<span id="cb16-76"><a href="#cb16-76" tabindex="-1"></a><span class="co">// Plot a time series of NDVI at a single location.</span></span>
<span id="cb16-77"><a href="#cb16-77" tabindex="-1"></a><span class="kw">var</span> singleFarm <span class="op">=</span> ee<span class="op">.</span><span class="fu">Feature</span>(farms<span class="op">.</span><span class="fu">toList</span>(<span class="dv">2</span>)<span class="op">.</span><span class="fu">get</span>(<span class="dv">0</span>))<span class="op">;</span></span>
<span id="cb16-78"><a href="#cb16-78" tabindex="-1"></a></span>
<span id="cb16-79"><a href="#cb16-79" tabindex="-1"></a><span class="co">// Display a time-series chart</span></span>
<span id="cb16-80"><a href="#cb16-80" tabindex="-1"></a><span class="kw">var</span> chart <span class="op">=</span> ui<span class="op">.</span><span class="at">Chart</span><span class="op">.</span><span class="at">image</span><span class="op">.</span><span class="fu">series</span>({</span>
<span id="cb16-81"><a href="#cb16-81" tabindex="-1"></a>  <span class="dt">imageCollection</span><span class="op">:</span> filteredWithVariables<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;ndvi&#39;</span>)<span class="op">,</span></span>
<span id="cb16-82"><a href="#cb16-82" tabindex="-1"></a>  <span class="dt">region</span><span class="op">:</span> singleFarm<span class="op">.</span><span class="fu">geometry</span>()<span class="op">,</span></span>
<span id="cb16-83"><a href="#cb16-83" tabindex="-1"></a>  <span class="dt">reducer</span><span class="op">:</span> ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">mean</span>()<span class="op">,</span></span>
<span id="cb16-84"><a href="#cb16-84" tabindex="-1"></a>  <span class="dt">scale</span><span class="op">:</span> <span class="dv">10</span></span>
<span id="cb16-85"><a href="#cb16-85" tabindex="-1"></a>})<span class="op">.</span><span class="fu">setOptions</span>({</span>
<span id="cb16-86"><a href="#cb16-86" tabindex="-1"></a>      <span class="dt">title</span><span class="op">:</span> <span class="st">&#39;Original NDVI Time Series&#39;</span><span class="op">,</span></span>
<span id="cb16-87"><a href="#cb16-87" tabindex="-1"></a>      <span class="dt">interpolateNulls</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span></span>
<span id="cb16-88"><a href="#cb16-88" tabindex="-1"></a>      <span class="dt">vAxis</span><span class="op">:</span> {<span class="dt">title</span><span class="op">:</span> <span class="st">&#39;NDVI&#39;</span><span class="op">,</span> <span class="dt">viewWindow</span><span class="op">:</span> {<span class="dt">min</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span> <span class="dv">1</span>}}<span class="op">,</span></span>
<span id="cb16-89"><a href="#cb16-89" tabindex="-1"></a>      <span class="dt">hAxis</span><span class="op">:</span> {<span class="dt">title</span><span class="op">:</span> <span class="st">&#39;&#39;</span><span class="op">,</span> <span class="dt">format</span><span class="op">:</span> <span class="st">&#39;YYYY-MM&#39;</span>}<span class="op">,</span></span>
<span id="cb16-90"><a href="#cb16-90" tabindex="-1"></a>      <span class="dt">lineWidth</span><span class="op">:</span> <span class="dv">1</span><span class="op">,</span></span>
<span id="cb16-91"><a href="#cb16-91" tabindex="-1"></a>      <span class="dt">pointSize</span><span class="op">:</span> <span class="dv">2</span><span class="op">,</span></span>
<span id="cb16-92"><a href="#cb16-92" tabindex="-1"></a>      <span class="dt">series</span><span class="op">:</span> {</span>
<span id="cb16-93"><a href="#cb16-93" tabindex="-1"></a>        <span class="dv">0</span><span class="op">:</span> {<span class="dt">color</span><span class="op">:</span> <span class="st">&#39;#238b45&#39;</span>}<span class="op">,</span></span>
<span id="cb16-94"><a href="#cb16-94" tabindex="-1"></a>      }<span class="op">,</span></span>
<span id="cb16-95"><a href="#cb16-95" tabindex="-1"></a>    })</span>
<span id="cb16-96"><a href="#cb16-96" tabindex="-1"></a><span class="fu">print</span>(chart)<span class="op">;</span></span>
<span id="cb16-97"><a href="#cb16-97" tabindex="-1"></a></span>
<span id="cb16-98"><a href="#cb16-98" tabindex="-1"></a></span>
<span id="cb16-99"><a href="#cb16-99" tabindex="-1"></a></span>
<span id="cb16-100"><a href="#cb16-100" tabindex="-1"></a><span class="co">// The number of cycles per year to model.</span></span>
<span id="cb16-101"><a href="#cb16-101" tabindex="-1"></a><span class="kw">var</span> harmonics <span class="op">=</span> <span class="dv">2</span><span class="op">;</span></span>
<span id="cb16-102"><a href="#cb16-102" tabindex="-1"></a></span>
<span id="cb16-103"><a href="#cb16-103" tabindex="-1"></a><span class="co">// Make a list of harmonic frequencies to model.  </span></span>
<span id="cb16-104"><a href="#cb16-104" tabindex="-1"></a><span class="co">// These also serve as band name suffixes.</span></span>
<span id="cb16-105"><a href="#cb16-105" tabindex="-1"></a><span class="kw">var</span> harmonicFrequencies <span class="op">=</span> ee<span class="op">.</span><span class="at">List</span><span class="op">.</span><span class="fu">sequence</span>(<span class="dv">1</span><span class="op">,</span> harmonics)<span class="op">;</span></span>
<span id="cb16-106"><a href="#cb16-106" tabindex="-1"></a></span>
<span id="cb16-107"><a href="#cb16-107" tabindex="-1"></a><span class="co">// Function to get a sequence of band names for harmonic terms.</span></span>
<span id="cb16-108"><a href="#cb16-108" tabindex="-1"></a><span class="kw">var</span> getNames <span class="op">=</span> <span class="kw">function</span>(base<span class="op">,</span> list) {</span>
<span id="cb16-109"><a href="#cb16-109" tabindex="-1"></a>  <span class="cf">return</span> ee<span class="op">.</span><span class="fu">List</span>(list)<span class="op">.</span><span class="fu">map</span>(<span class="kw">function</span>(i) { </span>
<span id="cb16-110"><a href="#cb16-110" tabindex="-1"></a>    <span class="cf">return</span> ee<span class="op">.</span><span class="fu">String</span>(base)<span class="op">.</span><span class="fu">cat</span>(ee<span class="op">.</span><span class="fu">Number</span>(i)<span class="op">.</span><span class="fu">int</span>())<span class="op">;</span></span>
<span id="cb16-111"><a href="#cb16-111" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb16-112"><a href="#cb16-112" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb16-113"><a href="#cb16-113" tabindex="-1"></a></span>
<span id="cb16-114"><a href="#cb16-114" tabindex="-1"></a><span class="co">// Construct lists of names for the harmonic terms.</span></span>
<span id="cb16-115"><a href="#cb16-115" tabindex="-1"></a><span class="kw">var</span> cosNames <span class="op">=</span> <span class="fu">getNames</span>(<span class="st">&#39;cos_&#39;</span><span class="op">,</span> harmonicFrequencies)<span class="op">;</span></span>
<span id="cb16-116"><a href="#cb16-116" tabindex="-1"></a><span class="kw">var</span> sinNames <span class="op">=</span> <span class="fu">getNames</span>(<span class="st">&#39;sin_&#39;</span><span class="op">,</span> harmonicFrequencies)<span class="op">;</span></span>
<span id="cb16-117"><a href="#cb16-117" tabindex="-1"></a></span>
<span id="cb16-118"><a href="#cb16-118" tabindex="-1"></a></span>
<span id="cb16-119"><a href="#cb16-119" tabindex="-1"></a></span>
<span id="cb16-120"><a href="#cb16-120" tabindex="-1"></a><span class="co">// The dependent variable we are modeling.</span></span>
<span id="cb16-121"><a href="#cb16-121" tabindex="-1"></a><span class="kw">var</span> dependent <span class="op">=</span> <span class="st">&#39;ndvi&#39;</span><span class="op">;</span></span>
<span id="cb16-122"><a href="#cb16-122" tabindex="-1"></a></span>
<span id="cb16-123"><a href="#cb16-123" tabindex="-1"></a><span class="co">// Independent variables.</span></span>
<span id="cb16-124"><a href="#cb16-124" tabindex="-1"></a><span class="kw">var</span> independents <span class="op">=</span> ee<span class="op">.</span><span class="fu">List</span>([<span class="st">&#39;constant&#39;</span><span class="op">,</span> <span class="st">&#39;t&#39;</span>])<span class="op">.</span><span class="fu">cat</span>(cosNames)<span class="op">.</span><span class="fu">cat</span>(sinNames)<span class="op">;</span></span>
<span id="cb16-125"><a href="#cb16-125" tabindex="-1"></a></span>
<span id="cb16-126"><a href="#cb16-126" tabindex="-1"></a></span>
<span id="cb16-127"><a href="#cb16-127" tabindex="-1"></a><span class="co">// Function to compute the specified number of harmonics</span></span>
<span id="cb16-128"><a href="#cb16-128" tabindex="-1"></a><span class="co">// and add them as bands. Assumes the time band is present.</span></span>
<span id="cb16-129"><a href="#cb16-129" tabindex="-1"></a><span class="kw">var</span> addHarmonics <span class="op">=</span> <span class="kw">function</span>(freqs) {</span>
<span id="cb16-130"><a href="#cb16-130" tabindex="-1"></a>  <span class="cf">return</span> <span class="kw">function</span>(image) {</span>
<span id="cb16-131"><a href="#cb16-131" tabindex="-1"></a>    <span class="co">// Make an image of frequencies.</span></span>
<span id="cb16-132"><a href="#cb16-132" tabindex="-1"></a>    <span class="kw">var</span> frequencies <span class="op">=</span> ee<span class="op">.</span><span class="at">Image</span><span class="op">.</span><span class="fu">constant</span>(freqs)<span class="op">;</span></span>
<span id="cb16-133"><a href="#cb16-133" tabindex="-1"></a>    <span class="co">// This band should represent time in radians.</span></span>
<span id="cb16-134"><a href="#cb16-134" tabindex="-1"></a>    <span class="kw">var</span> time <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(image)<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;t&#39;</span>)<span class="op">;</span></span>
<span id="cb16-135"><a href="#cb16-135" tabindex="-1"></a>    <span class="co">// Get the cosine terms.</span></span>
<span id="cb16-136"><a href="#cb16-136" tabindex="-1"></a>    <span class="kw">var</span> cosines <span class="op">=</span> time<span class="op">.</span><span class="fu">multiply</span>(frequencies)<span class="op">.</span><span class="fu">cos</span>()<span class="op">.</span><span class="fu">rename</span>(cosNames)<span class="op">;</span></span>
<span id="cb16-137"><a href="#cb16-137" tabindex="-1"></a>    <span class="co">// Get the sin terms.</span></span>
<span id="cb16-138"><a href="#cb16-138" tabindex="-1"></a>    <span class="kw">var</span> sines <span class="op">=</span> time<span class="op">.</span><span class="fu">multiply</span>(frequencies)<span class="op">.</span><span class="fu">sin</span>()<span class="op">.</span><span class="fu">rename</span>(sinNames)<span class="op">;</span></span>
<span id="cb16-139"><a href="#cb16-139" tabindex="-1"></a>    <span class="cf">return</span> image<span class="op">.</span><span class="fu">addBands</span>(cosines)<span class="op">.</span><span class="fu">addBands</span>(sines)<span class="op">;</span></span>
<span id="cb16-140"><a href="#cb16-140" tabindex="-1"></a>  }<span class="op">;</span></span>
<span id="cb16-141"><a href="#cb16-141" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb16-142"><a href="#cb16-142" tabindex="-1"></a></span>
<span id="cb16-143"><a href="#cb16-143" tabindex="-1"></a><span class="kw">var</span> filteredHarmonic <span class="op">=</span> filteredWithVariables<span class="op">.</span><span class="fu">map</span>(<span class="fu">addHarmonics</span>(harmonicFrequencies))<span class="op">;</span></span>
<span id="cb16-144"><a href="#cb16-144" tabindex="-1"></a></span>
<span id="cb16-145"><a href="#cb16-145" tabindex="-1"></a><span class="co">// The output of the regression reduction is a 4x1 array image.</span></span>
<span id="cb16-146"><a href="#cb16-146" tabindex="-1"></a><span class="kw">var</span> harmonicTrend <span class="op">=</span> filteredHarmonic</span>
<span id="cb16-147"><a href="#cb16-147" tabindex="-1"></a>  <span class="op">.</span><span class="fu">select</span>(independents<span class="op">.</span><span class="fu">add</span>(dependent))</span>
<span id="cb16-148"><a href="#cb16-148" tabindex="-1"></a>  <span class="op">.</span><span class="fu">reduce</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">linearRegression</span>(independents<span class="op">.</span><span class="fu">length</span>()<span class="op">,</span> <span class="dv">1</span>))<span class="op">;</span></span>
<span id="cb16-149"><a href="#cb16-149" tabindex="-1"></a></span>
<span id="cb16-150"><a href="#cb16-150" tabindex="-1"></a><span class="co">// Turn the array image into a multi-band image of coefficients.</span></span>
<span id="cb16-151"><a href="#cb16-151" tabindex="-1"></a><span class="kw">var</span> harmonicTrendCoefficients <span class="op">=</span> harmonicTrend<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;coefficients&#39;</span>)</span>
<span id="cb16-152"><a href="#cb16-152" tabindex="-1"></a>  <span class="op">.</span><span class="fu">arrayProject</span>([<span class="dv">0</span>])</span>
<span id="cb16-153"><a href="#cb16-153" tabindex="-1"></a>  <span class="op">.</span><span class="fu">arrayFlatten</span>([independents])<span class="op">;</span></span>
<span id="cb16-154"><a href="#cb16-154" tabindex="-1"></a></span>
<span id="cb16-155"><a href="#cb16-155" tabindex="-1"></a><span class="co">// Compute fitted values.</span></span>
<span id="cb16-156"><a href="#cb16-156" tabindex="-1"></a><span class="kw">var</span> fittedHarmonic <span class="op">=</span> filteredHarmonic<span class="op">.</span><span class="fu">map</span>(<span class="kw">function</span>(image) {</span>
<span id="cb16-157"><a href="#cb16-157" tabindex="-1"></a>  <span class="cf">return</span> image<span class="op">.</span><span class="fu">addBands</span>(</span>
<span id="cb16-158"><a href="#cb16-158" tabindex="-1"></a>    image<span class="op">.</span><span class="fu">select</span>(independents)</span>
<span id="cb16-159"><a href="#cb16-159" tabindex="-1"></a>      <span class="op">.</span><span class="fu">multiply</span>(harmonicTrendCoefficients)</span>
<span id="cb16-160"><a href="#cb16-160" tabindex="-1"></a>      <span class="op">.</span><span class="fu">reduce</span>(<span class="st">&#39;sum&#39;</span>)</span>
<span id="cb16-161"><a href="#cb16-161" tabindex="-1"></a>      <span class="op">.</span><span class="fu">rename</span>(<span class="st">&#39;fitted&#39;</span>))<span class="op">;</span></span>
<span id="cb16-162"><a href="#cb16-162" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb16-163"><a href="#cb16-163" tabindex="-1"></a></span>
<span id="cb16-164"><a href="#cb16-164" tabindex="-1"></a><span class="co">// Plot the fitted model and the original data at the ROI.</span></span>
<span id="cb16-165"><a href="#cb16-165" tabindex="-1"></a></span>
<span id="cb16-166"><a href="#cb16-166" tabindex="-1"></a><span class="kw">var</span> chart <span class="op">=</span> ui<span class="op">.</span><span class="at">Chart</span><span class="op">.</span><span class="at">image</span><span class="op">.</span><span class="fu">series</span>({</span>
<span id="cb16-167"><a href="#cb16-167" tabindex="-1"></a>  <span class="dt">imageCollection</span><span class="op">:</span> fittedHarmonic<span class="op">.</span><span class="fu">select</span>([<span class="st">&#39;fitted&#39;</span><span class="op">,</span> <span class="st">&#39;ndvi&#39;</span>])<span class="op">,</span></span>
<span id="cb16-168"><a href="#cb16-168" tabindex="-1"></a>  <span class="dt">region</span><span class="op">:</span> singleFarm<span class="op">.</span><span class="fu">geometry</span>()<span class="op">,</span></span>
<span id="cb16-169"><a href="#cb16-169" tabindex="-1"></a>  <span class="dt">reducer</span><span class="op">:</span> ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">mean</span>()<span class="op">,</span></span>
<span id="cb16-170"><a href="#cb16-170" tabindex="-1"></a>  <span class="dt">scale</span><span class="op">:</span> <span class="dv">10</span></span>
<span id="cb16-171"><a href="#cb16-171" tabindex="-1"></a>})<span class="op">.</span><span class="fu">setOptions</span>({</span>
<span id="cb16-172"><a href="#cb16-172" tabindex="-1"></a>      <span class="dt">title</span><span class="op">:</span> <span class="st">&#39;NDVI Time Series&#39;</span><span class="op">,</span></span>
<span id="cb16-173"><a href="#cb16-173" tabindex="-1"></a>      <span class="dt">vAxis</span><span class="op">:</span> {<span class="dt">title</span><span class="op">:</span> <span class="st">&#39;NDVI&#39;</span><span class="op">,</span> <span class="dt">viewWindow</span><span class="op">:</span> {<span class="dt">min</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span> <span class="dv">1</span>}}<span class="op">,</span></span>
<span id="cb16-174"><a href="#cb16-174" tabindex="-1"></a>      <span class="dt">hAxis</span><span class="op">:</span> {<span class="dt">title</span><span class="op">:</span> <span class="st">&#39;&#39;</span><span class="op">,</span> <span class="dt">format</span><span class="op">:</span> <span class="st">&#39;YYYY-MM&#39;</span>}<span class="op">,</span></span>
<span id="cb16-175"><a href="#cb16-175" tabindex="-1"></a>      <span class="dt">lineWidth</span><span class="op">:</span> <span class="dv">1</span><span class="op">,</span></span>
<span id="cb16-176"><a href="#cb16-176" tabindex="-1"></a>      <span class="dt">series</span><span class="op">:</span> {</span>
<span id="cb16-177"><a href="#cb16-177" tabindex="-1"></a>        <span class="dv">1</span><span class="op">:</span> {<span class="dt">color</span><span class="op">:</span> <span class="st">&#39;#66c2a4&#39;</span><span class="op">,</span> <span class="dt">lineDashStyle</span><span class="op">:</span> [<span class="dv">1</span><span class="op">,</span> <span class="dv">1</span>]<span class="op">,</span> <span class="dt">pointSize</span><span class="op">:</span> <span class="dv">1</span>}<span class="op">,</span> <span class="co">// Original NDVI</span></span>
<span id="cb16-178"><a href="#cb16-178" tabindex="-1"></a>        <span class="dv">0</span><span class="op">:</span> {<span class="dt">color</span><span class="op">:</span> <span class="st">&#39;#238b45&#39;</span><span class="op">,</span> <span class="dt">lineWidth</span><span class="op">:</span> <span class="dv">2</span><span class="op">,</span> <span class="dt">pointSize</span><span class="op">:</span> <span class="dv">1</span> }<span class="op">,</span> <span class="co">// Fitted NDVI</span></span>
<span id="cb16-179"><a href="#cb16-179" tabindex="-1"></a>      }<span class="op">,</span></span>
<span id="cb16-180"><a href="#cb16-180" tabindex="-1"></a>    })</span>
<span id="cb16-181"><a href="#cb16-181" tabindex="-1"></a><span class="fu">print</span>(chart)<span class="op">;</span></span>
<span id="cb16-182"><a href="#cb16-182" tabindex="-1"></a></span>
<span id="cb16-183"><a href="#cb16-183" tabindex="-1"></a><span class="fu">print</span>(fittedHarmonic)<span class="op">;</span></span>
<span id="cb16-184"><a href="#cb16-184" tabindex="-1"></a><span class="co">// Compute phase and amplitude.</span></span>
<span id="cb16-185"><a href="#cb16-185" tabindex="-1"></a><span class="kw">var</span> phase <span class="op">=</span> harmonicTrendCoefficients<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;sin_1&#39;</span>)</span>
<span id="cb16-186"><a href="#cb16-186" tabindex="-1"></a>  <span class="op">.</span><span class="fu">atan2</span>(harmonicTrendCoefficients<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;cos_1&#39;</span>))</span>
<span id="cb16-187"><a href="#cb16-187" tabindex="-1"></a>  <span class="co">// Scale to [0, 1] from radians.</span></span>
<span id="cb16-188"><a href="#cb16-188" tabindex="-1"></a>  <span class="op">.</span><span class="fu">unitScale</span>(<span class="op">-</span><span class="bu">Math</span><span class="op">.</span><span class="cn">PI</span><span class="op">,</span> <span class="bu">Math</span><span class="op">.</span><span class="cn">PI</span>)<span class="op">;</span></span>
<span id="cb16-189"><a href="#cb16-189" tabindex="-1"></a><span class="kw">var</span> amplitude <span class="op">=</span> harmonicTrendCoefficients<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;sin_1&#39;</span>)</span>
<span id="cb16-190"><a href="#cb16-190" tabindex="-1"></a>  <span class="op">.</span><span class="fu">hypot</span>(harmonicTrendCoefficients<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;cos_1&#39;</span>))</span>
<span id="cb16-191"><a href="#cb16-191" tabindex="-1"></a>  <span class="co">// Add a scale factor for visualization.</span></span>
<span id="cb16-192"><a href="#cb16-192" tabindex="-1"></a>  <span class="op">.</span><span class="fu">multiply</span>(<span class="dv">5</span>)<span class="op">;</span></span>
<span id="cb16-193"><a href="#cb16-193" tabindex="-1"></a>  </span>
<span id="cb16-194"><a href="#cb16-194" tabindex="-1"></a><span class="kw">var</span> constant <span class="op">=</span> harmonicTrendCoefficients<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;constant&#39;</span>)<span class="op">;</span></span>
<span id="cb16-195"><a href="#cb16-195" tabindex="-1"></a></span>
<span id="cb16-196"><a href="#cb16-196" tabindex="-1"></a><span class="co">// Add the phase, amplitude and constant bands to your composite</span></span>
<span id="cb16-197"><a href="#cb16-197" tabindex="-1"></a><span class="co">// which captures the phenology at each pixel.</span></span>
<span id="cb16-198"><a href="#cb16-198" tabindex="-1"></a></span>
<span id="cb16-199"><a href="#cb16-199" tabindex="-1"></a><span class="co">// Use the HSV to RGB transformation to display phase and amplitude.</span></span>
<span id="cb16-200"><a href="#cb16-200" tabindex="-1"></a><span class="kw">var</span> rgb <span class="op">=</span> ee<span class="op">.</span><span class="at">Image</span><span class="op">.</span><span class="fu">cat</span>([phase<span class="op">,</span> amplitude<span class="op">,</span> <span class="dv">1</span>])<span class="op">.</span><span class="fu">hsvToRgb</span>()<span class="op">;</span></span>
<span id="cb16-201"><a href="#cb16-201" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(rgb<span class="op">,</span> {}<span class="op">,</span> <span class="st">&#39;Phase (hue), Amplitude (sat)&#39;</span><span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span></span>
<span id="cb16-202"><a href="#cb16-202" tabindex="-1"></a></span>
<span id="cb16-203"><a href="#cb16-203" tabindex="-1"></a><span class="co">// The Phase and Amplitude values will be very different</span></span>
<span id="cb16-204"><a href="#cb16-204" tabindex="-1"></a><span class="co">// at farms following different cropping cycles</span></span>
<span id="cb16-205"><a href="#cb16-205" tabindex="-1"></a><span class="co">// Let&#39;s plot and compare the fitted time series</span></span>
<span id="cb16-206"><a href="#cb16-206" tabindex="-1"></a><span class="co">// Farm 1: Single cropping</span></span>
<span id="cb16-207"><a href="#cb16-207" tabindex="-1"></a><span class="co">// Farm 2: Multiple cropping</span></span>
<span id="cb16-208"><a href="#cb16-208" tabindex="-1"></a><span class="kw">var</span> chart <span class="op">=</span> ui<span class="op">.</span><span class="at">Chart</span><span class="op">.</span><span class="at">image</span><span class="op">.</span><span class="fu">seriesByRegion</span>({</span>
<span id="cb16-209"><a href="#cb16-209" tabindex="-1"></a>  <span class="dt">imageCollection</span><span class="op">:</span> fittedHarmonic<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;fitted&#39;</span>)<span class="op">,</span></span>
<span id="cb16-210"><a href="#cb16-210" tabindex="-1"></a>  <span class="dt">regions</span><span class="op">:</span> farms<span class="op">,</span></span>
<span id="cb16-211"><a href="#cb16-211" tabindex="-1"></a>  <span class="dt">reducer</span><span class="op">:</span> ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">mean</span>()<span class="op">,</span></span>
<span id="cb16-212"><a href="#cb16-212" tabindex="-1"></a>  <span class="dt">scale</span><span class="op">:</span> <span class="dv">10</span></span>
<span id="cb16-213"><a href="#cb16-213" tabindex="-1"></a>})<span class="op">.</span><span class="fu">setSeriesNames</span>([<span class="st">&#39;farm1&#39;</span><span class="op">,</span> <span class="st">&#39;farm2&#39;</span>])<span class="op">.</span><span class="fu">setOptions</span>({</span>
<span id="cb16-214"><a href="#cb16-214" tabindex="-1"></a>      <span class="dt">lineWidth</span><span class="op">:</span> <span class="dv">1</span><span class="op">,</span></span>
<span id="cb16-215"><a href="#cb16-215" tabindex="-1"></a>      <span class="dt">title</span><span class="op">:</span> <span class="st">&#39;Fitted NDVI Time Series at 2 Different Farms&#39;</span><span class="op">,</span></span>
<span id="cb16-216"><a href="#cb16-216" tabindex="-1"></a>      <span class="dt">interpolateNulls</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb16-217"><a href="#cb16-217" tabindex="-1"></a>      <span class="dt">vAxis</span><span class="op">:</span> {<span class="dt">title</span><span class="op">:</span> <span class="st">&#39;NDVI&#39;</span>}<span class="op">,</span></span>
<span id="cb16-218"><a href="#cb16-218" tabindex="-1"></a>      <span class="dt">hAxis</span><span class="op">:</span> {<span class="dt">title</span><span class="op">:</span> <span class="st">&#39;&#39;</span><span class="op">,</span> <span class="dt">format</span><span class="op">:</span> <span class="st">&#39;YYYY-MMM&#39;</span>}<span class="op">,</span></span>
<span id="cb16-219"><a href="#cb16-219" tabindex="-1"></a>    })</span>
<span id="cb16-220"><a href="#cb16-220" tabindex="-1"></a><span class="fu">print</span>(chart)<span class="op">;</span></span></code></pre></div>
</div>
<div id="using-sar-data" class="section level2">
<h2>Using SAR data</h2>
<p><a
href="https://code.earthengine.google.co.in/?scriptPath=users%2Fujavalgandhi%2FEnd-to-End-GEE%3ASupplement%2FSupervised_Classification%2FUsing_SAR_data"
target="_blank">Open in Code Editor ↗</a></p>
<div class="sourceCode" id="cb17"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb17-1"><a href="#cb17-1" tabindex="-1"></a><span class="co">// Script showing how to stack Sentinel-2 and Sentinel-1 bands</span></span>
<span id="cb17-2"><a href="#cb17-2" tabindex="-1"></a><span class="co">// for supervised classification</span></span>
<span id="cb17-3"><a href="#cb17-3" tabindex="-1"></a></span>
<span id="cb17-4"><a href="#cb17-4" tabindex="-1"></a><span class="kw">var</span> basin <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">&quot;WWF/HydroSHEDS/v1/Basins/hybas_7&quot;</span>)</span>
<span id="cb17-5"><a href="#cb17-5" tabindex="-1"></a><span class="kw">var</span> arkavathy <span class="op">=</span> basin<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;HYBAS_ID&#39;</span><span class="op">,</span> <span class="dv">4071139640</span>))</span>
<span id="cb17-6"><a href="#cb17-6" tabindex="-1"></a><span class="kw">var</span> geometry <span class="op">=</span> arkavathy<span class="op">.</span><span class="fu">geometry</span>()<span class="op">;</span></span>
<span id="cb17-7"><a href="#cb17-7" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">centerObject</span>(geometry)<span class="op">;</span></span>
<span id="cb17-8"><a href="#cb17-8" tabindex="-1"></a><span class="kw">var</span> s2 <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&#39;COPERNICUS/S2_SR_HARMONIZED&#39;</span>)</span>
<span id="cb17-9"><a href="#cb17-9" tabindex="-1"></a><span class="kw">var</span> rgbVis <span class="op">=</span> {</span>
<span id="cb17-10"><a href="#cb17-10" tabindex="-1"></a>  <span class="dt">min</span><span class="op">:</span> <span class="fl">0.0</span><span class="op">,</span></span>
<span id="cb17-11"><a href="#cb17-11" tabindex="-1"></a>  <span class="dt">max</span><span class="op">:</span> <span class="dv">3000</span><span class="op">,</span></span>
<span id="cb17-12"><a href="#cb17-12" tabindex="-1"></a>  <span class="dt">bands</span><span class="op">:</span> [<span class="st">&#39;B4&#39;</span><span class="op">,</span> <span class="st">&#39;B3&#39;</span><span class="op">,</span> <span class="st">&#39;B2&#39;</span>]<span class="op">,</span></span>
<span id="cb17-13"><a href="#cb17-13" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb17-14"><a href="#cb17-14" tabindex="-1"></a><span class="co">// Function to remove cloud and snow pixels from Sentinel-2 SR image </span></span>
<span id="cb17-15"><a href="#cb17-15" tabindex="-1"></a><span class="kw">function</span> <span class="fu">maskCloudAndShadowsSR</span>(image) {</span>
<span id="cb17-16"><a href="#cb17-16" tabindex="-1"></a>  <span class="kw">var</span> cloudProb <span class="op">=</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;MSK_CLDPRB&#39;</span>)<span class="op">;</span></span>
<span id="cb17-17"><a href="#cb17-17" tabindex="-1"></a>  <span class="kw">var</span> snowProb <span class="op">=</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;MSK_SNWPRB&#39;</span>)<span class="op">;</span></span>
<span id="cb17-18"><a href="#cb17-18" tabindex="-1"></a>  <span class="kw">var</span> cloud <span class="op">=</span> cloudProb<span class="op">.</span><span class="fu">lt</span>(<span class="dv">10</span>)<span class="op">;</span></span>
<span id="cb17-19"><a href="#cb17-19" tabindex="-1"></a>  <span class="kw">var</span> scl <span class="op">=</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;SCL&#39;</span>)<span class="op">;</span> </span>
<span id="cb17-20"><a href="#cb17-20" tabindex="-1"></a>  <span class="kw">var</span> shadow <span class="op">=</span> scl<span class="op">.</span><span class="fu">eq</span>(<span class="dv">3</span>)<span class="op">;</span> <span class="co">// 3 = cloud shadow</span></span>
<span id="cb17-21"><a href="#cb17-21" tabindex="-1"></a>  <span class="kw">var</span> cirrus <span class="op">=</span> scl<span class="op">.</span><span class="fu">eq</span>(<span class="dv">10</span>)<span class="op">;</span> <span class="co">// 10 = cirrus</span></span>
<span id="cb17-22"><a href="#cb17-22" tabindex="-1"></a>  <span class="co">// Cloud probability less than 10% or cloud shadow classification</span></span>
<span id="cb17-23"><a href="#cb17-23" tabindex="-1"></a>  <span class="kw">var</span> mask <span class="op">=</span> cloud<span class="op">.</span><span class="fu">and</span>(cirrus<span class="op">.</span><span class="fu">neq</span>(<span class="dv">1</span>))<span class="op">.</span><span class="fu">and</span>(shadow<span class="op">.</span><span class="fu">neq</span>(<span class="dv">1</span>))<span class="op">;</span></span>
<span id="cb17-24"><a href="#cb17-24" tabindex="-1"></a>  <span class="cf">return</span> image<span class="op">.</span><span class="fu">updateMask</span>(mask)<span class="op">.</span><span class="fu">divide</span>(<span class="dv">10000</span>)<span class="op">;</span></span>
<span id="cb17-25"><a href="#cb17-25" tabindex="-1"></a>}</span>
<span id="cb17-26"><a href="#cb17-26" tabindex="-1"></a></span>
<span id="cb17-27"><a href="#cb17-27" tabindex="-1"></a></span>
<span id="cb17-28"><a href="#cb17-28" tabindex="-1"></a><span class="kw">var</span> filtered <span class="op">=</span> s2</span>
<span id="cb17-29"><a href="#cb17-29" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(<span class="st">&#39;2019-01-01&#39;</span><span class="op">,</span> <span class="st">&#39;2020-01-01&#39;</span>))</span>
<span id="cb17-30"><a href="#cb17-30" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">bounds</span>(geometry))</span>
<span id="cb17-31"><a href="#cb17-31" tabindex="-1"></a>  <span class="op">.</span><span class="fu">map</span>(maskCloudAndShadowsSR)</span>
<span id="cb17-32"><a href="#cb17-32" tabindex="-1"></a>  <span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;B.*&#39;</span>)</span>
<span id="cb17-33"><a href="#cb17-33" tabindex="-1"></a>  </span>
<span id="cb17-34"><a href="#cb17-34" tabindex="-1"></a><span class="kw">var</span> composite <span class="op">=</span> filtered<span class="op">.</span><span class="fu">median</span>()<span class="op">.</span><span class="fu">clip</span>(geometry)</span>
<span id="cb17-35"><a href="#cb17-35" tabindex="-1"></a></span>
<span id="cb17-36"><a href="#cb17-36" tabindex="-1"></a><span class="kw">var</span> s1 <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&quot;COPERNICUS/S1_GRD&quot;</span>)</span>
<span id="cb17-37"><a href="#cb17-37" tabindex="-1"></a><span class="kw">var</span> filtered <span class="op">=</span> s1</span>
<span id="cb17-38"><a href="#cb17-38" tabindex="-1"></a>  <span class="co">// Filter to get images with VV and VH dual polarization.</span></span>
<span id="cb17-39"><a href="#cb17-39" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">listContains</span>(<span class="st">&#39;transmitterReceiverPolarisation&#39;</span><span class="op">,</span> <span class="st">&#39;VV&#39;</span>))</span>
<span id="cb17-40"><a href="#cb17-40" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">listContains</span>(<span class="st">&#39;transmitterReceiverPolarisation&#39;</span><span class="op">,</span> <span class="st">&#39;VH&#39;</span>))</span>
<span id="cb17-41"><a href="#cb17-41" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;instrumentMode&#39;</span><span class="op">,</span> <span class="st">&#39;IW&#39;</span>))</span>
<span id="cb17-42"><a href="#cb17-42" tabindex="-1"></a>  <span class="co">// Change the pass to ASCENDING depending on your location</span></span>
<span id="cb17-43"><a href="#cb17-43" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;orbitProperties_pass&#39;</span><span class="op">,</span> <span class="st">&#39;DESCENDING&#39;</span>))</span>
<span id="cb17-44"><a href="#cb17-44" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filterDate</span>(<span class="st">&#39;2019-01-01&#39;</span><span class="op">,</span> <span class="st">&#39;2020-01-01&#39;</span>)</span>
<span id="cb17-45"><a href="#cb17-45" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filterBounds</span>(geometry)</span>
<span id="cb17-46"><a href="#cb17-46" tabindex="-1"></a>  <span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;V.&#39;</span>)</span>
<span id="cb17-47"><a href="#cb17-47" tabindex="-1"></a></span>
<span id="cb17-48"><a href="#cb17-48" tabindex="-1"></a><span class="co">// Apply Speckle Filter</span></span>
<span id="cb17-49"><a href="#cb17-49" tabindex="-1"></a><span class="kw">var</span> speckleFiltered <span class="op">=</span> filtered<span class="op">.</span><span class="fu">map</span>(refinedLee)<span class="op">;</span></span>
<span id="cb17-50"><a href="#cb17-50" tabindex="-1"></a></span>
<span id="cb17-51"><a href="#cb17-51" tabindex="-1"></a><span class="co">// Mean is preferred for SAR data</span></span>
<span id="cb17-52"><a href="#cb17-52" tabindex="-1"></a><span class="kw">var</span> sarComposite <span class="op">=</span> speckleFiltered<span class="op">.</span><span class="fu">mean</span>()</span>
<span id="cb17-53"><a href="#cb17-53" tabindex="-1"></a><span class="kw">var</span> composite <span class="op">=</span> composite<span class="op">.</span><span class="fu">addBands</span>(sarComposite)</span>
<span id="cb17-54"><a href="#cb17-54" tabindex="-1"></a></span>
<span id="cb17-55"><a href="#cb17-55" tabindex="-1"></a></span>
<span id="cb17-56"><a href="#cb17-56" tabindex="-1"></a><span class="co">// Use this composite for supervised classification</span></span>
<span id="cb17-57"><a href="#cb17-57" tabindex="-1"></a><span class="fu">print</span>(composite)<span class="op">;</span></span>
<span id="cb17-58"><a href="#cb17-58" tabindex="-1"></a></span>
<span id="cb17-59"><a href="#cb17-59" tabindex="-1"></a></span>
<span id="cb17-60"><a href="#cb17-60" tabindex="-1"></a><span class="co">// Speckle Filtering functions</span></span>
<span id="cb17-61"><a href="#cb17-61" tabindex="-1"></a><span class="co">// Credit: SERVIR-Mekong, adapted from</span></span>
<span id="cb17-62"><a href="#cb17-62" tabindex="-1"></a><span class="co">// https://mygeoblog.com/2021/01/21/sentinel-1-speckle-filter-refined-lee/</span></span>
<span id="cb17-63"><a href="#cb17-63" tabindex="-1"></a><span class="kw">function</span> <span class="fu">powerToDb</span>(img){</span>
<span id="cb17-64"><a href="#cb17-64" tabindex="-1"></a>  <span class="cf">return</span> ee<span class="op">.</span><span class="fu">Image</span>(<span class="dv">10</span>)<span class="op">.</span><span class="fu">multiply</span>(img<span class="op">.</span><span class="fu">log10</span>())<span class="op">;</span></span>
<span id="cb17-65"><a href="#cb17-65" tabindex="-1"></a>}</span>
<span id="cb17-66"><a href="#cb17-66" tabindex="-1"></a> </span>
<span id="cb17-67"><a href="#cb17-67" tabindex="-1"></a><span class="kw">function</span> <span class="fu">dbToPower</span>(img){</span>
<span id="cb17-68"><a href="#cb17-68" tabindex="-1"></a>  <span class="cf">return</span> ee<span class="op">.</span><span class="fu">Image</span>(<span class="dv">10</span>)<span class="op">.</span><span class="fu">pow</span>(img<span class="op">.</span><span class="fu">divide</span>(<span class="dv">10</span>))<span class="op">;</span></span>
<span id="cb17-69"><a href="#cb17-69" tabindex="-1"></a>}</span>
<span id="cb17-70"><a href="#cb17-70" tabindex="-1"></a> </span>
<span id="cb17-71"><a href="#cb17-71" tabindex="-1"></a><span class="co">// The RL speckle filter</span></span>
<span id="cb17-72"><a href="#cb17-72" tabindex="-1"></a><span class="kw">function</span> <span class="fu">refinedLee</span>(image) {</span>
<span id="cb17-73"><a href="#cb17-73" tabindex="-1"></a>  <span class="kw">var</span> date <span class="op">=</span> image<span class="op">.</span><span class="fu">date</span>()<span class="op">;</span></span>
<span id="cb17-74"><a href="#cb17-74" tabindex="-1"></a>  <span class="kw">var</span> bandNames <span class="op">=</span> image<span class="op">.</span><span class="fu">bandNames</span>()<span class="op">;</span></span>
<span id="cb17-75"><a href="#cb17-75" tabindex="-1"></a>  image <span class="op">=</span> <span class="fu">dbToPower</span>(image)<span class="op">;</span></span>
<span id="cb17-76"><a href="#cb17-76" tabindex="-1"></a>   </span>
<span id="cb17-77"><a href="#cb17-77" tabindex="-1"></a>  <span class="kw">var</span> result <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(bandNames<span class="op">.</span><span class="fu">map</span>(<span class="kw">function</span>(b){</span>
<span id="cb17-78"><a href="#cb17-78" tabindex="-1"></a>    <span class="kw">var</span> img <span class="op">=</span> image<span class="op">.</span><span class="fu">select</span>([b])<span class="op">;</span></span>
<span id="cb17-79"><a href="#cb17-79" tabindex="-1"></a>     </span>
<span id="cb17-80"><a href="#cb17-80" tabindex="-1"></a>    <span class="co">// img must be in natural units, i.e. not in dB!</span></span>
<span id="cb17-81"><a href="#cb17-81" tabindex="-1"></a>    <span class="co">// Set up 3x3 kernels </span></span>
<span id="cb17-82"><a href="#cb17-82" tabindex="-1"></a>    <span class="kw">var</span> weights3 <span class="op">=</span> ee<span class="op">.</span><span class="at">List</span><span class="op">.</span><span class="fu">repeat</span>(ee<span class="op">.</span><span class="at">List</span><span class="op">.</span><span class="fu">repeat</span>(<span class="dv">1</span><span class="op">,</span><span class="dv">3</span>)<span class="op">,</span><span class="dv">3</span>)<span class="op">;</span></span>
<span id="cb17-83"><a href="#cb17-83" tabindex="-1"></a>    <span class="kw">var</span> kernel3 <span class="op">=</span> ee<span class="op">.</span><span class="at">Kernel</span><span class="op">.</span><span class="fu">fixed</span>(<span class="dv">3</span><span class="op">,</span><span class="dv">3</span><span class="op">,</span> weights3<span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span></span>
<span id="cb17-84"><a href="#cb17-84" tabindex="-1"></a>   </span>
<span id="cb17-85"><a href="#cb17-85" tabindex="-1"></a>    <span class="kw">var</span> mean3 <span class="op">=</span> img<span class="op">.</span><span class="fu">reduceNeighborhood</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">mean</span>()<span class="op">,</span> kernel3)<span class="op">;</span></span>
<span id="cb17-86"><a href="#cb17-86" tabindex="-1"></a>    <span class="kw">var</span> variance3 <span class="op">=</span> img<span class="op">.</span><span class="fu">reduceNeighborhood</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">variance</span>()<span class="op">,</span> kernel3)<span class="op">;</span></span>
<span id="cb17-87"><a href="#cb17-87" tabindex="-1"></a>   </span>
<span id="cb17-88"><a href="#cb17-88" tabindex="-1"></a>    <span class="co">// Use a sample of the 3x3 windows inside a 7x7 windows to determine gradients and directions</span></span>
<span id="cb17-89"><a href="#cb17-89" tabindex="-1"></a>    <span class="kw">var</span> sample_weights <span class="op">=</span> ee<span class="op">.</span><span class="fu">List</span>([[<span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span>]<span class="op">,</span> [<span class="dv">0</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span>]<span class="op">,</span>[<span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span>]<span class="op">,</span> [<span class="dv">0</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span>]<span class="op">,</span> [<span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span>]<span class="op">,</span> [<span class="dv">0</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span>]<span class="op">,</span>[<span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span>]])<span class="op">;</span></span>
<span id="cb17-90"><a href="#cb17-90" tabindex="-1"></a>   </span>
<span id="cb17-91"><a href="#cb17-91" tabindex="-1"></a>    <span class="kw">var</span> sample_kernel <span class="op">=</span> ee<span class="op">.</span><span class="at">Kernel</span><span class="op">.</span><span class="fu">fixed</span>(<span class="dv">7</span><span class="op">,</span><span class="dv">7</span><span class="op">,</span> sample_weights<span class="op">,</span> <span class="dv">3</span><span class="op">,</span><span class="dv">3</span><span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span></span>
<span id="cb17-92"><a href="#cb17-92" tabindex="-1"></a>   </span>
<span id="cb17-93"><a href="#cb17-93" tabindex="-1"></a>    <span class="co">// Calculate mean and variance for the sampled windows and store as 9 bands</span></span>
<span id="cb17-94"><a href="#cb17-94" tabindex="-1"></a>    <span class="kw">var</span> sample_mean <span class="op">=</span> mean3<span class="op">.</span><span class="fu">neighborhoodToBands</span>(sample_kernel)<span class="op">;</span> </span>
<span id="cb17-95"><a href="#cb17-95" tabindex="-1"></a>    <span class="kw">var</span> sample_var <span class="op">=</span> variance3<span class="op">.</span><span class="fu">neighborhoodToBands</span>(sample_kernel)<span class="op">;</span></span>
<span id="cb17-96"><a href="#cb17-96" tabindex="-1"></a>   </span>
<span id="cb17-97"><a href="#cb17-97" tabindex="-1"></a>    <span class="co">// Determine the 4 gradients for the sampled windows</span></span>
<span id="cb17-98"><a href="#cb17-98" tabindex="-1"></a>    <span class="kw">var</span> gradients <span class="op">=</span> sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">1</span>)<span class="op">.</span><span class="fu">subtract</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">7</span>))<span class="op">.</span><span class="fu">abs</span>()<span class="op">;</span></span>
<span id="cb17-99"><a href="#cb17-99" tabindex="-1"></a>    gradients <span class="op">=</span> gradients<span class="op">.</span><span class="fu">addBands</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">6</span>)<span class="op">.</span><span class="fu">subtract</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">2</span>))<span class="op">.</span><span class="fu">abs</span>())<span class="op">;</span></span>
<span id="cb17-100"><a href="#cb17-100" tabindex="-1"></a>    gradients <span class="op">=</span> gradients<span class="op">.</span><span class="fu">addBands</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">3</span>)<span class="op">.</span><span class="fu">subtract</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">5</span>))<span class="op">.</span><span class="fu">abs</span>())<span class="op">;</span></span>
<span id="cb17-101"><a href="#cb17-101" tabindex="-1"></a>    gradients <span class="op">=</span> gradients<span class="op">.</span><span class="fu">addBands</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">0</span>)<span class="op">.</span><span class="fu">subtract</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">8</span>))<span class="op">.</span><span class="fu">abs</span>())<span class="op">;</span></span>
<span id="cb17-102"><a href="#cb17-102" tabindex="-1"></a>   </span>
<span id="cb17-103"><a href="#cb17-103" tabindex="-1"></a>    <span class="co">// And find the maximum gradient amongst gradient bands</span></span>
<span id="cb17-104"><a href="#cb17-104" tabindex="-1"></a>    <span class="kw">var</span> max_gradient <span class="op">=</span> gradients<span class="op">.</span><span class="fu">reduce</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">max</span>())<span class="op">;</span></span>
<span id="cb17-105"><a href="#cb17-105" tabindex="-1"></a>   </span>
<span id="cb17-106"><a href="#cb17-106" tabindex="-1"></a>    <span class="co">// Create a mask for band pixels that are the maximum gradient</span></span>
<span id="cb17-107"><a href="#cb17-107" tabindex="-1"></a>    <span class="kw">var</span> gradmask <span class="op">=</span> gradients<span class="op">.</span><span class="fu">eq</span>(max_gradient)<span class="op">;</span></span>
<span id="cb17-108"><a href="#cb17-108" tabindex="-1"></a>   </span>
<span id="cb17-109"><a href="#cb17-109" tabindex="-1"></a>    <span class="co">// duplicate gradmask bands: each gradient represents 2 directions</span></span>
<span id="cb17-110"><a href="#cb17-110" tabindex="-1"></a>    gradmask <span class="op">=</span> gradmask<span class="op">.</span><span class="fu">addBands</span>(gradmask)<span class="op">;</span></span>
<span id="cb17-111"><a href="#cb17-111" tabindex="-1"></a>   </span>
<span id="cb17-112"><a href="#cb17-112" tabindex="-1"></a>    <span class="co">// Determine the 8 directions</span></span>
<span id="cb17-113"><a href="#cb17-113" tabindex="-1"></a>    <span class="kw">var</span> directions <span class="op">=</span> sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">1</span>)<span class="op">.</span><span class="fu">subtract</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">4</span>))<span class="op">.</span><span class="fu">gt</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">4</span>)<span class="op">.</span><span class="fu">subtract</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">7</span>)))<span class="op">.</span><span class="fu">multiply</span>(<span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb17-114"><a href="#cb17-114" tabindex="-1"></a>    directions <span class="op">=</span> directions<span class="op">.</span><span class="fu">addBands</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">6</span>)<span class="op">.</span><span class="fu">subtract</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">4</span>))<span class="op">.</span><span class="fu">gt</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">4</span>)<span class="op">.</span><span class="fu">subtract</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">2</span>)))<span class="op">.</span><span class="fu">multiply</span>(<span class="dv">2</span>))<span class="op">;</span></span>
<span id="cb17-115"><a href="#cb17-115" tabindex="-1"></a>    directions <span class="op">=</span> directions<span class="op">.</span><span class="fu">addBands</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">3</span>)<span class="op">.</span><span class="fu">subtract</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">4</span>))<span class="op">.</span><span class="fu">gt</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">4</span>)<span class="op">.</span><span class="fu">subtract</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">5</span>)))<span class="op">.</span><span class="fu">multiply</span>(<span class="dv">3</span>))<span class="op">;</span></span>
<span id="cb17-116"><a href="#cb17-116" tabindex="-1"></a>    directions <span class="op">=</span> directions<span class="op">.</span><span class="fu">addBands</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">0</span>)<span class="op">.</span><span class="fu">subtract</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">4</span>))<span class="op">.</span><span class="fu">gt</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">4</span>)<span class="op">.</span><span class="fu">subtract</span>(sample_mean<span class="op">.</span><span class="fu">select</span>(<span class="dv">8</span>)))<span class="op">.</span><span class="fu">multiply</span>(<span class="dv">4</span>))<span class="op">;</span></span>
<span id="cb17-117"><a href="#cb17-117" tabindex="-1"></a>    <span class="co">// The next 4 are the not() of the previous 4</span></span>
<span id="cb17-118"><a href="#cb17-118" tabindex="-1"></a>    directions <span class="op">=</span> directions<span class="op">.</span><span class="fu">addBands</span>(directions<span class="op">.</span><span class="fu">select</span>(<span class="dv">0</span>)<span class="op">.</span><span class="fu">not</span>()<span class="op">.</span><span class="fu">multiply</span>(<span class="dv">5</span>))<span class="op">;</span></span>
<span id="cb17-119"><a href="#cb17-119" tabindex="-1"></a>    directions <span class="op">=</span> directions<span class="op">.</span><span class="fu">addBands</span>(directions<span class="op">.</span><span class="fu">select</span>(<span class="dv">1</span>)<span class="op">.</span><span class="fu">not</span>()<span class="op">.</span><span class="fu">multiply</span>(<span class="dv">6</span>))<span class="op">;</span></span>
<span id="cb17-120"><a href="#cb17-120" tabindex="-1"></a>    directions <span class="op">=</span> directions<span class="op">.</span><span class="fu">addBands</span>(directions<span class="op">.</span><span class="fu">select</span>(<span class="dv">2</span>)<span class="op">.</span><span class="fu">not</span>()<span class="op">.</span><span class="fu">multiply</span>(<span class="dv">7</span>))<span class="op">;</span></span>
<span id="cb17-121"><a href="#cb17-121" tabindex="-1"></a>    directions <span class="op">=</span> directions<span class="op">.</span><span class="fu">addBands</span>(directions<span class="op">.</span><span class="fu">select</span>(<span class="dv">3</span>)<span class="op">.</span><span class="fu">not</span>()<span class="op">.</span><span class="fu">multiply</span>(<span class="dv">8</span>))<span class="op">;</span></span>
<span id="cb17-122"><a href="#cb17-122" tabindex="-1"></a>   </span>
<span id="cb17-123"><a href="#cb17-123" tabindex="-1"></a>    <span class="co">// Mask all values that are not 1-8</span></span>
<span id="cb17-124"><a href="#cb17-124" tabindex="-1"></a>    directions <span class="op">=</span> directions<span class="op">.</span><span class="fu">updateMask</span>(gradmask)<span class="op">;</span></span>
<span id="cb17-125"><a href="#cb17-125" tabindex="-1"></a>   </span>
<span id="cb17-126"><a href="#cb17-126" tabindex="-1"></a>    <span class="co">// &quot;collapse&quot; the stack into a singe band image (due to masking, each pixel has just one value (1-8) in it&#39;s directional band, and is otherwise masked)</span></span>
<span id="cb17-127"><a href="#cb17-127" tabindex="-1"></a>    directions <span class="op">=</span> directions<span class="op">.</span><span class="fu">reduce</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">sum</span>())<span class="op">;</span>  </span>
<span id="cb17-128"><a href="#cb17-128" tabindex="-1"></a>   </span>
<span id="cb17-129"><a href="#cb17-129" tabindex="-1"></a>    <span class="co">//var pal = [&#39;ffffff&#39;,&#39;ff0000&#39;,&#39;ffff00&#39;, &#39;00ff00&#39;, &#39;00ffff&#39;, &#39;0000ff&#39;, &#39;ff00ff&#39;, &#39;000000&#39;];</span></span>
<span id="cb17-130"><a href="#cb17-130" tabindex="-1"></a>    <span class="co">//Map.addLayer(directions.reduce(ee.Reducer.sum()), {min:1, max:8, palette: pal}, &#39;Directions&#39;, false);</span></span>
<span id="cb17-131"><a href="#cb17-131" tabindex="-1"></a>   </span>
<span id="cb17-132"><a href="#cb17-132" tabindex="-1"></a>    <span class="kw">var</span> sample_stats <span class="op">=</span> sample_var<span class="op">.</span><span class="fu">divide</span>(sample_mean<span class="op">.</span><span class="fu">multiply</span>(sample_mean))<span class="op">;</span></span>
<span id="cb17-133"><a href="#cb17-133" tabindex="-1"></a>   </span>
<span id="cb17-134"><a href="#cb17-134" tabindex="-1"></a>    <span class="co">// Calculate localNoiseVariance</span></span>
<span id="cb17-135"><a href="#cb17-135" tabindex="-1"></a>    <span class="kw">var</span> sigmaV <span class="op">=</span> sample_stats<span class="op">.</span><span class="fu">toArray</span>()<span class="op">.</span><span class="fu">arraySort</span>()<span class="op">.</span><span class="fu">arraySlice</span>(<span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">5</span>)<span class="op">.</span><span class="fu">arrayReduce</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">mean</span>()<span class="op">,</span> [<span class="dv">0</span>])<span class="op">;</span></span>
<span id="cb17-136"><a href="#cb17-136" tabindex="-1"></a>   </span>
<span id="cb17-137"><a href="#cb17-137" tabindex="-1"></a>    <span class="co">// Set up the 7*7 kernels for directional statistics</span></span>
<span id="cb17-138"><a href="#cb17-138" tabindex="-1"></a>    <span class="kw">var</span> rect_weights <span class="op">=</span> ee<span class="op">.</span><span class="at">List</span><span class="op">.</span><span class="fu">repeat</span>(ee<span class="op">.</span><span class="at">List</span><span class="op">.</span><span class="fu">repeat</span>(<span class="dv">0</span><span class="op">,</span><span class="dv">7</span>)<span class="op">,</span><span class="dv">3</span>)<span class="op">.</span><span class="fu">cat</span>(ee<span class="op">.</span><span class="at">List</span><span class="op">.</span><span class="fu">repeat</span>(ee<span class="op">.</span><span class="at">List</span><span class="op">.</span><span class="fu">repeat</span>(<span class="dv">1</span><span class="op">,</span><span class="dv">7</span>)<span class="op">,</span><span class="dv">4</span>))<span class="op">;</span></span>
<span id="cb17-139"><a href="#cb17-139" tabindex="-1"></a>   </span>
<span id="cb17-140"><a href="#cb17-140" tabindex="-1"></a>    <span class="kw">var</span> diag_weights <span class="op">=</span> ee<span class="op">.</span><span class="fu">List</span>([[<span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span>]<span class="op">,</span> [<span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span>]<span class="op">,</span> [<span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span>]<span class="op">,</span> </span>
<span id="cb17-141"><a href="#cb17-141" tabindex="-1"></a>      [<span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span>]<span class="op">,</span> [<span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span><span class="op">,</span><span class="dv">0</span>]<span class="op">,</span> [<span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">0</span>]<span class="op">,</span> [<span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span><span class="op">,</span><span class="dv">1</span>]])<span class="op">;</span></span>
<span id="cb17-142"><a href="#cb17-142" tabindex="-1"></a>   </span>
<span id="cb17-143"><a href="#cb17-143" tabindex="-1"></a>    <span class="kw">var</span> rect_kernel <span class="op">=</span> ee<span class="op">.</span><span class="at">Kernel</span><span class="op">.</span><span class="fu">fixed</span>(<span class="dv">7</span><span class="op">,</span><span class="dv">7</span><span class="op">,</span> rect_weights<span class="op">,</span> <span class="dv">3</span><span class="op">,</span> <span class="dv">3</span><span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span></span>
<span id="cb17-144"><a href="#cb17-144" tabindex="-1"></a>    <span class="kw">var</span> diag_kernel <span class="op">=</span> ee<span class="op">.</span><span class="at">Kernel</span><span class="op">.</span><span class="fu">fixed</span>(<span class="dv">7</span><span class="op">,</span><span class="dv">7</span><span class="op">,</span> diag_weights<span class="op">,</span> <span class="dv">3</span><span class="op">,</span> <span class="dv">3</span><span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span></span>
<span id="cb17-145"><a href="#cb17-145" tabindex="-1"></a>   </span>
<span id="cb17-146"><a href="#cb17-146" tabindex="-1"></a>    <span class="co">// Create stacks for mean and variance using the original kernels. Mask with relevant direction.</span></span>
<span id="cb17-147"><a href="#cb17-147" tabindex="-1"></a>    <span class="kw">var</span> dir_mean <span class="op">=</span> img<span class="op">.</span><span class="fu">reduceNeighborhood</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">mean</span>()<span class="op">,</span> rect_kernel)<span class="op">.</span><span class="fu">updateMask</span>(directions<span class="op">.</span><span class="fu">eq</span>(<span class="dv">1</span>))<span class="op">;</span></span>
<span id="cb17-148"><a href="#cb17-148" tabindex="-1"></a>    <span class="kw">var</span> dir_var <span class="op">=</span> img<span class="op">.</span><span class="fu">reduceNeighborhood</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">variance</span>()<span class="op">,</span> rect_kernel)<span class="op">.</span><span class="fu">updateMask</span>(directions<span class="op">.</span><span class="fu">eq</span>(<span class="dv">1</span>))<span class="op">;</span></span>
<span id="cb17-149"><a href="#cb17-149" tabindex="-1"></a>   </span>
<span id="cb17-150"><a href="#cb17-150" tabindex="-1"></a>    dir_mean <span class="op">=</span> dir_mean<span class="op">.</span><span class="fu">addBands</span>(img<span class="op">.</span><span class="fu">reduceNeighborhood</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">mean</span>()<span class="op">,</span> diag_kernel)<span class="op">.</span><span class="fu">updateMask</span>(directions<span class="op">.</span><span class="fu">eq</span>(<span class="dv">2</span>)))<span class="op">;</span></span>
<span id="cb17-151"><a href="#cb17-151" tabindex="-1"></a>    dir_var <span class="op">=</span> dir_var<span class="op">.</span><span class="fu">addBands</span>(img<span class="op">.</span><span class="fu">reduceNeighborhood</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">variance</span>()<span class="op">,</span> diag_kernel)<span class="op">.</span><span class="fu">updateMask</span>(directions<span class="op">.</span><span class="fu">eq</span>(<span class="dv">2</span>)))<span class="op">;</span></span>
<span id="cb17-152"><a href="#cb17-152" tabindex="-1"></a>   </span>
<span id="cb17-153"><a href="#cb17-153" tabindex="-1"></a>    <span class="co">// and add the bands for rotated kernels</span></span>
<span id="cb17-154"><a href="#cb17-154" tabindex="-1"></a>    <span class="cf">for</span> (<span class="kw">var</span> i<span class="op">=</span><span class="dv">1</span><span class="op">;</span> i<span class="op">&lt;</span><span class="dv">4</span><span class="op">;</span> i<span class="op">++</span>) {</span>
<span id="cb17-155"><a href="#cb17-155" tabindex="-1"></a>      dir_mean <span class="op">=</span> dir_mean<span class="op">.</span><span class="fu">addBands</span>(img<span class="op">.</span><span class="fu">reduceNeighborhood</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">mean</span>()<span class="op">,</span> rect_kernel<span class="op">.</span><span class="fu">rotate</span>(i))<span class="op">.</span><span class="fu">updateMask</span>(directions<span class="op">.</span><span class="fu">eq</span>(<span class="dv">2</span><span class="op">*</span>i<span class="op">+</span><span class="dv">1</span>)))<span class="op">;</span></span>
<span id="cb17-156"><a href="#cb17-156" tabindex="-1"></a>      dir_var <span class="op">=</span> dir_var<span class="op">.</span><span class="fu">addBands</span>(img<span class="op">.</span><span class="fu">reduceNeighborhood</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">variance</span>()<span class="op">,</span> rect_kernel<span class="op">.</span><span class="fu">rotate</span>(i))<span class="op">.</span><span class="fu">updateMask</span>(directions<span class="op">.</span><span class="fu">eq</span>(<span class="dv">2</span><span class="op">*</span>i<span class="op">+</span><span class="dv">1</span>)))<span class="op">;</span></span>
<span id="cb17-157"><a href="#cb17-157" tabindex="-1"></a>      dir_mean <span class="op">=</span> dir_mean<span class="op">.</span><span class="fu">addBands</span>(img<span class="op">.</span><span class="fu">reduceNeighborhood</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">mean</span>()<span class="op">,</span> diag_kernel<span class="op">.</span><span class="fu">rotate</span>(i))<span class="op">.</span><span class="fu">updateMask</span>(directions<span class="op">.</span><span class="fu">eq</span>(<span class="dv">2</span><span class="op">*</span>i<span class="op">+</span><span class="dv">2</span>)))<span class="op">;</span></span>
<span id="cb17-158"><a href="#cb17-158" tabindex="-1"></a>      dir_var <span class="op">=</span> dir_var<span class="op">.</span><span class="fu">addBands</span>(img<span class="op">.</span><span class="fu">reduceNeighborhood</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">variance</span>()<span class="op">,</span> diag_kernel<span class="op">.</span><span class="fu">rotate</span>(i))<span class="op">.</span><span class="fu">updateMask</span>(directions<span class="op">.</span><span class="fu">eq</span>(<span class="dv">2</span><span class="op">*</span>i<span class="op">+</span><span class="dv">2</span>)))<span class="op">;</span></span>
<span id="cb17-159"><a href="#cb17-159" tabindex="-1"></a>    }</span>
<span id="cb17-160"><a href="#cb17-160" tabindex="-1"></a>   </span>
<span id="cb17-161"><a href="#cb17-161" tabindex="-1"></a>    <span class="co">// &quot;collapse&quot; the stack into a single band image (due to masking, each pixel has just one value in it&#39;s directional band, and is otherwise masked)</span></span>
<span id="cb17-162"><a href="#cb17-162" tabindex="-1"></a>    dir_mean <span class="op">=</span> dir_mean<span class="op">.</span><span class="fu">reduce</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">sum</span>())<span class="op">;</span></span>
<span id="cb17-163"><a href="#cb17-163" tabindex="-1"></a>    dir_var <span class="op">=</span> dir_var<span class="op">.</span><span class="fu">reduce</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">sum</span>())<span class="op">;</span></span>
<span id="cb17-164"><a href="#cb17-164" tabindex="-1"></a>   </span>
<span id="cb17-165"><a href="#cb17-165" tabindex="-1"></a>    <span class="co">// A finally generate the filtered value</span></span>
<span id="cb17-166"><a href="#cb17-166" tabindex="-1"></a>    <span class="kw">var</span> varX <span class="op">=</span> dir_var<span class="op">.</span><span class="fu">subtract</span>(dir_mean<span class="op">.</span><span class="fu">multiply</span>(dir_mean)<span class="op">.</span><span class="fu">multiply</span>(sigmaV))<span class="op">.</span><span class="fu">divide</span>(sigmaV<span class="op">.</span><span class="fu">add</span>(<span class="fl">1.0</span>))<span class="op">;</span></span>
<span id="cb17-167"><a href="#cb17-167" tabindex="-1"></a>   </span>
<span id="cb17-168"><a href="#cb17-168" tabindex="-1"></a>    <span class="kw">var</span> b <span class="op">=</span> varX<span class="op">.</span><span class="fu">divide</span>(dir_var)<span class="op">;</span></span>
<span id="cb17-169"><a href="#cb17-169" tabindex="-1"></a>   </span>
<span id="cb17-170"><a href="#cb17-170" tabindex="-1"></a>    <span class="cf">return</span> dir_mean<span class="op">.</span><span class="fu">add</span>(b<span class="op">.</span><span class="fu">multiply</span>(img<span class="op">.</span><span class="fu">subtract</span>(dir_mean)))</span>
<span id="cb17-171"><a href="#cb17-171" tabindex="-1"></a>      <span class="op">.</span><span class="fu">arrayProject</span>([<span class="dv">0</span>])</span>
<span id="cb17-172"><a href="#cb17-172" tabindex="-1"></a>      <span class="co">// Get a multi-band image bands.</span></span>
<span id="cb17-173"><a href="#cb17-173" tabindex="-1"></a>      <span class="op">.</span><span class="fu">arrayFlatten</span>([[<span class="st">&#39;sum&#39;</span>]])</span>
<span id="cb17-174"><a href="#cb17-174" tabindex="-1"></a>      <span class="op">.</span><span class="fu">float</span>()<span class="op">;</span></span>
<span id="cb17-175"><a href="#cb17-175" tabindex="-1"></a>  }))<span class="op">.</span><span class="fu">toBands</span>()<span class="op">.</span><span class="fu">rename</span>(bandNames)<span class="op">;</span></span>
<span id="cb17-176"><a href="#cb17-176" tabindex="-1"></a>  <span class="kw">var</span> resultImage <span class="op">=</span> <span class="fu">powerToDb</span>(ee<span class="op">.</span><span class="fu">Image</span>(result))<span class="op">;</span></span>
<span id="cb17-177"><a href="#cb17-177" tabindex="-1"></a>  <span class="cf">return</span> resultImage<span class="op">.</span><span class="fu">set</span>(<span class="st">&#39;system:time_start&#39;</span><span class="op">,</span> date<span class="op">.</span><span class="fu">millis</span>())<span class="op">;</span></span>
<span id="cb17-178"><a href="#cb17-178" tabindex="-1"></a>}</span></code></pre></div>
</div>
<div id="adding-spatial-context" class="section level2">
<h2>Adding Spatial Context</h2>
<p><a
href="https://code.earthengine.google.com/?noload=1&amp;scriptPath=users%2Fujavalgandhi%2FEnd-to-End-GEE%3ASupplement%2FSupervised_Classification%2FAdding_Spatial_Context"
target="_blank">Open in Code Editor ↗</a></p>
<div class="sourceCode" id="cb18"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb18-1"><a href="#cb18-1" tabindex="-1"></a><span class="co">// Script showing how to add spatial context </span></span>
<span id="cb18-2"><a href="#cb18-2" tabindex="-1"></a><span class="co">// to classification training samples</span></span>
<span id="cb18-3"><a href="#cb18-3" tabindex="-1"></a></span>
<span id="cb18-4"><a href="#cb18-4" tabindex="-1"></a><span class="kw">var</span> gcp <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">&quot;users/ujavalgandhi/e2e/arkavathy_gcps&quot;</span>)<span class="op">;</span></span>
<span id="cb18-5"><a href="#cb18-5" tabindex="-1"></a><span class="kw">var</span> composite <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(<span class="st">&quot;users/ujavalgandhi/e2e/arkavathy_2019_composite&quot;</span>)<span class="op">;</span></span>
<span id="cb18-6"><a href="#cb18-6" tabindex="-1"></a><span class="kw">var</span> boundary <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">&quot;users/ujavalgandhi/e2e/arkavathy_boundary&quot;</span>)<span class="op">;</span></span>
<span id="cb18-7"><a href="#cb18-7" tabindex="-1"></a></span>
<span id="cb18-8"><a href="#cb18-8" tabindex="-1"></a><span class="kw">var</span> geometry <span class="op">=</span> boundary<span class="op">.</span><span class="fu">geometry</span>()</span>
<span id="cb18-9"><a href="#cb18-9" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">centerObject</span>(geometry)<span class="op">;</span></span>
<span id="cb18-10"><a href="#cb18-10" tabindex="-1"></a></span>
<span id="cb18-11"><a href="#cb18-11" tabindex="-1"></a><span class="co">// 1. Add Latitude and Longitude bands</span></span>
<span id="cb18-12"><a href="#cb18-12" tabindex="-1"></a><span class="kw">var</span> composite <span class="op">=</span> composite<span class="op">.</span><span class="fu">addBands</span>(ee<span class="op">.</span><span class="at">Image</span><span class="op">.</span><span class="fu">pixelLonLat</span>())<span class="op">;</span></span>
<span id="cb18-13"><a href="#cb18-13" tabindex="-1"></a></span>
<span id="cb18-14"><a href="#cb18-14" tabindex="-1"></a><span class="co">// 2. Add Distance to features</span></span>
<span id="cb18-15"><a href="#cb18-15" tabindex="-1"></a></span>
<span id="cb18-16"><a href="#cb18-16" tabindex="-1"></a><span class="co">// We will add distance to nearest road segment</span></span>
<span id="cb18-17"><a href="#cb18-17" tabindex="-1"></a><span class="kw">var</span> roads <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">&#39;users/ujavalgandhi/e2e/arkavathy_osm_roads&#39;</span>)<span class="op">;</span></span>
<span id="cb18-18"><a href="#cb18-18" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(roads<span class="op">,</span> {<span class="dt">color</span><span class="op">:</span> <span class="st">&#39;gray&#39;</span>}<span class="op">,</span> <span class="st">&#39;Roads&#39;</span><span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span></span>
<span id="cb18-19"><a href="#cb18-19" tabindex="-1"></a><span class="kw">var</span> distance <span class="op">=</span> roads<span class="op">.</span><span class="fu">distance</span>({<span class="dt">searchRadius</span><span class="op">:</span> <span class="dv">1000</span>})<span class="op">.</span><span class="fu">rename</span>(<span class="st">&#39;roads_distance&#39;</span>)<span class="op">;</span></span>
<span id="cb18-20"><a href="#cb18-20" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(distance<span class="op">,</span> {<span class="dt">min</span><span class="op">:</span><span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span><span class="dv">1000</span><span class="op">,</span> <span class="dt">palette</span><span class="op">:</span> [<span class="st">&#39;blue&#39;</span><span class="op">,</span> <span class="st">&#39;white&#39;</span>]}<span class="op">,</span> <span class="st">&#39;Distance&#39;</span><span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span></span>
<span id="cb18-21"><a href="#cb18-21" tabindex="-1"></a></span>
<span id="cb18-22"><a href="#cb18-22" tabindex="-1"></a><span class="kw">var</span> composite <span class="op">=</span> composite<span class="op">.</span><span class="fu">addBands</span>(distance)<span class="op">;</span></span>
<span id="cb18-23"><a href="#cb18-23" tabindex="-1"></a></span>
<span id="cb18-24"><a href="#cb18-24" tabindex="-1"></a><span class="co">// 3. Add Neighborhood bands</span></span>
<span id="cb18-25"><a href="#cb18-25" tabindex="-1"></a><span class="kw">var</span> addNdvi <span class="op">=</span> <span class="kw">function</span>(image) {</span>
<span id="cb18-26"><a href="#cb18-26" tabindex="-1"></a>  <span class="kw">var</span> ndvi <span class="op">=</span> image<span class="op">.</span><span class="fu">normalizedDifference</span>([<span class="st">&#39;B8&#39;</span><span class="op">,</span> <span class="st">&#39;B4&#39;</span>])<span class="op">.</span><span class="fu">rename</span>([<span class="st">&#39;ndvi&#39;</span>])<span class="op">;</span></span>
<span id="cb18-27"><a href="#cb18-27" tabindex="-1"></a>  <span class="cf">return</span> image<span class="op">.</span><span class="fu">addBands</span>(ndvi)<span class="op">;</span></span>
<span id="cb18-28"><a href="#cb18-28" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb18-29"><a href="#cb18-29" tabindex="-1"></a></span>
<span id="cb18-30"><a href="#cb18-30" tabindex="-1"></a><span class="kw">var</span> composite <span class="op">=</span> <span class="fu">addNdvi</span>(composite)<span class="op">;</span></span>
<span id="cb18-31"><a href="#cb18-31" tabindex="-1"></a></span>
<span id="cb18-32"><a href="#cb18-32" tabindex="-1"></a><span class="kw">var</span> kernel <span class="op">=</span> ee<span class="op">.</span><span class="at">Kernel</span><span class="op">.</span><span class="fu">square</span>({</span>
<span id="cb18-33"><a href="#cb18-33" tabindex="-1"></a>  <span class="dt">radius</span><span class="op">:</span> <span class="dv">1</span><span class="op">,</span></span>
<span id="cb18-34"><a href="#cb18-34" tabindex="-1"></a>  <span class="dt">units</span><span class="op">:</span> <span class="st">&#39;pixels&#39;</span><span class="op">,</span></span>
<span id="cb18-35"><a href="#cb18-35" tabindex="-1"></a>})</span>
<span id="cb18-36"><a href="#cb18-36" tabindex="-1"></a><span class="kw">var</span> neighbors <span class="op">=</span> composite<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;ndvi&#39;</span>)<span class="op">.</span><span class="fu">neighborhoodToBands</span>(kernel)<span class="op">;</span></span>
<span id="cb18-37"><a href="#cb18-37" tabindex="-1"></a></span>
<span id="cb18-38"><a href="#cb18-38" tabindex="-1"></a><span class="kw">var</span> composite <span class="op">=</span> composite<span class="op">.</span><span class="fu">addBands</span>(neighbors)<span class="op">;</span></span>
<span id="cb18-39"><a href="#cb18-39" tabindex="-1"></a></span>
<span id="cb18-40"><a href="#cb18-40" tabindex="-1"></a><span class="co">// Overlay the point on the image to get training data.</span></span>
<span id="cb18-41"><a href="#cb18-41" tabindex="-1"></a><span class="kw">var</span> training <span class="op">=</span> composite<span class="op">.</span><span class="fu">sampleRegions</span>({</span>
<span id="cb18-42"><a href="#cb18-42" tabindex="-1"></a>  <span class="dt">collection</span><span class="op">:</span> gcp<span class="op">,</span></span>
<span id="cb18-43"><a href="#cb18-43" tabindex="-1"></a>  <span class="dt">properties</span><span class="op">:</span> [<span class="st">&#39;landcover&#39;</span>]<span class="op">,</span></span>
<span id="cb18-44"><a href="#cb18-44" tabindex="-1"></a>  <span class="dt">scale</span><span class="op">:</span> <span class="dv">30</span><span class="op">,</span></span>
<span id="cb18-45"><a href="#cb18-45" tabindex="-1"></a>  <span class="dt">tileScale</span><span class="op">:</span> <span class="dv">16</span></span>
<span id="cb18-46"><a href="#cb18-46" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb18-47"><a href="#cb18-47" tabindex="-1"></a></span>
<span id="cb18-48"><a href="#cb18-48" tabindex="-1"></a><span class="fu">print</span>(training)</span>
<span id="cb18-49"><a href="#cb18-49" tabindex="-1"></a></span>
<span id="cb18-50"><a href="#cb18-50" tabindex="-1"></a><span class="co">// Train a classifier.</span></span>
<span id="cb18-51"><a href="#cb18-51" tabindex="-1"></a><span class="kw">var</span> classifier <span class="op">=</span> ee<span class="op">.</span><span class="at">Classifier</span><span class="op">.</span><span class="fu">smileRandomForest</span>(<span class="dv">50</span>)</span>
<span id="cb18-52"><a href="#cb18-52" tabindex="-1"></a><span class="op">.</span><span class="fu">train</span>({</span>
<span id="cb18-53"><a href="#cb18-53" tabindex="-1"></a>  <span class="dt">features</span><span class="op">:</span> training<span class="op">,</span>  </span>
<span id="cb18-54"><a href="#cb18-54" tabindex="-1"></a>  <span class="dt">classProperty</span><span class="op">:</span> <span class="st">&#39;landcover&#39;</span><span class="op">,</span></span>
<span id="cb18-55"><a href="#cb18-55" tabindex="-1"></a>  <span class="dt">inputProperties</span><span class="op">:</span> composite<span class="op">.</span><span class="fu">bandNames</span>()</span>
<span id="cb18-56"><a href="#cb18-56" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb18-57"><a href="#cb18-57" tabindex="-1"></a></span>
<span id="cb18-58"><a href="#cb18-58" tabindex="-1"></a><span class="co">// Classify the image.</span></span>
<span id="cb18-59"><a href="#cb18-59" tabindex="-1"></a><span class="kw">var</span> classified <span class="op">=</span> composite<span class="op">.</span><span class="fu">classify</span>(classifier)<span class="op">;</span></span>
<span id="cb18-60"><a href="#cb18-60" tabindex="-1"></a></span>
<span id="cb18-61"><a href="#cb18-61" tabindex="-1"></a><span class="kw">var</span> rgbVis <span class="op">=</span> {<span class="dt">min</span><span class="op">:</span> <span class="fl">0.0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span> <span class="dv">3000</span><span class="op">,</span> <span class="dt">bands</span><span class="op">:</span> [<span class="st">&#39;B4&#39;</span><span class="op">,</span> <span class="st">&#39;B3&#39;</span><span class="op">,</span> <span class="st">&#39;B2&#39;</span>]}<span class="op">;</span></span>
<span id="cb18-62"><a href="#cb18-62" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(composite<span class="op">,</span> rgbVis<span class="op">,</span> <span class="st">&#39;Composite&#39;</span>)</span>
<span id="cb18-63"><a href="#cb18-63" tabindex="-1"></a><span class="kw">var</span> palette <span class="op">=</span> [<span class="st">&#39;#cc6d8f&#39;</span><span class="op">,</span> <span class="st">&#39;#ffc107&#39;</span><span class="op">,</span> <span class="st">&#39;#1e88e5&#39;</span><span class="op">,</span> <span class="st">&#39;#004d40&#39;</span> ]<span class="op">;</span></span>
<span id="cb18-64"><a href="#cb18-64" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(classified<span class="op">,</span> {<span class="dt">min</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span> <span class="dv">3</span><span class="op">,</span> <span class="dt">palette</span><span class="op">:</span> palette}<span class="op">,</span> <span class="st">&#39;Classified&#39;</span>)<span class="op">;</span></span></code></pre></div>
</div>
</div>
<div id="advanced-change-detection-techniques" class="section level1">
<h1>Advanced Change Detection Techniques</h1>
<div id="dynamic-world-time-series-chart" class="section level2">
<h2>Dynamic World Time Series Chart</h2>
<div class="figure" style="text-align: center">
<img src="images/end_to_end_gee/dw_chart.png" alt="Dynamic World Class Probabilities" width="100%" />
<p class="caption">
Dynamic World Class Probabilities
</p>
</div>
<p><a
href="https://code.earthengine.google.co.in/?scriptPath=users%2Fujavalgandhi%2FEnd-to-End-GEE%3ASupplement%2FChange_Detection%2FDynamic_World_Time_Series_Chart"
target="_blank">Open in Code Editor ↗</a></p>
<div class="sourceCode" id="cb19"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb19-1"><a href="#cb19-1" tabindex="-1"></a><span class="co">// Example script showing how to create a chart of</span></span>
<span id="cb19-2"><a href="#cb19-2" tabindex="-1"></a><span class="co">// Dynamic World Class Probabilities Over Time</span></span>
<span id="cb19-3"><a href="#cb19-3" tabindex="-1"></a></span>
<span id="cb19-4"><a href="#cb19-4" tabindex="-1"></a><span class="kw">var</span> location1 <span class="op">=</span> ee<span class="op">.</span><span class="at">Geometry</span><span class="op">.</span><span class="fu">Point</span>([<span class="fl">77.688</span><span class="op">,</span> <span class="fl">12.894</span>])<span class="op">;</span></span>
<span id="cb19-5"><a href="#cb19-5" tabindex="-1"></a><span class="kw">var</span> location2 <span class="op">=</span> ee<span class="op">.</span><span class="at">Geometry</span><span class="op">.</span><span class="fu">Point</span>([<span class="fl">77.746</span><span class="op">,</span> <span class="fl">12.889</span>])<span class="op">;</span></span>
<span id="cb19-6"><a href="#cb19-6" tabindex="-1"></a></span>
<span id="cb19-7"><a href="#cb19-7" tabindex="-1"></a><span class="kw">var</span> geometry <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>([</span>
<span id="cb19-8"><a href="#cb19-8" tabindex="-1"></a>  ee<span class="op">.</span><span class="fu">Feature</span>(location1<span class="op">,</span> {<span class="dt">name</span><span class="op">:</span> <span class="st">&#39;newly built&#39;</span>})<span class="op">,</span></span>
<span id="cb19-9"><a href="#cb19-9" tabindex="-1"></a>  ee<span class="op">.</span><span class="fu">Feature</span>(location2<span class="op">,</span> {<span class="dt">name</span><span class="op">:</span> <span class="st">&#39;non-bullt&#39;</span>})</span>
<span id="cb19-10"><a href="#cb19-10" tabindex="-1"></a>  ])</span>
<span id="cb19-11"><a href="#cb19-11" tabindex="-1"></a>  </span>
<span id="cb19-12"><a href="#cb19-12" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(geometry<span class="op">,</span> {<span class="dt">color</span><span class="op">:</span> <span class="st">&#39;red&#39;</span>}<span class="op">,</span> <span class="st">&#39;Selected Locations&#39;</span>)</span>
<span id="cb19-13"><a href="#cb19-13" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">centerObject</span>(geometry<span class="op">,</span> <span class="dv">16</span>)</span>
<span id="cb19-14"><a href="#cb19-14" tabindex="-1"></a></span>
<span id="cb19-15"><a href="#cb19-15" tabindex="-1"></a><span class="co">// Filter the Dynamic World collection for the time period and</span></span>
<span id="cb19-16"><a href="#cb19-16" tabindex="-1"></a><span class="co">// location of interest.</span></span>
<span id="cb19-17"><a href="#cb19-17" tabindex="-1"></a><span class="kw">var</span> startDate <span class="op">=</span> ee<span class="op">.</span><span class="at">Date</span><span class="op">.</span><span class="fu">fromYMD</span>(<span class="dv">2019</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb19-18"><a href="#cb19-18" tabindex="-1"></a><span class="kw">var</span> endDate <span class="op">=</span> startDate<span class="op">.</span><span class="fu">advance</span>(<span class="dv">5</span><span class="op">,</span> <span class="st">&#39;year&#39;</span>)<span class="op">;</span></span>
<span id="cb19-19"><a href="#cb19-19" tabindex="-1"></a></span>
<span id="cb19-20"><a href="#cb19-20" tabindex="-1"></a><span class="kw">var</span> dw <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&#39;GOOGLE/DYNAMICWORLD/V1&#39;</span>)</span>
<span id="cb19-21"><a href="#cb19-21" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(startDate<span class="op">,</span> endDate))</span>
<span id="cb19-22"><a href="#cb19-22" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">bounds</span>(geometry))</span>
<span id="cb19-23"><a href="#cb19-23" tabindex="-1"></a></span>
<span id="cb19-24"><a href="#cb19-24" tabindex="-1"></a><span class="kw">var</span> probabilityBands <span class="op">=</span> [</span>
<span id="cb19-25"><a href="#cb19-25" tabindex="-1"></a>    <span class="st">&#39;water&#39;</span><span class="op">,</span> <span class="st">&#39;trees&#39;</span><span class="op">,</span> <span class="st">&#39;grass&#39;</span><span class="op">,</span> <span class="st">&#39;flooded_vegetation&#39;</span><span class="op">,</span> <span class="st">&#39;crops&#39;</span><span class="op">,</span></span>
<span id="cb19-26"><a href="#cb19-26" tabindex="-1"></a>    <span class="st">&#39;shrub_and_scrub&#39;</span><span class="op">,</span> <span class="st">&#39;built&#39;</span><span class="op">,</span> <span class="st">&#39;bare&#39;</span><span class="op">,</span> <span class="st">&#39;snow_and_ice&#39;</span></span>
<span id="cb19-27"><a href="#cb19-27" tabindex="-1"></a>    ]<span class="op">;</span></span>
<span id="cb19-28"><a href="#cb19-28" tabindex="-1"></a></span>
<span id="cb19-29"><a href="#cb19-29" tabindex="-1"></a><span class="co">// Select all probability bands</span></span>
<span id="cb19-30"><a href="#cb19-30" tabindex="-1"></a><span class="kw">var</span> dwTimeSeries <span class="op">=</span> dw<span class="op">.</span><span class="fu">select</span>(probabilityBands)<span class="op">;</span></span>
<span id="cb19-31"><a href="#cb19-31" tabindex="-1"></a></span>
<span id="cb19-32"><a href="#cb19-32" tabindex="-1"></a><span class="co">// Plot the time series for a single class</span></span>
<span id="cb19-33"><a href="#cb19-33" tabindex="-1"></a><span class="kw">var</span> chart <span class="op">=</span> ui<span class="op">.</span><span class="at">Chart</span><span class="op">.</span><span class="at">image</span><span class="op">.</span><span class="fu">seriesByRegion</span>({</span>
<span id="cb19-34"><a href="#cb19-34" tabindex="-1"></a>  <span class="dt">imageCollection</span><span class="op">:</span> dwTimeSeries<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;built&#39;</span>)<span class="op">,</span></span>
<span id="cb19-35"><a href="#cb19-35" tabindex="-1"></a>  <span class="dt">regions</span><span class="op">:</span> geometry<span class="op">,</span></span>
<span id="cb19-36"><a href="#cb19-36" tabindex="-1"></a>  <span class="dt">reducer</span><span class="op">:</span> ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">mean</span>()<span class="op">,</span></span>
<span id="cb19-37"><a href="#cb19-37" tabindex="-1"></a>  <span class="dt">scale</span><span class="op">:</span> <span class="dv">10</span><span class="op">,</span></span>
<span id="cb19-38"><a href="#cb19-38" tabindex="-1"></a>  <span class="dt">seriesProperty</span><span class="op">:</span> <span class="st">&#39;name&#39;</span></span>
<span id="cb19-39"><a href="#cb19-39" tabindex="-1"></a>})<span class="op">.</span><span class="fu">setOptions</span>({</span>
<span id="cb19-40"><a href="#cb19-40" tabindex="-1"></a>      <span class="dt">lineWidth</span><span class="op">:</span> <span class="fl">0.5</span><span class="op">,</span></span>
<span id="cb19-41"><a href="#cb19-41" tabindex="-1"></a>      <span class="dt">pointSize</span><span class="op">:</span> <span class="dv">1</span><span class="op">,</span></span>
<span id="cb19-42"><a href="#cb19-42" tabindex="-1"></a>      <span class="dt">title</span><span class="op">:</span> <span class="st">&#39;Dynamic World Class Probability (Built)&#39;</span><span class="op">,</span></span>
<span id="cb19-43"><a href="#cb19-43" tabindex="-1"></a>      <span class="dt">interpolateNulls</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb19-44"><a href="#cb19-44" tabindex="-1"></a>      <span class="dt">vAxis</span><span class="op">:</span> {<span class="dt">title</span><span class="op">:</span> <span class="st">&#39;Probability&#39;</span><span class="op">,</span> <span class="dt">viewWindow</span><span class="op">:</span> {<span class="dt">min</span><span class="op">:</span><span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span><span class="dv">1</span>}}<span class="op">,</span></span>
<span id="cb19-45"><a href="#cb19-45" tabindex="-1"></a>      <span class="dt">hAxis</span><span class="op">:</span> {<span class="dt">title</span><span class="op">:</span> <span class="st">&#39;&#39;</span><span class="op">,</span> <span class="dt">format</span><span class="op">:</span> <span class="st">&#39;YYYY-MMM&#39;</span>}<span class="op">,</span></span>
<span id="cb19-46"><a href="#cb19-46" tabindex="-1"></a>      <span class="dt">series</span><span class="op">:</span> {</span>
<span id="cb19-47"><a href="#cb19-47" tabindex="-1"></a>        <span class="dv">0</span><span class="op">:</span> {<span class="dt">color</span><span class="op">:</span> <span class="st">&#39;red&#39;</span><span class="op">,</span> <span class="dt">linewidth</span><span class="op">:</span> <span class="dv">1</span>}<span class="op">,</span></span>
<span id="cb19-48"><a href="#cb19-48" tabindex="-1"></a>        <span class="dv">1</span><span class="op">:</span> {<span class="dt">color</span><span class="op">:</span> <span class="st">&#39;orange&#39;</span><span class="op">,</span> <span class="dt">lineWith</span><span class="op">:</span> <span class="fl">0.5</span>}<span class="op">,</span></span>
<span id="cb19-49"><a href="#cb19-49" tabindex="-1"></a>      }<span class="op">,</span></span>
<span id="cb19-50"><a href="#cb19-50" tabindex="-1"></a>      <span class="dt">chartArea</span><span class="op">:</span> {<span class="dt">left</span><span class="op">:</span><span class="dv">100</span><span class="op">,</span> <span class="dt">right</span><span class="op">:</span><span class="dv">100</span>}<span class="op">,</span></span>
<span id="cb19-51"><a href="#cb19-51" tabindex="-1"></a>      <span class="dt">legend</span><span class="op">:</span> {<span class="dt">position</span><span class="op">:</span> <span class="st">&#39;top&#39;</span>}</span>
<span id="cb19-52"><a href="#cb19-52" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb19-53"><a href="#cb19-53" tabindex="-1"></a><span class="fu">print</span>(chart)<span class="op">;</span></span></code></pre></div>
</div>
<div id="landslide-detection-using-dynamic-world"
class="section level2">
<h2>Landslide Detection using Dynamic World</h2>
<p><a
href="https://code.earthengine.google.co.in/?scriptPath=users%2Fujavalgandhi%2FEnd-to-End-GEE%3ASupplement%2FChange_Detection%2FDynamic_World_Landslides_Detection"
target="_blank">Open in Code Editor ↗</a></p>
<div class="sourceCode" id="cb20"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb20-1"><a href="#cb20-1" tabindex="-1"></a><span class="co">// Landslides Detection using Dynamic World Probability Bands</span></span>
<span id="cb20-2"><a href="#cb20-2" tabindex="-1"></a></span>
<span id="cb20-3"><a href="#cb20-3" tabindex="-1"></a><span class="co">// We want to detect landslides occurred in August 2018</span></span>
<span id="cb20-4"><a href="#cb20-4" tabindex="-1"></a><span class="co">// in India&#39;s Kodagu district.</span></span>
<span id="cb20-5"><a href="#cb20-5" tabindex="-1"></a></span>
<span id="cb20-6"><a href="#cb20-6" tabindex="-1"></a><span class="kw">var</span> geometry <span class="op">=</span> ee<span class="op">.</span><span class="at">Geometry</span><span class="op">.</span><span class="fu">Polygon</span>([[</span>
<span id="cb20-7"><a href="#cb20-7" tabindex="-1"></a>  [<span class="fl">75.70357667713435</span><span class="op">,</span> <span class="fl">12.49723970868507</span>]<span class="op">,</span></span>
<span id="cb20-8"><a href="#cb20-8" tabindex="-1"></a>  [<span class="fl">75.70357667713435</span><span class="op">,</span> <span class="fl">12.470171844429931</span>]<span class="op">,</span></span>
<span id="cb20-9"><a href="#cb20-9" tabindex="-1"></a>  [<span class="fl">75.7528434923199</span><span class="op">,</span> <span class="fl">12.470171844429931</span>]<span class="op">,</span></span>
<span id="cb20-10"><a href="#cb20-10" tabindex="-1"></a>  [<span class="fl">75.7528434923199</span><span class="op">,</span> <span class="fl">12.49723970868507</span>]</span>
<span id="cb20-11"><a href="#cb20-11" tabindex="-1"></a>]])<span class="op">;</span></span>
<span id="cb20-12"><a href="#cb20-12" tabindex="-1"></a><span class="kw">var</span> dateOfIncident <span class="op">=</span> ee<span class="op">.</span><span class="at">Date</span><span class="op">.</span><span class="fu">fromYMD</span>(<span class="dv">2018</span><span class="op">,</span> <span class="dv">8</span><span class="op">,</span> <span class="dv">15</span>)<span class="op">;</span></span>
<span id="cb20-13"><a href="#cb20-13" tabindex="-1"></a></span>
<span id="cb20-14"><a href="#cb20-14" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">centerObject</span>(geometry)</span>
<span id="cb20-15"><a href="#cb20-15" tabindex="-1"></a></span>
<span id="cb20-16"><a href="#cb20-16" tabindex="-1"></a><span class="kw">var</span> beforeDateFilter <span class="op">=</span> ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">and</span>(</span>
<span id="cb20-17"><a href="#cb20-17" tabindex="-1"></a>  ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(dateOfIncident<span class="op">.</span><span class="fu">advance</span>(<span class="op">-</span><span class="dv">2</span><span class="op">,</span> <span class="st">&#39;year&#39;</span>)<span class="op">,</span> dateOfIncident)<span class="op">,</span></span>
<span id="cb20-18"><a href="#cb20-18" tabindex="-1"></a>  ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">calendarRange</span>(<span class="dv">6</span><span class="op">,</span> <span class="dv">10</span><span class="op">,</span> <span class="st">&#39;month&#39;</span>))</span>
<span id="cb20-19"><a href="#cb20-19" tabindex="-1"></a></span>
<span id="cb20-20"><a href="#cb20-20" tabindex="-1"></a><span class="co">// The period after the landslides was comparitively</span></span>
<span id="cb20-21"><a href="#cb20-21" tabindex="-1"></a><span class="co">// cloud-free, so we obtain images from upto 1 month after.</span></span>
<span id="cb20-22"><a href="#cb20-22" tabindex="-1"></a><span class="kw">var</span> afterDateFilter <span class="op">=</span> ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(</span>
<span id="cb20-23"><a href="#cb20-23" tabindex="-1"></a>  dateOfIncident<span class="op">,</span> dateOfIncident<span class="op">.</span><span class="fu">advance</span>(<span class="dv">1</span><span class="op">,</span> <span class="st">&#39;month&#39;</span>))<span class="op">;</span></span>
<span id="cb20-24"><a href="#cb20-24" tabindex="-1"></a>  </span>
<span id="cb20-25"><a href="#cb20-25" tabindex="-1"></a><span class="co">// Apply the filters and get composites</span></span>
<span id="cb20-26"><a href="#cb20-26" tabindex="-1"></a></span>
<span id="cb20-27"><a href="#cb20-27" tabindex="-1"></a><span class="co">// Load the Dynamic World collection</span></span>
<span id="cb20-28"><a href="#cb20-28" tabindex="-1"></a><span class="kw">var</span> dw <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&#39;GOOGLE/DYNAMICWORLD/V1&#39;</span>)<span class="op">;</span></span>
<span id="cb20-29"><a href="#cb20-29" tabindex="-1"></a></span>
<span id="cb20-30"><a href="#cb20-30" tabindex="-1"></a><span class="kw">var</span> beforeDW <span class="op">=</span> dw</span>
<span id="cb20-31"><a href="#cb20-31" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(beforeDateFilter)</span>
<span id="cb20-32"><a href="#cb20-32" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">bounds</span>(geometry))</span>
<span id="cb20-33"><a href="#cb20-33" tabindex="-1"></a>  <span class="op">.</span><span class="fu">mean</span>()<span class="op">;</span></span>
<span id="cb20-34"><a href="#cb20-34" tabindex="-1"></a>  </span>
<span id="cb20-35"><a href="#cb20-35" tabindex="-1"></a><span class="kw">var</span> afterDW <span class="op">=</span> dw</span>
<span id="cb20-36"><a href="#cb20-36" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(afterDateFilter)</span>
<span id="cb20-37"><a href="#cb20-37" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">bounds</span>(geometry))</span>
<span id="cb20-38"><a href="#cb20-38" tabindex="-1"></a>  <span class="op">.</span><span class="fu">mean</span>()<span class="op">;</span></span>
<span id="cb20-39"><a href="#cb20-39" tabindex="-1"></a>  </span>
<span id="cb20-40"><a href="#cb20-40" tabindex="-1"></a><span class="co">// Load the Sentinel-2 collection </span></span>
<span id="cb20-41"><a href="#cb20-41" tabindex="-1"></a><span class="kw">var</span> s2 <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&#39;COPERNICUS/S2_HARMONIZED&#39;</span>)<span class="op">;</span></span>
<span id="cb20-42"><a href="#cb20-42" tabindex="-1"></a></span>
<span id="cb20-43"><a href="#cb20-43" tabindex="-1"></a></span>
<span id="cb20-44"><a href="#cb20-44" tabindex="-1"></a><span class="kw">var</span> filtered <span class="op">=</span> s2</span>
<span id="cb20-45"><a href="#cb20-45" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">bounds</span>(geometry))</span>
<span id="cb20-46"><a href="#cb20-46" tabindex="-1"></a>  <span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;B.*&#39;</span>)<span class="op">;</span></span>
<span id="cb20-47"><a href="#cb20-47" tabindex="-1"></a></span>
<span id="cb20-48"><a href="#cb20-48" tabindex="-1"></a><span class="co">// Load the Cloud Score+ collection</span></span>
<span id="cb20-49"><a href="#cb20-49" tabindex="-1"></a><span class="kw">var</span> csPlus <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&#39;GOOGLE/CLOUD_SCORE_PLUS/V1/S2_HARMONIZED&#39;</span>)<span class="op">;</span></span>
<span id="cb20-50"><a href="#cb20-50" tabindex="-1"></a><span class="kw">var</span> csPlusBands <span class="op">=</span> csPlus<span class="op">.</span><span class="fu">first</span>()<span class="op">.</span><span class="fu">bandNames</span>()<span class="op">;</span></span>
<span id="cb20-51"><a href="#cb20-51" tabindex="-1"></a></span>
<span id="cb20-52"><a href="#cb20-52" tabindex="-1"></a><span class="co">// We need to add Cloud Score + bands to each Sentinel-2</span></span>
<span id="cb20-53"><a href="#cb20-53" tabindex="-1"></a><span class="co">// image in the collection</span></span>
<span id="cb20-54"><a href="#cb20-54" tabindex="-1"></a><span class="co">// This is done using the linkCollection() function</span></span>
<span id="cb20-55"><a href="#cb20-55" tabindex="-1"></a><span class="kw">var</span> filteredS2WithCs <span class="op">=</span> filtered<span class="op">.</span><span class="fu">linkCollection</span>(csPlus<span class="op">,</span> csPlusBands)<span class="op">;</span></span>
<span id="cb20-56"><a href="#cb20-56" tabindex="-1"></a></span>
<span id="cb20-57"><a href="#cb20-57" tabindex="-1"></a><span class="co">// Function to mask pixels with low CS+ QA scores.</span></span>
<span id="cb20-58"><a href="#cb20-58" tabindex="-1"></a><span class="kw">function</span> <span class="fu">maskLowQA</span>(image) {</span>
<span id="cb20-59"><a href="#cb20-59" tabindex="-1"></a>  <span class="kw">var</span> qaBand <span class="op">=</span> <span class="st">&#39;cs&#39;</span><span class="op">;</span></span>
<span id="cb20-60"><a href="#cb20-60" tabindex="-1"></a>  <span class="kw">var</span> clearThreshold <span class="op">=</span> <span class="fl">0.65</span><span class="op">;</span></span>
<span id="cb20-61"><a href="#cb20-61" tabindex="-1"></a>  <span class="kw">var</span> mask <span class="op">=</span> image<span class="op">.</span><span class="fu">select</span>(qaBand)<span class="op">.</span><span class="fu">gte</span>(clearThreshold)<span class="op">;</span></span>
<span id="cb20-62"><a href="#cb20-62" tabindex="-1"></a>  <span class="cf">return</span> image<span class="op">.</span><span class="fu">updateMask</span>(mask)<span class="op">;</span></span>
<span id="cb20-63"><a href="#cb20-63" tabindex="-1"></a>}</span>
<span id="cb20-64"><a href="#cb20-64" tabindex="-1"></a></span>
<span id="cb20-65"><a href="#cb20-65" tabindex="-1"></a><span class="kw">var</span> filteredMasked <span class="op">=</span> filteredS2WithCs</span>
<span id="cb20-66"><a href="#cb20-66" tabindex="-1"></a>  <span class="op">.</span><span class="fu">map</span>(maskLowQA)<span class="op">;</span></span>
<span id="cb20-67"><a href="#cb20-67" tabindex="-1"></a>  </span>
<span id="cb20-68"><a href="#cb20-68" tabindex="-1"></a><span class="kw">var</span> beforeS2 <span class="op">=</span> filteredMasked</span>
<span id="cb20-69"><a href="#cb20-69" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(beforeDateFilter)</span>
<span id="cb20-70"><a href="#cb20-70" tabindex="-1"></a>  <span class="op">.</span><span class="fu">median</span>()<span class="op">;</span></span>
<span id="cb20-71"><a href="#cb20-71" tabindex="-1"></a></span>
<span id="cb20-72"><a href="#cb20-72" tabindex="-1"></a><span class="kw">var</span> afterS2 <span class="op">=</span> filteredMasked</span>
<span id="cb20-73"><a href="#cb20-73" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(afterDateFilter)</span>
<span id="cb20-74"><a href="#cb20-74" tabindex="-1"></a>  <span class="op">.</span><span class="fu">median</span>()<span class="op">;</span></span>
<span id="cb20-75"><a href="#cb20-75" tabindex="-1"></a></span>
<span id="cb20-76"><a href="#cb20-76" tabindex="-1"></a><span class="kw">var</span> rgbVis <span class="op">=</span> {<span class="dt">min</span><span class="op">:</span> <span class="fl">0.0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span> <span class="dv">3000</span><span class="op">,</span> <span class="dt">bands</span><span class="op">:</span> [<span class="st">&#39;B4&#39;</span><span class="op">,</span> <span class="st">&#39;B3&#39;</span><span class="op">,</span> <span class="st">&#39;B2&#39;</span>]<span class="op">,</span>}<span class="op">;</span></span>
<span id="cb20-77"><a href="#cb20-77" tabindex="-1"></a></span>
<span id="cb20-78"><a href="#cb20-78" tabindex="-1"></a><span class="co">//Map.centerObject(geometry, 13);</span></span>
<span id="cb20-79"><a href="#cb20-79" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(beforeS2<span class="op">.</span><span class="fu">clip</span>(geometry)<span class="op">,</span> rgbVis<span class="op">,</span> <span class="st">&#39;Before&#39;</span>)<span class="op">;</span></span>
<span id="cb20-80"><a href="#cb20-80" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(afterS2<span class="op">.</span><span class="fu">clip</span>(geometry)<span class="op">,</span> rgbVis<span class="op">,</span> <span class="st">&#39;After&#39;</span>)<span class="op">;</span></span>
<span id="cb20-81"><a href="#cb20-81" tabindex="-1"></a></span>
<span id="cb20-82"><a href="#cb20-82" tabindex="-1"></a><span class="kw">var</span> probabilityVis <span class="op">=</span> {</span>
<span id="cb20-83"><a href="#cb20-83" tabindex="-1"></a>  <span class="dt">min</span><span class="op">:</span><span class="dv">0</span><span class="op">,</span> </span>
<span id="cb20-84"><a href="#cb20-84" tabindex="-1"></a>  <span class="dt">max</span><span class="op">:</span><span class="fl">0.5</span><span class="op">,</span></span>
<span id="cb20-85"><a href="#cb20-85" tabindex="-1"></a>  <span class="dt">palette</span><span class="op">:</span> [<span class="st">&#39;#ffffd4&#39;</span><span class="op">,</span><span class="st">&#39;#fed98e&#39;</span><span class="op">,</span><span class="st">&#39;#fe9929&#39;</span><span class="op">,</span><span class="st">&#39;#d95f0e&#39;</span><span class="op">,</span><span class="st">&#39;#993404&#39;</span>]<span class="op">,</span></span>
<span id="cb20-86"><a href="#cb20-86" tabindex="-1"></a>  <span class="dt">bands</span><span class="op">:</span> [<span class="st">&#39;bare&#39;</span>]</span>
<span id="cb20-87"><a href="#cb20-87" tabindex="-1"></a>}</span>
<span id="cb20-88"><a href="#cb20-88" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(beforeDW<span class="op">.</span><span class="fu">clip</span>(geometry)<span class="op">,</span> probabilityVis<span class="op">,</span> <span class="st">&#39;Before Probabilities&#39;</span><span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span></span>
<span id="cb20-89"><a href="#cb20-89" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(afterDW<span class="op">.</span><span class="fu">clip</span>(geometry)<span class="op">,</span> probabilityVis<span class="op">,</span> <span class="st">&#39;After Probabilities&#39;</span><span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span></span>
<span id="cb20-90"><a href="#cb20-90" tabindex="-1"></a></span>
<span id="cb20-91"><a href="#cb20-91" tabindex="-1"></a><span class="co">// We define the landslide pixels where the &#39;bare&#39; probability</span></span>
<span id="cb20-92"><a href="#cb20-92" tabindex="-1"></a><span class="co">// has increased or &#39;trees&#39; probability has decreased</span></span>
<span id="cb20-93"><a href="#cb20-93" tabindex="-1"></a><span class="kw">var</span> bareThreshold <span class="op">=</span> <span class="fl">0.1</span><span class="op">;</span></span>
<span id="cb20-94"><a href="#cb20-94" tabindex="-1"></a><span class="kw">var</span> treesThreshold <span class="op">=</span> <span class="fl">0.2</span><span class="op">;</span></span>
<span id="cb20-95"><a href="#cb20-95" tabindex="-1"></a><span class="kw">var</span> bareChange <span class="op">=</span> afterDW<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;bare&#39;</span>)</span>
<span id="cb20-96"><a href="#cb20-96" tabindex="-1"></a>  <span class="op">.</span><span class="fu">subtract</span>(beforeDW<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;bare&#39;</span>))</span>
<span id="cb20-97"><a href="#cb20-97" tabindex="-1"></a>  <span class="op">.</span><span class="fu">gt</span>(bareThreshold)<span class="op">;</span></span>
<span id="cb20-98"><a href="#cb20-98" tabindex="-1"></a><span class="kw">var</span> treesChange <span class="op">=</span> beforeDW<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;trees&#39;</span>)</span>
<span id="cb20-99"><a href="#cb20-99" tabindex="-1"></a>  <span class="op">.</span><span class="fu">subtract</span>(afterDW<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;trees&#39;</span>))</span>
<span id="cb20-100"><a href="#cb20-100" tabindex="-1"></a>  <span class="op">.</span><span class="fu">gt</span>(treesThreshold)<span class="op">;</span></span>
<span id="cb20-101"><a href="#cb20-101" tabindex="-1"></a><span class="kw">var</span> change <span class="op">=</span> bareChange<span class="op">.</span><span class="fu">or</span>(treesChange)<span class="op">;</span></span>
<span id="cb20-102"><a href="#cb20-102" tabindex="-1"></a>  </span>
<span id="cb20-103"><a href="#cb20-103" tabindex="-1"></a><span class="kw">var</span> changeVis <span class="op">=</span> {<span class="dt">min</span><span class="op">:</span><span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span><span class="dv">1</span><span class="op">,</span> <span class="dt">palette</span><span class="op">:</span> [<span class="st">&#39;red&#39;</span>]}<span class="op">;</span></span>
<span id="cb20-104"><a href="#cb20-104" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(change<span class="op">.</span><span class="fu">selfMask</span>()<span class="op">.</span><span class="fu">clip</span>(geometry)<span class="op">,</span> changeVis<span class="op">,</span></span>
<span id="cb20-105"><a href="#cb20-105" tabindex="-1"></a>  <span class="st">&#39;Detected Landslides&#39;</span>)<span class="op">;</span></span></code></pre></div>
</div>
<div id="urban-growth-detection-using-dynamic-world"
class="section level2">
<h2>Urban Growth Detection using Dynamic World</h2>
<p><a
href="https://code.earthengine.google.co.in/?scriptPath=users%2Fujavalgandhi%2FEnd-to-End-GEE%3ASupplement%2FChange_Detection%2FDynamic_World_Urban_Growth"
target="_blank">Open in Code Editor ↗</a></p>
<div class="sourceCode" id="cb21"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb21-1"><a href="#cb21-1" tabindex="-1"></a><span class="co">// Urban Growth Change Detection using Dynamic World Probability Bands</span></span>
<span id="cb21-2"><a href="#cb21-2" tabindex="-1"></a></span>
<span id="cb21-3"><a href="#cb21-3" tabindex="-1"></a><span class="kw">var</span> geometry <span class="op">=</span> ee<span class="op">.</span><span class="at">Geometry</span><span class="op">.</span><span class="fu">Polygon</span>([[</span>
<span id="cb21-4"><a href="#cb21-4" tabindex="-1"></a>  [<span class="fl">77.43062052556523</span><span class="op">,</span> <span class="fl">13.103764122826366</span>]<span class="op">,</span></span>
<span id="cb21-5"><a href="#cb21-5" tabindex="-1"></a>  [<span class="fl">77.43062052556523</span><span class="op">,</span> <span class="fl">12.821384160047845</span>]<span class="op">,</span></span>
<span id="cb21-6"><a href="#cb21-6" tabindex="-1"></a>  [<span class="fl">77.7588370782996</span><span class="op">,</span> <span class="fl">12.821384160047845</span>]<span class="op">,</span></span>
<span id="cb21-7"><a href="#cb21-7" tabindex="-1"></a>  [<span class="fl">77.7588370782996</span><span class="op">,</span> <span class="fl">13.103764122826366</span>]</span>
<span id="cb21-8"><a href="#cb21-8" tabindex="-1"></a>]])<span class="op">;</span></span>
<span id="cb21-9"><a href="#cb21-9" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">centerObject</span>(geometry)<span class="op">;</span></span>
<span id="cb21-10"><a href="#cb21-10" tabindex="-1"></a></span>
<span id="cb21-11"><a href="#cb21-11" tabindex="-1"></a><span class="co">// Define the before and after time periods.</span></span>
<span id="cb21-12"><a href="#cb21-12" tabindex="-1"></a><span class="kw">var</span> beforeYear <span class="op">=</span> <span class="dv">2022</span><span class="op">;</span></span>
<span id="cb21-13"><a href="#cb21-13" tabindex="-1"></a><span class="kw">var</span> afterYear <span class="op">=</span> <span class="dv">2023</span><span class="op">;</span></span>
<span id="cb21-14"><a href="#cb21-14" tabindex="-1"></a></span>
<span id="cb21-15"><a href="#cb21-15" tabindex="-1"></a><span class="co">// Create start and end dates for the before and after periods.</span></span>
<span id="cb21-16"><a href="#cb21-16" tabindex="-1"></a><span class="kw">var</span> beforeStart <span class="op">=</span> ee<span class="op">.</span><span class="at">Date</span><span class="op">.</span><span class="fu">fromYMD</span>(beforeYear<span class="op">,</span> <span class="dv">1</span> <span class="op">,</span> <span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb21-17"><a href="#cb21-17" tabindex="-1"></a><span class="kw">var</span> beforeEnd <span class="op">=</span> beforeStart<span class="op">.</span><span class="fu">advance</span>(<span class="dv">1</span><span class="op">,</span> <span class="st">&#39;year&#39;</span>)<span class="op">;</span></span>
<span id="cb21-18"><a href="#cb21-18" tabindex="-1"></a></span>
<span id="cb21-19"><a href="#cb21-19" tabindex="-1"></a><span class="kw">var</span> afterStart <span class="op">=</span> ee<span class="op">.</span><span class="at">Date</span><span class="op">.</span><span class="fu">fromYMD</span>(afterYear<span class="op">,</span> <span class="dv">1</span> <span class="op">,</span> <span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb21-20"><a href="#cb21-20" tabindex="-1"></a><span class="kw">var</span> afterEnd <span class="op">=</span> afterStart<span class="op">.</span><span class="fu">advance</span>(<span class="dv">1</span><span class="op">,</span> <span class="st">&#39;year&#39;</span>)<span class="op">;</span></span>
<span id="cb21-21"><a href="#cb21-21" tabindex="-1"></a></span>
<span id="cb21-22"><a href="#cb21-22" tabindex="-1"></a><span class="co">// Load the Dynamic World collection</span></span>
<span id="cb21-23"><a href="#cb21-23" tabindex="-1"></a><span class="kw">var</span> dw <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&#39;GOOGLE/DYNAMICWORLD/V1&#39;</span>)</span>
<span id="cb21-24"><a href="#cb21-24" tabindex="-1"></a></span>
<span id="cb21-25"><a href="#cb21-25" tabindex="-1"></a><span class="co">// Filter the collection and select the &#39;built&#39; band.</span></span>
<span id="cb21-26"><a href="#cb21-26" tabindex="-1"></a><span class="kw">var</span> dwFiltered <span class="op">=</span> dw</span>
<span id="cb21-27"><a href="#cb21-27" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">bounds</span>(geometry))</span>
<span id="cb21-28"><a href="#cb21-28" tabindex="-1"></a>  <span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;built&#39;</span>)<span class="op">;</span></span>
<span id="cb21-29"><a href="#cb21-29" tabindex="-1"></a></span>
<span id="cb21-30"><a href="#cb21-30" tabindex="-1"></a><span class="co">// Create mean composites</span></span>
<span id="cb21-31"><a href="#cb21-31" tabindex="-1"></a><span class="kw">var</span> beforeDw <span class="op">=</span> dwFiltered<span class="op">.</span><span class="fu">filter</span>(</span>
<span id="cb21-32"><a href="#cb21-32" tabindex="-1"></a>  ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(beforeStart<span class="op">,</span> beforeEnd))<span class="op">.</span><span class="fu">mean</span>()<span class="op">;</span></span>
<span id="cb21-33"><a href="#cb21-33" tabindex="-1"></a>  </span>
<span id="cb21-34"><a href="#cb21-34" tabindex="-1"></a><span class="kw">var</span> afterDw <span class="op">=</span> dwFiltered<span class="op">.</span><span class="fu">filter</span>(</span>
<span id="cb21-35"><a href="#cb21-35" tabindex="-1"></a>  ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(afterStart<span class="op">,</span> afterEnd))<span class="op">.</span><span class="fu">mean</span>()<span class="op">;</span></span>
<span id="cb21-36"><a href="#cb21-36" tabindex="-1"></a></span>
<span id="cb21-37"><a href="#cb21-37" tabindex="-1"></a></span>
<span id="cb21-38"><a href="#cb21-38" tabindex="-1"></a><span class="co">// Add Sentinel-2 Composites to verify the results.</span></span>
<span id="cb21-39"><a href="#cb21-39" tabindex="-1"></a><span class="kw">var</span> s2 <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&#39;COPERNICUS/S2_HARMONIZED&#39;</span>)</span>
<span id="cb21-40"><a href="#cb21-40" tabindex="-1"></a>     <span class="op">.</span><span class="fu">filterBounds</span>(geometry)</span>
<span id="cb21-41"><a href="#cb21-41" tabindex="-1"></a>     <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">lt</span>(<span class="st">&#39;CLOUDY_PIXEL_PERCENTAGE&#39;</span><span class="op">,</span> <span class="dv">35</span>))<span class="op">;</span></span>
<span id="cb21-42"><a href="#cb21-42" tabindex="-1"></a></span>
<span id="cb21-43"><a href="#cb21-43" tabindex="-1"></a><span class="co">// Create a median composite from sentinel-2 images.</span></span>
<span id="cb21-44"><a href="#cb21-44" tabindex="-1"></a><span class="kw">var</span> beforeS2 <span class="op">=</span> s2<span class="op">.</span><span class="fu">filterDate</span>(beforeStart<span class="op">,</span> beforeEnd)<span class="op">.</span><span class="fu">median</span>()<span class="op">;</span></span>
<span id="cb21-45"><a href="#cb21-45" tabindex="-1"></a><span class="kw">var</span> afterS2 <span class="op">=</span> s2<span class="op">.</span><span class="fu">filterDate</span>(afterStart<span class="op">,</span> afterEnd)<span class="op">.</span><span class="fu">median</span>()<span class="op">;</span></span>
<span id="cb21-46"><a href="#cb21-46" tabindex="-1"></a>  </span>
<span id="cb21-47"><a href="#cb21-47" tabindex="-1"></a><span class="co">// Visualize images</span></span>
<span id="cb21-48"><a href="#cb21-48" tabindex="-1"></a><span class="kw">var</span> s2VisParams <span class="op">=</span> {<span class="dt">bands</span><span class="op">:</span> [<span class="st">&#39;B4&#39;</span><span class="op">,</span> <span class="st">&#39;B3&#39;</span><span class="op">,</span> <span class="st">&#39;B2&#39;</span>]<span class="op">,</span> <span class="dt">min</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span> <span class="dv">3000</span>}<span class="op">;</span></span>
<span id="cb21-49"><a href="#cb21-49" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">centerObject</span>(geometry<span class="op">,</span> <span class="dv">10</span>)<span class="op">;</span></span>
<span id="cb21-50"><a href="#cb21-50" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(beforeS2<span class="op">.</span><span class="fu">clip</span>(geometry)<span class="op">,</span> s2VisParams<span class="op">,</span> <span class="st">&#39;Before S2&#39;</span>)<span class="op">;</span></span>
<span id="cb21-51"><a href="#cb21-51" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(afterS2<span class="op">.</span><span class="fu">clip</span>(geometry)<span class="op">,</span> s2VisParams<span class="op">,</span> <span class="st">&#39;After S2&#39;</span>)<span class="op">;</span></span>
<span id="cb21-52"><a href="#cb21-52" tabindex="-1"></a></span>
<span id="cb21-53"><a href="#cb21-53" tabindex="-1"></a><span class="co">// Select all pixels that have experienced large change</span></span>
<span id="cb21-54"><a href="#cb21-54" tabindex="-1"></a><span class="co">// in &#39;built&#39; probbility</span></span>
<span id="cb21-55"><a href="#cb21-55" tabindex="-1"></a><span class="kw">var</span> builtChangeThreshold <span class="op">=</span> <span class="fl">0.3</span><span class="op">;</span> </span>
<span id="cb21-56"><a href="#cb21-56" tabindex="-1"></a><span class="kw">var</span> newUrban <span class="op">=</span> afterDw<span class="op">.</span><span class="fu">subtract</span>(beforeDw)<span class="op">.</span><span class="fu">gt</span>(builtChangeThreshold)<span class="op">;</span></span>
<span id="cb21-57"><a href="#cb21-57" tabindex="-1"></a></span>
<span id="cb21-58"><a href="#cb21-58" tabindex="-1"></a><span class="kw">var</span> changeVisParams <span class="op">=</span> {<span class="dt">min</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span> <span class="dv">1</span><span class="op">,</span> <span class="dt">palette</span><span class="op">:</span> [<span class="st">&#39;white&#39;</span><span class="op">,</span> <span class="st">&#39;red&#39;</span>]}<span class="op">;</span></span>
<span id="cb21-59"><a href="#cb21-59" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(newUrban<span class="op">.</span><span class="fu">clip</span>(geometry)<span class="op">,</span> changeVisParams<span class="op">,</span> <span class="st">&#39;New Urban&#39;</span>)<span class="op">;</span></span>
<span id="cb21-60"><a href="#cb21-60" tabindex="-1"></a></span>
<span id="cb21-61"><a href="#cb21-61" tabindex="-1"></a><span class="co">// Mask all pixels with 0 value using selfMask()</span></span>
<span id="cb21-62"><a href="#cb21-62" tabindex="-1"></a><span class="kw">var</span> newUrbanMasked <span class="op">=</span> newUrban<span class="op">.</span><span class="fu">selfMask</span>()<span class="op">;</span></span>
<span id="cb21-63"><a href="#cb21-63" tabindex="-1"></a></span>
<span id="cb21-64"><a href="#cb21-64" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(</span>
<span id="cb21-65"><a href="#cb21-65" tabindex="-1"></a>  newUrbanMasked<span class="op">.</span><span class="fu">clip</span>(geometry)<span class="op">,</span> changeVisParams<span class="op">,</span> <span class="st">&#39;New Urban (Masked)&#39;</span>)<span class="op">;</span></span>
<span id="cb21-66"><a href="#cb21-66" tabindex="-1"></a></span>
<span id="cb21-67"><a href="#cb21-67" tabindex="-1"></a><span class="co">// To ensure the masked values are set to NoData, </span></span>
<span id="cb21-68"><a href="#cb21-68" tabindex="-1"></a><span class="co">// we cast the image to float and clip to geomery</span></span>
<span id="cb21-69"><a href="#cb21-69" tabindex="-1"></a><span class="kw">var</span> newUrbanMaskedExport <span class="op">=</span> newUrbanMasked<span class="op">.</span><span class="fu">toFloat</span>()<span class="op">.</span><span class="fu">clip</span>(geometry)<span class="op">;</span></span>
<span id="cb21-70"><a href="#cb21-70" tabindex="-1"></a></span>
<span id="cb21-71"><a href="#cb21-71" tabindex="-1"></a>Export<span class="op">.</span><span class="at">image</span><span class="op">.</span><span class="fu">toDrive</span>({</span>
<span id="cb21-72"><a href="#cb21-72" tabindex="-1"></a>  <span class="dt">image</span><span class="op">:</span> newUrbanMaskedExport<span class="op">,</span></span>
<span id="cb21-73"><a href="#cb21-73" tabindex="-1"></a>  <span class="dt">description</span><span class="op">:</span> <span class="st">&#39;New_Urban_Areas_&#39;</span> <span class="op">+</span> beforeYear <span class="op">+</span> <span class="st">&#39;_&#39;</span> <span class="op">+</span> afterYear<span class="op">,</span></span>
<span id="cb21-74"><a href="#cb21-74" tabindex="-1"></a>  <span class="dt">folder</span><span class="op">:</span> <span class="st">&#39;earthengine&#39;</span><span class="op">,</span></span>
<span id="cb21-75"><a href="#cb21-75" tabindex="-1"></a>  <span class="dt">fileNamePrefix</span><span class="op">:</span> <span class="st">&#39;new_urban_areas_&#39;</span> <span class="op">+</span> beforeYear <span class="op">+</span> <span class="st">&#39;_&#39;</span> <span class="op">+</span> afterYear<span class="op">,</span></span>
<span id="cb21-76"><a href="#cb21-76" tabindex="-1"></a>  <span class="dt">region</span><span class="op">:</span> geometry<span class="op">,</span></span>
<span id="cb21-77"><a href="#cb21-77" tabindex="-1"></a>  <span class="dt">scale</span><span class="op">:</span> <span class="dv">10</span><span class="op">,</span></span>
<span id="cb21-78"><a href="#cb21-78" tabindex="-1"></a>  <span class="dt">maxPixels</span><span class="op">:</span> <span class="fl">1e10</span></span>
<span id="cb21-79"><a href="#cb21-79" tabindex="-1"></a>})<span class="op">;</span></span></code></pre></div>
</div>
<div id="conflict-mapping" class="section level2">
<h2>Conflict Mapping</h2>
<p>During the <a
href="https://en.wikipedia.org/wiki/2021_Israel%E2%80%93Palestine_crisis">Israel-Palestine
Crisis of 2021</a>, Gaza was bombed heavily during May 2021. We are able
to monitor and detect bombed sites using Sentinel-2 images captured
before and after the bombing. Jamon Van Den Hoek put together a <a
href="https://jamonvdh.users.earthengine.app/view/gaza-bomb-damage-analysis">Google
Earth Engine App</a> with his analysis of the bombing. The script below
is an adaptation with open-source code showing how to carry out such
mapping using change detection techniques.</p>
<p><a
href="https://code.earthengine.google.co.in/?scriptPath=users%2Fujavalgandhi%2FEnd-to-End-GEE%3ASupplement%2FChange_Detection%2FGaza_Conflict_Change_Detection_Index"
target="_blank">Open in Code Editor ↗</a></p>
<div class="sourceCode" id="cb22"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb22-1"><a href="#cb22-1" tabindex="-1"></a><span class="co">// Gaza bomb damage analysis</span></span>
<span id="cb22-2"><a href="#cb22-2" tabindex="-1"></a><span class="co">// Adapted from https://jamonvdh.users.earthengine.app/view/gaza-bomb-damage-analysis</span></span>
<span id="cb22-3"><a href="#cb22-3" tabindex="-1"></a><span class="co">// Original app by: Jamon Van Den Hoek</span></span>
<span id="cb22-4"><a href="#cb22-4" tabindex="-1"></a><span class="co">// Adapted code by: Ujaval Gandhi </span></span>
<span id="cb22-5"><a href="#cb22-5" tabindex="-1"></a></span>
<span id="cb22-6"><a href="#cb22-6" tabindex="-1"></a><span class="kw">var</span> gaul <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">&quot;FAO/GAUL/2015/level0&quot;</span>)<span class="op">;</span></span>
<span id="cb22-7"><a href="#cb22-7" tabindex="-1"></a><span class="kw">var</span> gaza <span class="op">=</span> gaul<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;ADM0_NAME&#39;</span><span class="op">,</span> <span class="st">&#39;Gaza Strip&#39;</span>))</span>
<span id="cb22-8"><a href="#cb22-8" tabindex="-1"></a><span class="kw">var</span> geometry <span class="op">=</span> gaza<span class="op">.</span><span class="fu">geometry</span>()</span>
<span id="cb22-9"><a href="#cb22-9" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">setCenter</span>(<span class="fl">34.45</span><span class="op">,</span> <span class="fl">31.5</span><span class="op">,</span> <span class="dv">14</span>)</span>
<span id="cb22-10"><a href="#cb22-10" tabindex="-1"></a></span>
<span id="cb22-11"><a href="#cb22-11" tabindex="-1"></a></span>
<span id="cb22-12"><a href="#cb22-12" tabindex="-1"></a><span class="kw">var</span> s2 <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&quot;COPERNICUS/S2_HARMONIZED&quot;</span>)</span>
<span id="cb22-13"><a href="#cb22-13" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">bounds</span>(geometry))</span>
<span id="cb22-14"><a href="#cb22-14" tabindex="-1"></a> </span>
<span id="cb22-15"><a href="#cb22-15" tabindex="-1"></a><span class="co">// Load the Cloud Score+ collection</span></span>
<span id="cb22-16"><a href="#cb22-16" tabindex="-1"></a><span class="kw">var</span> csPlus <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&#39;GOOGLE/CLOUD_SCORE_PLUS/V1/S2_HARMONIZED&#39;</span>)<span class="op">;</span></span>
<span id="cb22-17"><a href="#cb22-17" tabindex="-1"></a><span class="kw">var</span> csPlusBands <span class="op">=</span> csPlus<span class="op">.</span><span class="fu">first</span>()<span class="op">.</span><span class="fu">bandNames</span>()<span class="op">;</span></span>
<span id="cb22-18"><a href="#cb22-18" tabindex="-1"></a></span>
<span id="cb22-19"><a href="#cb22-19" tabindex="-1"></a><span class="co">// We need to add Cloud Score + bands to each Sentinel-2</span></span>
<span id="cb22-20"><a href="#cb22-20" tabindex="-1"></a><span class="co">// image in the collection</span></span>
<span id="cb22-21"><a href="#cb22-21" tabindex="-1"></a><span class="co">// This is done using the linkCollection() function</span></span>
<span id="cb22-22"><a href="#cb22-22" tabindex="-1"></a><span class="kw">var</span> filteredS2WithCs <span class="op">=</span> s2<span class="op">.</span><span class="fu">linkCollection</span>(csPlus<span class="op">,</span> csPlusBands)<span class="op">;</span></span>
<span id="cb22-23"><a href="#cb22-23" tabindex="-1"></a></span>
<span id="cb22-24"><a href="#cb22-24" tabindex="-1"></a><span class="co">// Function to mask pixels with low CS+ QA scores.</span></span>
<span id="cb22-25"><a href="#cb22-25" tabindex="-1"></a><span class="kw">function</span> <span class="fu">maskLowQA</span>(image) {</span>
<span id="cb22-26"><a href="#cb22-26" tabindex="-1"></a>  <span class="kw">var</span> qaBand <span class="op">=</span> <span class="st">&#39;cs&#39;</span><span class="op">;</span></span>
<span id="cb22-27"><a href="#cb22-27" tabindex="-1"></a>  <span class="kw">var</span> clearThreshold <span class="op">=</span> <span class="fl">0.5</span><span class="op">;</span></span>
<span id="cb22-28"><a href="#cb22-28" tabindex="-1"></a>  <span class="kw">var</span> mask <span class="op">=</span> image<span class="op">.</span><span class="fu">select</span>(qaBand)<span class="op">.</span><span class="fu">gte</span>(clearThreshold)<span class="op">;</span></span>
<span id="cb22-29"><a href="#cb22-29" tabindex="-1"></a>  <span class="cf">return</span> image<span class="op">.</span><span class="fu">updateMask</span>(mask)<span class="op">;</span></span>
<span id="cb22-30"><a href="#cb22-30" tabindex="-1"></a>}</span>
<span id="cb22-31"><a href="#cb22-31" tabindex="-1"></a></span>
<span id="cb22-32"><a href="#cb22-32" tabindex="-1"></a></span>
<span id="cb22-33"><a href="#cb22-33" tabindex="-1"></a><span class="kw">var</span> filteredMasked <span class="op">=</span> filteredS2WithCs</span>
<span id="cb22-34"><a href="#cb22-34" tabindex="-1"></a>  <span class="op">.</span><span class="fu">map</span>(maskLowQA)<span class="op">;</span></span>
<span id="cb22-35"><a href="#cb22-35" tabindex="-1"></a></span>
<span id="cb22-36"><a href="#cb22-36" tabindex="-1"></a><span class="kw">var</span> beforeDate  <span class="op">=</span> ee<span class="op">.</span><span class="fu">Date</span>(<span class="st">&#39;2021-05-10&#39;</span>)</span>
<span id="cb22-37"><a href="#cb22-37" tabindex="-1"></a><span class="kw">var</span> afterDate <span class="op">=</span> ee<span class="op">.</span><span class="fu">Date</span>(<span class="st">&#39;2021-05-15&#39;</span>)</span>
<span id="cb22-38"><a href="#cb22-38" tabindex="-1"></a></span>
<span id="cb22-39"><a href="#cb22-39" tabindex="-1"></a><span class="kw">var</span> before <span class="op">=</span> filteredMasked<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(beforeDate<span class="op">,</span> beforeDate<span class="op">.</span><span class="fu">advance</span>(<span class="dv">1</span><span class="op">,</span> <span class="st">&#39;day&#39;</span>)))</span>
<span id="cb22-40"><a href="#cb22-40" tabindex="-1"></a><span class="kw">var</span> beforeComposite <span class="op">=</span> before<span class="op">.</span><span class="fu">median</span>()</span>
<span id="cb22-41"><a href="#cb22-41" tabindex="-1"></a></span>
<span id="cb22-42"><a href="#cb22-42" tabindex="-1"></a><span class="kw">var</span> after <span class="op">=</span> filteredMasked<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(afterDate<span class="op">,</span> afterDate<span class="op">.</span><span class="fu">advance</span>(<span class="dv">1</span><span class="op">,</span> <span class="st">&#39;day&#39;</span>)))</span>
<span id="cb22-43"><a href="#cb22-43" tabindex="-1"></a></span>
<span id="cb22-44"><a href="#cb22-44" tabindex="-1"></a><span class="kw">var</span> afterComposite <span class="op">=</span> after<span class="op">.</span><span class="fu">median</span>()</span>
<span id="cb22-45"><a href="#cb22-45" tabindex="-1"></a></span>
<span id="cb22-46"><a href="#cb22-46" tabindex="-1"></a><span class="kw">var</span> rgbVis <span class="op">=</span> {<span class="dt">min</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span> <span class="dv">3000</span><span class="op">,</span> <span class="dt">bands</span><span class="op">:</span> [<span class="st">&#39;B4&#39;</span><span class="op">,</span> <span class="st">&#39;B3&#39;</span><span class="op">,</span> <span class="st">&#39;B2&#39;</span>]}<span class="op">;</span></span>
<span id="cb22-47"><a href="#cb22-47" tabindex="-1"></a><span class="kw">var</span> nrgVis <span class="op">=</span> {<span class="dt">min</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span> <span class="dv">3000</span><span class="op">,</span> <span class="dt">bands</span><span class="op">:</span> [<span class="st">&#39;B8&#39;</span><span class="op">,</span> <span class="st">&#39;B4&#39;</span><span class="op">,</span> <span class="st">&#39;B3&#39;</span>]}<span class="op">;</span></span>
<span id="cb22-48"><a href="#cb22-48" tabindex="-1"></a></span>
<span id="cb22-49"><a href="#cb22-49" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(beforeComposite<span class="op">.</span><span class="fu">clip</span>(geometry)<span class="op">,</span> rgbVis<span class="op">,</span> <span class="st">&#39;Before&#39;</span>)</span>
<span id="cb22-50"><a href="#cb22-50" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(afterComposite<span class="op">.</span><span class="fu">clip</span>(geometry)<span class="op">,</span> rgbVis<span class="op">,</span> <span class="st">&#39;After&#39;</span>)</span>
<span id="cb22-51"><a href="#cb22-51" tabindex="-1"></a></span>
<span id="cb22-52"><a href="#cb22-52" tabindex="-1"></a><span class="kw">var</span> addIndices <span class="op">=</span> <span class="kw">function</span>(image) {</span>
<span id="cb22-53"><a href="#cb22-53" tabindex="-1"></a>  <span class="kw">var</span> nbr <span class="op">=</span> image<span class="op">.</span><span class="fu">normalizedDifference</span>([<span class="st">&#39;B8&#39;</span><span class="op">,</span> <span class="st">&#39;B12&#39;</span>])<span class="op">.</span><span class="fu">rename</span>([<span class="st">&#39;nbr&#39;</span>])<span class="op">;</span></span>
<span id="cb22-54"><a href="#cb22-54" tabindex="-1"></a>  <span class="kw">var</span> ndvi <span class="op">=</span> image<span class="op">.</span><span class="fu">normalizedDifference</span>([<span class="st">&#39;B8&#39;</span><span class="op">,</span> <span class="st">&#39;B4&#39;</span>])<span class="op">.</span><span class="fu">rename</span>([<span class="st">&#39;ndvi&#39;</span>])</span>
<span id="cb22-55"><a href="#cb22-55" tabindex="-1"></a>  <span class="cf">return</span> image<span class="op">.</span><span class="fu">addBands</span>(nbr)<span class="op">.</span><span class="fu">addBands</span>(ndvi)<span class="op">;</span></span>
<span id="cb22-56"><a href="#cb22-56" tabindex="-1"></a>}</span>
<span id="cb22-57"><a href="#cb22-57" tabindex="-1"></a></span>
<span id="cb22-58"><a href="#cb22-58" tabindex="-1"></a><span class="co">// You can try change detection with either NBR or NDVI</span></span>
<span id="cb22-59"><a href="#cb22-59" tabindex="-1"></a><span class="kw">var</span> selectedIndex <span class="op">=</span> <span class="st">&#39;nbr&#39;</span><span class="op">;</span></span>
<span id="cb22-60"><a href="#cb22-60" tabindex="-1"></a><span class="kw">var</span> beforeNbr <span class="op">=</span> <span class="fu">addIndices</span>(beforeComposite)<span class="op">.</span><span class="fu">select</span>(selectedIndex)<span class="op">;</span></span>
<span id="cb22-61"><a href="#cb22-61" tabindex="-1"></a><span class="kw">var</span> afterNbr <span class="op">=</span> <span class="fu">addIndices</span>(afterComposite)<span class="op">.</span><span class="fu">select</span>(selectedIndex)<span class="op">;</span></span>
<span id="cb22-62"><a href="#cb22-62" tabindex="-1"></a></span>
<span id="cb22-63"><a href="#cb22-63" tabindex="-1"></a><span class="co">// Change in Index</span></span>
<span id="cb22-64"><a href="#cb22-64" tabindex="-1"></a><span class="kw">var</span> difference <span class="op">=</span> beforeNbr<span class="op">.</span><span class="fu">subtract</span>(afterNbr)<span class="op">.</span><span class="fu">clip</span>(geometry)</span>
<span id="cb22-65"><a href="#cb22-65" tabindex="-1"></a></span>
<span id="cb22-66"><a href="#cb22-66" tabindex="-1"></a><span class="kw">var</span> indexThreshold <span class="op">=</span> <span class="fl">0.25</span><span class="op">;</span></span>
<span id="cb22-67"><a href="#cb22-67" tabindex="-1"></a><span class="kw">var</span> change <span class="op">=</span> difference<span class="op">.</span><span class="fu">gt</span>(indexThreshold)</span>
<span id="cb22-68"><a href="#cb22-68" tabindex="-1"></a></span>
<span id="cb22-69"><a href="#cb22-69" tabindex="-1"></a><span class="co">// Mask Waterbodies using WorldCover</span></span>
<span id="cb22-70"><a href="#cb22-70" tabindex="-1"></a><span class="kw">var</span> classification <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&quot;ESA/WorldCover/v100&quot;</span>)<span class="op">.</span><span class="fu">first</span>()<span class="op">;</span></span>
<span id="cb22-71"><a href="#cb22-71" tabindex="-1"></a><span class="kw">var</span> water <span class="op">=</span> classification<span class="op">.</span><span class="fu">eq</span>(<span class="dv">80</span>)</span>
<span id="cb22-72"><a href="#cb22-72" tabindex="-1"></a><span class="kw">var</span> change <span class="op">=</span> change<span class="op">.</span><span class="fu">updateMask</span>(water<span class="op">.</span><span class="fu">not</span>())</span>
<span id="cb22-73"><a href="#cb22-73" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(change<span class="op">.</span><span class="fu">selfMask</span>()<span class="op">,</span> {<span class="dt">min</span><span class="op">:</span><span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span> <span class="dv">1</span><span class="op">,</span> <span class="dt">palette</span><span class="op">:</span> [<span class="st">&#39;orange&#39;</span>]} <span class="op">,</span> <span class="st">&#39;Detected Change&#39;</span>)</span>
<span id="cb22-74"><a href="#cb22-74" tabindex="-1"></a></span>
<span id="cb22-75"><a href="#cb22-75" tabindex="-1"></a><span class="kw">var</span> minArea <span class="op">=</span> <span class="dv">300</span></span>
<span id="cb22-76"><a href="#cb22-76" tabindex="-1"></a><span class="kw">var</span> maxArea <span class="op">=</span> <span class="dv">50000</span></span>
<span id="cb22-77"><a href="#cb22-77" tabindex="-1"></a><span class="co">// S2 resolution is 10m</span></span>
<span id="cb22-78"><a href="#cb22-78" tabindex="-1"></a><span class="kw">var</span> minPixels <span class="op">=</span> ee<span class="op">.</span><span class="fu">Number</span>(minArea)<span class="op">.</span><span class="fu">divide</span>(<span class="dv">100</span>)</span>
<span id="cb22-79"><a href="#cb22-79" tabindex="-1"></a><span class="kw">var</span> maxPixels <span class="op">=</span> ee<span class="op">.</span><span class="fu">Number</span>(maxArea)<span class="op">.</span><span class="fu">divide</span>(<span class="dv">100</span>)</span>
<span id="cb22-80"><a href="#cb22-80" tabindex="-1"></a></span>
<span id="cb22-81"><a href="#cb22-81" tabindex="-1"></a><span class="kw">var</span> change <span class="op">=</span> change</span>
<span id="cb22-82"><a href="#cb22-82" tabindex="-1"></a><span class="kw">var</span> connections <span class="op">=</span> change<span class="op">.</span><span class="fu">connectedPixelCount</span>(maxPixels<span class="op">.</span><span class="fu">add</span>(<span class="dv">10</span>))</span>
<span id="cb22-83"><a href="#cb22-83" tabindex="-1"></a></span>
<span id="cb22-84"><a href="#cb22-84" tabindex="-1"></a><span class="kw">var</span> masked <span class="op">=</span> change</span>
<span id="cb22-85"><a href="#cb22-85" tabindex="-1"></a>  <span class="op">.</span><span class="fu">updateMask</span>(connections<span class="op">.</span><span class="fu">gt</span>(minPixels)<span class="op">.</span><span class="fu">and</span>(connections<span class="op">.</span><span class="fu">lte</span>(maxPixels)))</span>
<span id="cb22-86"><a href="#cb22-86" tabindex="-1"></a></span>
<span id="cb22-87"><a href="#cb22-87" tabindex="-1"></a><span class="kw">var</span> vectors <span class="op">=</span> masked<span class="op">.</span><span class="fu">selfMask</span>()<span class="op">.</span><span class="fu">reduceToVectors</span>({</span>
<span id="cb22-88"><a href="#cb22-88" tabindex="-1"></a>  <span class="dt">scale</span><span class="op">:</span> <span class="dv">10</span><span class="op">,</span></span>
<span id="cb22-89"><a href="#cb22-89" tabindex="-1"></a>  <span class="dt">eightConnected</span><span class="op">:</span> <span class="kw">false</span><span class="op">,</span></span>
<span id="cb22-90"><a href="#cb22-90" tabindex="-1"></a>  <span class="dt">maxPixels</span><span class="op">:</span> <span class="fl">1e10</span>})</span>
<span id="cb22-91"><a href="#cb22-91" tabindex="-1"></a></span>
<span id="cb22-92"><a href="#cb22-92" tabindex="-1"></a><span class="co">// Paint all the polygon edges with the same number and width, display.</span></span>
<span id="cb22-93"><a href="#cb22-93" tabindex="-1"></a><span class="kw">var</span> colored <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>()<span class="op">.</span><span class="fu">byte</span>()<span class="op">.</span><span class="fu">paint</span>({</span>
<span id="cb22-94"><a href="#cb22-94" tabindex="-1"></a>  <span class="dt">featureCollection</span><span class="op">:</span> vectors<span class="op">,</span></span>
<span id="cb22-95"><a href="#cb22-95" tabindex="-1"></a>  <span class="dt">color</span><span class="op">:</span> <span class="dv">1</span><span class="op">,</span></span>
<span id="cb22-96"><a href="#cb22-96" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb22-97"><a href="#cb22-97" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(colored<span class="op">,</span> {<span class="dt">max</span><span class="op">:</span><span class="dv">1</span><span class="op">,</span> <span class="dt">palette</span><span class="op">:</span>[<span class="st">&#39;red&#39;</span>]} <span class="op">,</span> <span class="st">&#39;Detected Change (Filtered)&#39;</span>)</span>
<span id="cb22-98"><a href="#cb22-98" tabindex="-1"></a></span>
<span id="cb22-99"><a href="#cb22-99" tabindex="-1"></a><span class="kw">var</span> centroids <span class="op">=</span> vectors<span class="op">.</span><span class="fu">map</span>(<span class="kw">function</span>(f) {</span>
<span id="cb22-100"><a href="#cb22-100" tabindex="-1"></a>  <span class="cf">return</span> f<span class="op">.</span><span class="fu">centroid</span>({<span class="dt">maxError</span><span class="op">:</span><span class="dv">1</span>})</span>
<span id="cb22-101"><a href="#cb22-101" tabindex="-1"></a>})</span>
<span id="cb22-102"><a href="#cb22-102" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(centroids<span class="op">,</span> {<span class="dt">max</span><span class="op">:</span><span class="dv">1</span><span class="op">,</span> <span class="dt">color</span><span class="op">:</span> <span class="st">&#39;cyan&#39;</span>} <span class="op">,</span> <span class="st">&#39;Detected Site Centroids&#39;</span>)</span>
<span id="cb22-103"><a href="#cb22-103" tabindex="-1"></a></span>
<span id="cb22-104"><a href="#cb22-104" tabindex="-1"></a></span>
<span id="cb22-105"><a href="#cb22-105" tabindex="-1"></a>Export<span class="op">.</span><span class="at">table</span><span class="op">.</span><span class="fu">toDrive</span>({</span>
<span id="cb22-106"><a href="#cb22-106" tabindex="-1"></a>  <span class="dt">collection</span><span class="op">:</span> centroids<span class="op">,</span></span>
<span id="cb22-107"><a href="#cb22-107" tabindex="-1"></a>  <span class="dt">description</span><span class="op">:</span> <span class="st">&#39;Detected_Site_Centroids&#39;</span><span class="op">,</span></span>
<span id="cb22-108"><a href="#cb22-108" tabindex="-1"></a>  <span class="dt">folder</span><span class="op">:</span> <span class="st">&#39;earthengine&#39;</span><span class="op">,</span></span>
<span id="cb22-109"><a href="#cb22-109" tabindex="-1"></a>  <span class="dt">fileNamePrefix</span><span class="op">:</span> <span class="st">&#39;change_sites&#39;</span><span class="op">,</span></span>
<span id="cb22-110"><a href="#cb22-110" tabindex="-1"></a>  <span class="dt">fileFormat</span><span class="op">:</span> <span class="st">&#39;SHP&#39;</span>})</span></code></pre></div>
</div>
</div>
<div id="image-collection-processing" class="section level1">
<h1>Image Collection Processing</h1>
<div id="aggregating-and-visualizing-imagecollections"
class="section level2">
<h2>Aggregating and Visualizing ImageCollections</h2>
<p><a
href="https://code.earthengine.google.co.in/?scriptPath=users%2Fujavalgandhi%2FEnd-to-End-GEE%3ASupplement%2FImage_Collections%2FAggregating_and_Visualizing_ImageCollections"
target="_blank">Open in Code Editor ↗</a></p>
<div class="sourceCode" id="cb23"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb23-1"><a href="#cb23-1" tabindex="-1"></a><span class="co">// Script showing techniques for visualizing image collections</span></span>
<span id="cb23-2"><a href="#cb23-2" tabindex="-1"></a><span class="co">// using UI elements and animation.</span></span>
<span id="cb23-3"><a href="#cb23-3" tabindex="-1"></a></span>
<span id="cb23-4"><a href="#cb23-4" tabindex="-1"></a><span class="kw">var</span> admin2 <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">&quot;FAO/GAUL_SIMPLIFIED_500m/2015/level2&quot;</span>)<span class="op">;</span></span>
<span id="cb23-5"><a href="#cb23-5" tabindex="-1"></a><span class="kw">var</span> selected <span class="op">=</span> admin2</span>
<span id="cb23-6"><a href="#cb23-6" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;ADM1_NAME&#39;</span><span class="op">,</span> <span class="st">&#39;Karnataka&#39;</span>))</span>
<span id="cb23-7"><a href="#cb23-7" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;ADM2_NAME&#39;</span><span class="op">,</span> <span class="st">&#39;Bangalore Urban&#39;</span>))</span>
<span id="cb23-8"><a href="#cb23-8" tabindex="-1"></a><span class="kw">var</span> geometry <span class="op">=</span> selected<span class="op">.</span><span class="fu">geometry</span>()<span class="op">;</span></span>
<span id="cb23-9"><a href="#cb23-9" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">centerObject</span>(geometry)</span>
<span id="cb23-10"><a href="#cb23-10" tabindex="-1"></a></span>
<span id="cb23-11"><a href="#cb23-11" tabindex="-1"></a><span class="kw">var</span> s2 <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&quot;COPERNICUS/S2_HARMONIZED&quot;</span>)<span class="op">;</span></span>
<span id="cb23-12"><a href="#cb23-12" tabindex="-1"></a></span>
<span id="cb23-13"><a href="#cb23-13" tabindex="-1"></a><span class="kw">var</span> filtered <span class="op">=</span> s2</span>
<span id="cb23-14"><a href="#cb23-14" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">lt</span>(<span class="st">&#39;CLOUDY_PIXEL_PERCENTAGE&#39;</span><span class="op">,</span> <span class="dv">30</span>))</span>
<span id="cb23-15"><a href="#cb23-15" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">bounds</span>(geometry))<span class="op">;</span></span>
<span id="cb23-16"><a href="#cb23-16" tabindex="-1"></a></span>
<span id="cb23-17"><a href="#cb23-17" tabindex="-1"></a><span class="co">// Load the Cloud Score+ collection</span></span>
<span id="cb23-18"><a href="#cb23-18" tabindex="-1"></a><span class="kw">var</span> csPlus <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&#39;GOOGLE/CLOUD_SCORE_PLUS/V1/S2_HARMONIZED&#39;</span>)<span class="op">;</span></span>
<span id="cb23-19"><a href="#cb23-19" tabindex="-1"></a><span class="kw">var</span> csPlusBands <span class="op">=</span> csPlus<span class="op">.</span><span class="fu">first</span>()<span class="op">.</span><span class="fu">bandNames</span>()<span class="op">;</span></span>
<span id="cb23-20"><a href="#cb23-20" tabindex="-1"></a></span>
<span id="cb23-21"><a href="#cb23-21" tabindex="-1"></a><span class="co">// We need to add Cloud Score + bands to each Sentinel-2</span></span>
<span id="cb23-22"><a href="#cb23-22" tabindex="-1"></a><span class="co">// image in the collection</span></span>
<span id="cb23-23"><a href="#cb23-23" tabindex="-1"></a><span class="co">// This is done using the linkCollection() function</span></span>
<span id="cb23-24"><a href="#cb23-24" tabindex="-1"></a><span class="kw">var</span> filteredS2WithCs <span class="op">=</span> filtered<span class="op">.</span><span class="fu">linkCollection</span>(csPlus<span class="op">,</span> csPlusBands)<span class="op">;</span></span>
<span id="cb23-25"><a href="#cb23-25" tabindex="-1"></a></span>
<span id="cb23-26"><a href="#cb23-26" tabindex="-1"></a><span class="co">// Function to mask pixels with low CS+ QA scores.</span></span>
<span id="cb23-27"><a href="#cb23-27" tabindex="-1"></a><span class="kw">function</span> <span class="fu">maskLowQA</span>(image) {</span>
<span id="cb23-28"><a href="#cb23-28" tabindex="-1"></a>  <span class="kw">var</span> qaBand <span class="op">=</span> <span class="st">&#39;cs&#39;</span><span class="op">;</span></span>
<span id="cb23-29"><a href="#cb23-29" tabindex="-1"></a>  <span class="kw">var</span> clearThreshold <span class="op">=</span> <span class="fl">0.5</span><span class="op">;</span></span>
<span id="cb23-30"><a href="#cb23-30" tabindex="-1"></a>  <span class="kw">var</span> mask <span class="op">=</span> image<span class="op">.</span><span class="fu">select</span>(qaBand)<span class="op">.</span><span class="fu">gte</span>(clearThreshold)<span class="op">;</span></span>
<span id="cb23-31"><a href="#cb23-31" tabindex="-1"></a>  <span class="cf">return</span> image<span class="op">.</span><span class="fu">updateMask</span>(mask)<span class="op">;</span></span>
<span id="cb23-32"><a href="#cb23-32" tabindex="-1"></a>}</span>
<span id="cb23-33"><a href="#cb23-33" tabindex="-1"></a></span>
<span id="cb23-34"><a href="#cb23-34" tabindex="-1"></a></span>
<span id="cb23-35"><a href="#cb23-35" tabindex="-1"></a><span class="kw">var</span> filteredMasked <span class="op">=</span> filteredS2WithCs</span>
<span id="cb23-36"><a href="#cb23-36" tabindex="-1"></a>  <span class="op">.</span><span class="fu">map</span>(maskLowQA)<span class="op">;</span></span>
<span id="cb23-37"><a href="#cb23-37" tabindex="-1"></a></span>
<span id="cb23-38"><a href="#cb23-38" tabindex="-1"></a><span class="co">// Write a function to scale the bands</span></span>
<span id="cb23-39"><a href="#cb23-39" tabindex="-1"></a><span class="kw">var</span> scaleImage <span class="op">=</span> <span class="kw">function</span>(image) {</span>
<span id="cb23-40"><a href="#cb23-40" tabindex="-1"></a>  <span class="cf">return</span> image</span>
<span id="cb23-41"><a href="#cb23-41" tabindex="-1"></a>    <span class="op">.</span><span class="fu">multiply</span>(<span class="fl">0.0001</span>)</span>
<span id="cb23-42"><a href="#cb23-42" tabindex="-1"></a>    <span class="op">.</span><span class="fu">copyProperties</span>(image<span class="op">,</span> [<span class="st">&quot;system:time_start&quot;</span>])</span>
<span id="cb23-43"><a href="#cb23-43" tabindex="-1"></a>}</span>
<span id="cb23-44"><a href="#cb23-44" tabindex="-1"></a></span>
<span id="cb23-45"><a href="#cb23-45" tabindex="-1"></a><span class="kw">var</span> processedCol <span class="op">=</span> filteredMasked</span>
<span id="cb23-46"><a href="#cb23-46" tabindex="-1"></a>  <span class="op">.</span><span class="fu">map</span>(scaleImage)</span>
<span id="cb23-47"><a href="#cb23-47" tabindex="-1"></a></span>
<span id="cb23-48"><a href="#cb23-48" tabindex="-1"></a><span class="co">// Aggregate it to yearly composites</span></span>
<span id="cb23-49"><a href="#cb23-49" tabindex="-1"></a><span class="kw">var</span> years <span class="op">=</span> ee<span class="op">.</span><span class="at">List</span><span class="op">.</span><span class="fu">sequence</span>(<span class="dv">2017</span><span class="op">,</span> <span class="dv">2021</span>)<span class="op">;</span></span>
<span id="cb23-50"><a href="#cb23-50" tabindex="-1"></a></span>
<span id="cb23-51"><a href="#cb23-51" tabindex="-1"></a><span class="co">// Write a function to create yearly composites</span></span>
<span id="cb23-52"><a href="#cb23-52" tabindex="-1"></a><span class="kw">var</span> createYearlyComposite <span class="op">=</span> <span class="kw">function</span>(year) {</span>
<span id="cb23-53"><a href="#cb23-53" tabindex="-1"></a>  <span class="kw">var</span> startDate <span class="op">=</span> ee<span class="op">.</span><span class="at">Date</span><span class="op">.</span><span class="fu">fromYMD</span>(year<span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb23-54"><a href="#cb23-54" tabindex="-1"></a>  <span class="kw">var</span> endDate <span class="op">=</span> startDate<span class="op">.</span><span class="fu">advance</span>(<span class="dv">1</span><span class="op">,</span> <span class="st">&#39;year&#39;</span>)<span class="op">;</span></span>
<span id="cb23-55"><a href="#cb23-55" tabindex="-1"></a>  <span class="kw">var</span> yearImages <span class="op">=</span> processedCol<span class="op">.</span><span class="fu">filter</span>(</span>
<span id="cb23-56"><a href="#cb23-56" tabindex="-1"></a>      ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(startDate<span class="op">,</span> endDate))<span class="op">;</span></span>
<span id="cb23-57"><a href="#cb23-57" tabindex="-1"></a>  <span class="kw">var</span> yearComposite <span class="op">=</span> yearImages<span class="op">.</span><span class="fu">median</span>()<span class="op">;</span></span>
<span id="cb23-58"><a href="#cb23-58" tabindex="-1"></a>  <span class="cf">return</span> yearComposite<span class="op">.</span><span class="fu">set</span>({</span>
<span id="cb23-59"><a href="#cb23-59" tabindex="-1"></a>    <span class="st">&#39;system:time_start&#39;</span><span class="op">:</span> startDate<span class="op">.</span><span class="fu">millis</span>()<span class="op">,</span></span>
<span id="cb23-60"><a href="#cb23-60" tabindex="-1"></a>    <span class="st">&#39;system:time_end&#39;</span><span class="op">:</span> endDate<span class="op">.</span><span class="fu">millis</span>()<span class="op">,</span></span>
<span id="cb23-61"><a href="#cb23-61" tabindex="-1"></a>    <span class="st">&#39;year&#39;</span><span class="op">:</span> ee<span class="op">.</span><span class="fu">Number</span>(year)<span class="op">.</span><span class="fu">format</span>(<span class="st">&#39;%04d&#39;</span>)})</span>
<span id="cb23-62"><a href="#cb23-62" tabindex="-1"></a>}</span>
<span id="cb23-63"><a href="#cb23-63" tabindex="-1"></a></span>
<span id="cb23-64"><a href="#cb23-64" tabindex="-1"></a><span class="co">// map() the function to create composite for all years</span></span>
<span id="cb23-65"><a href="#cb23-65" tabindex="-1"></a><span class="kw">var</span> yearComposites <span class="op">=</span> years<span class="op">.</span><span class="fu">map</span>(createYearlyComposite)</span>
<span id="cb23-66"><a href="#cb23-66" tabindex="-1"></a></span>
<span id="cb23-67"><a href="#cb23-67" tabindex="-1"></a><span class="co">// Create an ImageCollection from yearly composites</span></span>
<span id="cb23-68"><a href="#cb23-68" tabindex="-1"></a><span class="kw">var</span> yearlyCol <span class="op">=</span> ee<span class="op">.</span><span class="at">ImageCollection</span><span class="op">.</span><span class="fu">fromImages</span>(yearComposites)</span>
<span id="cb23-69"><a href="#cb23-69" tabindex="-1"></a><span class="fu">print</span>(yearlyCol)<span class="op">;</span></span>
<span id="cb23-70"><a href="#cb23-70" tabindex="-1"></a></span>
<span id="cb23-71"><a href="#cb23-71" tabindex="-1"></a><span class="co">// Visualize the collection</span></span>
<span id="cb23-72"><a href="#cb23-72" tabindex="-1"></a><span class="kw">var</span> rgbVis <span class="op">=</span> {<span class="dt">min</span><span class="op">:</span> <span class="fl">0.0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span> <span class="fl">0.3</span><span class="op">,</span> <span class="dt">bands</span><span class="op">:</span> [<span class="st">&#39;B4&#39;</span><span class="op">,</span> <span class="st">&#39;B3&#39;</span><span class="op">,</span> <span class="st">&#39;B2&#39;</span>]}<span class="op">;</span></span>
<span id="cb23-73"><a href="#cb23-73" tabindex="-1"></a></span>
<span id="cb23-74"><a href="#cb23-74" tabindex="-1"></a><span class="co">// A simple way to visualize is to use ui.Select()</span></span>
<span id="cb23-75"><a href="#cb23-75" tabindex="-1"></a><span class="co">// Our collection has a unique &#39;year&#39; property</span></span>
<span id="cb23-76"><a href="#cb23-76" tabindex="-1"></a><span class="co">// Use that to create a dropdown</span></span>
<span id="cb23-77"><a href="#cb23-77" tabindex="-1"></a></span>
<span id="cb23-78"><a href="#cb23-78" tabindex="-1"></a><span class="co">// Display the image with the given year.</span></span>
<span id="cb23-79"><a href="#cb23-79" tabindex="-1"></a><span class="kw">var</span> display <span class="op">=</span> <span class="kw">function</span>(year) {</span>
<span id="cb23-80"><a href="#cb23-80" tabindex="-1"></a>  <span class="kw">var</span> filtered <span class="op">=</span> yearlyCol<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;year&#39;</span><span class="op">,</span> year))</span>
<span id="cb23-81"><a href="#cb23-81" tabindex="-1"></a>  <span class="kw">var</span> image <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(filtered<span class="op">.</span><span class="fu">first</span>())<span class="op">;</span></span>
<span id="cb23-82"><a href="#cb23-82" tabindex="-1"></a>  <span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(image<span class="op">.</span><span class="fu">clip</span>(geometry)<span class="op">,</span> rgbVis<span class="op">,</span> <span class="st">&#39;RGB_Composite_&#39;</span> <span class="op">+</span> year)</span>
<span id="cb23-83"><a href="#cb23-83" tabindex="-1"></a>}</span>
<span id="cb23-84"><a href="#cb23-84" tabindex="-1"></a></span>
<span id="cb23-85"><a href="#cb23-85" tabindex="-1"></a><span class="co">// Get the list of IDs and put them into a select</span></span>
<span id="cb23-86"><a href="#cb23-86" tabindex="-1"></a>yearlyCol<span class="op">.</span><span class="fu">aggregate_array</span>(<span class="st">&#39;year&#39;</span>)<span class="op">.</span><span class="fu">evaluate</span>(<span class="kw">function</span>(years) {</span>
<span id="cb23-87"><a href="#cb23-87" tabindex="-1"></a>  <span class="bu">Map</span><span class="op">.</span><span class="fu">add</span>(ui<span class="op">.</span><span class="fu">Select</span>({</span>
<span id="cb23-88"><a href="#cb23-88" tabindex="-1"></a>    <span class="dt">placeholder</span><span class="op">:</span> <span class="st">&#39;Select a year&#39;</span><span class="op">,</span></span>
<span id="cb23-89"><a href="#cb23-89" tabindex="-1"></a>    <span class="dt">items</span><span class="op">:</span> years<span class="op">,</span></span>
<span id="cb23-90"><a href="#cb23-90" tabindex="-1"></a>    <span class="dt">onChange</span><span class="op">:</span> display</span>
<span id="cb23-91"><a href="#cb23-91" tabindex="-1"></a>  }))</span>
<span id="cb23-92"><a href="#cb23-92" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb23-93"><a href="#cb23-93" tabindex="-1"></a></span>
<span id="cb23-94"><a href="#cb23-94" tabindex="-1"></a><span class="co">// Another way is to create an animation</span></span>
<span id="cb23-95"><a href="#cb23-95" tabindex="-1"></a></span>
<span id="cb23-96"><a href="#cb23-96" tabindex="-1"></a><span class="co">// Define a function to convert an image to an RGB visualization</span></span>
<span id="cb23-97"><a href="#cb23-97" tabindex="-1"></a><span class="co">// Clip the image and copy the system:time_start property</span></span>
<span id="cb23-98"><a href="#cb23-98" tabindex="-1"></a><span class="kw">var</span> visualizeImage <span class="op">=</span> <span class="kw">function</span>(image) {</span>
<span id="cb23-99"><a href="#cb23-99" tabindex="-1"></a>  <span class="cf">return</span> image<span class="op">.</span><span class="fu">visualize</span>(rgbVis)<span class="op">.</span><span class="fu">clip</span>(geometry)</span>
<span id="cb23-100"><a href="#cb23-100" tabindex="-1"></a>    <span class="op">.</span><span class="fu">copyProperties</span>(image<span class="op">,</span></span>
<span id="cb23-101"><a href="#cb23-101" tabindex="-1"></a>      [<span class="st">&#39;system:time_start&#39;</span><span class="op">,</span> <span class="st">&#39;system:time_end&#39;</span><span class="op">,</span> <span class="st">&#39;year&#39;</span>])</span>
<span id="cb23-102"><a href="#cb23-102" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb23-103"><a href="#cb23-103" tabindex="-1"></a></span>
<span id="cb23-104"><a href="#cb23-104" tabindex="-1"></a><span class="kw">var</span> visCol <span class="op">=</span> yearlyCol<span class="op">.</span><span class="fu">map</span>(visualizeImage)</span>
<span id="cb23-105"><a href="#cb23-105" tabindex="-1"></a></span>
<span id="cb23-106"><a href="#cb23-106" tabindex="-1"></a><span class="co">// Define arguments for animation function parameters.</span></span>
<span id="cb23-107"><a href="#cb23-107" tabindex="-1"></a><span class="kw">var</span> videoArgs <span class="op">=</span> {</span>
<span id="cb23-108"><a href="#cb23-108" tabindex="-1"></a>  <span class="dt">dimensions</span><span class="op">:</span> <span class="dv">768</span><span class="op">,</span></span>
<span id="cb23-109"><a href="#cb23-109" tabindex="-1"></a>  <span class="dt">region</span><span class="op">:</span> geometry<span class="op">,</span></span>
<span id="cb23-110"><a href="#cb23-110" tabindex="-1"></a>  <span class="dt">framesPerSecond</span><span class="op">:</span> <span class="dv">1</span><span class="op">,</span></span>
<span id="cb23-111"><a href="#cb23-111" tabindex="-1"></a>  <span class="dt">crs</span><span class="op">:</span> <span class="st">&#39;EPSG:3857&#39;</span><span class="op">,</span></span>
<span id="cb23-112"><a href="#cb23-112" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb23-113"><a href="#cb23-113" tabindex="-1"></a><span class="fu">print</span>(ui<span class="op">.</span><span class="fu">Thumbnail</span>(visCol<span class="op">,</span> videoArgs))<span class="op">;</span></span></code></pre></div>
</div>
<div id="exporting-imagecollections" class="section level2">
<h2>Exporting ImageCollections</h2>
<p><a
href="https://code.earthengine.google.co.in/?scriptPath=users%2Fujavalgandhi%2FEnd-to-End-GEE%3ASupplement%2FImage_Collections%2FExporting_ImageCollections"
target="_blank">Open in Code Editor ↗</a></p>
<div class="sourceCode" id="cb24"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb24-1"><a href="#cb24-1" tabindex="-1"></a><span class="co">// Example script showing how to export ImageCollections</span></span>
<span id="cb24-2"><a href="#cb24-2" tabindex="-1"></a><span class="co">// using client-side code for batch image exports.</span></span>
<span id="cb24-3"><a href="#cb24-3" tabindex="-1"></a></span>
<span id="cb24-4"><a href="#cb24-4" tabindex="-1"></a><span class="co">// This script shows 2 options for exporting ImageCollections</span></span>
<span id="cb24-5"><a href="#cb24-5" tabindex="-1"></a><span class="co">// Option 1: Export Individual Images to Drive</span></span>
<span id="cb24-6"><a href="#cb24-6" tabindex="-1"></a><span class="co">// Option 2: Export ImageCollection to Asset</span></span>
<span id="cb24-7"><a href="#cb24-7" tabindex="-1"></a></span>
<span id="cb24-8"><a href="#cb24-8" tabindex="-1"></a></span>
<span id="cb24-9"><a href="#cb24-9" tabindex="-1"></a><span class="co">// If you want to export large number of images, or</span></span>
<span id="cb24-10"><a href="#cb24-10" tabindex="-1"></a><span class="co">// want to automate batch exports, please check </span></span>
<span id="cb24-11"><a href="#cb24-11" tabindex="-1"></a><span class="co">// the notebook using Python API</span></span>
<span id="cb24-12"><a href="#cb24-12" tabindex="-1"></a><span class="co">// https://courses.spatialthoughts.com/end-to-end-gee.html#batch-exports</span></span>
<span id="cb24-13"><a href="#cb24-13" tabindex="-1"></a></span>
<span id="cb24-14"><a href="#cb24-14" tabindex="-1"></a><span class="co">// We create a NDVI time-series and export each</span></span>
<span id="cb24-15"><a href="#cb24-15" tabindex="-1"></a><span class="co">// image as a separate GeoTiff file</span></span>
<span id="cb24-16"><a href="#cb24-16" tabindex="-1"></a><span class="kw">var</span> s2 <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&quot;COPERNICUS/S2_HARMONIZED&quot;</span>)<span class="op">;</span></span>
<span id="cb24-17"><a href="#cb24-17" tabindex="-1"></a><span class="kw">var</span> geometry <span class="op">=</span> ee<span class="op">.</span><span class="at">Geometry</span><span class="op">.</span><span class="fu">Polygon</span>([[</span>
<span id="cb24-18"><a href="#cb24-18" tabindex="-1"></a>  [<span class="fl">82.60642647743225</span><span class="op">,</span> <span class="fl">27.16350437805251</span>]<span class="op">,</span></span>
<span id="cb24-19"><a href="#cb24-19" tabindex="-1"></a>  [<span class="fl">82.60984897613525</span><span class="op">,</span> <span class="fl">27.1618529901377</span>]<span class="op">,</span></span>
<span id="cb24-20"><a href="#cb24-20" tabindex="-1"></a>  [<span class="fl">82.61088967323303</span><span class="op">,</span> <span class="fl">27.163695288375266</span>]<span class="op">,</span></span>
<span id="cb24-21"><a href="#cb24-21" tabindex="-1"></a>  [<span class="fl">82.60757446289062</span><span class="op">,</span> <span class="fl">27.16517483230927</span>]</span>
<span id="cb24-22"><a href="#cb24-22" tabindex="-1"></a>]])<span class="op">;</span></span>
<span id="cb24-23"><a href="#cb24-23" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(geometry<span class="op">,</span> {<span class="dt">color</span><span class="op">:</span> <span class="st">&#39;red&#39;</span>}<span class="op">,</span> <span class="st">&#39;Farm&#39;</span>)</span>
<span id="cb24-24"><a href="#cb24-24" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">centerObject</span>(geometry)</span>
<span id="cb24-25"><a href="#cb24-25" tabindex="-1"></a><span class="kw">var</span> rgbVis <span class="op">=</span> {<span class="dt">min</span><span class="op">:</span> <span class="fl">0.0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span> <span class="dv">3000</span><span class="op">,</span> <span class="dt">bands</span><span class="op">:</span> [<span class="st">&#39;B4&#39;</span><span class="op">,</span> <span class="st">&#39;B3&#39;</span><span class="op">,</span> <span class="st">&#39;B2&#39;</span>]}<span class="op">;</span></span>
<span id="cb24-26"><a href="#cb24-26" tabindex="-1"></a></span>
<span id="cb24-27"><a href="#cb24-27" tabindex="-1"></a><span class="kw">var</span> filtered <span class="op">=</span> s2</span>
<span id="cb24-28"><a href="#cb24-28" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(<span class="st">&#39;2017-01-01&#39;</span><span class="op">,</span> <span class="st">&#39;2018-01-01&#39;</span>))</span>
<span id="cb24-29"><a href="#cb24-29" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">lt</span>(<span class="st">&#39;CLOUDY_PIXEL_PERCENTAGE&#39;</span><span class="op">,</span> <span class="dv">30</span>))</span>
<span id="cb24-30"><a href="#cb24-30" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">bounds</span>(geometry))</span>
<span id="cb24-31"><a href="#cb24-31" tabindex="-1"></a></span>
<span id="cb24-32"><a href="#cb24-32" tabindex="-1"></a><span class="co">// Load the Cloud Score+ collection</span></span>
<span id="cb24-33"><a href="#cb24-33" tabindex="-1"></a><span class="kw">var</span> csPlus <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&#39;GOOGLE/CLOUD_SCORE_PLUS/V1/S2_HARMONIZED&#39;</span>)<span class="op">;</span></span>
<span id="cb24-34"><a href="#cb24-34" tabindex="-1"></a><span class="kw">var</span> csPlusBands <span class="op">=</span> csPlus<span class="op">.</span><span class="fu">first</span>()<span class="op">.</span><span class="fu">bandNames</span>()<span class="op">;</span></span>
<span id="cb24-35"><a href="#cb24-35" tabindex="-1"></a></span>
<span id="cb24-36"><a href="#cb24-36" tabindex="-1"></a><span class="co">// We need to add Cloud Score + bands to each Sentinel-2</span></span>
<span id="cb24-37"><a href="#cb24-37" tabindex="-1"></a><span class="co">// image in the collection</span></span>
<span id="cb24-38"><a href="#cb24-38" tabindex="-1"></a><span class="co">// This is done using the linkCollection() function</span></span>
<span id="cb24-39"><a href="#cb24-39" tabindex="-1"></a><span class="kw">var</span> filteredS2WithCs <span class="op">=</span> filtered<span class="op">.</span><span class="fu">linkCollection</span>(csPlus<span class="op">,</span> csPlusBands)<span class="op">;</span></span>
<span id="cb24-40"><a href="#cb24-40" tabindex="-1"></a></span>
<span id="cb24-41"><a href="#cb24-41" tabindex="-1"></a><span class="co">// Function to mask pixels with low CS+ QA scores.</span></span>
<span id="cb24-42"><a href="#cb24-42" tabindex="-1"></a><span class="kw">function</span> <span class="fu">maskLowQA</span>(image) {</span>
<span id="cb24-43"><a href="#cb24-43" tabindex="-1"></a>  <span class="kw">var</span> qaBand <span class="op">=</span> <span class="st">&#39;cs&#39;</span><span class="op">;</span></span>
<span id="cb24-44"><a href="#cb24-44" tabindex="-1"></a>  <span class="kw">var</span> clearThreshold <span class="op">=</span> <span class="fl">0.5</span><span class="op">;</span></span>
<span id="cb24-45"><a href="#cb24-45" tabindex="-1"></a>  <span class="kw">var</span> mask <span class="op">=</span> image<span class="op">.</span><span class="fu">select</span>(qaBand)<span class="op">.</span><span class="fu">gte</span>(clearThreshold)<span class="op">;</span></span>
<span id="cb24-46"><a href="#cb24-46" tabindex="-1"></a>  <span class="cf">return</span> image<span class="op">.</span><span class="fu">updateMask</span>(mask)<span class="op">;</span></span>
<span id="cb24-47"><a href="#cb24-47" tabindex="-1"></a>}</span>
<span id="cb24-48"><a href="#cb24-48" tabindex="-1"></a></span>
<span id="cb24-49"><a href="#cb24-49" tabindex="-1"></a></span>
<span id="cb24-50"><a href="#cb24-50" tabindex="-1"></a><span class="kw">var</span> filteredMasked <span class="op">=</span> filteredS2WithCs</span>
<span id="cb24-51"><a href="#cb24-51" tabindex="-1"></a>  <span class="op">.</span><span class="fu">map</span>(maskLowQA)<span class="op">;</span></span>
<span id="cb24-52"><a href="#cb24-52" tabindex="-1"></a><span class="co">// Write a function that computes NDVI for an image and adds it as a band</span></span>
<span id="cb24-53"><a href="#cb24-53" tabindex="-1"></a><span class="kw">function</span> <span class="fu">addNDVI</span>(image) {</span>
<span id="cb24-54"><a href="#cb24-54" tabindex="-1"></a>  <span class="kw">var</span> ndvi <span class="op">=</span> image<span class="op">.</span><span class="fu">normalizedDifference</span>([<span class="st">&#39;B8&#39;</span><span class="op">,</span> <span class="st">&#39;B4&#39;</span>])<span class="op">.</span><span class="fu">rename</span>(<span class="st">&#39;ndvi&#39;</span>)<span class="op">;</span></span>
<span id="cb24-55"><a href="#cb24-55" tabindex="-1"></a>  <span class="cf">return</span> image<span class="op">.</span><span class="fu">addBands</span>(ndvi)<span class="op">;</span></span>
<span id="cb24-56"><a href="#cb24-56" tabindex="-1"></a>}</span>
<span id="cb24-57"><a href="#cb24-57" tabindex="-1"></a></span>
<span id="cb24-58"><a href="#cb24-58" tabindex="-1"></a><span class="co">// Map the function over the collection</span></span>
<span id="cb24-59"><a href="#cb24-59" tabindex="-1"></a><span class="kw">var</span> withNdvi <span class="op">=</span> filteredMasked<span class="op">.</span><span class="fu">map</span>(addNDVI)<span class="op">;</span></span>
<span id="cb24-60"><a href="#cb24-60" tabindex="-1"></a></span>
<span id="cb24-61"><a href="#cb24-61" tabindex="-1"></a><span class="kw">var</span> exportCol <span class="op">=</span> withNdvi<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;ndvi&#39;</span>)<span class="op">;</span></span>
<span id="cb24-62"><a href="#cb24-62" tabindex="-1"></a></span>
<span id="cb24-63"><a href="#cb24-63" tabindex="-1"></a><span class="co">// *************************************************************</span></span>
<span id="cb24-64"><a href="#cb24-64" tabindex="-1"></a><span class="co">// Option 1: Export Individual Images to Drive</span></span>
<span id="cb24-65"><a href="#cb24-65" tabindex="-1"></a><span class="co">// *************************************************************</span></span>
<span id="cb24-66"><a href="#cb24-66" tabindex="-1"></a></span>
<span id="cb24-67"><a href="#cb24-67" tabindex="-1"></a><span class="co">// The function below exports the images in the collection</span></span>
<span id="cb24-68"><a href="#cb24-68" tabindex="-1"></a><span class="co">// as individual GeoTIFF files to Google Drive</span></span>
<span id="cb24-69"><a href="#cb24-69" tabindex="-1"></a></span>
<span id="cb24-70"><a href="#cb24-70" tabindex="-1"></a><span class="co">// The key is to use &#39;evaluate()&#39; to asynchronously get a list</span></span>
<span id="cb24-71"><a href="#cb24-71" tabindex="-1"></a><span class="co">// if image ids and start an export task for each image</span></span>
<span id="cb24-72"><a href="#cb24-72" tabindex="-1"></a></span>
<span id="cb24-73"><a href="#cb24-73" tabindex="-1"></a><span class="kw">var</span> doExportDrive <span class="op">=</span> <span class="kw">function</span>() {</span>
<span id="cb24-74"><a href="#cb24-74" tabindex="-1"></a>  <span class="fu">print</span>(<span class="st">&#39;Working&#39;</span>)</span>
<span id="cb24-75"><a href="#cb24-75" tabindex="-1"></a>  <span class="kw">var</span> ids <span class="op">=</span> exportCol<span class="op">.</span><span class="fu">aggregate_array</span>(<span class="st">&#39;system:index&#39;</span>)<span class="op">;</span></span>
<span id="cb24-76"><a href="#cb24-76" tabindex="-1"></a>  <span class="co">// evaluate() will not block the UI and once the result is available</span></span>
<span id="cb24-77"><a href="#cb24-77" tabindex="-1"></a>  <span class="co">// will be passed-on to the callback function where we will call</span></span>
<span id="cb24-78"><a href="#cb24-78" tabindex="-1"></a>  <span class="co">// Export.image.toDrive()</span></span>
<span id="cb24-79"><a href="#cb24-79" tabindex="-1"></a>  ids<span class="op">.</span><span class="fu">evaluate</span>(<span class="kw">function</span>(imageIds) {</span>
<span id="cb24-80"><a href="#cb24-80" tabindex="-1"></a>    <span class="fu">print</span>(<span class="st">&#39;Total number of images&#39;</span><span class="op">,</span> imageIds<span class="op">.</span><span class="at">length</span>)<span class="op">;</span></span>
<span id="cb24-81"><a href="#cb24-81" tabindex="-1"></a>    <span class="fu">print</span>(<span class="st">&#39;Exporting now... (see Tasks tab)&#39;</span>)<span class="op">;</span></span>
<span id="cb24-82"><a href="#cb24-82" tabindex="-1"></a>    <span class="fu">print</span>(<span class="st">&#39;Tip: Use Ctrl+Click/Cmd+Click on tasks to skip confirmation.&#39;</span>)<span class="op">;</span></span>
<span id="cb24-83"><a href="#cb24-83" tabindex="-1"></a>    <span class="cf">for</span>(<span class="kw">var</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> imageIds<span class="op">.</span><span class="at">length</span><span class="op">;</span> i<span class="op">++</span>) {</span>
<span id="cb24-84"><a href="#cb24-84" tabindex="-1"></a>      </span>
<span id="cb24-85"><a href="#cb24-85" tabindex="-1"></a>      <span class="co">// Filter using the image id</span></span>
<span id="cb24-86"><a href="#cb24-86" tabindex="-1"></a>      <span class="kw">var</span> image <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(exportCol<span class="op">.</span><span class="fu">toList</span>(<span class="dv">1</span><span class="op">,</span> i)<span class="op">.</span><span class="fu">get</span>(<span class="dv">0</span>))<span class="op">;</span></span>
<span id="cb24-87"><a href="#cb24-87" tabindex="-1"></a></span>
<span id="cb24-88"><a href="#cb24-88" tabindex="-1"></a>      <span class="co">// Clip image to the geometry</span></span>
<span id="cb24-89"><a href="#cb24-89" tabindex="-1"></a>      Export<span class="op">.</span><span class="at">image</span><span class="op">.</span><span class="fu">toDrive</span>({</span>
<span id="cb24-90"><a href="#cb24-90" tabindex="-1"></a>        <span class="dt">image</span><span class="op">:</span> image<span class="op">.</span><span class="fu">clip</span>(geometry)<span class="op">,</span></span>
<span id="cb24-91"><a href="#cb24-91" tabindex="-1"></a>        <span class="dt">region</span><span class="op">:</span> geometry<span class="op">,</span></span>
<span id="cb24-92"><a href="#cb24-92" tabindex="-1"></a>        <span class="dt">scale</span><span class="op">:</span> <span class="dv">10</span><span class="op">,</span></span>
<span id="cb24-93"><a href="#cb24-93" tabindex="-1"></a>        <span class="dt">fileNamePrefix</span><span class="op">:</span> imageIds[i]<span class="op">,</span></span>
<span id="cb24-94"><a href="#cb24-94" tabindex="-1"></a>        <span class="dt">folder</span><span class="op">:</span> <span class="st">&#39;earthengine&#39;</span><span class="op">,</span></span>
<span id="cb24-95"><a href="#cb24-95" tabindex="-1"></a>        <span class="dt">description</span><span class="op">:</span> <span class="st">&#39;Export_Drive_&#39;</span> <span class="op">+</span> i <span class="op">+</span> <span class="st">&#39;_&#39;</span> <span class="op">+</span> imageIds[i]<span class="op">,</span></span>
<span id="cb24-96"><a href="#cb24-96" tabindex="-1"></a>      })</span>
<span id="cb24-97"><a href="#cb24-97" tabindex="-1"></a>      }</span>
<span id="cb24-98"><a href="#cb24-98" tabindex="-1"></a>  })</span>
<span id="cb24-99"><a href="#cb24-99" tabindex="-1"></a>  </span>
<span id="cb24-100"><a href="#cb24-100" tabindex="-1"></a>}</span>
<span id="cb24-101"><a href="#cb24-101" tabindex="-1"></a></span>
<span id="cb24-102"><a href="#cb24-102" tabindex="-1"></a><span class="fu">print</span>(<span class="st">&#39;Click button below to start export to Drive&#39;</span>)</span>
<span id="cb24-103"><a href="#cb24-103" tabindex="-1"></a><span class="kw">var</span> button <span class="op">=</span> ui<span class="op">.</span><span class="fu">Button</span>({<span class="dt">label</span><span class="op">:</span> <span class="st">&#39;Export to Drive&#39;</span><span class="op">,</span> <span class="dt">onClick</span><span class="op">:</span> doExportDrive})</span>
<span id="cb24-104"><a href="#cb24-104" tabindex="-1"></a><span class="fu">print</span>(button)</span>
<span id="cb24-105"><a href="#cb24-105" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">centerObject</span>(geometry)<span class="op">;</span></span>
<span id="cb24-106"><a href="#cb24-106" tabindex="-1"></a></span>
<span id="cb24-107"><a href="#cb24-107" tabindex="-1"></a><span class="co">// *************************************************************</span></span>
<span id="cb24-108"><a href="#cb24-108" tabindex="-1"></a><span class="co">// Option 2: Export ImageCollection to Asset</span></span>
<span id="cb24-109"><a href="#cb24-109" tabindex="-1"></a><span class="co">// *************************************************************</span></span>
<span id="cb24-110"><a href="#cb24-110" tabindex="-1"></a></span>
<span id="cb24-111"><a href="#cb24-111" tabindex="-1"></a><span class="co">// If you want to use the collection in another script</span></span>
<span id="cb24-112"><a href="#cb24-112" tabindex="-1"></a><span class="co">// it is better to export the images as assets.</span></span>
<span id="cb24-113"><a href="#cb24-113" tabindex="-1"></a></span>
<span id="cb24-114"><a href="#cb24-114" tabindex="-1"></a><span class="co">// This is also recommended for collections that require large</span></span>
<span id="cb24-115"><a href="#cb24-115" tabindex="-1"></a><span class="co">// computation and may time-out. Exporting to Asset will</span></span>
<span id="cb24-116"><a href="#cb24-116" tabindex="-1"></a><span class="co">// result in a pre-computed collection that can be imported and </span></span>
<span id="cb24-117"><a href="#cb24-117" tabindex="-1"></a><span class="co">// used without these errors.</span></span>
<span id="cb24-118"><a href="#cb24-118" tabindex="-1"></a></span>
<span id="cb24-119"><a href="#cb24-119" tabindex="-1"></a><span class="co">// First create a new empty collection</span></span>
<span id="cb24-120"><a href="#cb24-120" tabindex="-1"></a><span class="co">// Go to Assets Tab -&gt; New -&gt; Image collection</span></span>
<span id="cb24-121"><a href="#cb24-121" tabindex="-1"></a></span>
<span id="cb24-122"><a href="#cb24-122" tabindex="-1"></a><span class="co">// Once created, replace below with your own image collection id</span></span>
<span id="cb24-123"><a href="#cb24-123" tabindex="-1"></a><span class="kw">var</span> exportAssetColId <span class="op">=</span> <span class="st">&#39;users/ujavalgandhi/e2e/ndvi_col&#39;</span><span class="op">;</span></span>
<span id="cb24-124"><a href="#cb24-124" tabindex="-1"></a></span>
<span id="cb24-125"><a href="#cb24-125" tabindex="-1"></a><span class="co">// Next we will export images as assets into this collection</span></span>
<span id="cb24-126"><a href="#cb24-126" tabindex="-1"></a><span class="kw">var</span> doExportAsset <span class="op">=</span> <span class="kw">function</span>() {</span>
<span id="cb24-127"><a href="#cb24-127" tabindex="-1"></a>  <span class="fu">print</span>(<span class="st">&#39;Working&#39;</span>)<span class="op">;</span></span>
<span id="cb24-128"><a href="#cb24-128" tabindex="-1"></a>  <span class="kw">var</span> ids <span class="op">=</span> exportCol<span class="op">.</span><span class="fu">aggregate_array</span>(<span class="st">&#39;system:index&#39;</span>)<span class="op">;</span></span>
<span id="cb24-129"><a href="#cb24-129" tabindex="-1"></a>  <span class="co">// evaluate() will not block the UI and once the result is available</span></span>
<span id="cb24-130"><a href="#cb24-130" tabindex="-1"></a>  <span class="co">// will be passed-on to the callback function where we will call</span></span>
<span id="cb24-131"><a href="#cb24-131" tabindex="-1"></a>  <span class="co">// Export.image.toAsset()</span></span>
<span id="cb24-132"><a href="#cb24-132" tabindex="-1"></a>  ids<span class="op">.</span><span class="fu">evaluate</span>(<span class="kw">function</span>(imageIds) {</span>
<span id="cb24-133"><a href="#cb24-133" tabindex="-1"></a>    <span class="fu">print</span>(<span class="st">&#39;Total number of images&#39;</span><span class="op">,</span> imageIds<span class="op">.</span><span class="at">length</span>)<span class="op">;</span></span>
<span id="cb24-134"><a href="#cb24-134" tabindex="-1"></a>    <span class="fu">print</span>(<span class="st">&#39;Exporting now... (see Tasks tab)&#39;</span>)<span class="op">;</span></span>
<span id="cb24-135"><a href="#cb24-135" tabindex="-1"></a>    <span class="fu">print</span>(<span class="st">&#39;Tip: Use Ctrl+Click/Cmd+Click on tasks to skip confirmation.&#39;</span>)<span class="op">;</span></span>
<span id="cb24-136"><a href="#cb24-136" tabindex="-1"></a>    <span class="cf">for</span>(<span class="kw">var</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> imageIds<span class="op">.</span><span class="at">length</span><span class="op">;</span> i<span class="op">++</span>) {</span>
<span id="cb24-137"><a href="#cb24-137" tabindex="-1"></a>      </span>
<span id="cb24-138"><a href="#cb24-138" tabindex="-1"></a>      <span class="co">// Filter using the image id</span></span>
<span id="cb24-139"><a href="#cb24-139" tabindex="-1"></a>      <span class="kw">var</span> image <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(exportCol<span class="op">.</span><span class="fu">toList</span>(<span class="dv">1</span><span class="op">,</span> i)<span class="op">.</span><span class="fu">get</span>(<span class="dv">0</span>))<span class="op">;</span></span>
<span id="cb24-140"><a href="#cb24-140" tabindex="-1"></a></span>
<span id="cb24-141"><a href="#cb24-141" tabindex="-1"></a>      <span class="co">// Clip image to the geometry</span></span>
<span id="cb24-142"><a href="#cb24-142" tabindex="-1"></a>      Export<span class="op">.</span><span class="at">image</span><span class="op">.</span><span class="fu">toAsset</span>({</span>
<span id="cb24-143"><a href="#cb24-143" tabindex="-1"></a>        <span class="dt">image</span><span class="op">:</span> image<span class="op">.</span><span class="fu">clip</span>(geometry)<span class="op">,</span></span>
<span id="cb24-144"><a href="#cb24-144" tabindex="-1"></a>        <span class="dt">description</span><span class="op">:</span> <span class="st">&#39;Export_Asset_&#39;</span> <span class="op">+</span> i <span class="op">+</span> <span class="st">&#39;_&#39;</span> <span class="op">+</span> imageIds[i]<span class="op">,</span></span>
<span id="cb24-145"><a href="#cb24-145" tabindex="-1"></a>        <span class="dt">assetId</span><span class="op">:</span> exportAssetColId <span class="op">+</span> <span class="st">&#39;/&#39;</span> <span class="op">+</span> imageIds[i]<span class="op">,</span></span>
<span id="cb24-146"><a href="#cb24-146" tabindex="-1"></a>        <span class="dt">region</span><span class="op">:</span> geometry<span class="op">,</span></span>
<span id="cb24-147"><a href="#cb24-147" tabindex="-1"></a>        <span class="dt">scale</span><span class="op">:</span> <span class="dv">10</span></span>
<span id="cb24-148"><a href="#cb24-148" tabindex="-1"></a>      })<span class="op">;</span></span>
<span id="cb24-149"><a href="#cb24-149" tabindex="-1"></a>    }</span>
<span id="cb24-150"><a href="#cb24-150" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb24-151"><a href="#cb24-151" tabindex="-1"></a>  </span>
<span id="cb24-152"><a href="#cb24-152" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb24-153"><a href="#cb24-153" tabindex="-1"></a></span>
<span id="cb24-154"><a href="#cb24-154" tabindex="-1"></a><span class="fu">print</span>(<span class="st">&#39;Click button below to start export to Asset&#39;</span>)<span class="op">;</span></span>
<span id="cb24-155"><a href="#cb24-155" tabindex="-1"></a><span class="kw">var</span> button <span class="op">=</span> ui<span class="op">.</span><span class="fu">Button</span>({<span class="dt">label</span><span class="op">:</span> <span class="st">&#39;Export to Asset&#39;</span><span class="op">,</span> <span class="dt">onClick</span><span class="op">:</span> doExportAsset})<span class="op">;</span></span>
<span id="cb24-156"><a href="#cb24-156" tabindex="-1"></a><span class="fu">print</span>(button)<span class="op">;</span></span>
<span id="cb24-157"><a href="#cb24-157" tabindex="-1"></a></span>
<span id="cb24-158"><a href="#cb24-158" tabindex="-1"></a><span class="co">// Once all the exports finish, you can use the resulting collection</span></span>
<span id="cb24-159"><a href="#cb24-159" tabindex="-1"></a><span class="co">// in other scripts just like a regular GEE collection</span></span>
<span id="cb24-160"><a href="#cb24-160" tabindex="-1"></a><span class="kw">var</span> exportAssetCol <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(exportAssetColId)<span class="op">;</span></span></code></pre></div>
</div>
<div id="create-composites-at-regular-intervals" class="section level2">
<h2>Create Composites at Regular Intervals</h2>
<p><a
href="https://code.earthengine.google.co.in/?scriptPath=users%2Fujavalgandhi%2FEnd-to-End-GEE%3ASupplement%2FImage_Collections%2FInterval_Composites"
target="_blank">Open in Code Editor ↗</a></p>
<div class="sourceCode" id="cb25"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb25-1"><a href="#cb25-1" tabindex="-1"></a><span class="co">// Example script showing how to create composite images</span></span>
<span id="cb25-2"><a href="#cb25-2" tabindex="-1"></a><span class="co">// at regular intervals</span></span>
<span id="cb25-3"><a href="#cb25-3" tabindex="-1"></a></span>
<span id="cb25-4"><a href="#cb25-4" tabindex="-1"></a><span class="co">// Let&#39;s create 15-day composites</span></span>
<span id="cb25-5"><a href="#cb25-5" tabindex="-1"></a><span class="co">// Change the parameters below for custom intervals</span></span>
<span id="cb25-6"><a href="#cb25-6" tabindex="-1"></a><span class="co">// i.e. For monthly composites, use interval=1 and unit=&#39;month&#39;</span></span>
<span id="cb25-7"><a href="#cb25-7" tabindex="-1"></a></span>
<span id="cb25-8"><a href="#cb25-8" tabindex="-1"></a><span class="co">// Define the interval</span></span>
<span id="cb25-9"><a href="#cb25-9" tabindex="-1"></a><span class="kw">var</span> interval <span class="op">=</span> <span class="dv">15</span><span class="op">;</span></span>
<span id="cb25-10"><a href="#cb25-10" tabindex="-1"></a></span>
<span id="cb25-11"><a href="#cb25-11" tabindex="-1"></a><span class="co">// Define the unit of interval</span></span>
<span id="cb25-12"><a href="#cb25-12" tabindex="-1"></a><span class="co">// &#39;year&#39;, &#39;month&#39; &#39;week&#39;, &#39;day&#39;, &#39;hour&#39;, &#39;minute&#39;, or &#39;second&#39;.</span></span>
<span id="cb25-13"><a href="#cb25-13" tabindex="-1"></a><span class="kw">var</span> unit <span class="op">=</span> <span class="st">&#39;day&#39;</span><span class="op">;</span></span>
<span id="cb25-14"><a href="#cb25-14" tabindex="-1"></a> </span>
<span id="cb25-15"><a href="#cb25-15" tabindex="-1"></a><span class="co">// Define the period</span></span>
<span id="cb25-16"><a href="#cb25-16" tabindex="-1"></a><span class="kw">var</span> startDate <span class="op">=</span> ee<span class="op">.</span><span class="at">Date</span><span class="op">.</span><span class="fu">fromYMD</span>(<span class="dv">2023</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb25-17"><a href="#cb25-17" tabindex="-1"></a><span class="kw">var</span> endDate <span class="op">=</span> ee<span class="op">.</span><span class="at">Date</span><span class="op">.</span><span class="fu">fromYMD</span>(<span class="dv">2024</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb25-18"><a href="#cb25-18" tabindex="-1"></a></span>
<span id="cb25-19"><a href="#cb25-19" tabindex="-1"></a><span class="co">// Get the total units in the period</span></span>
<span id="cb25-20"><a href="#cb25-20" tabindex="-1"></a><span class="kw">var</span> totalUnits <span class="op">=</span> endDate<span class="op">.</span><span class="fu">difference</span>(startDate<span class="op">,</span> unit)<span class="op">;</span></span>
<span id="cb25-21"><a href="#cb25-21" tabindex="-1"></a><span class="fu">print</span>(<span class="st">&#39;Total &#39;</span> <span class="op">+</span> unit<span class="op">,</span> totalUnits)<span class="op">;</span></span>
<span id="cb25-22"><a href="#cb25-22" tabindex="-1"></a></span>
<span id="cb25-23"><a href="#cb25-23" tabindex="-1"></a><span class="co">// Create a list of dates at start of each interval</span></span>
<span id="cb25-24"><a href="#cb25-24" tabindex="-1"></a><span class="kw">var</span> intervals <span class="op">=</span> ee<span class="op">.</span><span class="at">List</span><span class="op">.</span><span class="fu">sequence</span>(<span class="dv">0</span><span class="op">,</span> totalUnits<span class="op">,</span> interval)<span class="op">;</span></span>
<span id="cb25-25"><a href="#cb25-25" tabindex="-1"></a></span>
<span id="cb25-26"><a href="#cb25-26" tabindex="-1"></a><span class="kw">var</span> startDates <span class="op">=</span> intervals<span class="op">.</span><span class="fu">map</span>(<span class="kw">function</span>(interval) {</span>
<span id="cb25-27"><a href="#cb25-27" tabindex="-1"></a>  <span class="kw">var</span> intervalStart <span class="op">=</span> startDate<span class="op">.</span><span class="fu">advance</span>(interval<span class="op">,</span> unit)<span class="op">;</span></span>
<span id="cb25-28"><a href="#cb25-28" tabindex="-1"></a>  <span class="cf">return</span> intervalStart<span class="op">;</span></span>
<span id="cb25-29"><a href="#cb25-29" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb25-30"><a href="#cb25-30" tabindex="-1"></a></span>
<span id="cb25-31"><a href="#cb25-31" tabindex="-1"></a><span class="fu">print</span>(<span class="st">&#39;Start dates for each interval&#39;</span><span class="op">,</span> startDates)<span class="op">;</span></span>
<span id="cb25-32"><a href="#cb25-32" tabindex="-1"></a></span>
<span id="cb25-33"><a href="#cb25-33" tabindex="-1"></a><span class="co">// Now we create the composites</span></span>
<span id="cb25-34"><a href="#cb25-34" tabindex="-1"></a></span>
<span id="cb25-35"><a href="#cb25-35" tabindex="-1"></a><span class="co">// Define collection and apply filters</span></span>
<span id="cb25-36"><a href="#cb25-36" tabindex="-1"></a><span class="kw">var</span> s2 <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&quot;COPERNICUS/S2_SR_HARMONIZED&quot;</span>)</span>
<span id="cb25-37"><a href="#cb25-37" tabindex="-1"></a><span class="kw">var</span> basin <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">&quot;WWF/HydroSHEDS/v1/Basins/hybas_7&quot;</span>)</span>
<span id="cb25-38"><a href="#cb25-38" tabindex="-1"></a><span class="kw">var</span> arkavathy <span class="op">=</span> basin<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;HYBAS_ID&#39;</span><span class="op">,</span> <span class="dv">4071139640</span>))</span>
<span id="cb25-39"><a href="#cb25-39" tabindex="-1"></a><span class="kw">var</span> geometry <span class="op">=</span> arkavathy<span class="op">.</span><span class="fu">geometry</span>()</span>
<span id="cb25-40"><a href="#cb25-40" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">centerObject</span>(geometry<span class="op">,</span> <span class="dv">11</span>)</span>
<span id="cb25-41"><a href="#cb25-41" tabindex="-1"></a></span>
<span id="cb25-42"><a href="#cb25-42" tabindex="-1"></a><span class="kw">var</span> filtered <span class="op">=</span> s2</span>
<span id="cb25-43"><a href="#cb25-43" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(startDate<span class="op">,</span> endDate))</span>
<span id="cb25-44"><a href="#cb25-44" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">bounds</span>(geometry))<span class="op">;</span></span>
<span id="cb25-45"><a href="#cb25-45" tabindex="-1"></a></span>
<span id="cb25-46"><a href="#cb25-46" tabindex="-1"></a><span class="co">// Load the Cloud Score+ collection</span></span>
<span id="cb25-47"><a href="#cb25-47" tabindex="-1"></a><span class="kw">var</span> csPlus <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&#39;GOOGLE/CLOUD_SCORE_PLUS/V1/S2_HARMONIZED&#39;</span>)<span class="op">;</span></span>
<span id="cb25-48"><a href="#cb25-48" tabindex="-1"></a><span class="kw">var</span> csPlusBands <span class="op">=</span> csPlus<span class="op">.</span><span class="fu">first</span>()<span class="op">.</span><span class="fu">bandNames</span>()<span class="op">;</span></span>
<span id="cb25-49"><a href="#cb25-49" tabindex="-1"></a></span>
<span id="cb25-50"><a href="#cb25-50" tabindex="-1"></a><span class="co">// We need to add Cloud Score + bands to each Sentinel-2</span></span>
<span id="cb25-51"><a href="#cb25-51" tabindex="-1"></a><span class="co">// image in the collection</span></span>
<span id="cb25-52"><a href="#cb25-52" tabindex="-1"></a><span class="co">// This is done using the linkCollection() function</span></span>
<span id="cb25-53"><a href="#cb25-53" tabindex="-1"></a><span class="kw">var</span> filteredS2WithCs <span class="op">=</span> filtered<span class="op">.</span><span class="fu">linkCollection</span>(csPlus<span class="op">,</span> csPlusBands)<span class="op">;</span></span>
<span id="cb25-54"><a href="#cb25-54" tabindex="-1"></a></span>
<span id="cb25-55"><a href="#cb25-55" tabindex="-1"></a><span class="co">// Function to mask pixels with low CS+ QA scores.</span></span>
<span id="cb25-56"><a href="#cb25-56" tabindex="-1"></a><span class="kw">function</span> <span class="fu">maskLowQA</span>(image) {</span>
<span id="cb25-57"><a href="#cb25-57" tabindex="-1"></a>  <span class="kw">var</span> qaBand <span class="op">=</span> <span class="st">&#39;cs&#39;</span><span class="op">;</span></span>
<span id="cb25-58"><a href="#cb25-58" tabindex="-1"></a>  <span class="kw">var</span> clearThreshold <span class="op">=</span> <span class="fl">0.5</span><span class="op">;</span></span>
<span id="cb25-59"><a href="#cb25-59" tabindex="-1"></a>  <span class="kw">var</span> mask <span class="op">=</span> image<span class="op">.</span><span class="fu">select</span>(qaBand)<span class="op">.</span><span class="fu">gte</span>(clearThreshold)<span class="op">;</span></span>
<span id="cb25-60"><a href="#cb25-60" tabindex="-1"></a>  <span class="cf">return</span> image<span class="op">.</span><span class="fu">updateMask</span>(mask)<span class="op">;</span></span>
<span id="cb25-61"><a href="#cb25-61" tabindex="-1"></a>}</span>
<span id="cb25-62"><a href="#cb25-62" tabindex="-1"></a></span>
<span id="cb25-63"><a href="#cb25-63" tabindex="-1"></a></span>
<span id="cb25-64"><a href="#cb25-64" tabindex="-1"></a><span class="kw">var</span> filteredMasked <span class="op">=</span> filteredS2WithCs</span>
<span id="cb25-65"><a href="#cb25-65" tabindex="-1"></a>  <span class="op">.</span><span class="fu">map</span>(maskLowQA)<span class="op">;</span></span>
<span id="cb25-66"><a href="#cb25-66" tabindex="-1"></a></span>
<span id="cb25-67"><a href="#cb25-67" tabindex="-1"></a></span>
<span id="cb25-68"><a href="#cb25-68" tabindex="-1"></a><span class="co">// We map() a function that takes each date from the startDates</span></span>
<span id="cb25-69"><a href="#cb25-69" tabindex="-1"></a><span class="co">// and applies a filter for images in that interval</span></span>
<span id="cb25-70"><a href="#cb25-70" tabindex="-1"></a><span class="kw">var</span> compositeImages <span class="op">=</span> startDates<span class="op">.</span><span class="fu">map</span>(<span class="kw">function</span>(startDate) {</span>
<span id="cb25-71"><a href="#cb25-71" tabindex="-1"></a>  <span class="kw">var</span> intervalStartDate <span class="op">=</span> ee<span class="op">.</span><span class="fu">Date</span>(startDate)<span class="op">;</span></span>
<span id="cb25-72"><a href="#cb25-72" tabindex="-1"></a>  <span class="kw">var</span> intervalEndDate <span class="op">=</span> intervalStartDate<span class="op">.</span><span class="fu">advance</span>(interval<span class="op">,</span> unit)<span class="op">;</span></span>
<span id="cb25-73"><a href="#cb25-73" tabindex="-1"></a>  <span class="co">// Remember that end dates are not included in EE Filters</span></span>
<span id="cb25-74"><a href="#cb25-74" tabindex="-1"></a>  <span class="co">// So we get images upto the end date. </span></span>
<span id="cb25-75"><a href="#cb25-75" tabindex="-1"></a>  <span class="kw">var</span> intervalFiltered <span class="op">=</span> filteredMasked<span class="op">.</span><span class="fu">filter</span>(</span>
<span id="cb25-76"><a href="#cb25-76" tabindex="-1"></a>    ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(intervalStartDate<span class="op">,</span> intervalEndDate))<span class="op">;</span></span>
<span id="cb25-77"><a href="#cb25-77" tabindex="-1"></a>  <span class="co">// Count the number of images</span></span>
<span id="cb25-78"><a href="#cb25-78" tabindex="-1"></a>  <span class="co">// This will be used later to filter out</span></span>
<span id="cb25-79"><a href="#cb25-79" tabindex="-1"></a>  <span class="co">// composites with no matching images</span></span>
<span id="cb25-80"><a href="#cb25-80" tabindex="-1"></a>  <span class="kw">var</span> intervalImageCount <span class="op">=</span> intervalFiltered<span class="op">.</span><span class="fu">size</span>()<span class="op">;</span></span>
<span id="cb25-81"><a href="#cb25-81" tabindex="-1"></a>  <span class="kw">var</span> composite <span class="op">=</span> intervalFiltered<span class="op">.</span><span class="fu">median</span>()<span class="op">;</span></span>
<span id="cb25-82"><a href="#cb25-82" tabindex="-1"></a>  <span class="cf">return</span> composite<span class="op">.</span><span class="fu">set</span>({</span>
<span id="cb25-83"><a href="#cb25-83" tabindex="-1"></a>    <span class="st">&#39;system:time_start&#39;</span><span class="op">:</span> intervalStartDate<span class="op">.</span><span class="fu">millis</span>()<span class="op">,</span></span>
<span id="cb25-84"><a href="#cb25-84" tabindex="-1"></a>    <span class="st">&#39;system:time_end&#39;</span><span class="op">:</span> intervalEndDate<span class="op">.</span><span class="fu">millis</span>()<span class="op">,</span></span>
<span id="cb25-85"><a href="#cb25-85" tabindex="-1"></a>    <span class="st">&#39;start_date&#39;</span><span class="op">:</span> intervalStartDate<span class="op">.</span><span class="fu">format</span>(<span class="st">&#39;YYYY-MM-dd&#39;</span>)<span class="op">,</span></span>
<span id="cb25-86"><a href="#cb25-86" tabindex="-1"></a>    <span class="st">&#39;end_date&#39;</span><span class="op">:</span> intervalEndDate<span class="op">.</span><span class="fu">format</span>(<span class="st">&#39;YYYY-MM-dd&#39;</span>)<span class="op">,</span></span>
<span id="cb25-87"><a href="#cb25-87" tabindex="-1"></a>    <span class="st">&#39;image_count&#39;</span><span class="op">:</span> intervalImageCount</span>
<span id="cb25-88"><a href="#cb25-88" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb25-89"><a href="#cb25-89" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb25-90"><a href="#cb25-90" tabindex="-1"></a></span>
<span id="cb25-91"><a href="#cb25-91" tabindex="-1"></a><span class="kw">var</span> compositeCol <span class="op">=</span> ee<span class="op">.</span><span class="at">ImageCollection</span><span class="op">.</span><span class="fu">fromImages</span>(compositeImages)<span class="op">;</span></span>
<span id="cb25-92"><a href="#cb25-92" tabindex="-1"></a></span>
<span id="cb25-93"><a href="#cb25-93" tabindex="-1"></a><span class="kw">var</span> compositeColFiltered <span class="op">=</span> compositeCol<span class="op">.</span><span class="fu">filter</span>(</span>
<span id="cb25-94"><a href="#cb25-94" tabindex="-1"></a>  ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">neq</span>(<span class="st">&#39;image_count&#39;</span><span class="op">,</span> <span class="dv">0</span>))<span class="op">;</span></span>
<span id="cb25-95"><a href="#cb25-95" tabindex="-1"></a></span>
<span id="cb25-96"><a href="#cb25-96" tabindex="-1"></a><span class="fu">print</span>(<span class="st">&#39;Composites at &#39;</span> <span class="op">+</span> interval <span class="op">+</span> <span class="st">&#39; &#39;</span> <span class="op">+</span> unit <span class="op">+</span> <span class="st">&#39; intervals&#39;</span><span class="op">,</span></span>
<span id="cb25-97"><a href="#cb25-97" tabindex="-1"></a>  compositeColFiltered)<span class="op">;</span></span></code></pre></div>
</div>
<div id="export-imagecollection-metadata" class="section level2">
<h2>Export ImageCollection Metadata</h2>
<p><a
href="https://code.earthengine.google.co.in/?scriptPath=users%2Fujavalgandhi%2FEnd-to-End-GEE%3ASupplement%2FImage_Collections%2FImageCollection_Metadata"
target="_blank">Open in Code Editor ↗</a></p>
<div class="sourceCode" id="cb26"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb26-1"><a href="#cb26-1" tabindex="-1"></a><span class="co">// Example script showing how to export metadata of</span></span>
<span id="cb26-2"><a href="#cb26-2" tabindex="-1"></a><span class="co">// all images in a collection as a CSV file</span></span>
<span id="cb26-3"><a href="#cb26-3" tabindex="-1"></a></span>
<span id="cb26-4"><a href="#cb26-4" tabindex="-1"></a><span class="co">// Learn more functions for extracting metadata </span></span>
<span id="cb26-5"><a href="#cb26-5" tabindex="-1"></a><span class="co">// statistics at</span></span>
<span id="cb26-6"><a href="#cb26-6" tabindex="-1"></a><span class="co">// https://developers.google.com/earth-engine/guides/ic_info</span></span>
<span id="cb26-7"><a href="#cb26-7" tabindex="-1"></a><span class="kw">var</span> s2 <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&quot;COPERNICUS/S2_HARMONIZED&quot;</span>)<span class="op">;</span></span>
<span id="cb26-8"><a href="#cb26-8" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">centerObject</span>(geometry)<span class="op">;</span></span>
<span id="cb26-9"><a href="#cb26-9" tabindex="-1"></a></span>
<span id="cb26-10"><a href="#cb26-10" tabindex="-1"></a><span class="kw">var</span> filtered <span class="op">=</span> s2</span>
<span id="cb26-11"><a href="#cb26-11" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(<span class="st">&#39;2017-01-01&#39;</span><span class="op">,</span> <span class="st">&#39;2018-01-01&#39;</span>))</span>
<span id="cb26-12"><a href="#cb26-12" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">lt</span>(<span class="st">&#39;CLOUDY_PIXEL_PERCENTAGE&#39;</span><span class="op">,</span> <span class="dv">30</span>))</span>
<span id="cb26-13"><a href="#cb26-13" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">bounds</span>(geometry))<span class="op">;</span></span>
<span id="cb26-14"><a href="#cb26-14" tabindex="-1"></a><span class="co">// Print an image to check the metadata properties</span></span>
<span id="cb26-15"><a href="#cb26-15" tabindex="-1"></a><span class="co">// of interest</span></span>
<span id="cb26-16"><a href="#cb26-16" tabindex="-1"></a><span class="fu">print</span>(<span class="st">&#39;Image&#39;</span><span class="op">,</span> filtered<span class="op">.</span><span class="fu">first</span>()<span class="op">.</span><span class="fu">toDictionary</span>())<span class="op">;</span></span>
<span id="cb26-17"><a href="#cb26-17" tabindex="-1"></a></span>
<span id="cb26-18"><a href="#cb26-18" tabindex="-1"></a><span class="co">// We create a function to extract the required </span></span>
<span id="cb26-19"><a href="#cb26-19" tabindex="-1"></a><span class="co">// properties and create a FeatureCollection</span></span>
<span id="cb26-20"><a href="#cb26-20" tabindex="-1"></a><span class="kw">var</span> getMetadata <span class="op">=</span> <span class="kw">function</span>(image) {</span>
<span id="cb26-21"><a href="#cb26-21" tabindex="-1"></a>  <span class="co">// Get the image date</span></span>
<span id="cb26-22"><a href="#cb26-22" tabindex="-1"></a>  <span class="kw">var</span> date <span class="op">=</span> image<span class="op">.</span><span class="fu">date</span>()<span class="op">;</span></span>
<span id="cb26-23"><a href="#cb26-23" tabindex="-1"></a>  <span class="kw">var</span> formattedDate <span class="op">=</span> date<span class="op">.</span><span class="fu">format</span>(<span class="st">&#39;YYYY-MM-dd&#39;</span>)<span class="op">;</span></span>
<span id="cb26-24"><a href="#cb26-24" tabindex="-1"></a>  <span class="co">// Get the image id</span></span>
<span id="cb26-25"><a href="#cb26-25" tabindex="-1"></a>  <span class="kw">var</span> imageId <span class="op">=</span> image<span class="op">.</span><span class="fu">id</span>()<span class="op">;</span></span>
<span id="cb26-26"><a href="#cb26-26" tabindex="-1"></a>  <span class="co">// Extract the image footprint</span></span>
<span id="cb26-27"><a href="#cb26-27" tabindex="-1"></a>  <span class="kw">var</span> footprint <span class="op">=</span> image<span class="op">.</span><span class="fu">geometry</span>()<span class="op">;</span></span>
<span id="cb26-28"><a href="#cb26-28" tabindex="-1"></a>  </span>
<span id="cb26-29"><a href="#cb26-29" tabindex="-1"></a>  <span class="co">// Extract the ,mtadata of interest</span></span>
<span id="cb26-30"><a href="#cb26-30" tabindex="-1"></a>  <span class="kw">var</span> cloudCover <span class="op">=</span> image<span class="op">.</span><span class="fu">get</span>(<span class="st">&#39;CLOUDY_PIXEL_PERCENTAGE&#39;</span>)<span class="op">;</span></span>
<span id="cb26-31"><a href="#cb26-31" tabindex="-1"></a>  <span class="kw">var</span> satelliteName <span class="op">=</span> image<span class="op">.</span><span class="fu">get</span>(<span class="st">&#39;SPACECRAFT_NAME&#39;</span>)<span class="op">;</span></span>
<span id="cb26-32"><a href="#cb26-32" tabindex="-1"></a>  <span class="kw">var</span> mgrsTile <span class="op">=</span> image<span class="op">.</span><span class="fu">get</span>(<span class="st">&#39;MGRS_TILE&#39;</span>)<span class="op">;</span></span>
<span id="cb26-33"><a href="#cb26-33" tabindex="-1"></a>  <span class="co">// Create a feature with image footprint</span></span>
<span id="cb26-34"><a href="#cb26-34" tabindex="-1"></a>  <span class="co">// and extracted metadata</span></span>
<span id="cb26-35"><a href="#cb26-35" tabindex="-1"></a>  <span class="kw">var</span> feature <span class="op">=</span> ee<span class="op">.</span><span class="fu">Feature</span>(footprint<span class="op">,</span> {</span>
<span id="cb26-36"><a href="#cb26-36" tabindex="-1"></a>    <span class="st">&#39;image_id&#39;</span><span class="op">:</span> imageId<span class="op">,</span></span>
<span id="cb26-37"><a href="#cb26-37" tabindex="-1"></a>    <span class="st">&#39;date&#39;</span><span class="op">:</span> formattedDate<span class="op">,</span></span>
<span id="cb26-38"><a href="#cb26-38" tabindex="-1"></a>    <span class="st">&#39;cloud_cover&#39;</span><span class="op">:</span> cloudCover<span class="op">,</span></span>
<span id="cb26-39"><a href="#cb26-39" tabindex="-1"></a>    <span class="st">&#39;satellite&#39;</span><span class="op">:</span> satelliteName<span class="op">,</span></span>
<span id="cb26-40"><a href="#cb26-40" tabindex="-1"></a>    <span class="st">&#39;mgrs_tile&#39;</span><span class="op">:</span> mgrsTile</span>
<span id="cb26-41"><a href="#cb26-41" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb26-42"><a href="#cb26-42" tabindex="-1"></a>  <span class="cf">return</span> feature<span class="op">;</span></span>
<span id="cb26-43"><a href="#cb26-43" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb26-44"><a href="#cb26-44" tabindex="-1"></a></span>
<span id="cb26-45"><a href="#cb26-45" tabindex="-1"></a></span>
<span id="cb26-46"><a href="#cb26-46" tabindex="-1"></a><span class="co">// map() the function on the ImageCollection</span></span>
<span id="cb26-47"><a href="#cb26-47" tabindex="-1"></a><span class="kw">var</span> metadataList <span class="op">=</span> filtered<span class="op">.</span><span class="fu">map</span>(getMetadata)<span class="op">;</span></span>
<span id="cb26-48"><a href="#cb26-48" tabindex="-1"></a><span class="kw">var</span> metadataFc <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(metadataList)<span class="op">;</span></span>
<span id="cb26-49"><a href="#cb26-49" tabindex="-1"></a></span>
<span id="cb26-50"><a href="#cb26-50" tabindex="-1"></a><span class="co">// Export the results</span></span>
<span id="cb26-51"><a href="#cb26-51" tabindex="-1"></a></span>
<span id="cb26-52"><a href="#cb26-52" tabindex="-1"></a><span class="co">// Use the &#39;selectors&#39; parameter to maintain the</span></span>
<span id="cb26-53"><a href="#cb26-53" tabindex="-1"></a><span class="co">// order of columns</span></span>
<span id="cb26-54"><a href="#cb26-54" tabindex="-1"></a><span class="co">// &#39;.geo&#39; refers to the geometry column</span></span>
<span id="cb26-55"><a href="#cb26-55" tabindex="-1"></a>Export<span class="op">.</span><span class="at">table</span><span class="op">.</span><span class="fu">toDrive</span>({</span>
<span id="cb26-56"><a href="#cb26-56" tabindex="-1"></a>  <span class="dt">collection</span><span class="op">:</span> metadataFc<span class="op">,</span></span>
<span id="cb26-57"><a href="#cb26-57" tabindex="-1"></a>  <span class="dt">description</span><span class="op">:</span> <span class="st">&#39;Collection_Metadata_GeoJSON&#39;</span><span class="op">,</span></span>
<span id="cb26-58"><a href="#cb26-58" tabindex="-1"></a>  <span class="dt">folder</span><span class="op">:</span> <span class="st">&#39;earthengine&#39;</span><span class="op">,</span></span>
<span id="cb26-59"><a href="#cb26-59" tabindex="-1"></a>  <span class="dt">fileNamePrefix</span><span class="op">:</span> <span class="st">&#39;metadata&#39;</span><span class="op">,</span></span>
<span id="cb26-60"><a href="#cb26-60" tabindex="-1"></a>  <span class="dt">fileFormat</span><span class="op">:</span> <span class="st">&#39;GeoJSON&#39;</span><span class="op">,</span></span>
<span id="cb26-61"><a href="#cb26-61" tabindex="-1"></a>  <span class="dt">selectors</span><span class="op">:</span> [<span class="st">&#39;image_id&#39;</span><span class="op">,</span> <span class="st">&#39;date&#39;</span><span class="op">,</span> <span class="st">&#39;cloud_cover&#39;</span><span class="op">,</span></span>
<span id="cb26-62"><a href="#cb26-62" tabindex="-1"></a>    <span class="st">&#39;satellite&#39;</span><span class="op">,</span> <span class="st">&#39;mgrs_tile&#39;</span><span class="op">,</span> <span class="st">&#39;.geo&#39;</span>]</span>
<span id="cb26-63"><a href="#cb26-63" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb26-64"><a href="#cb26-64" tabindex="-1"></a></span>
<span id="cb26-65"><a href="#cb26-65" tabindex="-1"></a><span class="co">// Export as a CSV (without geometry)</span></span>
<span id="cb26-66"><a href="#cb26-66" tabindex="-1"></a>Export<span class="op">.</span><span class="at">table</span><span class="op">.</span><span class="fu">toDrive</span>({</span>
<span id="cb26-67"><a href="#cb26-67" tabindex="-1"></a>  <span class="dt">collection</span><span class="op">:</span> metadataFc<span class="op">,</span></span>
<span id="cb26-68"><a href="#cb26-68" tabindex="-1"></a>  <span class="dt">description</span><span class="op">:</span> <span class="st">&#39;Collection_Metadata_CSV&#39;</span><span class="op">,</span></span>
<span id="cb26-69"><a href="#cb26-69" tabindex="-1"></a>  <span class="dt">folder</span><span class="op">:</span> <span class="st">&#39;earthengine&#39;</span><span class="op">,</span></span>
<span id="cb26-70"><a href="#cb26-70" tabindex="-1"></a>  <span class="dt">fileNamePrefix</span><span class="op">:</span> <span class="st">&#39;metadata&#39;</span><span class="op">,</span></span>
<span id="cb26-71"><a href="#cb26-71" tabindex="-1"></a>  <span class="dt">fileFormat</span><span class="op">:</span> <span class="st">&#39;CSV&#39;</span><span class="op">,</span></span>
<span id="cb26-72"><a href="#cb26-72" tabindex="-1"></a>  <span class="dt">selectors</span><span class="op">:</span> [<span class="st">&#39;image_id&#39;</span><span class="op">,</span> <span class="st">&#39;date&#39;</span><span class="op">,</span> <span class="st">&#39;cloud_cover&#39;</span><span class="op">,</span></span>
<span id="cb26-73"><a href="#cb26-73" tabindex="-1"></a>    <span class="st">&#39;satellite&#39;</span><span class="op">,</span> <span class="st">&#39;mgrs_tile&#39;</span>]</span>
<span id="cb26-74"><a href="#cb26-74" tabindex="-1"></a>})<span class="op">;</span></span></code></pre></div>
</div>
<div id="get-pixelwise-dates-for-composites" class="section level2">
<h2>Get Pixelwise Dates for Composites</h2>
<p><a
href="https://code.earthengine.google.co.in/?scriptPath=users%2Fujavalgandhi%2FEnd-to-End-GEE%3ASupplement%2FImage_Collections%2FGet_Pixelwise_Dates_in_Composites"
target="_blank">Open in Code Editor ↗</a></p>
<div class="sourceCode" id="cb27"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb27-1"><a href="#cb27-1" tabindex="-1"></a><span class="co">// Example script showing how to determine the date of each pixel</span></span>
<span id="cb27-2"><a href="#cb27-2" tabindex="-1"></a><span class="co">// in a composite image</span></span>
<span id="cb27-3"><a href="#cb27-3" tabindex="-1"></a></span>
<span id="cb27-4"><a href="#cb27-4" tabindex="-1"></a><span class="co">// Select a region</span></span>
<span id="cb27-5"><a href="#cb27-5" tabindex="-1"></a><span class="kw">var</span> admin1 <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">&#39;FAO/GAUL_SIMPLIFIED_500m/2015/level1&#39;</span>)<span class="op">;</span></span>
<span id="cb27-6"><a href="#cb27-6" tabindex="-1"></a><span class="kw">var</span> karnataka <span class="op">=</span> admin1<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;ADM1_NAME&#39;</span><span class="op">,</span> <span class="st">&#39;Karnataka&#39;</span>))<span class="op">;</span></span>
<span id="cb27-7"><a href="#cb27-7" tabindex="-1"></a><span class="kw">var</span> geometry <span class="op">=</span> karnataka<span class="op">.</span><span class="fu">geometry</span>()<span class="op">;</span></span>
<span id="cb27-8"><a href="#cb27-8" tabindex="-1"></a></span>
<span id="cb27-9"><a href="#cb27-9" tabindex="-1"></a><span class="co">// Use the Sentinel-2 collection </span></span>
<span id="cb27-10"><a href="#cb27-10" tabindex="-1"></a><span class="kw">var</span> s2 <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&#39;COPERNICUS/S2_HARMONIZED&#39;</span>)<span class="op">;</span></span>
<span id="cb27-11"><a href="#cb27-11" tabindex="-1"></a></span>
<span id="cb27-12"><a href="#cb27-12" tabindex="-1"></a><span class="co">// Load the Cloud Score+ collection</span></span>
<span id="cb27-13"><a href="#cb27-13" tabindex="-1"></a><span class="kw">var</span> csPlus <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&#39;GOOGLE/CLOUD_SCORE_PLUS/V1/S2_HARMONIZED&#39;</span>)<span class="op">;</span></span>
<span id="cb27-14"><a href="#cb27-14" tabindex="-1"></a><span class="kw">var</span> csPlusBands <span class="op">=</span> csPlus<span class="op">.</span><span class="fu">first</span>()<span class="op">.</span><span class="fu">bandNames</span>()<span class="op">;</span></span>
<span id="cb27-15"><a href="#cb27-15" tabindex="-1"></a></span>
<span id="cb27-16"><a href="#cb27-16" tabindex="-1"></a><span class="co">// We need to add Cloud Score + bands to each Sentinel-2</span></span>
<span id="cb27-17"><a href="#cb27-17" tabindex="-1"></a><span class="co">// image in the collection</span></span>
<span id="cb27-18"><a href="#cb27-18" tabindex="-1"></a><span class="co">// This is done using the linkCollection() function</span></span>
<span id="cb27-19"><a href="#cb27-19" tabindex="-1"></a><span class="kw">var</span> filteredS2WithCs <span class="op">=</span> s2<span class="op">.</span><span class="fu">linkCollection</span>(csPlus<span class="op">,</span> csPlusBands)<span class="op">;</span></span>
<span id="cb27-20"><a href="#cb27-20" tabindex="-1"></a></span>
<span id="cb27-21"><a href="#cb27-21" tabindex="-1"></a><span class="co">// Function to mask pixels with low CS+ QA scores.</span></span>
<span id="cb27-22"><a href="#cb27-22" tabindex="-1"></a><span class="kw">function</span> <span class="fu">maskLowQA</span>(image) {</span>
<span id="cb27-23"><a href="#cb27-23" tabindex="-1"></a>  <span class="kw">var</span> qaBand <span class="op">=</span> <span class="st">&#39;cs&#39;</span><span class="op">;</span></span>
<span id="cb27-24"><a href="#cb27-24" tabindex="-1"></a>  <span class="kw">var</span> clearThreshold <span class="op">=</span> <span class="fl">0.5</span><span class="op">;</span></span>
<span id="cb27-25"><a href="#cb27-25" tabindex="-1"></a>  <span class="kw">var</span> mask <span class="op">=</span> image<span class="op">.</span><span class="fu">select</span>(qaBand)<span class="op">.</span><span class="fu">gte</span>(clearThreshold)<span class="op">;</span></span>
<span id="cb27-26"><a href="#cb27-26" tabindex="-1"></a>  <span class="cf">return</span> image<span class="op">.</span><span class="fu">updateMask</span>(mask)<span class="op">;</span></span>
<span id="cb27-27"><a href="#cb27-27" tabindex="-1"></a>}</span>
<span id="cb27-28"><a href="#cb27-28" tabindex="-1"></a></span>
<span id="cb27-29"><a href="#cb27-29" tabindex="-1"></a></span>
<span id="cb27-30"><a href="#cb27-30" tabindex="-1"></a><span class="kw">var</span> filteredMasked <span class="op">=</span> filteredS2WithCs</span>
<span id="cb27-31"><a href="#cb27-31" tabindex="-1"></a>  <span class="op">.</span><span class="fu">map</span>(maskLowQA)<span class="op">;</span></span>
<span id="cb27-32"><a href="#cb27-32" tabindex="-1"></a></span>
<span id="cb27-33"><a href="#cb27-33" tabindex="-1"></a><span class="co">// Write a function to apply the scaling factor to</span></span>
<span id="cb27-34"><a href="#cb27-34" tabindex="-1"></a><span class="co">// each of the bands to get reflectance values</span></span>
<span id="cb27-35"><a href="#cb27-35" tabindex="-1"></a><span class="kw">var</span> scaleImage <span class="op">=</span> <span class="kw">function</span>(image) {</span>
<span id="cb27-36"><a href="#cb27-36" tabindex="-1"></a>  <span class="cf">return</span> image</span>
<span id="cb27-37"><a href="#cb27-37" tabindex="-1"></a>    <span class="op">.</span><span class="fu">multiply</span>(<span class="fl">0.0001</span>)</span>
<span id="cb27-38"><a href="#cb27-38" tabindex="-1"></a>    <span class="op">.</span><span class="fu">copyProperties</span>(image<span class="op">,</span> [<span class="st">&#39;system:time_start&#39;</span>])</span>
<span id="cb27-39"><a href="#cb27-39" tabindex="-1"></a>}</span>
<span id="cb27-40"><a href="#cb27-40" tabindex="-1"></a></span>
<span id="cb27-41"><a href="#cb27-41" tabindex="-1"></a></span>
<span id="cb27-42"><a href="#cb27-42" tabindex="-1"></a><span class="co">// Write a function that computes NDVI for an image and adds it as a band</span></span>
<span id="cb27-43"><a href="#cb27-43" tabindex="-1"></a><span class="co">// We also add negative ndvi so we can find date of lowest NDVI</span></span>
<span id="cb27-44"><a href="#cb27-44" tabindex="-1"></a><span class="kw">function</span> <span class="fu">addNDVI</span>(image) {</span>
<span id="cb27-45"><a href="#cb27-45" tabindex="-1"></a>  <span class="kw">var</span> ndvi <span class="op">=</span> image<span class="op">.</span><span class="fu">normalizedDifference</span>([<span class="st">&#39;B8&#39;</span><span class="op">,</span> <span class="st">&#39;B4&#39;</span>])<span class="op">.</span><span class="fu">rename</span>(<span class="st">&#39;ndvi&#39;</span>)<span class="op">;</span></span>
<span id="cb27-46"><a href="#cb27-46" tabindex="-1"></a>  <span class="kw">var</span> invertNdvi <span class="op">=</span> ndvi<span class="op">.</span><span class="fu">multiply</span>(<span class="op">-</span><span class="dv">1</span>)<span class="op">.</span><span class="fu">rename</span>(<span class="st">&#39;invertndvi&#39;</span>)<span class="op">;</span></span>
<span id="cb27-47"><a href="#cb27-47" tabindex="-1"></a>  <span class="cf">return</span> image<span class="op">.</span><span class="fu">addBands</span>([ndvi<span class="op">,</span> invertNdvi])<span class="op">;</span></span>
<span id="cb27-48"><a href="#cb27-48" tabindex="-1"></a>}</span>
<span id="cb27-49"><a href="#cb27-49" tabindex="-1"></a><span class="co">// Write a function to add date band</span></span>
<span id="cb27-50"><a href="#cb27-50" tabindex="-1"></a><span class="kw">var</span> addDateBand <span class="op">=</span> <span class="kw">function</span>(image) {</span>
<span id="cb27-51"><a href="#cb27-51" tabindex="-1"></a>  <span class="co">// Create an image with day of the year as value</span></span>
<span id="cb27-52"><a href="#cb27-52" tabindex="-1"></a>  <span class="kw">var</span> date <span class="op">=</span> ee<span class="op">.</span><span class="fu">Date</span>(image<span class="op">.</span><span class="fu">get</span>(<span class="st">&#39;system:time_start&#39;</span>))<span class="op">;</span></span>
<span id="cb27-53"><a href="#cb27-53" tabindex="-1"></a>  <span class="co">// Create an image where each pixel&#39;s value is the</span></span>
<span id="cb27-54"><a href="#cb27-54" tabindex="-1"></a>  <span class="co">// timestamp of the image date</span></span>
<span id="cb27-55"><a href="#cb27-55" tabindex="-1"></a>  <span class="kw">var</span> dateImage <span class="op">=</span> ee<span class="op">.</span><span class="at">Image</span><span class="op">.</span><span class="fu">constant</span>(date<span class="op">.</span><span class="fu">millis</span>())<span class="op">.</span><span class="fu">rename</span>([<span class="st">&#39;timestamp&#39;</span>])<span class="op">.</span><span class="fu">toFloat</span>()<span class="op">;</span></span>
<span id="cb27-56"><a href="#cb27-56" tabindex="-1"></a>  <span class="co">// We can also create an image where each pixel has the value</span></span>
<span id="cb27-57"><a href="#cb27-57" tabindex="-1"></a>  <span class="co">// equivalent to the day of the year of the image date</span></span>
<span id="cb27-58"><a href="#cb27-58" tabindex="-1"></a>  <span class="kw">var</span> doy <span class="op">=</span> date<span class="op">.</span><span class="fu">getRelative</span>(<span class="st">&#39;day&#39;</span><span class="op">,</span> <span class="st">&#39;year&#39;</span>)<span class="op">;</span></span>
<span id="cb27-59"><a href="#cb27-59" tabindex="-1"></a>  <span class="kw">var</span> doyImage <span class="op">=</span> ee<span class="op">.</span><span class="at">Image</span><span class="op">.</span><span class="fu">constant</span>(doy)<span class="op">.</span><span class="fu">rename</span>([<span class="st">&#39;doy&#39;</span>])<span class="op">.</span><span class="fu">toFloat</span>()<span class="op">;</span></span>
<span id="cb27-60"><a href="#cb27-60" tabindex="-1"></a>  <span class="cf">return</span> image<span class="op">.</span><span class="fu">addBands</span>([dateImage<span class="op">,</span> doyImage])<span class="op">;</span></span>
<span id="cb27-61"><a href="#cb27-61" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb27-62"><a href="#cb27-62" tabindex="-1"></a></span>
<span id="cb27-63"><a href="#cb27-63" tabindex="-1"></a><span class="co">// Filter and pre-process the collection</span></span>
<span id="cb27-64"><a href="#cb27-64" tabindex="-1"></a><span class="kw">var</span> filtered <span class="op">=</span> filteredMasked</span>
<span id="cb27-65"><a href="#cb27-65" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(<span class="st">&#39;2019-01-01&#39;</span><span class="op">,</span> <span class="st">&#39;2020-01-01&#39;</span>))</span>
<span id="cb27-66"><a href="#cb27-66" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">lt</span>(<span class="st">&#39;CLOUDY_PIXEL_PERCENTAGE&#39;</span><span class="op">,</span> <span class="dv">30</span>))</span>
<span id="cb27-67"><a href="#cb27-67" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">bounds</span>(geometry))</span>
<span id="cb27-68"><a href="#cb27-68" tabindex="-1"></a>  <span class="op">.</span><span class="fu">map</span>(scaleImage)</span>
<span id="cb27-69"><a href="#cb27-69" tabindex="-1"></a>  <span class="op">.</span><span class="fu">map</span>(addNDVI)</span>
<span id="cb27-70"><a href="#cb27-70" tabindex="-1"></a>  <span class="op">.</span><span class="fu">map</span>(addDateBand)<span class="op">;</span></span>
<span id="cb27-71"><a href="#cb27-71" tabindex="-1"></a>  </span>
<span id="cb27-72"><a href="#cb27-72" tabindex="-1"></a><span class="co">// Create a composite with highest and lowest NDVI per pixel</span></span>
<span id="cb27-73"><a href="#cb27-73" tabindex="-1"></a><span class="kw">var</span> maxNdvi <span class="op">=</span> filtered<span class="op">.</span><span class="fu">qualityMosaic</span>(<span class="st">&#39;ndvi&#39;</span>)</span>
<span id="cb27-74"><a href="#cb27-74" tabindex="-1"></a><span class="kw">var</span> minNdvi <span class="op">=</span> filtered<span class="op">.</span><span class="fu">qualityMosaic</span>(<span class="st">&#39;invertndvi&#39;</span>)</span>
<span id="cb27-75"><a href="#cb27-75" tabindex="-1"></a></span>
<span id="cb27-76"><a href="#cb27-76" tabindex="-1"></a><span class="co">// We select the &#39;doy&#39; band</span></span>
<span id="cb27-77"><a href="#cb27-77" tabindex="-1"></a><span class="co">// The DOY images have a pixel value equivalent to day of the year</span></span>
<span id="cb27-78"><a href="#cb27-78" tabindex="-1"></a><span class="co">// of the image from which the pixel was used.</span></span>
<span id="cb27-79"><a href="#cb27-79" tabindex="-1"></a><span class="kw">var</span> maxDoy <span class="op">=</span> maxNdvi<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;doy&#39;</span>)<span class="op">;</span></span>
<span id="cb27-80"><a href="#cb27-80" tabindex="-1"></a><span class="kw">var</span> minDoy <span class="op">=</span> minNdvi<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;doy&#39;</span>)<span class="op">;</span></span>
<span id="cb27-81"><a href="#cb27-81" tabindex="-1"></a></span>
<span id="cb27-82"><a href="#cb27-82" tabindex="-1"></a><span class="co">//  Visualize the results</span></span>
<span id="cb27-83"><a href="#cb27-83" tabindex="-1"></a></span>
<span id="cb27-84"><a href="#cb27-84" tabindex="-1"></a><span class="co">// First add the collection so we can validate the results</span></span>
<span id="cb27-85"><a href="#cb27-85" tabindex="-1"></a><span class="co">// by inspecting pixel values</span></span>
<span id="cb27-86"><a href="#cb27-86" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(filtered<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;ndvi&#39;</span>)<span class="op">,</span> {}<span class="op">,</span> <span class="st">&#39;Full Collection&#39;</span><span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span></span>
<span id="cb27-87"><a href="#cb27-87" tabindex="-1"></a></span>
<span id="cb27-88"><a href="#cb27-88" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">centerObject</span>(geometry<span class="op">,</span> <span class="dv">10</span>)<span class="op">;</span></span>
<span id="cb27-89"><a href="#cb27-89" tabindex="-1"></a><span class="kw">var</span> palette <span class="op">=</span> [<span class="st">&#39;#fef0d9&#39;</span><span class="op">,</span><span class="st">&#39;#fdcc8a&#39;</span><span class="op">,</span><span class="st">&#39;#fc8d59&#39;</span><span class="op">,</span><span class="st">&#39;#e34a33&#39;</span><span class="op">,</span><span class="st">&#39;#b30000&#39;</span>]<span class="op">;</span></span>
<span id="cb27-90"><a href="#cb27-90" tabindex="-1"></a><span class="kw">var</span> doyVis <span class="op">=</span> {<span class="dt">min</span><span class="op">:</span><span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span><span class="dv">365</span><span class="op">,</span> <span class="dt">palette</span><span class="op">:</span> palette}</span>
<span id="cb27-91"><a href="#cb27-91" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(minDoy<span class="op">.</span><span class="fu">clip</span>(geometry)<span class="op">,</span> doyVis<span class="op">,</span> <span class="st">&#39;DOY of Minimum NDVI&#39;</span>)<span class="op">;</span></span>
<span id="cb27-92"><a href="#cb27-92" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(maxDoy<span class="op">.</span><span class="fu">clip</span>(geometry)<span class="op">,</span> doyVis<span class="op">,</span> <span class="st">&#39;DOY of Maximum NDVI&#39;</span>)<span class="op">;</span></span>
<span id="cb27-93"><a href="#cb27-93" tabindex="-1"></a></span>
<span id="cb27-94"><a href="#cb27-94" tabindex="-1"></a>  </span></code></pre></div>
</div>
<div id="filter-images-by-cloud-cover-in-a-region"
class="section level2">
<h2>Filter Images by Cloud Cover in a Region</h2>
<p>This script shows how to calculate the cloud cover in a region, and
set an image property with the cloud cover for a given region. We can
then apply a filter to select images having no cloud cover in the
region. This is useful where you are working in a very cloudy region and
want to ensure that you are filtering for clouds in your region of
interest, instead of the whole scene.</p>
<p><a
href="https://code.earthengine.google.co.in/?scriptPath=users%2Fujavalgandhi%2FEnd-to-End-GEE%3ASupplement%2FImage_Collections%2FFilter_by_Cloud_Cover_In_Region"
target="_blank">Open in Code Editor ↗</a></p>
<div class="sourceCode" id="cb28"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb28-1"><a href="#cb28-1" tabindex="-1"></a><span class="kw">var</span> geometry <span class="op">=</span> ee<span class="op">.</span><span class="at">Geometry</span><span class="op">.</span><span class="fu">Polygon</span>([[</span>
<span id="cb28-2"><a href="#cb28-2" tabindex="-1"></a>    [<span class="fl">77.4783</span><span class="op">,</span> <span class="fl">13.0848</span>]<span class="op">,</span></span>
<span id="cb28-3"><a href="#cb28-3" tabindex="-1"></a>    [<span class="fl">77.4783</span><span class="op">,</span> <span class="fl">12.8198</span>]<span class="op">,</span></span>
<span id="cb28-4"><a href="#cb28-4" tabindex="-1"></a>    [<span class="fl">77.7502</span><span class="op">,</span> <span class="fl">12.8198</span>]<span class="op">,</span></span>
<span id="cb28-5"><a href="#cb28-5" tabindex="-1"></a>    [<span class="fl">77.7502</span><span class="op">,</span> <span class="fl">13.0848</span>]]</span>
<span id="cb28-6"><a href="#cb28-6" tabindex="-1"></a>])<span class="op">;</span></span>
<span id="cb28-7"><a href="#cb28-7" tabindex="-1"></a>          </span>
<span id="cb28-8"><a href="#cb28-8" tabindex="-1"></a><span class="kw">var</span> s2 <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&#39;COPERNICUS/S2_HARMONIZED&#39;</span>)<span class="op">;</span></span>
<span id="cb28-9"><a href="#cb28-9" tabindex="-1"></a></span>
<span id="cb28-10"><a href="#cb28-10" tabindex="-1"></a></span>
<span id="cb28-11"><a href="#cb28-11" tabindex="-1"></a><span class="kw">var</span> filtered <span class="op">=</span> s2</span>
<span id="cb28-12"><a href="#cb28-12" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(<span class="st">&#39;2019-01-01&#39;</span><span class="op">,</span> <span class="st">&#39;2020-01-01&#39;</span>))</span>
<span id="cb28-13"><a href="#cb28-13" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">bounds</span>(geometry))<span class="op">;</span></span>
<span id="cb28-14"><a href="#cb28-14" tabindex="-1"></a></span>
<span id="cb28-15"><a href="#cb28-15" tabindex="-1"></a><span class="co">// Load the Cloud Score+ collection</span></span>
<span id="cb28-16"><a href="#cb28-16" tabindex="-1"></a><span class="kw">var</span> csPlus <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&#39;GOOGLE/CLOUD_SCORE_PLUS/V1/S2_HARMONIZED&#39;</span>)<span class="op">;</span></span>
<span id="cb28-17"><a href="#cb28-17" tabindex="-1"></a><span class="kw">var</span> csPlusBands <span class="op">=</span> csPlus<span class="op">.</span><span class="fu">first</span>()<span class="op">.</span><span class="fu">bandNames</span>()<span class="op">;</span></span>
<span id="cb28-18"><a href="#cb28-18" tabindex="-1"></a></span>
<span id="cb28-19"><a href="#cb28-19" tabindex="-1"></a><span class="co">// We need to add Cloud Score + bands to each Sentinel-2</span></span>
<span id="cb28-20"><a href="#cb28-20" tabindex="-1"></a><span class="co">// image in the collection</span></span>
<span id="cb28-21"><a href="#cb28-21" tabindex="-1"></a><span class="co">// This is done using the linkCollection() function</span></span>
<span id="cb28-22"><a href="#cb28-22" tabindex="-1"></a><span class="kw">var</span> filteredS2WithCs <span class="op">=</span> filtered<span class="op">.</span><span class="fu">linkCollection</span>(csPlus<span class="op">,</span> csPlusBands)<span class="op">;</span></span>
<span id="cb28-23"><a href="#cb28-23" tabindex="-1"></a></span>
<span id="cb28-24"><a href="#cb28-24" tabindex="-1"></a><span class="co">// Function to mask pixels with low CS+ QA scores.</span></span>
<span id="cb28-25"><a href="#cb28-25" tabindex="-1"></a><span class="kw">function</span> <span class="fu">maskLowQA</span>(image) {</span>
<span id="cb28-26"><a href="#cb28-26" tabindex="-1"></a>  <span class="kw">var</span> qaBand <span class="op">=</span> <span class="st">&#39;cs&#39;</span><span class="op">;</span></span>
<span id="cb28-27"><a href="#cb28-27" tabindex="-1"></a>  <span class="kw">var</span> clearThreshold <span class="op">=</span> <span class="fl">0.5</span><span class="op">;</span></span>
<span id="cb28-28"><a href="#cb28-28" tabindex="-1"></a>  <span class="kw">var</span> mask <span class="op">=</span> image<span class="op">.</span><span class="fu">select</span>(qaBand)<span class="op">.</span><span class="fu">gte</span>(clearThreshold)<span class="op">;</span></span>
<span id="cb28-29"><a href="#cb28-29" tabindex="-1"></a>  <span class="cf">return</span> image<span class="op">.</span><span class="fu">updateMask</span>(mask)<span class="op">;</span></span>
<span id="cb28-30"><a href="#cb28-30" tabindex="-1"></a>}</span>
<span id="cb28-31"><a href="#cb28-31" tabindex="-1"></a></span>
<span id="cb28-32"><a href="#cb28-32" tabindex="-1"></a><span class="co">// Add a function that adds a property to each image</span></span>
<span id="cb28-33"><a href="#cb28-33" tabindex="-1"></a><span class="co">// with the cloud cover in the chosen geometry</span></span>
<span id="cb28-34"><a href="#cb28-34" tabindex="-1"></a><span class="kw">var</span> calculateCloudCover <span class="op">=</span> <span class="kw">function</span>(image) {</span>
<span id="cb28-35"><a href="#cb28-35" tabindex="-1"></a>  <span class="co">// Apply the cloud mask function</span></span>
<span id="cb28-36"><a href="#cb28-36" tabindex="-1"></a>  <span class="kw">var</span> maskedImage <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(<span class="fu">maskLowQA</span>(image))<span class="op">;</span></span>
<span id="cb28-37"><a href="#cb28-37" tabindex="-1"></a>  <span class="co">// The image now has some pixels that are masked</span></span>
<span id="cb28-38"><a href="#cb28-38" tabindex="-1"></a>  <span class="co">// We count the number of unmasked pixels</span></span>
<span id="cb28-39"><a href="#cb28-39" tabindex="-1"></a>  <span class="co">// Select any band, since all bands have the same mask</span></span>
<span id="cb28-40"><a href="#cb28-40" tabindex="-1"></a>  <span class="co">// Working with a single band maes the analysis simpler</span></span>
<span id="cb28-41"><a href="#cb28-41" tabindex="-1"></a>  <span class="kw">var</span> bandName <span class="op">=</span> <span class="st">&#39;B1&#39;</span><span class="op">;</span></span>
<span id="cb28-42"><a href="#cb28-42" tabindex="-1"></a>  <span class="kw">var</span> band <span class="op">=</span> maskedImage<span class="op">.</span><span class="fu">select</span>(bandName)<span class="op">;</span></span>
<span id="cb28-43"><a href="#cb28-43" tabindex="-1"></a>  <span class="kw">var</span> withMaskStats <span class="op">=</span> band<span class="op">.</span><span class="fu">reduceRegion</span>({</span>
<span id="cb28-44"><a href="#cb28-44" tabindex="-1"></a>    <span class="dt">reducer</span><span class="op">:</span> ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">count</span>()<span class="op">,</span></span>
<span id="cb28-45"><a href="#cb28-45" tabindex="-1"></a>    <span class="dt">geometry</span><span class="op">:</span> geometry<span class="op">,</span></span>
<span id="cb28-46"><a href="#cb28-46" tabindex="-1"></a>    <span class="dt">scale</span><span class="op">:</span> <span class="dv">10</span></span>
<span id="cb28-47"><a href="#cb28-47" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb28-48"><a href="#cb28-48" tabindex="-1"></a>  <span class="kw">var</span> cloudFreePixels <span class="op">=</span> withMaskStats<span class="op">.</span><span class="fu">getNumber</span>(bandName)<span class="op">;</span></span>
<span id="cb28-49"><a href="#cb28-49" tabindex="-1"></a>  </span>
<span id="cb28-50"><a href="#cb28-50" tabindex="-1"></a>  <span class="co">// Remove the mask and count all pixels</span></span>
<span id="cb28-51"><a href="#cb28-51" tabindex="-1"></a>  <span class="kw">var</span> withoutMaskStats <span class="op">=</span> band<span class="op">.</span><span class="fu">unmask</span>(<span class="dv">0</span>)<span class="op">.</span><span class="fu">reduceRegion</span>({</span>
<span id="cb28-52"><a href="#cb28-52" tabindex="-1"></a>    <span class="dt">reducer</span><span class="op">:</span> ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">count</span>()<span class="op">,</span></span>
<span id="cb28-53"><a href="#cb28-53" tabindex="-1"></a>    <span class="dt">geometry</span><span class="op">:</span> geometry<span class="op">,</span></span>
<span id="cb28-54"><a href="#cb28-54" tabindex="-1"></a>    <span class="dt">scale</span><span class="op">:</span> <span class="dv">10</span></span>
<span id="cb28-55"><a href="#cb28-55" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb28-56"><a href="#cb28-56" tabindex="-1"></a>  </span>
<span id="cb28-57"><a href="#cb28-57" tabindex="-1"></a>  <span class="kw">var</span> totalPixels <span class="op">=</span> withoutMaskStats<span class="op">.</span><span class="fu">getNumber</span>(<span class="st">&#39;B1&#39;</span>)<span class="op">;</span></span>
<span id="cb28-58"><a href="#cb28-58" tabindex="-1"></a>  </span>
<span id="cb28-59"><a href="#cb28-59" tabindex="-1"></a>  <span class="kw">var</span> cloudCoverPercentage <span class="op">=</span> ee<span class="op">.</span><span class="at">Number</span><span class="op">.</span><span class="fu">expression</span>(</span>
<span id="cb28-60"><a href="#cb28-60" tabindex="-1"></a>    <span class="st">&#39;100*(totalPixels-cloudFreePixels)/totalPixels&#39;</span><span class="op">,</span> {</span>
<span id="cb28-61"><a href="#cb28-61" tabindex="-1"></a>      <span class="dt">totalPixels</span><span class="op">:</span> totalPixels<span class="op">,</span></span>
<span id="cb28-62"><a href="#cb28-62" tabindex="-1"></a>      <span class="dt">cloudFreePixels</span><span class="op">:</span> cloudFreePixels</span>
<span id="cb28-63"><a href="#cb28-63" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb28-64"><a href="#cb28-64" tabindex="-1"></a>  <span class="cf">return</span> image<span class="op">.</span><span class="fu">set</span>({</span>
<span id="cb28-65"><a href="#cb28-65" tabindex="-1"></a>    <span class="st">&#39;CLOUDY_PIXEL_PERCENTAGE_REGION&#39;</span><span class="op">:</span> cloudCoverPercentage</span>
<span id="cb28-66"><a href="#cb28-66" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb28-67"><a href="#cb28-67" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb28-68"><a href="#cb28-68" tabindex="-1"></a></span>
<span id="cb28-69"><a href="#cb28-69" tabindex="-1"></a><span class="kw">var</span> filteredWithCount <span class="op">=</span> filteredS2WithCs<span class="op">.</span><span class="fu">map</span>(calculateCloudCover)<span class="op">;</span></span>
<span id="cb28-70"><a href="#cb28-70" tabindex="-1"></a></span>
<span id="cb28-71"><a href="#cb28-71" tabindex="-1"></a><span class="fu">print</span>(filteredWithCount<span class="op">.</span><span class="fu">first</span>())<span class="op">;</span></span>
<span id="cb28-72"><a href="#cb28-72" tabindex="-1"></a></span>
<span id="cb28-73"><a href="#cb28-73" tabindex="-1"></a><span class="co">// Filter using the newly created property</span></span>
<span id="cb28-74"><a href="#cb28-74" tabindex="-1"></a><span class="kw">var</span> cloudFreeImages <span class="op">=</span> filteredWithCount</span>
<span id="cb28-75"><a href="#cb28-75" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;CLOUDY_PIXEL_PERCENTAGE_REGION&#39;</span><span class="op">,</span> <span class="dv">0</span>))<span class="op">;</span></span>
<span id="cb28-76"><a href="#cb28-76" tabindex="-1"></a><span class="fu">print</span>(<span class="st">&#39;Cloud Free Images in Region&#39;</span><span class="op">,</span> cloudFreeImages<span class="op">.</span><span class="fu">size</span>())<span class="op">;</span></span>
<span id="cb28-77"><a href="#cb28-77" tabindex="-1"></a></span>
<span id="cb28-78"><a href="#cb28-78" tabindex="-1"></a><span class="co">// Verify the results</span></span>
<span id="cb28-79"><a href="#cb28-79" tabindex="-1"></a><span class="co">// Sort the results by cloud cover and pick the most cloudy</span></span>
<span id="cb28-80"><a href="#cb28-80" tabindex="-1"></a><span class="co">// image that is cloud-free within the region</span></span>
<span id="cb28-81"><a href="#cb28-81" tabindex="-1"></a><span class="kw">var</span> image <span class="op">=</span> cloudFreeImages<span class="op">.</span><span class="fu">sort</span>(<span class="st">&#39;CLOUDY_PIXEL_PERCENTAGE&#39;</span><span class="op">,</span> <span class="kw">false</span>)<span class="op">.</span><span class="fu">first</span>()</span>
<span id="cb28-82"><a href="#cb28-82" tabindex="-1"></a></span>
<span id="cb28-83"><a href="#cb28-83" tabindex="-1"></a><span class="kw">var</span> visParams <span class="op">=</span> {<span class="dt">min</span><span class="op">:</span><span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span><span class="dv">3000</span><span class="op">,</span> <span class="dt">bands</span><span class="op">:</span> [<span class="st">&#39;B4&#39;</span><span class="op">,</span> <span class="st">&#39;B3&#39;</span><span class="op">,</span> <span class="st">&#39;B2&#39;</span>]}<span class="op">;</span></span>
<span id="cb28-84"><a href="#cb28-84" tabindex="-1"></a></span>
<span id="cb28-85"><a href="#cb28-85" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">centerObject</span>(geometry)<span class="op">;</span></span>
<span id="cb28-86"><a href="#cb28-86" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(image<span class="op">,</span> visParams<span class="op">,</span> <span class="st">&#39;Image&#39;</span>)<span class="op">;</span></span>
<span id="cb28-87"><a href="#cb28-87" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(geometry<span class="op">,</span> {<span class="dt">color</span><span class="op">:</span> <span class="st">&#39;red&#39;</span>}<span class="op">,</span> <span class="st">&#39;Selected Region&#39;</span>)<span class="op">;</span></span></code></pre></div>
</div>
<div id="harmonized-landsat-time-series" class="section level2">
<h2>Harmonized Landsat Time Series</h2>
<p><a
href="https://code.earthengine.google.co.in/?scriptPath=users%2Fujavalgandhi%2FEnd-to-End-GEE%3ASupplement%2FImage_Collections%2FHarmonized_Landsat_Time_Series"
target="_blank">Open in Code Editor ↗</a></p>
<div class="sourceCode" id="cb29"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb29-1"><a href="#cb29-1" tabindex="-1"></a><span class="co">// Script showing how to obtain a harmonized Landsat Time-Series</span></span>
<span id="cb29-2"><a href="#cb29-2" tabindex="-1"></a><span class="co">// using Landsat Collection 2</span></span>
<span id="cb29-3"><a href="#cb29-3" tabindex="-1"></a><span class="kw">var</span> geometry <span class="op">=</span> ee<span class="op">.</span><span class="at">Geometry</span><span class="op">.</span><span class="fu">Polygon</span>([[</span>
<span id="cb29-4"><a href="#cb29-4" tabindex="-1"></a>  [<span class="fl">82.60642647743225</span><span class="op">,</span> <span class="fl">27.16350437805251</span>]<span class="op">,</span></span>
<span id="cb29-5"><a href="#cb29-5" tabindex="-1"></a>  [<span class="fl">82.60984897613525</span><span class="op">,</span> <span class="fl">27.1618529901377</span>]<span class="op">,</span></span>
<span id="cb29-6"><a href="#cb29-6" tabindex="-1"></a>  [<span class="fl">82.61088967323303</span><span class="op">,</span> <span class="fl">27.163695288375266</span>]<span class="op">,</span></span>
<span id="cb29-7"><a href="#cb29-7" tabindex="-1"></a>  [<span class="fl">82.60757446289062</span><span class="op">,</span> <span class="fl">27.16517483230927</span>]</span>
<span id="cb29-8"><a href="#cb29-8" tabindex="-1"></a>]])<span class="op">;</span></span>
<span id="cb29-9"><a href="#cb29-9" tabindex="-1"></a></span>
<span id="cb29-10"><a href="#cb29-10" tabindex="-1"></a><span class="co">// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span></span>
<span id="cb29-11"><a href="#cb29-11" tabindex="-1"></a><span class="co">// Step 1: Select the Landsat dataset</span></span>
<span id="cb29-12"><a href="#cb29-12" tabindex="-1"></a><span class="co">// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span></span>
<span id="cb29-13"><a href="#cb29-13" tabindex="-1"></a></span>
<span id="cb29-14"><a href="#cb29-14" tabindex="-1"></a><span class="co">// We use &quot;Landsat Level 2 Collection 2 Tier-1 Scenes&quot;</span></span>
<span id="cb29-15"><a href="#cb29-15" tabindex="-1"></a></span>
<span id="cb29-16"><a href="#cb29-16" tabindex="-1"></a><span class="co">// Collection 2 --&gt;</span></span>
<span id="cb29-17"><a href="#cb29-17" tabindex="-1"></a><span class="co">// Landsat Collection 2 algorithm has improved</span></span>
<span id="cb29-18"><a href="#cb29-18" tabindex="-1"></a><span class="co">// geometric and radiometric calibration that makes</span></span>
<span id="cb29-19"><a href="#cb29-19" tabindex="-1"></a><span class="co">// the collections interoperable.</span></span>
<span id="cb29-20"><a href="#cb29-20" tabindex="-1"></a><span class="co">// Learn more at https://www.usgs.gov/landsat-missions/landsat-collection-2</span></span>
<span id="cb29-21"><a href="#cb29-21" tabindex="-1"></a></span>
<span id="cb29-22"><a href="#cb29-22" tabindex="-1"></a><span class="co">// Level 2 --&gt;</span></span>
<span id="cb29-23"><a href="#cb29-23" tabindex="-1"></a><span class="co">// This is a surface reflectance product and </span></span>
<span id="cb29-24"><a href="#cb29-24" tabindex="-1"></a><span class="co">// have the highest level of interoperability through time.</span></span>
<span id="cb29-25"><a href="#cb29-25" tabindex="-1"></a></span>
<span id="cb29-26"><a href="#cb29-26" tabindex="-1"></a><span class="co">// Tier 1 --&gt;</span></span>
<span id="cb29-27"><a href="#cb29-27" tabindex="-1"></a><span class="co">// Highest quality scenes which are considered suitable</span></span>
<span id="cb29-28"><a href="#cb29-28" tabindex="-1"></a><span class="co">// for time-series analysis</span></span>
<span id="cb29-29"><a href="#cb29-29" tabindex="-1"></a><span class="kw">var</span> L5 <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&#39;LANDSAT/LT05/C02/T1_L2&#39;</span>)<span class="op">;</span></span>
<span id="cb29-30"><a href="#cb29-30" tabindex="-1"></a><span class="kw">var</span> L7 <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&#39;LANDSAT/LE07/C02/T1_L2&#39;</span>)<span class="op">;</span></span>
<span id="cb29-31"><a href="#cb29-31" tabindex="-1"></a><span class="kw">var</span> L8 <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&#39;LANDSAT/LC08/C02/T1_L2&#39;</span>)<span class="op">;</span></span>
<span id="cb29-32"><a href="#cb29-32" tabindex="-1"></a></span>
<span id="cb29-33"><a href="#cb29-33" tabindex="-1"></a><span class="co">// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span></span>
<span id="cb29-34"><a href="#cb29-34" tabindex="-1"></a><span class="co">// Step 2: Data Pre-Processing and Cloud Masking</span></span>
<span id="cb29-35"><a href="#cb29-35" tabindex="-1"></a><span class="co">// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span></span>
<span id="cb29-36"><a href="#cb29-36" tabindex="-1"></a></span>
<span id="cb29-37"><a href="#cb29-37" tabindex="-1"></a><span class="co">// Mapping of band-names to a uniform naming scheme</span></span>
<span id="cb29-38"><a href="#cb29-38" tabindex="-1"></a><span class="kw">var</span> l5Bands <span class="op">=</span> [<span class="st">&#39;SR_B1&#39;</span><span class="op">,</span><span class="st">&#39;SR_B2&#39;</span><span class="op">,</span><span class="st">&#39;SR_B3&#39;</span><span class="op">,</span><span class="st">&#39;SR_B4&#39;</span><span class="op">,</span><span class="st">&#39;SR_B5&#39;</span><span class="op">,</span><span class="st">&#39;SR_B7&#39;</span>]<span class="op">;</span></span>
<span id="cb29-39"><a href="#cb29-39" tabindex="-1"></a><span class="kw">var</span> l5names <span class="op">=</span> [<span class="st">&#39;blue&#39;</span><span class="op">,</span><span class="st">&#39;green&#39;</span><span class="op">,</span><span class="st">&#39;red&#39;</span><span class="op">,</span><span class="st">&#39;nir&#39;</span><span class="op">,</span><span class="st">&#39;swir1&#39;</span><span class="op">,</span><span class="st">&#39;swir2&#39;</span>]<span class="op">;</span></span>
<span id="cb29-40"><a href="#cb29-40" tabindex="-1"></a></span>
<span id="cb29-41"><a href="#cb29-41" tabindex="-1"></a><span class="kw">var</span> l7Bands <span class="op">=</span> [<span class="st">&#39;SR_B1&#39;</span><span class="op">,</span><span class="st">&#39;SR_B2&#39;</span><span class="op">,</span><span class="st">&#39;SR_B3&#39;</span><span class="op">,</span><span class="st">&#39;SR_B4&#39;</span><span class="op">,</span><span class="st">&#39;SR_B5&#39;</span><span class="op">,</span><span class="st">&#39;SR_B7&#39;</span>]<span class="op">;</span></span>
<span id="cb29-42"><a href="#cb29-42" tabindex="-1"></a><span class="kw">var</span> l7names <span class="op">=</span> [<span class="st">&#39;blue&#39;</span><span class="op">,</span><span class="st">&#39;green&#39;</span><span class="op">,</span><span class="st">&#39;red&#39;</span><span class="op">,</span><span class="st">&#39;nir&#39;</span><span class="op">,</span><span class="st">&#39;swir1&#39;</span><span class="op">,</span><span class="st">&#39;swir2&#39;</span>]<span class="op">;</span></span>
<span id="cb29-43"><a href="#cb29-43" tabindex="-1"></a></span>
<span id="cb29-44"><a href="#cb29-44" tabindex="-1"></a><span class="kw">var</span> l8Bands <span class="op">=</span> [<span class="st">&#39;SR_B2&#39;</span><span class="op">,</span><span class="st">&#39;SR_B3&#39;</span><span class="op">,</span><span class="st">&#39;SR_B4&#39;</span><span class="op">,</span><span class="st">&#39;SR_B5&#39;</span><span class="op">,</span><span class="st">&#39;SR_B6&#39;</span><span class="op">,</span><span class="st">&#39;SR_B7&#39;</span>]<span class="op">;</span></span>
<span id="cb29-45"><a href="#cb29-45" tabindex="-1"></a><span class="kw">var</span> l8names <span class="op">=</span> [<span class="st">&#39;blue&#39;</span><span class="op">,</span><span class="st">&#39;green&#39;</span><span class="op">,</span><span class="st">&#39;red&#39;</span><span class="op">,</span><span class="st">&#39;nir&#39;</span><span class="op">,</span><span class="st">&#39;swir1&#39;</span><span class="op">,</span><span class="st">&#39;swir2&#39;</span>]<span class="op">;</span></span>
<span id="cb29-46"><a href="#cb29-46" tabindex="-1"></a></span>
<span id="cb29-47"><a href="#cb29-47" tabindex="-1"></a><span class="co">// Cloud masking function for Landsat 4,5 and 7</span></span>
<span id="cb29-48"><a href="#cb29-48" tabindex="-1"></a><span class="kw">function</span> <span class="fu">maskL457sr</span>(image) {</span>
<span id="cb29-49"><a href="#cb29-49" tabindex="-1"></a>  <span class="kw">var</span> qaMask <span class="op">=</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;QA_PIXEL&#39;</span>)<span class="op">.</span><span class="fu">bitwiseAnd</span>(<span class="pp">parseInt</span>(<span class="st">&#39;11111&#39;</span><span class="op">,</span> <span class="dv">2</span>))<span class="op">.</span><span class="fu">eq</span>(<span class="dv">0</span>)<span class="op">;</span></span>
<span id="cb29-50"><a href="#cb29-50" tabindex="-1"></a>  <span class="kw">var</span> saturationMask <span class="op">=</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;QA_RADSAT&#39;</span>)<span class="op">.</span><span class="fu">eq</span>(<span class="dv">0</span>)<span class="op">;</span></span>
<span id="cb29-51"><a href="#cb29-51" tabindex="-1"></a></span>
<span id="cb29-52"><a href="#cb29-52" tabindex="-1"></a>  <span class="co">// Apply the scaling factors to the appropriate bands.</span></span>
<span id="cb29-53"><a href="#cb29-53" tabindex="-1"></a>  <span class="kw">var</span> opticalBands <span class="op">=</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;SR_B.&#39;</span>)<span class="op">.</span><span class="fu">multiply</span>(<span class="fl">0.0000275</span>)<span class="op">.</span><span class="fu">add</span>(<span class="op">-</span><span class="fl">0.2</span>)<span class="op">;</span></span>
<span id="cb29-54"><a href="#cb29-54" tabindex="-1"></a>  <span class="kw">var</span> thermalBand <span class="op">=</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;ST_B6&#39;</span>)<span class="op">.</span><span class="fu">multiply</span>(<span class="fl">0.00341802</span>)<span class="op">.</span><span class="fu">add</span>(<span class="fl">149.0</span>)<span class="op">;</span></span>
<span id="cb29-55"><a href="#cb29-55" tabindex="-1"></a></span>
<span id="cb29-56"><a href="#cb29-56" tabindex="-1"></a>  <span class="co">// Replace the original bands with the scaled ones and apply the masks.</span></span>
<span id="cb29-57"><a href="#cb29-57" tabindex="-1"></a>  <span class="cf">return</span> image<span class="op">.</span><span class="fu">addBands</span>(opticalBands<span class="op">,</span> <span class="kw">null</span><span class="op">,</span> <span class="kw">true</span>)</span>
<span id="cb29-58"><a href="#cb29-58" tabindex="-1"></a>      <span class="op">.</span><span class="fu">addBands</span>(thermalBand<span class="op">,</span> <span class="kw">null</span><span class="op">,</span> <span class="kw">true</span>)</span>
<span id="cb29-59"><a href="#cb29-59" tabindex="-1"></a>      <span class="op">.</span><span class="fu">updateMask</span>(qaMask)</span>
<span id="cb29-60"><a href="#cb29-60" tabindex="-1"></a>      <span class="op">.</span><span class="fu">updateMask</span>(saturationMask)</span>
<span id="cb29-61"><a href="#cb29-61" tabindex="-1"></a>      <span class="op">.</span><span class="fu">copyProperties</span>(image<span class="op">,</span> [<span class="st">&#39;system:time_start&#39;</span>])<span class="op">;</span></span>
<span id="cb29-62"><a href="#cb29-62" tabindex="-1"></a>}</span>
<span id="cb29-63"><a href="#cb29-63" tabindex="-1"></a></span>
<span id="cb29-64"><a href="#cb29-64" tabindex="-1"></a><span class="co">// Cloud masking function for Landsat 8</span></span>
<span id="cb29-65"><a href="#cb29-65" tabindex="-1"></a><span class="kw">function</span> <span class="fu">maskL8sr</span>(image) {</span>
<span id="cb29-66"><a href="#cb29-66" tabindex="-1"></a>  <span class="kw">var</span> qaMask <span class="op">=</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;QA_PIXEL&#39;</span>)<span class="op">.</span><span class="fu">bitwiseAnd</span>(<span class="pp">parseInt</span>(<span class="st">&#39;11111&#39;</span><span class="op">,</span> <span class="dv">2</span>))<span class="op">.</span><span class="fu">eq</span>(<span class="dv">0</span>)<span class="op">;</span></span>
<span id="cb29-67"><a href="#cb29-67" tabindex="-1"></a>  <span class="kw">var</span> saturationMask <span class="op">=</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;QA_RADSAT&#39;</span>)<span class="op">.</span><span class="fu">eq</span>(<span class="dv">0</span>)<span class="op">;</span></span>
<span id="cb29-68"><a href="#cb29-68" tabindex="-1"></a></span>
<span id="cb29-69"><a href="#cb29-69" tabindex="-1"></a>  <span class="co">// Apply the scaling factors to the appropriate bands.</span></span>
<span id="cb29-70"><a href="#cb29-70" tabindex="-1"></a>  <span class="kw">var</span> opticalBands <span class="op">=</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;SR_B.&#39;</span>)<span class="op">.</span><span class="fu">multiply</span>(<span class="fl">0.0000275</span>)<span class="op">.</span><span class="fu">add</span>(<span class="op">-</span><span class="fl">0.2</span>)<span class="op">;</span></span>
<span id="cb29-71"><a href="#cb29-71" tabindex="-1"></a>  <span class="kw">var</span> thermalBands <span class="op">=</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;ST_B.*&#39;</span>)<span class="op">.</span><span class="fu">multiply</span>(<span class="fl">0.00341802</span>)<span class="op">.</span><span class="fu">add</span>(<span class="fl">149.0</span>)<span class="op">;</span></span>
<span id="cb29-72"><a href="#cb29-72" tabindex="-1"></a></span>
<span id="cb29-73"><a href="#cb29-73" tabindex="-1"></a>  <span class="co">// Replace the original bands with the scaled ones and apply the masks.</span></span>
<span id="cb29-74"><a href="#cb29-74" tabindex="-1"></a>  <span class="cf">return</span> image<span class="op">.</span><span class="fu">addBands</span>(opticalBands<span class="op">,</span> <span class="kw">null</span><span class="op">,</span> <span class="kw">true</span>)</span>
<span id="cb29-75"><a href="#cb29-75" tabindex="-1"></a>      <span class="op">.</span><span class="fu">addBands</span>(thermalBands<span class="op">,</span> <span class="kw">null</span><span class="op">,</span> <span class="kw">true</span>)</span>
<span id="cb29-76"><a href="#cb29-76" tabindex="-1"></a>      <span class="op">.</span><span class="fu">updateMask</span>(qaMask)</span>
<span id="cb29-77"><a href="#cb29-77" tabindex="-1"></a>      <span class="op">.</span><span class="fu">updateMask</span>(saturationMask)</span>
<span id="cb29-78"><a href="#cb29-78" tabindex="-1"></a>      <span class="op">.</span><span class="fu">copyProperties</span>(image<span class="op">,</span> [<span class="st">&#39;system:time_start&#39;</span>])<span class="op">;</span></span>
<span id="cb29-79"><a href="#cb29-79" tabindex="-1"></a>}</span>
<span id="cb29-80"><a href="#cb29-80" tabindex="-1"></a></span>
<span id="cb29-81"><a href="#cb29-81" tabindex="-1"></a><span class="co">// Apply filters, cloud-mask and rename bands</span></span>
<span id="cb29-82"><a href="#cb29-82" tabindex="-1"></a><span class="co">// Filters from https://github.com/google/earthengine-catalog/blob/main/pipelines/landsat.py</span></span>
<span id="cb29-83"><a href="#cb29-83" tabindex="-1"></a><span class="kw">var</span> L5 <span class="op">=</span> L5</span>
<span id="cb29-84"><a href="#cb29-84" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">lt</span>(<span class="st">&#39;WRS_ROW&#39;</span><span class="op">,</span> <span class="dv">122</span>))  <span class="co">// Remove night-time images.</span></span>
<span id="cb29-85"><a href="#cb29-85" tabindex="-1"></a>  <span class="op">.</span><span class="fu">map</span>(maskL457sr)</span>
<span id="cb29-86"><a href="#cb29-86" tabindex="-1"></a>  <span class="op">.</span><span class="fu">select</span>(l5Bands<span class="op">,</span>l5names)<span class="op">;</span></span>
<span id="cb29-87"><a href="#cb29-87" tabindex="-1"></a></span>
<span id="cb29-88"><a href="#cb29-88" tabindex="-1"></a><span class="kw">var</span> L7 <span class="op">=</span> L7</span>
<span id="cb29-89"><a href="#cb29-89" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">lt</span>(<span class="st">&#39;WRS_ROW&#39;</span><span class="op">,</span> <span class="dv">122</span>))  <span class="co">// Remove night-time images.</span></span>
<span id="cb29-90"><a href="#cb29-90" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(<span class="st">&#39;1984-01-01&#39;</span><span class="op">,</span> <span class="st">&#39;2017-01-01&#39;</span>))  <span class="co">// Orbital drift after 2017.</span></span>
<span id="cb29-91"><a href="#cb29-91" tabindex="-1"></a>  <span class="op">.</span><span class="fu">map</span>(maskL457sr)</span>
<span id="cb29-92"><a href="#cb29-92" tabindex="-1"></a>  <span class="op">.</span><span class="fu">select</span>(l7Bands<span class="op">,</span>l7names)<span class="op">;</span></span>
<span id="cb29-93"><a href="#cb29-93" tabindex="-1"></a></span>
<span id="cb29-94"><a href="#cb29-94" tabindex="-1"></a><span class="kw">var</span> L8 <span class="op">=</span> L8</span>
<span id="cb29-95"><a href="#cb29-95" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(<span class="st">&#39;2013-05-01&#39;</span><span class="op">,</span> <span class="st">&#39;2099-01-01&#39;</span>)) <span class="co">// Images before May 1 had some pointing issues.</span></span>
<span id="cb29-96"><a href="#cb29-96" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">neq</span>(<span class="st">&#39;NADIR_OFFNADIR&#39;</span><span class="op">,</span> <span class="st">&#39;OFFNADIR&#39;</span>))</span>
<span id="cb29-97"><a href="#cb29-97" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">lt</span>(<span class="st">&#39;WRS_ROW&#39;</span><span class="op">,</span> <span class="dv">122</span>))  <span class="co">// Remove night-time images.</span></span>
<span id="cb29-98"><a href="#cb29-98" tabindex="-1"></a>  <span class="op">.</span><span class="fu">map</span>(maskL8sr)</span>
<span id="cb29-99"><a href="#cb29-99" tabindex="-1"></a>  <span class="op">.</span><span class="fu">select</span>(l8Bands<span class="op">,</span>l8names)<span class="op">;</span></span>
<span id="cb29-100"><a href="#cb29-100" tabindex="-1"></a></span>
<span id="cb29-101"><a href="#cb29-101" tabindex="-1"></a><span class="co">// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span></span>
<span id="cb29-102"><a href="#cb29-102" tabindex="-1"></a><span class="co">// Step 3a: Verify Radiometric Calibration</span></span>
<span id="cb29-103"><a href="#cb29-103" tabindex="-1"></a><span class="co">// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span></span>
<span id="cb29-104"><a href="#cb29-104" tabindex="-1"></a><span class="co">// We plot band values from different satellites during</span></span>
<span id="cb29-105"><a href="#cb29-105" tabindex="-1"></a><span class="co">// times when both were operational.</span></span>
<span id="cb29-106"><a href="#cb29-106" tabindex="-1"></a></span>
<span id="cb29-107"><a href="#cb29-107" tabindex="-1"></a><span class="co">// Compare L5 and L7</span></span>
<span id="cb29-108"><a href="#cb29-108" tabindex="-1"></a><span class="kw">var</span> L5Filtered <span class="op">=</span> L5</span>
<span id="cb29-109"><a href="#cb29-109" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(<span class="st">&#39;2005-01-01&#39;</span><span class="op">,</span> <span class="st">&#39;2006-01-01&#39;</span>))</span>
<span id="cb29-110"><a href="#cb29-110" tabindex="-1"></a>  <span class="op">.</span><span class="fu">select</span>([<span class="st">&#39;red&#39;</span><span class="op">,</span> <span class="st">&#39;nir&#39;</span>]<span class="op">,</span> [<span class="st">&#39;red_L5&#39;</span><span class="op">,</span> <span class="st">&#39;nir_L5&#39;</span>])<span class="op">;</span></span>
<span id="cb29-111"><a href="#cb29-111" tabindex="-1"></a></span>
<span id="cb29-112"><a href="#cb29-112" tabindex="-1"></a><span class="kw">var</span> L7Filtered <span class="op">=</span> L7</span>
<span id="cb29-113"><a href="#cb29-113" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(<span class="st">&#39;2005-01-01&#39;</span><span class="op">,</span> <span class="st">&#39;2006-01-01&#39;</span>))</span>
<span id="cb29-114"><a href="#cb29-114" tabindex="-1"></a>  <span class="op">.</span><span class="fu">select</span>([<span class="st">&#39;red&#39;</span><span class="op">,</span> <span class="st">&#39;nir&#39;</span>]<span class="op">,</span> [<span class="st">&#39;red_L7&#39;</span><span class="op">,</span> <span class="st">&#39;nir_L7&#39;</span>])<span class="op">;</span></span>
<span id="cb29-115"><a href="#cb29-115" tabindex="-1"></a></span>
<span id="cb29-116"><a href="#cb29-116" tabindex="-1"></a><span class="kw">var</span> L5L7merged <span class="op">=</span> L5Filtered<span class="op">.</span><span class="fu">merge</span>(L7Filtered)</span>
<span id="cb29-117"><a href="#cb29-117" tabindex="-1"></a></span>
<span id="cb29-118"><a href="#cb29-118" tabindex="-1"></a><span class="kw">var</span> chart <span class="op">=</span> ui<span class="op">.</span><span class="at">Chart</span><span class="op">.</span><span class="at">image</span><span class="op">.</span><span class="fu">series</span>({</span>
<span id="cb29-119"><a href="#cb29-119" tabindex="-1"></a>  <span class="dt">imageCollection</span><span class="op">:</span> L5L7merged<span class="op">,</span></span>
<span id="cb29-120"><a href="#cb29-120" tabindex="-1"></a>  <span class="dt">region</span><span class="op">:</span> geometry<span class="op">,</span></span>
<span id="cb29-121"><a href="#cb29-121" tabindex="-1"></a>  <span class="dt">reducer</span><span class="op">:</span> ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">mean</span>()<span class="op">,</span></span>
<span id="cb29-122"><a href="#cb29-122" tabindex="-1"></a>  <span class="dt">scale</span><span class="op">:</span> <span class="dv">30</span></span>
<span id="cb29-123"><a href="#cb29-123" tabindex="-1"></a>})<span class="op">.</span><span class="fu">setChartType</span>(<span class="st">&#39;LineChart&#39;</span>)</span>
<span id="cb29-124"><a href="#cb29-124" tabindex="-1"></a>  <span class="op">.</span><span class="fu">setOptions</span>({</span>
<span id="cb29-125"><a href="#cb29-125" tabindex="-1"></a>    <span class="dt">title</span><span class="op">:</span> <span class="st">&#39;Landsat 5 vs Landsat 7&#39;</span><span class="op">,</span></span>
<span id="cb29-126"><a href="#cb29-126" tabindex="-1"></a>    <span class="dt">interpolateNulls</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb29-127"><a href="#cb29-127" tabindex="-1"></a>    <span class="dt">vAxis</span><span class="op">:</span> {<span class="dt">title</span><span class="op">:</span> <span class="st">&#39;Reflectance&#39;</span><span class="op">,</span> <span class="dt">viewWindow</span><span class="op">:</span> {<span class="dt">min</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span> <span class="fl">0.5</span>}}<span class="op">,</span></span>
<span id="cb29-128"><a href="#cb29-128" tabindex="-1"></a>    <span class="dt">hAxis</span><span class="op">:</span> {<span class="dt">title</span><span class="op">:</span> <span class="st">&#39;&#39;</span><span class="op">,</span> <span class="dt">format</span><span class="op">:</span> <span class="st">&#39;YYYY-MM&#39;</span>}<span class="op">,</span></span>
<span id="cb29-129"><a href="#cb29-129" tabindex="-1"></a>    <span class="dt">lineWidth</span><span class="op">:</span> <span class="dv">1</span><span class="op">,</span></span>
<span id="cb29-130"><a href="#cb29-130" tabindex="-1"></a>    <span class="dt">pointSize</span><span class="op">:</span> <span class="dv">4</span><span class="op">,</span></span>
<span id="cb29-131"><a href="#cb29-131" tabindex="-1"></a>    <span class="dt">lineDashStyle</span><span class="op">:</span> [<span class="dv">4</span><span class="op">,</span> <span class="dv">4</span>]</span>
<span id="cb29-132"><a href="#cb29-132" tabindex="-1"></a>  })</span>
<span id="cb29-133"><a href="#cb29-133" tabindex="-1"></a><span class="fu">print</span>(chart)<span class="op">;</span></span>
<span id="cb29-134"><a href="#cb29-134" tabindex="-1"></a></span>
<span id="cb29-135"><a href="#cb29-135" tabindex="-1"></a><span class="co">// Compare L7 and L8</span></span>
<span id="cb29-136"><a href="#cb29-136" tabindex="-1"></a><span class="kw">var</span> L7Filtered <span class="op">=</span> L7</span>
<span id="cb29-137"><a href="#cb29-137" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(<span class="st">&#39;2016-01-01&#39;</span><span class="op">,</span> <span class="st">&#39;2017-01-01&#39;</span>))</span>
<span id="cb29-138"><a href="#cb29-138" tabindex="-1"></a>  <span class="op">.</span><span class="fu">select</span>([<span class="st">&#39;red&#39;</span><span class="op">,</span> <span class="st">&#39;nir&#39;</span>]<span class="op">,</span> [<span class="st">&#39;red_L7&#39;</span><span class="op">,</span> <span class="st">&#39;nir_L7&#39;</span>])<span class="op">;</span></span>
<span id="cb29-139"><a href="#cb29-139" tabindex="-1"></a></span>
<span id="cb29-140"><a href="#cb29-140" tabindex="-1"></a><span class="kw">var</span> L8Filtered <span class="op">=</span> L8</span>
<span id="cb29-141"><a href="#cb29-141" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(<span class="st">&#39;2016-01-01&#39;</span><span class="op">,</span> <span class="st">&#39;2017-01-01&#39;</span>))</span>
<span id="cb29-142"><a href="#cb29-142" tabindex="-1"></a>  <span class="op">.</span><span class="fu">select</span>([<span class="st">&#39;red&#39;</span><span class="op">,</span> <span class="st">&#39;nir&#39;</span>]<span class="op">,</span> [<span class="st">&#39;red_L8&#39;</span><span class="op">,</span> <span class="st">&#39;nir_L8&#39;</span>])<span class="op">;</span></span>
<span id="cb29-143"><a href="#cb29-143" tabindex="-1"></a></span>
<span id="cb29-144"><a href="#cb29-144" tabindex="-1"></a><span class="kw">var</span> L7L8merged <span class="op">=</span> L7Filtered<span class="op">.</span><span class="fu">merge</span>(L8Filtered)</span>
<span id="cb29-145"><a href="#cb29-145" tabindex="-1"></a></span>
<span id="cb29-146"><a href="#cb29-146" tabindex="-1"></a><span class="kw">var</span> chart <span class="op">=</span> ui<span class="op">.</span><span class="at">Chart</span><span class="op">.</span><span class="at">image</span><span class="op">.</span><span class="fu">series</span>({</span>
<span id="cb29-147"><a href="#cb29-147" tabindex="-1"></a>  <span class="dt">imageCollection</span><span class="op">:</span> L7L8merged<span class="op">,</span></span>
<span id="cb29-148"><a href="#cb29-148" tabindex="-1"></a>  <span class="dt">region</span><span class="op">:</span> geometry<span class="op">,</span></span>
<span id="cb29-149"><a href="#cb29-149" tabindex="-1"></a>  <span class="dt">reducer</span><span class="op">:</span> ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">mean</span>()<span class="op">,</span></span>
<span id="cb29-150"><a href="#cb29-150" tabindex="-1"></a>  <span class="dt">scale</span><span class="op">:</span> <span class="dv">30</span></span>
<span id="cb29-151"><a href="#cb29-151" tabindex="-1"></a>})<span class="op">.</span><span class="fu">setChartType</span>(<span class="st">&#39;LineChart&#39;</span>)</span>
<span id="cb29-152"><a href="#cb29-152" tabindex="-1"></a>  <span class="op">.</span><span class="fu">setOptions</span>({</span>
<span id="cb29-153"><a href="#cb29-153" tabindex="-1"></a>    <span class="dt">title</span><span class="op">:</span> <span class="st">&#39;Landsat 7 vs Landsat 8&#39;</span><span class="op">,</span></span>
<span id="cb29-154"><a href="#cb29-154" tabindex="-1"></a>    <span class="dt">interpolateNulls</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb29-155"><a href="#cb29-155" tabindex="-1"></a>    <span class="dt">vAxis</span><span class="op">:</span> {<span class="dt">title</span><span class="op">:</span> <span class="st">&#39;Reflectance&#39;</span><span class="op">,</span> <span class="dt">viewWindow</span><span class="op">:</span> {<span class="dt">min</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span> <span class="fl">0.5</span>}}<span class="op">,</span></span>
<span id="cb29-156"><a href="#cb29-156" tabindex="-1"></a>    <span class="dt">hAxis</span><span class="op">:</span> {<span class="dt">title</span><span class="op">:</span> <span class="st">&#39;&#39;</span><span class="op">,</span> <span class="dt">format</span><span class="op">:</span> <span class="st">&#39;YYYY-MM&#39;</span>}<span class="op">,</span></span>
<span id="cb29-157"><a href="#cb29-157" tabindex="-1"></a>    <span class="dt">lineWidth</span><span class="op">:</span> <span class="dv">1</span><span class="op">,</span></span>
<span id="cb29-158"><a href="#cb29-158" tabindex="-1"></a>    <span class="dt">pointSize</span><span class="op">:</span> <span class="dv">4</span><span class="op">,</span></span>
<span id="cb29-159"><a href="#cb29-159" tabindex="-1"></a>    <span class="dt">lineDashStyle</span><span class="op">:</span> [<span class="dv">4</span><span class="op">,</span> <span class="dv">4</span>]</span>
<span id="cb29-160"><a href="#cb29-160" tabindex="-1"></a>  })</span>
<span id="cb29-161"><a href="#cb29-161" tabindex="-1"></a><span class="fu">print</span>(chart)<span class="op">;</span></span>
<span id="cb29-162"><a href="#cb29-162" tabindex="-1"></a></span>
<span id="cb29-163"><a href="#cb29-163" tabindex="-1"></a><span class="co">// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span></span>
<span id="cb29-164"><a href="#cb29-164" tabindex="-1"></a><span class="co">// Step 3b: Select Date Ranges, Filter and Merge</span></span>
<span id="cb29-165"><a href="#cb29-165" tabindex="-1"></a><span class="co">// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span></span>
<span id="cb29-166"><a href="#cb29-166" tabindex="-1"></a><span class="co">// See the Landsat timeline for date ranges</span></span>
<span id="cb29-167"><a href="#cb29-167" tabindex="-1"></a><span class="co">// https://www.usgs.gov/media/images/landsat-missions-timeline</span></span>
<span id="cb29-168"><a href="#cb29-168" tabindex="-1"></a></span>
<span id="cb29-169"><a href="#cb29-169" tabindex="-1"></a><span class="co">// Adjust the range depending on your </span></span>
<span id="cb29-170"><a href="#cb29-170" tabindex="-1"></a><span class="co">// application and location</span></span>
<span id="cb29-171"><a href="#cb29-171" tabindex="-1"></a><span class="kw">var</span> l5Start <span class="op">=</span> ee<span class="op">.</span><span class="at">Date</span><span class="op">.</span><span class="fu">fromYMD</span>(<span class="dv">1990</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb29-172"><a href="#cb29-172" tabindex="-1"></a><span class="kw">var</span> l5End <span class="op">=</span> ee<span class="op">.</span><span class="at">Date</span><span class="op">.</span><span class="fu">fromYMD</span>(<span class="dv">1999</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb29-173"><a href="#cb29-173" tabindex="-1"></a></span>
<span id="cb29-174"><a href="#cb29-174" tabindex="-1"></a><span class="kw">var</span> l7Start <span class="op">=</span> ee<span class="op">.</span><span class="at">Date</span><span class="op">.</span><span class="fu">fromYMD</span>(<span class="dv">1999</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb29-175"><a href="#cb29-175" tabindex="-1"></a><span class="kw">var</span> l7End <span class="op">=</span> ee<span class="op">.</span><span class="at">Date</span><span class="op">.</span><span class="fu">fromYMD</span>(<span class="dv">2014</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb29-176"><a href="#cb29-176" tabindex="-1"></a></span>
<span id="cb29-177"><a href="#cb29-177" tabindex="-1"></a><span class="kw">var</span> l8Start <span class="op">=</span> ee<span class="op">.</span><span class="at">Date</span><span class="op">.</span><span class="fu">fromYMD</span>(<span class="dv">2014</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb29-178"><a href="#cb29-178" tabindex="-1"></a><span class="kw">var</span> l8End <span class="op">=</span> ee<span class="op">.</span><span class="at">Date</span><span class="op">.</span><span class="fu">fromYMD</span>(<span class="dv">2023</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb29-179"><a href="#cb29-179" tabindex="-1"></a></span>
<span id="cb29-180"><a href="#cb29-180" tabindex="-1"></a><span class="kw">var</span> L5 <span class="op">=</span> L5</span>
<span id="cb29-181"><a href="#cb29-181" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(l5Start<span class="op">,</span> l5End))</span>
<span id="cb29-182"><a href="#cb29-182" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">bounds</span>(geometry))<span class="op">;</span></span>
<span id="cb29-183"><a href="#cb29-183" tabindex="-1"></a></span>
<span id="cb29-184"><a href="#cb29-184" tabindex="-1"></a><span class="kw">var</span> L7 <span class="op">=</span> L7</span>
<span id="cb29-185"><a href="#cb29-185" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(l7Start<span class="op">,</span> l7End))</span>
<span id="cb29-186"><a href="#cb29-186" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">bounds</span>(geometry))<span class="op">;</span></span>
<span id="cb29-187"><a href="#cb29-187" tabindex="-1"></a></span>
<span id="cb29-188"><a href="#cb29-188" tabindex="-1"></a><span class="kw">var</span> L8 <span class="op">=</span> L8</span>
<span id="cb29-189"><a href="#cb29-189" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(l8Start<span class="op">,</span> l8End))</span>
<span id="cb29-190"><a href="#cb29-190" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">bounds</span>(geometry))<span class="op">;</span></span>
<span id="cb29-191"><a href="#cb29-191" tabindex="-1"></a>  </span>
<span id="cb29-192"><a href="#cb29-192" tabindex="-1"></a><span class="kw">var</span> merged <span class="op">=</span> L5<span class="op">.</span><span class="fu">merge</span>(L7)<span class="op">.</span><span class="fu">merge</span>(L8)</span>
<span id="cb29-193"><a href="#cb29-193" tabindex="-1"></a></span>
<span id="cb29-194"><a href="#cb29-194" tabindex="-1"></a><span class="co">// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span></span>
<span id="cb29-195"><a href="#cb29-195" tabindex="-1"></a><span class="co">// Step 4: Create Annual Composites</span></span>
<span id="cb29-196"><a href="#cb29-196" tabindex="-1"></a><span class="co">// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span></span>
<span id="cb29-197"><a href="#cb29-197" tabindex="-1"></a><span class="kw">var</span> years <span class="op">=</span> ee<span class="op">.</span><span class="at">List</span><span class="op">.</span><span class="fu">sequence</span>(<span class="dv">1990</span><span class="op">,</span> <span class="dv">2023</span>)<span class="op">;</span></span>
<span id="cb29-198"><a href="#cb29-198" tabindex="-1"></a></span>
<span id="cb29-199"><a href="#cb29-199" tabindex="-1"></a><span class="kw">var</span> compositeImages <span class="op">=</span> years<span class="op">.</span><span class="fu">map</span>(<span class="kw">function</span>(year) {</span>
<span id="cb29-200"><a href="#cb29-200" tabindex="-1"></a>  <span class="kw">var</span> startDate <span class="op">=</span> ee<span class="op">.</span><span class="at">Date</span><span class="op">.</span><span class="fu">fromYMD</span>(year<span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb29-201"><a href="#cb29-201" tabindex="-1"></a>  <span class="kw">var</span> endDate <span class="op">=</span> startDate<span class="op">.</span><span class="fu">advance</span>(<span class="dv">1</span><span class="op">,</span> <span class="st">&#39;year&#39;</span>)<span class="op">;</span></span>
<span id="cb29-202"><a href="#cb29-202" tabindex="-1"></a>  <span class="kw">var</span> yearFiltered <span class="op">=</span> merged<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(startDate<span class="op">,</span> endDate))<span class="op">;</span></span>
<span id="cb29-203"><a href="#cb29-203" tabindex="-1"></a>  <span class="kw">var</span> composite <span class="op">=</span> yearFiltered<span class="op">.</span><span class="fu">median</span>()<span class="op">;</span></span>
<span id="cb29-204"><a href="#cb29-204" tabindex="-1"></a>  <span class="cf">return</span> composite<span class="op">.</span><span class="fu">set</span>({</span>
<span id="cb29-205"><a href="#cb29-205" tabindex="-1"></a>    <span class="st">&#39;year&#39;</span><span class="op">:</span> year<span class="op">,</span></span>
<span id="cb29-206"><a href="#cb29-206" tabindex="-1"></a>    <span class="st">&#39;system:time_start&#39;</span><span class="op">:</span> startDate<span class="op">.</span><span class="fu">millis</span>()<span class="op">,</span></span>
<span id="cb29-207"><a href="#cb29-207" tabindex="-1"></a>    <span class="st">&#39;system:time_end&#39;</span><span class="op">:</span> endDate<span class="op">.</span><span class="fu">millis</span>()<span class="op">,</span></span>
<span id="cb29-208"><a href="#cb29-208" tabindex="-1"></a>  })</span>
<span id="cb29-209"><a href="#cb29-209" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb29-210"><a href="#cb29-210" tabindex="-1"></a></span>
<span id="cb29-211"><a href="#cb29-211" tabindex="-1"></a><span class="kw">var</span> compositeCol <span class="op">=</span> ee<span class="op">.</span><span class="at">ImageCollection</span><span class="op">.</span><span class="fu">fromImages</span>(compositeImages)<span class="op">;</span></span>
<span id="cb29-212"><a href="#cb29-212" tabindex="-1"></a><span class="fu">print</span>(<span class="st">&#39;Annual Landsat Composites&#39;</span><span class="op">,</span> compositeCol)<span class="op">;</span></span></code></pre></div>
</div>
<div id="landsat-timelapse-animation-with-text" class="section level2">
<h2>Landsat Timelapse Animation with Text</h2>
<p>We can build a collection of cloud-free annual composites from the <a
href="#harmonized-landsat-time-series">Harmonized Landsat Time
Series</a> and create a timelapse animation. Since Earth Engine does not
have a built-in way to render text, we leverage Gennadii Donchyts’s <a
href="https://github.com/gee-community/ee-packages-js"><code>text</code>
package</a> for adding text overlay of the year on the images. The
exported video can be converted to an animated GIF using <a
href="https://ezgif.com/" class="uri">https://ezgif.com/</a>.</p>
<div class="figure" style="text-align: center">
<img src="images/end_to_end_gee/alamatti_animation.gif" alt="Timelapse Animation" width="80%" />
<p class="caption">
Timelapse Animation
</p>
</div>
<p><a
href="https://code.earthengine.google.co.in/?scriptPath=users%2Fujavalgandhi%2FEnd-to-End-GEE%3ASupplement%2FImage_Collections%2FLandsat_Timelapse_Animation"
target="_blank">Open in Code Editor ↗</a></p>
<div class="sourceCode" id="cb30"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb30-1"><a href="#cb30-1" tabindex="-1"></a><span class="kw">var</span> geometry <span class="op">=</span> ee<span class="op">.</span><span class="at">Geometry</span><span class="op">.</span><span class="fu">Polygon</span>([[</span>
<span id="cb30-2"><a href="#cb30-2" tabindex="-1"></a>  [<span class="fl">75.5210</span><span class="op">,</span> <span class="fl">16.4779</span>]<span class="op">,</span></span>
<span id="cb30-3"><a href="#cb30-3" tabindex="-1"></a>  [<span class="fl">75.5210</span><span class="op">,</span> <span class="fl">16.1656</span>]<span class="op">,</span></span>
<span id="cb30-4"><a href="#cb30-4" tabindex="-1"></a>  [<span class="fl">75.9906</span><span class="op">,</span> <span class="fl">16.1656</span>]<span class="op">,</span></span>
<span id="cb30-5"><a href="#cb30-5" tabindex="-1"></a>  [<span class="fl">75.9906</span><span class="op">,</span> <span class="fl">16.4779</span>]</span>
<span id="cb30-6"><a href="#cb30-6" tabindex="-1"></a>]])<span class="op">;</span></span>
<span id="cb30-7"><a href="#cb30-7" tabindex="-1"></a><span class="co">// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span></span>
<span id="cb30-8"><a href="#cb30-8" tabindex="-1"></a><span class="co">// Select the Landsat dataset</span></span>
<span id="cb30-9"><a href="#cb30-9" tabindex="-1"></a><span class="co">// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span></span>
<span id="cb30-10"><a href="#cb30-10" tabindex="-1"></a></span>
<span id="cb30-11"><a href="#cb30-11" tabindex="-1"></a><span class="co">// We use &quot;Landsat Level 2 Collection 2 Tier-1 Scenes&quot;</span></span>
<span id="cb30-12"><a href="#cb30-12" tabindex="-1"></a></span>
<span id="cb30-13"><a href="#cb30-13" tabindex="-1"></a><span class="co">// Collection 2 --&gt;</span></span>
<span id="cb30-14"><a href="#cb30-14" tabindex="-1"></a><span class="co">// Landsat Collection 2 algorithm has improved</span></span>
<span id="cb30-15"><a href="#cb30-15" tabindex="-1"></a><span class="co">// geometric and radiometric calibration that makes</span></span>
<span id="cb30-16"><a href="#cb30-16" tabindex="-1"></a><span class="co">// the collections interoperable.</span></span>
<span id="cb30-17"><a href="#cb30-17" tabindex="-1"></a><span class="co">// Learn more at https://www.usgs.gov/landsat-missions/landsat-collection-2</span></span>
<span id="cb30-18"><a href="#cb30-18" tabindex="-1"></a></span>
<span id="cb30-19"><a href="#cb30-19" tabindex="-1"></a><span class="co">// Level 2 --&gt;</span></span>
<span id="cb30-20"><a href="#cb30-20" tabindex="-1"></a><span class="co">// This is a surface reflectance product and </span></span>
<span id="cb30-21"><a href="#cb30-21" tabindex="-1"></a><span class="co">// have the highest level of interoperability through time.</span></span>
<span id="cb30-22"><a href="#cb30-22" tabindex="-1"></a></span>
<span id="cb30-23"><a href="#cb30-23" tabindex="-1"></a><span class="co">// Tier 1 --&gt;</span></span>
<span id="cb30-24"><a href="#cb30-24" tabindex="-1"></a><span class="co">// Highest quality scenes which are considered suitable</span></span>
<span id="cb30-25"><a href="#cb30-25" tabindex="-1"></a><span class="co">// for time-series analysis</span></span>
<span id="cb30-26"><a href="#cb30-26" tabindex="-1"></a><span class="kw">var</span> L5 <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&#39;LANDSAT/LT05/C02/T1_L2&#39;</span>)<span class="op">;</span></span>
<span id="cb30-27"><a href="#cb30-27" tabindex="-1"></a><span class="kw">var</span> L7 <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&#39;LANDSAT/LE07/C02/T1_L2&#39;</span>)<span class="op">;</span></span>
<span id="cb30-28"><a href="#cb30-28" tabindex="-1"></a><span class="kw">var</span> L8 <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&#39;LANDSAT/LC08/C02/T1_L2&#39;</span>)<span class="op">;</span></span>
<span id="cb30-29"><a href="#cb30-29" tabindex="-1"></a></span>
<span id="cb30-30"><a href="#cb30-30" tabindex="-1"></a><span class="co">// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span></span>
<span id="cb30-31"><a href="#cb30-31" tabindex="-1"></a><span class="co">// Data Pre-Processing and Cloud Masking</span></span>
<span id="cb30-32"><a href="#cb30-32" tabindex="-1"></a><span class="co">// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span></span>
<span id="cb30-33"><a href="#cb30-33" tabindex="-1"></a></span>
<span id="cb30-34"><a href="#cb30-34" tabindex="-1"></a><span class="co">// Mapping of band-names to a uniform naming scheme</span></span>
<span id="cb30-35"><a href="#cb30-35" tabindex="-1"></a><span class="kw">var</span> l5Bands <span class="op">=</span> [<span class="st">&#39;SR_B1&#39;</span><span class="op">,</span><span class="st">&#39;SR_B2&#39;</span><span class="op">,</span><span class="st">&#39;SR_B3&#39;</span><span class="op">,</span><span class="st">&#39;SR_B4&#39;</span><span class="op">,</span><span class="st">&#39;SR_B5&#39;</span><span class="op">,</span><span class="st">&#39;SR_B7&#39;</span>]<span class="op">;</span></span>
<span id="cb30-36"><a href="#cb30-36" tabindex="-1"></a><span class="kw">var</span> l5names <span class="op">=</span> [<span class="st">&#39;blue&#39;</span><span class="op">,</span><span class="st">&#39;green&#39;</span><span class="op">,</span><span class="st">&#39;red&#39;</span><span class="op">,</span><span class="st">&#39;nir&#39;</span><span class="op">,</span><span class="st">&#39;swir1&#39;</span><span class="op">,</span><span class="st">&#39;swir2&#39;</span>]<span class="op">;</span></span>
<span id="cb30-37"><a href="#cb30-37" tabindex="-1"></a></span>
<span id="cb30-38"><a href="#cb30-38" tabindex="-1"></a><span class="kw">var</span> l7Bands <span class="op">=</span> [<span class="st">&#39;SR_B1&#39;</span><span class="op">,</span><span class="st">&#39;SR_B2&#39;</span><span class="op">,</span><span class="st">&#39;SR_B3&#39;</span><span class="op">,</span><span class="st">&#39;SR_B4&#39;</span><span class="op">,</span><span class="st">&#39;SR_B5&#39;</span><span class="op">,</span><span class="st">&#39;SR_B7&#39;</span>]<span class="op">;</span></span>
<span id="cb30-39"><a href="#cb30-39" tabindex="-1"></a><span class="kw">var</span> l7names <span class="op">=</span> [<span class="st">&#39;blue&#39;</span><span class="op">,</span><span class="st">&#39;green&#39;</span><span class="op">,</span><span class="st">&#39;red&#39;</span><span class="op">,</span><span class="st">&#39;nir&#39;</span><span class="op">,</span><span class="st">&#39;swir1&#39;</span><span class="op">,</span><span class="st">&#39;swir2&#39;</span>]<span class="op">;</span></span>
<span id="cb30-40"><a href="#cb30-40" tabindex="-1"></a></span>
<span id="cb30-41"><a href="#cb30-41" tabindex="-1"></a><span class="kw">var</span> l8Bands <span class="op">=</span> [<span class="st">&#39;SR_B2&#39;</span><span class="op">,</span><span class="st">&#39;SR_B3&#39;</span><span class="op">,</span><span class="st">&#39;SR_B4&#39;</span><span class="op">,</span><span class="st">&#39;SR_B5&#39;</span><span class="op">,</span><span class="st">&#39;SR_B6&#39;</span><span class="op">,</span><span class="st">&#39;SR_B7&#39;</span>]<span class="op">;</span></span>
<span id="cb30-42"><a href="#cb30-42" tabindex="-1"></a><span class="kw">var</span> l8names <span class="op">=</span> [<span class="st">&#39;blue&#39;</span><span class="op">,</span><span class="st">&#39;green&#39;</span><span class="op">,</span><span class="st">&#39;red&#39;</span><span class="op">,</span><span class="st">&#39;nir&#39;</span><span class="op">,</span><span class="st">&#39;swir1&#39;</span><span class="op">,</span><span class="st">&#39;swir2&#39;</span>]<span class="op">;</span></span>
<span id="cb30-43"><a href="#cb30-43" tabindex="-1"></a></span>
<span id="cb30-44"><a href="#cb30-44" tabindex="-1"></a><span class="co">// Cloud masking function for Landsat 4,5 and 7</span></span>
<span id="cb30-45"><a href="#cb30-45" tabindex="-1"></a><span class="kw">function</span> <span class="fu">maskL457sr</span>(image) {</span>
<span id="cb30-46"><a href="#cb30-46" tabindex="-1"></a>  <span class="kw">var</span> qaMask <span class="op">=</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;QA_PIXEL&#39;</span>)<span class="op">.</span><span class="fu">bitwiseAnd</span>(<span class="pp">parseInt</span>(<span class="st">&#39;11111&#39;</span><span class="op">,</span> <span class="dv">2</span>))<span class="op">.</span><span class="fu">eq</span>(<span class="dv">0</span>)<span class="op">;</span></span>
<span id="cb30-47"><a href="#cb30-47" tabindex="-1"></a>  <span class="kw">var</span> saturationMask <span class="op">=</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;QA_RADSAT&#39;</span>)<span class="op">.</span><span class="fu">eq</span>(<span class="dv">0</span>)<span class="op">;</span></span>
<span id="cb30-48"><a href="#cb30-48" tabindex="-1"></a></span>
<span id="cb30-49"><a href="#cb30-49" tabindex="-1"></a>  <span class="co">// Apply the scaling factors to the appropriate bands.</span></span>
<span id="cb30-50"><a href="#cb30-50" tabindex="-1"></a>  <span class="kw">var</span> opticalBands <span class="op">=</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;SR_B.&#39;</span>)<span class="op">.</span><span class="fu">multiply</span>(<span class="fl">0.0000275</span>)<span class="op">.</span><span class="fu">add</span>(<span class="op">-</span><span class="fl">0.2</span>)<span class="op">;</span></span>
<span id="cb30-51"><a href="#cb30-51" tabindex="-1"></a>  <span class="kw">var</span> thermalBand <span class="op">=</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;ST_B6&#39;</span>)<span class="op">.</span><span class="fu">multiply</span>(<span class="fl">0.00341802</span>)<span class="op">.</span><span class="fu">add</span>(<span class="fl">149.0</span>)<span class="op">;</span></span>
<span id="cb30-52"><a href="#cb30-52" tabindex="-1"></a></span>
<span id="cb30-53"><a href="#cb30-53" tabindex="-1"></a>  <span class="co">// Replace the original bands with the scaled ones and apply the masks.</span></span>
<span id="cb30-54"><a href="#cb30-54" tabindex="-1"></a>  <span class="cf">return</span> image<span class="op">.</span><span class="fu">addBands</span>(opticalBands<span class="op">,</span> <span class="kw">null</span><span class="op">,</span> <span class="kw">true</span>)</span>
<span id="cb30-55"><a href="#cb30-55" tabindex="-1"></a>      <span class="op">.</span><span class="fu">addBands</span>(thermalBand<span class="op">,</span> <span class="kw">null</span><span class="op">,</span> <span class="kw">true</span>)</span>
<span id="cb30-56"><a href="#cb30-56" tabindex="-1"></a>      <span class="op">.</span><span class="fu">updateMask</span>(qaMask)</span>
<span id="cb30-57"><a href="#cb30-57" tabindex="-1"></a>      <span class="op">.</span><span class="fu">updateMask</span>(saturationMask)</span>
<span id="cb30-58"><a href="#cb30-58" tabindex="-1"></a>      <span class="op">.</span><span class="fu">copyProperties</span>(image<span class="op">,</span> [<span class="st">&#39;system:time_start&#39;</span>])<span class="op">;</span></span>
<span id="cb30-59"><a href="#cb30-59" tabindex="-1"></a>}</span>
<span id="cb30-60"><a href="#cb30-60" tabindex="-1"></a></span>
<span id="cb30-61"><a href="#cb30-61" tabindex="-1"></a><span class="co">// Cloud masking function for Landsat 8</span></span>
<span id="cb30-62"><a href="#cb30-62" tabindex="-1"></a><span class="kw">function</span> <span class="fu">maskL8sr</span>(image) {</span>
<span id="cb30-63"><a href="#cb30-63" tabindex="-1"></a>  <span class="kw">var</span> qaMask <span class="op">=</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;QA_PIXEL&#39;</span>)<span class="op">.</span><span class="fu">bitwiseAnd</span>(<span class="pp">parseInt</span>(<span class="st">&#39;11111&#39;</span><span class="op">,</span> <span class="dv">2</span>))<span class="op">.</span><span class="fu">eq</span>(<span class="dv">0</span>)<span class="op">;</span></span>
<span id="cb30-64"><a href="#cb30-64" tabindex="-1"></a>  <span class="kw">var</span> saturationMask <span class="op">=</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;QA_RADSAT&#39;</span>)<span class="op">.</span><span class="fu">eq</span>(<span class="dv">0</span>)<span class="op">;</span></span>
<span id="cb30-65"><a href="#cb30-65" tabindex="-1"></a></span>
<span id="cb30-66"><a href="#cb30-66" tabindex="-1"></a>  <span class="co">// Apply the scaling factors to the appropriate bands.</span></span>
<span id="cb30-67"><a href="#cb30-67" tabindex="-1"></a>  <span class="kw">var</span> opticalBands <span class="op">=</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;SR_B.&#39;</span>)<span class="op">.</span><span class="fu">multiply</span>(<span class="fl">0.0000275</span>)<span class="op">.</span><span class="fu">add</span>(<span class="op">-</span><span class="fl">0.2</span>)<span class="op">;</span></span>
<span id="cb30-68"><a href="#cb30-68" tabindex="-1"></a>  <span class="kw">var</span> thermalBands <span class="op">=</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;ST_B.*&#39;</span>)<span class="op">.</span><span class="fu">multiply</span>(<span class="fl">0.00341802</span>)<span class="op">.</span><span class="fu">add</span>(<span class="fl">149.0</span>)<span class="op">;</span></span>
<span id="cb30-69"><a href="#cb30-69" tabindex="-1"></a></span>
<span id="cb30-70"><a href="#cb30-70" tabindex="-1"></a>  <span class="co">// Replace the original bands with the scaled ones and apply the masks.</span></span>
<span id="cb30-71"><a href="#cb30-71" tabindex="-1"></a>  <span class="cf">return</span> image<span class="op">.</span><span class="fu">addBands</span>(opticalBands<span class="op">,</span> <span class="kw">null</span><span class="op">,</span> <span class="kw">true</span>)</span>
<span id="cb30-72"><a href="#cb30-72" tabindex="-1"></a>      <span class="op">.</span><span class="fu">addBands</span>(thermalBands<span class="op">,</span> <span class="kw">null</span><span class="op">,</span> <span class="kw">true</span>)</span>
<span id="cb30-73"><a href="#cb30-73" tabindex="-1"></a>      <span class="op">.</span><span class="fu">updateMask</span>(qaMask)</span>
<span id="cb30-74"><a href="#cb30-74" tabindex="-1"></a>      <span class="op">.</span><span class="fu">updateMask</span>(saturationMask)</span>
<span id="cb30-75"><a href="#cb30-75" tabindex="-1"></a>      <span class="op">.</span><span class="fu">copyProperties</span>(image<span class="op">,</span> [<span class="st">&#39;system:time_start&#39;</span>])<span class="op">;</span></span>
<span id="cb30-76"><a href="#cb30-76" tabindex="-1"></a>}</span>
<span id="cb30-77"><a href="#cb30-77" tabindex="-1"></a></span>
<span id="cb30-78"><a href="#cb30-78" tabindex="-1"></a><span class="co">// Apply filters, cloud-mask and rename bands</span></span>
<span id="cb30-79"><a href="#cb30-79" tabindex="-1"></a><span class="co">// Filters from https://github.com/google/earthengine-catalog/blob/main/pipelines/landsat.py</span></span>
<span id="cb30-80"><a href="#cb30-80" tabindex="-1"></a><span class="kw">var</span> L5 <span class="op">=</span> L5</span>
<span id="cb30-81"><a href="#cb30-81" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">lt</span>(<span class="st">&#39;WRS_ROW&#39;</span><span class="op">,</span> <span class="dv">122</span>))  <span class="co">// Remove night-time images.</span></span>
<span id="cb30-82"><a href="#cb30-82" tabindex="-1"></a>  <span class="op">.</span><span class="fu">map</span>(maskL457sr)</span>
<span id="cb30-83"><a href="#cb30-83" tabindex="-1"></a>  <span class="op">.</span><span class="fu">select</span>(l5Bands<span class="op">,</span>l5names)<span class="op">;</span></span>
<span id="cb30-84"><a href="#cb30-84" tabindex="-1"></a></span>
<span id="cb30-85"><a href="#cb30-85" tabindex="-1"></a><span class="kw">var</span> L7 <span class="op">=</span> L7</span>
<span id="cb30-86"><a href="#cb30-86" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">lt</span>(<span class="st">&#39;WRS_ROW&#39;</span><span class="op">,</span> <span class="dv">122</span>))  <span class="co">// Remove night-time images.</span></span>
<span id="cb30-87"><a href="#cb30-87" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(<span class="st">&#39;1984-01-01&#39;</span><span class="op">,</span> <span class="st">&#39;2017-01-01&#39;</span>))  <span class="co">// Orbital drift after 2017.</span></span>
<span id="cb30-88"><a href="#cb30-88" tabindex="-1"></a>  <span class="op">.</span><span class="fu">map</span>(maskL457sr)</span>
<span id="cb30-89"><a href="#cb30-89" tabindex="-1"></a>  <span class="op">.</span><span class="fu">select</span>(l7Bands<span class="op">,</span>l7names)<span class="op">;</span></span>
<span id="cb30-90"><a href="#cb30-90" tabindex="-1"></a></span>
<span id="cb30-91"><a href="#cb30-91" tabindex="-1"></a><span class="kw">var</span> L8 <span class="op">=</span> L8</span>
<span id="cb30-92"><a href="#cb30-92" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(<span class="st">&#39;2013-05-01&#39;</span><span class="op">,</span> <span class="st">&#39;2099-01-01&#39;</span>)) <span class="co">// Images before May 1 had some pointing issues.</span></span>
<span id="cb30-93"><a href="#cb30-93" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">neq</span>(<span class="st">&#39;NADIR_OFFNADIR&#39;</span><span class="op">,</span> <span class="st">&#39;OFFNADIR&#39;</span>))</span>
<span id="cb30-94"><a href="#cb30-94" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">lt</span>(<span class="st">&#39;WRS_ROW&#39;</span><span class="op">,</span> <span class="dv">122</span>))  <span class="co">// Remove night-time images.</span></span>
<span id="cb30-95"><a href="#cb30-95" tabindex="-1"></a>  <span class="op">.</span><span class="fu">map</span>(maskL8sr)</span>
<span id="cb30-96"><a href="#cb30-96" tabindex="-1"></a>  <span class="op">.</span><span class="fu">select</span>(l8Bands<span class="op">,</span>l8names)<span class="op">;</span></span>
<span id="cb30-97"><a href="#cb30-97" tabindex="-1"></a></span>
<span id="cb30-98"><a href="#cb30-98" tabindex="-1"></a><span class="co">// Adjust the range depending on your </span></span>
<span id="cb30-99"><a href="#cb30-99" tabindex="-1"></a><span class="co">// application and location</span></span>
<span id="cb30-100"><a href="#cb30-100" tabindex="-1"></a><span class="kw">var</span> l5Start <span class="op">=</span> ee<span class="op">.</span><span class="at">Date</span><span class="op">.</span><span class="fu">fromYMD</span>(<span class="dv">1985</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb30-101"><a href="#cb30-101" tabindex="-1"></a><span class="kw">var</span> l5End <span class="op">=</span> ee<span class="op">.</span><span class="at">Date</span><span class="op">.</span><span class="fu">fromYMD</span>(<span class="dv">2001</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb30-102"><a href="#cb30-102" tabindex="-1"></a></span>
<span id="cb30-103"><a href="#cb30-103" tabindex="-1"></a><span class="kw">var</span> l7Start <span class="op">=</span> ee<span class="op">.</span><span class="at">Date</span><span class="op">.</span><span class="fu">fromYMD</span>(<span class="dv">2001</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb30-104"><a href="#cb30-104" tabindex="-1"></a><span class="kw">var</span> l7End <span class="op">=</span> ee<span class="op">.</span><span class="at">Date</span><span class="op">.</span><span class="fu">fromYMD</span>(<span class="dv">2014</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb30-105"><a href="#cb30-105" tabindex="-1"></a></span>
<span id="cb30-106"><a href="#cb30-106" tabindex="-1"></a><span class="kw">var</span> l8Start <span class="op">=</span> ee<span class="op">.</span><span class="at">Date</span><span class="op">.</span><span class="fu">fromYMD</span>(<span class="dv">2014</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb30-107"><a href="#cb30-107" tabindex="-1"></a><span class="kw">var</span> l8End <span class="op">=</span> ee<span class="op">.</span><span class="at">Date</span><span class="op">.</span><span class="fu">fromYMD</span>(<span class="dv">2023</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb30-108"><a href="#cb30-108" tabindex="-1"></a></span>
<span id="cb30-109"><a href="#cb30-109" tabindex="-1"></a><span class="kw">var</span> L5 <span class="op">=</span> L5</span>
<span id="cb30-110"><a href="#cb30-110" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(l5Start<span class="op">,</span> l5End))</span>
<span id="cb30-111"><a href="#cb30-111" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">bounds</span>(geometry))<span class="op">;</span></span>
<span id="cb30-112"><a href="#cb30-112" tabindex="-1"></a></span>
<span id="cb30-113"><a href="#cb30-113" tabindex="-1"></a><span class="kw">var</span> L7 <span class="op">=</span> L7</span>
<span id="cb30-114"><a href="#cb30-114" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(l7Start<span class="op">,</span> l7End))</span>
<span id="cb30-115"><a href="#cb30-115" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">bounds</span>(geometry))<span class="op">;</span></span>
<span id="cb30-116"><a href="#cb30-116" tabindex="-1"></a></span>
<span id="cb30-117"><a href="#cb30-117" tabindex="-1"></a><span class="kw">var</span> L8 <span class="op">=</span> L8</span>
<span id="cb30-118"><a href="#cb30-118" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(l8Start<span class="op">,</span> l8End))</span>
<span id="cb30-119"><a href="#cb30-119" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">bounds</span>(geometry))<span class="op">;</span></span>
<span id="cb30-120"><a href="#cb30-120" tabindex="-1"></a>  </span>
<span id="cb30-121"><a href="#cb30-121" tabindex="-1"></a><span class="co">// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span></span>
<span id="cb30-122"><a href="#cb30-122" tabindex="-1"></a><span class="co">// Optional: Gap-Fill Landsat 7</span></span>
<span id="cb30-123"><a href="#cb30-123" tabindex="-1"></a><span class="co">// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span></span>
<span id="cb30-124"><a href="#cb30-124" tabindex="-1"></a></span>
<span id="cb30-125"><a href="#cb30-125" tabindex="-1"></a><span class="kw">var</span> kernelSize <span class="op">=</span> <span class="dv">25</span><span class="op">;</span></span>
<span id="cb30-126"><a href="#cb30-126" tabindex="-1"></a><span class="kw">var</span> kernel <span class="op">=</span> ee<span class="op">.</span><span class="at">Kernel</span><span class="op">.</span><span class="fu">square</span>(kernelSize <span class="op">*</span> <span class="dv">30</span><span class="op">,</span> <span class="st">&#39;meters&#39;</span><span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span></span>
<span id="cb30-127"><a href="#cb30-127" tabindex="-1"></a></span>
<span id="cb30-128"><a href="#cb30-128" tabindex="-1"></a><span class="kw">var</span> gapFill <span class="op">=</span> <span class="kw">function</span>(image) {</span>
<span id="cb30-129"><a href="#cb30-129" tabindex="-1"></a>  <span class="kw">var</span> start <span class="op">=</span> image<span class="op">.</span><span class="fu">date</span>()<span class="op">.</span><span class="fu">advance</span>(<span class="op">-</span><span class="dv">1</span><span class="op">,</span> <span class="st">&#39;year&#39;</span>)<span class="op">;</span></span>
<span id="cb30-130"><a href="#cb30-130" tabindex="-1"></a>  <span class="kw">var</span> end <span class="op">=</span> image<span class="op">.</span><span class="fu">date</span>()<span class="op">.</span><span class="fu">advance</span>(<span class="dv">1</span><span class="op">,</span> <span class="st">&#39;year&#39;</span>)<span class="op">;</span></span>
<span id="cb30-131"><a href="#cb30-131" tabindex="-1"></a>  <span class="kw">var</span> fill <span class="op">=</span> L7<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(start<span class="op">,</span> end))<span class="op">.</span><span class="fu">median</span>()<span class="op">;</span></span>
<span id="cb30-132"><a href="#cb30-132" tabindex="-1"></a>  <span class="kw">var</span> regress <span class="op">=</span> fill<span class="op">.</span><span class="fu">addBands</span>(image)<span class="op">;</span> </span>
<span id="cb30-133"><a href="#cb30-133" tabindex="-1"></a>  <span class="kw">var</span> regress1 <span class="op">=</span> regress<span class="op">.</span><span class="fu">select</span>(regress<span class="op">.</span><span class="fu">bandNames</span>()<span class="op">.</span><span class="fu">sort</span>())<span class="op">;</span></span>
<span id="cb30-134"><a href="#cb30-134" tabindex="-1"></a>  <span class="kw">var</span> fit <span class="op">=</span> regress1<span class="op">.</span><span class="fu">reduceNeighborhood</span>(</span>
<span id="cb30-135"><a href="#cb30-135" tabindex="-1"></a>    ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">linearFit</span>()<span class="op">.</span><span class="fu">forEach</span>(image<span class="op">.</span><span class="fu">bandNames</span>())<span class="op">,</span></span>
<span id="cb30-136"><a href="#cb30-136" tabindex="-1"></a>    kernel<span class="op">,</span> <span class="kw">null</span><span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span></span>
<span id="cb30-137"><a href="#cb30-137" tabindex="-1"></a>  <span class="kw">var</span> offset <span class="op">=</span> fit<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;.*_offset&#39;</span>)<span class="op">;</span></span>
<span id="cb30-138"><a href="#cb30-138" tabindex="-1"></a>  <span class="kw">var</span> scale <span class="op">=</span> fit<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;.*_scale&#39;</span>)<span class="op">;</span></span>
<span id="cb30-139"><a href="#cb30-139" tabindex="-1"></a>  <span class="kw">var</span> scaled <span class="op">=</span> fill<span class="op">.</span><span class="fu">multiply</span>(scale)<span class="op">.</span><span class="fu">add</span>(offset)<span class="op">;</span></span>
<span id="cb30-140"><a href="#cb30-140" tabindex="-1"></a>  <span class="cf">return</span> image<span class="op">.</span><span class="fu">unmask</span>(scaled<span class="op">,</span> <span class="kw">true</span>)<span class="op">;</span></span>
<span id="cb30-141"><a href="#cb30-141" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb30-142"><a href="#cb30-142" tabindex="-1"></a></span>
<span id="cb30-143"><a href="#cb30-143" tabindex="-1"></a><span class="co">// Uncomment below to do L7 Gapfilling</span></span>
<span id="cb30-144"><a href="#cb30-144" tabindex="-1"></a><span class="co">// Note: Computation of gap-filling can take a long time</span></span>
<span id="cb30-145"><a href="#cb30-145" tabindex="-1"></a><span class="co">// and your Export of animation may run for many hours</span></span>
<span id="cb30-146"><a href="#cb30-146" tabindex="-1"></a></span>
<span id="cb30-147"><a href="#cb30-147" tabindex="-1"></a><span class="co">//var L7 = L7.map(gapFill);</span></span>
<span id="cb30-148"><a href="#cb30-148" tabindex="-1"></a></span>
<span id="cb30-149"><a href="#cb30-149" tabindex="-1"></a><span class="co">// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span></span>
<span id="cb30-150"><a href="#cb30-150" tabindex="-1"></a><span class="co">// Create Annual Composites</span></span>
<span id="cb30-151"><a href="#cb30-151" tabindex="-1"></a><span class="co">// ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span></span>
<span id="cb30-152"><a href="#cb30-152" tabindex="-1"></a><span class="kw">var</span> merged <span class="op">=</span> L5<span class="op">.</span><span class="fu">merge</span>(L7)<span class="op">.</span><span class="fu">merge</span>(L8)<span class="op">;</span></span>
<span id="cb30-153"><a href="#cb30-153" tabindex="-1"></a></span>
<span id="cb30-154"><a href="#cb30-154" tabindex="-1"></a><span class="co">// Select any dates from 1985 to 2023</span></span>
<span id="cb30-155"><a href="#cb30-155" tabindex="-1"></a><span class="kw">var</span> years <span class="op">=</span> ee<span class="op">.</span><span class="at">List</span><span class="op">.</span><span class="fu">sequence</span>(<span class="dv">1995</span><span class="op">,</span> <span class="dv">2010</span>)<span class="op">;</span></span>
<span id="cb30-156"><a href="#cb30-156" tabindex="-1"></a></span>
<span id="cb30-157"><a href="#cb30-157" tabindex="-1"></a><span class="kw">var</span> compositeImages <span class="op">=</span> years<span class="op">.</span><span class="fu">map</span>(<span class="kw">function</span>(year) {</span>
<span id="cb30-158"><a href="#cb30-158" tabindex="-1"></a>  <span class="kw">var</span> startDate <span class="op">=</span> ee<span class="op">.</span><span class="at">Date</span><span class="op">.</span><span class="fu">fromYMD</span>(year<span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb30-159"><a href="#cb30-159" tabindex="-1"></a>  <span class="kw">var</span> endDate <span class="op">=</span> startDate<span class="op">.</span><span class="fu">advance</span>(<span class="dv">1</span><span class="op">,</span> <span class="st">&#39;year&#39;</span>)<span class="op">;</span></span>
<span id="cb30-160"><a href="#cb30-160" tabindex="-1"></a>  <span class="kw">var</span> yearFiltered <span class="op">=</span> merged<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(startDate<span class="op">,</span> endDate))<span class="op">;</span></span>
<span id="cb30-161"><a href="#cb30-161" tabindex="-1"></a>  <span class="kw">var</span> composite <span class="op">=</span> yearFiltered<span class="op">.</span><span class="fu">median</span>()<span class="op">;</span></span>
<span id="cb30-162"><a href="#cb30-162" tabindex="-1"></a>  <span class="cf">return</span> composite<span class="op">.</span><span class="fu">set</span>({</span>
<span id="cb30-163"><a href="#cb30-163" tabindex="-1"></a>    <span class="st">&#39;year&#39;</span><span class="op">:</span> year<span class="op">,</span></span>
<span id="cb30-164"><a href="#cb30-164" tabindex="-1"></a>    <span class="st">&#39;system:time_start&#39;</span><span class="op">:</span> startDate<span class="op">.</span><span class="fu">millis</span>()<span class="op">,</span></span>
<span id="cb30-165"><a href="#cb30-165" tabindex="-1"></a>    <span class="st">&#39;system:time_end&#39;</span><span class="op">:</span> endDate<span class="op">.</span><span class="fu">millis</span>()<span class="op">,</span></span>
<span id="cb30-166"><a href="#cb30-166" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb30-167"><a href="#cb30-167" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb30-168"><a href="#cb30-168" tabindex="-1"></a></span>
<span id="cb30-169"><a href="#cb30-169" tabindex="-1"></a><span class="kw">var</span> compositeCol <span class="op">=</span> ee<span class="op">.</span><span class="at">ImageCollection</span><span class="op">.</span><span class="fu">fromImages</span>(compositeImages)<span class="op">;</span></span>
<span id="cb30-170"><a href="#cb30-170" tabindex="-1"></a><span class="fu">print</span>(<span class="st">&#39;Annual Landsat Composites&#39;</span><span class="op">,</span> compositeCol)<span class="op">;</span></span>
<span id="cb30-171"><a href="#cb30-171" tabindex="-1"></a></span>
<span id="cb30-172"><a href="#cb30-172" tabindex="-1"></a><span class="co">// Select the band combination</span></span>
<span id="cb30-173"><a href="#cb30-173" tabindex="-1"></a><span class="co">//var bands = [&#39;red&#39;, &#39;green&#39;, &#39;blue&#39;];</span></span>
<span id="cb30-174"><a href="#cb30-174" tabindex="-1"></a><span class="kw">var</span> bands <span class="op">=</span> [<span class="st">&#39;swir1&#39;</span><span class="op">,</span> <span class="st">&#39;nir&#39;</span><span class="op">,</span> <span class="st">&#39;red&#39;</span>]<span class="op">;</span></span>
<span id="cb30-175"><a href="#cb30-175" tabindex="-1"></a></span>
<span id="cb30-176"><a href="#cb30-176" tabindex="-1"></a><span class="co">// Visualize the image</span></span>
<span id="cb30-177"><a href="#cb30-177" tabindex="-1"></a><span class="kw">var</span> visParams <span class="op">=</span> {</span>
<span id="cb30-178"><a href="#cb30-178" tabindex="-1"></a>  <span class="dt">min</span><span class="op">:</span><span class="dv">0</span><span class="op">,</span></span>
<span id="cb30-179"><a href="#cb30-179" tabindex="-1"></a>  <span class="dt">max</span><span class="op">:</span><span class="fl">0.3</span><span class="op">,</span></span>
<span id="cb30-180"><a href="#cb30-180" tabindex="-1"></a>  <span class="dt">bands</span><span class="op">:</span> bands</span>
<span id="cb30-181"><a href="#cb30-181" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb30-182"><a href="#cb30-182" tabindex="-1"></a></span>
<span id="cb30-183"><a href="#cb30-183" tabindex="-1"></a><span class="kw">var</span> compositeColVis <span class="op">=</span> compositeCol<span class="op">.</span><span class="fu">map</span>(<span class="kw">function</span>(image) {</span>
<span id="cb30-184"><a href="#cb30-184" tabindex="-1"></a>  <span class="cf">return</span> image</span>
<span id="cb30-185"><a href="#cb30-185" tabindex="-1"></a>    <span class="op">.</span><span class="fu">visualize</span>(visParams)</span>
<span id="cb30-186"><a href="#cb30-186" tabindex="-1"></a>    <span class="op">.</span><span class="fu">clip</span>(geometry)</span>
<span id="cb30-187"><a href="#cb30-187" tabindex="-1"></a>    <span class="op">.</span><span class="fu">set</span>(<span class="st">&#39;label&#39;</span><span class="op">,</span> image<span class="op">.</span><span class="fu">getNumber</span>(<span class="st">&#39;year&#39;</span>)<span class="op">.</span><span class="fu">format</span>(<span class="st">&#39;%04d&#39;</span>))<span class="op">;</span></span>
<span id="cb30-188"><a href="#cb30-188" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb30-189"><a href="#cb30-189" tabindex="-1"></a></span>
<span id="cb30-190"><a href="#cb30-190" tabindex="-1"></a><span class="co">// Earth Engine doesn&#39;t have a way to add text labels</span></span>
<span id="cb30-191"><a href="#cb30-191" tabindex="-1"></a><span class="co">// Use the 3rd-party text package to add annotations</span></span>
<span id="cb30-192"><a href="#cb30-192" tabindex="-1"></a><span class="kw">var</span> text <span class="op">=</span> <span class="pp">require</span>(<span class="st">&#39;users/gena/packages:text&#39;</span>)<span class="op">;</span></span>
<span id="cb30-193"><a href="#cb30-193" tabindex="-1"></a><span class="kw">var</span> scale <span class="op">=</span> <span class="bu">Map</span><span class="op">.</span><span class="fu">getScale</span>()<span class="op">;</span> <span class="co">// This is scale for text, adjust as required</span></span>
<span id="cb30-194"><a href="#cb30-194" tabindex="-1"></a><span class="kw">var</span> fontSize <span class="op">=</span> <span class="dv">18</span><span class="op">;</span></span>
<span id="cb30-195"><a href="#cb30-195" tabindex="-1"></a><span class="kw">var</span> bounds <span class="op">=</span> geometry<span class="op">.</span><span class="fu">bounds</span>()<span class="op">;</span></span>
<span id="cb30-196"><a href="#cb30-196" tabindex="-1"></a><span class="kw">var</span> image <span class="op">=</span> compositeColVis<span class="op">.</span><span class="fu">first</span>()<span class="op">;</span></span>
<span id="cb30-197"><a href="#cb30-197" tabindex="-1"></a>  </span>
<span id="cb30-198"><a href="#cb30-198" tabindex="-1"></a><span class="kw">var</span> annotations <span class="op">=</span> [</span>
<span id="cb30-199"><a href="#cb30-199" tabindex="-1"></a>  {</span>
<span id="cb30-200"><a href="#cb30-200" tabindex="-1"></a>    <span class="co">// Use &#39;margin&#39; for x-position and &#39;offset&#39; for y-position</span></span>
<span id="cb30-201"><a href="#cb30-201" tabindex="-1"></a>    <span class="dt">position</span><span class="op">:</span> <span class="st">&#39;right&#39;</span><span class="op">,</span> <span class="dt">offset</span><span class="op">:</span> <span class="st">&#39;5%&#39;</span><span class="op">,</span> <span class="dt">margin</span><span class="op">:</span> <span class="st">&#39;25%&#39;</span><span class="op">,</span></span>
<span id="cb30-202"><a href="#cb30-202" tabindex="-1"></a>    <span class="dt">property</span><span class="op">:</span> <span class="st">&#39;label&#39;</span><span class="op">,</span></span>
<span id="cb30-203"><a href="#cb30-203" tabindex="-1"></a>    <span class="dt">scale</span><span class="op">:</span> scale<span class="op">,</span></span>
<span id="cb30-204"><a href="#cb30-204" tabindex="-1"></a>    <span class="dt">fontType</span><span class="op">:</span> <span class="st">&#39;Consolas&#39;</span><span class="op">,</span> <span class="dt">fontSize</span><span class="op">:</span> <span class="dv">18</span></span>
<span id="cb30-205"><a href="#cb30-205" tabindex="-1"></a>  }</span>
<span id="cb30-206"><a href="#cb30-206" tabindex="-1"></a>]<span class="op">;</span></span>
<span id="cb30-207"><a href="#cb30-207" tabindex="-1"></a>  </span>
<span id="cb30-208"><a href="#cb30-208" tabindex="-1"></a><span class="kw">var</span> vis <span class="op">=</span> {<span class="dt">forceRgbOutput</span><span class="op">:</span> <span class="kw">true</span>}<span class="op">;</span></span>
<span id="cb30-209"><a href="#cb30-209" tabindex="-1"></a></span>
<span id="cb30-210"><a href="#cb30-210" tabindex="-1"></a><span class="co">// Test the parameters</span></span>
<span id="cb30-211"><a href="#cb30-211" tabindex="-1"></a><span class="kw">var</span> results <span class="op">=</span> text<span class="op">.</span><span class="fu">annotateImage</span>(image<span class="op">,</span> vis<span class="op">,</span> bounds<span class="op">,</span> annotations)<span class="op">;</span></span>
<span id="cb30-212"><a href="#cb30-212" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">centerObject</span>(geometry)</span>
<span id="cb30-213"><a href="#cb30-213" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(results<span class="op">,</span> {}<span class="op">,</span> <span class="st">&#39;Test Image with Annotation&#39;</span>)<span class="op">;</span></span>
<span id="cb30-214"><a href="#cb30-214" tabindex="-1"></a></span>
<span id="cb30-215"><a href="#cb30-215" tabindex="-1"></a><span class="co">// Apple labeling on all images</span></span>
<span id="cb30-216"><a href="#cb30-216" tabindex="-1"></a><span class="kw">var</span> labeledImages <span class="op">=</span> compositeColVis<span class="op">.</span><span class="fu">map</span>(<span class="kw">function</span>(image) {</span>
<span id="cb30-217"><a href="#cb30-217" tabindex="-1"></a>  <span class="cf">return</span> text<span class="op">.</span><span class="fu">annotateImage</span>(image<span class="op">,</span> vis<span class="op">,</span> bounds<span class="op">,</span> annotations)<span class="op">;</span></span>
<span id="cb30-218"><a href="#cb30-218" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb30-219"><a href="#cb30-219" tabindex="-1"></a></span>
<span id="cb30-220"><a href="#cb30-220" tabindex="-1"></a><span class="co">// Export the collection as video</span></span>
<span id="cb30-221"><a href="#cb30-221" tabindex="-1"></a></span>
<span id="cb30-222"><a href="#cb30-222" tabindex="-1"></a>Export<span class="op">.</span><span class="at">video</span><span class="op">.</span><span class="fu">toDrive</span>({</span>
<span id="cb30-223"><a href="#cb30-223" tabindex="-1"></a>  <span class="dt">collection</span><span class="op">:</span> labeledImages<span class="op">,</span></span>
<span id="cb30-224"><a href="#cb30-224" tabindex="-1"></a>  <span class="dt">description</span><span class="op">:</span> <span class="st">&#39;Animation_with_Label&#39;</span><span class="op">,</span></span>
<span id="cb30-225"><a href="#cb30-225" tabindex="-1"></a>  <span class="dt">folder</span><span class="op">:</span> <span class="st">&#39;earthengine&#39;</span><span class="op">,</span></span>
<span id="cb30-226"><a href="#cb30-226" tabindex="-1"></a>  <span class="dt">fileNamePrefix</span><span class="op">:</span> <span class="st">&#39;animation&#39;</span><span class="op">,</span></span>
<span id="cb30-227"><a href="#cb30-227" tabindex="-1"></a>  <span class="dt">framesPerSecond</span><span class="op">:</span> <span class="dv">1</span><span class="op">,</span></span>
<span id="cb30-228"><a href="#cb30-228" tabindex="-1"></a>  <span class="dt">dimensions</span><span class="op">:</span> <span class="dv">800</span><span class="op">,</span></span>
<span id="cb30-229"><a href="#cb30-229" tabindex="-1"></a>  <span class="dt">region</span><span class="op">:</span> geometry<span class="op">,</span></span>
<span id="cb30-230"><a href="#cb30-230" tabindex="-1"></a>})<span class="op">;</span></span></code></pre></div>
</div>
<div id="percentile-composites" class="section level2">
<h2>Percentile Composites</h2>
<p>When working in a very cloudy region you may still be left with
majority of the images contaminated with cloudy pixels. You may apply a
cloud-mask to remove them but many cloud masking algorithms may miss
thin clouds or fog. A median composite takes the 50th percentile value
from the image stack to create the final image. When you expect most
images to have clouds, the 50th percentile (median) value could still be
cloudy. In such cases, you can use the
<code>ee.Reducer.percentile()</code> to create composite that uses the
value at a lower percentile to ensure a cloud-free observation.</p>
<p><a
href="https://code.earthengine.google.co.in/?scriptPath=users%2Fujavalgandhi%2FEnd-to-End-GEE%3ASupplement%2FImage_Collections%2FPercentile_Composites"
target="_blank">Open in Code Editor ↗</a></p>
<div class="sourceCode" id="cb31"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb31-1"><a href="#cb31-1" tabindex="-1"></a><span class="kw">var</span> geometry <span class="op">=</span> ee<span class="op">.</span><span class="at">Geometry</span><span class="op">.</span><span class="fu">Polygon</span>([[</span>
<span id="cb31-2"><a href="#cb31-2" tabindex="-1"></a>  [<span class="op">-</span><span class="fl">1.8611</span><span class="op">,</span> <span class="fl">4.9272</span>]<span class="op">,</span></span>
<span id="cb31-3"><a href="#cb31-3" tabindex="-1"></a>  [<span class="op">-</span><span class="fl">1.8611</span><span class="op">,</span> <span class="fl">4.8448</span>]<span class="op">,</span></span>
<span id="cb31-4"><a href="#cb31-4" tabindex="-1"></a>  [<span class="op">-</span><span class="fl">1.7141</span><span class="op">,</span> <span class="fl">4.8448</span>]<span class="op">,</span></span>
<span id="cb31-5"><a href="#cb31-5" tabindex="-1"></a>  [<span class="op">-</span><span class="fl">1.7141</span><span class="op">,</span> <span class="fl">4.9272</span>]</span>
<span id="cb31-6"><a href="#cb31-6" tabindex="-1"></a>]])<span class="op">;</span></span>
<span id="cb31-7"><a href="#cb31-7" tabindex="-1"></a></span>
<span id="cb31-8"><a href="#cb31-8" tabindex="-1"></a><span class="kw">var</span> s2 <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&#39;COPERNICUS/S2_HARMONIZED&#39;</span>)<span class="op">;</span></span>
<span id="cb31-9"><a href="#cb31-9" tabindex="-1"></a></span>
<span id="cb31-10"><a href="#cb31-10" tabindex="-1"></a><span class="kw">var</span> rgbVis <span class="op">=</span> {</span>
<span id="cb31-11"><a href="#cb31-11" tabindex="-1"></a>  <span class="dt">min</span><span class="op">:</span> <span class="fl">0.0</span><span class="op">,</span></span>
<span id="cb31-12"><a href="#cb31-12" tabindex="-1"></a>  <span class="dt">max</span><span class="op">:</span> <span class="dv">3000</span><span class="op">,</span></span>
<span id="cb31-13"><a href="#cb31-13" tabindex="-1"></a>  <span class="dt">bands</span><span class="op">:</span> [<span class="st">&#39;B4&#39;</span><span class="op">,</span> <span class="st">&#39;B3&#39;</span><span class="op">,</span> <span class="st">&#39;B2&#39;</span>]<span class="op">,</span></span>
<span id="cb31-14"><a href="#cb31-14" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb31-15"><a href="#cb31-15" tabindex="-1"></a></span>
<span id="cb31-16"><a href="#cb31-16" tabindex="-1"></a></span>
<span id="cb31-17"><a href="#cb31-17" tabindex="-1"></a><span class="kw">var</span> filtered <span class="op">=</span> s2</span>
<span id="cb31-18"><a href="#cb31-18" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">lt</span>(<span class="st">&#39;CLOUDY_PIXEL_PERCENTAGE&#39;</span><span class="op">,</span> <span class="dv">30</span>))</span>
<span id="cb31-19"><a href="#cb31-19" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(<span class="st">&#39;2022-01-01&#39;</span><span class="op">,</span> <span class="st">&#39;2022-04-01&#39;</span>))</span>
<span id="cb31-20"><a href="#cb31-20" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">bounds</span>(geometry))</span>
<span id="cb31-21"><a href="#cb31-21" tabindex="-1"></a>  <span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;B.*&#39;</span>)<span class="op">;</span></span>
<span id="cb31-22"><a href="#cb31-22" tabindex="-1"></a></span>
<span id="cb31-23"><a href="#cb31-23" tabindex="-1"></a><span class="co">// Median Composite</span></span>
<span id="cb31-24"><a href="#cb31-24" tabindex="-1"></a></span>
<span id="cb31-25"><a href="#cb31-25" tabindex="-1"></a><span class="kw">var</span> medianComposite <span class="op">=</span> filtered<span class="op">.</span><span class="fu">median</span>()<span class="op">;</span></span>
<span id="cb31-26"><a href="#cb31-26" tabindex="-1"></a></span>
<span id="cb31-27"><a href="#cb31-27" tabindex="-1"></a><span class="co">// Create a 25th-percentile Composite</span></span>
<span id="cb31-28"><a href="#cb31-28" tabindex="-1"></a><span class="kw">var</span> percentileComposite <span class="op">=</span> filtered<span class="op">.</span><span class="fu">reduce</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">percentile</span>([<span class="dv">25</span>]))<span class="op">;</span></span>
<span id="cb31-29"><a href="#cb31-29" tabindex="-1"></a><span class="co">// ee.Reducer.percentile([25]) adds &#39;_p25&#39; to band names, remove them</span></span>
<span id="cb31-30"><a href="#cb31-30" tabindex="-1"></a><span class="kw">var</span> percentileComposite <span class="op">=</span> percentileComposite<span class="op">.</span><span class="fu">regexpRename</span>(<span class="st">&#39;_p25&#39;</span><span class="op">,</span> <span class="st">&#39;&#39;</span>)<span class="op">;</span></span>
<span id="cb31-31"><a href="#cb31-31" tabindex="-1"></a></span>
<span id="cb31-32"><a href="#cb31-32" tabindex="-1"></a><span class="co">// Display the composites</span></span>
<span id="cb31-33"><a href="#cb31-33" tabindex="-1"></a></span>
<span id="cb31-34"><a href="#cb31-34" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">centerObject</span>(geometry)<span class="op">;</span></span>
<span id="cb31-35"><a href="#cb31-35" tabindex="-1"></a></span>
<span id="cb31-36"><a href="#cb31-36" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(medianComposite<span class="op">.</span><span class="fu">clip</span>(geometry) <span class="op">,</span> rgbVis<span class="op">,</span> <span class="st">&#39;Median Composite&#39;</span>)<span class="op">;</span></span>
<span id="cb31-37"><a href="#cb31-37" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(percentileComposite<span class="op">.</span><span class="fu">clip</span>(geometry) <span class="op">,</span> rgbVis<span class="op">,</span> <span class="st">&#39;25-Percentile Composite&#39;</span>)<span class="op">;</span> </span>
<span id="cb31-38"><a href="#cb31-38" tabindex="-1"></a> </span></code></pre></div>
</div>
<div id="medoid-composites" class="section level2">
<h2>Medoid Composites</h2>
<p>Medoid or Multi Dimensional Median is often used to get a more
representative sample from multi-dimensional data. For multispectral
satellite images - a medoid composite can result in a better output than
a simple median composite. The method and its advantages are described
in the paper <a href="https://www.mdpi.com/2072-4292/5/12/6481">Seasonal
Composite Landsat TM/ETM+ Images Using the Medoid</a>. You can also use
a Geometric Median which is similar to a medoid but it does not impose
the constraint that the values must be from the same observation.</p>
<p><img src="images/end_to_end_gee/medoid.png" width="100%" style="display: block; margin: auto;" /></p>
<p>Some key differences between a simple median composite vs. a medoid
composite:</p>
<ol style="list-style-type: decimal">
<li>Median values are calculated independently for each band while
Medoid value is computed by comparing pixel values across all bands and
selecting the values that minimize the difference between the median and
the chosen value.</li>
<li>In a median composite image, each band value may come from different
images. Medoid values are guaranteed to come from the same image.</li>
<li>Median composites may have values that are not present in the
original images. i.e. Median of [1, 2, 3, 4] –&gt; 2.5. Medoid will
always pick values present in the input data.</li>
</ol>
<p>For most users, the difference is minimal and a simple median
composite will be adequate. However, median composites can sometimes
produce outliers when computing spectral indices (like NDVI) whereas
medoid composites are more robust against such outliers.</p>
<p><a
href="https://code.earthengine.google.co.in/?scriptPath=users%2Fujavalgandhi%2FEnd-to-End-GEE%3ASupplement%2FImage_Collections%2FMedoid_Composites"
target="_blank">Open in Code Editor ↗</a></p>
<div class="sourceCode" id="cb32"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb32-1"><a href="#cb32-1" tabindex="-1"></a><span class="co">// Script comparing Median vs. Medoid vs. Geometric Median compositing</span></span>
<span id="cb32-2"><a href="#cb32-2" tabindex="-1"></a><span class="co">// Learn more at https://www.mdpi.com/2072-4292/5/12/6481</span></span>
<span id="cb32-3"><a href="#cb32-3" tabindex="-1"></a><span class="kw">var</span> geometry <span class="op">=</span> ee<span class="op">.</span><span class="at">Geometry</span><span class="op">.</span><span class="fu">Point</span>([<span class="fl">77.60412933051538</span><span class="op">,</span> <span class="fl">12.952912912328241</span>])<span class="op">;</span></span>
<span id="cb32-4"><a href="#cb32-4" tabindex="-1"></a><span class="kw">var</span> s2 <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&#39;COPERNICUS/S2_HARMONIZED&#39;</span>)<span class="op">;</span></span>
<span id="cb32-5"><a href="#cb32-5" tabindex="-1"></a></span>
<span id="cb32-6"><a href="#cb32-6" tabindex="-1"></a></span>
<span id="cb32-7"><a href="#cb32-7" tabindex="-1"></a><span class="co">// Apply the filters and find candidate images</span></span>
<span id="cb32-8"><a href="#cb32-8" tabindex="-1"></a></span>
<span id="cb32-9"><a href="#cb32-9" tabindex="-1"></a><span class="co">// Medoid will find the image with all band values closest to</span></span>
<span id="cb32-10"><a href="#cb32-10" tabindex="-1"></a><span class="co">// the median, so make sure to select the bands of interest</span></span>
<span id="cb32-11"><a href="#cb32-11" tabindex="-1"></a><span class="co">// Here we select all spectral bands (B1 - B13)</span></span>
<span id="cb32-12"><a href="#cb32-12" tabindex="-1"></a><span class="kw">var</span> filtered <span class="op">=</span> s2<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">lt</span>(<span class="st">&#39;CLOUDY_PIXEL_PERCENTAGE&#39;</span><span class="op">,</span> <span class="dv">30</span>))</span>
<span id="cb32-13"><a href="#cb32-13" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(<span class="st">&#39;2019-01-01&#39;</span><span class="op">,</span> <span class="st">&#39;2020-01-01&#39;</span>))</span>
<span id="cb32-14"><a href="#cb32-14" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">bounds</span>(geometry))</span>
<span id="cb32-15"><a href="#cb32-15" tabindex="-1"></a>  <span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;B.*&#39;</span>)<span class="op">;</span></span>
<span id="cb32-16"><a href="#cb32-16" tabindex="-1"></a>  </span>
<span id="cb32-17"><a href="#cb32-17" tabindex="-1"></a><span class="co">// Median Composite</span></span>
<span id="cb32-18"><a href="#cb32-18" tabindex="-1"></a></span>
<span id="cb32-19"><a href="#cb32-19" tabindex="-1"></a><span class="co">// Create a median composite</span></span>
<span id="cb32-20"><a href="#cb32-20" tabindex="-1"></a><span class="kw">var</span> median <span class="op">=</span> filtered<span class="op">.</span><span class="fu">median</span>()<span class="op">;</span></span>
<span id="cb32-21"><a href="#cb32-21" tabindex="-1"></a></span>
<span id="cb32-22"><a href="#cb32-22" tabindex="-1"></a><span class="co">// Geometric Median Composite</span></span>
<span id="cb32-23"><a href="#cb32-23" tabindex="-1"></a></span>
<span id="cb32-24"><a href="#cb32-24" tabindex="-1"></a><span class="co">// use the ee.Reducer.geometricMedian() to select the value</span></span>
<span id="cb32-25"><a href="#cb32-25" tabindex="-1"></a><span class="co">// that minimizes the euclidean distance </span></span>
<span id="cb32-26"><a href="#cb32-26" tabindex="-1"></a><span class="kw">var</span> bandNames <span class="op">=</span> filtered<span class="op">.</span><span class="fu">first</span>()<span class="op">.</span><span class="fu">bandNames</span>()<span class="op">;</span></span>
<span id="cb32-27"><a href="#cb32-27" tabindex="-1"></a><span class="kw">var</span> bandPositions <span class="op">=</span> ee<span class="op">.</span><span class="at">List</span><span class="op">.</span><span class="fu">sequence</span>(<span class="dv">0</span><span class="op">,</span> bandNames<span class="op">.</span><span class="fu">length</span>()<span class="op">.</span><span class="fu">subtract</span>(<span class="dv">1</span>))<span class="op">;</span></span>
<span id="cb32-28"><a href="#cb32-28" tabindex="-1"></a><span class="kw">var</span> geomedian <span class="op">=</span> filtered</span>
<span id="cb32-29"><a href="#cb32-29" tabindex="-1"></a>  <span class="op">.</span><span class="fu">reduce</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">geometricMedian</span>(bandNames<span class="op">.</span><span class="fu">length</span>()))</span>
<span id="cb32-30"><a href="#cb32-30" tabindex="-1"></a>  <span class="op">.</span><span class="fu">select</span>(bandPositions<span class="op">,</span> bandNames)<span class="op">;</span></span>
<span id="cb32-31"><a href="#cb32-31" tabindex="-1"></a>  </span>
<span id="cb32-32"><a href="#cb32-32" tabindex="-1"></a><span class="co">// Medoid Composite</span></span>
<span id="cb32-33"><a href="#cb32-33" tabindex="-1"></a></span>
<span id="cb32-34"><a href="#cb32-34" tabindex="-1"></a><span class="co">// Medoid composites import a constraint that all the band</span></span>
<span id="cb32-35"><a href="#cb32-35" tabindex="-1"></a><span class="co">// values must be from the same image. </span></span>
<span id="cb32-36"><a href="#cb32-36" tabindex="-1"></a></span>
<span id="cb32-37"><a href="#cb32-37" tabindex="-1"></a><span class="co">// We calculate the distance between each image and the median</span></span>
<span id="cb32-38"><a href="#cb32-38" tabindex="-1"></a><span class="co">// and choose the one that minimizes the distance.</span></span>
<span id="cb32-39"><a href="#cb32-39" tabindex="-1"></a></span>
<span id="cb32-40"><a href="#cb32-40" tabindex="-1"></a><span class="co">// The definitions of medoid vary. Some use distance to median</span></span>
<span id="cb32-41"><a href="#cb32-41" tabindex="-1"></a><span class="co">// and others use distance to geometric median. You can choose</span></span>
<span id="cb32-42"><a href="#cb32-42" tabindex="-1"></a><span class="co">// the median measure you want to use.</span></span>
<span id="cb32-43"><a href="#cb32-43" tabindex="-1"></a><span class="kw">var</span> medianMeasure <span class="op">=</span> median<span class="op">;</span> <span class="co">// use &#39;geomedian&#39; for geometric median</span></span>
<span id="cb32-44"><a href="#cb32-44" tabindex="-1"></a></span>
<span id="cb32-45"><a href="#cb32-45" tabindex="-1"></a><span class="co">// Calculate the difference between each image and the median.</span></span>
<span id="cb32-46"><a href="#cb32-46" tabindex="-1"></a><span class="kw">var</span> diffFromMedian <span class="op">=</span> filtered<span class="op">.</span><span class="fu">map</span>(<span class="kw">function</span>(image) {</span>
<span id="cb32-47"><a href="#cb32-47" tabindex="-1"></a>  <span class="kw">var</span> diff <span class="op">=</span> image<span class="op">.</span><span class="fu">subtract</span>(medianMeasure)<span class="op">.</span><span class="fu">pow</span>(<span class="dv">2</span>)</span>
<span id="cb32-48"><a href="#cb32-48" tabindex="-1"></a>    <span class="op">.</span><span class="fu">reduce</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">sum</span>())<span class="op">.</span><span class="fu">rename</span>(<span class="st">&#39;difference&#39;</span>)<span class="op">;</span></span>
<span id="cb32-49"><a href="#cb32-49" tabindex="-1"></a>  <span class="cf">return</span> diff<span class="op">.</span><span class="fu">addBands</span>(image)<span class="op">.</span><span class="fu">copyProperties</span>(image<span class="op">,</span> [<span class="st">&#39;system:time_start&#39;</span>])<span class="op">;</span></span>
<span id="cb32-50"><a href="#cb32-50" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb32-51"><a href="#cb32-51" tabindex="-1"></a></span>
<span id="cb32-52"><a href="#cb32-52" tabindex="-1"></a><span class="co">// Generate a composite image by selecting the pixel</span></span>
<span id="cb32-53"><a href="#cb32-53" tabindex="-1"></a><span class="co">// closest to the median.</span></span>
<span id="cb32-54"><a href="#cb32-54" tabindex="-1"></a><span class="kw">var</span> bandNames <span class="op">=</span> diffFromMedian<span class="op">.</span><span class="fu">first</span>()<span class="op">.</span><span class="fu">bandNames</span>()<span class="op">;</span></span>
<span id="cb32-55"><a href="#cb32-55" tabindex="-1"></a><span class="kw">var</span> bandPositions <span class="op">=</span> ee<span class="op">.</span><span class="at">List</span><span class="op">.</span><span class="fu">sequence</span>(<span class="dv">1</span><span class="op">,</span> bandNames<span class="op">.</span><span class="fu">length</span>()<span class="op">.</span><span class="fu">subtract</span>(<span class="dv">1</span>))<span class="op">;</span></span>
<span id="cb32-56"><a href="#cb32-56" tabindex="-1"></a><span class="kw">var</span> medoid <span class="op">=</span> diffFromMedian<span class="op">.</span><span class="fu">reduce</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">min</span>(bandNames<span class="op">.</span><span class="fu">length</span>()))</span>
<span id="cb32-57"><a href="#cb32-57" tabindex="-1"></a>  <span class="op">.</span><span class="fu">select</span>(bandPositions<span class="op">,</span> bandNames<span class="op">.</span><span class="fu">slice</span>(<span class="dv">1</span>))<span class="op">;</span></span>
<span id="cb32-58"><a href="#cb32-58" tabindex="-1"></a></span>
<span id="cb32-59"><a href="#cb32-59" tabindex="-1"></a></span>
<span id="cb32-60"><a href="#cb32-60" tabindex="-1"></a><span class="kw">var</span> rgbVis <span class="op">=</span> {</span>
<span id="cb32-61"><a href="#cb32-61" tabindex="-1"></a>  <span class="dt">min</span><span class="op">:</span> <span class="fl">0.0</span><span class="op">,</span></span>
<span id="cb32-62"><a href="#cb32-62" tabindex="-1"></a>  <span class="dt">max</span><span class="op">:</span> <span class="dv">3000</span><span class="op">,</span></span>
<span id="cb32-63"><a href="#cb32-63" tabindex="-1"></a>  <span class="dt">bands</span><span class="op">:</span> [<span class="st">&#39;B4&#39;</span><span class="op">,</span> <span class="st">&#39;B3&#39;</span><span class="op">,</span> <span class="st">&#39;B2&#39;</span>]<span class="op">,</span> </span>
<span id="cb32-64"><a href="#cb32-64" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb32-65"><a href="#cb32-65" tabindex="-1"></a></span>
<span id="cb32-66"><a href="#cb32-66" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">centerObject</span>(geometry<span class="op">,</span> <span class="dv">10</span>)<span class="op">;</span></span>
<span id="cb32-67"><a href="#cb32-67" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(median<span class="op">,</span> rgbVis<span class="op">,</span> <span class="st">&#39;Median Composite&#39;</span>)<span class="op">;</span></span>
<span id="cb32-68"><a href="#cb32-68" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(geomedian<span class="op">,</span> rgbVis<span class="op">,</span> <span class="st">&#39;Geometric Median Composite&#39;</span>)<span class="op">;</span></span>
<span id="cb32-69"><a href="#cb32-69" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(medoid<span class="op">,</span> rgbVis<span class="op">,</span> <span class="st">&#39;Medoid Composite&#39;</span>)<span class="op">;</span></span>
<span id="cb32-70"><a href="#cb32-70" tabindex="-1"></a>  </span></code></pre></div>
</div>
<div id="visualize-number-of-images-in-composites"
class="section level2">
<h2>Visualize Number of Images in Composites</h2>
<p><a
href="https://code.earthengine.google.co.in/?scriptPath=users%2Fujavalgandhi%2FEnd-to-End-GEE%3ASupplement%2FImage_Collections%2FVisualize_Number_of_Images_in_Composites"
target="_blank">Open in Code Editor ↗</a></p>
<div class="sourceCode" id="cb33"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb33-1"><a href="#cb33-1" tabindex="-1"></a><span class="co">// Exploring Composite Images</span></span>
<span id="cb33-2"><a href="#cb33-2" tabindex="-1"></a><span class="co">// Example script showing </span></span>
<span id="cb33-3"><a href="#cb33-3" tabindex="-1"></a><span class="co">// 1. How to visualize the DOY (day-of-year) of each pixel of a composite</span></span>
<span id="cb33-4"><a href="#cb33-4" tabindex="-1"></a><span class="co">// 2. How to visualize count of images at each pixel of a composite</span></span>
<span id="cb33-5"><a href="#cb33-5" tabindex="-1"></a><span class="kw">var</span> admin1 <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">&#39;FAO/GAUL_SIMPLIFIED_500m/2015/level1&#39;</span>)<span class="op">;</span></span>
<span id="cb33-6"><a href="#cb33-6" tabindex="-1"></a><span class="kw">var</span> karnataka <span class="op">=</span> admin1<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;ADM1_NAME&#39;</span><span class="op">,</span> <span class="st">&#39;Karnataka&#39;</span>))<span class="op">;</span></span>
<span id="cb33-7"><a href="#cb33-7" tabindex="-1"></a><span class="kw">var</span> geometry <span class="op">=</span> karnataka<span class="op">.</span><span class="fu">geometry</span>()<span class="op">;</span></span>
<span id="cb33-8"><a href="#cb33-8" tabindex="-1"></a></span>
<span id="cb33-9"><a href="#cb33-9" tabindex="-1"></a><span class="kw">var</span> s2 <span class="op">=</span>ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&#39;COPERNICUS/S2_HARMONIZED&#39;</span>)<span class="op">;</span></span>
<span id="cb33-10"><a href="#cb33-10" tabindex="-1"></a></span>
<span id="cb33-11"><a href="#cb33-11" tabindex="-1"></a><span class="kw">var</span> rgbVis <span class="op">=</span> {</span>
<span id="cb33-12"><a href="#cb33-12" tabindex="-1"></a>  <span class="dt">min</span><span class="op">:</span> <span class="fl">0.0</span><span class="op">,</span></span>
<span id="cb33-13"><a href="#cb33-13" tabindex="-1"></a>  <span class="dt">max</span><span class="op">:</span> <span class="dv">3000</span><span class="op">,</span></span>
<span id="cb33-14"><a href="#cb33-14" tabindex="-1"></a>  <span class="dt">bands</span><span class="op">:</span> [<span class="st">&#39;B4&#39;</span><span class="op">,</span> <span class="st">&#39;B3&#39;</span><span class="op">,</span> <span class="st">&#39;B2&#39;</span>]<span class="op">,</span></span>
<span id="cb33-15"><a href="#cb33-15" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb33-16"><a href="#cb33-16" tabindex="-1"></a></span>
<span id="cb33-17"><a href="#cb33-17" tabindex="-1"></a></span>
<span id="cb33-18"><a href="#cb33-18" tabindex="-1"></a><span class="kw">var</span> filtered <span class="op">=</span> s2<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">lt</span>(<span class="st">&#39;CLOUDY_PIXEL_PERCENTAGE&#39;</span><span class="op">,</span> <span class="dv">30</span>))</span>
<span id="cb33-19"><a href="#cb33-19" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(<span class="st">&#39;2019-01-01&#39;</span><span class="op">,</span> <span class="st">&#39;2020-01-01&#39;</span>))</span>
<span id="cb33-20"><a href="#cb33-20" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">bounds</span>(geometry))<span class="op">;</span></span>
<span id="cb33-21"><a href="#cb33-21" tabindex="-1"></a></span>
<span id="cb33-22"><a href="#cb33-22" tabindex="-1"></a><span class="co">// Add a band to each image indicating the DOY of each image</span></span>
<span id="cb33-23"><a href="#cb33-23" tabindex="-1"></a><span class="kw">var</span> filteredWithDoyBand <span class="op">=</span> filtered<span class="op">.</span><span class="fu">map</span>(<span class="kw">function</span>(image) {</span>
<span id="cb33-24"><a href="#cb33-24" tabindex="-1"></a>  <span class="co">// Create an image with day of the year as value</span></span>
<span id="cb33-25"><a href="#cb33-25" tabindex="-1"></a>  <span class="kw">var</span> date <span class="op">=</span> ee<span class="op">.</span><span class="fu">Date</span>(image<span class="op">.</span><span class="fu">get</span>(<span class="st">&#39;system:time_start&#39;</span>))<span class="op">;</span></span>
<span id="cb33-26"><a href="#cb33-26" tabindex="-1"></a>  <span class="kw">var</span> day <span class="op">=</span> date<span class="op">.</span><span class="fu">getRelative</span>(<span class="st">&#39;day&#39;</span><span class="op">,</span> <span class="st">&#39;year&#39;</span>)<span class="op">;</span></span>
<span id="cb33-27"><a href="#cb33-27" tabindex="-1"></a>  <span class="kw">var</span> dayImage <span class="op">=</span> ee<span class="op">.</span><span class="at">Image</span><span class="op">.</span><span class="fu">constant</span>(day)<span class="op">.</span><span class="fu">rename</span>([<span class="st">&#39;dayofyear&#39;</span>])<span class="op">.</span><span class="fu">int</span>()<span class="op">.</span><span class="fu">clip</span>(image<span class="op">.</span><span class="fu">geometry</span>())<span class="op">;</span></span>
<span id="cb33-28"><a href="#cb33-28" tabindex="-1"></a>  <span class="cf">return</span> image<span class="op">.</span><span class="fu">addBands</span>([dayImage])<span class="op">;</span></span>
<span id="cb33-29"><a href="#cb33-29" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb33-30"><a href="#cb33-30" tabindex="-1"></a></span>
<span id="cb33-31"><a href="#cb33-31" tabindex="-1"></a><span class="kw">var</span> composite <span class="op">=</span> filteredWithDoyBand<span class="op">.</span><span class="fu">median</span>()<span class="op">;</span></span>
<span id="cb33-32"><a href="#cb33-32" tabindex="-1"></a></span>
<span id="cb33-33"><a href="#cb33-33" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">centerObject</span>(geometry<span class="op">,</span> <span class="dv">8</span>)<span class="op">;</span></span>
<span id="cb33-34"><a href="#cb33-34" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(composite<span class="op">.</span><span class="fu">clip</span>(geometry)<span class="op">,</span> rgbVis<span class="op">,</span> <span class="st">&#39;2019 Median Composite&#39;</span>)</span>
<span id="cb33-35"><a href="#cb33-35" tabindex="-1"></a></span>
<span id="cb33-36"><a href="#cb33-36" tabindex="-1"></a></span>
<span id="cb33-37"><a href="#cb33-37" tabindex="-1"></a><span class="co">// Visualize which pixels contribute to the composite</span></span>
<span id="cb33-38"><a href="#cb33-38" tabindex="-1"></a><span class="kw">var</span> dateImage <span class="op">=</span> composite<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;dayofyear&#39;</span>)<span class="op">.</span><span class="fu">int</span>()<span class="op">;</span></span>
<span id="cb33-39"><a href="#cb33-39" tabindex="-1"></a></span>
<span id="cb33-40"><a href="#cb33-40" tabindex="-1"></a><span class="kw">var</span> doyVis <span class="op">=</span> {</span>
<span id="cb33-41"><a href="#cb33-41" tabindex="-1"></a>  <span class="dt">min</span><span class="op">:</span><span class="dv">20</span><span class="op">,</span></span>
<span id="cb33-42"><a href="#cb33-42" tabindex="-1"></a>  <span class="dt">max</span><span class="op">:</span> <span class="dv">100</span><span class="op">,</span></span>
<span id="cb33-43"><a href="#cb33-43" tabindex="-1"></a>  <span class="dt">palette</span><span class="op">:</span> [<span class="st">&#39;d7191c&#39;</span><span class="op">,</span><span class="st">&#39;fdae61&#39;</span><span class="op">,</span><span class="st">&#39;ffffbf&#39;</span><span class="op">,</span><span class="st">&#39;a6d96a&#39;</span><span class="op">,</span><span class="st">&#39;1a9641&#39;</span>]</span>
<span id="cb33-44"><a href="#cb33-44" tabindex="-1"></a>}</span>
<span id="cb33-45"><a href="#cb33-45" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(dateImage<span class="op">.</span><span class="fu">clip</span>(geometry)<span class="op">,</span> doyVis<span class="op">,</span> <span class="st">&#39;DOY of Each Pixel in Composite&#39;</span>)<span class="op">;</span></span>
<span id="cb33-46"><a href="#cb33-46" tabindex="-1"></a></span>
<span id="cb33-47"><a href="#cb33-47" tabindex="-1"></a><span class="co">// Visualize the number of images contributing to each pixel </span></span>
<span id="cb33-48"><a href="#cb33-48" tabindex="-1"></a><span class="co">// of the composite</span></span>
<span id="cb33-49"><a href="#cb33-49" tabindex="-1"></a><span class="co">// Select a single band and use count()</span></span>
<span id="cb33-50"><a href="#cb33-50" tabindex="-1"></a><span class="kw">var</span> count <span class="op">=</span> filtered<span class="op">.</span><span class="fu">select</span>([<span class="st">&#39;B4&#39;</span>])<span class="op">.</span><span class="fu">count</span>()<span class="op">;</span></span>
<span id="cb33-51"><a href="#cb33-51" tabindex="-1"></a></span>
<span id="cb33-52"><a href="#cb33-52" tabindex="-1"></a><span class="co">// show image count</span></span>
<span id="cb33-53"><a href="#cb33-53" tabindex="-1"></a><span class="kw">var</span> countVis <span class="op">=</span> {</span>
<span id="cb33-54"><a href="#cb33-54" tabindex="-1"></a>    <span class="dt">min</span><span class="op">:</span> <span class="dv">50</span><span class="op">,</span></span>
<span id="cb33-55"><a href="#cb33-55" tabindex="-1"></a>    <span class="dt">max</span><span class="op">:</span> <span class="dv">100</span><span class="op">,</span></span>
<span id="cb33-56"><a href="#cb33-56" tabindex="-1"></a>    <span class="dt">palette</span><span class="op">:</span> [<span class="st">&#39;#fee5d9&#39;</span><span class="op">,</span><span class="st">&#39;#fcae91&#39;</span><span class="op">,</span><span class="st">&#39;#fb6a4a&#39;</span><span class="op">,</span><span class="st">&#39;#de2d26&#39;</span><span class="op">,</span><span class="st">&#39;#a50f15&#39;</span>]</span>
<span id="cb33-57"><a href="#cb33-57" tabindex="-1"></a>}</span>
<span id="cb33-58"><a href="#cb33-58" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(count<span class="op">.</span><span class="fu">clip</span>(geometry)<span class="op">,</span> countVis<span class="op">,</span> <span class="st">&#39;Number of S2 Scenes&#39;</span>)</span></code></pre></div>
</div>
<div id="visualizing-bands-of-an-image" class="section level2">
<h2>Visualizing Bands of an Image</h2>
<p>This script shows how to visualize bands of an image as a FilmStrip
or a Video. The functions to create these visualizations work on
ImageCollections, so we turn the multi-band image into a collection and
visualize it.</p>
<div class="figure" style="text-align: center">
<img src="images/end_to_end_gee/filmstrip.png" alt="FilmStrip Visualization" width="100%" />
<p class="caption">
FilmStrip Visualization
</p>
</div>
<div class="figure" style="text-align: center">
<img src="images/end_to_end_gee/bands_animation.gif" alt="Video Visualization" width="100%" />
<p class="caption">
Video Visualization
</p>
</div>
<p><a
href="https://code.earthengine.google.co.in/?scriptPath=users%2Fujavalgandhi%2FEnd-to-End-GEE%3ASupplement%2FImage_Collections%2FVisualizing_Bands_of_an_Image"
target="_blank">Open in Code Editor ↗</a></p>
<div class="sourceCode" id="cb34"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb34-1"><a href="#cb34-1" tabindex="-1"></a><span class="co">// Example script showing how to visualize</span></span>
<span id="cb34-2"><a href="#cb34-2" tabindex="-1"></a><span class="co">// all the bands of an image</span></span>
<span id="cb34-3"><a href="#cb34-3" tabindex="-1"></a><span class="co">// 1. Filmstrip: Create a tiled image with all the bands</span></span>
<span id="cb34-4"><a href="#cb34-4" tabindex="-1"></a><span class="co">// 2. Animation: Create a video with a frame for each band</span></span>
<span id="cb34-5"><a href="#cb34-5" tabindex="-1"></a></span>
<span id="cb34-6"><a href="#cb34-6" tabindex="-1"></a><span class="kw">var</span> s2 <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&#39;COPERNICUS/S2_HARMONIZED&#39;</span>)<span class="op">;</span></span>
<span id="cb34-7"><a href="#cb34-7" tabindex="-1"></a></span>
<span id="cb34-8"><a href="#cb34-8" tabindex="-1"></a><span class="co">// You may delete and draw a polygon at any region</span></span>
<span id="cb34-9"><a href="#cb34-9" tabindex="-1"></a><span class="co">// in the world</span></span>
<span id="cb34-10"><a href="#cb34-10" tabindex="-1"></a><span class="kw">var</span> geometry <span class="op">=</span> ee<span class="op">.</span><span class="at">Geometry</span><span class="op">.</span><span class="fu">Polygon</span>([[</span>
<span id="cb34-11"><a href="#cb34-11" tabindex="-1"></a>  [<span class="fl">77.57018</span><span class="op">,</span> <span class="fl">12.96010</span>]<span class="op">,</span></span>
<span id="cb34-12"><a href="#cb34-12" tabindex="-1"></a>  [<span class="fl">77.57018</span><span class="op">,</span> <span class="fl">12.93953</span>]<span class="op">,</span></span>
<span id="cb34-13"><a href="#cb34-13" tabindex="-1"></a>  [<span class="fl">77.59988</span><span class="op">,</span> <span class="fl">12.93953</span>]<span class="op">,</span></span>
<span id="cb34-14"><a href="#cb34-14" tabindex="-1"></a>  [<span class="fl">77.59988</span><span class="op">,</span> <span class="fl">12.96010</span>]]</span>
<span id="cb34-15"><a href="#cb34-15" tabindex="-1"></a>])<span class="op">;</span></span>
<span id="cb34-16"><a href="#cb34-16" tabindex="-1"></a>          </span>
<span id="cb34-17"><a href="#cb34-17" tabindex="-1"></a><span class="kw">var</span> filteredS2 <span class="op">=</span> s2<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">lt</span>(<span class="st">&#39;CLOUDY_PIXEL_PERCENTAGE&#39;</span><span class="op">,</span> <span class="dv">30</span>))</span>
<span id="cb34-18"><a href="#cb34-18" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(<span class="st">&#39;2019-01-01&#39;</span><span class="op">,</span> <span class="st">&#39;2020-01-01&#39;</span>))</span>
<span id="cb34-19"><a href="#cb34-19" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">bounds</span>(geometry))<span class="op">;</span></span>
<span id="cb34-20"><a href="#cb34-20" tabindex="-1"></a></span>
<span id="cb34-21"><a href="#cb34-21" tabindex="-1"></a><span class="co">// Sort the collection and pick the least cloudy image</span></span>
<span id="cb34-22"><a href="#cb34-22" tabindex="-1"></a><span class="kw">var</span> filteredS2Sorted <span class="op">=</span> filteredS2<span class="op">.</span><span class="fu">sort</span>(<span class="st">&#39;CLOUDY_PIXEL_PERCENTAGE&#39;</span>)<span class="op">;</span></span>
<span id="cb34-23"><a href="#cb34-23" tabindex="-1"></a><span class="kw">var</span> image <span class="op">=</span> filteredS2Sorted<span class="op">.</span><span class="fu">first</span>()<span class="op">;</span></span>
<span id="cb34-24"><a href="#cb34-24" tabindex="-1"></a></span>
<span id="cb34-25"><a href="#cb34-25" tabindex="-1"></a><span class="co">// Convert the multi-band image to an ImageCollection</span></span>
<span id="cb34-26"><a href="#cb34-26" tabindex="-1"></a><span class="kw">var</span> bands <span class="op">=</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;B.*&#39;</span>)<span class="op">.</span><span class="fu">bandNames</span>()<span class="op">;</span></span>
<span id="cb34-27"><a href="#cb34-27" tabindex="-1"></a></span>
<span id="cb34-28"><a href="#cb34-28" tabindex="-1"></a><span class="co">// Remove the &#39;Cirrus&#39; band</span></span>
<span id="cb34-29"><a href="#cb34-29" tabindex="-1"></a><span class="kw">var</span> bandsToUse <span class="op">=</span> bands<span class="op">.</span><span class="fu">remove</span>(<span class="st">&#39;B10&#39;</span>)<span class="op">;</span></span>
<span id="cb34-30"><a href="#cb34-30" tabindex="-1"></a></span>
<span id="cb34-31"><a href="#cb34-31" tabindex="-1"></a><span class="co">// Tip: change the bandsToUse variable to a smaller list</span></span>
<span id="cb34-32"><a href="#cb34-32" tabindex="-1"></a><span class="co">// such as [&#39;B1&#39;, &#39;B2&#39;, &#39;B3&#39;, &#39;B4] to create shorter </span></span>
<span id="cb34-33"><a href="#cb34-33" tabindex="-1"></a><span class="co">// filmstrips and repeat for other set of bands</span></span>
<span id="cb34-34"><a href="#cb34-34" tabindex="-1"></a></span>
<span id="cb34-35"><a href="#cb34-35" tabindex="-1"></a><span class="co">// map() a function on the list of bands</span></span>
<span id="cb34-36"><a href="#cb34-36" tabindex="-1"></a><span class="kw">var</span> bandCol <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(bandsToUse<span class="op">.</span><span class="fu">map</span>(<span class="kw">function</span>(band) {</span>
<span id="cb34-37"><a href="#cb34-37" tabindex="-1"></a>  <span class="co">// All images in a collection are expected to have the same bands</span></span>
<span id="cb34-38"><a href="#cb34-38" tabindex="-1"></a>  <span class="co">// Set the name of hte bands to &#39;band&#39;</span></span>
<span id="cb34-39"><a href="#cb34-39" tabindex="-1"></a>  <span class="kw">var</span> bandImage <span class="op">=</span> image<span class="op">.</span><span class="fu">select</span>([band])<span class="op">.</span><span class="fu">rename</span>(<span class="st">&#39;band&#39;</span>)<span class="op">;</span></span>
<span id="cb34-40"><a href="#cb34-40" tabindex="-1"></a>  <span class="co">// Set the image ID to the actual name of the band. i.e. B1, B2 etc.</span></span>
<span id="cb34-41"><a href="#cb34-41" tabindex="-1"></a>  <span class="cf">return</span> bandImage<span class="op">.</span><span class="fu">set</span>(<span class="st">&#39;system:index&#39;</span><span class="op">,</span> band)<span class="op">;</span></span>
<span id="cb34-42"><a href="#cb34-42" tabindex="-1"></a>}))<span class="op">;</span></span>
<span id="cb34-43"><a href="#cb34-43" tabindex="-1"></a></span>
<span id="cb34-44"><a href="#cb34-44" tabindex="-1"></a><span class="co">// Define arguments for the getFilmstripThumbURL function parameters.</span></span>
<span id="cb34-45"><a href="#cb34-45" tabindex="-1"></a><span class="kw">var</span> filmArgs <span class="op">=</span> {</span>
<span id="cb34-46"><a href="#cb34-46" tabindex="-1"></a>  <span class="dt">dimensions</span><span class="op">:</span> <span class="dv">800</span><span class="op">,</span></span>
<span id="cb34-47"><a href="#cb34-47" tabindex="-1"></a>  <span class="dt">region</span><span class="op">:</span> geometry<span class="op">,</span></span>
<span id="cb34-48"><a href="#cb34-48" tabindex="-1"></a>  <span class="dt">crs</span><span class="op">:</span> <span class="st">&#39;EPSG:3857&#39;</span><span class="op">,</span></span>
<span id="cb34-49"><a href="#cb34-49" tabindex="-1"></a>  <span class="dt">min</span><span class="op">:</span> <span class="dv">500</span><span class="op">,</span></span>
<span id="cb34-50"><a href="#cb34-50" tabindex="-1"></a>  <span class="dt">max</span><span class="op">:</span> <span class="dv">2700</span><span class="op">,</span></span>
<span id="cb34-51"><a href="#cb34-51" tabindex="-1"></a>  <span class="dt">palette</span><span class="op">:</span> [<span class="st">&#39;black&#39;</span><span class="op">,</span> <span class="st">&#39;white&#39;</span>]</span>
<span id="cb34-52"><a href="#cb34-52" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb34-53"><a href="#cb34-53" tabindex="-1"></a></span>
<span id="cb34-54"><a href="#cb34-54" tabindex="-1"></a><span class="co">// Print a URL that will produce the filmstrip when accessed.</span></span>
<span id="cb34-55"><a href="#cb34-55" tabindex="-1"></a><span class="fu">print</span>(<span class="st">&#39;Film Strip (click to view)&#39;</span><span class="op">,</span> bandCol<span class="op">.</span><span class="fu">getFilmstripThumbURL</span>(filmArgs))<span class="op">;</span></span>
<span id="cb34-56"><a href="#cb34-56" tabindex="-1"></a></span>
<span id="cb34-57"><a href="#cb34-57" tabindex="-1"></a><span class="co">// Create an Animation</span></span>
<span id="cb34-58"><a href="#cb34-58" tabindex="-1"></a><span class="kw">var</span> videoArgs <span class="op">=</span> {</span>
<span id="cb34-59"><a href="#cb34-59" tabindex="-1"></a>  <span class="dt">dimensions</span><span class="op">:</span> <span class="dv">800</span><span class="op">,</span></span>
<span id="cb34-60"><a href="#cb34-60" tabindex="-1"></a>  <span class="dt">region</span><span class="op">:</span> geometry<span class="op">,</span></span>
<span id="cb34-61"><a href="#cb34-61" tabindex="-1"></a>  <span class="dt">crs</span><span class="op">:</span> <span class="st">&#39;EPSG:3857&#39;</span><span class="op">,</span></span>
<span id="cb34-62"><a href="#cb34-62" tabindex="-1"></a>  <span class="dt">framesPerSeconds</span><span class="op">:</span> <span class="dv">1</span><span class="op">,</span></span>
<span id="cb34-63"><a href="#cb34-63" tabindex="-1"></a>  <span class="dt">min</span><span class="op">:</span> <span class="dv">500</span><span class="op">,</span></span>
<span id="cb34-64"><a href="#cb34-64" tabindex="-1"></a>  <span class="dt">max</span><span class="op">:</span> <span class="dv">2700</span><span class="op">,</span></span>
<span id="cb34-65"><a href="#cb34-65" tabindex="-1"></a>  <span class="dt">palette</span><span class="op">:</span> [<span class="st">&#39;black&#39;</span><span class="op">,</span> <span class="st">&#39;white&#39;</span>]</span>
<span id="cb34-66"><a href="#cb34-66" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb34-67"><a href="#cb34-67" tabindex="-1"></a></span>
<span id="cb34-68"><a href="#cb34-68" tabindex="-1"></a><span class="fu">print</span>(<span class="st">&#39;Animation (click to view)&#39;</span><span class="op">,</span> bandCol<span class="op">.</span><span class="fu">getVideoThumbURL</span>(videoArgs))<span class="op">;</span></span>
<span id="cb34-69"><a href="#cb34-69" tabindex="-1"></a></span>
<span id="cb34-70"><a href="#cb34-70" tabindex="-1"></a><span class="kw">var</span> rgbVis <span class="op">=</span> {<span class="dt">min</span><span class="op">:</span> <span class="fl">0.0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span> <span class="dv">3000</span><span class="op">,</span> <span class="dt">bands</span><span class="op">:</span> [<span class="st">&#39;B4&#39;</span><span class="op">,</span> <span class="st">&#39;B3&#39;</span><span class="op">,</span> <span class="st">&#39;B2&#39;</span>]}<span class="op">;</span></span>
<span id="cb34-71"><a href="#cb34-71" tabindex="-1"></a></span>
<span id="cb34-72"><a href="#cb34-72" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">centerObject</span>(geometry<span class="op">,</span> <span class="dv">10</span>)<span class="op">;</span></span>
<span id="cb34-73"><a href="#cb34-73" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(image<span class="op">,</span> rgbVis<span class="op">,</span> <span class="st">&#39;Image&#39;</span>)<span class="op">;</span></span></code></pre></div>
</div>
</div>
<div id="advanced-image-processing" class="section level1">
<h1>Advanced Image Processing</h1>
<div id="working-with-landsat-collection-2" class="section level2">
<h2>Working with Landsat Collection 2</h2>
<p><a
href="https://code.earthengine.google.co.in/?scriptPath=users%2Fujavalgandhi%2FEnd-to-End-GEE%3ASupplement%2FImage_Processing%2FLandsat_Indices"
target="_blank">Open in Code Editor ↗</a></p>
<div class="sourceCode" id="cb35"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb35-1"><a href="#cb35-1" tabindex="-1"></a><span class="co">// Example script for calculating NDVI and EVI from Landsat Collection 2 images</span></span>
<span id="cb35-2"><a href="#cb35-2" tabindex="-1"></a></span>
<span id="cb35-3"><a href="#cb35-3" tabindex="-1"></a><span class="co">// Get Banglore boundary </span></span>
<span id="cb35-4"><a href="#cb35-4" tabindex="-1"></a><span class="kw">var</span> admin2 <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">&quot;FAO/GAUL_SIMPLIFIED_500m/2015/level2&quot;</span>)<span class="op">;</span></span>
<span id="cb35-5"><a href="#cb35-5" tabindex="-1"></a> </span>
<span id="cb35-6"><a href="#cb35-6" tabindex="-1"></a><span class="kw">var</span> bangalore <span class="op">=</span> admin2<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;ADM2_NAME&#39;</span><span class="op">,</span> <span class="st">&#39;Bangalore Urban&#39;</span>))<span class="op">;</span></span>
<span id="cb35-7"><a href="#cb35-7" tabindex="-1"></a><span class="kw">var</span> geometry <span class="op">=</span> bangalore<span class="op">.</span><span class="fu">geometry</span>()<span class="op">;</span></span>
<span id="cb35-8"><a href="#cb35-8" tabindex="-1"></a></span>
<span id="cb35-9"><a href="#cb35-9" tabindex="-1"></a><span class="co">// Applies cloud mask and scaling factors.</span></span>
<span id="cb35-10"><a href="#cb35-10" tabindex="-1"></a><span class="kw">function</span> <span class="fu">maskL8sr</span>(image) {</span>
<span id="cb35-11"><a href="#cb35-11" tabindex="-1"></a>  <span class="co">// Bit 0 - Fill</span></span>
<span id="cb35-12"><a href="#cb35-12" tabindex="-1"></a>  <span class="co">// Bit 1 - Dilated Cloud</span></span>
<span id="cb35-13"><a href="#cb35-13" tabindex="-1"></a>  <span class="co">// Bit 2 - Cirrus</span></span>
<span id="cb35-14"><a href="#cb35-14" tabindex="-1"></a>  <span class="co">// Bit 3 - Cloud</span></span>
<span id="cb35-15"><a href="#cb35-15" tabindex="-1"></a>  <span class="co">// Bit 4 - Cloud Shadow</span></span>
<span id="cb35-16"><a href="#cb35-16" tabindex="-1"></a>  <span class="kw">var</span> qaMask <span class="op">=</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;QA_PIXEL&#39;</span>)<span class="op">.</span><span class="fu">bitwiseAnd</span>(<span class="pp">parseInt</span>(<span class="st">&#39;11111&#39;</span><span class="op">,</span> <span class="dv">2</span>))<span class="op">.</span><span class="fu">eq</span>(<span class="dv">0</span>)<span class="op">;</span></span>
<span id="cb35-17"><a href="#cb35-17" tabindex="-1"></a>  <span class="kw">var</span> saturationMask <span class="op">=</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;QA_RADSAT&#39;</span>)<span class="op">.</span><span class="fu">eq</span>(<span class="dv">0</span>)<span class="op">;</span></span>
<span id="cb35-18"><a href="#cb35-18" tabindex="-1"></a></span>
<span id="cb35-19"><a href="#cb35-19" tabindex="-1"></a>  <span class="co">// Apply the scaling factors to the appropriate bands.</span></span>
<span id="cb35-20"><a href="#cb35-20" tabindex="-1"></a>  <span class="kw">var</span> opticalBands <span class="op">=</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;SR_B.&#39;</span>)<span class="op">.</span><span class="fu">multiply</span>(<span class="fl">0.0000275</span>)<span class="op">.</span><span class="fu">add</span>(<span class="op">-</span><span class="fl">0.2</span>)<span class="op">;</span></span>
<span id="cb35-21"><a href="#cb35-21" tabindex="-1"></a>  <span class="kw">var</span> thermalBands <span class="op">=</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;ST_B.*&#39;</span>)<span class="op">.</span><span class="fu">multiply</span>(<span class="fl">0.00341802</span>)<span class="op">.</span><span class="fu">add</span>(<span class="fl">149.0</span>)<span class="op">;</span></span>
<span id="cb35-22"><a href="#cb35-22" tabindex="-1"></a></span>
<span id="cb35-23"><a href="#cb35-23" tabindex="-1"></a>  <span class="co">// Replace the original bands with the scaled ones and apply the masks.</span></span>
<span id="cb35-24"><a href="#cb35-24" tabindex="-1"></a>  <span class="cf">return</span> image<span class="op">.</span><span class="fu">addBands</span>(opticalBands<span class="op">,</span> <span class="kw">null</span><span class="op">,</span> <span class="kw">true</span>)</span>
<span id="cb35-25"><a href="#cb35-25" tabindex="-1"></a>      <span class="op">.</span><span class="fu">addBands</span>(thermalBands<span class="op">,</span> <span class="kw">null</span><span class="op">,</span> <span class="kw">true</span>)</span>
<span id="cb35-26"><a href="#cb35-26" tabindex="-1"></a>      <span class="op">.</span><span class="fu">updateMask</span>(qaMask)</span>
<span id="cb35-27"><a href="#cb35-27" tabindex="-1"></a>      <span class="op">.</span><span class="fu">updateMask</span>(saturationMask)<span class="op">;</span></span>
<span id="cb35-28"><a href="#cb35-28" tabindex="-1"></a>}</span>
<span id="cb35-29"><a href="#cb35-29" tabindex="-1"></a></span>
<span id="cb35-30"><a href="#cb35-30" tabindex="-1"></a><span class="co">// Filter to 2021 Landsat 8 images over banglore. </span></span>
<span id="cb35-31"><a href="#cb35-31" tabindex="-1"></a><span class="kw">var</span> dataset <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&#39;LANDSAT/LC08/C02/T1_L2&#39;</span>)</span>
<span id="cb35-32"><a href="#cb35-32" tabindex="-1"></a>    <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(<span class="st">&#39;2021-01-01&#39;</span><span class="op">,</span> <span class="st">&#39;2022-01-01&#39;</span>))</span>
<span id="cb35-33"><a href="#cb35-33" tabindex="-1"></a>    <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">bounds</span>(geometry))</span>
<span id="cb35-34"><a href="#cb35-34" tabindex="-1"></a>    <span class="op">.</span><span class="fu">map</span>(maskL8sr)<span class="op">;</span></span>
<span id="cb35-35"><a href="#cb35-35" tabindex="-1"></a></span>
<span id="cb35-36"><a href="#cb35-36" tabindex="-1"></a><span class="co">// Create a median composite</span></span>
<span id="cb35-37"><a href="#cb35-37" tabindex="-1"></a><span class="kw">var</span> image <span class="op">=</span> dataset<span class="op">.</span><span class="fu">median</span>()<span class="op">;</span> </span>
<span id="cb35-38"><a href="#cb35-38" tabindex="-1"></a></span>
<span id="cb35-39"><a href="#cb35-39" tabindex="-1"></a><span class="co">// Print to check the bands. </span></span>
<span id="cb35-40"><a href="#cb35-40" tabindex="-1"></a><span class="fu">print</span>(image)<span class="op">;</span></span>
<span id="cb35-41"><a href="#cb35-41" tabindex="-1"></a></span>
<span id="cb35-42"><a href="#cb35-42" tabindex="-1"></a><span class="co">// Create NDVI image. </span></span>
<span id="cb35-43"><a href="#cb35-43" tabindex="-1"></a><span class="kw">var</span> ndvi <span class="op">=</span> image<span class="op">.</span><span class="fu">normalizedDifference</span>([<span class="st">&#39;SR_B5&#39;</span><span class="op">,</span> <span class="st">&#39;SR_B4&#39;</span>])<span class="op">.</span><span class="fu">rename</span>([<span class="st">&#39;ndvi&#39;</span>])<span class="op">;</span></span>
<span id="cb35-44"><a href="#cb35-44" tabindex="-1"></a></span>
<span id="cb35-45"><a href="#cb35-45" tabindex="-1"></a><span class="co">// Create MNDWI image. </span></span>
<span id="cb35-46"><a href="#cb35-46" tabindex="-1"></a><span class="kw">var</span> mndwi <span class="op">=</span> image<span class="op">.</span><span class="fu">normalizedDifference</span>([<span class="st">&#39;SR_B3&#39;</span><span class="op">,</span> <span class="st">&#39;SR_B6&#39;</span>])<span class="op">.</span><span class="fu">rename</span>([<span class="st">&#39;mndwi&#39;</span>])<span class="op">;</span></span>
<span id="cb35-47"><a href="#cb35-47" tabindex="-1"></a></span>
<span id="cb35-48"><a href="#cb35-48" tabindex="-1"></a><span class="co">// Create EVI image</span></span>
<span id="cb35-49"><a href="#cb35-49" tabindex="-1"></a><span class="co">// EVI = 2.5 * ((Band 5 – Band 4) / (Band 5 + 6 * Band 4 – 7.5 * Band 2 + 1)).</span></span>
<span id="cb35-50"><a href="#cb35-50" tabindex="-1"></a><span class="kw">var</span> evi <span class="op">=</span> image<span class="op">.</span><span class="fu">expression</span>(</span>
<span id="cb35-51"><a href="#cb35-51" tabindex="-1"></a>    <span class="st">&#39;2.5 * ( (NIR - RED) / (NIR + 6 * RED - 7.5 * BLUE + 1))&#39;</span><span class="op">,</span> {</span>
<span id="cb35-52"><a href="#cb35-52" tabindex="-1"></a>      <span class="st">&#39;BLUE&#39;</span><span class="op">:</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;SR_B2&#39;</span>)<span class="op">,</span></span>
<span id="cb35-53"><a href="#cb35-53" tabindex="-1"></a>      <span class="st">&#39;RED&#39;</span><span class="op">:</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;SR_B4&#39;</span>)<span class="op">,</span></span>
<span id="cb35-54"><a href="#cb35-54" tabindex="-1"></a>      <span class="st">&#39;NIR&#39;</span><span class="op">:</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;SR_B5&#39;</span>)</span>
<span id="cb35-55"><a href="#cb35-55" tabindex="-1"></a>})<span class="op">.</span><span class="fu">rename</span>(<span class="st">&#39;evi&#39;</span>)<span class="op">;</span></span>
<span id="cb35-56"><a href="#cb35-56" tabindex="-1"></a></span>
<span id="cb35-57"><a href="#cb35-57" tabindex="-1"></a><span class="co">// Create MNDWI image</span></span>
<span id="cb35-58"><a href="#cb35-58" tabindex="-1"></a></span>
<span id="cb35-59"><a href="#cb35-59" tabindex="-1"></a><span class="co">// Visualization parameter. </span></span>
<span id="cb35-60"><a href="#cb35-60" tabindex="-1"></a><span class="kw">var</span> rgbVis <span class="op">=</span> {<span class="dt">min</span><span class="op">:</span><span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span><span class="fl">0.3</span><span class="op">,</span> <span class="dt">bands</span><span class="op">:</span>[<span class="st">&#39;SR_B4&#39;</span><span class="op">,</span> <span class="st">&#39;SR_B3&#39;</span><span class="op">,</span> <span class="st">&#39;SR_B2&#39;</span>]}<span class="op">;</span></span>
<span id="cb35-61"><a href="#cb35-61" tabindex="-1"></a><span class="kw">var</span> ndviVis <span class="op">=</span> {<span class="dt">min</span><span class="op">:</span><span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span><span class="fl">0.5</span><span class="op">,</span>  <span class="dt">palette</span><span class="op">:</span> [<span class="st">&#39;white&#39;</span><span class="op">,</span> <span class="st">&#39;green&#39;</span>]}<span class="op">;</span></span>
<span id="cb35-62"><a href="#cb35-62" tabindex="-1"></a><span class="kw">var</span> ndwiVis <span class="op">=</span> {<span class="dt">min</span><span class="op">:</span><span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span><span class="fl">0.5</span><span class="op">,</span>  <span class="dt">palette</span><span class="op">:</span> [<span class="st">&#39;white&#39;</span><span class="op">,</span> <span class="st">&#39;blue&#39;</span>]}<span class="op">;</span></span>
<span id="cb35-63"><a href="#cb35-63" tabindex="-1"></a></span>
<span id="cb35-64"><a href="#cb35-64" tabindex="-1"></a><span class="co">// Add EVI and NDVI images to Map. </span></span>
<span id="cb35-65"><a href="#cb35-65" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">centerObject</span>(geometry)<span class="op">;</span></span>
<span id="cb35-66"><a href="#cb35-66" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(image<span class="op">.</span><span class="fu">clip</span>(geometry)<span class="op">,</span> rgbVis<span class="op">,</span> <span class="st">&#39;Image&#39;</span>)<span class="op">;</span></span>
<span id="cb35-67"><a href="#cb35-67" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(evi<span class="op">.</span><span class="fu">clip</span>(geometry)<span class="op">,</span> ndviVis<span class="op">,</span> <span class="st">&#39;EVI&#39;</span>)<span class="op">;</span></span>
<span id="cb35-68"><a href="#cb35-68" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(ndvi<span class="op">.</span><span class="fu">clip</span>(geometry)<span class="op">,</span> ndviVis<span class="op">,</span> <span class="st">&#39;NDVI&#39;</span>)<span class="op">;</span></span>
<span id="cb35-69"><a href="#cb35-69" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(mndwi<span class="op">.</span><span class="fu">clip</span>(geometry)<span class="op">,</span> ndwiVis<span class="op">,</span> <span class="st">&#39;MNDWI&#39;</span>)<span class="op">;</span></span></code></pre></div>
</div>
<div id="derive-lst-from-landsat-images" class="section level2">
<h2>Derive LST from Landsat Images</h2>
<p>Many researchers are interested in studying the effects of climate
change and the urban environment. Landsat sensors have thermal bands
which makes it possible to study these interactions at high spatial and
temporal resolutions. The script below shows how to compute LST using
two different methods.</p>
<ul>
<li>Method 1: Using the <a
href="https://www.mdpi.com/2072-4292/12/9/1471">LST Computation
Algorithm by Sofia Ermida</a>.</li>
<li>Method 2: Using <a
href="https://www.usgs.gov/landsat-missions/landsat-collection-2-surface-temperature">Landsat
Collection 2 Level 2 Dataset</a>.</li>
</ul>
<blockquote>
<p>Warning: LST has poor correlation with thermal stress experienced by
humans. Users should not use satellite-derived LST as a proxy for
measurement or mitigation of exposure to heat. References: <a
href="https://www.tandfonline.com/doi/full/10.1080/1747423X.2021.2015003">[1]</a>
<a
href="https://www.sciencedirect.com/science/article/pii/S2590332223002506">[2]</a></p>
</blockquote>
<p>The script generates a map of land surface temperature distribution
along with a time series for different land surfaces.</p>
<div class="figure" style="text-align: center">
<img src="images/end_to_end_gee/landsat_lst_time_series.png" alt="LST Time-Series for Different Landcovers" width="100%" />
<p class="caption">
LST Time-Series for Different Landcovers
</p>
</div>
<p><a
href="https://code.earthengine.google.co.in/?scriptPath=users%2Fujavalgandhi%2FEnd-to-End-GEE%3ASupplement%2FImage_Processing%2FLandsat_LST"
target="_blank">Open in Code Editor ↗</a></p>
<div class="sourceCode" id="cb36"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb36-1"><a href="#cb36-1" tabindex="-1"></a><span class="co">// Script showing how to obtain a Landsat LST Time-Series</span></span>
<span id="cb36-2"><a href="#cb36-2" tabindex="-1"></a><span class="co">// over different land surfaces</span></span>
<span id="cb36-3"><a href="#cb36-3" tabindex="-1"></a></span>
<span id="cb36-4"><a href="#cb36-4" tabindex="-1"></a><span class="kw">var</span> metalroof <span class="op">=</span> ee<span class="op">.</span><span class="at">Geometry</span><span class="op">.</span><span class="fu">Point</span>([<span class="fl">72.8550936937685</span><span class="op">,</span> <span class="fl">19.044646120301234</span>])<span class="op">;</span></span>
<span id="cb36-5"><a href="#cb36-5" tabindex="-1"></a><span class="kw">var</span> concreteroof <span class="op">=</span>  ee<span class="op">.</span><span class="at">Geometry</span><span class="op">.</span><span class="fu">Point</span>([<span class="fl">72.85441764267667</span><span class="op">,</span> <span class="fl">19.028290540890772</span>])<span class="op">;</span></span>
<span id="cb36-6"><a href="#cb36-6" tabindex="-1"></a><span class="kw">var</span> airport <span class="op">=</span> ee<span class="op">.</span><span class="at">Geometry</span><span class="op">.</span><span class="fu">Point</span>([<span class="fl">72.86249644714638</span><span class="op">,</span> <span class="fl">19.09355985643176</span>])<span class="op">;</span></span>
<span id="cb36-7"><a href="#cb36-7" tabindex="-1"></a><span class="kw">var</span> water <span class="op">=</span> ee<span class="op">.</span><span class="at">Geometry</span><span class="op">.</span><span class="fu">Point</span>([<span class="fl">72.91107782264197</span><span class="op">,</span> <span class="fl">19.152799035509638</span>])<span class="op">;</span></span>
<span id="cb36-8"><a href="#cb36-8" tabindex="-1"></a><span class="kw">var</span> mangrove <span class="op">=</span>  ee<span class="op">.</span><span class="at">Geometry</span><span class="op">.</span><span class="fu">Point</span>([<span class="fl">72.8115905761819</span><span class="op">,</span> <span class="fl">19.152316393168405</span>])<span class="op">;</span></span>
<span id="cb36-9"><a href="#cb36-9" tabindex="-1"></a>    </span>
<span id="cb36-10"><a href="#cb36-10" tabindex="-1"></a><span class="co">// Use Mumbai city boundary</span></span>
<span id="cb36-11"><a href="#cb36-11" tabindex="-1"></a><span class="kw">var</span> mumbai_wards <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(</span>
<span id="cb36-12"><a href="#cb36-12" tabindex="-1"></a>  <span class="st">&#39;users/ujavalgandhi/public/mumbai_bmc_wards_datameet&#39;</span>)<span class="op">;</span></span>
<span id="cb36-13"><a href="#cb36-13" tabindex="-1"></a><span class="kw">var</span> geometry <span class="op">=</span> mumbai_wards<span class="op">.</span><span class="fu">geometry</span>()<span class="op">;</span></span>
<span id="cb36-14"><a href="#cb36-14" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">centerObject</span>(geometry<span class="op">,</span> <span class="dv">12</span>)<span class="op">;</span></span>
<span id="cb36-15"><a href="#cb36-15" tabindex="-1"></a></span>
<span id="cb36-16"><a href="#cb36-16" tabindex="-1"></a><span class="co">// Method 1</span></span>
<span id="cb36-17"><a href="#cb36-17" tabindex="-1"></a><span class="co">// LST Computation code by Sofia Ermida (sofia.ermida@ipma.pt; @ermida_sofia)</span></span>
<span id="cb36-18"><a href="#cb36-18" tabindex="-1"></a></span>
<span id="cb36-19"><a href="#cb36-19" tabindex="-1"></a><span class="co">// Ermida, S.L., Soares, P., Mantas, V., Göttsche, F.-M., Trigo, I.F., 2020. </span></span>
<span id="cb36-20"><a href="#cb36-20" tabindex="-1"></a><span class="co">//     Google Earth Engine open-source code for Land Surface Temperature estimation from the Landsat series.</span></span>
<span id="cb36-21"><a href="#cb36-21" tabindex="-1"></a><span class="co">//     Remote Sensing, 12 (9), 1471; https://doi.org/10.3390/rs12091471</span></span>
<span id="cb36-22"><a href="#cb36-22" tabindex="-1"></a><span class="kw">var</span> LandsatLST <span class="op">=</span> <span class="pp">require</span>(<span class="st">&#39;users/sofiaermida/landsat_smw_lst:modules/Landsat_LST.js&#39;</span>)</span>
<span id="cb36-23"><a href="#cb36-23" tabindex="-1"></a></span>
<span id="cb36-24"><a href="#cb36-24" tabindex="-1"></a><span class="co">// Set parameters to get Landsat 8 data</span></span>
<span id="cb36-25"><a href="#cb36-25" tabindex="-1"></a><span class="kw">var</span> satellite <span class="op">=</span> <span class="st">&#39;L8&#39;</span><span class="op">;</span></span>
<span id="cb36-26"><a href="#cb36-26" tabindex="-1"></a><span class="kw">var</span> date_start <span class="op">=</span> <span class="st">&#39;2015-01-01&#39;</span><span class="op">;</span></span>
<span id="cb36-27"><a href="#cb36-27" tabindex="-1"></a><span class="kw">var</span> date_end <span class="op">=</span> <span class="st">&#39;2016-01-01&#39;</span><span class="op">;</span></span>
<span id="cb36-28"><a href="#cb36-28" tabindex="-1"></a><span class="kw">var</span> use_ndvi <span class="op">=</span> <span class="kw">true</span><span class="op">;</span></span>
<span id="cb36-29"><a href="#cb36-29" tabindex="-1"></a></span>
<span id="cb36-30"><a href="#cb36-30" tabindex="-1"></a><span class="co">// get landsat collection with added variables: NDVI, FVC, TPW, EM, LST</span></span>
<span id="cb36-31"><a href="#cb36-31" tabindex="-1"></a><span class="kw">var</span> LandsatColl <span class="op">=</span> LandsatLST<span class="op">.</span><span class="fu">collection</span>(satellite<span class="op">,</span> date_start<span class="op">,</span> date_end<span class="op">,</span> geometry<span class="op">,</span> use_ndvi)</span>
<span id="cb36-32"><a href="#cb36-32" tabindex="-1"></a></span>
<span id="cb36-33"><a href="#cb36-33" tabindex="-1"></a><span class="co">// Select LST band</span></span>
<span id="cb36-34"><a href="#cb36-34" tabindex="-1"></a><span class="kw">var</span> lstK <span class="op">=</span> LandsatColl<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;LST&#39;</span>)</span>
<span id="cb36-35"><a href="#cb36-35" tabindex="-1"></a></span>
<span id="cb36-36"><a href="#cb36-36" tabindex="-1"></a><span class="co">// Convert to celsius</span></span>
<span id="cb36-37"><a href="#cb36-37" tabindex="-1"></a><span class="kw">var</span> lstC <span class="op">=</span> lstK<span class="op">.</span><span class="fu">map</span>(<span class="kw">function</span>(image){</span>
<span id="cb36-38"><a href="#cb36-38" tabindex="-1"></a>  <span class="cf">return</span> image<span class="op">.</span><span class="fu">subtract</span>(<span class="fl">273.15</span>)<span class="op">.</span><span class="fu">copyProperties</span>(image<span class="op">,</span> image<span class="op">.</span><span class="fu">propertyNames</span>())</span>
<span id="cb36-39"><a href="#cb36-39" tabindex="-1"></a>})</span>
<span id="cb36-40"><a href="#cb36-40" tabindex="-1"></a></span>
<span id="cb36-41"><a href="#cb36-41" tabindex="-1"></a></span>
<span id="cb36-42"><a href="#cb36-42" tabindex="-1"></a><span class="co">// Filter to May month image to visualize in map. </span></span>
<span id="cb36-43"><a href="#cb36-43" tabindex="-1"></a><span class="kw">var</span> lstMay  <span class="op">=</span> lstC</span>
<span id="cb36-44"><a href="#cb36-44" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(<span class="st">&#39;2015-04-01&#39;</span><span class="op">,</span> <span class="st">&#39;2015-05-01&#39;</span>))</span>
<span id="cb36-45"><a href="#cb36-45" tabindex="-1"></a>  <span class="op">.</span><span class="fu">mean</span>()</span>
<span id="cb36-46"><a href="#cb36-46" tabindex="-1"></a></span>
<span id="cb36-47"><a href="#cb36-47" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(lstMay<span class="op">.</span><span class="fu">clip</span>(geometry)<span class="op">,</span> </span>
<span id="cb36-48"><a href="#cb36-48" tabindex="-1"></a>  {<span class="dt">min</span><span class="op">:</span><span class="dv">25</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span><span class="dv">45</span><span class="op">,</span> <span class="dt">palette</span><span class="op">:</span>[<span class="st">&#39;green&#39;</span><span class="op">,</span><span class="st">&#39;yellow&#39;</span><span class="op">,</span><span class="st">&#39;red&#39;</span>]}<span class="op">,</span> </span>
<span id="cb36-49"><a href="#cb36-49" tabindex="-1"></a>  <span class="st">&#39;Landsat-LST (Ermida, S.L)&#39;</span>)</span>
<span id="cb36-50"><a href="#cb36-50" tabindex="-1"></a></span>
<span id="cb36-51"><a href="#cb36-51" tabindex="-1"></a><span class="co">// Create the LSt time series chart. </span></span>
<span id="cb36-52"><a href="#cb36-52" tabindex="-1"></a><span class="kw">var</span> chart <span class="op">=</span> ui<span class="op">.</span><span class="at">Chart</span><span class="op">.</span><span class="at">image</span><span class="op">.</span><span class="fu">seriesByRegion</span>({</span>
<span id="cb36-53"><a href="#cb36-53" tabindex="-1"></a>  <span class="dt">imageCollection</span><span class="op">:</span>lstC<span class="op">,</span>  </span>
<span id="cb36-54"><a href="#cb36-54" tabindex="-1"></a>  <span class="dt">regions</span><span class="op">:</span> [airport<span class="op">,</span> metalroof<span class="op">,</span> concreteroof<span class="op">,</span> mangrove<span class="op">,</span> water]<span class="op">,</span></span>
<span id="cb36-55"><a href="#cb36-55" tabindex="-1"></a>  <span class="dt">reducer</span><span class="op">:</span>ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">mean</span>()<span class="op">,</span></span>
<span id="cb36-56"><a href="#cb36-56" tabindex="-1"></a>  <span class="dt">band</span><span class="op">:</span>[<span class="st">&#39;LST&#39;</span>]<span class="op">,</span></span>
<span id="cb36-57"><a href="#cb36-57" tabindex="-1"></a>  <span class="dt">scale</span><span class="op">:</span><span class="dv">30</span><span class="op">,</span>  </span>
<span id="cb36-58"><a href="#cb36-58" tabindex="-1"></a>  <span class="dt">xProperty</span><span class="op">:</span><span class="st">&#39;system:time_start&#39;</span><span class="op">,</span></span>
<span id="cb36-59"><a href="#cb36-59" tabindex="-1"></a>})<span class="op">.</span><span class="fu">setOptions</span>({</span>
<span id="cb36-60"><a href="#cb36-60" tabindex="-1"></a>      <span class="dt">lineWidth</span><span class="op">:</span> <span class="dv">1</span><span class="op">,</span></span>
<span id="cb36-61"><a href="#cb36-61" tabindex="-1"></a>      <span class="dt">title</span><span class="op">:</span> <span class="st">&#39;Land Surface Temperature Time-Series (Ermida, S.L)&#39;</span><span class="op">,</span></span>
<span id="cb36-62"><a href="#cb36-62" tabindex="-1"></a>      <span class="dt">interpolateNulls</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb36-63"><a href="#cb36-63" tabindex="-1"></a>      <span class="dt">viewWindowMode</span><span class="op">:</span><span class="st">&#39;explicit&#39;</span><span class="op">,</span></span>
<span id="cb36-64"><a href="#cb36-64" tabindex="-1"></a>        <span class="dt">viewWindow</span><span class="op">:</span> {</span>
<span id="cb36-65"><a href="#cb36-65" tabindex="-1"></a>            <span class="dt">max</span><span class="op">:</span><span class="dv">50</span><span class="op">,</span></span>
<span id="cb36-66"><a href="#cb36-66" tabindex="-1"></a>            <span class="dt">min</span><span class="op">:</span><span class="dv">25</span></span>
<span id="cb36-67"><a href="#cb36-67" tabindex="-1"></a>        }<span class="op">,</span></span>
<span id="cb36-68"><a href="#cb36-68" tabindex="-1"></a>      <span class="dt">vAxis</span><span class="op">:</span> {<span class="dt">title</span><span class="op">:</span> <span class="st">&#39;LST (°C)&#39;</span>}<span class="op">,</span></span>
<span id="cb36-69"><a href="#cb36-69" tabindex="-1"></a>      <span class="dt">hAxis</span><span class="op">:</span> {<span class="dt">title</span><span class="op">:</span> <span class="st">&#39;&#39;</span><span class="op">,</span> <span class="dt">format</span><span class="op">:</span> <span class="st">&#39;YYYY-MMM&#39;</span>}<span class="op">,</span></span>
<span id="cb36-70"><a href="#cb36-70" tabindex="-1"></a>      <span class="dt">series</span><span class="op">:</span> {</span>
<span id="cb36-71"><a href="#cb36-71" tabindex="-1"></a>      <span class="dv">0</span><span class="op">:</span> {<span class="dt">color</span><span class="op">:</span> <span class="st">&#39;red&#39;</span><span class="op">,</span> <span class="dt">labelInLegend</span><span class="op">:</span> <span class="st">&#39;Airport Tarmac&#39;</span>}<span class="op">,</span> </span>
<span id="cb36-72"><a href="#cb36-72" tabindex="-1"></a>      <span class="dv">1</span><span class="op">:</span> {<span class="dt">color</span><span class="op">:</span> <span class="st">&#39;pink&#39;</span><span class="op">,</span> <span class="dt">labelInLegend</span><span class="op">:</span> <span class="st">&#39;Residential-Slum (Metal Roof)&#39;</span>}<span class="op">,</span> </span>
<span id="cb36-73"><a href="#cb36-73" tabindex="-1"></a>      <span class="dv">2</span><span class="op">:</span> {<span class="dt">color</span><span class="op">:</span> <span class="st">&#39;grey&#39;</span><span class="op">,</span> <span class="dt">labelInLegend</span><span class="op">:</span> <span class="st">&#39;Residential (Concrete Roof)&#39;</span>}<span class="op">,</span></span>
<span id="cb36-74"><a href="#cb36-74" tabindex="-1"></a>      <span class="dv">3</span><span class="op">:</span> {<span class="dt">color</span><span class="op">:</span> <span class="st">&#39;green&#39;</span><span class="op">,</span> <span class="dt">labelInLegend</span><span class="op">:</span> <span class="st">&#39;Mangrove&#39;</span>}<span class="op">,</span></span>
<span id="cb36-75"><a href="#cb36-75" tabindex="-1"></a>      <span class="dv">4</span><span class="op">:</span> {<span class="dt">color</span><span class="op">:</span> <span class="st">&#39;blue&#39;</span><span class="op">,</span> <span class="dt">labelInLegend</span><span class="op">:</span> <span class="st">&#39;Water&#39;</span>}</span>
<span id="cb36-76"><a href="#cb36-76" tabindex="-1"></a>    } </span>
<span id="cb36-77"><a href="#cb36-77" tabindex="-1"></a>    })</span>
<span id="cb36-78"><a href="#cb36-78" tabindex="-1"></a>  </span>
<span id="cb36-79"><a href="#cb36-79" tabindex="-1"></a><span class="fu">print</span>(chart)<span class="op">;</span></span>
<span id="cb36-80"><a href="#cb36-80" tabindex="-1"></a></span>
<span id="cb36-81"><a href="#cb36-81" tabindex="-1"></a><span class="co">// Method 2</span></span>
<span id="cb36-82"><a href="#cb36-82" tabindex="-1"></a><span class="co">// Landsat Collection 2 Level 2 LST</span></span>
<span id="cb36-83"><a href="#cb36-83" tabindex="-1"></a></span>
<span id="cb36-84"><a href="#cb36-84" tabindex="-1"></a><span class="kw">var</span> date_start <span class="op">=</span> <span class="st">&#39;2015-01-01&#39;</span><span class="op">;</span></span>
<span id="cb36-85"><a href="#cb36-85" tabindex="-1"></a><span class="kw">var</span> date_end <span class="op">=</span> <span class="st">&#39;2016-01-01&#39;</span><span class="op">;</span></span>
<span id="cb36-86"><a href="#cb36-86" tabindex="-1"></a></span>
<span id="cb36-87"><a href="#cb36-87" tabindex="-1"></a><span class="kw">var</span> dataset <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&#39;LANDSAT/LC08/C02/T1_L2&#39;</span>)</span>
<span id="cb36-88"><a href="#cb36-88" tabindex="-1"></a>    <span class="op">.</span><span class="fu">filterDate</span>(date_start<span class="op">,</span> date_end)</span>
<span id="cb36-89"><a href="#cb36-89" tabindex="-1"></a>    <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">bounds</span>(geometry))</span>
<span id="cb36-90"><a href="#cb36-90" tabindex="-1"></a>    </span>
<span id="cb36-91"><a href="#cb36-91" tabindex="-1"></a><span class="kw">function</span> <span class="fu">maskL8sr</span>(image) {</span>
<span id="cb36-92"><a href="#cb36-92" tabindex="-1"></a>  <span class="co">// Bit 0 - Fill</span></span>
<span id="cb36-93"><a href="#cb36-93" tabindex="-1"></a>  <span class="co">// Bit 1 - Dilated Cloud</span></span>
<span id="cb36-94"><a href="#cb36-94" tabindex="-1"></a>  <span class="co">// Bit 2 - Cirrus</span></span>
<span id="cb36-95"><a href="#cb36-95" tabindex="-1"></a>  <span class="co">// Bit 3 - Cloud</span></span>
<span id="cb36-96"><a href="#cb36-96" tabindex="-1"></a>  <span class="co">// Bit 4 - Cloud Shadow</span></span>
<span id="cb36-97"><a href="#cb36-97" tabindex="-1"></a>  <span class="kw">var</span> qaMask <span class="op">=</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;QA_PIXEL&#39;</span>)<span class="op">.</span><span class="fu">bitwiseAnd</span>(<span class="pp">parseInt</span>(<span class="st">&#39;11111&#39;</span><span class="op">,</span> <span class="dv">2</span>))<span class="op">.</span><span class="fu">eq</span>(<span class="dv">0</span>)<span class="op">;</span></span>
<span id="cb36-98"><a href="#cb36-98" tabindex="-1"></a>  <span class="kw">var</span> saturationMask <span class="op">=</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;QA_RADSAT&#39;</span>)<span class="op">.</span><span class="fu">eq</span>(<span class="dv">0</span>)<span class="op">;</span></span>
<span id="cb36-99"><a href="#cb36-99" tabindex="-1"></a></span>
<span id="cb36-100"><a href="#cb36-100" tabindex="-1"></a>  <span class="co">// Apply the scaling factors to the appropriate bands.</span></span>
<span id="cb36-101"><a href="#cb36-101" tabindex="-1"></a>  <span class="kw">var</span> opticalBands <span class="op">=</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;SR_B.&#39;</span>)<span class="op">.</span><span class="fu">multiply</span>(<span class="fl">0.0000275</span>)<span class="op">.</span><span class="fu">add</span>(<span class="op">-</span><span class="fl">0.2</span>)<span class="op">;</span></span>
<span id="cb36-102"><a href="#cb36-102" tabindex="-1"></a>  <span class="kw">var</span> thermalBands <span class="op">=</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;ST_B.*&#39;</span>)<span class="op">.</span><span class="fu">multiply</span>(<span class="fl">0.00341802</span>)<span class="op">.</span><span class="fu">add</span>(<span class="fl">149.0</span>)<span class="op">;</span></span>
<span id="cb36-103"><a href="#cb36-103" tabindex="-1"></a></span>
<span id="cb36-104"><a href="#cb36-104" tabindex="-1"></a>  <span class="co">// Replace the original bands with the scaled ones and apply the masks.</span></span>
<span id="cb36-105"><a href="#cb36-105" tabindex="-1"></a>  <span class="cf">return</span> image<span class="op">.</span><span class="fu">addBands</span>(opticalBands<span class="op">,</span> <span class="kw">null</span><span class="op">,</span> <span class="kw">true</span>)</span>
<span id="cb36-106"><a href="#cb36-106" tabindex="-1"></a>      <span class="op">.</span><span class="fu">addBands</span>(thermalBands<span class="op">,</span> <span class="kw">null</span><span class="op">,</span> <span class="kw">true</span>)</span>
<span id="cb36-107"><a href="#cb36-107" tabindex="-1"></a>      <span class="op">.</span><span class="fu">updateMask</span>(qaMask)</span>
<span id="cb36-108"><a href="#cb36-108" tabindex="-1"></a>      <span class="op">.</span><span class="fu">updateMask</span>(saturationMask)<span class="op">;</span></span>
<span id="cb36-109"><a href="#cb36-109" tabindex="-1"></a>}</span>
<span id="cb36-110"><a href="#cb36-110" tabindex="-1"></a></span>
<span id="cb36-111"><a href="#cb36-111" tabindex="-1"></a></span>
<span id="cb36-112"><a href="#cb36-112" tabindex="-1"></a>dataset <span class="op">=</span> dataset<span class="op">.</span><span class="fu">map</span>(maskL8sr)<span class="op">;</span></span>
<span id="cb36-113"><a href="#cb36-113" tabindex="-1"></a></span>
<span id="cb36-114"><a href="#cb36-114" tabindex="-1"></a><span class="co">// Select B10 band and rename it to LST</span></span>
<span id="cb36-115"><a href="#cb36-115" tabindex="-1"></a><span class="kw">var</span> lstK <span class="op">=</span> dataset<span class="op">.</span><span class="fu">select</span>([<span class="st">&#39;ST_B10&#39;</span>]<span class="op">,</span> [<span class="st">&#39;LST&#39;</span>])<span class="op">;</span></span>
<span id="cb36-116"><a href="#cb36-116" tabindex="-1"></a></span>
<span id="cb36-117"><a href="#cb36-117" tabindex="-1"></a><span class="co">// Convert to celsius</span></span>
<span id="cb36-118"><a href="#cb36-118" tabindex="-1"></a><span class="kw">var</span> lstC <span class="op">=</span> lstK<span class="op">.</span><span class="fu">map</span>(<span class="kw">function</span>(image){</span>
<span id="cb36-119"><a href="#cb36-119" tabindex="-1"></a>  <span class="cf">return</span> image<span class="op">.</span><span class="fu">subtract</span>(<span class="fl">273.15</span>)<span class="op">.</span><span class="fu">copyProperties</span>(image<span class="op">,</span> image<span class="op">.</span><span class="fu">propertyNames</span>())<span class="op">;</span></span>
<span id="cb36-120"><a href="#cb36-120" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb36-121"><a href="#cb36-121" tabindex="-1"></a></span>
<span id="cb36-122"><a href="#cb36-122" tabindex="-1"></a></span>
<span id="cb36-123"><a href="#cb36-123" tabindex="-1"></a><span class="co">// Filter to May month image to visualize in map. </span></span>
<span id="cb36-124"><a href="#cb36-124" tabindex="-1"></a><span class="kw">var</span> lstMay  <span class="op">=</span> lstC</span>
<span id="cb36-125"><a href="#cb36-125" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(<span class="st">&#39;2015-04-01&#39;</span><span class="op">,</span> <span class="st">&#39;2015-05-01&#39;</span>))<span class="op">.</span><span class="fu">mean</span>()<span class="op">;</span></span>
<span id="cb36-126"><a href="#cb36-126" tabindex="-1"></a></span>
<span id="cb36-127"><a href="#cb36-127" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(lstMay<span class="op">.</span><span class="fu">clip</span>(geometry)<span class="op">,</span></span>
<span id="cb36-128"><a href="#cb36-128" tabindex="-1"></a>  {<span class="dt">min</span><span class="op">:</span><span class="dv">25</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span><span class="dv">45</span><span class="op">,</span> <span class="dt">palette</span><span class="op">:</span>[<span class="st">&#39;green&#39;</span><span class="op">,</span><span class="st">&#39;yellow&#39;</span><span class="op">,</span><span class="st">&#39;red&#39;</span>]}<span class="op">,</span></span>
<span id="cb36-129"><a href="#cb36-129" tabindex="-1"></a>  <span class="st">&#39;Landsat-LST (Landsat Collection 2)&#39;</span>)<span class="op">;</span></span>
<span id="cb36-130"><a href="#cb36-130" tabindex="-1"></a></span>
<span id="cb36-131"><a href="#cb36-131" tabindex="-1"></a><span class="co">// Create the LSt time series chart. </span></span>
<span id="cb36-132"><a href="#cb36-132" tabindex="-1"></a><span class="kw">var</span> chart <span class="op">=</span> ui<span class="op">.</span><span class="at">Chart</span><span class="op">.</span><span class="at">image</span><span class="op">.</span><span class="fu">seriesByRegion</span>({</span>
<span id="cb36-133"><a href="#cb36-133" tabindex="-1"></a>  <span class="dt">imageCollection</span><span class="op">:</span>lstC<span class="op">,</span>  </span>
<span id="cb36-134"><a href="#cb36-134" tabindex="-1"></a>  <span class="dt">regions</span><span class="op">:</span> [airport<span class="op">,</span> metalroof<span class="op">,</span> concreteroof<span class="op">,</span> mangrove<span class="op">,</span> water]<span class="op">,</span></span>
<span id="cb36-135"><a href="#cb36-135" tabindex="-1"></a>  <span class="dt">reducer</span><span class="op">:</span>ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">mean</span>()<span class="op">,</span></span>
<span id="cb36-136"><a href="#cb36-136" tabindex="-1"></a>  <span class="dt">band</span><span class="op">:</span>[<span class="st">&#39;LST&#39;</span>]<span class="op">,</span></span>
<span id="cb36-137"><a href="#cb36-137" tabindex="-1"></a>  <span class="dt">scale</span><span class="op">:</span><span class="dv">30</span><span class="op">,</span>  </span>
<span id="cb36-138"><a href="#cb36-138" tabindex="-1"></a>  <span class="dt">xProperty</span><span class="op">:</span><span class="st">&#39;system:time_start&#39;</span><span class="op">,</span></span>
<span id="cb36-139"><a href="#cb36-139" tabindex="-1"></a>})<span class="op">.</span><span class="fu">setOptions</span>({</span>
<span id="cb36-140"><a href="#cb36-140" tabindex="-1"></a>      <span class="dt">lineWidth</span><span class="op">:</span> <span class="dv">1</span><span class="op">,</span></span>
<span id="cb36-141"><a href="#cb36-141" tabindex="-1"></a>      <span class="dt">title</span><span class="op">:</span> <span class="st">&#39;Land Surface Temperature Time-Series (Landsat Collection 2)&#39;</span><span class="op">,</span></span>
<span id="cb36-142"><a href="#cb36-142" tabindex="-1"></a>      <span class="dt">interpolateNulls</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb36-143"><a href="#cb36-143" tabindex="-1"></a>      <span class="dt">viewWindowMode</span><span class="op">:</span><span class="st">&#39;explicit&#39;</span><span class="op">,</span></span>
<span id="cb36-144"><a href="#cb36-144" tabindex="-1"></a>        <span class="dt">viewWindow</span><span class="op">:</span> {</span>
<span id="cb36-145"><a href="#cb36-145" tabindex="-1"></a>            <span class="dt">max</span><span class="op">:</span><span class="dv">50</span><span class="op">,</span></span>
<span id="cb36-146"><a href="#cb36-146" tabindex="-1"></a>            <span class="dt">min</span><span class="op">:</span><span class="dv">25</span></span>
<span id="cb36-147"><a href="#cb36-147" tabindex="-1"></a>        }<span class="op">,</span></span>
<span id="cb36-148"><a href="#cb36-148" tabindex="-1"></a>      <span class="dt">vAxis</span><span class="op">:</span> {<span class="dt">title</span><span class="op">:</span> <span class="st">&#39;LST (°C)&#39;</span>}<span class="op">,</span></span>
<span id="cb36-149"><a href="#cb36-149" tabindex="-1"></a>      <span class="dt">hAxis</span><span class="op">:</span> {<span class="dt">title</span><span class="op">:</span> <span class="st">&#39;&#39;</span><span class="op">,</span> <span class="dt">format</span><span class="op">:</span> <span class="st">&#39;YYYY-MMM&#39;</span>}<span class="op">,</span></span>
<span id="cb36-150"><a href="#cb36-150" tabindex="-1"></a>      <span class="dt">series</span><span class="op">:</span> {</span>
<span id="cb36-151"><a href="#cb36-151" tabindex="-1"></a>      <span class="dv">0</span><span class="op">:</span> {<span class="dt">color</span><span class="op">:</span> <span class="st">&#39;red&#39;</span><span class="op">,</span> <span class="dt">labelInLegend</span><span class="op">:</span> <span class="st">&#39;Airport Tarmac&#39;</span>}<span class="op">,</span> </span>
<span id="cb36-152"><a href="#cb36-152" tabindex="-1"></a>      <span class="dv">1</span><span class="op">:</span> {<span class="dt">color</span><span class="op">:</span> <span class="st">&#39;pink&#39;</span><span class="op">,</span> <span class="dt">labelInLegend</span><span class="op">:</span> <span class="st">&#39;Residential-Slum (Metal Roof)&#39;</span>}<span class="op">,</span> </span>
<span id="cb36-153"><a href="#cb36-153" tabindex="-1"></a>      <span class="dv">2</span><span class="op">:</span> {<span class="dt">color</span><span class="op">:</span> <span class="st">&#39;grey&#39;</span><span class="op">,</span> <span class="dt">labelInLegend</span><span class="op">:</span> <span class="st">&#39;Residential (Concrete Roof)&#39;</span>}<span class="op">,</span></span>
<span id="cb36-154"><a href="#cb36-154" tabindex="-1"></a>      <span class="dv">3</span><span class="op">:</span> {<span class="dt">color</span><span class="op">:</span> <span class="st">&#39;green&#39;</span><span class="op">,</span> <span class="dt">labelInLegend</span><span class="op">:</span> <span class="st">&#39;Mangrove&#39;</span>}<span class="op">,</span></span>
<span id="cb36-155"><a href="#cb36-155" tabindex="-1"></a>      <span class="dv">4</span><span class="op">:</span> {<span class="dt">color</span><span class="op">:</span> <span class="st">&#39;blue&#39;</span><span class="op">,</span> <span class="dt">labelInLegend</span><span class="op">:</span> <span class="st">&#39;Water&#39;</span>}</span>
<span id="cb36-156"><a href="#cb36-156" tabindex="-1"></a>    } </span>
<span id="cb36-157"><a href="#cb36-157" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb36-158"><a href="#cb36-158" tabindex="-1"></a>  </span>
<span id="cb36-159"><a href="#cb36-159" tabindex="-1"></a><span class="fu">print</span>(chart)<span class="op">;</span></span></code></pre></div>
</div>
<div id="gap-filling-of-landsat-7-slc-off-images"
class="section level2">
<h2>Gap-filling of Landsat 7 SLC-Off Images</h2>
<p>The Scan Line Corrector (SLC) failed on the Landsat 7 ETM+ sensor in
May 2003, resulting in wedge-shaped scan line gaps. USGS has developed
and published a <a
href="https://www.usgs.gov/media/files/landsat-7-slc-gap-filled-products-phase-two-methodology">methodology</a>
to fill these scan lines using a linear regression over a moving window.
A simpler-version of this algorithm has been adapted for Google Earth
Engine and provided here.</p>
<p><img src="images/end_to_end_gee/l7_gapfill.png" width="100%" style="display: block; margin: auto;" /></p>
<p><a
href="https://code.earthengine.google.co.in/?scriptPath=users%2Fujavalgandhi%2FEnd-to-End-GEE%3ASupplement%2FImage_Processing%2FLandsat7_Gapfilling"
target="_blank">Open in Code Editor ↗</a></p>
<div class="sourceCode" id="cb37"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb37-1"><a href="#cb37-1" tabindex="-1"></a><span class="co">// Example code for filling landsat 7 SLC-off gap-filling</span></span>
<span id="cb37-2"><a href="#cb37-2" tabindex="-1"></a><span class="co">// This code is based on Landsat 7 SLC-off Gap-Filled Products Phase Two Methodology</span></span>
<span id="cb37-3"><a href="#cb37-3" tabindex="-1"></a><span class="co">// https://www.usgs.gov/media/files/landsat-7-slc-gap-filled-products-phase-two-methodology</span></span>
<span id="cb37-4"><a href="#cb37-4" tabindex="-1"></a><span class="co">// Adapted from original implementation by Noel Gorelick</span></span>
<span id="cb37-5"><a href="#cb37-5" tabindex="-1"></a><span class="kw">var</span> L7 <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&#39;LANDSAT/LE07/C02/T1_L2&#39;</span>)<span class="op">;</span></span>
<span id="cb37-6"><a href="#cb37-6" tabindex="-1"></a></span>
<span id="cb37-7"><a href="#cb37-7" tabindex="-1"></a><span class="kw">var</span> l7Bands <span class="op">=</span> [<span class="st">&#39;SR_B1&#39;</span><span class="op">,</span><span class="st">&#39;SR_B2&#39;</span><span class="op">,</span><span class="st">&#39;SR_B3&#39;</span><span class="op">,</span><span class="st">&#39;SR_B4&#39;</span><span class="op">,</span><span class="st">&#39;SR_B5&#39;</span><span class="op">,</span><span class="st">&#39;SR_B7&#39;</span>]<span class="op">;</span></span>
<span id="cb37-8"><a href="#cb37-8" tabindex="-1"></a><span class="kw">var</span> l7names <span class="op">=</span> [<span class="st">&#39;blue&#39;</span><span class="op">,</span><span class="st">&#39;green&#39;</span><span class="op">,</span><span class="st">&#39;red&#39;</span><span class="op">,</span><span class="st">&#39;nir&#39;</span><span class="op">,</span><span class="st">&#39;swir1&#39;</span><span class="op">,</span><span class="st">&#39;swir2&#39;</span>]<span class="op">;</span></span>
<span id="cb37-9"><a href="#cb37-9" tabindex="-1"></a></span>
<span id="cb37-10"><a href="#cb37-10" tabindex="-1"></a><span class="co">// Cloud masking function for Landsat 4,5 and 7</span></span>
<span id="cb37-11"><a href="#cb37-11" tabindex="-1"></a><span class="kw">function</span> <span class="fu">maskL457sr</span>(image) {</span>
<span id="cb37-12"><a href="#cb37-12" tabindex="-1"></a>  <span class="kw">var</span> qaMask <span class="op">=</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;QA_PIXEL&#39;</span>)<span class="op">.</span><span class="fu">bitwiseAnd</span>(<span class="pp">parseInt</span>(<span class="st">&#39;11111&#39;</span><span class="op">,</span> <span class="dv">2</span>))<span class="op">.</span><span class="fu">eq</span>(<span class="dv">0</span>)<span class="op">;</span></span>
<span id="cb37-13"><a href="#cb37-13" tabindex="-1"></a>  <span class="kw">var</span> saturationMask <span class="op">=</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;QA_RADSAT&#39;</span>)<span class="op">.</span><span class="fu">eq</span>(<span class="dv">0</span>)<span class="op">;</span></span>
<span id="cb37-14"><a href="#cb37-14" tabindex="-1"></a></span>
<span id="cb37-15"><a href="#cb37-15" tabindex="-1"></a>  <span class="co">// Apply the scaling factors to the appropriate bands.</span></span>
<span id="cb37-16"><a href="#cb37-16" tabindex="-1"></a>  <span class="kw">var</span> opticalBands <span class="op">=</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;SR_B.&#39;</span>)<span class="op">.</span><span class="fu">multiply</span>(<span class="fl">0.0000275</span>)<span class="op">.</span><span class="fu">add</span>(<span class="op">-</span><span class="fl">0.2</span>)<span class="op">;</span></span>
<span id="cb37-17"><a href="#cb37-17" tabindex="-1"></a>  <span class="kw">var</span> thermalBand <span class="op">=</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;ST_B6&#39;</span>)<span class="op">.</span><span class="fu">multiply</span>(<span class="fl">0.00341802</span>)<span class="op">.</span><span class="fu">add</span>(<span class="fl">149.0</span>)<span class="op">;</span></span>
<span id="cb37-18"><a href="#cb37-18" tabindex="-1"></a></span>
<span id="cb37-19"><a href="#cb37-19" tabindex="-1"></a>  <span class="co">// Replace the original bands with the scaled ones and apply the masks.</span></span>
<span id="cb37-20"><a href="#cb37-20" tabindex="-1"></a>  <span class="cf">return</span> image<span class="op">.</span><span class="fu">addBands</span>(opticalBands<span class="op">,</span> <span class="kw">null</span><span class="op">,</span> <span class="kw">true</span>)</span>
<span id="cb37-21"><a href="#cb37-21" tabindex="-1"></a>      <span class="op">.</span><span class="fu">addBands</span>(thermalBand<span class="op">,</span> <span class="kw">null</span><span class="op">,</span> <span class="kw">true</span>)</span>
<span id="cb37-22"><a href="#cb37-22" tabindex="-1"></a>      <span class="op">.</span><span class="fu">updateMask</span>(qaMask)</span>
<span id="cb37-23"><a href="#cb37-23" tabindex="-1"></a>      <span class="op">.</span><span class="fu">updateMask</span>(saturationMask)</span>
<span id="cb37-24"><a href="#cb37-24" tabindex="-1"></a>      <span class="op">.</span><span class="fu">copyProperties</span>(image<span class="op">,</span> [<span class="st">&#39;system:time_start&#39;</span>])<span class="op">;</span></span>
<span id="cb37-25"><a href="#cb37-25" tabindex="-1"></a>}</span>
<span id="cb37-26"><a href="#cb37-26" tabindex="-1"></a></span>
<span id="cb37-27"><a href="#cb37-27" tabindex="-1"></a><span class="co">// Prepare the full L7 collection</span></span>
<span id="cb37-28"><a href="#cb37-28" tabindex="-1"></a><span class="kw">var</span> L7 <span class="op">=</span> L7</span>
<span id="cb37-29"><a href="#cb37-29" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(<span class="st">&#39;1984-01-01&#39;</span><span class="op">,</span> <span class="st">&#39;2017-01-01&#39;</span>))</span>
<span id="cb37-30"><a href="#cb37-30" tabindex="-1"></a>  <span class="op">.</span><span class="fu">map</span>(maskL457sr)</span>
<span id="cb37-31"><a href="#cb37-31" tabindex="-1"></a>  <span class="op">.</span><span class="fu">select</span>(l7Bands<span class="op">,</span>l7names)<span class="op">;</span></span>
<span id="cb37-32"><a href="#cb37-32" tabindex="-1"></a></span>
<span id="cb37-33"><a href="#cb37-33" tabindex="-1"></a></span>
<span id="cb37-34"><a href="#cb37-34" tabindex="-1"></a><span class="co">// #####################################################</span></span>
<span id="cb37-35"><a href="#cb37-35" tabindex="-1"></a><span class="co">// Gap-filling Function</span></span>
<span id="cb37-36"><a href="#cb37-36" tabindex="-1"></a><span class="co">// #####################################################</span></span>
<span id="cb37-37"><a href="#cb37-37" tabindex="-1"></a></span>
<span id="cb37-38"><a href="#cb37-38" tabindex="-1"></a><span class="kw">var</span> gapFill <span class="op">=</span> <span class="kw">function</span>(image) {</span>
<span id="cb37-39"><a href="#cb37-39" tabindex="-1"></a>  <span class="co">// We need a reference &#39;fill&#39; image without gaps or clouds</span></span>
<span id="cb37-40"><a href="#cb37-40" tabindex="-1"></a>  <span class="co">// that will be used to derive missing pixels</span></span>
<span id="cb37-41"><a href="#cb37-41" tabindex="-1"></a>  <span class="co">// Here we use a median composite created from images</span></span>
<span id="cb37-42"><a href="#cb37-42" tabindex="-1"></a>  <span class="co">// from a 6-month period around from each image date</span></span>
<span id="cb37-43"><a href="#cb37-43" tabindex="-1"></a>  <span class="co">// You may adjust this to shorter/longer period</span></span>
<span id="cb37-44"><a href="#cb37-44" tabindex="-1"></a>  <span class="kw">var</span> start <span class="op">=</span> image<span class="op">.</span><span class="fu">date</span>()<span class="op">.</span><span class="fu">advance</span>(<span class="op">-</span><span class="dv">3</span><span class="op">,</span> <span class="st">&#39;month&#39;</span>)<span class="op">;</span></span>
<span id="cb37-45"><a href="#cb37-45" tabindex="-1"></a>  <span class="kw">var</span> end <span class="op">=</span> image<span class="op">.</span><span class="fu">date</span>()<span class="op">.</span><span class="fu">advance</span>(<span class="dv">3</span><span class="op">,</span> <span class="st">&#39;month&#39;</span>)<span class="op">;</span></span>
<span id="cb37-46"><a href="#cb37-46" tabindex="-1"></a>  <span class="co">// Create a gap-free version as the target image</span></span>
<span id="cb37-47"><a href="#cb37-47" tabindex="-1"></a>  <span class="kw">var</span> fill <span class="op">=</span> L7<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(start<span class="op">,</span> end))<span class="op">.</span><span class="fu">median</span>()<span class="op">;</span></span>
<span id="cb37-48"><a href="#cb37-48" tabindex="-1"></a>  <span class="kw">var</span> kernelSize <span class="op">=</span> <span class="dv">20</span><span class="op">;</span><span class="co">// Tried with 5, 10, 20, 30</span></span>
<span id="cb37-49"><a href="#cb37-49" tabindex="-1"></a>  <span class="kw">var</span> kernel <span class="op">=</span> ee<span class="op">.</span><span class="at">Kernel</span><span class="op">.</span><span class="fu">square</span>(kernelSize <span class="op">*</span> <span class="dv">30</span><span class="op">,</span> <span class="st">&#39;meters&#39;</span><span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span></span>
<span id="cb37-50"><a href="#cb37-50" tabindex="-1"></a>  <span class="kw">var</span> MIN_SCALE <span class="op">=</span> <span class="dv">1</span><span class="op">/</span><span class="dv">3</span><span class="op">;</span></span>
<span id="cb37-51"><a href="#cb37-51" tabindex="-1"></a>  <span class="kw">var</span> MAX_SCALE <span class="op">=</span> <span class="dv">3</span><span class="op">;</span></span>
<span id="cb37-52"><a href="#cb37-52" tabindex="-1"></a>  <span class="kw">var</span> MIN_NEIGHBORS <span class="op">=</span> <span class="dv">144</span><span class="op">;</span></span>
<span id="cb37-53"><a href="#cb37-53" tabindex="-1"></a>  </span>
<span id="cb37-54"><a href="#cb37-54" tabindex="-1"></a>  <span class="co">// Find the pixels common to both scenes.</span></span>
<span id="cb37-55"><a href="#cb37-55" tabindex="-1"></a>  <span class="kw">var</span> common <span class="op">=</span> image<span class="op">.</span><span class="fu">mask</span>()<span class="op">.</span><span class="fu">and</span>(fill<span class="op">.</span><span class="fu">mask</span>())<span class="op">;</span></span>
<span id="cb37-56"><a href="#cb37-56" tabindex="-1"></a>  <span class="kw">var</span> fc <span class="op">=</span> fill<span class="op">.</span><span class="fu">updateMask</span>(common)<span class="op">;</span></span>
<span id="cb37-57"><a href="#cb37-57" tabindex="-1"></a>  <span class="kw">var</span> sc <span class="op">=</span> image<span class="op">.</span><span class="fu">updateMask</span>(common)<span class="op">;</span></span>
<span id="cb37-58"><a href="#cb37-58" tabindex="-1"></a></span>
<span id="cb37-59"><a href="#cb37-59" tabindex="-1"></a>  <span class="co">// Find the primary scaling factors with a regression.</span></span>
<span id="cb37-60"><a href="#cb37-60" tabindex="-1"></a>  <span class="kw">var</span> regress <span class="op">=</span> fill<span class="op">.</span><span class="fu">addBands</span>(image)<span class="op">;</span> </span>
<span id="cb37-61"><a href="#cb37-61" tabindex="-1"></a>  regress <span class="op">=</span> regress<span class="op">.</span><span class="fu">select</span>(regress<span class="op">.</span><span class="fu">bandNames</span>()<span class="op">.</span><span class="fu">sort</span>())<span class="op">;</span></span>
<span id="cb37-62"><a href="#cb37-62" tabindex="-1"></a>  <span class="kw">var</span> fit <span class="op">=</span> regress<span class="op">.</span><span class="fu">reduceNeighborhood</span>(</span>
<span id="cb37-63"><a href="#cb37-63" tabindex="-1"></a>    ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">linearFit</span>()<span class="op">.</span><span class="fu">forEach</span>(image<span class="op">.</span><span class="fu">bandNames</span>())<span class="op">,</span>  kernel<span class="op">,</span> <span class="kw">null</span><span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span></span>
<span id="cb37-64"><a href="#cb37-64" tabindex="-1"></a>  <span class="kw">var</span> offset <span class="op">=</span> fit<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;.*_offset&#39;</span>)<span class="op">;</span></span>
<span id="cb37-65"><a href="#cb37-65" tabindex="-1"></a>  <span class="kw">var</span> scale <span class="op">=</span> fit<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;.*_scale&#39;</span>)<span class="op">;</span></span>
<span id="cb37-66"><a href="#cb37-66" tabindex="-1"></a></span>
<span id="cb37-67"><a href="#cb37-67" tabindex="-1"></a>  <span class="co">// Find the secondary scaling factors using just means and stddev</span></span>
<span id="cb37-68"><a href="#cb37-68" tabindex="-1"></a>  <span class="kw">var</span> reducer <span class="op">=</span> ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">mean</span>()<span class="op">.</span><span class="fu">combine</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">stdDev</span>()<span class="op">,</span> <span class="kw">null</span><span class="op">,</span> <span class="kw">true</span>)<span class="op">;</span></span>
<span id="cb37-69"><a href="#cb37-69" tabindex="-1"></a>  <span class="kw">var</span> src_stats <span class="op">=</span> image<span class="op">.</span><span class="fu">reduceNeighborhood</span>(reducer<span class="op">,</span> kernel<span class="op">,</span> <span class="kw">null</span><span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span></span>
<span id="cb37-70"><a href="#cb37-70" tabindex="-1"></a>  <span class="kw">var</span> fill_stats <span class="op">=</span> fill<span class="op">.</span><span class="fu">reduceNeighborhood</span>(reducer<span class="op">,</span> kernel<span class="op">,</span> <span class="kw">null</span><span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span></span>
<span id="cb37-71"><a href="#cb37-71" tabindex="-1"></a>  <span class="kw">var</span> scale2 <span class="op">=</span> src_stats<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;.*stdDev&#39;</span>)</span>
<span id="cb37-72"><a href="#cb37-72" tabindex="-1"></a>    <span class="op">.</span><span class="fu">divide</span>(fill_stats<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;.*stdDev&#39;</span>))<span class="op">;</span></span>
<span id="cb37-73"><a href="#cb37-73" tabindex="-1"></a>  <span class="kw">var</span> offset2 <span class="op">=</span> src_stats<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;.*mean&#39;</span>)</span>
<span id="cb37-74"><a href="#cb37-74" tabindex="-1"></a>    <span class="op">.</span><span class="fu">subtract</span>(fill_stats<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;.*mean&#39;</span>)<span class="op">.</span><span class="fu">multiply</span>(scale2))<span class="op">;</span></span>
<span id="cb37-75"><a href="#cb37-75" tabindex="-1"></a></span>
<span id="cb37-76"><a href="#cb37-76" tabindex="-1"></a>  <span class="kw">var</span> invalid <span class="op">=</span> scale<span class="op">.</span><span class="fu">lt</span>(MIN_SCALE)<span class="op">.</span><span class="fu">or</span>(scale<span class="op">.</span><span class="fu">gt</span>(MAX_SCALE))<span class="op">;</span></span>
<span id="cb37-77"><a href="#cb37-77" tabindex="-1"></a>  scale <span class="op">=</span> scale<span class="op">.</span><span class="fu">where</span>(invalid<span class="op">,</span> scale2)<span class="op">;</span></span>
<span id="cb37-78"><a href="#cb37-78" tabindex="-1"></a>  offset <span class="op">=</span> offset<span class="op">.</span><span class="fu">where</span>(invalid<span class="op">,</span> offset2)<span class="op">;</span></span>
<span id="cb37-79"><a href="#cb37-79" tabindex="-1"></a></span>
<span id="cb37-80"><a href="#cb37-80" tabindex="-1"></a>  <span class="co">// When all else fails, just use the difference of means as an offset.  </span></span>
<span id="cb37-81"><a href="#cb37-81" tabindex="-1"></a>  <span class="kw">var</span> invalid2 <span class="op">=</span> scale<span class="op">.</span><span class="fu">lt</span>(MIN_SCALE)<span class="op">.</span><span class="fu">or</span>(scale<span class="op">.</span><span class="fu">gt</span>(MAX_SCALE))<span class="op">;</span></span>
<span id="cb37-82"><a href="#cb37-82" tabindex="-1"></a>  scale <span class="op">=</span> scale<span class="op">.</span><span class="fu">where</span>(invalid2<span class="op">,</span> <span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb37-83"><a href="#cb37-83" tabindex="-1"></a>  offset <span class="op">=</span> offset<span class="op">.</span><span class="fu">where</span>(invalid2<span class="op">,</span> src_stats<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;.*mean&#39;</span>)</span>
<span id="cb37-84"><a href="#cb37-84" tabindex="-1"></a>    <span class="op">.</span><span class="fu">subtract</span>(fill_stats<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;.*mean&#39;</span>)))<span class="op">;</span></span>
<span id="cb37-85"><a href="#cb37-85" tabindex="-1"></a></span>
<span id="cb37-86"><a href="#cb37-86" tabindex="-1"></a>  <span class="co">// Apply the scaling and mask off pixels that didn&#39;t have enough neighbors.</span></span>
<span id="cb37-87"><a href="#cb37-87" tabindex="-1"></a>  <span class="kw">var</span> count <span class="op">=</span> common<span class="op">.</span><span class="fu">reduceNeighborhood</span>(</span>
<span id="cb37-88"><a href="#cb37-88" tabindex="-1"></a>    ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">count</span>()<span class="op">,</span> kernel<span class="op">,</span> <span class="kw">null</span><span class="op">,</span> <span class="kw">true</span><span class="op">,</span> <span class="st">&#39;boxcar&#39;</span>)<span class="op">;</span></span>
<span id="cb37-89"><a href="#cb37-89" tabindex="-1"></a>  <span class="kw">var</span> scaled <span class="op">=</span> fill<span class="op">.</span><span class="fu">multiply</span>(scale)<span class="op">.</span><span class="fu">add</span>(offset)</span>
<span id="cb37-90"><a href="#cb37-90" tabindex="-1"></a>      <span class="op">.</span><span class="fu">updateMask</span>(count<span class="op">.</span><span class="fu">gte</span>(MIN_NEIGHBORS))<span class="op">;</span></span>
<span id="cb37-91"><a href="#cb37-91" tabindex="-1"></a></span>
<span id="cb37-92"><a href="#cb37-92" tabindex="-1"></a>  <span class="cf">return</span> image<span class="op">.</span><span class="fu">unmask</span>(scaled<span class="op">,</span> <span class="kw">true</span>)<span class="op">;</span></span>
<span id="cb37-93"><a href="#cb37-93" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb37-94"><a href="#cb37-94" tabindex="-1"></a></span>
<span id="cb37-95"><a href="#cb37-95" tabindex="-1"></a></span>
<span id="cb37-96"><a href="#cb37-96" tabindex="-1"></a><span class="kw">var</span> bangalore <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">&#39;users/ujavalgandhi/public/bangalore_boundary&#39;</span>)<span class="op">;</span></span>
<span id="cb37-97"><a href="#cb37-97" tabindex="-1"></a><span class="kw">var</span> geometry <span class="op">=</span> bangalore<span class="op">.</span><span class="fu">geometry</span>()<span class="op">;</span></span>
<span id="cb37-98"><a href="#cb37-98" tabindex="-1"></a></span>
<span id="cb37-99"><a href="#cb37-99" tabindex="-1"></a><span class="kw">var</span> L7Filtered <span class="op">=</span> L7</span>
<span id="cb37-100"><a href="#cb37-100" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(<span class="st">&#39;2012-02-01&#39;</span><span class="op">,</span> <span class="st">&#39;2012-04-01&#39;</span>))</span>
<span id="cb37-101"><a href="#cb37-101" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">bounds</span>(geometry))<span class="op">;</span></span>
<span id="cb37-102"><a href="#cb37-102" tabindex="-1"></a></span>
<span id="cb37-103"><a href="#cb37-103" tabindex="-1"></a><span class="co">// Composite without gap-filling</span></span>
<span id="cb37-104"><a href="#cb37-104" tabindex="-1"></a><span class="kw">var</span> composite <span class="op">=</span> L7Filtered<span class="op">.</span><span class="fu">median</span>()<span class="op">;</span></span>
<span id="cb37-105"><a href="#cb37-105" tabindex="-1"></a></span>
<span id="cb37-106"><a href="#cb37-106" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">centerObject</span>(geometry<span class="op">,</span> <span class="dv">11</span>)<span class="op">;</span></span>
<span id="cb37-107"><a href="#cb37-107" tabindex="-1"></a><span class="kw">var</span> visParams <span class="op">=</span> {<span class="dt">bands</span><span class="op">:</span> [<span class="st">&#39;red&#39;</span><span class="op">,</span> <span class="st">&#39;green&#39;</span><span class="op">,</span> <span class="st">&#39;blue&#39;</span>]<span class="op">,</span> <span class="dt">min</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span> <span class="fl">0.3</span>}<span class="op">;</span></span>
<span id="cb37-108"><a href="#cb37-108" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(composite<span class="op">.</span><span class="fu">clip</span>(geometry)<span class="op">,</span> visParams<span class="op">,</span> <span class="st">&#39;Original Image&#39;</span>)<span class="op">;</span></span>
<span id="cb37-109"><a href="#cb37-109" tabindex="-1"></a></span>
<span id="cb37-110"><a href="#cb37-110" tabindex="-1"></a><span class="co">// Apply Gap-filling</span></span>
<span id="cb37-111"><a href="#cb37-111" tabindex="-1"></a><span class="kw">var</span> L7GapFilled <span class="op">=</span> L7Filtered<span class="op">.</span><span class="fu">map</span>(gapFill)<span class="op">;</span></span>
<span id="cb37-112"><a href="#cb37-112" tabindex="-1"></a><span class="kw">var</span> compositeGapFill <span class="op">=</span> L7GapFilled<span class="op">.</span><span class="fu">median</span>()<span class="op">;</span></span>
<span id="cb37-113"><a href="#cb37-113" tabindex="-1"></a></span>
<span id="cb37-114"><a href="#cb37-114" tabindex="-1"></a><span class="co">// Gap-filling is a computationally expensive operation</span></span>
<span id="cb37-115"><a href="#cb37-115" tabindex="-1"></a><span class="co">// so it cannot be visualized interactively</span></span>
<span id="cb37-116"><a href="#cb37-116" tabindex="-1"></a><span class="co">// Export the results and import the asset to visualize</span></span>
<span id="cb37-117"><a href="#cb37-117" tabindex="-1"></a></span>
<span id="cb37-118"><a href="#cb37-118" tabindex="-1"></a><span class="co">// Change the asset id to your own asset path</span></span>
<span id="cb37-119"><a href="#cb37-119" tabindex="-1"></a><span class="kw">var</span> assetId <span class="op">=</span> <span class="st">&#39;users/ujavalgandhi/e2e/l7_gapfilled&#39;</span><span class="op">;</span></span>
<span id="cb37-120"><a href="#cb37-120" tabindex="-1"></a></span>
<span id="cb37-121"><a href="#cb37-121" tabindex="-1"></a>Export<span class="op">.</span><span class="at">image</span><span class="op">.</span><span class="fu">toAsset</span>({</span>
<span id="cb37-122"><a href="#cb37-122" tabindex="-1"></a>  <span class="dt">image</span><span class="op">:</span> compositeGapFill<span class="op">.</span><span class="fu">clip</span>(geometry)<span class="op">,</span></span>
<span id="cb37-123"><a href="#cb37-123" tabindex="-1"></a>  <span class="dt">description</span><span class="op">:</span> <span class="st">&#39;L7_Gapfill_Export&#39;</span><span class="op">,</span></span>
<span id="cb37-124"><a href="#cb37-124" tabindex="-1"></a>  <span class="dt">assetId</span><span class="op">:</span> assetId<span class="op">,</span></span>
<span id="cb37-125"><a href="#cb37-125" tabindex="-1"></a>  <span class="dt">region</span><span class="op">:</span> geometry<span class="op">,</span></span>
<span id="cb37-126"><a href="#cb37-126" tabindex="-1"></a>  <span class="dt">scale</span><span class="op">:</span><span class="dv">30</span><span class="op">,</span></span>
<span id="cb37-127"><a href="#cb37-127" tabindex="-1"></a>  <span class="dt">maxPixels</span><span class="op">:</span> <span class="fl">1e10</span></span>
<span id="cb37-128"><a href="#cb37-128" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb37-129"><a href="#cb37-129" tabindex="-1"></a></span>
<span id="cb37-130"><a href="#cb37-130" tabindex="-1"></a><span class="co">// Wait for the export to finish and then uncomment</span></span>
<span id="cb37-131"><a href="#cb37-131" tabindex="-1"></a><span class="co">// the below lines to see exported results</span></span>
<span id="cb37-132"><a href="#cb37-132" tabindex="-1"></a></span>
<span id="cb37-133"><a href="#cb37-133" tabindex="-1"></a><span class="co">// var exportedGapFilledImage = ee.Image(assetId);</span></span>
<span id="cb37-134"><a href="#cb37-134" tabindex="-1"></a><span class="co">// Map.addLayer(exportedGapFilledImage.clip(geometry), visParams, &#39;Gap-Filled Image&#39;);</span></span></code></pre></div>
</div>
</div>
<div id="user-interface-templates" class="section level1">
<h1>User Interface Templates</h1>
<div id="adding-a-discrete-legend" class="section level2">
<h2>Adding a Discrete Legend</h2>
<p>You may want to add a legend for a classified image to your map
visualization in your App. Here’s a code snippet that shows how you can
build it using the UI Widgets.</p>
<div class="figure" style="text-align: center">
<img src="images/end_to_end_gee/map_legend.png" alt="Creating a Discrete Map Legend" width="100%" />
<p class="caption">
Creating a Discrete Map Legend
</p>
</div>
<p><a
href="https://code.earthengine.google.co.in/?scriptPath=users%2Fujavalgandhi%2FEnd-to-End-GEE%3ASupplement%2FUI_Widgets_and_Apps%2FMap_Legend"
target="_blank">Open in Code Editor ↗</a></p>
<div class="sourceCode" id="cb38"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb38-1"><a href="#cb38-1" tabindex="-1"></a><span class="kw">var</span> classified <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(<span class="st">&quot;users/ujavalgandhi/e2e/bangalore_classified&quot;</span>)</span>
<span id="cb38-2"><a href="#cb38-2" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">centerObject</span>(classified)</span>
<span id="cb38-3"><a href="#cb38-3" tabindex="-1"></a><span class="kw">var</span> palette <span class="op">=</span> [<span class="st">&#39;#cc6d8f&#39;</span><span class="op">,</span> <span class="st">&#39;#ffc107&#39;</span><span class="op">,</span> <span class="st">&#39;#1e88e5&#39;</span><span class="op">,</span> <span class="st">&#39;#004d40&#39;</span>]<span class="op">;</span></span>
<span id="cb38-4"><a href="#cb38-4" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(classified<span class="op">,</span> {<span class="dt">min</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span> <span class="dv">3</span><span class="op">,</span> <span class="dt">palette</span><span class="op">:</span> palette}<span class="op">,</span> <span class="st">&#39;2019&#39;</span>)<span class="op">;</span></span>
<span id="cb38-5"><a href="#cb38-5" tabindex="-1"></a></span>
<span id="cb38-6"><a href="#cb38-6" tabindex="-1"></a><span class="kw">var</span> legend <span class="op">=</span> ui<span class="op">.</span><span class="fu">Panel</span>({<span class="dt">style</span><span class="op">:</span> {<span class="dt">position</span><span class="op">:</span> <span class="st">&#39;middle-right&#39;</span><span class="op">,</span> <span class="dt">padding</span><span class="op">:</span> <span class="st">&#39;8px 15px&#39;</span>}})<span class="op">;</span></span>
<span id="cb38-7"><a href="#cb38-7" tabindex="-1"></a></span>
<span id="cb38-8"><a href="#cb38-8" tabindex="-1"></a><span class="kw">var</span> makeRow <span class="op">=</span> <span class="kw">function</span>(color<span class="op">,</span> name) {</span>
<span id="cb38-9"><a href="#cb38-9" tabindex="-1"></a>  <span class="kw">var</span> colorBox <span class="op">=</span> ui<span class="op">.</span><span class="fu">Label</span>({</span>
<span id="cb38-10"><a href="#cb38-10" tabindex="-1"></a>    <span class="dt">style</span><span class="op">:</span> {<span class="dt">color</span><span class="op">:</span> <span class="st">&#39;#ffffff&#39;</span><span class="op">,</span></span>
<span id="cb38-11"><a href="#cb38-11" tabindex="-1"></a>      <span class="dt">backgroundColor</span><span class="op">:</span> color<span class="op">,</span></span>
<span id="cb38-12"><a href="#cb38-12" tabindex="-1"></a>      <span class="dt">padding</span><span class="op">:</span> <span class="st">&#39;10px&#39;</span><span class="op">,</span></span>
<span id="cb38-13"><a href="#cb38-13" tabindex="-1"></a>      <span class="dt">margin</span><span class="op">:</span> <span class="st">&#39;0 0 4px 0&#39;</span><span class="op">,</span></span>
<span id="cb38-14"><a href="#cb38-14" tabindex="-1"></a>    }</span>
<span id="cb38-15"><a href="#cb38-15" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb38-16"><a href="#cb38-16" tabindex="-1"></a>  <span class="kw">var</span> description <span class="op">=</span> ui<span class="op">.</span><span class="fu">Label</span>({</span>
<span id="cb38-17"><a href="#cb38-17" tabindex="-1"></a>    <span class="dt">value</span><span class="op">:</span> name<span class="op">,</span></span>
<span id="cb38-18"><a href="#cb38-18" tabindex="-1"></a>    <span class="dt">style</span><span class="op">:</span> {</span>
<span id="cb38-19"><a href="#cb38-19" tabindex="-1"></a>      <span class="dt">margin</span><span class="op">:</span> <span class="st">&#39;0px 0 4px 6px&#39;</span><span class="op">,</span></span>
<span id="cb38-20"><a href="#cb38-20" tabindex="-1"></a>    }</span>
<span id="cb38-21"><a href="#cb38-21" tabindex="-1"></a>  })<span class="op">;</span> </span>
<span id="cb38-22"><a href="#cb38-22" tabindex="-1"></a>  <span class="cf">return</span> ui<span class="op">.</span><span class="fu">Panel</span>({</span>
<span id="cb38-23"><a href="#cb38-23" tabindex="-1"></a>    <span class="dt">widgets</span><span class="op">:</span> [colorBox<span class="op">,</span> description]<span class="op">,</span></span>
<span id="cb38-24"><a href="#cb38-24" tabindex="-1"></a>    <span class="dt">layout</span><span class="op">:</span> ui<span class="op">.</span><span class="at">Panel</span><span class="op">.</span><span class="at">Layout</span><span class="op">.</span><span class="fu">Flow</span>(<span class="st">&#39;horizontal&#39;</span>)}</span>
<span id="cb38-25"><a href="#cb38-25" tabindex="-1"></a>)}<span class="op">;</span></span>
<span id="cb38-26"><a href="#cb38-26" tabindex="-1"></a></span>
<span id="cb38-27"><a href="#cb38-27" tabindex="-1"></a><span class="kw">var</span> title <span class="op">=</span> ui<span class="op">.</span><span class="fu">Label</span>({</span>
<span id="cb38-28"><a href="#cb38-28" tabindex="-1"></a>  <span class="dt">value</span><span class="op">:</span> <span class="st">&#39;Legend&#39;</span><span class="op">,</span></span>
<span id="cb38-29"><a href="#cb38-29" tabindex="-1"></a>  <span class="dt">style</span><span class="op">:</span> {<span class="dt">fontWeight</span><span class="op">:</span> <span class="st">&#39;bold&#39;</span><span class="op">,</span></span>
<span id="cb38-30"><a href="#cb38-30" tabindex="-1"></a>    <span class="dt">fontSize</span><span class="op">:</span> <span class="st">&#39;16px&#39;</span><span class="op">,</span></span>
<span id="cb38-31"><a href="#cb38-31" tabindex="-1"></a>    <span class="dt">margin</span><span class="op">:</span> <span class="st">&#39;0px 0 4px 0px&#39;</span>}})<span class="op">;</span></span>
<span id="cb38-32"><a href="#cb38-32" tabindex="-1"></a></span>
<span id="cb38-33"><a href="#cb38-33" tabindex="-1"></a>legend<span class="op">.</span><span class="fu">add</span>(title)<span class="op">;</span></span>
<span id="cb38-34"><a href="#cb38-34" tabindex="-1"></a>legend<span class="op">.</span><span class="fu">add</span>(<span class="fu">makeRow</span>(<span class="st">&#39;#cc6d8f&#39;</span><span class="op">,</span><span class="st">&#39;Built-up&#39;</span>))</span>
<span id="cb38-35"><a href="#cb38-35" tabindex="-1"></a>legend<span class="op">.</span><span class="fu">add</span>(<span class="fu">makeRow</span>(<span class="st">&#39;#ffc107&#39;</span><span class="op">,</span><span class="st">&#39;Bare Earth&#39;</span>))</span>
<span id="cb38-36"><a href="#cb38-36" tabindex="-1"></a>legend<span class="op">.</span><span class="fu">add</span>(<span class="fu">makeRow</span>(<span class="st">&#39;#1e88e5&#39;</span><span class="op">,</span><span class="st">&#39;Water&#39;</span>))</span>
<span id="cb38-37"><a href="#cb38-37" tabindex="-1"></a>legend<span class="op">.</span><span class="fu">add</span>(<span class="fu">makeRow</span>(<span class="st">&#39;#004d40&#39;</span><span class="op">,</span><span class="st">&#39;Vegetation&#39;</span>))</span>
<span id="cb38-38"><a href="#cb38-38" tabindex="-1"></a></span>
<span id="cb38-39"><a href="#cb38-39" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">add</span>(legend)<span class="op">;</span></span></code></pre></div>
</div>
<div id="adding-a-continous-legend" class="section level2">
<h2>Adding a Continous Legend</h2>
<p>If you are displaying a raster layer in your app with a color
palette, you can use the following technique to add a colorbar using the
snipet below.</p>
<div class="figure" style="text-align: center">
<img src="images/end_to_end_gee/colorbar.png" alt="Creating a Continuous Raster Legend" width="100%" />
<p class="caption">
Creating a Continuous Raster Legend
</p>
</div>
<p><a
href="https://code.earthengine.google.co.in/?scriptPath=users%2Fujavalgandhi%2FEnd-to-End-GEE%3ASupplement%2FUI_Widgets_and_Apps%2FColorbar_Legend"
target="_blank">Open in Code Editor ↗</a></p>
<div class="sourceCode" id="cb39"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb39-1"><a href="#cb39-1" tabindex="-1"></a><span class="kw">var</span> s2 <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&#39;COPERNICUS/S2_HARMONIZED&#39;</span>)<span class="op">;</span></span>
<span id="cb39-2"><a href="#cb39-2" tabindex="-1"></a><span class="kw">var</span> admin2 <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">&#39;FAO/GAUL_SIMPLIFIED_500m/2015/level2&#39;</span>)<span class="op">;</span></span>
<span id="cb39-3"><a href="#cb39-3" tabindex="-1"></a></span>
<span id="cb39-4"><a href="#cb39-4" tabindex="-1"></a><span class="kw">var</span> bangalore <span class="op">=</span> admin2<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;ADM2_NAME&#39;</span><span class="op">,</span> <span class="st">&#39;Bangalore Urban&#39;</span>))</span>
<span id="cb39-5"><a href="#cb39-5" tabindex="-1"></a><span class="kw">var</span> geometry <span class="op">=</span> bangalore<span class="op">.</span><span class="fu">geometry</span>()</span>
<span id="cb39-6"><a href="#cb39-6" tabindex="-1"></a></span>
<span id="cb39-7"><a href="#cb39-7" tabindex="-1"></a><span class="kw">var</span> filtered <span class="op">=</span> s2<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">lt</span>(<span class="st">&#39;CLOUDY_PIXEL_PERCENTAGE&#39;</span><span class="op">,</span> <span class="dv">30</span>))</span>
<span id="cb39-8"><a href="#cb39-8" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(<span class="st">&#39;2019-01-01&#39;</span><span class="op">,</span> <span class="st">&#39;2020-01-01&#39;</span>))</span>
<span id="cb39-9"><a href="#cb39-9" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">bounds</span>(geometry))</span>
<span id="cb39-10"><a href="#cb39-10" tabindex="-1"></a></span>
<span id="cb39-11"><a href="#cb39-11" tabindex="-1"></a><span class="kw">var</span> image <span class="op">=</span> filtered<span class="op">.</span><span class="fu">median</span>()<span class="op">;</span> </span>
<span id="cb39-12"><a href="#cb39-12" tabindex="-1"></a></span>
<span id="cb39-13"><a href="#cb39-13" tabindex="-1"></a><span class="co">// Calculate  Normalized Difference Vegetation Index (NDVI)</span></span>
<span id="cb39-14"><a href="#cb39-14" tabindex="-1"></a><span class="co">// &#39;NIR&#39; (B8) and &#39;RED&#39; (B4)</span></span>
<span id="cb39-15"><a href="#cb39-15" tabindex="-1"></a><span class="kw">var</span> ndvi <span class="op">=</span> image<span class="op">.</span><span class="fu">normalizedDifference</span>([<span class="st">&#39;B8&#39;</span><span class="op">,</span> <span class="st">&#39;B4&#39;</span>])<span class="op">.</span><span class="fu">rename</span>([<span class="st">&#39;ndvi&#39;</span>])<span class="op">;</span></span>
<span id="cb39-16"><a href="#cb39-16" tabindex="-1"></a></span>
<span id="cb39-17"><a href="#cb39-17" tabindex="-1"></a><span class="kw">var</span> palette <span class="op">=</span> [<span class="st">&#39;#d7191c&#39;</span><span class="op">,</span><span class="st">&#39;#fdae61&#39;</span><span class="op">,</span><span class="st">&#39;#ffffbf&#39;</span><span class="op">,</span><span class="st">&#39;#a6d96a&#39;</span><span class="op">,</span><span class="st">&#39;#1a9641&#39;</span>]</span>
<span id="cb39-18"><a href="#cb39-18" tabindex="-1"></a><span class="kw">var</span> ndviVis <span class="op">=</span> {<span class="dt">min</span><span class="op">:</span><span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span><span class="fl">0.5</span><span class="op">,</span> <span class="dt">palette</span><span class="op">:</span> palette}</span>
<span id="cb39-19"><a href="#cb39-19" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">centerObject</span>(geometry<span class="op">,</span> <span class="dv">12</span>)</span>
<span id="cb39-20"><a href="#cb39-20" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(ndvi<span class="op">.</span><span class="fu">clip</span>(geometry)<span class="op">,</span> ndviVis<span class="op">,</span> <span class="st">&#39;ndvi&#39;</span>)</span>
<span id="cb39-21"><a href="#cb39-21" tabindex="-1"></a></span>
<span id="cb39-22"><a href="#cb39-22" tabindex="-1"></a></span>
<span id="cb39-23"><a href="#cb39-23" tabindex="-1"></a><span class="kw">function</span> <span class="fu">createColorBar</span>(titleText<span class="op">,</span> palette<span class="op">,</span> min<span class="op">,</span> max) {</span>
<span id="cb39-24"><a href="#cb39-24" tabindex="-1"></a>  <span class="co">// Legend Title</span></span>
<span id="cb39-25"><a href="#cb39-25" tabindex="-1"></a>  <span class="kw">var</span> title <span class="op">=</span> ui<span class="op">.</span><span class="fu">Label</span>({</span>
<span id="cb39-26"><a href="#cb39-26" tabindex="-1"></a>    <span class="dt">value</span><span class="op">:</span> titleText<span class="op">,</span> </span>
<span id="cb39-27"><a href="#cb39-27" tabindex="-1"></a>    <span class="dt">style</span><span class="op">:</span> {<span class="dt">fontWeight</span><span class="op">:</span> <span class="st">&#39;bold&#39;</span><span class="op">,</span> <span class="dt">textAlign</span><span class="op">:</span> <span class="st">&#39;center&#39;</span><span class="op">,</span> <span class="dt">stretch</span><span class="op">:</span> <span class="st">&#39;horizontal&#39;</span>}})<span class="op">;</span></span>
<span id="cb39-28"><a href="#cb39-28" tabindex="-1"></a></span>
<span id="cb39-29"><a href="#cb39-29" tabindex="-1"></a>  <span class="co">// Colorbar</span></span>
<span id="cb39-30"><a href="#cb39-30" tabindex="-1"></a>  <span class="kw">var</span> legend <span class="op">=</span> ui<span class="op">.</span><span class="fu">Thumbnail</span>({</span>
<span id="cb39-31"><a href="#cb39-31" tabindex="-1"></a>    <span class="dt">image</span><span class="op">:</span> ee<span class="op">.</span><span class="at">Image</span><span class="op">.</span><span class="fu">pixelLonLat</span>()<span class="op">.</span><span class="fu">select</span>(<span class="dv">0</span>)<span class="op">,</span></span>
<span id="cb39-32"><a href="#cb39-32" tabindex="-1"></a>    <span class="dt">params</span><span class="op">:</span> {</span>
<span id="cb39-33"><a href="#cb39-33" tabindex="-1"></a>      <span class="dt">bbox</span><span class="op">:</span> [<span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="fl">0.1</span>]<span class="op">,</span></span>
<span id="cb39-34"><a href="#cb39-34" tabindex="-1"></a>      <span class="dt">dimensions</span><span class="op">:</span> <span class="st">&#39;200x20&#39;</span><span class="op">,</span></span>
<span id="cb39-35"><a href="#cb39-35" tabindex="-1"></a>      <span class="dt">format</span><span class="op">:</span> <span class="st">&#39;png&#39;</span><span class="op">,</span> </span>
<span id="cb39-36"><a href="#cb39-36" tabindex="-1"></a>      <span class="dt">min</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span> <span class="dv">1</span><span class="op">,</span></span>
<span id="cb39-37"><a href="#cb39-37" tabindex="-1"></a>      <span class="dt">palette</span><span class="op">:</span> palette}<span class="op">,</span></span>
<span id="cb39-38"><a href="#cb39-38" tabindex="-1"></a>    <span class="dt">style</span><span class="op">:</span> {<span class="dt">stretch</span><span class="op">:</span> <span class="st">&#39;horizontal&#39;</span><span class="op">,</span> <span class="dt">margin</span><span class="op">:</span> <span class="st">&#39;8px 8px&#39;</span><span class="op">,</span> <span class="dt">maxHeight</span><span class="op">:</span> <span class="st">&#39;40px&#39;</span>}<span class="op">,</span></span>
<span id="cb39-39"><a href="#cb39-39" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb39-40"><a href="#cb39-40" tabindex="-1"></a>  </span>
<span id="cb39-41"><a href="#cb39-41" tabindex="-1"></a>  <span class="co">// Legend Labels</span></span>
<span id="cb39-42"><a href="#cb39-42" tabindex="-1"></a>  <span class="kw">var</span> labels <span class="op">=</span> ui<span class="op">.</span><span class="fu">Panel</span>({</span>
<span id="cb39-43"><a href="#cb39-43" tabindex="-1"></a>    <span class="dt">widgets</span><span class="op">:</span> [</span>
<span id="cb39-44"><a href="#cb39-44" tabindex="-1"></a>      ui<span class="op">.</span><span class="fu">Label</span>(min<span class="op">,</span> {<span class="dt">margin</span><span class="op">:</span> <span class="st">&#39;4px 10px&#39;</span><span class="op">,</span><span class="dt">textAlign</span><span class="op">:</span> <span class="st">&#39;left&#39;</span><span class="op">,</span> <span class="dt">stretch</span><span class="op">:</span> <span class="st">&#39;horizontal&#39;</span>})<span class="op">,</span></span>
<span id="cb39-45"><a href="#cb39-45" tabindex="-1"></a>      ui<span class="op">.</span><span class="fu">Label</span>((min<span class="op">+</span>max)<span class="op">/</span><span class="dv">2</span><span class="op">,</span> {<span class="dt">margin</span><span class="op">:</span> <span class="st">&#39;4px 20px&#39;</span><span class="op">,</span> <span class="dt">textAlign</span><span class="op">:</span> <span class="st">&#39;center&#39;</span><span class="op">,</span> <span class="dt">stretch</span><span class="op">:</span> <span class="st">&#39;horizontal&#39;</span>})<span class="op">,</span></span>
<span id="cb39-46"><a href="#cb39-46" tabindex="-1"></a>      ui<span class="op">.</span><span class="fu">Label</span>(max<span class="op">,</span> {<span class="dt">margin</span><span class="op">:</span> <span class="st">&#39;4px 10px&#39;</span><span class="op">,</span><span class="dt">textAlign</span><span class="op">:</span> <span class="st">&#39;right&#39;</span><span class="op">,</span> <span class="dt">stretch</span><span class="op">:</span> <span class="st">&#39;horizontal&#39;</span>})]<span class="op">,</span></span>
<span id="cb39-47"><a href="#cb39-47" tabindex="-1"></a>    <span class="dt">layout</span><span class="op">:</span> ui<span class="op">.</span><span class="at">Panel</span><span class="op">.</span><span class="at">Layout</span><span class="op">.</span><span class="fu">flow</span>(<span class="st">&#39;horizontal&#39;</span>)})<span class="op">;</span></span>
<span id="cb39-48"><a href="#cb39-48" tabindex="-1"></a>  </span>
<span id="cb39-49"><a href="#cb39-49" tabindex="-1"></a>  <span class="co">// Create a panel with all 3 widgets</span></span>
<span id="cb39-50"><a href="#cb39-50" tabindex="-1"></a>  <span class="kw">var</span> legendPanel <span class="op">=</span> ui<span class="op">.</span><span class="fu">Panel</span>({</span>
<span id="cb39-51"><a href="#cb39-51" tabindex="-1"></a>    <span class="dt">widgets</span><span class="op">:</span> [title<span class="op">,</span> legend<span class="op">,</span> labels]<span class="op">,</span></span>
<span id="cb39-52"><a href="#cb39-52" tabindex="-1"></a>    <span class="dt">style</span><span class="op">:</span> {<span class="dt">position</span><span class="op">:</span> <span class="st">&#39;bottom-center&#39;</span><span class="op">,</span> <span class="dt">padding</span><span class="op">:</span> <span class="st">&#39;8px 15px&#39;</span>}</span>
<span id="cb39-53"><a href="#cb39-53" tabindex="-1"></a>  })</span>
<span id="cb39-54"><a href="#cb39-54" tabindex="-1"></a>  <span class="cf">return</span> legendPanel</span>
<span id="cb39-55"><a href="#cb39-55" tabindex="-1"></a>}</span>
<span id="cb39-56"><a href="#cb39-56" tabindex="-1"></a><span class="co">// Call the function to create a colorbar legend  </span></span>
<span id="cb39-57"><a href="#cb39-57" tabindex="-1"></a><span class="kw">var</span> colorBar <span class="op">=</span> <span class="fu">createColorBar</span>(<span class="st">&#39;NDVI Values&#39;</span><span class="op">,</span> palette<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="fl">0.5</span>)</span>
<span id="cb39-58"><a href="#cb39-58" tabindex="-1"></a></span>
<span id="cb39-59"><a href="#cb39-59" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">add</span>(colorBar)</span></code></pre></div>
</div>
<div id="change-visualization-ui-app" class="section level2">
<h2>Change Visualization UI App</h2>
<p>A common use-case for Earth Engine Apps is to display 2 images in a
split panel app. Below script contains a simple template that you can
use to create an interactive split panel app. Here we have 2 map objects
- <code>leftMap</code> and <code>rightMap</code>. You can add different
images to each of the maps and users will be able to explore them
side-by-side. ![<a
href="https://courses.spatialthoughts.com/images/end_to_end_gee/dust_storm_app.gif"
target="_blank">View Animated GIF ↗</a>]</p>
<div class="figure" style="text-align: center">
<img src="images/end_to_end_gee/dust_storm_app.png" alt="A Split Panel App that displays Pre- and Post-Storm Images" width="100%" />
<p class="caption">
A Split Panel App that displays Pre- and Post-Storm Images
</p>
</div>
<p><a
href="https://code.earthengine.google.com/?scriptPath=users%2Fujavalgandhi%2FEnd-to-End-GEE%3ASupplement%2FUI_Widgets_and_Apps%2FChange_Visualization_UI_App"
target="_blank">Open in Code Editor ↗</a></p>
<div class="sourceCode" id="cb40"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb40-1"><a href="#cb40-1" tabindex="-1"></a><span class="co">// On June 9, 2018 - A massive dust storm hit North India</span></span>
<span id="cb40-2"><a href="#cb40-2" tabindex="-1"></a><span class="co">// This example shows before and after imagery from Sentinel-2</span></span>
<span id="cb40-3"><a href="#cb40-3" tabindex="-1"></a></span>
<span id="cb40-4"><a href="#cb40-4" tabindex="-1"></a><span class="co">// Display two visualizations of a map.</span></span>
<span id="cb40-5"><a href="#cb40-5" tabindex="-1"></a></span>
<span id="cb40-6"><a href="#cb40-6" tabindex="-1"></a><span class="co">// Set a center and zoom level.</span></span>
<span id="cb40-7"><a href="#cb40-7" tabindex="-1"></a><span class="kw">var</span> center <span class="op">=</span> {<span class="dt">lon</span><span class="op">:</span> <span class="fl">77.47</span><span class="op">,</span> <span class="dt">lat</span><span class="op">:</span> <span class="fl">28.41</span><span class="op">,</span> <span class="dt">zoom</span><span class="op">:</span> <span class="dv">12</span>}<span class="op">;</span></span>
<span id="cb40-8"><a href="#cb40-8" tabindex="-1"></a></span>
<span id="cb40-9"><a href="#cb40-9" tabindex="-1"></a><span class="co">// Create two maps.</span></span>
<span id="cb40-10"><a href="#cb40-10" tabindex="-1"></a><span class="kw">var</span> leftMap <span class="op">=</span> ui<span class="op">.</span><span class="fu">Map</span>(center)<span class="op">;</span></span>
<span id="cb40-11"><a href="#cb40-11" tabindex="-1"></a><span class="kw">var</span> rightMap <span class="op">=</span> ui<span class="op">.</span><span class="fu">Map</span>(center)<span class="op">;</span></span>
<span id="cb40-12"><a href="#cb40-12" tabindex="-1"></a></span>
<span id="cb40-13"><a href="#cb40-13" tabindex="-1"></a><span class="co">// Remove UI controls from both maps, but leave zoom control on the left map.</span></span>
<span id="cb40-14"><a href="#cb40-14" tabindex="-1"></a>leftMap<span class="op">.</span><span class="fu">setControlVisibility</span>(<span class="kw">false</span>)<span class="op">;</span></span>
<span id="cb40-15"><a href="#cb40-15" tabindex="-1"></a>rightMap<span class="op">.</span><span class="fu">setControlVisibility</span>(<span class="kw">false</span>)<span class="op">;</span></span>
<span id="cb40-16"><a href="#cb40-16" tabindex="-1"></a>leftMap<span class="op">.</span><span class="fu">setControlVisibility</span>({<span class="dt">zoomControl</span><span class="op">:</span> <span class="kw">true</span>})<span class="op">;</span></span>
<span id="cb40-17"><a href="#cb40-17" tabindex="-1"></a></span>
<span id="cb40-18"><a href="#cb40-18" tabindex="-1"></a><span class="co">// Link them together.</span></span>
<span id="cb40-19"><a href="#cb40-19" tabindex="-1"></a><span class="kw">var</span> linker <span class="op">=</span> ui<span class="op">.</span><span class="at">Map</span><span class="op">.</span><span class="fu">Linker</span>([leftMap<span class="op">,</span> rightMap])<span class="op">;</span></span>
<span id="cb40-20"><a href="#cb40-20" tabindex="-1"></a></span>
<span id="cb40-21"><a href="#cb40-21" tabindex="-1"></a><span class="co">// Create a split panel with the two maps.</span></span>
<span id="cb40-22"><a href="#cb40-22" tabindex="-1"></a><span class="kw">var</span> splitPanel <span class="op">=</span> ui<span class="op">.</span><span class="fu">SplitPanel</span>({</span>
<span id="cb40-23"><a href="#cb40-23" tabindex="-1"></a>  <span class="dt">firstPanel</span><span class="op">:</span> leftMap<span class="op">,</span></span>
<span id="cb40-24"><a href="#cb40-24" tabindex="-1"></a>  <span class="dt">secondPanel</span><span class="op">:</span> rightMap<span class="op">,</span></span>
<span id="cb40-25"><a href="#cb40-25" tabindex="-1"></a>  <span class="dt">orientation</span><span class="op">:</span> <span class="st">&#39;horizontal&#39;</span><span class="op">,</span></span>
<span id="cb40-26"><a href="#cb40-26" tabindex="-1"></a>  <span class="dt">wipe</span><span class="op">:</span> <span class="kw">true</span></span>
<span id="cb40-27"><a href="#cb40-27" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb40-28"><a href="#cb40-28" tabindex="-1"></a></span>
<span id="cb40-29"><a href="#cb40-29" tabindex="-1"></a><span class="co">// Remove the default map from the root panel.</span></span>
<span id="cb40-30"><a href="#cb40-30" tabindex="-1"></a>ui<span class="op">.</span><span class="at">root</span><span class="op">.</span><span class="fu">clear</span>()<span class="op">;</span></span>
<span id="cb40-31"><a href="#cb40-31" tabindex="-1"></a></span>
<span id="cb40-32"><a href="#cb40-32" tabindex="-1"></a><span class="co">// Add our split panel to the root panel.</span></span>
<span id="cb40-33"><a href="#cb40-33" tabindex="-1"></a>ui<span class="op">.</span><span class="at">root</span><span class="op">.</span><span class="fu">add</span>(splitPanel)<span class="op">;</span></span>
<span id="cb40-34"><a href="#cb40-34" tabindex="-1"></a></span>
<span id="cb40-35"><a href="#cb40-35" tabindex="-1"></a><span class="kw">var</span> rgb_vis <span class="op">=</span> {<span class="dt">min</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span> <span class="dv">3200</span><span class="op">,</span> <span class="dt">bands</span><span class="op">:</span> [<span class="st">&#39;B4&#39;</span><span class="op">,</span> <span class="st">&#39;B3&#39;</span><span class="op">,</span> <span class="st">&#39;B2&#39;</span>]}<span class="op">;</span></span>
<span id="cb40-36"><a href="#cb40-36" tabindex="-1"></a></span>
<span id="cb40-37"><a href="#cb40-37" tabindex="-1"></a><span class="kw">var</span> preStorm <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(<span class="st">&#39;COPERNICUS/S2/20180604T052651_20180604T053435_T43RGM&#39;</span>)</span>
<span id="cb40-38"><a href="#cb40-38" tabindex="-1"></a><span class="kw">var</span> postStorm <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(<span class="st">&#39;COPERNICUS/S2/20180614T052651_20180614T053611_T43RGM&#39;</span>)</span>
<span id="cb40-39"><a href="#cb40-39" tabindex="-1"></a></span>
<span id="cb40-40"><a href="#cb40-40" tabindex="-1"></a><span class="co">// Add a RGB Landsat 8 layer to the left map.</span></span>
<span id="cb40-41"><a href="#cb40-41" tabindex="-1"></a>leftMap<span class="op">.</span><span class="fu">addLayer</span>(preStorm<span class="op">,</span> rgb_vis)<span class="op">;</span></span>
<span id="cb40-42"><a href="#cb40-42" tabindex="-1"></a>rightMap<span class="op">.</span><span class="fu">addLayer</span>(postStorm<span class="op">,</span> rgb_vis)<span class="op">;</span></span></code></pre></div>
</div>
<div id="ndvi-explorer-ui-app" class="section level2">
<h2>NDVI Explorer UI App</h2>
<p>Earth Engine Apps allow you to display interactive charts in response
to user action. This app shows the common design pattern to build an app
that allows the user to click anywhere on the map and obtain a chart
using the clicked-location.</p>
<div class="figure" style="text-align: center">
<img src="images/end_to_end_gee/global_ndvi_explorer.png" alt="Global NDVI Explorer App" width="100%" />
<p class="caption">
Global NDVI Explorer App
</p>
</div>
<p><a
href="https://code.earthengine.google.co.in/?scriptPath=users%2Fujavalgandhi%2FEnd-to-End-GEE%3ASupplement%2FUI_Widgets_and_Apps%2FNDVI_Explorer_UI_App"
target="_blank">Open in Code Editor ↗</a></p>
<div class="sourceCode" id="cb41"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb41-1"><a href="#cb41-1" tabindex="-1"></a><span class="kw">var</span> geometry <span class="op">=</span> ee<span class="op">.</span><span class="at">Geometry</span><span class="op">.</span><span class="fu">Point</span>([<span class="fl">77.5979</span><span class="op">,</span> <span class="fl">13.00896</span>])<span class="op">;</span></span>
<span id="cb41-2"><a href="#cb41-2" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">centerObject</span>(geometry<span class="op">,</span> <span class="dv">10</span>)</span>
<span id="cb41-3"><a href="#cb41-3" tabindex="-1"></a></span>
<span id="cb41-4"><a href="#cb41-4" tabindex="-1"></a><span class="kw">var</span> s2 <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&#39;COPERNICUS/S2_HARMONIZED&#39;</span>)</span>
<span id="cb41-5"><a href="#cb41-5" tabindex="-1"></a></span>
<span id="cb41-6"><a href="#cb41-6" tabindex="-1"></a><span class="co">// Load the Cloud Score+ collection</span></span>
<span id="cb41-7"><a href="#cb41-7" tabindex="-1"></a><span class="kw">var</span> csPlus <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&#39;GOOGLE/CLOUD_SCORE_PLUS/V1/S2_HARMONIZED&#39;</span>)<span class="op">;</span></span>
<span id="cb41-8"><a href="#cb41-8" tabindex="-1"></a><span class="kw">var</span> csPlusBands <span class="op">=</span> csPlus<span class="op">.</span><span class="fu">first</span>()<span class="op">.</span><span class="fu">bandNames</span>()<span class="op">;</span></span>
<span id="cb41-9"><a href="#cb41-9" tabindex="-1"></a></span>
<span id="cb41-10"><a href="#cb41-10" tabindex="-1"></a><span class="co">// We need to add Cloud Score + bands to each Sentinel-2</span></span>
<span id="cb41-11"><a href="#cb41-11" tabindex="-1"></a><span class="co">// image in the collection</span></span>
<span id="cb41-12"><a href="#cb41-12" tabindex="-1"></a><span class="co">// This is done using the linkCollection() function</span></span>
<span id="cb41-13"><a href="#cb41-13" tabindex="-1"></a><span class="kw">var</span> s2WithCs <span class="op">=</span> s2<span class="op">.</span><span class="fu">linkCollection</span>(csPlus<span class="op">,</span> csPlusBands)<span class="op">;</span></span>
<span id="cb41-14"><a href="#cb41-14" tabindex="-1"></a></span>
<span id="cb41-15"><a href="#cb41-15" tabindex="-1"></a><span class="co">// Function to mask pixels with low CS+ QA scores.</span></span>
<span id="cb41-16"><a href="#cb41-16" tabindex="-1"></a><span class="kw">function</span> <span class="fu">maskLowQA</span>(image) {</span>
<span id="cb41-17"><a href="#cb41-17" tabindex="-1"></a>  <span class="kw">var</span> qaBand <span class="op">=</span> <span class="st">&#39;cs&#39;</span><span class="op">;</span></span>
<span id="cb41-18"><a href="#cb41-18" tabindex="-1"></a>  <span class="kw">var</span> clearThreshold <span class="op">=</span> <span class="fl">0.5</span><span class="op">;</span></span>
<span id="cb41-19"><a href="#cb41-19" tabindex="-1"></a>  <span class="kw">var</span> mask <span class="op">=</span> image<span class="op">.</span><span class="fu">select</span>(qaBand)<span class="op">.</span><span class="fu">gte</span>(clearThreshold)<span class="op">;</span></span>
<span id="cb41-20"><a href="#cb41-20" tabindex="-1"></a>  <span class="cf">return</span> image<span class="op">.</span><span class="fu">updateMask</span>(mask)<span class="op">;</span></span>
<span id="cb41-21"><a href="#cb41-21" tabindex="-1"></a>}</span>
<span id="cb41-22"><a href="#cb41-22" tabindex="-1"></a></span>
<span id="cb41-23"><a href="#cb41-23" tabindex="-1"></a><span class="kw">var</span> rgbVis <span class="op">=</span> {</span>
<span id="cb41-24"><a href="#cb41-24" tabindex="-1"></a>  <span class="dt">min</span><span class="op">:</span> <span class="fl">0.0</span><span class="op">,</span></span>
<span id="cb41-25"><a href="#cb41-25" tabindex="-1"></a>  <span class="dt">max</span><span class="op">:</span> <span class="dv">3000</span><span class="op">,</span></span>
<span id="cb41-26"><a href="#cb41-26" tabindex="-1"></a>  <span class="dt">bands</span><span class="op">:</span> [<span class="st">&#39;B4&#39;</span><span class="op">,</span> <span class="st">&#39;B3&#39;</span><span class="op">,</span> <span class="st">&#39;B2&#39;</span>]<span class="op">,</span></span>
<span id="cb41-27"><a href="#cb41-27" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb41-28"><a href="#cb41-28" tabindex="-1"></a></span>
<span id="cb41-29"><a href="#cb41-29" tabindex="-1"></a><span class="kw">var</span> palette <span class="op">=</span> [</span>
<span id="cb41-30"><a href="#cb41-30" tabindex="-1"></a>  <span class="st">&#39;FFFFFF&#39;</span><span class="op">,</span> <span class="st">&#39;CE7E45&#39;</span><span class="op">,</span> <span class="st">&#39;DF923D&#39;</span><span class="op">,</span> <span class="st">&#39;F1B555&#39;</span><span class="op">,</span> <span class="st">&#39;FCD163&#39;</span><span class="op">,</span> <span class="st">&#39;99B718&#39;</span><span class="op">,</span></span>
<span id="cb41-31"><a href="#cb41-31" tabindex="-1"></a>  <span class="st">&#39;74A901&#39;</span><span class="op">,</span> <span class="st">&#39;66A000&#39;</span><span class="op">,</span> <span class="st">&#39;529400&#39;</span><span class="op">,</span> <span class="st">&#39;3E8601&#39;</span><span class="op">,</span> <span class="st">&#39;207401&#39;</span><span class="op">,</span> <span class="st">&#39;056201&#39;</span><span class="op">,</span></span>
<span id="cb41-32"><a href="#cb41-32" tabindex="-1"></a>  <span class="st">&#39;004C00&#39;</span><span class="op">,</span> <span class="st">&#39;023B01&#39;</span><span class="op">,</span> <span class="st">&#39;012E01&#39;</span><span class="op">,</span> <span class="st">&#39;011D01&#39;</span><span class="op">,</span> <span class="st">&#39;011301&#39;</span>]<span class="op">;</span></span>
<span id="cb41-33"><a href="#cb41-33" tabindex="-1"></a></span>
<span id="cb41-34"><a href="#cb41-34" tabindex="-1"></a><span class="kw">var</span> ndviVis <span class="op">=</span> {<span class="dt">min</span><span class="op">:</span><span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span><span class="fl">0.5</span><span class="op">,</span> <span class="dt">palette</span><span class="op">:</span> palette }</span>
<span id="cb41-35"><a href="#cb41-35" tabindex="-1"></a></span>
<span id="cb41-36"><a href="#cb41-36" tabindex="-1"></a><span class="co">// Write a function that computes NDVI for an image and adds it as a band</span></span>
<span id="cb41-37"><a href="#cb41-37" tabindex="-1"></a><span class="kw">function</span> <span class="fu">addNDVI</span>(image) {</span>
<span id="cb41-38"><a href="#cb41-38" tabindex="-1"></a>  <span class="kw">var</span> ndvi <span class="op">=</span> image<span class="op">.</span><span class="fu">normalizedDifference</span>([<span class="st">&#39;B8&#39;</span><span class="op">,</span> <span class="st">&#39;B4&#39;</span>])<span class="op">.</span><span class="fu">rename</span>(<span class="st">&#39;ndvi&#39;</span>)<span class="op">;</span></span>
<span id="cb41-39"><a href="#cb41-39" tabindex="-1"></a>  <span class="cf">return</span> image<span class="op">.</span><span class="fu">addBands</span>(ndvi)<span class="op">;</span></span>
<span id="cb41-40"><a href="#cb41-40" tabindex="-1"></a>}</span>
<span id="cb41-41"><a href="#cb41-41" tabindex="-1"></a></span>
<span id="cb41-42"><a href="#cb41-42" tabindex="-1"></a><span class="kw">function</span> <span class="fu">getComposite</span>(geometry) {</span>
<span id="cb41-43"><a href="#cb41-43" tabindex="-1"></a>  <span class="kw">var</span> filtered <span class="op">=</span> s2WithCs</span>
<span id="cb41-44"><a href="#cb41-44" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(<span class="st">&#39;2019-01-01&#39;</span><span class="op">,</span> <span class="st">&#39;2019-12-31&#39;</span>))</span>
<span id="cb41-45"><a href="#cb41-45" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">lt</span>(<span class="st">&#39;CLOUDY_PIXEL_PERCENTAGE&#39;</span><span class="op">,</span> <span class="dv">30</span>))</span>
<span id="cb41-46"><a href="#cb41-46" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">bounds</span>(geometry))</span>
<span id="cb41-47"><a href="#cb41-47" tabindex="-1"></a>  <span class="op">.</span><span class="fu">map</span>(maskLowQA)<span class="op">;</span></span>
<span id="cb41-48"><a href="#cb41-48" tabindex="-1"></a>  <span class="co">// Map the function over the collection</span></span>
<span id="cb41-49"><a href="#cb41-49" tabindex="-1"></a>  <span class="kw">var</span> withNdvi <span class="op">=</span> filtered<span class="op">.</span><span class="fu">map</span>(addNDVI)<span class="op">;</span></span>
<span id="cb41-50"><a href="#cb41-50" tabindex="-1"></a></span>
<span id="cb41-51"><a href="#cb41-51" tabindex="-1"></a>  <span class="kw">var</span> composite <span class="op">=</span> withNdvi<span class="op">.</span><span class="fu">median</span>()</span>
<span id="cb41-52"><a href="#cb41-52" tabindex="-1"></a>  <span class="cf">return</span> composite</span>
<span id="cb41-53"><a href="#cb41-53" tabindex="-1"></a>}</span>
<span id="cb41-54"><a href="#cb41-54" tabindex="-1"></a></span>
<span id="cb41-55"><a href="#cb41-55" tabindex="-1"></a></span>
<span id="cb41-56"><a href="#cb41-56" tabindex="-1"></a><span class="co">// Create UI Elements</span></span>
<span id="cb41-57"><a href="#cb41-57" tabindex="-1"></a><span class="kw">var</span> title <span class="op">=</span> ui<span class="op">.</span><span class="fu">Label</span>(<span class="st">&#39;Global NDVI Explorer&#39;</span>)<span class="op">;</span></span>
<span id="cb41-58"><a href="#cb41-58" tabindex="-1"></a>title<span class="op">.</span><span class="fu">style</span>()<span class="op">.</span><span class="fu">set</span>({</span>
<span id="cb41-59"><a href="#cb41-59" tabindex="-1"></a>  <span class="st">&#39;position&#39;</span><span class="op">:</span>  <span class="st">&#39;top-center&#39;</span><span class="op">,</span></span>
<span id="cb41-60"><a href="#cb41-60" tabindex="-1"></a>  <span class="st">&#39;fontSize&#39;</span><span class="op">:</span> <span class="st">&#39;24px&#39;</span></span>
<span id="cb41-61"><a href="#cb41-61" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb41-62"><a href="#cb41-62" tabindex="-1"></a><span class="kw">var</span> resultsPanel <span class="op">=</span> ui<span class="op">.</span><span class="fu">Panel</span>()<span class="op">;</span></span>
<span id="cb41-63"><a href="#cb41-63" tabindex="-1"></a><span class="kw">var</span> chartPanel <span class="op">=</span> ui<span class="op">.</span><span class="fu">Panel</span>()<span class="op">;</span></span>
<span id="cb41-64"><a href="#cb41-64" tabindex="-1"></a><span class="kw">var</span> selectionPanel <span class="op">=</span> ui<span class="op">.</span><span class="fu">Panel</span>({</span>
<span id="cb41-65"><a href="#cb41-65" tabindex="-1"></a>  <span class="dt">layout</span><span class="op">:</span> ui<span class="op">.</span><span class="at">Panel</span><span class="op">.</span><span class="at">Layout</span><span class="op">.</span><span class="fu">flow</span>(<span class="st">&#39;horizontal&#39;</span>)<span class="op">,</span></span>
<span id="cb41-66"><a href="#cb41-66" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb41-67"><a href="#cb41-67" tabindex="-1"></a><span class="kw">var</span> downloadPanel <span class="op">=</span> ui<span class="op">.</span><span class="fu">Panel</span>()<span class="op">;</span></span>
<span id="cb41-68"><a href="#cb41-68" tabindex="-1"></a></span>
<span id="cb41-69"><a href="#cb41-69" tabindex="-1"></a>resultsPanel<span class="op">.</span><span class="fu">style</span>()<span class="op">.</span><span class="fu">set</span>({</span>
<span id="cb41-70"><a href="#cb41-70" tabindex="-1"></a>  <span class="dt">width</span><span class="op">:</span> <span class="st">&#39;400px&#39;</span><span class="op">,</span></span>
<span id="cb41-71"><a href="#cb41-71" tabindex="-1"></a>  <span class="dt">position</span><span class="op">:</span> <span class="st">&#39;bottom-right&#39;</span></span>
<span id="cb41-72"><a href="#cb41-72" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb41-73"><a href="#cb41-73" tabindex="-1"></a></span>
<span id="cb41-74"><a href="#cb41-74" tabindex="-1"></a><span class="kw">var</span> resetPanel <span class="op">=</span> ui<span class="op">.</span><span class="fu">Panel</span>()<span class="op">;</span></span>
<span id="cb41-75"><a href="#cb41-75" tabindex="-1"></a></span>
<span id="cb41-76"><a href="#cb41-76" tabindex="-1"></a></span>
<span id="cb41-77"><a href="#cb41-77" tabindex="-1"></a>resultsPanel<span class="op">.</span><span class="fu">add</span>(selectionPanel)<span class="op">;</span></span>
<span id="cb41-78"><a href="#cb41-78" tabindex="-1"></a>resultsPanel<span class="op">.</span><span class="fu">add</span>(chartPanel)<span class="op">;</span></span>
<span id="cb41-79"><a href="#cb41-79" tabindex="-1"></a>resultsPanel<span class="op">.</span><span class="fu">add</span>(downloadPanel)<span class="op">;</span></span>
<span id="cb41-80"><a href="#cb41-80" tabindex="-1"></a>resultsPanel<span class="op">.</span><span class="fu">add</span>(resetPanel)<span class="op">;</span></span>
<span id="cb41-81"><a href="#cb41-81" tabindex="-1"></a></span>
<span id="cb41-82"><a href="#cb41-82" tabindex="-1"></a><span class="co">// Function to reset the app to initial state</span></span>
<span id="cb41-83"><a href="#cb41-83" tabindex="-1"></a><span class="kw">var</span> resetEverything <span class="op">=</span> <span class="kw">function</span>() {</span>
<span id="cb41-84"><a href="#cb41-84" tabindex="-1"></a>  chartPanel<span class="op">.</span><span class="fu">clear</span>()<span class="op">;</span></span>
<span id="cb41-85"><a href="#cb41-85" tabindex="-1"></a>  selectionPanel<span class="op">.</span><span class="fu">clear</span>()<span class="op">;</span></span>
<span id="cb41-86"><a href="#cb41-86" tabindex="-1"></a>  downloadPanel<span class="op">.</span><span class="fu">clear</span>()<span class="op">;</span></span>
<span id="cb41-87"><a href="#cb41-87" tabindex="-1"></a>  resetPanel<span class="op">.</span><span class="fu">clear</span>()<span class="op">;</span></span>
<span id="cb41-88"><a href="#cb41-88" tabindex="-1"></a></span>
<span id="cb41-89"><a href="#cb41-89" tabindex="-1"></a>  <span class="bu">Map</span><span class="op">.</span><span class="fu">clear</span>()</span>
<span id="cb41-90"><a href="#cb41-90" tabindex="-1"></a></span>
<span id="cb41-91"><a href="#cb41-91" tabindex="-1"></a>  <span class="bu">Map</span><span class="op">.</span><span class="fu">add</span>(title)<span class="op">;</span></span>
<span id="cb41-92"><a href="#cb41-92" tabindex="-1"></a>  <span class="bu">Map</span><span class="op">.</span><span class="fu">add</span>(resultsPanel)</span>
<span id="cb41-93"><a href="#cb41-93" tabindex="-1"></a>  <span class="bu">Map</span><span class="op">.</span><span class="fu">onClick</span>(displayChart)</span>
<span id="cb41-94"><a href="#cb41-94" tabindex="-1"></a>  <span class="co">// Use the current viewport</span></span>
<span id="cb41-95"><a href="#cb41-95" tabindex="-1"></a>  <span class="kw">var</span> bounds <span class="op">=</span> ee<span class="op">.</span><span class="at">Geometry</span><span class="op">.</span><span class="fu">Rectangle</span>(<span class="bu">Map</span><span class="op">.</span><span class="fu">getBounds</span>())</span>
<span id="cb41-96"><a href="#cb41-96" tabindex="-1"></a>  <span class="kw">var</span> composite <span class="op">=</span> <span class="fu">getComposite</span>(bounds)</span>
<span id="cb41-97"><a href="#cb41-97" tabindex="-1"></a>  <span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(composite<span class="op">,</span> rgbVis<span class="op">,</span> <span class="st">&#39;Sentinel-2 Composite&#39;</span>)</span>
<span id="cb41-98"><a href="#cb41-98" tabindex="-1"></a>  <span class="kw">var</span> label <span class="op">=</span> ui<span class="op">.</span><span class="fu">Label</span>(<span class="st">&#39;Click anywhere to see the chart&#39;</span>)</span>
<span id="cb41-99"><a href="#cb41-99" tabindex="-1"></a>  resetPanel<span class="op">.</span><span class="fu">add</span>(label)</span>
<span id="cb41-100"><a href="#cb41-100" tabindex="-1"></a></span>
<span id="cb41-101"><a href="#cb41-101" tabindex="-1"></a>}</span>
<span id="cb41-102"><a href="#cb41-102" tabindex="-1"></a></span>
<span id="cb41-103"><a href="#cb41-103" tabindex="-1"></a><span class="co">// Function to create and display NDVI time-series chart</span></span>
<span id="cb41-104"><a href="#cb41-104" tabindex="-1"></a><span class="kw">var</span> displayChart <span class="op">=</span> <span class="kw">function</span>(point) {</span>
<span id="cb41-105"><a href="#cb41-105" tabindex="-1"></a>  resetPanel<span class="op">.</span><span class="fu">clear</span>()</span>
<span id="cb41-106"><a href="#cb41-106" tabindex="-1"></a>  <span class="kw">var</span> button <span class="op">=</span> ui<span class="op">.</span><span class="fu">Button</span>({</span>
<span id="cb41-107"><a href="#cb41-107" tabindex="-1"></a>    <span class="dt">label</span><span class="op">:</span> <span class="st">&#39;Reset&#39;</span><span class="op">,</span></span>
<span id="cb41-108"><a href="#cb41-108" tabindex="-1"></a>    <span class="dt">onClick</span><span class="op">:</span> resetEverything})</span>
<span id="cb41-109"><a href="#cb41-109" tabindex="-1"></a>  resetPanel<span class="op">.</span><span class="fu">add</span>(button)</span>
<span id="cb41-110"><a href="#cb41-110" tabindex="-1"></a>  <span class="kw">var</span> geometry <span class="op">=</span> ee<span class="op">.</span><span class="at">Geometry</span><span class="op">.</span><span class="fu">Point</span>(point[<span class="st">&#39;lon&#39;</span>]<span class="op">,</span> point[<span class="st">&#39;lat&#39;</span>])<span class="op">;</span></span>
<span id="cb41-111"><a href="#cb41-111" tabindex="-1"></a>  </span>
<span id="cb41-112"><a href="#cb41-112" tabindex="-1"></a>  <span class="kw">var</span> filtered <span class="op">=</span> s2WithCs</span>
<span id="cb41-113"><a href="#cb41-113" tabindex="-1"></a>    <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(<span class="st">&#39;2019-01-01&#39;</span><span class="op">,</span> <span class="st">&#39;2019-12-31&#39;</span>))</span>
<span id="cb41-114"><a href="#cb41-114" tabindex="-1"></a>    <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">lt</span>(<span class="st">&#39;CLOUDY_PIXEL_PERCENTAGE&#39;</span><span class="op">,</span> <span class="dv">30</span>))</span>
<span id="cb41-115"><a href="#cb41-115" tabindex="-1"></a>    <span class="op">.</span><span class="fu">map</span>(maskLowQA)</span>
<span id="cb41-116"><a href="#cb41-116" tabindex="-1"></a>    <span class="op">.</span><span class="fu">map</span>(addNDVI)</span>
<span id="cb41-117"><a href="#cb41-117" tabindex="-1"></a>    <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">bounds</span>(geometry))</span>
<span id="cb41-118"><a href="#cb41-118" tabindex="-1"></a>  </span>
<span id="cb41-119"><a href="#cb41-119" tabindex="-1"></a>  <span class="kw">var</span> chart <span class="op">=</span> ui<span class="op">.</span><span class="at">Chart</span><span class="op">.</span><span class="at">image</span><span class="op">.</span><span class="fu">series</span>({</span>
<span id="cb41-120"><a href="#cb41-120" tabindex="-1"></a>    <span class="dt">imageCollection</span><span class="op">:</span> filtered<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;ndvi&#39;</span>)<span class="op">,</span></span>
<span id="cb41-121"><a href="#cb41-121" tabindex="-1"></a>    <span class="dt">region</span><span class="op">:</span> geometry<span class="op">,</span></span>
<span id="cb41-122"><a href="#cb41-122" tabindex="-1"></a>    <span class="dt">reducer</span><span class="op">:</span> ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">mean</span>()<span class="op">,</span></span>
<span id="cb41-123"><a href="#cb41-123" tabindex="-1"></a>    <span class="dt">scale</span><span class="op">:</span> <span class="dv">20</span>})<span class="op">.</span><span class="fu">setOptions</span>({</span>
<span id="cb41-124"><a href="#cb41-124" tabindex="-1"></a>      <span class="dt">title</span><span class="op">:</span> <span class="st">&#39;NDVI Time Series&#39;</span><span class="op">,</span></span>
<span id="cb41-125"><a href="#cb41-125" tabindex="-1"></a>      <span class="dt">vAxis</span><span class="op">:</span> {<span class="dt">title</span><span class="op">:</span> <span class="st">&#39;NDVI&#39;</span>}<span class="op">,</span></span>
<span id="cb41-126"><a href="#cb41-126" tabindex="-1"></a>      <span class="dt">hAxis</span><span class="op">:</span> {<span class="dt">title</span><span class="op">:</span> <span class="st">&#39;Date&#39;</span><span class="op">,</span> <span class="dt">gridlines</span><span class="op">:</span> {<span class="dt">count</span><span class="op">:</span> <span class="dv">12</span>}}<span class="op">,</span></span>
<span id="cb41-127"><a href="#cb41-127" tabindex="-1"></a>      <span class="dt">interpolateNulls</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb41-128"><a href="#cb41-128" tabindex="-1"></a>      <span class="dt">pointSize</span><span class="op">:</span> <span class="dv">2</span><span class="op">,</span></span>
<span id="cb41-129"><a href="#cb41-129" tabindex="-1"></a>      <span class="dt">lineWidth</span><span class="op">:</span> <span class="dv">1</span></span>
<span id="cb41-130"><a href="#cb41-130" tabindex="-1"></a>    })</span>
<span id="cb41-131"><a href="#cb41-131" tabindex="-1"></a>      </span>
<span id="cb41-132"><a href="#cb41-132" tabindex="-1"></a>  chartPanel<span class="op">.</span><span class="fu">clear</span>()</span>
<span id="cb41-133"><a href="#cb41-133" tabindex="-1"></a>  selectionPanel<span class="op">.</span><span class="fu">clear</span>()</span>
<span id="cb41-134"><a href="#cb41-134" tabindex="-1"></a>  downloadPanel<span class="op">.</span><span class="fu">clear</span>()</span>
<span id="cb41-135"><a href="#cb41-135" tabindex="-1"></a>  selectionPanel<span class="op">.</span><span class="fu">add</span>(ui<span class="op">.</span><span class="fu">Label</span>(<span class="st">&#39;Choose an image to display:&#39;</span>))</span>
<span id="cb41-136"><a href="#cb41-136" tabindex="-1"></a>  chartPanel<span class="op">.</span><span class="fu">add</span>(chart)</span>
<span id="cb41-137"><a href="#cb41-137" tabindex="-1"></a>  </span>
<span id="cb41-138"><a href="#cb41-138" tabindex="-1"></a>  <span class="co">// S2 collection has overlapping granules for same dates</span></span>
<span id="cb41-139"><a href="#cb41-139" tabindex="-1"></a>  <span class="co">// Add a &#39;date&#39; property so we can merge data for the same date</span></span>
<span id="cb41-140"><a href="#cb41-140" tabindex="-1"></a>  <span class="kw">var</span> filtered <span class="op">=</span> filtered<span class="op">.</span><span class="fu">map</span>(<span class="kw">function</span>(image) {</span>
<span id="cb41-141"><a href="#cb41-141" tabindex="-1"></a>    <span class="kw">var</span> dateString <span class="op">=</span> ee<span class="op">.</span><span class="fu">Date</span>(image<span class="op">.</span><span class="fu">date</span>())<span class="op">.</span><span class="fu">format</span>(<span class="st">&#39;YYYY-MM-dd&#39;</span>)</span>
<span id="cb41-142"><a href="#cb41-142" tabindex="-1"></a>    <span class="cf">return</span> image<span class="op">.</span><span class="fu">set</span>(<span class="st">&#39;date&#39;</span><span class="op">,</span> dateString)<span class="op">;</span></span>
<span id="cb41-143"><a href="#cb41-143" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb41-144"><a href="#cb41-144" tabindex="-1"></a>  </span>
<span id="cb41-145"><a href="#cb41-145" tabindex="-1"></a>  <span class="kw">var</span> addNdviLayer <span class="op">=</span> <span class="kw">function</span>(dateString) {</span>
<span id="cb41-146"><a href="#cb41-146" tabindex="-1"></a>    <span class="kw">var</span> date <span class="op">=</span> ee<span class="op">.</span><span class="at">Date</span><span class="op">.</span><span class="fu">parse</span>(<span class="st">&#39;YYYY-MM-dd&#39;</span><span class="op">,</span> dateString)</span>
<span id="cb41-147"><a href="#cb41-147" tabindex="-1"></a>    <span class="kw">var</span> image <span class="op">=</span> filtered</span>
<span id="cb41-148"><a href="#cb41-148" tabindex="-1"></a>      <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(date<span class="op">,</span> date<span class="op">.</span><span class="fu">advance</span>(<span class="dv">1</span><span class="op">,</span> <span class="st">&#39;day&#39;</span>)))</span>
<span id="cb41-149"><a href="#cb41-149" tabindex="-1"></a>      <span class="op">.</span><span class="fu">mosaic</span>()<span class="op">;</span></span>
<span id="cb41-150"><a href="#cb41-150" tabindex="-1"></a>    <span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;ndvi&#39;</span>)<span class="op">,</span> ndviVis<span class="op">,</span> <span class="st">&#39;NDVI Image -&#39;</span> <span class="op">+</span> dateString)</span>
<span id="cb41-151"><a href="#cb41-151" tabindex="-1"></a>  }</span>
<span id="cb41-152"><a href="#cb41-152" tabindex="-1"></a></span>
<span id="cb41-153"><a href="#cb41-153" tabindex="-1"></a>  <span class="kw">var</span> dates <span class="op">=</span> filtered<span class="op">.</span><span class="fu">aggregate_array</span>(<span class="st">&#39;date&#39;</span>)<span class="op">.</span><span class="fu">distinct</span>()<span class="op">;</span></span>
<span id="cb41-154"><a href="#cb41-154" tabindex="-1"></a>  </span>
<span id="cb41-155"><a href="#cb41-155" tabindex="-1"></a>  <span class="co">// Add dates to a dropdown selector</span></span>
<span id="cb41-156"><a href="#cb41-156" tabindex="-1"></a>  dates<span class="op">.</span><span class="fu">evaluate</span>(<span class="kw">function</span>(dateList){</span>
<span id="cb41-157"><a href="#cb41-157" tabindex="-1"></a>      selectionPanel<span class="op">.</span><span class="fu">add</span>(ui<span class="op">.</span><span class="fu">Select</span>({</span>
<span id="cb41-158"><a href="#cb41-158" tabindex="-1"></a>      <span class="dt">items</span><span class="op">:</span> dateList<span class="op">,</span></span>
<span id="cb41-159"><a href="#cb41-159" tabindex="-1"></a>      <span class="dt">onChange</span><span class="op">:</span> addNdviLayer<span class="op">,</span></span>
<span id="cb41-160"><a href="#cb41-160" tabindex="-1"></a>      <span class="dt">placeholder</span><span class="op">:</span> <span class="st">&#39;Select a date&#39;</span></span>
<span id="cb41-161"><a href="#cb41-161" tabindex="-1"></a>    }))</span>
<span id="cb41-162"><a href="#cb41-162" tabindex="-1"></a>    })</span>
<span id="cb41-163"><a href="#cb41-163" tabindex="-1"></a>    </span>
<span id="cb41-164"><a href="#cb41-164" tabindex="-1"></a>  <span class="co">// Extract the NDVI values as a FeatureCollection</span></span>
<span id="cb41-165"><a href="#cb41-165" tabindex="-1"></a>  <span class="kw">var</span> ndviFc <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(dates<span class="op">.</span><span class="fu">map</span>(<span class="kw">function</span>(dateString) {</span>
<span id="cb41-166"><a href="#cb41-166" tabindex="-1"></a>    <span class="kw">var</span> date <span class="op">=</span> ee<span class="op">.</span><span class="at">Date</span><span class="op">.</span><span class="fu">parse</span>(<span class="st">&#39;YYYY-MM-dd&#39;</span><span class="op">,</span> dateString)</span>
<span id="cb41-167"><a href="#cb41-167" tabindex="-1"></a>    <span class="kw">var</span> image <span class="op">=</span> filtered</span>
<span id="cb41-168"><a href="#cb41-168" tabindex="-1"></a>      <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(date<span class="op">,</span> date<span class="op">.</span><span class="fu">advance</span>(<span class="dv">1</span><span class="op">,</span> <span class="st">&#39;day&#39;</span>)))</span>
<span id="cb41-169"><a href="#cb41-169" tabindex="-1"></a>      <span class="op">.</span><span class="fu">mosaic</span>()<span class="op">;</span></span>
<span id="cb41-170"><a href="#cb41-170" tabindex="-1"></a>    </span>
<span id="cb41-171"><a href="#cb41-171" tabindex="-1"></a>    <span class="kw">var</span> ndviImage <span class="op">=</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;ndvi&#39;</span>)<span class="op">;</span></span>
<span id="cb41-172"><a href="#cb41-172" tabindex="-1"></a>    <span class="kw">var</span> stats <span class="op">=</span> ndviImage<span class="op">.</span><span class="fu">reduceRegion</span>({</span>
<span id="cb41-173"><a href="#cb41-173" tabindex="-1"></a>      <span class="dt">reducer</span><span class="op">:</span> ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">mean</span>()<span class="op">.</span><span class="fu">setOutputs</span>([<span class="st">&#39;ndvi&#39;</span>])<span class="op">,</span></span>
<span id="cb41-174"><a href="#cb41-174" tabindex="-1"></a>      <span class="dt">geometry</span><span class="op">:</span> geometry<span class="op">,</span></span>
<span id="cb41-175"><a href="#cb41-175" tabindex="-1"></a>      <span class="dt">scale</span><span class="op">:</span> <span class="dv">20</span></span>
<span id="cb41-176"><a href="#cb41-176" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb41-177"><a href="#cb41-177" tabindex="-1"></a>    <span class="co">// Add date as wel as lat/lon columns</span></span>
<span id="cb41-178"><a href="#cb41-178" tabindex="-1"></a>    <span class="kw">var</span> properties <span class="op">=</span> stats<span class="op">.</span><span class="fu">combine</span>({</span>
<span id="cb41-179"><a href="#cb41-179" tabindex="-1"></a>      <span class="st">&#39;date&#39;</span><span class="op">:</span> dateString<span class="op">,</span></span>
<span id="cb41-180"><a href="#cb41-180" tabindex="-1"></a>      <span class="st">&#39;longitude&#39;</span><span class="op">:</span> point[<span class="st">&#39;lon&#39;</span>]<span class="op">,</span></span>
<span id="cb41-181"><a href="#cb41-181" tabindex="-1"></a>      <span class="st">&#39;latitude&#39;</span><span class="op">:</span> point[<span class="st">&#39;lat&#39;</span>]</span>
<span id="cb41-182"><a href="#cb41-182" tabindex="-1"></a>    })</span>
<span id="cb41-183"><a href="#cb41-183" tabindex="-1"></a>    <span class="cf">return</span> ee<span class="op">.</span><span class="fu">Feature</span>(<span class="kw">null</span><span class="op">,</span> properties)<span class="op">;</span></span>
<span id="cb41-184"><a href="#cb41-184" tabindex="-1"></a>  }))<span class="op">;</span></span>
<span id="cb41-185"><a href="#cb41-185" tabindex="-1"></a>  </span>
<span id="cb41-186"><a href="#cb41-186" tabindex="-1"></a>  <span class="co">// Prepare the collection to download</span></span>
<span id="cb41-187"><a href="#cb41-187" tabindex="-1"></a>  <span class="kw">var</span> downloadReady <span class="op">=</span> <span class="kw">function</span>(url) {</span>
<span id="cb41-188"><a href="#cb41-188" tabindex="-1"></a>    <span class="kw">var</span> label <span class="op">=</span> ui<span class="op">.</span><span class="fu">Label</span>({</span>
<span id="cb41-189"><a href="#cb41-189" tabindex="-1"></a>      <span class="dt">value</span><span class="op">:</span> <span class="st">&#39;Download CSV&#39;</span><span class="op">,</span></span>
<span id="cb41-190"><a href="#cb41-190" tabindex="-1"></a>      <span class="dt">targetUrl</span><span class="op">:</span> url})</span>
<span id="cb41-191"><a href="#cb41-191" tabindex="-1"></a>    downloadPanel<span class="op">.</span><span class="fu">add</span>(label)<span class="op">;</span></span>
<span id="cb41-192"><a href="#cb41-192" tabindex="-1"></a>  }</span>
<span id="cb41-193"><a href="#cb41-193" tabindex="-1"></a>  ndviFc<span class="op">.</span><span class="fu">getDownloadURL</span>({</span>
<span id="cb41-194"><a href="#cb41-194" tabindex="-1"></a>    <span class="dt">format</span><span class="op">:</span> <span class="st">&#39;CSV&#39;</span><span class="op">,</span></span>
<span id="cb41-195"><a href="#cb41-195" tabindex="-1"></a>    <span class="dt">selectors</span><span class="op">:</span> [<span class="st">&#39;date&#39;</span><span class="op">,</span> <span class="st">&#39;latitude&#39;</span><span class="op">,</span> <span class="st">&#39;longitude&#39;</span><span class="op">,</span> <span class="st">&#39;ndvi&#39;</span>]<span class="op">,</span></span>
<span id="cb41-196"><a href="#cb41-196" tabindex="-1"></a>    <span class="dt">filename</span><span class="op">:</span> <span class="st">&#39;ndvi_time_series&#39;</span><span class="op">,</span> </span>
<span id="cb41-197"><a href="#cb41-197" tabindex="-1"></a>    <span class="dt">callback</span><span class="op">:</span> downloadReady})</span>
<span id="cb41-198"><a href="#cb41-198" tabindex="-1"></a></span>
<span id="cb41-199"><a href="#cb41-199" tabindex="-1"></a><span class="co">//});</span></span>
<span id="cb41-200"><a href="#cb41-200" tabindex="-1"></a></span>
<span id="cb41-201"><a href="#cb41-201" tabindex="-1"></a>}</span>
<span id="cb41-202"><a href="#cb41-202" tabindex="-1"></a><span class="co">// Call the function to build the initial UI state.</span></span>
<span id="cb41-203"><a href="#cb41-203" tabindex="-1"></a><span class="fu">resetEverything</span>()<span class="op">;</span></span></code></pre></div>
</div>
<div id="app-with-layer-control" class="section level2">
<h2>App with Layer Control</h2>
<p>We can use the <code>ui.CheckBox()</code> widget along with
<code>ui.Map.Layer()</code> objects to build a custom layer control that
allows users to select which layers are visible on the map.</p>
<p><a
href="https://code.earthengine.google.co.in/?scriptPath=users%2Fujavalgandhi%2FEnd-to-End-GEE%3ASupplement%2FUI_Widgets_and_Apps%2FApp_with_Layer_Control"
target="_blank">Open in Code Editor ↗</a></p>
<div class="sourceCode" id="cb42"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb42-1"><a href="#cb42-1" tabindex="-1"></a><span class="co">// Example script showing how to control layers</span></span>
<span id="cb42-2"><a href="#cb42-2" tabindex="-1"></a><span class="co">// in EE Apps</span></span>
<span id="cb42-3"><a href="#cb42-3" tabindex="-1"></a><span class="kw">var</span> mainPanel <span class="op">=</span> ui<span class="op">.</span><span class="fu">Panel</span>({</span>
<span id="cb42-4"><a href="#cb42-4" tabindex="-1"></a>  <span class="dt">style</span><span class="op">:</span> {<span class="dt">width</span><span class="op">:</span> <span class="st">&#39;300px&#39;</span>}</span>
<span id="cb42-5"><a href="#cb42-5" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb42-6"><a href="#cb42-6" tabindex="-1"></a></span>
<span id="cb42-7"><a href="#cb42-7" tabindex="-1"></a><span class="kw">var</span> title <span class="op">=</span> ui<span class="op">.</span><span class="fu">Label</span>({</span>
<span id="cb42-8"><a href="#cb42-8" tabindex="-1"></a>  <span class="dt">value</span><span class="op">:</span> <span class="st">&#39;App with Layer Control&#39;</span><span class="op">,</span></span>
<span id="cb42-9"><a href="#cb42-9" tabindex="-1"></a>  <span class="dt">style</span><span class="op">:</span> {<span class="st">&#39;fontSize&#39;</span><span class="op">:</span> <span class="st">&#39;24px&#39;</span>}</span>
<span id="cb42-10"><a href="#cb42-10" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb42-11"><a href="#cb42-11" tabindex="-1"></a>mainPanel<span class="op">.</span><span class="fu">add</span>(title)<span class="op">;</span></span>
<span id="cb42-12"><a href="#cb42-12" tabindex="-1"></a></span>
<span id="cb42-13"><a href="#cb42-13" tabindex="-1"></a><span class="co">// Create our own layer control</span></span>
<span id="cb42-14"><a href="#cb42-14" tabindex="-1"></a><span class="kw">var</span> layerControlPanel <span class="op">=</span> ui<span class="op">.</span><span class="fu">Panel</span>()<span class="op">;</span></span>
<span id="cb42-15"><a href="#cb42-15" tabindex="-1"></a><span class="kw">var</span> label <span class="op">=</span> ui<span class="op">.</span><span class="fu">Label</span>(<span class="st">&#39;Layers&#39;</span>)<span class="op">;</span></span>
<span id="cb42-16"><a href="#cb42-16" tabindex="-1"></a>layerControlPanel<span class="op">.</span><span class="fu">add</span>(label)<span class="op">;</span></span>
<span id="cb42-17"><a href="#cb42-17" tabindex="-1"></a></span>
<span id="cb42-18"><a href="#cb42-18" tabindex="-1"></a><span class="kw">var</span> checkBoxLayer1 <span class="op">=</span> ui<span class="op">.</span><span class="fu">Checkbox</span>({<span class="dt">label</span><span class="op">:</span> <span class="st">&#39;2020&#39;</span>})<span class="op">;</span></span>
<span id="cb42-19"><a href="#cb42-19" tabindex="-1"></a><span class="kw">var</span> checkBoxLayer2 <span class="op">=</span> ui<span class="op">.</span><span class="fu">Checkbox</span>({<span class="dt">label</span><span class="op">:</span> <span class="st">&#39;2021&#39;</span>})<span class="op">;</span></span>
<span id="cb42-20"><a href="#cb42-20" tabindex="-1"></a></span>
<span id="cb42-21"><a href="#cb42-21" tabindex="-1"></a>layerControlPanel<span class="op">.</span><span class="fu">add</span>(checkBoxLayer1)<span class="op">;</span></span>
<span id="cb42-22"><a href="#cb42-22" tabindex="-1"></a>layerControlPanel<span class="op">.</span><span class="fu">add</span>(checkBoxLayer2)<span class="op">;</span></span>
<span id="cb42-23"><a href="#cb42-23" tabindex="-1"></a>mainPanel<span class="op">.</span><span class="fu">add</span>(layerControlPanel)<span class="op">;</span></span>
<span id="cb42-24"><a href="#cb42-24" tabindex="-1"></a><span class="co">// Add our split panel to the root panel.</span></span>
<span id="cb42-25"><a href="#cb42-25" tabindex="-1"></a>ui<span class="op">.</span><span class="at">root</span><span class="op">.</span><span class="fu">add</span>(mainPanel)<span class="op">;</span></span>
<span id="cb42-26"><a href="#cb42-26" tabindex="-1"></a></span>
<span id="cb42-27"><a href="#cb42-27" tabindex="-1"></a><span class="co">// Load ESA WorldCover Classification</span></span>
<span id="cb42-28"><a href="#cb42-28" tabindex="-1"></a><span class="kw">var</span> classification2020 <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&quot;ESA/WorldCover/v100&quot;</span>)<span class="op">.</span><span class="fu">first</span>()<span class="op">;</span></span>
<span id="cb42-29"><a href="#cb42-29" tabindex="-1"></a><span class="kw">var</span> classification2021 <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&quot;ESA/WorldCover/v200&quot;</span>)<span class="op">.</span><span class="fu">first</span>()<span class="op">;</span></span>
<span id="cb42-30"><a href="#cb42-30" tabindex="-1"></a></span>
<span id="cb42-31"><a href="#cb42-31" tabindex="-1"></a><span class="co">// Create the layers with the visibility off</span></span>
<span id="cb42-32"><a href="#cb42-32" tabindex="-1"></a><span class="kw">var</span> layer2020 <span class="op">=</span> ui<span class="op">.</span><span class="at">Map</span><span class="op">.</span><span class="fu">Layer</span>(classification2020<span class="op">,</span> {}<span class="op">,</span> <span class="st">&#39;2020&#39;</span><span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span></span>
<span id="cb42-33"><a href="#cb42-33" tabindex="-1"></a><span class="kw">var</span> layer2021 <span class="op">=</span> ui<span class="op">.</span><span class="at">Map</span><span class="op">.</span><span class="fu">Layer</span>(classification2021<span class="op">,</span> {}<span class="op">,</span> <span class="st">&#39;2021&#39;</span><span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span></span>
<span id="cb42-34"><a href="#cb42-34" tabindex="-1"></a></span>
<span id="cb42-35"><a href="#cb42-35" tabindex="-1"></a><span class="co">// Add layers to the map</span></span>
<span id="cb42-36"><a href="#cb42-36" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">add</span>(layer2020)<span class="op">;</span></span>
<span id="cb42-37"><a href="#cb42-37" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">add</span>(layer2021)<span class="op">;</span></span>
<span id="cb42-38"><a href="#cb42-38" tabindex="-1"></a></span>
<span id="cb42-39"><a href="#cb42-39" tabindex="-1"></a><span class="co">// Configure the checkboxes to control the visiblity</span></span>
<span id="cb42-40"><a href="#cb42-40" tabindex="-1"></a>checkBoxLayer1<span class="op">.</span><span class="fu">onChange</span>(<span class="kw">function</span>(checked){</span>
<span id="cb42-41"><a href="#cb42-41" tabindex="-1"></a>  layer2020<span class="op">.</span><span class="fu">setShown</span>(checked)<span class="op">;</span></span>
<span id="cb42-42"><a href="#cb42-42" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb42-43"><a href="#cb42-43" tabindex="-1"></a></span>
<span id="cb42-44"><a href="#cb42-44" tabindex="-1"></a>checkBoxLayer2<span class="op">.</span><span class="fu">onChange</span>(<span class="kw">function</span>(checked){</span>
<span id="cb42-45"><a href="#cb42-45" tabindex="-1"></a>  layer2021<span class="op">.</span><span class="fu">setShown</span>(checked)<span class="op">;</span></span>
<span id="cb42-46"><a href="#cb42-46" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb42-47"><a href="#cb42-47" tabindex="-1"></a></span>
<span id="cb42-48"><a href="#cb42-48" tabindex="-1"></a><span class="co">// Remove the default layers control from the map</span></span>
<span id="cb42-49"><a href="#cb42-49" tabindex="-1"></a><span class="co">// as we have our custom control</span></span>
<span id="cb42-50"><a href="#cb42-50" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">setControlVisibility</span>({<span class="dt">layerList</span><span class="op">:</span> <span class="kw">false</span>})<span class="op">;</span></span>
<span id="cb42-51"><a href="#cb42-51" tabindex="-1"></a></span>
<span id="cb42-52"><a href="#cb42-52" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">setCenter</span>(<span class="fl">76.43</span><span class="op">,</span> <span class="fl">12.41</span><span class="op">,</span> <span class="dv">12</span>)<span class="op">;</span></span></code></pre></div>
</div>
</div>
<div id="code-sharing-and-script-modules" class="section level1">
<h1>Code Sharing and Script Modules</h1>
<p>As your Earth Engine project grows, you need a way to organize and
share your code to collaborate with others. We will learn some best
practices on how best to set-up your project in Earth Engine.</p>
<div id="sharing-a-single-script" class="section level2">
<h2>Sharing a Single Script</h2>
<p>To share your code from a single script, you need to use the
<strong>Get Link</strong> button in the code editor. As you click the
button, the contents of your code editor is captured and encoded into a
URL. When you share this URL with someone, they will be able see same
content as your code editor. This is a great way to send a snapshot of
your code so others can reproduce your output. Remember that the script
links are just snapshots, if you change your code after sending the link
to someone, they will not see the updates.</p>
<blockquote>
<p>When trying to send someone a link, do NOT click the <em>Copy Script
Path</em> button. Sending this path to someone will NOT give them access
to your code. The script path only works only on public or shared
repositories.</p>
</blockquote>
<div class="figure" style="text-align: center">
<img src="images/end_to_end_gee/get_link.png" alt="Code Sharing using Get Link button" width="75%" />
<p class="caption">
Code Sharing using Get Link button
</p>
</div>
<p>While sharing the script using <em>Get Link</em>, you should also
share any private <strong>Assets</strong> that you may have uploaded and
are using in the script. You can share the asset with a specific email
address, or check the <em>Anyone can read</em> box if you want anyone
with the script link to be able to access it. Failing to do so will
prevent others from running your script.</p>
<div class="figure" style="text-align: center">
<img src="images/end_to_end_gee/sharing_assets.png" alt="Sharing Uploaded Assets" width="75%" />
<p class="caption">
Sharing Uploaded Assets
</p>
</div>
<p>Learn more in the <a
href="https://developers.google.com/earth-engine/guides/playground#get-link">Script
links</a> section of the Google Earth Engine User Guide.</p>
</div>
<div id="sharing-multiple-scripts" class="section level2">
<h2>Sharing Multiple Scripts</h2>
<p>If you want to share a collection of scripts with other users or your
collaborators, the best way is to create a new
<strong>Repository</strong>.</p>
<div class="figure" style="text-align: center">
<img src="images/end_to_end_gee/new_repository.png" alt="Creating New Repository" width="40%" />
<p class="caption">
Creating New Repository
</p>
</div>
<p>You can put multiple scripts within the repository and share the
repository with other users. You can grant them <strong>Reader</strong>
or <strong>Writer</strong> access so they can view/add/modify/delete
scripts in that repository. If you want to make it readable by
<strong>Public</strong>, you can check the <em>Anyone can read</em>
option. You will see a URL in the form of
<code>https://code.earthengine.google.co.in/?accept_repo=...</code>.
When you share this URL with other users and they visit that link, your
repository will be added to their Code Editor under the <em>Reader</em>
or <em>Writer</em> folder depending on their access.</p>
<div class="figure" style="text-align: center">
<img src="images/end_to_end_gee/sharing_repository.png" alt="Creating New Repository" width="75%" />
<p class="caption">
Creating New Repository
</p>
</div>
<p>Learn more in the <a
href="https://developers.google.com/earth-engine/guides/playground#script-manager-scripts-tab">Script
Manager</a> section of the Google Earth Engine User Guide.</p>
</div>
<div id="sharing-code-between-scripts" class="section level2">
<h2>Sharing Code between Scripts</h2>
<p>For a large project, it is preferable to share commonly used
functions between scripts. That way, each script doesn’t have to
re-implement the same code. Earth Engine enables this using
<strong>Script Modules</strong>. Using a special object called
<code>exports</code>, you can expose a function to other scripts. Learn
more in the <a
href="https://developers.google.com/earth-engine/guides/playground#script-modules">Script
modules</a> section of the Google Earth Engine User Guide.</p>
<p>There are many Earth Engine users who have shared their repositories
publicly and written script modules to perform a variety of tasks.
Here’s an example of using the <code>grid</code> module from the
<code>users/gena/packages</code> repository to create regularly spaced
grids in Earth Engine.</p>
<div class="figure" style="text-align: center">
<img src="images/end_to_end_gee/script_modules.png" alt="Using a function from a script module" width="100%" />
<p class="caption">
Using a function from a script module
</p>
</div>
<p><a
href="https://code.earthengine.google.co.in/?accept_repo=users%2Fujavalgandhi%2FEnd-to-End-GEE&amp;scriptPath=users%2Fujavalgandhi%2FEnd-to-End-GEE%3ASupplement%2FMiscellaneous%2FCode_Sharing_and_Script_Modules"
target="_blank">Open in Code Editor ↗</a></p>
<div class="sourceCode" id="cb43"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb43-1"><a href="#cb43-1" tabindex="-1"></a><span class="kw">var</span> karnataka <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">&quot;users/ujavalgandhi/public/karnataka&quot;</span>)<span class="op">;</span></span>
<span id="cb43-2"><a href="#cb43-2" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(karnataka<span class="op">,</span> {<span class="dt">color</span><span class="op">:</span> <span class="st">&#39;gray&#39;</span>}<span class="op">,</span> <span class="st">&#39;State Boundary&#39;</span>)</span>
<span id="cb43-3"><a href="#cb43-3" tabindex="-1"></a><span class="kw">var</span> bounds <span class="op">=</span> karnataka<span class="op">.</span><span class="fu">geometry</span>()<span class="op">.</span><span class="fu">bounds</span>()</span>
<span id="cb43-4"><a href="#cb43-4" tabindex="-1"></a><span class="kw">var</span> coords <span class="op">=</span> ee<span class="op">.</span><span class="fu">List</span>(bounds<span class="op">.</span><span class="fu">coordinates</span>()<span class="op">.</span><span class="fu">get</span>(<span class="dv">0</span>))</span>
<span id="cb43-5"><a href="#cb43-5" tabindex="-1"></a><span class="kw">var</span> xmin <span class="op">=</span> ee<span class="op">.</span><span class="fu">List</span>(coords<span class="op">.</span><span class="fu">get</span>(<span class="dv">0</span>))<span class="op">.</span><span class="fu">get</span>(<span class="dv">0</span>)</span>
<span id="cb43-6"><a href="#cb43-6" tabindex="-1"></a><span class="kw">var</span> ymin <span class="op">=</span> ee<span class="op">.</span><span class="fu">List</span>(coords<span class="op">.</span><span class="fu">get</span>(<span class="dv">0</span>))<span class="op">.</span><span class="fu">get</span>(<span class="dv">1</span>)</span>
<span id="cb43-7"><a href="#cb43-7" tabindex="-1"></a><span class="kw">var</span> xmax <span class="op">=</span> ee<span class="op">.</span><span class="fu">List</span>(coords<span class="op">.</span><span class="fu">get</span>(<span class="dv">2</span>))<span class="op">.</span><span class="fu">get</span>(<span class="dv">0</span>)</span>
<span id="cb43-8"><a href="#cb43-8" tabindex="-1"></a><span class="kw">var</span> ymax <span class="op">=</span> ee<span class="op">.</span><span class="fu">List</span>(coords<span class="op">.</span><span class="fu">get</span>(<span class="dv">2</span>))<span class="op">.</span><span class="fu">get</span>(<span class="dv">1</span>)</span>
<span id="cb43-9"><a href="#cb43-9" tabindex="-1"></a><span class="co">// source code for the grid package:</span></span>
<span id="cb43-10"><a href="#cb43-10" tabindex="-1"></a><span class="co">// https://code.earthengine.google.com/?accept_repo=users/gena/packages</span></span>
<span id="cb43-11"><a href="#cb43-11" tabindex="-1"></a></span>
<span id="cb43-12"><a href="#cb43-12" tabindex="-1"></a><span class="co">// Import the module to our script using &#39;require&#39;</span></span>
<span id="cb43-13"><a href="#cb43-13" tabindex="-1"></a><span class="kw">var</span> gridModule <span class="op">=</span> <span class="pp">require</span>(<span class="st">&#39;users/gena/packages:grid&#39;</span>)</span>
<span id="cb43-14"><a href="#cb43-14" tabindex="-1"></a></span>
<span id="cb43-15"><a href="#cb43-15" tabindex="-1"></a><span class="co">// Now we can run any function from the module</span></span>
<span id="cb43-16"><a href="#cb43-16" tabindex="-1"></a><span class="co">// We try running the generateGrid function to create regularly spaced vector grid</span></span>
<span id="cb43-17"><a href="#cb43-17" tabindex="-1"></a><span class="co">// generateGrid(xmin, ymin, xmax, ymax, dx, dy, marginx, marginy, opt_proj)</span></span>
<span id="cb43-18"><a href="#cb43-18" tabindex="-1"></a></span>
<span id="cb43-19"><a href="#cb43-19" tabindex="-1"></a><span class="kw">var</span> spacing <span class="op">=</span> <span class="fl">0.5</span></span>
<span id="cb43-20"><a href="#cb43-20" tabindex="-1"></a><span class="kw">var</span> gridVector <span class="op">=</span> gridModule<span class="op">.</span><span class="fu">generateGrid</span>(xmin<span class="op">,</span> ymin<span class="op">,</span> xmax<span class="op">,</span> ymax<span class="op">,</span> spacing<span class="op">,</span> spacing<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span>)</span>
<span id="cb43-21"><a href="#cb43-21" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">centerObject</span>(gridVector)</span>
<span id="cb43-22"><a href="#cb43-22" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(gridVector<span class="op">,</span> {<span class="dt">color</span><span class="op">:</span> <span class="st">&#39;blue&#39;</span>}<span class="op">,</span> <span class="st">&#39;Grids&#39;</span>)</span></code></pre></div>
<div style="page-break-after: always;"></div>
</div>
</div>
<div id="license" class="section level1">
<h1>License</h1>
<p>The course material (text, images, presentation, videos) is licensed
under a <a href="https://creativecommons.org/licenses/by/4.0/">Creative
Commons Attribution 4.0 International License</a>.</p>
<p>The code (scripts, Jupyter notebooks) is licensed under the MIT
License. For a copy, see <a href="https://opensource.org/licenses/MIT"
class="uri">https://opensource.org/licenses/MIT</a></p>
<p>Kindly give appropriate credit to the original author as below:</p>
<p>Copyright © 2022 Ujaval Gandhi <a
href="https://spatialthoughts.com">www.spatialthoughts.com</a></p>
</div>
<div id="citing-and-referencing" class="section level1">
<h1>Citing and Referencing</h1>
<p>You can cite the course materials as follows</p>
<ul>
<li>Gandhi, Ujaval, 2021. <em>End-to-End Google Earth Engine</em>
Course. Spatial Thoughts. <a
href="https://courses.spatialthoughts.com/end-to-end-gee.html"
class="uri">https://courses.spatialthoughts.com/end-to-end-gee.html</a></li>
</ul>
<hr />
<p><strong>This course is offered as an instructor-led online class.
Visit <a href="https://spatialthoughts.com/events/">Spatial Thoughts</a>
to know details of upcoming sessions.</strong></p>
</div>

<!-- Comment Section Powered by utterances -->
<div id="comments">
  <hr />
  <p>If you want to report any issues with this page, please comment below.</p>
<script src="https://utteranc.es/client.js"
        repo="spatialthoughts/courses"
        issue-term="title"
        label="comment"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>
</div>



</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.odd').parent('tbody').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open');
  });
});
</script>

<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
