<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />


<meta name="author" content="Ujaval Gandhi" />


<title>Google Earth Engine for Water Resources Management (Supplementary Course)</title>

<script src="site_libs/header-attrs-2.10/header-attrs.js"></script>
<script src="site_libs/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/flatly.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<style>h1 {font-size: 34px;}
       h1.title {font-size: 38px;}
       h2 {font-size: 30px;}
       h3 {font-size: 24px;}
       h4 {font-size: 18px;}
       h5 {font-size: 16px;}
       h6 {font-size: 12px;}
       code {color: inherit; background-color: rgba(0, 0, 0, 0.04);}
       pre:not([class]) { background-color: white }</style>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<link href="site_libs/pagedtable-1.1/css/pagedtable.css" rel="stylesheet" />
<script src="site_libs/pagedtable-1.1/js/pagedtable.js"></script>
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-PDGF11RK4Z"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-PDGF11RK4Z');
</script>

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>


<style type="text/css">
  code {
    white-space: pre;
  }
  .sourceCode {
    overflow: visible;
  }
</style>
<style type="text/css" data-origin="pandoc">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */

</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    for (var j = 0; j < rules.length; j++) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") continue;
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') continue;
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>







<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
pre code {
  padding: 0;
}
</style>


<style type="text/css">
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #adb5bd;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script type="text/javascript">
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.tab('show');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');

  // Navbar adjustments
  var navHeight = $(".navbar").first().height() + 15;
  var style = document.createElement('style');
  var pt = "padding-top: " + navHeight + "px; ";
  var mt = "margin-top: -" + navHeight + "px; ";
  var css = "";
  // offset scroll position for anchor links (for fixed navbar)
  for (var i = 1; i <= 6; i++) {
    css += ".section h" + i + "{ " + pt + mt + "}\n";
  }
  style.innerHTML = "body {" + pt + "padding-bottom: 40px; }\n" + css;
  document.head.appendChild(style);
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "&#xe258;";
  border: none;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->




</head>

<body>


<div class="container-fluid main-container">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">Courses</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="http://spatialthoughts.com">Back to Main Site</a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li>
  <a href="#">Back to Top</a>
</li>
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div id="header">



<h1 class="title toc-ignore">Google Earth Engine for Water Resources
Management (Supplementary Course)</h1>
<h4 class="author">Ujaval Gandhi</h4>

</div>

<div id="TOC">
<ul>
<li><a href="#introduction" id="toc-introduction">Introduction</a></li>
<li><a href="#drought-monitoring" id="toc-drought-monitoring">Drought
Monitoring</a>
<ul>
<li><a href="#modis-tci" id="toc-modis-tci">MODIS TCI</a></li>
<li><a href="#modis-16-day-vci" id="toc-modis-16-day-vci">MODIS 16-Day
VCI</a></li>
<li><a href="#pie-chart-group-statistics"
id="toc-pie-chart-group-statistics">Pie Chart Group Statistics</a></li>
</ul></li>
<li><a href="#hydrology" id="toc-hydrology">Hydrology</a>
<ul>
<li><a href="#chart-cumulative-rainfall"
id="toc-chart-cumulative-rainfall">Chart Cumulative Rainfall</a></li>
<li><a href="#exporting-country-wide-precipitation-rasters"
id="toc-exporting-country-wide-precipitation-rasters">Exporting
Country-wide Precipitation Rasters</a></li>
<li><a href="#exporting-pixel-values-as-shapefiles"
id="toc-exporting-pixel-values-as-shapefiles">Exporting Pixel Values as
Shapefiles</a></li>
<li><a href="#extracting-precipitation-time-series-at-each-pixel"
id="toc-extracting-precipitation-time-series-at-each-pixel">Extracting
Precipitation Time-Series at Each Pixel</a></li>
<li><a href="#gpm-precipitation-time-series"
id="toc-gpm-precipitation-time-series">GPM Precipitation Time
Series</a></li>
<li><a href="#imd-number-of-rainy-days"
id="toc-imd-number-of-rainy-days">IMD Number of Rainy Days</a></li>
</ul></li>
<li><a href="#surface-water" id="toc-surface-water">Surface Water</a>
<ul>
<li><a href="#animating-surface-water-changes"
id="toc-animating-surface-water-changes">Animating Surface Water
Changes</a></li>
<li><a href="#detecting-algal-blooms"
id="toc-detecting-algal-blooms">Detecting Algal Blooms</a></li>
<li><a href="#detect-first-year-of-water"
id="toc-detect-first-year-of-water">Detect First Year of Water</a></li>
<li><a href="#otsu-dynamic-thresholding"
id="toc-otsu-dynamic-thresholding">Otsu Dynamic Thresholding</a></li>
<li><a href="#smoothing-vectors" id="toc-smoothing-vectors">Smoothing
Vectors</a></li>
<li><a href="#surface-water-explorer-split-panel-app"
id="toc-surface-water-explorer-split-panel-app">Surface Water Explorer
Split Panel App</a></li>
<li><a href="#unsupervised-clustering"
id="toc-unsupervised-clustering">Unsupervised Clustering</a></li>
<li><a href="#dynamic-world-water-detection"
id="toc-dynamic-world-water-detection">Dynamic World Water
Detection</a></li>
</ul></li>
<li><a href="#sar" id="toc-sar">SAR</a>
<ul>
<li><a href="#sentinel-1-ard-pre-processing"
id="toc-sentinel-1-ard-pre-processing">Sentinel-1 ARD
Pre-Processing</a></li>
<li><a href="#sar-water-detection" id="toc-sar-water-detection">SAR
Water Detection</a></li>
</ul></li>
<li><a href="#time-series-analysis" id="toc-time-series-analysis">Time
Series Analysis</a>
<ul>
<li><a href="#mann-kendall-test" id="toc-mann-kendall-test">Mann Kendall
Test</a></li>
</ul></li>
<li><a href="#license" id="toc-license">License</a></li>
<li><a href="#citing-and-referencing"
id="toc-citing-and-referencing">Citing and Referencing</a></li>
</ul>
</div>

<div style="page-break-after: always;"></div>
<hr />
<p><img src="images/spatial_thoughts_logo.png" width="250pt" style="display: block; margin: auto;" /></p>
<hr />
<div style="page-break-after: always;"></div>
<div id="introduction" class="section level1">
<h1>Introduction</h1>
<p>This page contains Supplementary Materials for the Google Earth
Engine for Water Resources Management course. It is a collection useful
scripts and code snippets that can be adapted for your projects.</p>
<p>Please visit the <a
href="https://courses.spatialthoughts.com/gee-water-resources-management.html">Google
Earth Engine for Water Resources Management</a> course page for the full
course material.</p>
</div>
<div id="drought-monitoring" class="section level1">
<h1>Drought Monitoring</h1>
<div id="modis-tci" class="section level2">
<h2>MODIS TCI</h2>
<p>This script is adaptation of our <a
href="https://courses.spatialthoughts.com/gee-water-resources-management.html#calculate-vci">Vegetation
Condition Index (VCI)</a> script to calculate Temperature Condition
Index (TCI) using MODIS LST dataset. This is helpful in calculation of
Vegetation Health Index (VHI) which is an index that is an average of
VCI and TCI.</p>
<p><a
href="https://code.earthengine.google.co.in/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3ASupplement%2FDrought_Monitoring%2FMODIS_TCI"
target="_blank">Open in Code Editor ↗</a></p>
<div class="sourceCode" id="cb1"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="co">// Example script showing how to calculate </span></span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a><span class="co">// Temperature Condition Index (TCI)</span></span>
<span id="cb1-3"><a href="#cb1-3" tabindex="-1"></a><span class="co">// Implemented using the MODIS LST data with the following formula</span></span>
<span id="cb1-4"><a href="#cb1-4" tabindex="-1"></a><span class="co">// TCI = 100 * (LSTmax - LST) / (LSTmax – LSTmin)</span></span>
<span id="cb1-5"><a href="#cb1-5" tabindex="-1"></a></span>
<span id="cb1-6"><a href="#cb1-6" tabindex="-1"></a><span class="co">// Use MODIS 8-Day Global 1km LST dataset</span></span>
<span id="cb1-7"><a href="#cb1-7" tabindex="-1"></a><span class="kw">var</span> modisLST <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&#39;MODIS/061/MOD11A2&#39;</span>)<span class="op">;</span></span>
<span id="cb1-8"><a href="#cb1-8" tabindex="-1"></a></span>
<span id="cb1-9"><a href="#cb1-9" tabindex="-1"></a><span class="kw">var</span> startYear <span class="op">=</span> <span class="dv">2010</span></span>
<span id="cb1-10"><a href="#cb1-10" tabindex="-1"></a><span class="kw">var</span> endYear <span class="op">=</span> <span class="dv">2020</span></span>
<span id="cb1-11"><a href="#cb1-11" tabindex="-1"></a><span class="kw">var</span> startDate <span class="op">=</span> ee<span class="op">.</span><span class="at">Date</span><span class="op">.</span><span class="fu">fromYMD</span>(startYear<span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">1</span>)</span>
<span id="cb1-12"><a href="#cb1-12" tabindex="-1"></a><span class="kw">var</span> endDate <span class="op">=</span> ee<span class="op">.</span><span class="at">Date</span><span class="op">.</span><span class="fu">fromYMD</span>(endYear<span class="op">,</span> <span class="dv">12</span><span class="op">,</span> <span class="dv">31</span>)</span>
<span id="cb1-13"><a href="#cb1-13" tabindex="-1"></a><span class="kw">var</span> filtered <span class="op">=</span> modisLST<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(startDate<span class="op">,</span> endDate))</span>
<span id="cb1-14"><a href="#cb1-14" tabindex="-1"></a></span>
<span id="cb1-15"><a href="#cb1-15" tabindex="-1"></a><span class="co">// Apply QA Mask to select only the highest quality pixels</span></span>
<span id="cb1-16"><a href="#cb1-16" tabindex="-1"></a></span>
<span id="cb1-17"><a href="#cb1-17" tabindex="-1"></a><span class="kw">var</span> bitwiseExtract <span class="op">=</span> <span class="kw">function</span>(input<span class="op">,</span> fromBit<span class="op">,</span> toBit) {</span>
<span id="cb1-18"><a href="#cb1-18" tabindex="-1"></a>  <span class="kw">var</span> maskSize <span class="op">=</span> ee<span class="op">.</span><span class="fu">Number</span>(<span class="dv">1</span>)<span class="op">.</span><span class="fu">add</span>(toBit)<span class="op">.</span><span class="fu">subtract</span>(fromBit)</span>
<span id="cb1-19"><a href="#cb1-19" tabindex="-1"></a>  <span class="kw">var</span> mask <span class="op">=</span> ee<span class="op">.</span><span class="fu">Number</span>(<span class="dv">1</span>)<span class="op">.</span><span class="fu">leftShift</span>(maskSize)<span class="op">.</span><span class="fu">subtract</span>(<span class="dv">1</span>)</span>
<span id="cb1-20"><a href="#cb1-20" tabindex="-1"></a>  <span class="cf">return</span> input<span class="op">.</span><span class="fu">rightShift</span>(fromBit)<span class="op">.</span><span class="fu">bitwiseAnd</span>(mask)</span>
<span id="cb1-21"><a href="#cb1-21" tabindex="-1"></a>}</span>
<span id="cb1-22"><a href="#cb1-22" tabindex="-1"></a><span class="kw">var</span> applyQaMask <span class="op">=</span> <span class="kw">function</span>(image) {</span>
<span id="cb1-23"><a href="#cb1-23" tabindex="-1"></a>  <span class="kw">var</span> lstDay <span class="op">=</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;LST_Day_1km&#39;</span>)</span>
<span id="cb1-24"><a href="#cb1-24" tabindex="-1"></a>  <span class="kw">var</span> qcDay <span class="op">=</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;QC_Day&#39;</span>)</span>
<span id="cb1-25"><a href="#cb1-25" tabindex="-1"></a>  <span class="kw">var</span> qaMask <span class="op">=</span> <span class="fu">bitwiseExtract</span>(qcDay<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">1</span>)<span class="op">.</span><span class="fu">eq</span>(<span class="dv">0</span>) <span class="co">// Highest quality</span></span>
<span id="cb1-26"><a href="#cb1-26" tabindex="-1"></a>  <span class="kw">var</span> dataQualityMask <span class="op">=</span> <span class="fu">bitwiseExtract</span>(qcDay<span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">3</span>)<span class="op">.</span><span class="fu">eq</span>(<span class="dv">0</span>)</span>
<span id="cb1-27"><a href="#cb1-27" tabindex="-1"></a>  <span class="kw">var</span> lstErrorMask <span class="op">=</span> <span class="fu">bitwiseExtract</span>(qcDay<span class="op">,</span> <span class="dv">6</span><span class="op">,</span> <span class="dv">7</span>)<span class="op">.</span><span class="fu">eq</span>(<span class="dv">0</span>)</span>
<span id="cb1-28"><a href="#cb1-28" tabindex="-1"></a>  <span class="kw">var</span> mask <span class="op">=</span> qaMask<span class="op">.</span><span class="fu">and</span>(dataQualityMask)<span class="op">.</span><span class="fu">and</span>(lstErrorMask)</span>
<span id="cb1-29"><a href="#cb1-29" tabindex="-1"></a>  <span class="cf">return</span> lstDay<span class="op">.</span><span class="fu">updateMask</span>(mask)</span>
<span id="cb1-30"><a href="#cb1-30" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb1-31"><a href="#cb1-31" tabindex="-1"></a><span class="kw">var</span> maskedCol <span class="op">=</span> filtered<span class="op">.</span><span class="fu">map</span>(applyQaMask)<span class="op">;</span></span>
<span id="cb1-32"><a href="#cb1-32" tabindex="-1"></a></span>
<span id="cb1-33"><a href="#cb1-33" tabindex="-1"></a><span class="kw">var</span> lstCol <span class="op">=</span> maskedCol<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;LST_Day_1km&#39;</span>)<span class="op">;</span></span>
<span id="cb1-34"><a href="#cb1-34" tabindex="-1"></a></span>
<span id="cb1-35"><a href="#cb1-35" tabindex="-1"></a><span class="co">// MODIS LST values come as LST x 200 that need to be scaled by 0.02</span></span>
<span id="cb1-36"><a href="#cb1-36" tabindex="-1"></a><span class="kw">var</span> scaleLST <span class="op">=</span> <span class="kw">function</span>(image) {</span>
<span id="cb1-37"><a href="#cb1-37" tabindex="-1"></a>  <span class="kw">var</span> scaled <span class="op">=</span> image<span class="op">.</span><span class="fu">multiply</span>(<span class="fl">0.02</span>)</span>
<span id="cb1-38"><a href="#cb1-38" tabindex="-1"></a>  <span class="op">.</span><span class="fu">subtract</span>(<span class="fl">273.15</span>)</span>
<span id="cb1-39"><a href="#cb1-39" tabindex="-1"></a>  <span class="cf">return</span> scaled<span class="op">.</span><span class="fu">copyProperties</span>(image<span class="op">,</span></span>
<span id="cb1-40"><a href="#cb1-40" tabindex="-1"></a>    [<span class="st">&#39;system:index&#39;</span><span class="op">,</span> <span class="st">&#39;system:time_start&#39;</span>])</span>
<span id="cb1-41"><a href="#cb1-41" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb1-42"><a href="#cb1-42" tabindex="-1"></a></span>
<span id="cb1-43"><a href="#cb1-43" tabindex="-1"></a><span class="kw">var</span> lstScaled <span class="op">=</span> lstCol<span class="op">.</span><span class="fu">map</span>(scaleLST)<span class="op">;</span></span>
<span id="cb1-44"><a href="#cb1-44" tabindex="-1"></a></span>
<span id="cb1-45"><a href="#cb1-45" tabindex="-1"></a><span class="co">// Create LST composite for every month</span></span>
<span id="cb1-46"><a href="#cb1-46" tabindex="-1"></a><span class="kw">var</span> years <span class="op">=</span> ee<span class="op">.</span><span class="at">List</span><span class="op">.</span><span class="fu">sequence</span>(startYear<span class="op">,</span>endYear)<span class="op">;</span></span>
<span id="cb1-47"><a href="#cb1-47" tabindex="-1"></a><span class="kw">var</span> months <span class="op">=</span> ee<span class="op">.</span><span class="at">List</span><span class="op">.</span><span class="fu">sequence</span>(<span class="dv">1</span><span class="op">,</span> <span class="dv">12</span>)<span class="op">;</span></span>
<span id="cb1-48"><a href="#cb1-48" tabindex="-1"></a></span>
<span id="cb1-49"><a href="#cb1-49" tabindex="-1"></a><span class="co">// Map over the years and create a monthly average collection</span></span>
<span id="cb1-50"><a href="#cb1-50" tabindex="-1"></a><span class="kw">var</span> monthlyImages <span class="op">=</span> years<span class="op">.</span><span class="fu">map</span>(<span class="kw">function</span>(year) {</span>
<span id="cb1-51"><a href="#cb1-51" tabindex="-1"></a>  <span class="cf">return</span> months<span class="op">.</span><span class="fu">map</span>(<span class="kw">function</span>(month) {</span>
<span id="cb1-52"><a href="#cb1-52" tabindex="-1"></a>    <span class="kw">var</span> filtered <span class="op">=</span> lstScaled</span>
<span id="cb1-53"><a href="#cb1-53" tabindex="-1"></a>      <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">calendarRange</span>(year<span class="op">,</span> year<span class="op">,</span> <span class="st">&#39;year&#39;</span>))</span>
<span id="cb1-54"><a href="#cb1-54" tabindex="-1"></a>      <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">calendarRange</span>(month<span class="op">,</span> month<span class="op">,</span> <span class="st">&#39;month&#39;</span>))</span>
<span id="cb1-55"><a href="#cb1-55" tabindex="-1"></a>    <span class="kw">var</span> monthly <span class="op">=</span> filtered<span class="op">.</span><span class="fu">mean</span>()</span>
<span id="cb1-56"><a href="#cb1-56" tabindex="-1"></a>    <span class="cf">return</span> monthly<span class="op">.</span><span class="fu">set</span>({<span class="st">&#39;month&#39;</span><span class="op">:</span> month<span class="op">,</span> <span class="st">&#39;year&#39;</span><span class="op">:</span> year})</span>
<span id="cb1-57"><a href="#cb1-57" tabindex="-1"></a>  })</span>
<span id="cb1-58"><a href="#cb1-58" tabindex="-1"></a>})<span class="op">.</span><span class="fu">flatten</span>()</span>
<span id="cb1-59"><a href="#cb1-59" tabindex="-1"></a></span>
<span id="cb1-60"><a href="#cb1-60" tabindex="-1"></a><span class="co">// We now have 1 image per month for entire duratioon</span></span>
<span id="cb1-61"><a href="#cb1-61" tabindex="-1"></a><span class="kw">var</span> monthlyCol <span class="op">=</span> ee<span class="op">.</span><span class="at">ImageCollection</span><span class="op">.</span><span class="fu">fromImages</span>(monthlyImages)</span>
<span id="cb1-62"><a href="#cb1-62" tabindex="-1"></a></span>
<span id="cb1-63"><a href="#cb1-63" tabindex="-1"></a></span>
<span id="cb1-64"><a href="#cb1-64" tabindex="-1"></a><span class="co">// We can compute Minimum LST for each month across all years</span></span>
<span id="cb1-65"><a href="#cb1-65" tabindex="-1"></a><span class="co">// i.e. Minimum LST for all May months in the collection</span></span>
<span id="cb1-66"><a href="#cb1-66" tabindex="-1"></a><span class="kw">var</span> monthlyMinImages <span class="op">=</span> months<span class="op">.</span><span class="fu">map</span>(<span class="kw">function</span>(month) {</span>
<span id="cb1-67"><a href="#cb1-67" tabindex="-1"></a>    <span class="kw">var</span> filtered <span class="op">=</span> monthlyCol<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;month&#39;</span><span class="op">,</span> month))</span>
<span id="cb1-68"><a href="#cb1-68" tabindex="-1"></a>    <span class="kw">var</span> monthlyMin <span class="op">=</span> filtered<span class="op">.</span><span class="fu">min</span>()</span>
<span id="cb1-69"><a href="#cb1-69" tabindex="-1"></a>    <span class="cf">return</span> monthlyMin<span class="op">.</span><span class="fu">set</span>(<span class="st">&#39;month&#39;</span><span class="op">,</span> month)</span>
<span id="cb1-70"><a href="#cb1-70" tabindex="-1"></a>})</span>
<span id="cb1-71"><a href="#cb1-71" tabindex="-1"></a><span class="kw">var</span> monthlyMin <span class="op">=</span> ee<span class="op">.</span><span class="at">ImageCollection</span><span class="op">.</span><span class="fu">fromImages</span>(monthlyMinImages)</span>
<span id="cb1-72"><a href="#cb1-72" tabindex="-1"></a></span>
<span id="cb1-73"><a href="#cb1-73" tabindex="-1"></a><span class="co">// We can compute Maximum LST for each month across all years</span></span>
<span id="cb1-74"><a href="#cb1-74" tabindex="-1"></a><span class="co">// i.e. Maximum LST for all May months in the collection</span></span>
<span id="cb1-75"><a href="#cb1-75" tabindex="-1"></a><span class="kw">var</span> monthlyMaxImages <span class="op">=</span> months<span class="op">.</span><span class="fu">map</span>(<span class="kw">function</span>(month) {</span>
<span id="cb1-76"><a href="#cb1-76" tabindex="-1"></a>    <span class="kw">var</span> filtered <span class="op">=</span> monthlyCol<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;month&#39;</span><span class="op">,</span> month))</span>
<span id="cb1-77"><a href="#cb1-77" tabindex="-1"></a>    <span class="kw">var</span> monthlyMax <span class="op">=</span> filtered<span class="op">.</span><span class="fu">max</span>()</span>
<span id="cb1-78"><a href="#cb1-78" tabindex="-1"></a>    <span class="cf">return</span> monthlyMax<span class="op">.</span><span class="fu">set</span>(<span class="st">&#39;month&#39;</span><span class="op">,</span> month)</span>
<span id="cb1-79"><a href="#cb1-79" tabindex="-1"></a>})</span>
<span id="cb1-80"><a href="#cb1-80" tabindex="-1"></a><span class="kw">var</span> monthlyMax <span class="op">=</span> ee<span class="op">.</span><span class="at">ImageCollection</span><span class="op">.</span><span class="fu">fromImages</span>(monthlyMaxImages)</span>
<span id="cb1-81"><a href="#cb1-81" tabindex="-1"></a></span>
<span id="cb1-82"><a href="#cb1-82" tabindex="-1"></a><span class="co">// Calculate TCI for 2020</span></span>
<span id="cb1-83"><a href="#cb1-83" tabindex="-1"></a></span>
<span id="cb1-84"><a href="#cb1-84" tabindex="-1"></a><span class="co">// We are interested in calculating TCI for a particular month</span></span>
<span id="cb1-85"><a href="#cb1-85" tabindex="-1"></a><span class="kw">var</span> currentYear <span class="op">=</span> <span class="dv">2020</span></span>
<span id="cb1-86"><a href="#cb1-86" tabindex="-1"></a><span class="kw">var</span> currentMonth <span class="op">=</span> <span class="dv">5</span></span>
<span id="cb1-87"><a href="#cb1-87" tabindex="-1"></a></span>
<span id="cb1-88"><a href="#cb1-88" tabindex="-1"></a><span class="kw">var</span> filtered <span class="op">=</span> monthlyCol</span>
<span id="cb1-89"><a href="#cb1-89" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;year&#39;</span><span class="op">,</span> currentYear))</span>
<span id="cb1-90"><a href="#cb1-90" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;month&#39;</span><span class="op">,</span> currentMonth))</span>
<span id="cb1-91"><a href="#cb1-91" tabindex="-1"></a><span class="kw">var</span> currentMonthLST <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(filtered<span class="op">.</span><span class="fu">first</span>())</span>
<span id="cb1-92"><a href="#cb1-92" tabindex="-1"></a></span>
<span id="cb1-93"><a href="#cb1-93" tabindex="-1"></a><span class="kw">var</span> minLST <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(monthlyMin<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;month&#39;</span><span class="op">,</span> currentMonth))<span class="op">.</span><span class="fu">first</span>())</span>
<span id="cb1-94"><a href="#cb1-94" tabindex="-1"></a><span class="kw">var</span> maxLST <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(monthlyMax<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;month&#39;</span><span class="op">,</span> currentMonth))<span class="op">.</span><span class="fu">first</span>())</span>
<span id="cb1-95"><a href="#cb1-95" tabindex="-1"></a></span>
<span id="cb1-96"><a href="#cb1-96" tabindex="-1"></a><span class="co">// TCI = 100 * (LSTmax - LST) / (LSTmax – LSTmin)</span></span>
<span id="cb1-97"><a href="#cb1-97" tabindex="-1"></a><span class="kw">var</span> image <span class="op">=</span> ee<span class="op">.</span><span class="at">Image</span><span class="op">.</span><span class="fu">cat</span>([currentMonthLST<span class="op">,</span> minLST<span class="op">,</span> maxLST])</span>
<span id="cb1-98"><a href="#cb1-98" tabindex="-1"></a>  <span class="op">.</span><span class="fu">rename</span>([<span class="st">&#39;lst&#39;</span><span class="op">,</span> <span class="st">&#39;min&#39;</span><span class="op">,</span> <span class="st">&#39;max&#39;</span>])</span>
<span id="cb1-99"><a href="#cb1-99" tabindex="-1"></a><span class="kw">var</span> tci <span class="op">=</span> image<span class="op">.</span><span class="fu">expression</span>(<span class="st">&#39;100* (max - lst) / (max - min)&#39;</span><span class="op">,</span></span>
<span id="cb1-100"><a href="#cb1-100" tabindex="-1"></a>    {<span class="st">&#39;lst&#39;</span><span class="op">:</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;lst&#39;</span>)<span class="op">,</span></span>
<span id="cb1-101"><a href="#cb1-101" tabindex="-1"></a>      <span class="st">&#39;min&#39;</span><span class="op">:</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;min&#39;</span>)<span class="op">,</span></span>
<span id="cb1-102"><a href="#cb1-102" tabindex="-1"></a>      <span class="st">&#39;max&#39;</span><span class="op">:</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;max&#39;</span>)</span>
<span id="cb1-103"><a href="#cb1-103" tabindex="-1"></a>    })<span class="op">.</span><span class="fu">rename</span>(<span class="st">&#39;tci&#39;</span>)</span>
<span id="cb1-104"><a href="#cb1-104" tabindex="-1"></a></span>
<span id="cb1-105"><a href="#cb1-105" tabindex="-1"></a></span>
<span id="cb1-106"><a href="#cb1-106" tabindex="-1"></a><span class="kw">var</span> visParams <span class="op">=</span> {<span class="dt">min</span><span class="op">:</span> <span class="op">-</span><span class="dv">80</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span> <span class="dv">60</span><span class="op">,</span> <span class="dt">palette</span><span class="op">:</span> [<span class="st">&#39;white&#39;</span><span class="op">,</span> <span class="st">&#39;red&#39;</span>]}</span>
<span id="cb1-107"><a href="#cb1-107" tabindex="-1"></a><span class="kw">var</span> tciPalette <span class="op">=</span> [<span class="st">&#39;#4575b4&#39;</span><span class="op">,</span><span class="st">&#39;#74add1&#39;</span><span class="op">,</span><span class="st">&#39;#abd9e9&#39;</span><span class="op">,</span><span class="st">&#39;#e0f3f8&#39;</span><span class="op">,</span></span>
<span id="cb1-108"><a href="#cb1-108" tabindex="-1"></a>  <span class="st">&#39;#fee090&#39;</span><span class="op">,</span><span class="st">&#39;#fdae61&#39;</span><span class="op">,</span><span class="st">&#39;#f46d43&#39;</span><span class="op">,</span><span class="st">&#39;#d73027&#39;</span>]<span class="op">;</span></span>
<span id="cb1-109"><a href="#cb1-109" tabindex="-1"></a><span class="kw">var</span> tciVisParams <span class="op">=</span> {<span class="dt">min</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span> <span class="dv">100</span><span class="op">,</span> <span class="dt">palette</span><span class="op">:</span> tciPalette}<span class="op">;</span></span>
<span id="cb1-110"><a href="#cb1-110" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(minLST<span class="op">,</span> visParams<span class="op">,</span> <span class="st">&#39;Minimum May LST&#39;</span><span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span></span>
<span id="cb1-111"><a href="#cb1-111" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(maxLST<span class="op">,</span> visParams<span class="op">,</span> <span class="st">&#39;Maximum May LST&#39;</span><span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span></span>
<span id="cb1-112"><a href="#cb1-112" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(currentMonthLST<span class="op">,</span> visParams<span class="op">,</span> <span class="st">&#39;Current May LST&#39;</span><span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span></span>
<span id="cb1-113"><a href="#cb1-113" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(tci<span class="op">,</span> tciVisParams<span class="op">,</span> <span class="st">&#39;TCI&#39;</span>)<span class="op">;</span></span></code></pre></div>
</div>
<div id="modis-16-day-vci" class="section level2">
<h2>MODIS 16-Day VCI</h2>
<p>This script is an adaptation of the <a
href="https://courses.spatialthoughts.com/gee-water-resources-management.html#drought-monitoring">Drought
Monitoring</a> script that uses 16-day composites instead of monthly
composites.</p>
<p><a
href="https://code.earthengine.google.com/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3ASupplement%2FDrought_Monitoring%2FMODIS_16day_VCI"
target="_blank">Open in Code Editor ↗</a></p>
<div class="sourceCode" id="cb2"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a><span class="co">// Example script showing VCI computation</span></span>
<span id="cb2-2"><a href="#cb2-2" tabindex="-1"></a><span class="co">// for each 16-day period of MODIS composites</span></span>
<span id="cb2-3"><a href="#cb2-3" tabindex="-1"></a></span>
<span id="cb2-4"><a href="#cb2-4" tabindex="-1"></a><span class="kw">var</span> modis <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&#39;MODIS/061/MOD13Q1&#39;</span>)<span class="op">;</span></span>
<span id="cb2-5"><a href="#cb2-5" tabindex="-1"></a></span>
<span id="cb2-6"><a href="#cb2-6" tabindex="-1"></a><span class="kw">var</span> startYear <span class="op">=</span> <span class="dv">2001</span></span>
<span id="cb2-7"><a href="#cb2-7" tabindex="-1"></a><span class="kw">var</span> endYear <span class="op">=</span> <span class="dv">2023</span></span>
<span id="cb2-8"><a href="#cb2-8" tabindex="-1"></a><span class="kw">var</span> startDate <span class="op">=</span> ee<span class="op">.</span><span class="at">Date</span><span class="op">.</span><span class="fu">fromYMD</span>(startYear<span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">1</span>)</span>
<span id="cb2-9"><a href="#cb2-9" tabindex="-1"></a><span class="kw">var</span> endDate <span class="op">=</span> ee<span class="op">.</span><span class="at">Date</span><span class="op">.</span><span class="fu">fromYMD</span>(endYear<span class="op">,</span> <span class="dv">12</span><span class="op">,</span> <span class="dv">31</span>)</span>
<span id="cb2-10"><a href="#cb2-10" tabindex="-1"></a><span class="kw">var</span> filtered <span class="op">=</span> modis</span>
<span id="cb2-11"><a href="#cb2-11" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(<span class="st">&#39;2010-01-01&#39;</span><span class="op">,</span> <span class="st">&#39;2023-07-01&#39;</span>))</span>
<span id="cb2-12"><a href="#cb2-12" tabindex="-1"></a><span class="fu">print</span>(filtered)</span>
<span id="cb2-13"><a href="#cb2-13" tabindex="-1"></a><span class="co">// Cloud Masking</span></span>
<span id="cb2-14"><a href="#cb2-14" tabindex="-1"></a><span class="kw">var</span> bitwiseExtract <span class="op">=</span> <span class="kw">function</span>(input<span class="op">,</span> fromBit<span class="op">,</span> toBit) {</span>
<span id="cb2-15"><a href="#cb2-15" tabindex="-1"></a>  <span class="kw">var</span> maskSize <span class="op">=</span> ee<span class="op">.</span><span class="fu">Number</span>(<span class="dv">1</span>)<span class="op">.</span><span class="fu">add</span>(toBit)<span class="op">.</span><span class="fu">subtract</span>(fromBit)</span>
<span id="cb2-16"><a href="#cb2-16" tabindex="-1"></a>  <span class="kw">var</span> mask <span class="op">=</span> ee<span class="op">.</span><span class="fu">Number</span>(<span class="dv">1</span>)<span class="op">.</span><span class="fu">leftShift</span>(maskSize)<span class="op">.</span><span class="fu">subtract</span>(<span class="dv">1</span>)</span>
<span id="cb2-17"><a href="#cb2-17" tabindex="-1"></a>  <span class="cf">return</span> input<span class="op">.</span><span class="fu">rightShift</span>(fromBit)<span class="op">.</span><span class="fu">bitwiseAnd</span>(mask)</span>
<span id="cb2-18"><a href="#cb2-18" tabindex="-1"></a>}</span>
<span id="cb2-19"><a href="#cb2-19" tabindex="-1"></a></span>
<span id="cb2-20"><a href="#cb2-20" tabindex="-1"></a><span class="kw">var</span> maskSnowAndClouds <span class="op">=</span> <span class="kw">function</span>(image) {</span>
<span id="cb2-21"><a href="#cb2-21" tabindex="-1"></a>  <span class="kw">var</span> summaryQa <span class="op">=</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;SummaryQA&#39;</span>)</span>
<span id="cb2-22"><a href="#cb2-22" tabindex="-1"></a>  <span class="co">// Select pixels which are less than or equals to 1 (0 or 1)</span></span>
<span id="cb2-23"><a href="#cb2-23" tabindex="-1"></a>  <span class="kw">var</span> qaMask <span class="op">=</span> <span class="fu">bitwiseExtract</span>(summaryQa<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">1</span>)<span class="op">.</span><span class="fu">lte</span>(<span class="dv">1</span>)</span>
<span id="cb2-24"><a href="#cb2-24" tabindex="-1"></a>  <span class="kw">var</span> maskedImage <span class="op">=</span> image<span class="op">.</span><span class="fu">updateMask</span>(qaMask)</span>
<span id="cb2-25"><a href="#cb2-25" tabindex="-1"></a>  <span class="cf">return</span> maskedImage<span class="op">.</span><span class="fu">copyProperties</span>(image<span class="op">,</span> [<span class="st">&#39;system:index&#39;</span><span class="op">,</span> <span class="st">&#39;system:time_start&#39;</span>])</span>
<span id="cb2-26"><a href="#cb2-26" tabindex="-1"></a>}</span>
<span id="cb2-27"><a href="#cb2-27" tabindex="-1"></a></span>
<span id="cb2-28"><a href="#cb2-28" tabindex="-1"></a><span class="co">// Apply the function to all images in the collection</span></span>
<span id="cb2-29"><a href="#cb2-29" tabindex="-1"></a><span class="kw">var</span> maskedCol <span class="op">=</span> filtered<span class="op">.</span><span class="fu">map</span>(maskSnowAndClouds)</span>
<span id="cb2-30"><a href="#cb2-30" tabindex="-1"></a></span>
<span id="cb2-31"><a href="#cb2-31" tabindex="-1"></a><span class="kw">var</span> ndviCol <span class="op">=</span> maskedCol<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;NDVI&#39;</span>)</span>
<span id="cb2-32"><a href="#cb2-32" tabindex="-1"></a><span class="co">// MODIS NDVI values come as NDVI x 10000 that need to be scaled by 0.0001</span></span>
<span id="cb2-33"><a href="#cb2-33" tabindex="-1"></a><span class="kw">var</span> scaleNdvi <span class="op">=</span> <span class="kw">function</span>(image) {</span>
<span id="cb2-34"><a href="#cb2-34" tabindex="-1"></a>  <span class="kw">var</span> scaled <span class="op">=</span> image<span class="op">.</span><span class="fu">divide</span>(<span class="dv">10000</span>)</span>
<span id="cb2-35"><a href="#cb2-35" tabindex="-1"></a>  <span class="cf">return</span> scaled<span class="op">.</span><span class="fu">copyProperties</span>(image<span class="op">,</span> [<span class="st">&#39;system:index&#39;</span><span class="op">,</span> <span class="st">&#39;system:time_start&#39;</span>])</span>
<span id="cb2-36"><a href="#cb2-36" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb2-37"><a href="#cb2-37" tabindex="-1"></a><span class="kw">var</span> addImageNumber <span class="op">=</span> <span class="kw">function</span>(image) {</span>
<span id="cb2-38"><a href="#cb2-38" tabindex="-1"></a>  <span class="kw">var</span> startDate <span class="op">=</span> ee<span class="op">.</span><span class="fu">Date</span>(image<span class="op">.</span><span class="fu">get</span>(<span class="st">&#39;system:time_start&#39;</span>))</span>
<span id="cb2-39"><a href="#cb2-39" tabindex="-1"></a>  <span class="kw">var</span> difference <span class="op">=</span> startDate<span class="op">.</span><span class="fu">getRelative</span>(<span class="st">&#39;day&#39;</span><span class="op">,</span> <span class="st">&#39;year&#39;</span>) </span>
<span id="cb2-40"><a href="#cb2-40" tabindex="-1"></a>  <span class="kw">var</span> period <span class="op">=</span> difference<span class="op">.</span><span class="fu">divide</span>(<span class="dv">16</span>)<span class="op">.</span><span class="fu">add</span>(<span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb2-41"><a href="#cb2-41" tabindex="-1"></a>  <span class="cf">return</span> image<span class="op">.</span><span class="fu">set</span>(<span class="st">&#39;period&#39;</span><span class="op">,</span> period)<span class="op">.</span><span class="fu">set</span>(<span class="st">&#39;year&#39;</span><span class="op">,</span>image<span class="op">.</span><span class="fu">date</span>()<span class="op">.</span><span class="fu">get</span>(<span class="st">&#39;year&#39;</span>))</span>
<span id="cb2-42"><a href="#cb2-42" tabindex="-1"></a>          </span>
<span id="cb2-43"><a href="#cb2-43" tabindex="-1"></a>}</span>
<span id="cb2-44"><a href="#cb2-44" tabindex="-1"></a><span class="kw">var</span> ndviScaled <span class="op">=</span> ndviCol<span class="op">.</span><span class="fu">map</span>(scaleNdvi)<span class="op">.</span><span class="fu">map</span>(addImageNumber)</span>
<span id="cb2-45"><a href="#cb2-45" tabindex="-1"></a><span class="fu">print</span>(ndviScaled<span class="op">,</span><span class="st">&#39;ndvi&#39;</span>)</span>
<span id="cb2-46"><a href="#cb2-46" tabindex="-1"></a></span>
<span id="cb2-47"><a href="#cb2-47" tabindex="-1"></a><span class="kw">var</span> periods <span class="op">=</span> ee<span class="op">.</span><span class="at">List</span><span class="op">.</span><span class="fu">sequence</span>(<span class="dv">1</span><span class="op">,</span> <span class="dv">23</span>)</span>
<span id="cb2-48"><a href="#cb2-48" tabindex="-1"></a></span>
<span id="cb2-49"><a href="#cb2-49" tabindex="-1"></a><span class="kw">var</span> periodImages <span class="op">=</span> periods<span class="op">.</span><span class="fu">map</span>(<span class="kw">function</span>(period) {</span>
<span id="cb2-50"><a href="#cb2-50" tabindex="-1"></a>    <span class="kw">var</span> filtered <span class="op">=</span> ndviScaled</span>
<span id="cb2-51"><a href="#cb2-51" tabindex="-1"></a>      <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;period&#39;</span><span class="op">,</span> period))</span>
<span id="cb2-52"><a href="#cb2-52" tabindex="-1"></a>    <span class="kw">var</span> periodMin <span class="op">=</span> filtered<span class="op">.</span><span class="fu">min</span>()<span class="op">;</span></span>
<span id="cb2-53"><a href="#cb2-53" tabindex="-1"></a>    <span class="kw">var</span> periodMax <span class="op">=</span> filtered<span class="op">.</span><span class="fu">max</span>()<span class="op">;</span></span>
<span id="cb2-54"><a href="#cb2-54" tabindex="-1"></a>    <span class="kw">var</span> periodMean <span class="op">=</span> filtered<span class="op">.</span><span class="fu">mean</span>()<span class="op">;</span></span>
<span id="cb2-55"><a href="#cb2-55" tabindex="-1"></a>    <span class="kw">var</span> periodImage <span class="op">=</span> ee<span class="op">.</span><span class="at">Image</span><span class="op">.</span><span class="fu">cat</span>([periodMin<span class="op">,</span> periodMean<span class="op">,</span> periodMax])</span>
<span id="cb2-56"><a href="#cb2-56" tabindex="-1"></a>      <span class="op">.</span><span class="fu">rename</span>([<span class="st">&#39;ndvi_min&#39;</span><span class="op">,</span> <span class="st">&#39;ndvi_mean&#39;</span><span class="op">,</span> <span class="st">&#39;ndvi_max&#39;</span>])</span>
<span id="cb2-57"><a href="#cb2-57" tabindex="-1"></a>    <span class="cf">return</span> periodImage<span class="op">.</span><span class="fu">set</span>(<span class="st">&#39;period&#39;</span><span class="op">,</span> period)</span>
<span id="cb2-58"><a href="#cb2-58" tabindex="-1"></a>      </span>
<span id="cb2-59"><a href="#cb2-59" tabindex="-1"></a>})</span>
<span id="cb2-60"><a href="#cb2-60" tabindex="-1"></a><span class="kw">var</span> periodCol <span class="op">=</span> ee<span class="op">.</span><span class="at">ImageCollection</span><span class="op">.</span><span class="fu">fromImages</span>(periodImages)</span>
<span id="cb2-61"><a href="#cb2-61" tabindex="-1"></a><span class="fu">print</span>(periodCol)</span>
<span id="cb2-62"><a href="#cb2-62" tabindex="-1"></a></span>
<span id="cb2-63"><a href="#cb2-63" tabindex="-1"></a><span class="kw">var</span> currentYear <span class="op">=</span> <span class="dv">2023</span></span>
<span id="cb2-64"><a href="#cb2-64" tabindex="-1"></a></span>
<span id="cb2-65"><a href="#cb2-65" tabindex="-1"></a><span class="kw">var</span> getColForYears <span class="op">=</span> <span class="kw">function</span>(year) {</span>
<span id="cb2-66"><a href="#cb2-66" tabindex="-1"></a>  periods <span class="op">=</span> ndviScaled</span>
<span id="cb2-67"><a href="#cb2-67" tabindex="-1"></a>    <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;year&#39;</span><span class="op">,</span> currentYear))<span class="op">.</span><span class="fu">aggregate_array</span>(<span class="st">&#39;period&#39;</span>)</span>
<span id="cb2-68"><a href="#cb2-68" tabindex="-1"></a></span>
<span id="cb2-69"><a href="#cb2-69" tabindex="-1"></a>  <span class="kw">var</span> result <span class="op">=</span> periods<span class="op">.</span><span class="fu">map</span>(<span class="kw">function</span>(period) {</span>
<span id="cb2-70"><a href="#cb2-70" tabindex="-1"></a>    <span class="kw">var</span> filtered <span class="op">=</span> ndviScaled</span>
<span id="cb2-71"><a href="#cb2-71" tabindex="-1"></a>      <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">calendarRange</span>(year<span class="op">,</span> year<span class="op">,</span> <span class="st">&#39;year&#39;</span>))</span>
<span id="cb2-72"><a href="#cb2-72" tabindex="-1"></a>      <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;period&#39;</span><span class="op">,</span> period))</span>
<span id="cb2-73"><a href="#cb2-73" tabindex="-1"></a></span>
<span id="cb2-74"><a href="#cb2-74" tabindex="-1"></a>    <span class="kw">var</span> periodNdvi <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(filtered<span class="op">.</span><span class="fu">first</span>())<span class="op">;</span></span>
<span id="cb2-75"><a href="#cb2-75" tabindex="-1"></a>    <span class="kw">var</span> periodImage <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(periodCol<span class="op">.</span><span class="fu">filter</span>(</span>
<span id="cb2-76"><a href="#cb2-76" tabindex="-1"></a>      ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;period&#39;</span><span class="op">,</span> period))<span class="op">.</span><span class="fu">first</span>())</span>
<span id="cb2-77"><a href="#cb2-77" tabindex="-1"></a>    <span class="kw">var</span> periodMean <span class="op">=</span> periodImage<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;ndvi_mean&#39;</span>)<span class="op">;</span></span>
<span id="cb2-78"><a href="#cb2-78" tabindex="-1"></a>    <span class="kw">var</span> periodMin <span class="op">=</span> periodImage<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;ndvi_min&#39;</span>)<span class="op">;</span></span>
<span id="cb2-79"><a href="#cb2-79" tabindex="-1"></a>    <span class="kw">var</span> periodMax <span class="op">=</span> periodImage<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;ndvi_max&#39;</span>)<span class="op">;</span></span>
<span id="cb2-80"><a href="#cb2-80" tabindex="-1"></a></span>
<span id="cb2-81"><a href="#cb2-81" tabindex="-1"></a>    <span class="kw">var</span> periodVariance <span class="op">=</span> periodNdvi<span class="op">.</span><span class="fu">subtract</span>(periodMean)<span class="op">;</span></span>
<span id="cb2-82"><a href="#cb2-82" tabindex="-1"></a>  </span>
<span id="cb2-83"><a href="#cb2-83" tabindex="-1"></a>    <span class="kw">var</span> image <span class="op">=</span> ee<span class="op">.</span><span class="at">Image</span><span class="op">.</span><span class="fu">cat</span>(</span>
<span id="cb2-84"><a href="#cb2-84" tabindex="-1"></a>      [periodNdvi<span class="op">,</span> periodMean<span class="op">,</span> periodVariance<span class="op">,</span> periodMin<span class="op">,</span> periodMax])<span class="op">.</span><span class="fu">rename</span>(</span>
<span id="cb2-85"><a href="#cb2-85" tabindex="-1"></a>      [<span class="st">&#39;ndvi&#39;</span><span class="op">,</span> <span class="st">&#39;mean&#39;</span><span class="op">,</span> <span class="st">&#39;variance&#39;</span><span class="op">,</span> <span class="st">&#39;min&#39;</span><span class="op">,</span> <span class="st">&#39;max&#39;</span>])</span>
<span id="cb2-86"><a href="#cb2-86" tabindex="-1"></a>    <span class="kw">var</span> vci <span class="op">=</span> image<span class="op">.</span><span class="fu">expression</span>(<span class="st">&#39;100*(NDVI-NDVImin)/(NDVImax-NDVImin)&#39;</span><span class="op">,</span> {</span>
<span id="cb2-87"><a href="#cb2-87" tabindex="-1"></a>      <span class="st">&#39;NDVI&#39;</span><span class="op">:</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;ndvi&#39;</span>)<span class="op">,</span></span>
<span id="cb2-88"><a href="#cb2-88" tabindex="-1"></a>      <span class="st">&#39;NDVImin&#39;</span><span class="op">:</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;min&#39;</span>)<span class="op">,</span></span>
<span id="cb2-89"><a href="#cb2-89" tabindex="-1"></a>      <span class="st">&#39;NDVImax&#39;</span><span class="op">:</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;max&#39;</span>)<span class="op">,</span></span>
<span id="cb2-90"><a href="#cb2-90" tabindex="-1"></a>    })<span class="op">.</span><span class="fu">rename</span>(<span class="st">&#39;vci&#39;</span>)<span class="op">;</span></span>
<span id="cb2-91"><a href="#cb2-91" tabindex="-1"></a>    <span class="kw">var</span> image <span class="op">=</span> image<span class="op">.</span><span class="fu">addBands</span>(vci)<span class="op">;</span></span>
<span id="cb2-92"><a href="#cb2-92" tabindex="-1"></a>    <span class="kw">var</span> imageId <span class="op">=</span> ee<span class="op">.</span><span class="fu">Number</span>(year)<span class="op">.</span><span class="fu">format</span>(<span class="st">&#39;%d&#39;</span>)</span>
<span id="cb2-93"><a href="#cb2-93" tabindex="-1"></a>      <span class="op">.</span><span class="fu">cat</span>(ee<span class="op">.</span><span class="fu">Number</span>(period)<span class="op">.</span><span class="fu">format</span>(<span class="st">&#39;%02d&#39;</span>))</span>
<span id="cb2-94"><a href="#cb2-94" tabindex="-1"></a></span>
<span id="cb2-95"><a href="#cb2-95" tabindex="-1"></a>    <span class="cf">return</span> image<span class="op">.</span><span class="fu">set</span>(<span class="st">&#39;system:index&#39;</span><span class="op">,</span> imageId<span class="op">,</span><span class="st">&#39;year&#39;</span><span class="op">,</span>year)</span>
<span id="cb2-96"><a href="#cb2-96" tabindex="-1"></a>  }) </span>
<span id="cb2-97"><a href="#cb2-97" tabindex="-1"></a>  </span>
<span id="cb2-98"><a href="#cb2-98" tabindex="-1"></a>  <span class="cf">return</span> ee<span class="op">.</span><span class="at">ImageCollection</span><span class="op">.</span><span class="fu">fromImages</span>(result)</span>
<span id="cb2-99"><a href="#cb2-99" tabindex="-1"></a>}</span>
<span id="cb2-100"><a href="#cb2-100" tabindex="-1"></a></span>
<span id="cb2-101"><a href="#cb2-101" tabindex="-1"></a><span class="co">// Get images for a year</span></span>
<span id="cb2-102"><a href="#cb2-102" tabindex="-1"></a><span class="kw">var</span> currentYearCol <span class="op">=</span> <span class="fu">getColForYears</span>(currentYear)<span class="op">;</span></span>
<span id="cb2-103"><a href="#cb2-103" tabindex="-1"></a><span class="fu">print</span>(currentYearCol)</span></code></pre></div>
</div>
<div id="pie-chart-group-statistics" class="section level2">
<h2>Pie Chart Group Statistics</h2>
<p><a
href="https://code.earthengine.google.com/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3ASupplement%2FDrought_Monitoring%2FPie_Chart_Group_Statistics"
target="_blank">Open in Code Editor ↗</a></p>
<div class="sourceCode" id="cb3"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a><span class="kw">var</span> modis <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&quot;MODIS/006/MOD13Q1&quot;</span>)<span class="op">;</span></span>
<span id="cb3-2"><a href="#cb3-2" tabindex="-1"></a><span class="kw">var</span> gfsad <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(<span class="st">&quot;USGS/GFSAD1000_V1&quot;</span>)<span class="op">;</span></span>
<span id="cb3-3"><a href="#cb3-3" tabindex="-1"></a></span>
<span id="cb3-4"><a href="#cb3-4" tabindex="-1"></a><span class="kw">var</span> startYear <span class="op">=</span> <span class="dv">2010</span></span>
<span id="cb3-5"><a href="#cb3-5" tabindex="-1"></a><span class="kw">var</span> endYear <span class="op">=</span> <span class="dv">2020</span></span>
<span id="cb3-6"><a href="#cb3-6" tabindex="-1"></a><span class="kw">var</span> startDate <span class="op">=</span> ee<span class="op">.</span><span class="at">Date</span><span class="op">.</span><span class="fu">fromYMD</span>(startYear<span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">1</span>)</span>
<span id="cb3-7"><a href="#cb3-7" tabindex="-1"></a><span class="kw">var</span> endDate <span class="op">=</span> ee<span class="op">.</span><span class="at">Date</span><span class="op">.</span><span class="fu">fromYMD</span>(endYear<span class="op">,</span> <span class="dv">12</span><span class="op">,</span> <span class="dv">31</span>)</span>
<span id="cb3-8"><a href="#cb3-8" tabindex="-1"></a><span class="kw">var</span> filtered <span class="op">=</span> modis</span>
<span id="cb3-9"><a href="#cb3-9" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(startDate<span class="op">,</span> endDate))</span>
<span id="cb3-10"><a href="#cb3-10" tabindex="-1"></a></span>
<span id="cb3-11"><a href="#cb3-11" tabindex="-1"></a><span class="co">// Cloud Masking</span></span>
<span id="cb3-12"><a href="#cb3-12" tabindex="-1"></a><span class="kw">var</span> bitwiseExtract <span class="op">=</span> <span class="kw">function</span>(input<span class="op">,</span> fromBit<span class="op">,</span> toBit) {</span>
<span id="cb3-13"><a href="#cb3-13" tabindex="-1"></a>  <span class="kw">var</span> maskSize <span class="op">=</span> ee<span class="op">.</span><span class="fu">Number</span>(<span class="dv">1</span>)<span class="op">.</span><span class="fu">add</span>(toBit)<span class="op">.</span><span class="fu">subtract</span>(fromBit)</span>
<span id="cb3-14"><a href="#cb3-14" tabindex="-1"></a>  <span class="kw">var</span> mask <span class="op">=</span> ee<span class="op">.</span><span class="fu">Number</span>(<span class="dv">1</span>)<span class="op">.</span><span class="fu">leftShift</span>(maskSize)<span class="op">.</span><span class="fu">subtract</span>(<span class="dv">1</span>)</span>
<span id="cb3-15"><a href="#cb3-15" tabindex="-1"></a>  <span class="cf">return</span> input<span class="op">.</span><span class="fu">rightShift</span>(fromBit)<span class="op">.</span><span class="fu">bitwiseAnd</span>(mask)</span>
<span id="cb3-16"><a href="#cb3-16" tabindex="-1"></a>}</span>
<span id="cb3-17"><a href="#cb3-17" tabindex="-1"></a></span>
<span id="cb3-18"><a href="#cb3-18" tabindex="-1"></a><span class="kw">var</span> maskSnowAndClouds <span class="op">=</span> <span class="kw">function</span>(image) {</span>
<span id="cb3-19"><a href="#cb3-19" tabindex="-1"></a>  <span class="kw">var</span> summaryQa <span class="op">=</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;SummaryQA&#39;</span>)</span>
<span id="cb3-20"><a href="#cb3-20" tabindex="-1"></a>  <span class="co">// Select pixels which are less than or equals to 1 (0 or 1)</span></span>
<span id="cb3-21"><a href="#cb3-21" tabindex="-1"></a>  <span class="kw">var</span> qaMask <span class="op">=</span> <span class="fu">bitwiseExtract</span>(summaryQa<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">1</span>)<span class="op">.</span><span class="fu">lte</span>(<span class="dv">1</span>)</span>
<span id="cb3-22"><a href="#cb3-22" tabindex="-1"></a>  <span class="kw">var</span> maskedImage <span class="op">=</span> image<span class="op">.</span><span class="fu">updateMask</span>(qaMask)</span>
<span id="cb3-23"><a href="#cb3-23" tabindex="-1"></a>  <span class="cf">return</span> maskedImage<span class="op">.</span><span class="fu">copyProperties</span>(image<span class="op">,</span> [<span class="st">&#39;system:index&#39;</span><span class="op">,</span> <span class="st">&#39;system:time_start&#39;</span>])</span>
<span id="cb3-24"><a href="#cb3-24" tabindex="-1"></a>}</span>
<span id="cb3-25"><a href="#cb3-25" tabindex="-1"></a></span>
<span id="cb3-26"><a href="#cb3-26" tabindex="-1"></a><span class="co">// Apply the function to all images in the collection</span></span>
<span id="cb3-27"><a href="#cb3-27" tabindex="-1"></a><span class="kw">var</span> maskedCol <span class="op">=</span> filtered<span class="op">.</span><span class="fu">map</span>(maskSnowAndClouds)</span>
<span id="cb3-28"><a href="#cb3-28" tabindex="-1"></a></span>
<span id="cb3-29"><a href="#cb3-29" tabindex="-1"></a><span class="kw">var</span> ndviCol <span class="op">=</span> maskedCol<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;NDVI&#39;</span>)</span>
<span id="cb3-30"><a href="#cb3-30" tabindex="-1"></a><span class="co">// MODIS NDVI values come as NDVI x 10000 that need to be scaled by 0.0001</span></span>
<span id="cb3-31"><a href="#cb3-31" tabindex="-1"></a><span class="kw">var</span> scaleNdvi <span class="op">=</span> <span class="kw">function</span>(image) {</span>
<span id="cb3-32"><a href="#cb3-32" tabindex="-1"></a>  <span class="kw">var</span> scaled <span class="op">=</span> image<span class="op">.</span><span class="fu">divide</span>(<span class="dv">10000</span>)</span>
<span id="cb3-33"><a href="#cb3-33" tabindex="-1"></a>  <span class="cf">return</span> scaled<span class="op">.</span><span class="fu">copyProperties</span>(image<span class="op">,</span> [<span class="st">&#39;system:index&#39;</span><span class="op">,</span> <span class="st">&#39;system:time_start&#39;</span>])</span>
<span id="cb3-34"><a href="#cb3-34" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb3-35"><a href="#cb3-35" tabindex="-1"></a></span>
<span id="cb3-36"><a href="#cb3-36" tabindex="-1"></a><span class="kw">var</span> ndviScaled <span class="op">=</span> ndviCol<span class="op">.</span><span class="fu">map</span>(scaleNdvi)</span>
<span id="cb3-37"><a href="#cb3-37" tabindex="-1"></a></span>
<span id="cb3-38"><a href="#cb3-38" tabindex="-1"></a><span class="co">// Create NDVI composite for every month</span></span>
<span id="cb3-39"><a href="#cb3-39" tabindex="-1"></a><span class="kw">var</span> years <span class="op">=</span> ee<span class="op">.</span><span class="at">List</span><span class="op">.</span><span class="fu">sequence</span>(startYear<span class="op">,</span>endYear)<span class="op">;</span></span>
<span id="cb3-40"><a href="#cb3-40" tabindex="-1"></a><span class="kw">var</span> months <span class="op">=</span> ee<span class="op">.</span><span class="at">List</span><span class="op">.</span><span class="fu">sequence</span>(<span class="dv">1</span><span class="op">,</span> <span class="dv">12</span>)<span class="op">;</span></span>
<span id="cb3-41"><a href="#cb3-41" tabindex="-1"></a></span>
<span id="cb3-42"><a href="#cb3-42" tabindex="-1"></a><span class="co">// Map over the years and create a monthly average collection</span></span>
<span id="cb3-43"><a href="#cb3-43" tabindex="-1"></a><span class="kw">var</span> monthlyImages <span class="op">=</span> years<span class="op">.</span><span class="fu">map</span>(<span class="kw">function</span>(year) {</span>
<span id="cb3-44"><a href="#cb3-44" tabindex="-1"></a>  <span class="cf">return</span> months<span class="op">.</span><span class="fu">map</span>(<span class="kw">function</span>(month) {</span>
<span id="cb3-45"><a href="#cb3-45" tabindex="-1"></a>    <span class="kw">var</span> filtered <span class="op">=</span> ndviScaled</span>
<span id="cb3-46"><a href="#cb3-46" tabindex="-1"></a>      <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">calendarRange</span>(year<span class="op">,</span> year<span class="op">,</span> <span class="st">&#39;year&#39;</span>))</span>
<span id="cb3-47"><a href="#cb3-47" tabindex="-1"></a>      <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">calendarRange</span>(month<span class="op">,</span> month<span class="op">,</span> <span class="st">&#39;month&#39;</span>))</span>
<span id="cb3-48"><a href="#cb3-48" tabindex="-1"></a>    <span class="kw">var</span> monthly <span class="op">=</span> filtered<span class="op">.</span><span class="fu">mean</span>()</span>
<span id="cb3-49"><a href="#cb3-49" tabindex="-1"></a>    <span class="cf">return</span> monthly<span class="op">.</span><span class="fu">set</span>({<span class="st">&#39;month&#39;</span><span class="op">:</span> month<span class="op">,</span> <span class="st">&#39;year&#39;</span><span class="op">:</span> year})</span>
<span id="cb3-50"><a href="#cb3-50" tabindex="-1"></a>  })</span>
<span id="cb3-51"><a href="#cb3-51" tabindex="-1"></a>})<span class="op">.</span><span class="fu">flatten</span>()</span>
<span id="cb3-52"><a href="#cb3-52" tabindex="-1"></a></span>
<span id="cb3-53"><a href="#cb3-53" tabindex="-1"></a><span class="co">// We now have 1 image per month for entire duratioon</span></span>
<span id="cb3-54"><a href="#cb3-54" tabindex="-1"></a><span class="kw">var</span> monthlyCol <span class="op">=</span> ee<span class="op">.</span><span class="at">ImageCollection</span><span class="op">.</span><span class="fu">fromImages</span>(monthlyImages)</span>
<span id="cb3-55"><a href="#cb3-55" tabindex="-1"></a></span>
<span id="cb3-56"><a href="#cb3-56" tabindex="-1"></a></span>
<span id="cb3-57"><a href="#cb3-57" tabindex="-1"></a><span class="co">// We can compute Minimum NDVI for each month across all years</span></span>
<span id="cb3-58"><a href="#cb3-58" tabindex="-1"></a><span class="co">// i.e. Minimum NDVI for all May months in the collection</span></span>
<span id="cb3-59"><a href="#cb3-59" tabindex="-1"></a><span class="kw">var</span> monthlyMinImages <span class="op">=</span> months<span class="op">.</span><span class="fu">map</span>(<span class="kw">function</span>(month) {</span>
<span id="cb3-60"><a href="#cb3-60" tabindex="-1"></a>    <span class="kw">var</span> filtered <span class="op">=</span> monthlyCol<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;month&#39;</span><span class="op">,</span> month))</span>
<span id="cb3-61"><a href="#cb3-61" tabindex="-1"></a>    <span class="kw">var</span> monthlyMin <span class="op">=</span> filtered<span class="op">.</span><span class="fu">min</span>()</span>
<span id="cb3-62"><a href="#cb3-62" tabindex="-1"></a>    <span class="cf">return</span> monthlyMin<span class="op">.</span><span class="fu">set</span>(<span class="st">&#39;month&#39;</span><span class="op">,</span> month)</span>
<span id="cb3-63"><a href="#cb3-63" tabindex="-1"></a>})</span>
<span id="cb3-64"><a href="#cb3-64" tabindex="-1"></a><span class="kw">var</span> monthlyMin <span class="op">=</span> ee<span class="op">.</span><span class="at">ImageCollection</span><span class="op">.</span><span class="fu">fromImages</span>(monthlyMinImages)</span>
<span id="cb3-65"><a href="#cb3-65" tabindex="-1"></a></span>
<span id="cb3-66"><a href="#cb3-66" tabindex="-1"></a><span class="co">// We can compute Maximum NDVI for each month across all years</span></span>
<span id="cb3-67"><a href="#cb3-67" tabindex="-1"></a><span class="co">// i.e. Maximum NDVI for all May months in the collection</span></span>
<span id="cb3-68"><a href="#cb3-68" tabindex="-1"></a><span class="kw">var</span> monthlyMaxImages <span class="op">=</span> months<span class="op">.</span><span class="fu">map</span>(<span class="kw">function</span>(month) {</span>
<span id="cb3-69"><a href="#cb3-69" tabindex="-1"></a>    <span class="kw">var</span> filtered <span class="op">=</span> monthlyCol<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;month&#39;</span><span class="op">,</span> month))</span>
<span id="cb3-70"><a href="#cb3-70" tabindex="-1"></a>    <span class="kw">var</span> monthlyMax <span class="op">=</span> filtered<span class="op">.</span><span class="fu">max</span>()</span>
<span id="cb3-71"><a href="#cb3-71" tabindex="-1"></a>    <span class="cf">return</span> monthlyMax<span class="op">.</span><span class="fu">set</span>(<span class="st">&#39;month&#39;</span><span class="op">,</span> month)</span>
<span id="cb3-72"><a href="#cb3-72" tabindex="-1"></a>})</span>
<span id="cb3-73"><a href="#cb3-73" tabindex="-1"></a><span class="kw">var</span> monthlyMax <span class="op">=</span> ee<span class="op">.</span><span class="at">ImageCollection</span><span class="op">.</span><span class="fu">fromImages</span>(monthlyMaxImages)</span>
<span id="cb3-74"><a href="#cb3-74" tabindex="-1"></a></span>
<span id="cb3-75"><a href="#cb3-75" tabindex="-1"></a><span class="co">// Calculate VCI for 2020</span></span>
<span id="cb3-76"><a href="#cb3-76" tabindex="-1"></a></span>
<span id="cb3-77"><a href="#cb3-77" tabindex="-1"></a><span class="co">// We are interested in calculating VCI for a particular month</span></span>
<span id="cb3-78"><a href="#cb3-78" tabindex="-1"></a><span class="kw">var</span> currentYear <span class="op">=</span> <span class="dv">2020</span></span>
<span id="cb3-79"><a href="#cb3-79" tabindex="-1"></a><span class="kw">var</span> currentMonth <span class="op">=</span> <span class="dv">5</span></span>
<span id="cb3-80"><a href="#cb3-80" tabindex="-1"></a></span>
<span id="cb3-81"><a href="#cb3-81" tabindex="-1"></a><span class="kw">var</span> filtered <span class="op">=</span> monthlyCol</span>
<span id="cb3-82"><a href="#cb3-82" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;year&#39;</span><span class="op">,</span> currentYear))</span>
<span id="cb3-83"><a href="#cb3-83" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;month&#39;</span><span class="op">,</span> currentMonth))</span>
<span id="cb3-84"><a href="#cb3-84" tabindex="-1"></a><span class="kw">var</span> currentMonthNdvi <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(filtered<span class="op">.</span><span class="fu">first</span>())</span>
<span id="cb3-85"><a href="#cb3-85" tabindex="-1"></a></span>
<span id="cb3-86"><a href="#cb3-86" tabindex="-1"></a><span class="kw">var</span> minNdvi <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(monthlyMin<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;month&#39;</span><span class="op">,</span> currentMonth))<span class="op">.</span><span class="fu">first</span>())</span>
<span id="cb3-87"><a href="#cb3-87" tabindex="-1"></a><span class="kw">var</span> maxNdvi <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(monthlyMax<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;month&#39;</span><span class="op">,</span> currentMonth))<span class="op">.</span><span class="fu">first</span>())</span>
<span id="cb3-88"><a href="#cb3-88" tabindex="-1"></a></span>
<span id="cb3-89"><a href="#cb3-89" tabindex="-1"></a><span class="co">// VCI = (NDVI - min) / (max - min)</span></span>
<span id="cb3-90"><a href="#cb3-90" tabindex="-1"></a><span class="kw">var</span> image <span class="op">=</span> ee<span class="op">.</span><span class="at">Image</span><span class="op">.</span><span class="fu">cat</span>([currentMonthNdvi<span class="op">,</span> minNdvi<span class="op">,</span> maxNdvi])<span class="op">.</span><span class="fu">rename</span>([<span class="st">&#39;ndvi&#39;</span><span class="op">,</span> <span class="st">&#39;min&#39;</span><span class="op">,</span> <span class="st">&#39;max&#39;</span>])</span>
<span id="cb3-91"><a href="#cb3-91" tabindex="-1"></a><span class="kw">var</span> vci <span class="op">=</span> image<span class="op">.</span><span class="fu">expression</span>(<span class="st">&#39;100* (ndvi - min) / (max - min)&#39;</span><span class="op">,</span></span>
<span id="cb3-92"><a href="#cb3-92" tabindex="-1"></a>    {<span class="st">&#39;ndvi&#39;</span><span class="op">:</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;ndvi&#39;</span>)<span class="op">,</span></span>
<span id="cb3-93"><a href="#cb3-93" tabindex="-1"></a>      <span class="st">&#39;min&#39;</span><span class="op">:</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;min&#39;</span>)<span class="op">,</span></span>
<span id="cb3-94"><a href="#cb3-94" tabindex="-1"></a>      <span class="st">&#39;max&#39;</span><span class="op">:</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;max&#39;</span>)</span>
<span id="cb3-95"><a href="#cb3-95" tabindex="-1"></a>    })<span class="op">.</span><span class="fu">rename</span>(<span class="st">&#39;vci&#39;</span>)</span>
<span id="cb3-96"><a href="#cb3-96" tabindex="-1"></a></span>
<span id="cb3-97"><a href="#cb3-97" tabindex="-1"></a><span class="kw">var</span> cropLand <span class="op">=</span> gfsad<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;landcover&#39;</span>)<span class="op">.</span><span class="fu">neq</span>(<span class="dv">0</span>)</span>
<span id="cb3-98"><a href="#cb3-98" tabindex="-1"></a><span class="kw">var</span> vciMasked <span class="op">=</span> vci<span class="op">.</span><span class="fu">updateMask</span>(cropLand)</span>
<span id="cb3-99"><a href="#cb3-99" tabindex="-1"></a></span>
<span id="cb3-100"><a href="#cb3-100" tabindex="-1"></a><span class="co">// Vegetation Condition Classification</span></span>
<span id="cb3-101"><a href="#cb3-101" tabindex="-1"></a></span>
<span id="cb3-102"><a href="#cb3-102" tabindex="-1"></a><span class="co">// | VCI    | Condition |</span></span>
<span id="cb3-103"><a href="#cb3-103" tabindex="-1"></a><span class="co">// | 60-100 | Good      |</span></span>
<span id="cb3-104"><a href="#cb3-104" tabindex="-1"></a><span class="co">// | 40-60  | Fair      |</span></span>
<span id="cb3-105"><a href="#cb3-105" tabindex="-1"></a><span class="co">// | 0-40   | Poor      |</span></span>
<span id="cb3-106"><a href="#cb3-106" tabindex="-1"></a></span>
<span id="cb3-107"><a href="#cb3-107" tabindex="-1"></a><span class="co">// Use .where() function to classify continuous images to</span></span>
<span id="cb3-108"><a href="#cb3-108" tabindex="-1"></a><span class="co">// discrete values</span></span>
<span id="cb3-109"><a href="#cb3-109" tabindex="-1"></a><span class="kw">var</span> condition <span class="op">=</span> vciMasked</span>
<span id="cb3-110"><a href="#cb3-110" tabindex="-1"></a>  <span class="op">.</span><span class="fu">where</span>(vciMasked<span class="op">.</span><span class="fu">lt</span>(<span class="dv">40</span>)<span class="op">,</span> <span class="dv">1</span>)</span>
<span id="cb3-111"><a href="#cb3-111" tabindex="-1"></a>  <span class="op">.</span><span class="fu">where</span>(vciMasked<span class="op">.</span><span class="fu">gte</span>(<span class="dv">40</span>)<span class="op">.</span><span class="fu">and</span>(vciMasked<span class="op">.</span><span class="fu">lt</span>(<span class="dv">60</span>))<span class="op">,</span> <span class="dv">2</span>)</span>
<span id="cb3-112"><a href="#cb3-112" tabindex="-1"></a>  <span class="op">.</span><span class="fu">where</span>(vciMasked<span class="op">.</span><span class="fu">gte</span>(<span class="dv">60</span>)<span class="op">,</span> <span class="dv">3</span>)</span>
<span id="cb3-113"><a href="#cb3-113" tabindex="-1"></a></span>
<span id="cb3-114"><a href="#cb3-114" tabindex="-1"></a></span>
<span id="cb3-115"><a href="#cb3-115" tabindex="-1"></a><span class="kw">var</span> admin1 <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">&quot;FAO/GAUL_SIMPLIFIED_500m/2015/level1&quot;</span>)<span class="op">;</span></span>
<span id="cb3-116"><a href="#cb3-116" tabindex="-1"></a><span class="kw">var</span> karnataka <span class="op">=</span> admin1<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;ADM1_NAME&#39;</span><span class="op">,</span> <span class="st">&#39;Karnataka&#39;</span>))</span>
<span id="cb3-117"><a href="#cb3-117" tabindex="-1"></a><span class="kw">var</span> geometry <span class="op">=</span> karnataka<span class="op">.</span><span class="fu">geometry</span>()</span>
<span id="cb3-118"><a href="#cb3-118" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">centerObject</span>(geometry)</span>
<span id="cb3-119"><a href="#cb3-119" tabindex="-1"></a></span>
<span id="cb3-120"><a href="#cb3-120" tabindex="-1"></a></span>
<span id="cb3-121"><a href="#cb3-121" tabindex="-1"></a><span class="kw">var</span> conditionParams <span class="op">=</span> {<span class="dt">min</span><span class="op">:</span><span class="dv">1</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span><span class="dv">3</span><span class="op">,</span> <span class="dt">palette</span><span class="op">:</span> [<span class="st">&#39;#d7191c&#39;</span><span class="op">,</span><span class="st">&#39;#fdae61&#39;</span><span class="op">,</span><span class="st">&#39;#91cf60&#39;</span>]}</span>
<span id="cb3-122"><a href="#cb3-122" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(condition<span class="op">.</span><span class="fu">clip</span>(geometry)<span class="op">,</span> conditionParams<span class="op">,</span> <span class="st">&#39;Vegetation Condition&#39;</span>)</span>
<span id="cb3-123"><a href="#cb3-123" tabindex="-1"></a></span>
<span id="cb3-124"><a href="#cb3-124" tabindex="-1"></a><span class="co">// Create a Pie-Chart of Vegetation Condition for the State</span></span>
<span id="cb3-125"><a href="#cb3-125" tabindex="-1"></a><span class="co">// Code adapted from </span></span>
<span id="cb3-126"><a href="#cb3-126" tabindex="-1"></a><span class="co">// https://developers.google.com/earth-engine/tutorials/tutorial_global_surface_water_04</span></span>
<span id="cb3-127"><a href="#cb3-127" tabindex="-1"></a></span>
<span id="cb3-128"><a href="#cb3-128" tabindex="-1"></a><span class="kw">var</span> areaImage <span class="op">=</span>  ee<span class="op">.</span><span class="at">Image</span><span class="op">.</span><span class="fu">pixelArea</span>()<span class="op">.</span><span class="fu">divide</span>(<span class="fl">1e5</span>)<span class="op">.</span><span class="fu">addBands</span>(condition)<span class="op">;</span></span>
<span id="cb3-129"><a href="#cb3-129" tabindex="-1"></a></span>
<span id="cb3-130"><a href="#cb3-130" tabindex="-1"></a><span class="co">// Run a Grouped Reducer to get area by class</span></span>
<span id="cb3-131"><a href="#cb3-131" tabindex="-1"></a><span class="kw">var</span> stats <span class="op">=</span> areaImage<span class="op">.</span><span class="fu">reduceRegion</span>({</span>
<span id="cb3-132"><a href="#cb3-132" tabindex="-1"></a>  <span class="dt">reducer</span><span class="op">:</span> ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">sum</span>()<span class="op">.</span><span class="fu">group</span>({</span>
<span id="cb3-133"><a href="#cb3-133" tabindex="-1"></a>    <span class="dt">groupField</span><span class="op">:</span> <span class="dv">1</span><span class="op">,</span></span>
<span id="cb3-134"><a href="#cb3-134" tabindex="-1"></a>    <span class="dt">groupName</span><span class="op">:</span> <span class="st">&#39;class&#39;</span><span class="op">,</span></span>
<span id="cb3-135"><a href="#cb3-135" tabindex="-1"></a>  })<span class="op">,</span></span>
<span id="cb3-136"><a href="#cb3-136" tabindex="-1"></a>  <span class="dt">geometry</span><span class="op">:</span> geometry<span class="op">,</span></span>
<span id="cb3-137"><a href="#cb3-137" tabindex="-1"></a>  <span class="dt">scale</span><span class="op">:</span> <span class="dv">500</span><span class="op">,</span></span>
<span id="cb3-138"><a href="#cb3-138" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb3-139"><a href="#cb3-139" tabindex="-1"></a></span>
<span id="cb3-140"><a href="#cb3-140" tabindex="-1"></a><span class="kw">var</span> areaStatsList <span class="op">=</span> ee<span class="op">.</span><span class="fu">List</span>(stats<span class="op">.</span><span class="fu">get</span>(<span class="st">&#39;groups&#39;</span>))<span class="op">;</span></span>
<span id="cb3-141"><a href="#cb3-141" tabindex="-1"></a></span>
<span id="cb3-142"><a href="#cb3-142" tabindex="-1"></a><span class="co">// Define Dictionaries for chart labels and colors</span></span>
<span id="cb3-143"><a href="#cb3-143" tabindex="-1"></a><span class="kw">var</span> classNames <span class="op">=</span> ee<span class="op">.</span><span class="fu">Dictionary</span>({</span>
<span id="cb3-144"><a href="#cb3-144" tabindex="-1"></a>  <span class="st">&#39;1&#39;</span><span class="op">:</span> <span class="st">&#39;Poor&#39;</span><span class="op">,</span></span>
<span id="cb3-145"><a href="#cb3-145" tabindex="-1"></a>  <span class="st">&#39;2&#39;</span><span class="op">:</span> <span class="st">&#39;Fair&#39;</span><span class="op">,</span></span>
<span id="cb3-146"><a href="#cb3-146" tabindex="-1"></a>  <span class="st">&#39;3&#39;</span><span class="op">:</span> <span class="st">&#39;Good&#39;</span></span>
<span id="cb3-147"><a href="#cb3-147" tabindex="-1"></a>})</span>
<span id="cb3-148"><a href="#cb3-148" tabindex="-1"></a><span class="kw">var</span> classPalette <span class="op">=</span> ee<span class="op">.</span><span class="fu">Dictionary</span>({</span>
<span id="cb3-149"><a href="#cb3-149" tabindex="-1"></a>  <span class="st">&#39;1&#39;</span><span class="op">:</span> <span class="st">&#39;#d7191c&#39;</span><span class="op">,</span></span>
<span id="cb3-150"><a href="#cb3-150" tabindex="-1"></a>  <span class="st">&#39;2&#39;</span><span class="op">:</span> <span class="st">&#39;#fdae61&#39;</span><span class="op">,</span></span>
<span id="cb3-151"><a href="#cb3-151" tabindex="-1"></a>  <span class="st">&#39;3&#39;</span><span class="op">:</span> <span class="st">&#39;#91cf60&#39;</span></span>
<span id="cb3-152"><a href="#cb3-152" tabindex="-1"></a>})</span>
<span id="cb3-153"><a href="#cb3-153" tabindex="-1"></a></span>
<span id="cb3-154"><a href="#cb3-154" tabindex="-1"></a><span class="co">// Convert the group stats results to a feature collection</span></span>
<span id="cb3-155"><a href="#cb3-155" tabindex="-1"></a><span class="kw">function</span> <span class="fu">createFeature</span>(areaStats) {</span>
<span id="cb3-156"><a href="#cb3-156" tabindex="-1"></a>  areaStats <span class="op">=</span> ee<span class="op">.</span><span class="fu">Dictionary</span>(areaStats)<span class="op">;</span></span>
<span id="cb3-157"><a href="#cb3-157" tabindex="-1"></a>  <span class="kw">var</span> classNumber <span class="op">=</span> ee<span class="op">.</span><span class="fu">Number</span>(areaStats<span class="op">.</span><span class="fu">get</span>(<span class="st">&#39;class&#39;</span>))<span class="op">.</span><span class="fu">format</span>(<span class="st">&#39;%d&#39;</span>)<span class="op">;</span></span>
<span id="cb3-158"><a href="#cb3-158" tabindex="-1"></a>  <span class="kw">var</span> result <span class="op">=</span> {</span>
<span id="cb3-159"><a href="#cb3-159" tabindex="-1"></a>      <span class="st">&#39;class&#39;</span><span class="op">:</span> classNumber<span class="op">,</span></span>
<span id="cb3-160"><a href="#cb3-160" tabindex="-1"></a>      <span class="st">&#39;class_name&#39;</span><span class="op">:</span> classNames<span class="op">.</span><span class="fu">get</span>(classNumber)<span class="op">,</span></span>
<span id="cb3-161"><a href="#cb3-161" tabindex="-1"></a>      <span class="st">&#39;palette&#39;</span><span class="op">:</span> classPalette<span class="op">.</span><span class="fu">get</span>(classNumber)<span class="op">,</span></span>
<span id="cb3-162"><a href="#cb3-162" tabindex="-1"></a>      <span class="st">&#39;area_hectares&#39;</span><span class="op">:</span> areaStats<span class="op">.</span><span class="fu">get</span>(<span class="st">&#39;sum&#39;</span>)</span>
<span id="cb3-163"><a href="#cb3-163" tabindex="-1"></a>  }<span class="op">;</span></span>
<span id="cb3-164"><a href="#cb3-164" tabindex="-1"></a>  <span class="cf">return</span> ee<span class="op">.</span><span class="fu">Feature</span>(<span class="kw">null</span><span class="op">,</span> result)<span class="op">;</span>   <span class="co">// Creates a feature without a geometry.</span></span>
<span id="cb3-165"><a href="#cb3-165" tabindex="-1"></a>}</span>
<span id="cb3-166"><a href="#cb3-166" tabindex="-1"></a><span class="kw">var</span> fc <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(areaStatsList<span class="op">.</span><span class="fu">map</span>(createFeature))</span>
<span id="cb3-167"><a href="#cb3-167" tabindex="-1"></a></span>
<span id="cb3-168"><a href="#cb3-168" tabindex="-1"></a><span class="co">// Create a JSON dictionary that defines piechart colors based on the</span></span>
<span id="cb3-169"><a href="#cb3-169" tabindex="-1"></a><span class="co">// transition class palette.</span></span>
<span id="cb3-170"><a href="#cb3-170" tabindex="-1"></a><span class="co">// https://developers.google.com/chart/interactive/docs/gallery/piechart</span></span>
<span id="cb3-171"><a href="#cb3-171" tabindex="-1"></a><span class="co">// .getInfo() is need to convert server object to JSON</span></span>
<span id="cb3-172"><a href="#cb3-172" tabindex="-1"></a><span class="kw">function</span> <span class="fu">createPieChartSliceDictionary</span>(fc) {</span>
<span id="cb3-173"><a href="#cb3-173" tabindex="-1"></a>  <span class="cf">return</span> ee<span class="op">.</span><span class="fu">List</span>(fc<span class="op">.</span><span class="fu">aggregate_array</span>(<span class="st">&#39;palette&#39;</span>))</span>
<span id="cb3-174"><a href="#cb3-174" tabindex="-1"></a>    <span class="op">.</span><span class="fu">map</span>(<span class="kw">function</span>(p) { <span class="cf">return</span> {<span class="st">&#39;color&#39;</span><span class="op">:</span> p}<span class="op">;</span> })<span class="op">.</span><span class="fu">getInfo</span>()<span class="op">;</span></span>
<span id="cb3-175"><a href="#cb3-175" tabindex="-1"></a>}</span>
<span id="cb3-176"><a href="#cb3-176" tabindex="-1"></a><span class="kw">var</span> chart <span class="op">=</span> ui<span class="op">.</span><span class="at">Chart</span><span class="op">.</span><span class="at">feature</span><span class="op">.</span><span class="fu">byFeature</span>({</span>
<span id="cb3-177"><a href="#cb3-177" tabindex="-1"></a>    <span class="dt">features</span><span class="op">:</span> fc<span class="op">,</span></span>
<span id="cb3-178"><a href="#cb3-178" tabindex="-1"></a>    <span class="dt">xProperty</span><span class="op">:</span> <span class="st">&#39;class_name&#39;</span><span class="op">,</span></span>
<span id="cb3-179"><a href="#cb3-179" tabindex="-1"></a>    <span class="dt">yProperties</span><span class="op">:</span> [<span class="st">&#39;area_hectares&#39;</span><span class="op">,</span> <span class="st">&#39;class&#39;</span>]</span>
<span id="cb3-180"><a href="#cb3-180" tabindex="-1"></a>  })</span>
<span id="cb3-181"><a href="#cb3-181" tabindex="-1"></a>  <span class="op">.</span><span class="fu">setChartType</span>(<span class="st">&#39;PieChart&#39;</span>)</span>
<span id="cb3-182"><a href="#cb3-182" tabindex="-1"></a>  <span class="op">.</span><span class="fu">setOptions</span>({</span>
<span id="cb3-183"><a href="#cb3-183" tabindex="-1"></a>    <span class="dt">title</span><span class="op">:</span> <span class="st">&#39;Summary of Vegetation Condition&#39;</span><span class="op">,</span></span>
<span id="cb3-184"><a href="#cb3-184" tabindex="-1"></a>    <span class="dt">slices</span><span class="op">:</span> <span class="fu">createPieChartSliceDictionary</span>(fc)<span class="op">,</span></span>
<span id="cb3-185"><a href="#cb3-185" tabindex="-1"></a>    <span class="dt">sliceVisibilityThreshold</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span> <span class="co">// don&#39;t group small slices</span></span>
<span id="cb3-186"><a href="#cb3-186" tabindex="-1"></a>    <span class="dt">is3D</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb3-187"><a href="#cb3-187" tabindex="-1"></a></span>
<span id="cb3-188"><a href="#cb3-188" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb3-189"><a href="#cb3-189" tabindex="-1"></a><span class="fu">print</span>(chart)<span class="op">;</span></span></code></pre></div>
</div>
</div>
<div id="hydrology" class="section level1">
<h1>Hydrology</h1>
<div id="chart-cumulative-rainfall" class="section level2">
<h2>Chart Cumulative Rainfall</h2>
<p><a
href="https://code.earthengine.google.com/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3ASupplement%2FHydrology%2FChart_Cumulative_Rainfall"
target="_blank">Open in Code Editor ↗</a></p>
<div class="sourceCode" id="cb4"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a><span class="kw">var</span> chirpsDaily <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&quot;UCSB-CHG/CHIRPS/DAILY&quot;</span>)<span class="op">;</span></span>
<span id="cb4-2"><a href="#cb4-2" tabindex="-1"></a></span>
<span id="cb4-3"><a href="#cb4-3" tabindex="-1"></a><span class="co">// Define a water year</span></span>
<span id="cb4-4"><a href="#cb4-4" tabindex="-1"></a><span class="kw">var</span> startDate <span class="op">=</span> ee<span class="op">.</span><span class="fu">Date</span>(<span class="st">&#39;2020-06-01&#39;</span>)</span>
<span id="cb4-5"><a href="#cb4-5" tabindex="-1"></a><span class="kw">var</span> endDate <span class="op">=</span> ee<span class="op">.</span><span class="fu">Date</span>(<span class="st">&#39;2020-09-30&#39;</span>)</span>
<span id="cb4-6"><a href="#cb4-6" tabindex="-1"></a></span>
<span id="cb4-7"><a href="#cb4-7" tabindex="-1"></a><span class="kw">var</span> days <span class="op">=</span> endDate<span class="op">.</span><span class="fu">difference</span>(startDate<span class="op">,</span> <span class="st">&#39;day&#39;</span>)</span>
<span id="cb4-8"><a href="#cb4-8" tabindex="-1"></a><span class="kw">var</span> daysList <span class="op">=</span> ee<span class="op">.</span><span class="at">List</span><span class="op">.</span><span class="fu">sequence</span>(<span class="dv">1</span><span class="op">,</span> days)</span>
<span id="cb4-9"><a href="#cb4-9" tabindex="-1"></a></span>
<span id="cb4-10"><a href="#cb4-10" tabindex="-1"></a><span class="co">// map() a function over the list of days</span></span>
<span id="cb4-11"><a href="#cb4-11" tabindex="-1"></a></span>
<span id="cb4-12"><a href="#cb4-12" tabindex="-1"></a><span class="kw">var</span> cumulativeImages <span class="op">=</span> daysList<span class="op">.</span><span class="fu">map</span>(<span class="kw">function</span>(day) {</span>
<span id="cb4-13"><a href="#cb4-13" tabindex="-1"></a>  <span class="co">// Filter the collection from start date till the day of computatiton</span></span>
<span id="cb4-14"><a href="#cb4-14" tabindex="-1"></a>  <span class="kw">var</span> begin <span class="op">=</span> startDate</span>
<span id="cb4-15"><a href="#cb4-15" tabindex="-1"></a>  <span class="kw">var</span> current <span class="op">=</span> startDate<span class="op">.</span><span class="fu">advance</span>(day<span class="op">,</span> <span class="st">&#39;day&#39;</span>)</span>
<span id="cb4-16"><a href="#cb4-16" tabindex="-1"></a>  <span class="kw">var</span> filtered <span class="op">=</span> chirpsDaily<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(begin<span class="op">,</span> current))</span>
<span id="cb4-17"><a href="#cb4-17" tabindex="-1"></a>  <span class="co">// Use sum() to calculate total rainfall in the period</span></span>
<span id="cb4-18"><a href="#cb4-18" tabindex="-1"></a>  <span class="co">// Make sure to set the start_time for the image</span></span>
<span id="cb4-19"><a href="#cb4-19" tabindex="-1"></a>  <span class="kw">var</span> cumulativeImage <span class="op">=</span> filtered<span class="op">.</span><span class="fu">reduce</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">sum</span>())</span>
<span id="cb4-20"><a href="#cb4-20" tabindex="-1"></a>    <span class="op">.</span><span class="fu">set</span>(<span class="st">&#39;system:time_start&#39;</span><span class="op">,</span> current<span class="op">.</span><span class="fu">millis</span>())</span>
<span id="cb4-21"><a href="#cb4-21" tabindex="-1"></a>  <span class="cf">return</span> cumulativeImage</span>
<span id="cb4-22"><a href="#cb4-22" tabindex="-1"></a>})</span>
<span id="cb4-23"><a href="#cb4-23" tabindex="-1"></a></span>
<span id="cb4-24"><a href="#cb4-24" tabindex="-1"></a><span class="co">// We have list of images containing cumulative rainfall</span></span>
<span id="cb4-25"><a href="#cb4-25" tabindex="-1"></a><span class="co">// Put them in a collection</span></span>
<span id="cb4-26"><a href="#cb4-26" tabindex="-1"></a><span class="kw">var</span> cumulativeCol <span class="op">=</span> ee<span class="op">.</span><span class="at">ImageCollection</span><span class="op">.</span><span class="fu">fromImages</span>(cumulativeImages)</span>
<span id="cb4-27"><a href="#cb4-27" tabindex="-1"></a></span>
<span id="cb4-28"><a href="#cb4-28" tabindex="-1"></a><span class="co">// Create a point with coordinates for the city of Bengaluru, India</span></span>
<span id="cb4-29"><a href="#cb4-29" tabindex="-1"></a><span class="kw">var</span> point <span class="op">=</span> ee<span class="op">.</span><span class="at">Geometry</span><span class="op">.</span><span class="fu">Point</span>(<span class="fl">77.5946</span><span class="op">,</span> <span class="fl">12.9716</span>)</span>
<span id="cb4-30"><a href="#cb4-30" tabindex="-1"></a></span>
<span id="cb4-31"><a href="#cb4-31" tabindex="-1"></a><span class="co">// Chart cumulative rainfall</span></span>
<span id="cb4-32"><a href="#cb4-32" tabindex="-1"></a><span class="kw">var</span> chart <span class="op">=</span> ui<span class="op">.</span><span class="at">Chart</span><span class="op">.</span><span class="at">image</span><span class="op">.</span><span class="fu">series</span>({</span>
<span id="cb4-33"><a href="#cb4-33" tabindex="-1"></a>  <span class="dt">imageCollection</span><span class="op">:</span> cumulativeCol<span class="op">,</span> </span>
<span id="cb4-34"><a href="#cb4-34" tabindex="-1"></a>  <span class="dt">region</span><span class="op">:</span> point<span class="op">,</span> </span>
<span id="cb4-35"><a href="#cb4-35" tabindex="-1"></a>  <span class="dt">reducer</span><span class="op">:</span> ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">mean</span>()<span class="op">,</span> </span>
<span id="cb4-36"><a href="#cb4-36" tabindex="-1"></a>  <span class="dt">scale</span><span class="op">:</span> <span class="dv">5566</span><span class="op">,</span></span>
<span id="cb4-37"><a href="#cb4-37" tabindex="-1"></a>})<span class="op">.</span><span class="fu">setOptions</span>({</span>
<span id="cb4-38"><a href="#cb4-38" tabindex="-1"></a>      <span class="dt">interpolateNulls</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb4-39"><a href="#cb4-39" tabindex="-1"></a>      <span class="dt">lineWidth</span><span class="op">:</span> <span class="dv">1</span><span class="op">,</span></span>
<span id="cb4-40"><a href="#cb4-40" tabindex="-1"></a>      <span class="dt">pointSize</span><span class="op">:</span> <span class="dv">3</span><span class="op">,</span></span>
<span id="cb4-41"><a href="#cb4-41" tabindex="-1"></a>      <span class="dt">title</span><span class="op">:</span> <span class="st">&#39;Cumulative Monsoon Rainfall at Bengaluru (2020)&#39;</span><span class="op">,</span></span>
<span id="cb4-42"><a href="#cb4-42" tabindex="-1"></a>      <span class="dt">vAxis</span><span class="op">:</span> {<span class="dt">title</span><span class="op">:</span> <span class="st">&#39;Cumulative Rainfall (mm)&#39;</span>}<span class="op">,</span></span>
<span id="cb4-43"><a href="#cb4-43" tabindex="-1"></a>      <span class="dt">hAxis</span><span class="op">:</span> {<span class="dt">title</span><span class="op">:</span> <span class="st">&#39;Month&#39;</span><span class="op">,</span> <span class="dt">format</span><span class="op">:</span> <span class="st">&#39;YYYY-MMM&#39;</span>}</span>
<span id="cb4-44"><a href="#cb4-44" tabindex="-1"></a></span>
<span id="cb4-45"><a href="#cb4-45" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb4-46"><a href="#cb4-46" tabindex="-1"></a><span class="fu">print</span>(chart)<span class="op">;</span></span></code></pre></div>
</div>
<div id="exporting-country-wide-precipitation-rasters"
class="section level2">
<h2>Exporting Country-wide Precipitation Rasters</h2>
<p>This script shows how to create a multi-band raster from a collection
and export it. If you want to export each image separately, see our
guide on <a
href="https://courses.spatialthoughts.com/end-to-end-gee-supplement.html#exporting-imagecollections">Exporting
ImageCollections</a>.</p>
<p><a
href="https://code.earthengine.google.co.in/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3ASupplement%2FHydrology%2FExporting_Precipitation_Rasters"
target="_blank">Open in Code Editor ↗</a></p>
<div class="sourceCode" id="cb5"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a><span class="co">// This script demonstrates how to create and export</span></span>
<span id="cb5-2"><a href="#cb5-2" tabindex="-1"></a><span class="co">// country/continent-wide precipitation data from CHIRPS</span></span>
<span id="cb5-3"><a href="#cb5-3" tabindex="-1"></a><span class="co">// The goal is to create 1 yearly image with 12 bands -</span></span>
<span id="cb5-4"><a href="#cb5-4" tabindex="-1"></a><span class="co">// with each band having the monthly total precipitation</span></span>
<span id="cb5-5"><a href="#cb5-5" tabindex="-1"></a><span class="kw">var</span> chirps <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&quot;UCSB-CHG/CHIRPS/PENTAD&quot;</span>)<span class="op">;</span></span>
<span id="cb5-6"><a href="#cb5-6" tabindex="-1"></a><span class="kw">var</span> lsib <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">&quot;USDOS/LSIB_SIMPLE/2017&quot;</span>)<span class="op">;</span></span>
<span id="cb5-7"><a href="#cb5-7" tabindex="-1"></a></span>
<span id="cb5-8"><a href="#cb5-8" tabindex="-1"></a><span class="kw">var</span> region <span class="op">=</span> lsib<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;wld_rgn&#39;</span><span class="op">,</span> <span class="st">&#39;South America&#39;</span>))</span>
<span id="cb5-9"><a href="#cb5-9" tabindex="-1"></a><span class="kw">var</span> geometry <span class="op">=</span> region<span class="op">.</span><span class="fu">geometry</span>()</span>
<span id="cb5-10"><a href="#cb5-10" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">centerObject</span>(geometry)</span>
<span id="cb5-11"><a href="#cb5-11" tabindex="-1"></a></span>
<span id="cb5-12"><a href="#cb5-12" tabindex="-1"></a><span class="kw">var</span> year <span class="op">=</span> <span class="dv">2020</span></span>
<span id="cb5-13"><a href="#cb5-13" tabindex="-1"></a><span class="kw">var</span> months <span class="op">=</span> ee<span class="op">.</span><span class="at">List</span><span class="op">.</span><span class="fu">sequence</span>(<span class="dv">1</span><span class="op">,</span> <span class="dv">12</span>)</span>
<span id="cb5-14"><a href="#cb5-14" tabindex="-1"></a></span>
<span id="cb5-15"><a href="#cb5-15" tabindex="-1"></a><span class="co">// Map over the years and create a monthly totals collection</span></span>
<span id="cb5-16"><a href="#cb5-16" tabindex="-1"></a><span class="kw">var</span> monthlyImages <span class="op">=</span> months<span class="op">.</span><span class="fu">map</span>(<span class="kw">function</span>(month) {</span>
<span id="cb5-17"><a href="#cb5-17" tabindex="-1"></a>    <span class="kw">var</span> filtered <span class="op">=</span> chirps</span>
<span id="cb5-18"><a href="#cb5-18" tabindex="-1"></a>      <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">calendarRange</span>(year<span class="op">,</span> year<span class="op">,</span> <span class="st">&#39;year&#39;</span>))</span>
<span id="cb5-19"><a href="#cb5-19" tabindex="-1"></a>      <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">calendarRange</span>(month<span class="op">,</span> month<span class="op">,</span> <span class="st">&#39;month&#39;</span>))</span>
<span id="cb5-20"><a href="#cb5-20" tabindex="-1"></a>    <span class="kw">var</span> monthly <span class="op">=</span> filtered<span class="op">.</span><span class="fu">sum</span>()</span>
<span id="cb5-21"><a href="#cb5-21" tabindex="-1"></a>    <span class="cf">return</span> monthly<span class="op">.</span><span class="fu">set</span>({<span class="st">&#39;month&#39;</span><span class="op">:</span> month<span class="op">,</span> <span class="st">&#39;year&#39;</span><span class="op">:</span> year})</span>
<span id="cb5-22"><a href="#cb5-22" tabindex="-1"></a>  })</span>
<span id="cb5-23"><a href="#cb5-23" tabindex="-1"></a></span>
<span id="cb5-24"><a href="#cb5-24" tabindex="-1"></a><span class="co">// We now have 1 image per month for the chosen year</span></span>
<span id="cb5-25"><a href="#cb5-25" tabindex="-1"></a><span class="kw">var</span> monthlyCol <span class="op">=</span> ee<span class="op">.</span><span class="at">ImageCollection</span><span class="op">.</span><span class="fu">fromImages</span>(monthlyImages)</span>
<span id="cb5-26"><a href="#cb5-26" tabindex="-1"></a><span class="fu">print</span>(<span class="st">&#39;Image Collection:&#39;</span><span class="op">,</span> monthlyCol)</span>
<span id="cb5-27"><a href="#cb5-27" tabindex="-1"></a></span>
<span id="cb5-28"><a href="#cb5-28" tabindex="-1"></a><span class="co">// Use the toBands() function to create a multi-band image</span></span>
<span id="cb5-29"><a href="#cb5-29" tabindex="-1"></a><span class="kw">var</span> yearImage <span class="op">=</span> monthlyCol<span class="op">.</span><span class="fu">toBands</span>()</span>
<span id="cb5-30"><a href="#cb5-30" tabindex="-1"></a></span>
<span id="cb5-31"><a href="#cb5-31" tabindex="-1"></a><span class="co">// Rename the bands so they have names &#39;1&#39;, &#39;2&#39; ... &#39;12&#39;</span></span>
<span id="cb5-32"><a href="#cb5-32" tabindex="-1"></a><span class="kw">var</span> bandNames <span class="op">=</span> months<span class="op">.</span><span class="fu">map</span>(<span class="kw">function</span>(month) {</span>
<span id="cb5-33"><a href="#cb5-33" tabindex="-1"></a>  <span class="cf">return</span> ee<span class="op">.</span><span class="fu">Number</span>(month)<span class="op">.</span><span class="fu">format</span>(<span class="st">&#39;%d&#39;</span>)</span>
<span id="cb5-34"><a href="#cb5-34" tabindex="-1"></a>})</span>
<span id="cb5-35"><a href="#cb5-35" tabindex="-1"></a><span class="kw">var</span> yearImage <span class="op">=</span> yearImage<span class="op">.</span><span class="fu">rename</span>(bandNames)</span>
<span id="cb5-36"><a href="#cb5-36" tabindex="-1"></a><span class="fu">print</span>(<span class="st">&#39;Multi-band Image&#39;</span><span class="op">,</span> yearImage)</span>
<span id="cb5-37"><a href="#cb5-37" tabindex="-1"></a></span>
<span id="cb5-38"><a href="#cb5-38" tabindex="-1"></a><span class="co">// Export to GeoTiff</span></span>
<span id="cb5-39"><a href="#cb5-39" tabindex="-1"></a><span class="co">// The resulting region is large and geometry is complex/</span></span>
<span id="cb5-40"><a href="#cb5-40" tabindex="-1"></a><span class="co">// Extract the bounding-box to be used in the export.</span></span>
<span id="cb5-41"><a href="#cb5-41" tabindex="-1"></a><span class="kw">var</span> exportGeometry <span class="op">=</span> geometry<span class="op">.</span><span class="fu">bounds</span>()</span>
<span id="cb5-42"><a href="#cb5-42" tabindex="-1"></a></span>
<span id="cb5-43"><a href="#cb5-43" tabindex="-1"></a>Export<span class="op">.</span><span class="at">image</span><span class="op">.</span><span class="fu">toDrive</span>({</span>
<span id="cb5-44"><a href="#cb5-44" tabindex="-1"></a>  <span class="dt">image</span><span class="op">:</span> yearImage<span class="op">,</span></span>
<span id="cb5-45"><a href="#cb5-45" tabindex="-1"></a>  <span class="dt">description</span><span class="op">:</span> <span class="st">&#39;multi_band_image_export&#39;</span><span class="op">,</span></span>
<span id="cb5-46"><a href="#cb5-46" tabindex="-1"></a>  <span class="dt">folder</span><span class="op">:</span> <span class="st">&#39;earthengine&#39;</span><span class="op">,</span></span>
<span id="cb5-47"><a href="#cb5-47" tabindex="-1"></a>  <span class="dt">fileNamePrefix</span><span class="op">:</span> <span class="st">&#39;precipitation&#39;</span><span class="op">,</span></span>
<span id="cb5-48"><a href="#cb5-48" tabindex="-1"></a>  <span class="dt">region</span><span class="op">:</span> exportGeometry<span class="op">,</span></span>
<span id="cb5-49"><a href="#cb5-49" tabindex="-1"></a>  <span class="dt">scale</span><span class="op">:</span> <span class="dv">5566</span><span class="op">,</span></span>
<span id="cb5-50"><a href="#cb5-50" tabindex="-1"></a>  <span class="dt">crs</span><span class="op">:</span> <span class="st">&#39;EPSG:4326&#39;</span><span class="op">,</span></span>
<span id="cb5-51"><a href="#cb5-51" tabindex="-1"></a>  <span class="dt">maxPixels</span><span class="op">:</span> <span class="fl">1e10</span></span>
<span id="cb5-52"><a href="#cb5-52" tabindex="-1"></a>})</span>
<span id="cb5-53"><a href="#cb5-53" tabindex="-1"></a></span>
<span id="cb5-54"><a href="#cb5-54" tabindex="-1"></a><span class="co">// Visualize the collection by creating a yearly total image</span></span>
<span id="cb5-55"><a href="#cb5-55" tabindex="-1"></a><span class="kw">var</span> visParams <span class="op">=</span> {</span>
<span id="cb5-56"><a href="#cb5-56" tabindex="-1"></a>  <span class="dt">min</span><span class="op">:</span><span class="dv">0</span><span class="op">,</span></span>
<span id="cb5-57"><a href="#cb5-57" tabindex="-1"></a>  <span class="dt">max</span><span class="op">:</span> <span class="dv">2500</span><span class="op">,</span></span>
<span id="cb5-58"><a href="#cb5-58" tabindex="-1"></a>  <span class="dt">palette</span><span class="op">:</span> [<span class="st">&#39;#f1eef6&#39;</span><span class="op">,</span><span class="st">&#39;#bdc9e1&#39;</span><span class="op">,</span><span class="st">&#39;#74a9cf&#39;</span><span class="op">,</span><span class="st">&#39;#2b8cbe&#39;</span><span class="op">,</span><span class="st">&#39;#045a8d&#39;</span>]</span>
<span id="cb5-59"><a href="#cb5-59" tabindex="-1"></a>}</span>
<span id="cb5-60"><a href="#cb5-60" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(monthlyCol<span class="op">.</span><span class="fu">sum</span>()<span class="op">.</span><span class="fu">clip</span>(geometry)<span class="op">,</span> visParams<span class="op">,</span> <span class="st">&#39;Yearly Precipitation&#39;</span>)</span></code></pre></div>
</div>
<div id="exporting-pixel-values-as-shapefiles" class="section level2">
<h2>Exporting Pixel Values as Shapefiles</h2>
<p><a
href="https://code.earthengine.google.co.in/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3ASupplement%2FHydrology%2FExporting_Pixel_Values"
target="_blank">Open in Code Editor ↗</a></p>
<div class="sourceCode" id="cb6"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a><span class="co">// Example script showing how to export a shapefile</span></span>
<span id="cb6-2"><a href="#cb6-2" tabindex="-1"></a><span class="co">// with the value of each pixel in an image of</span></span>
<span id="cb6-3"><a href="#cb6-3" tabindex="-1"></a><span class="co">// a gridded precipitation dataset</span></span>
<span id="cb6-4"><a href="#cb6-4" tabindex="-1"></a></span>
<span id="cb6-5"><a href="#cb6-5" tabindex="-1"></a><span class="kw">var</span> chirps <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&#39;UCSB-CHG/CHIRPS/DAILY&#39;</span>)<span class="op">;</span></span>
<span id="cb6-6"><a href="#cb6-6" tabindex="-1"></a><span class="kw">var</span> year <span class="op">=</span> <span class="dv">2019</span><span class="op">;</span></span>
<span id="cb6-7"><a href="#cb6-7" tabindex="-1"></a><span class="kw">var</span> startDate <span class="op">=</span> ee<span class="op">.</span><span class="at">Date</span><span class="op">.</span><span class="fu">fromYMD</span>(year<span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb6-8"><a href="#cb6-8" tabindex="-1"></a><span class="kw">var</span> endDate <span class="op">=</span> startDate<span class="op">.</span><span class="fu">advance</span>(<span class="dv">1</span><span class="op">,</span> <span class="st">&#39;year&#39;</span>)<span class="op">;</span></span>
<span id="cb6-9"><a href="#cb6-9" tabindex="-1"></a></span>
<span id="cb6-10"><a href="#cb6-10" tabindex="-1"></a><span class="kw">var</span> dateFilter <span class="op">=</span> ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(startDate<span class="op">,</span> endDate)<span class="op">;</span></span>
<span id="cb6-11"><a href="#cb6-11" tabindex="-1"></a><span class="kw">var</span> yearFiltered <span class="op">=</span> chirps<span class="op">.</span><span class="fu">filter</span>(dateFilter)<span class="op">;</span></span>
<span id="cb6-12"><a href="#cb6-12" tabindex="-1"></a></span>
<span id="cb6-13"><a href="#cb6-13" tabindex="-1"></a><span class="fu">print</span>(yearFiltered)</span>
<span id="cb6-14"><a href="#cb6-14" tabindex="-1"></a></span>
<span id="cb6-15"><a href="#cb6-15" tabindex="-1"></a><span class="co">// Calculate the total yearly precipitation</span></span>
<span id="cb6-16"><a href="#cb6-16" tabindex="-1"></a><span class="kw">var</span> total <span class="op">=</span> yearFiltered<span class="op">.</span><span class="fu">sum</span>()<span class="op">;</span></span>
<span id="cb6-17"><a href="#cb6-17" tabindex="-1"></a><span class="fu">print</span>(total)<span class="op">;</span></span>
<span id="cb6-18"><a href="#cb6-18" tabindex="-1"></a></span>
<span id="cb6-19"><a href="#cb6-19" tabindex="-1"></a><span class="co">// Select a region</span></span>
<span id="cb6-20"><a href="#cb6-20" tabindex="-1"></a><span class="co">// If you want your own region, upload a shapefile</span></span>
<span id="cb6-21"><a href="#cb6-21" tabindex="-1"></a><span class="co">// and use the resulting asset instead</span></span>
<span id="cb6-22"><a href="#cb6-22" tabindex="-1"></a><span class="kw">var</span> admin2 <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">&quot;FAO/GAUL_SIMPLIFIED_500m/2015/level2&quot;</span>)<span class="op">;</span></span>
<span id="cb6-23"><a href="#cb6-23" tabindex="-1"></a><span class="kw">var</span> selected <span class="op">=</span> admin2<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;ADM2_NAME&#39;</span><span class="op">,</span> <span class="st">&#39;Bangalore Urban&#39;</span>))<span class="op">;</span></span>
<span id="cb6-24"><a href="#cb6-24" tabindex="-1"></a><span class="kw">var</span> geometry <span class="op">=</span> selected<span class="op">.</span><span class="fu">geometry</span>()<span class="op">;</span></span>
<span id="cb6-25"><a href="#cb6-25" tabindex="-1"></a></span>
<span id="cb6-26"><a href="#cb6-26" tabindex="-1"></a><span class="co">// We want to extract the value at each pixel</span></span>
<span id="cb6-27"><a href="#cb6-27" tabindex="-1"></a></span>
<span id="cb6-28"><a href="#cb6-28" tabindex="-1"></a><span class="co">// Add lat and lon bands</span></span>
<span id="cb6-29"><a href="#cb6-29" tabindex="-1"></a><span class="co">// This will give us the lat and lon of each pixel center</span></span>
<span id="cb6-30"><a href="#cb6-30" tabindex="-1"></a><span class="kw">var</span> imageWithLonLat <span class="op">=</span> total<span class="op">.</span><span class="fu">addBands</span>(ee<span class="op">.</span><span class="at">Image</span><span class="op">.</span><span class="fu">pixelLonLat</span>())<span class="op">;</span></span>
<span id="cb6-31"><a href="#cb6-31" tabindex="-1"></a></span>
<span id="cb6-32"><a href="#cb6-32" tabindex="-1"></a><span class="co">// Use sample() to extract values at each pixel</span></span>
<span id="cb6-33"><a href="#cb6-33" tabindex="-1"></a><span class="co">// Use native projection and resolution of input dataset</span></span>
<span id="cb6-34"><a href="#cb6-34" tabindex="-1"></a><span class="kw">var</span> projection <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(chirps<span class="op">.</span><span class="fu">first</span>())<span class="op">.</span><span class="fu">projection</span>()<span class="op">;</span></span>
<span id="cb6-35"><a href="#cb6-35" tabindex="-1"></a><span class="kw">var</span> scale <span class="op">=</span> projection<span class="op">.</span><span class="fu">nominalScale</span>()<span class="op">;</span></span>
<span id="cb6-36"><a href="#cb6-36" tabindex="-1"></a><span class="kw">var</span> extracted <span class="op">=</span> imageWithLonLat<span class="op">.</span><span class="fu">sample</span>({</span>
<span id="cb6-37"><a href="#cb6-37" tabindex="-1"></a>  <span class="dt">region</span><span class="op">:</span> geometry<span class="op">,</span></span>
<span id="cb6-38"><a href="#cb6-38" tabindex="-1"></a>  <span class="dt">scale</span><span class="op">:</span> scale<span class="op">,</span></span>
<span id="cb6-39"><a href="#cb6-39" tabindex="-1"></a>  <span class="dt">projection</span><span class="op">:</span> projection<span class="op">,</span></span>
<span id="cb6-40"><a href="#cb6-40" tabindex="-1"></a>  <span class="dt">geometries</span><span class="op">:</span> <span class="kw">true</span>})<span class="op">;</span></span>
<span id="cb6-41"><a href="#cb6-41" tabindex="-1"></a></span>
<span id="cb6-42"><a href="#cb6-42" tabindex="-1"></a><span class="co">// Check the result</span></span>
<span id="cb6-43"><a href="#cb6-43" tabindex="-1"></a><span class="co">// This may time-out for large computation</span></span>
<span id="cb6-44"><a href="#cb6-44" tabindex="-1"></a><span class="co">// If that happens, just do the export directly</span></span>
<span id="cb6-45"><a href="#cb6-45" tabindex="-1"></a><span class="fu">print</span>(<span class="st">&#39;Extracted Value Sample&#39;</span><span class="op">,</span> extracted<span class="op">.</span><span class="fu">first</span>())<span class="op">;</span></span>
<span id="cb6-46"><a href="#cb6-46" tabindex="-1"></a></span>
<span id="cb6-47"><a href="#cb6-47" tabindex="-1"></a><span class="co">// Export the results</span></span>
<span id="cb6-48"><a href="#cb6-48" tabindex="-1"></a><span class="co">// Choose &#39;CSV&#39; as format if you just want a table</span></span>
<span id="cb6-49"><a href="#cb6-49" tabindex="-1"></a>Export<span class="op">.</span><span class="at">table</span><span class="op">.</span><span class="fu">toDrive</span>({</span>
<span id="cb6-50"><a href="#cb6-50" tabindex="-1"></a>  <span class="dt">collection</span><span class="op">:</span> extracted<span class="op">,</span></span>
<span id="cb6-51"><a href="#cb6-51" tabindex="-1"></a>  <span class="dt">description</span><span class="op">:</span> <span class="st">&#39;Precipitation_Pixel_Values_Export&#39;</span><span class="op">,</span></span>
<span id="cb6-52"><a href="#cb6-52" tabindex="-1"></a>  <span class="dt">folder</span><span class="op">:</span> <span class="st">&#39;earthengine&#39;</span><span class="op">,</span></span>
<span id="cb6-53"><a href="#cb6-53" tabindex="-1"></a>  <span class="dt">fileNamePrefix</span><span class="op">:</span> <span class="st">&#39;pixel_values&#39;</span><span class="op">,</span></span>
<span id="cb6-54"><a href="#cb6-54" tabindex="-1"></a>  <span class="dt">fileFormat</span><span class="op">:</span> <span class="st">&#39;SHP&#39;</span>})<span class="op">;</span></span></code></pre></div>
</div>
<div id="extracting-precipitation-time-series-at-each-pixel"
class="section level2">
<h2>Extracting Precipitation Time-Series at Each Pixel</h2>
<p><a
href="https://code.earthengine.google.co.in/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3ASupplement%2FHydrology%2FExporting_Precipitation_Time_Series"
target="_blank">Open in Code Editor ↗</a></p>
<div class="sourceCode" id="cb7"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a><span class="co">// This script shows how to extract and export</span></span>
<span id="cb7-2"><a href="#cb7-2" tabindex="-1"></a><span class="co">// daily precipitation time-series at each pixel</span></span>
<span id="cb7-3"><a href="#cb7-3" tabindex="-1"></a><span class="kw">var</span> chirps <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&#39;UCSB-CHG/CHIRPS/DAILY&#39;</span>)<span class="op">;</span></span>
<span id="cb7-4"><a href="#cb7-4" tabindex="-1"></a></span>
<span id="cb7-5"><a href="#cb7-5" tabindex="-1"></a><span class="co">// Save the scale and projection values</span></span>
<span id="cb7-6"><a href="#cb7-6" tabindex="-1"></a><span class="kw">var</span> projection <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(chirps<span class="op">.</span><span class="fu">first</span>())<span class="op">.</span><span class="fu">projection</span>()<span class="op">;</span></span>
<span id="cb7-7"><a href="#cb7-7" tabindex="-1"></a><span class="kw">var</span> scale <span class="op">=</span> projection<span class="op">.</span><span class="fu">nominalScale</span>()<span class="op">;</span></span>
<span id="cb7-8"><a href="#cb7-8" tabindex="-1"></a></span>
<span id="cb7-9"><a href="#cb7-9" tabindex="-1"></a><span class="co">// Define the start and end dates</span></span>
<span id="cb7-10"><a href="#cb7-10" tabindex="-1"></a><span class="co">// Here we are extracting 10-years of data</span></span>
<span id="cb7-11"><a href="#cb7-11" tabindex="-1"></a><span class="kw">var</span> startDate <span class="op">=</span> ee<span class="op">.</span><span class="at">Date</span><span class="op">.</span><span class="fu">fromYMD</span>(<span class="dv">2010</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb7-12"><a href="#cb7-12" tabindex="-1"></a><span class="kw">var</span> endDate <span class="op">=</span> startDate<span class="op">.</span><span class="fu">advance</span>(<span class="dv">10</span><span class="op">,</span> <span class="st">&#39;year&#39;</span>)<span class="op">;</span></span>
<span id="cb7-13"><a href="#cb7-13" tabindex="-1"></a></span>
<span id="cb7-14"><a href="#cb7-14" tabindex="-1"></a><span class="co">// Select a region</span></span>
<span id="cb7-15"><a href="#cb7-15" tabindex="-1"></a><span class="co">// If you want your own region, upload a shapefile</span></span>
<span id="cb7-16"><a href="#cb7-16" tabindex="-1"></a><span class="co">// and use the resulting asset instead</span></span>
<span id="cb7-17"><a href="#cb7-17" tabindex="-1"></a><span class="kw">var</span> admin2 <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">&quot;FAO/GAUL_SIMPLIFIED_500m/2015/level2&quot;</span>)<span class="op">;</span></span>
<span id="cb7-18"><a href="#cb7-18" tabindex="-1"></a><span class="kw">var</span> selected <span class="op">=</span> admin2<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;ADM2_NAME&#39;</span><span class="op">,</span> <span class="st">&#39;Bangalore Urban&#39;</span>))</span>
<span id="cb7-19"><a href="#cb7-19" tabindex="-1"></a><span class="kw">var</span> geometry <span class="op">=</span> selected<span class="op">.</span><span class="fu">geometry</span>()<span class="op">;</span></span>
<span id="cb7-20"><a href="#cb7-20" tabindex="-1"></a></span>
<span id="cb7-21"><a href="#cb7-21" tabindex="-1"></a><span class="kw">var</span> dateFilter <span class="op">=</span> ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(startDate<span class="op">,</span> endDate)<span class="op">;</span></span>
<span id="cb7-22"><a href="#cb7-22" tabindex="-1"></a><span class="kw">var</span> filtered <span class="op">=</span> chirps<span class="op">.</span><span class="fu">filter</span>(dateFilter)<span class="op">;</span></span>
<span id="cb7-23"><a href="#cb7-23" tabindex="-1"></a>  </span>
<span id="cb7-24"><a href="#cb7-24" tabindex="-1"></a><span class="co">// Write a function to extract values from a single image</span></span>
<span id="cb7-25"><a href="#cb7-25" tabindex="-1"></a><span class="kw">var</span> extractValues <span class="op">=</span> <span class="kw">function</span>(image) {</span>
<span id="cb7-26"><a href="#cb7-26" tabindex="-1"></a>  <span class="co">// We want to extract a time-series at each pixel</span></span>
<span id="cb7-27"><a href="#cb7-27" tabindex="-1"></a>  <span class="co">// Add a band with latlon values</span></span>
<span id="cb7-28"><a href="#cb7-28" tabindex="-1"></a>  <span class="kw">var</span> imageWithLonLat <span class="op">=</span> image<span class="op">.</span><span class="fu">addBands</span>(ee<span class="op">.</span><span class="at">Image</span><span class="op">.</span><span class="fu">pixelLonLat</span>())<span class="op">;</span></span>
<span id="cb7-29"><a href="#cb7-29" tabindex="-1"></a>  <span class="kw">var</span> extracted <span class="op">=</span> imageWithLonLat<span class="op">.</span><span class="fu">sample</span>({</span>
<span id="cb7-30"><a href="#cb7-30" tabindex="-1"></a>    <span class="dt">region</span><span class="op">:</span> geometry<span class="op">,</span></span>
<span id="cb7-31"><a href="#cb7-31" tabindex="-1"></a>    <span class="dt">scale</span><span class="op">:</span> scale<span class="op">,</span></span>
<span id="cb7-32"><a href="#cb7-32" tabindex="-1"></a>    <span class="dt">projection</span><span class="op">:</span> projection<span class="op">,</span></span>
<span id="cb7-33"><a href="#cb7-33" tabindex="-1"></a>    <span class="dt">geometries</span><span class="op">:</span> <span class="kw">false</span> </span>
<span id="cb7-34"><a href="#cb7-34" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb7-35"><a href="#cb7-35" tabindex="-1"></a>  <span class="kw">var</span> date <span class="op">=</span> image<span class="op">.</span><span class="fu">date</span>()<span class="op">.</span><span class="fu">format</span>(<span class="st">&#39;YYYY-MM-dd&#39;</span>)<span class="op">;</span></span>
<span id="cb7-36"><a href="#cb7-36" tabindex="-1"></a>  <span class="co">// Set the date for all features</span></span>
<span id="cb7-37"><a href="#cb7-37" tabindex="-1"></a>  <span class="kw">var</span> extractedWithDate <span class="op">=</span> extracted<span class="op">.</span><span class="fu">map</span>(<span class="kw">function</span>(f) {</span>
<span id="cb7-38"><a href="#cb7-38" tabindex="-1"></a>    <span class="cf">return</span> f<span class="op">.</span><span class="fu">set</span>(<span class="st">&#39;date&#39;</span><span class="op">,</span> date)<span class="op">;</span>  </span>
<span id="cb7-39"><a href="#cb7-39" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb7-40"><a href="#cb7-40" tabindex="-1"></a>  <span class="cf">return</span> extractedWithDate<span class="op">;</span></span>
<span id="cb7-41"><a href="#cb7-41" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb7-42"><a href="#cb7-42" tabindex="-1"></a></span>
<span id="cb7-43"><a href="#cb7-43" tabindex="-1"></a><span class="co">// Test the function</span></span>
<span id="cb7-44"><a href="#cb7-44" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">extractValues</span>(filtered<span class="op">.</span><span class="fu">first</span>()))<span class="op">;</span></span>
<span id="cb7-45"><a href="#cb7-45" tabindex="-1"></a></span>
<span id="cb7-46"><a href="#cb7-46" tabindex="-1"></a><span class="co">// map() the function the filtered collection</span></span>
<span id="cb7-47"><a href="#cb7-47" tabindex="-1"></a><span class="kw">var</span> timeSeries <span class="op">=</span> filtered<span class="op">.</span><span class="fu">map</span>(extractValues)<span class="op">.</span><span class="fu">flatten</span>()<span class="op">;</span></span>
<span id="cb7-48"><a href="#cb7-48" tabindex="-1"></a></span>
<span id="cb7-49"><a href="#cb7-49" tabindex="-1"></a><span class="co">// To reduce the exported data, we can also filter</span></span>
<span id="cb7-50"><a href="#cb7-50" tabindex="-1"></a><span class="co">// records with 0 precipitation</span></span>
<span id="cb7-51"><a href="#cb7-51" tabindex="-1"></a><span class="kw">var</span> timeSeriesFiltered <span class="op">=</span> timeSeries<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">gt</span>(<span class="st">&#39;precipitation&#39;</span><span class="op">,</span> <span class="dv">0</span>))<span class="op">;</span></span>
<span id="cb7-52"><a href="#cb7-52" tabindex="-1"></a></span>
<span id="cb7-53"><a href="#cb7-53" tabindex="-1"></a><span class="co">// Export the results as CSV</span></span>
<span id="cb7-54"><a href="#cb7-54" tabindex="-1"></a>Export<span class="op">.</span><span class="at">table</span><span class="op">.</span><span class="fu">toDrive</span>({</span>
<span id="cb7-55"><a href="#cb7-55" tabindex="-1"></a>  <span class="dt">collection</span><span class="op">:</span> timeSeriesFiltered<span class="op">,</span></span>
<span id="cb7-56"><a href="#cb7-56" tabindex="-1"></a>  <span class="dt">description</span><span class="op">:</span> <span class="st">&#39;Precipitation_Time_Series_Export&#39;</span><span class="op">,</span></span>
<span id="cb7-57"><a href="#cb7-57" tabindex="-1"></a>  <span class="dt">folder</span><span class="op">:</span> <span class="st">&#39;earthengine&#39;</span><span class="op">,</span></span>
<span id="cb7-58"><a href="#cb7-58" tabindex="-1"></a>  <span class="dt">fileNamePrefix</span><span class="op">:</span> <span class="st">&#39;precipitation_time_series&#39;</span><span class="op">,</span></span>
<span id="cb7-59"><a href="#cb7-59" tabindex="-1"></a>  <span class="dt">fileFormat</span><span class="op">:</span> <span class="st">&#39;CSV&#39;</span><span class="op">,</span></span>
<span id="cb7-60"><a href="#cb7-60" tabindex="-1"></a>  <span class="dt">selectors</span><span class="op">:</span> [<span class="st">&#39;latitude&#39;</span><span class="op">,</span> <span class="st">&#39;longitude&#39;</span><span class="op">,</span> <span class="st">&#39;date&#39;</span><span class="op">,</span> <span class="st">&#39;precipitation&#39;</span>]</span>
<span id="cb7-61"><a href="#cb7-61" tabindex="-1"></a>})<span class="op">;</span></span></code></pre></div>
</div>
<div id="gpm-precipitation-time-series" class="section level2">
<h2>GPM Precipitation Time Series</h2>
<p><a
href="https://code.earthengine.google.com/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3ASupplement%2FHydrology%2FGPM_Precipitation_Time_Series"
target="_blank">Open in Code Editor ↗</a></p>
<div class="sourceCode" id="cb8"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a><span class="co">/**** Start of imports. If edited, may not auto-convert in the playground. ****/</span></span>
<span id="cb8-2"><a href="#cb8-2" tabindex="-1"></a><span class="kw">var</span> gpm <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&quot;NASA/GPM_L3/IMERG_V06&quot;</span>)<span class="op">;</span></span>
<span id="cb8-3"><a href="#cb8-3" tabindex="-1"></a><span class="co">/***** End of imports. If edited, may not auto-convert in the playground. *****/</span></span>
<span id="cb8-4"><a href="#cb8-4" tabindex="-1"></a><span class="co">// Display GPM Precipitation Time Series</span></span>
<span id="cb8-5"><a href="#cb8-5" tabindex="-1"></a></span>
<span id="cb8-6"><a href="#cb8-6" tabindex="-1"></a><span class="kw">var</span> startDate <span class="op">=</span> ee<span class="op">.</span><span class="at">Date</span><span class="op">.</span><span class="fu">fromYMD</span>(<span class="dv">2021</span><span class="op">,</span> <span class="dv">9</span><span class="op">,</span> <span class="dv">4</span>)</span>
<span id="cb8-7"><a href="#cb8-7" tabindex="-1"></a><span class="kw">var</span> endDate <span class="op">=</span> startDate<span class="op">.</span><span class="fu">advance</span>(<span class="dv">1</span><span class="op">,</span> <span class="st">&#39;day&#39;</span>)</span>
<span id="cb8-8"><a href="#cb8-8" tabindex="-1"></a></span>
<span id="cb8-9"><a href="#cb8-9" tabindex="-1"></a><span class="co">// Select the Calibrated Precipitation Band</span></span>
<span id="cb8-10"><a href="#cb8-10" tabindex="-1"></a><span class="kw">var</span> collection <span class="op">=</span> gpm<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;precipitationCal&#39;</span>)<span class="op">;</span></span>
<span id="cb8-11"><a href="#cb8-11" tabindex="-1"></a></span>
<span id="cb8-12"><a href="#cb8-12" tabindex="-1"></a><span class="kw">var</span> filtered <span class="op">=</span> collection<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(startDate<span class="op">,</span> endDate))</span>
<span id="cb8-13"><a href="#cb8-13" tabindex="-1"></a><span class="fu">print</span>(filtered)</span>
<span id="cb8-14"><a href="#cb8-14" tabindex="-1"></a></span>
<span id="cb8-15"><a href="#cb8-15" tabindex="-1"></a><span class="co">// GPM units are mm/hour but image represents 30 mins</span></span>
<span id="cb8-16"><a href="#cb8-16" tabindex="-1"></a><span class="co">// Divide by 2 to get the total precipitation within 30 mins</span></span>
<span id="cb8-17"><a href="#cb8-17" tabindex="-1"></a><span class="kw">var</span> filtered <span class="op">=</span> filtered<span class="op">.</span><span class="fu">map</span>(<span class="kw">function</span>(image) {</span>
<span id="cb8-18"><a href="#cb8-18" tabindex="-1"></a>  <span class="kw">var</span> newImage <span class="op">=</span> image<span class="op">.</span><span class="fu">divide</span>(<span class="dv">2</span>)<span class="op">;</span></span>
<span id="cb8-19"><a href="#cb8-19" tabindex="-1"></a>  <span class="cf">return</span> newImage<span class="op">.</span><span class="fu">set</span>(<span class="st">&#39;system:time_start&#39;</span><span class="op">,</span> image<span class="op">.</span><span class="fu">date</span>())</span>
<span id="cb8-20"><a href="#cb8-20" tabindex="-1"></a>})</span>
<span id="cb8-21"><a href="#cb8-21" tabindex="-1"></a></span>
<span id="cb8-22"><a href="#cb8-22" tabindex="-1"></a><span class="kw">var</span> geometry <span class="op">=</span> ee<span class="op">.</span><span class="at">Geometry</span><span class="op">.</span><span class="fu">Point</span>([<span class="fl">77.60412933051538</span><span class="op">,</span> <span class="fl">12.952912912328241</span>])</span>
<span id="cb8-23"><a href="#cb8-23" tabindex="-1"></a></span>
<span id="cb8-24"><a href="#cb8-24" tabindex="-1"></a><span class="co">// Display a time-series chart</span></span>
<span id="cb8-25"><a href="#cb8-25" tabindex="-1"></a></span>
<span id="cb8-26"><a href="#cb8-26" tabindex="-1"></a><span class="co">// Note: Earth Engine converts chart timestamps</span></span>
<span id="cb8-27"><a href="#cb8-27" tabindex="-1"></a><span class="co">// to local timezone automatically</span></span>
<span id="cb8-28"><a href="#cb8-28" tabindex="-1"></a></span>
<span id="cb8-29"><a href="#cb8-29" tabindex="-1"></a><span class="kw">var</span> chart <span class="op">=</span> ui<span class="op">.</span><span class="at">Chart</span><span class="op">.</span><span class="at">image</span><span class="op">.</span><span class="fu">series</span>({</span>
<span id="cb8-30"><a href="#cb8-30" tabindex="-1"></a>  <span class="dt">imageCollection</span><span class="op">:</span> filtered<span class="op">,</span></span>
<span id="cb8-31"><a href="#cb8-31" tabindex="-1"></a>  <span class="dt">region</span><span class="op">:</span> geometry<span class="op">,</span></span>
<span id="cb8-32"><a href="#cb8-32" tabindex="-1"></a>  <span class="dt">reducer</span><span class="op">:</span> ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">mean</span>()<span class="op">,</span></span>
<span id="cb8-33"><a href="#cb8-33" tabindex="-1"></a>  <span class="dt">scale</span><span class="op">:</span> <span class="dv">11132</span></span>
<span id="cb8-34"><a href="#cb8-34" tabindex="-1"></a>})<span class="op">.</span><span class="fu">setOptions</span>({</span>
<span id="cb8-35"><a href="#cb8-35" tabindex="-1"></a>      <span class="dt">lineWidth</span><span class="op">:</span> <span class="dv">1</span><span class="op">,</span></span>
<span id="cb8-36"><a href="#cb8-36" tabindex="-1"></a>      <span class="dt">title</span><span class="op">:</span> <span class="st">&#39;Precipitation Time Series&#39;</span><span class="op">,</span></span>
<span id="cb8-37"><a href="#cb8-37" tabindex="-1"></a>      <span class="dt">interpolateNulls</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb8-38"><a href="#cb8-38" tabindex="-1"></a>      <span class="dt">vAxis</span><span class="op">:</span> {<span class="dt">title</span><span class="op">:</span> <span class="st">&#39;30-min Precipitation (mm)&#39;</span>}</span>
<span id="cb8-39"><a href="#cb8-39" tabindex="-1"></a>    })</span>
<span id="cb8-40"><a href="#cb8-40" tabindex="-1"></a><span class="fu">print</span>(chart)<span class="op">;</span></span>
<span id="cb8-41"><a href="#cb8-41" tabindex="-1"></a></span>
<span id="cb8-42"><a href="#cb8-42" tabindex="-1"></a><span class="co">// Export the time-series as a CSV</span></span>
<span id="cb8-43"><a href="#cb8-43" tabindex="-1"></a></span>
<span id="cb8-44"><a href="#cb8-44" tabindex="-1"></a><span class="kw">var</span> timeSeries <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(filtered<span class="op">.</span><span class="fu">map</span>(<span class="kw">function</span>(image) {</span>
<span id="cb8-45"><a href="#cb8-45" tabindex="-1"></a>  <span class="kw">var</span> stats <span class="op">=</span> image<span class="op">.</span><span class="fu">reduceRegion</span>({</span>
<span id="cb8-46"><a href="#cb8-46" tabindex="-1"></a>    <span class="dt">reducer</span><span class="op">:</span> ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">mean</span>()<span class="op">,</span></span>
<span id="cb8-47"><a href="#cb8-47" tabindex="-1"></a>    <span class="dt">geometry</span><span class="op">:</span> geometry<span class="op">,</span></span>
<span id="cb8-48"><a href="#cb8-48" tabindex="-1"></a>    <span class="dt">scale</span><span class="op">:</span> <span class="dv">11132</span><span class="op">,</span></span>
<span id="cb8-49"><a href="#cb8-49" tabindex="-1"></a>    <span class="dt">maxPixels</span><span class="op">:</span> <span class="fl">1e10</span></span>
<span id="cb8-50"><a href="#cb8-50" tabindex="-1"></a>  })</span>
<span id="cb8-51"><a href="#cb8-51" tabindex="-1"></a>  <span class="co">// reduceRegion doesn&#39;t return any output if the image doesn&#39;t intersect</span></span>
<span id="cb8-52"><a href="#cb8-52" tabindex="-1"></a>  <span class="co">// with the point or if the image is masked out due to cloud</span></span>
<span id="cb8-53"><a href="#cb8-53" tabindex="-1"></a>  <span class="co">// If there was no value found, we set the ndvi to a NoData value -9999</span></span>
<span id="cb8-54"><a href="#cb8-54" tabindex="-1"></a>  <span class="kw">var</span> value <span class="op">=</span> ee<span class="op">.</span><span class="fu">List</span>([stats<span class="op">.</span><span class="fu">get</span>(<span class="st">&#39;precipitationCal&#39;</span>)<span class="op">,</span> <span class="op">-</span><span class="dv">9999</span>])</span>
<span id="cb8-55"><a href="#cb8-55" tabindex="-1"></a>    <span class="op">.</span><span class="fu">reduce</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">firstNonNull</span>())</span>
<span id="cb8-56"><a href="#cb8-56" tabindex="-1"></a> </span>
<span id="cb8-57"><a href="#cb8-57" tabindex="-1"></a>  <span class="co">// Remember timestamps are in UTC</span></span>
<span id="cb8-58"><a href="#cb8-58" tabindex="-1"></a>  <span class="co">// Convert to the preferred timezone</span></span>
<span id="cb8-59"><a href="#cb8-59" tabindex="-1"></a>  <span class="co">// You can specify your local timezone as IANA zone id</span></span>
<span id="cb8-60"><a href="#cb8-60" tabindex="-1"></a>  <span class="co">// https://en.wikipedia.org/wiki/List_of_tz_database_time_zones</span></span>
<span id="cb8-61"><a href="#cb8-61" tabindex="-1"></a></span>
<span id="cb8-62"><a href="#cb8-62" tabindex="-1"></a>  <span class="co">// Here we specify the dates in timezone for India</span></span>
<span id="cb8-63"><a href="#cb8-63" tabindex="-1"></a>  <span class="kw">var</span> tz <span class="op">=</span> <span class="st">&#39;Asia/Kolkata&#39;</span><span class="op">;</span></span>
<span id="cb8-64"><a href="#cb8-64" tabindex="-1"></a>  <span class="kw">var</span> date <span class="op">=</span> ee<span class="op">.</span><span class="fu">Date</span>(image<span class="op">.</span><span class="fu">get</span>(<span class="st">&#39;system:time_start&#39;</span>))<span class="op">;</span></span>
<span id="cb8-65"><a href="#cb8-65" tabindex="-1"></a>  <span class="co">// Create a feature with null geometry and NDVI value and date as properties</span></span>
<span id="cb8-66"><a href="#cb8-66" tabindex="-1"></a>  <span class="kw">var</span> f <span class="op">=</span> ee<span class="op">.</span><span class="fu">Feature</span>(<span class="kw">null</span><span class="op">,</span> {<span class="st">&#39;precipitation&#39;</span><span class="op">:</span> value<span class="op">,</span></span>
<span id="cb8-67"><a href="#cb8-67" tabindex="-1"></a>    <span class="st">&#39;time&#39;</span><span class="op">:</span> date<span class="op">.</span><span class="fu">format</span>(<span class="st">&#39;YYYY-MM-dd HH:mm:ss&#39;</span><span class="op">,</span> tz)</span>
<span id="cb8-68"><a href="#cb8-68" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb8-69"><a href="#cb8-69" tabindex="-1"></a>  <span class="cf">return</span> f</span>
<span id="cb8-70"><a href="#cb8-70" tabindex="-1"></a>}))</span>
<span id="cb8-71"><a href="#cb8-71" tabindex="-1"></a> </span>
<span id="cb8-72"><a href="#cb8-72" tabindex="-1"></a><span class="co">// Check the results</span></span>
<span id="cb8-73"><a href="#cb8-73" tabindex="-1"></a><span class="fu">print</span>(timeSeries<span class="op">.</span><span class="fu">first</span>())</span>
<span id="cb8-74"><a href="#cb8-74" tabindex="-1"></a> </span>
<span id="cb8-75"><a href="#cb8-75" tabindex="-1"></a><span class="co">// Export to CSV</span></span>
<span id="cb8-76"><a href="#cb8-76" tabindex="-1"></a>Export<span class="op">.</span><span class="at">table</span><span class="op">.</span><span class="fu">toDrive</span>({</span>
<span id="cb8-77"><a href="#cb8-77" tabindex="-1"></a>    <span class="dt">collection</span><span class="op">:</span> timeSeries<span class="op">,</span></span>
<span id="cb8-78"><a href="#cb8-78" tabindex="-1"></a>    <span class="dt">description</span><span class="op">:</span> <span class="st">&#39;GPM_Time_Series_Export&#39;</span><span class="op">,</span></span>
<span id="cb8-79"><a href="#cb8-79" tabindex="-1"></a>    <span class="dt">folder</span><span class="op">:</span> <span class="st">&#39;earthengine&#39;</span><span class="op">,</span></span>
<span id="cb8-80"><a href="#cb8-80" tabindex="-1"></a>    <span class="dt">fileNamePrefix</span><span class="op">:</span> <span class="st">&#39;gpm_time_series&#39;</span><span class="op">,</span></span>
<span id="cb8-81"><a href="#cb8-81" tabindex="-1"></a>    <span class="dt">fileFormat</span><span class="op">:</span> <span class="st">&#39;CSV&#39;</span></span>
<span id="cb8-82"><a href="#cb8-82" tabindex="-1"></a>})</span></code></pre></div>
</div>
<div id="imd-number-of-rainy-days" class="section level2">
<h2>IMD Number of Rainy Days</h2>
<p><a
href="https://code.earthengine.google.com/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3ASupplement%2FHydrology%2FIMD_Number_of_Rainy_Days"
target="_blank">Open in Code Editor ↗</a></p>
<div class="sourceCode" id="cb9"><pre class="sourceCode js"><code class="sourceCode javascript"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a><span class="co">// Calculate Total Number of Rainy Days in a Year per Pixel</span></span>
<span id="cb9-2"><a href="#cb9-2" tabindex="-1"></a></span>
<span id="cb9-3"><a href="#cb9-3" tabindex="-1"></a><span class="co">// IMD Collection is a processed version of raw IMD Rainfall Images</span></span>
<span id="cb9-4"><a href="#cb9-4" tabindex="-1"></a><span class="co">// See https://github.com/spatialthoughts/projects/tree/master/imd</span></span>
<span id="cb9-5"><a href="#cb9-5" tabindex="-1"></a><span class="co">// It has 1 image per day with a &#39;rainfall&#39; band with precipitation values in mm</span></span>
<span id="cb9-6"><a href="#cb9-6" tabindex="-1"></a><span class="kw">var</span> imdCol <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&quot;users/ujavalgandhi/imd/rainfall&quot;</span>)<span class="op">;</span></span>
<span id="cb9-7"><a href="#cb9-7" tabindex="-1"></a><span class="kw">var</span> india <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">&quot;users/ujavalgandhi/public/soi_india_boundary&quot;</span>)<span class="op">;</span></span>
<span id="cb9-8"><a href="#cb9-8" tabindex="-1"></a></span>
<span id="cb9-9"><a href="#cb9-9" tabindex="-1"></a><span class="kw">var</span> filtered <span class="op">=</span> imdCol</span>
<span id="cb9-10"><a href="#cb9-10" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(<span class="st">&#39;2017-01-01&#39;</span><span class="op">,</span> <span class="st">&#39;2018-01-01&#39;</span>))</span>
<span id="cb9-11"><a href="#cb9-11" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">bounds</span>(india))</span>
<span id="cb9-12"><a href="#cb9-12" tabindex="-1"></a></span>
<span id="cb9-13"><a href="#cb9-13" tabindex="-1"></a><span class="co">// Rainy day is when the total daily rainfall is &gt; 2.5mm</span></span>
<span id="cb9-14"><a href="#cb9-14" tabindex="-1"></a><span class="co">// Let&#39;s process the collection to find all pixels which are &#39;rainy&#39;</span></span>
<span id="cb9-15"><a href="#cb9-15" tabindex="-1"></a><span class="kw">var</span> rainyCol <span class="op">=</span> filtered<span class="op">.</span><span class="fu">map</span>(<span class="kw">function</span>(dayImage){</span>
<span id="cb9-16"><a href="#cb9-16" tabindex="-1"></a>  <span class="co">// selfMask() is important as it will mask all 0 values</span></span>
<span id="cb9-17"><a href="#cb9-17" tabindex="-1"></a>  <span class="co">// Otherwise it will still count as a valid pixel</span></span>
<span id="cb9-18"><a href="#cb9-18" tabindex="-1"></a>  <span class="cf">return</span> dayImage<span class="op">.</span><span class="fu">gt</span>(<span class="fl">2.5</span>)<span class="op">.</span><span class="fu">selfMask</span>()</span>
<span id="cb9-19"><a href="#cb9-19" tabindex="-1"></a>})</span>
<span id="cb9-20"><a href="#cb9-20" tabindex="-1"></a></span>
<span id="cb9-21"><a href="#cb9-21" tabindex="-1"></a><span class="co">// We can now apply a reducer to count all valid pixels from the stack of images</span></span>
<span id="cb9-22"><a href="#cb9-22" tabindex="-1"></a><span class="co">// Alternatively, we can use the ee.Reducer.sum()</span></span>
<span id="cb9-23"><a href="#cb9-23" tabindex="-1"></a><span class="kw">var</span> raindayCount <span class="op">=</span> rainyCol<span class="op">.</span><span class="fu">reduce</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">count</span>())</span>
<span id="cb9-24"><a href="#cb9-24" tabindex="-1"></a></span>
<span id="cb9-25"><a href="#cb9-25" tabindex="-1"></a><span class="kw">var</span> visParams <span class="op">=</span> {</span>
<span id="cb9-26"><a href="#cb9-26" tabindex="-1"></a>  <span class="dt">min</span><span class="op">:</span> <span class="dv">30</span><span class="op">,</span></span>
<span id="cb9-27"><a href="#cb9-27" tabindex="-1"></a>  <span class="dt">max</span><span class="op">:</span> <span class="dv">120</span><span class="op">,</span></span>
<span id="cb9-28"><a href="#cb9-28" tabindex="-1"></a>  <span class="dt">palette</span><span class="op">:</span> [<span class="st">&#39;#feebe2&#39;</span><span class="op">,</span><span class="st">&#39;#fbb4b9&#39;</span><span class="op">,</span><span class="st">&#39;#f768a1&#39;</span><span class="op">,</span><span class="st">&#39;#c51b8a&#39;</span><span class="op">,</span><span class="st">&#39;#7a0177&#39;</span>]</span>
<span id="cb9-29"><a href="#cb9-29" tabindex="-1"></a>}</span>
<span id="cb9-30"><a href="#cb9-30" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(raindayCount<span class="op">,</span> visParams<span class="op">,</span> <span class="st">&#39;Number of Rainy Days&#39;</span>)</span></code></pre></div>
</div>
</div>
<div id="surface-water" class="section level1">
<h1>Surface Water</h1>
<div id="animating-surface-water-changes" class="section level2">
<h2>Animating Surface Water Changes</h2>
<p>To visualize changes in surface water over time, we can create an
ImageCollection of visualized images and use
<code>Export.video.toDrive()</code> function to exported a video
animation. We use Gennadii Donchyts’s excellent <a
href="https://github.com/gee-community/ee-packages-js"><code>text</code>
package</a> for adding text overlay on the images. The exported video
can be converted to an animated GIF using <a href="https://ezgif.com/"
class="uri">https://ezgif.com/</a>.</p>
<div class="figure" style="text-align: center">
<img src="images/gee_water_resources_management/surface_water_animation.gif" alt="Video Animation" width="80%" />
<p class="caption">
Video Animation
</p>
</div>
<p><a
href="https://code.earthengine.google.co.in/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3ASupplement%2FSurface_Water%2FSurface_Water_Animation"
target="_blank">Open in Code Editor ↗</a></p>
<div class="sourceCode" id="cb10"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb10-1"><a href="#cb10-1" tabindex="-1"></a><span class="co">// Example script showing how to create and export</span></span>
<span id="cb10-2"><a href="#cb10-2" tabindex="-1"></a><span class="co">// an animation of surface water change</span></span>
<span id="cb10-3"><a href="#cb10-3" tabindex="-1"></a></span>
<span id="cb10-4"><a href="#cb10-4" tabindex="-1"></a><span class="co">// Delete the &#39;geometry&#39; and draw a polygon at </span></span>
<span id="cb10-5"><a href="#cb10-5" tabindex="-1"></a><span class="co">// your region of interest</span></span>
<span id="cb10-6"><a href="#cb10-6" tabindex="-1"></a><span class="kw">var</span> geometry <span class="op">=</span> ee<span class="op">.</span><span class="at">Geometry</span><span class="op">.</span><span class="fu">Polygon</span>([[</span>
<span id="cb10-7"><a href="#cb10-7" tabindex="-1"></a>  [<span class="fl">76.3733</span><span class="op">,</span> <span class="fl">12.5680</span>]<span class="op">,</span></span>
<span id="cb10-8"><a href="#cb10-8" tabindex="-1"></a>  [<span class="fl">76.3733</span><span class="op">,</span> <span class="fl">12.3736</span>]<span class="op">,</span></span>
<span id="cb10-9"><a href="#cb10-9" tabindex="-1"></a>  [<span class="fl">76.6329</span><span class="op">,</span> <span class="fl">12.3736</span>]<span class="op">,</span></span>
<span id="cb10-10"><a href="#cb10-10" tabindex="-1"></a>  [<span class="fl">76.6329</span><span class="op">,</span> <span class="fl">12.5680</span>]</span>
<span id="cb10-11"><a href="#cb10-11" tabindex="-1"></a>]])<span class="op">;</span></span>
<span id="cb10-12"><a href="#cb10-12" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">centerObject</span>(geometry<span class="op">,</span> <span class="dv">10</span>)<span class="op">;</span></span>
<span id="cb10-13"><a href="#cb10-13" tabindex="-1"></a></span>
<span id="cb10-14"><a href="#cb10-14" tabindex="-1"></a><span class="kw">var</span> gswYearly <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&quot;JRC/GSW1_4/YearlyHistory&quot;</span>)<span class="op">;</span></span>
<span id="cb10-15"><a href="#cb10-15" tabindex="-1"></a></span>
<span id="cb10-16"><a href="#cb10-16" tabindex="-1"></a><span class="kw">var</span> years <span class="op">=</span> ee<span class="op">.</span><span class="at">List</span><span class="op">.</span><span class="fu">sequence</span>(<span class="dv">1990</span><span class="op">,</span> <span class="dv">2020</span>)<span class="op">;</span></span>
<span id="cb10-17"><a href="#cb10-17" tabindex="-1"></a></span>
<span id="cb10-18"><a href="#cb10-18" tabindex="-1"></a><span class="kw">var</span> yearlyWater <span class="op">=</span> years<span class="op">.</span><span class="fu">map</span>(<span class="kw">function</span>(year) {</span>
<span id="cb10-19"><a href="#cb10-19" tabindex="-1"></a>  <span class="kw">var</span> filtered <span class="op">=</span> gswYearly<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;year&#39;</span><span class="op">,</span> year))<span class="op">;</span></span>
<span id="cb10-20"><a href="#cb10-20" tabindex="-1"></a>  <span class="kw">var</span> yearImage <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(filtered<span class="op">.</span><span class="fu">first</span>())<span class="op">;</span></span>
<span id="cb10-21"><a href="#cb10-21" tabindex="-1"></a>  </span>
<span id="cb10-22"><a href="#cb10-22" tabindex="-1"></a>  <span class="co">// Select permanent or seasonal water</span></span>
<span id="cb10-23"><a href="#cb10-23" tabindex="-1"></a>  <span class="kw">var</span> water <span class="op">=</span> yearImage<span class="op">.</span><span class="fu">eq</span>(<span class="dv">2</span>)<span class="op">.</span><span class="fu">or</span>(yearImage<span class="op">.</span><span class="fu">eq</span>(<span class="dv">3</span>))<span class="op">;</span></span>
<span id="cb10-24"><a href="#cb10-24" tabindex="-1"></a>  </span>
<span id="cb10-25"><a href="#cb10-25" tabindex="-1"></a>  <span class="co">// Mask &#39;0&#39; value pixels</span></span>
<span id="cb10-26"><a href="#cb10-26" tabindex="-1"></a>  <span class="cf">return</span> water<span class="op">.</span><span class="fu">selfMask</span>()<span class="op">.</span><span class="fu">set</span>(<span class="st">&#39;year&#39;</span><span class="op">,</span> year)<span class="op">;</span></span>
<span id="cb10-27"><a href="#cb10-27" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb10-28"><a href="#cb10-28" tabindex="-1"></a></span>
<span id="cb10-29"><a href="#cb10-29" tabindex="-1"></a></span>
<span id="cb10-30"><a href="#cb10-30" tabindex="-1"></a><span class="co">// Visualize the image</span></span>
<span id="cb10-31"><a href="#cb10-31" tabindex="-1"></a><span class="kw">var</span> visParams <span class="op">=</span> {</span>
<span id="cb10-32"><a href="#cb10-32" tabindex="-1"></a>  <span class="dt">min</span><span class="op">:</span><span class="dv">0</span><span class="op">,</span></span>
<span id="cb10-33"><a href="#cb10-33" tabindex="-1"></a>  <span class="dt">max</span><span class="op">:</span><span class="dv">1</span><span class="op">,</span></span>
<span id="cb10-34"><a href="#cb10-34" tabindex="-1"></a>  <span class="dt">palette</span><span class="op">:</span> [<span class="st">&#39;white&#39;</span><span class="op">,</span><span class="st">&#39;blue&#39;</span>]</span>
<span id="cb10-35"><a href="#cb10-35" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb10-36"><a href="#cb10-36" tabindex="-1"></a></span>
<span id="cb10-37"><a href="#cb10-37" tabindex="-1"></a><span class="kw">var</span> yearlyWaterVisualized <span class="op">=</span> yearlyWater<span class="op">.</span><span class="fu">map</span>(<span class="kw">function</span>(image) {</span>
<span id="cb10-38"><a href="#cb10-38" tabindex="-1"></a>  <span class="cf">return</span> ee<span class="op">.</span><span class="fu">Image</span>(image)</span>
<span id="cb10-39"><a href="#cb10-39" tabindex="-1"></a>    <span class="op">.</span><span class="fu">unmask</span>(<span class="dv">0</span>)</span>
<span id="cb10-40"><a href="#cb10-40" tabindex="-1"></a>    <span class="op">.</span><span class="fu">visualize</span>(visParams)</span>
<span id="cb10-41"><a href="#cb10-41" tabindex="-1"></a>    <span class="op">.</span><span class="fu">clip</span>(geometry)</span>
<span id="cb10-42"><a href="#cb10-42" tabindex="-1"></a>    <span class="op">.</span><span class="fu">set</span>(<span class="st">&#39;label&#39;</span><span class="op">,</span> ee<span class="op">.</span><span class="fu">Image</span>(image)<span class="op">.</span><span class="fu">getNumber</span>(<span class="st">&#39;year&#39;</span>)<span class="op">.</span><span class="fu">format</span>(<span class="st">&#39;%04d&#39;</span>))<span class="op">;</span></span>
<span id="cb10-43"><a href="#cb10-43" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb10-44"><a href="#cb10-44" tabindex="-1"></a></span>
<span id="cb10-45"><a href="#cb10-45" tabindex="-1"></a><span class="kw">var</span> yearlyWaterCol <span class="op">=</span> ee<span class="op">.</span><span class="at">ImageCollection</span><span class="op">.</span><span class="fu">fromImages</span>(yearlyWaterVisualized)<span class="op">;</span></span>
<span id="cb10-46"><a href="#cb10-46" tabindex="-1"></a><span class="fu">print</span>(yearlyWaterCol)<span class="op">;</span></span>
<span id="cb10-47"><a href="#cb10-47" tabindex="-1"></a></span>
<span id="cb10-48"><a href="#cb10-48" tabindex="-1"></a><span class="co">// Earth Engine doesn&#39;t have a way to add text labels</span></span>
<span id="cb10-49"><a href="#cb10-49" tabindex="-1"></a><span class="co">// Use the 3rd-party text package to add annotations</span></span>
<span id="cb10-50"><a href="#cb10-50" tabindex="-1"></a><span class="kw">var</span> text <span class="op">=</span> <span class="pp">require</span>(<span class="st">&#39;users/gena/packages:text&#39;</span>)<span class="op">;</span></span>
<span id="cb10-51"><a href="#cb10-51" tabindex="-1"></a><span class="kw">var</span> scale <span class="op">=</span> <span class="bu">Map</span><span class="op">.</span><span class="fu">getScale</span>()<span class="op">;</span></span>
<span id="cb10-52"><a href="#cb10-52" tabindex="-1"></a><span class="kw">var</span> fontSize <span class="op">=</span> <span class="dv">18</span><span class="op">;</span></span>
<span id="cb10-53"><a href="#cb10-53" tabindex="-1"></a><span class="kw">var</span> bounds <span class="op">=</span> geometry<span class="op">.</span><span class="fu">bounds</span>()<span class="op">;</span></span>
<span id="cb10-54"><a href="#cb10-54" tabindex="-1"></a><span class="kw">var</span> image <span class="op">=</span> yearlyWaterCol<span class="op">.</span><span class="fu">first</span>()<span class="op">;</span></span>
<span id="cb10-55"><a href="#cb10-55" tabindex="-1"></a>  </span>
<span id="cb10-56"><a href="#cb10-56" tabindex="-1"></a><span class="kw">var</span> annotations <span class="op">=</span> [</span>
<span id="cb10-57"><a href="#cb10-57" tabindex="-1"></a>  {</span>
<span id="cb10-58"><a href="#cb10-58" tabindex="-1"></a>    <span class="co">// Use &#39;margin&#39; for x-position and &#39;offset&#39; for y-position</span></span>
<span id="cb10-59"><a href="#cb10-59" tabindex="-1"></a>    <span class="dt">position</span><span class="op">:</span> <span class="st">&#39;right&#39;</span><span class="op">,</span> <span class="dt">offset</span><span class="op">:</span> <span class="st">&#39;5%&#39;</span><span class="op">,</span> <span class="dt">margin</span><span class="op">:</span> <span class="st">&#39;20%&#39;</span><span class="op">,</span></span>
<span id="cb10-60"><a href="#cb10-60" tabindex="-1"></a>    <span class="dt">property</span><span class="op">:</span> <span class="st">&#39;label&#39;</span><span class="op">,</span></span>
<span id="cb10-61"><a href="#cb10-61" tabindex="-1"></a>    <span class="dt">scale</span><span class="op">:</span> scale<span class="op">,</span></span>
<span id="cb10-62"><a href="#cb10-62" tabindex="-1"></a>    <span class="dt">fontType</span><span class="op">:</span> <span class="st">&#39;Consolas&#39;</span><span class="op">,</span> <span class="dt">fontSize</span><span class="op">:</span> <span class="dv">18</span></span>
<span id="cb10-63"><a href="#cb10-63" tabindex="-1"></a>  }</span>
<span id="cb10-64"><a href="#cb10-64" tabindex="-1"></a>]<span class="op">;</span></span>
<span id="cb10-65"><a href="#cb10-65" tabindex="-1"></a>  </span>
<span id="cb10-66"><a href="#cb10-66" tabindex="-1"></a><span class="kw">var</span> vis <span class="op">=</span> {<span class="dt">forceRgbOutput</span><span class="op">:</span> <span class="kw">true</span>}<span class="op">;</span></span>
<span id="cb10-67"><a href="#cb10-67" tabindex="-1"></a></span>
<span id="cb10-68"><a href="#cb10-68" tabindex="-1"></a><span class="co">// Test the parameters</span></span>
<span id="cb10-69"><a href="#cb10-69" tabindex="-1"></a><span class="kw">var</span> results <span class="op">=</span> text<span class="op">.</span><span class="fu">annotateImage</span>(image<span class="op">,</span> vis<span class="op">,</span> bounds<span class="op">,</span> annotations)<span class="op">;</span></span>
<span id="cb10-70"><a href="#cb10-70" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(results<span class="op">,</span> {}<span class="op">,</span> <span class="st">&#39;Test Image with Annotation&#39;</span>)<span class="op">;</span></span>
<span id="cb10-71"><a href="#cb10-71" tabindex="-1"></a></span>
<span id="cb10-72"><a href="#cb10-72" tabindex="-1"></a><span class="co">// Apple labeling on all images</span></span>
<span id="cb10-73"><a href="#cb10-73" tabindex="-1"></a><span class="kw">var</span> labeledImages <span class="op">=</span> yearlyWaterCol<span class="op">.</span><span class="fu">map</span>(<span class="kw">function</span>(image) {</span>
<span id="cb10-74"><a href="#cb10-74" tabindex="-1"></a>  <span class="cf">return</span> text<span class="op">.</span><span class="fu">annotateImage</span>(image<span class="op">,</span> vis<span class="op">,</span> bounds<span class="op">,</span> annotations)<span class="op">;</span></span>
<span id="cb10-75"><a href="#cb10-75" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb10-76"><a href="#cb10-76" tabindex="-1"></a></span>
<span id="cb10-77"><a href="#cb10-77" tabindex="-1"></a><span class="co">// Export the collection as video</span></span>
<span id="cb10-78"><a href="#cb10-78" tabindex="-1"></a></span>
<span id="cb10-79"><a href="#cb10-79" tabindex="-1"></a>Export<span class="op">.</span><span class="at">video</span><span class="op">.</span><span class="fu">toDrive</span>({</span>
<span id="cb10-80"><a href="#cb10-80" tabindex="-1"></a>  <span class="dt">collection</span><span class="op">:</span> labeledImages<span class="op">,</span></span>
<span id="cb10-81"><a href="#cb10-81" tabindex="-1"></a>  <span class="dt">description</span><span class="op">:</span> <span class="st">&#39;Animation_with_Label&#39;</span><span class="op">,</span></span>
<span id="cb10-82"><a href="#cb10-82" tabindex="-1"></a>  <span class="dt">folder</span><span class="op">:</span> <span class="st">&#39;earthengine&#39;</span><span class="op">,</span></span>
<span id="cb10-83"><a href="#cb10-83" tabindex="-1"></a>  <span class="dt">fileNamePrefix</span><span class="op">:</span> <span class="st">&#39;animation&#39;</span><span class="op">,</span></span>
<span id="cb10-84"><a href="#cb10-84" tabindex="-1"></a>  <span class="dt">framesPerSecond</span><span class="op">:</span> <span class="dv">1</span><span class="op">,</span></span>
<span id="cb10-85"><a href="#cb10-85" tabindex="-1"></a>  <span class="dt">dimensions</span><span class="op">:</span> <span class="dv">800</span><span class="op">,</span></span>
<span id="cb10-86"><a href="#cb10-86" tabindex="-1"></a>  <span class="dt">region</span><span class="op">:</span> geometry<span class="op">,</span></span>
<span id="cb10-87"><a href="#cb10-87" tabindex="-1"></a>})<span class="op">;</span></span></code></pre></div>
</div>
<div id="detecting-algal-blooms" class="section level2">
<h2>Detecting Algal Blooms</h2>
<p><a
href="https://code.earthengine.google.co.in/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3ASupplement%2FSurface_Water%2FDetecting_Algae_Blooms"
target="_blank">Open in Code Editor ↗</a></p>
<div class="sourceCode" id="cb11"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb11-1"><a href="#cb11-1" tabindex="-1"></a><span class="co">// Example script showing how to compute</span></span>
<span id="cb11-2"><a href="#cb11-2" tabindex="-1"></a><span class="co">// Normalized Difference Chlorophyll Index (NDCI) to detect</span></span>
<span id="cb11-3"><a href="#cb11-3" tabindex="-1"></a><span class="co">// Algal Blooms in inland waters</span></span>
<span id="cb11-4"><a href="#cb11-4" tabindex="-1"></a></span>
<span id="cb11-5"><a href="#cb11-5" tabindex="-1"></a><span class="co">// This example shows the algal bloom in the</span></span>
<span id="cb11-6"><a href="#cb11-6" tabindex="-1"></a><span class="co">// Ukai Dam Reservoir, Gujarat, India</span></span>
<span id="cb11-7"><a href="#cb11-7" tabindex="-1"></a><span class="co">// during February, 2022</span></span>
<span id="cb11-8"><a href="#cb11-8" tabindex="-1"></a><span class="co">// More info at https://x.com/rajbhagatt/status/1497212432195809280</span></span>
<span id="cb11-9"><a href="#cb11-9" tabindex="-1"></a></span>
<span id="cb11-10"><a href="#cb11-10" tabindex="-1"></a><span class="kw">var</span> geometry <span class="op">=</span> ee<span class="op">.</span><span class="at">Geometry</span><span class="op">.</span><span class="fu">Polygon</span>([[</span>
<span id="cb11-11"><a href="#cb11-11" tabindex="-1"></a>  [<span class="fl">73.5583</span><span class="op">,</span> <span class="fl">21.3022</span>]<span class="op">,</span></span>
<span id="cb11-12"><a href="#cb11-12" tabindex="-1"></a>  [<span class="fl">73.5583</span><span class="op">,</span> <span class="fl">21.1626</span>]<span class="op">,</span></span>
<span id="cb11-13"><a href="#cb11-13" tabindex="-1"></a>  [<span class="fl">73.8027</span><span class="op">,</span> <span class="fl">21.1626</span>]<span class="op">,</span></span>
<span id="cb11-14"><a href="#cb11-14" tabindex="-1"></a>  [<span class="fl">73.8027</span><span class="op">,</span> <span class="fl">21.3022</span>]</span>
<span id="cb11-15"><a href="#cb11-15" tabindex="-1"></a>]])<span class="op">;</span></span>
<span id="cb11-16"><a href="#cb11-16" tabindex="-1"></a>          </span>
<span id="cb11-17"><a href="#cb11-17" tabindex="-1"></a><span class="kw">var</span> s2 <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&#39;COPERNICUS/S2_SR_HARMONIZED&#39;</span>)<span class="op">;</span></span>
<span id="cb11-18"><a href="#cb11-18" tabindex="-1"></a></span>
<span id="cb11-19"><a href="#cb11-19" tabindex="-1"></a><span class="kw">var</span> startDate <span class="op">=</span> ee<span class="op">.</span><span class="at">Date</span><span class="op">.</span><span class="fu">fromYMD</span>(<span class="dv">2022</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">15</span>)<span class="op">;</span></span>
<span id="cb11-20"><a href="#cb11-20" tabindex="-1"></a><span class="kw">var</span> endDate <span class="op">=</span> startDate<span class="op">.</span><span class="fu">advance</span>(<span class="dv">10</span><span class="op">,</span> <span class="st">&#39;day&#39;</span>)<span class="op">;</span></span>
<span id="cb11-21"><a href="#cb11-21" tabindex="-1"></a></span>
<span id="cb11-22"><a href="#cb11-22" tabindex="-1"></a><span class="kw">var</span> filtered <span class="op">=</span> s2</span>
<span id="cb11-23"><a href="#cb11-23" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(startDate<span class="op">,</span> endDate))</span>
<span id="cb11-24"><a href="#cb11-24" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">bounds</span>(geometry))</span>
<span id="cb11-25"><a href="#cb11-25" tabindex="-1"></a></span>
<span id="cb11-26"><a href="#cb11-26" tabindex="-1"></a><span class="kw">var</span> image <span class="op">=</span> filtered<span class="op">.</span><span class="fu">first</span>()<span class="op">;</span> </span>
<span id="cb11-27"><a href="#cb11-27" tabindex="-1"></a></span>
<span id="cb11-28"><a href="#cb11-28" tabindex="-1"></a></span>
<span id="cb11-29"><a href="#cb11-29" tabindex="-1"></a><span class="co">// Calculate Normalized Difference Chlorophyll Index (NDCI)</span></span>
<span id="cb11-30"><a href="#cb11-30" tabindex="-1"></a><span class="co">// NDCI is an index that aims to predict the chlorophyll content</span></span>
<span id="cb11-31"><a href="#cb11-31" tabindex="-1"></a><span class="co">// in turbid productive waters.</span></span>
<span id="cb11-32"><a href="#cb11-32" tabindex="-1"></a><span class="co">// &#39;RED EDGE&#39; (B5) and &#39;RED&#39; (B4)</span></span>
<span id="cb11-33"><a href="#cb11-33" tabindex="-1"></a><span class="kw">var</span> ndci <span class="op">=</span> image<span class="op">.</span><span class="fu">normalizedDifference</span>([<span class="st">&#39;B5&#39;</span><span class="op">,</span> <span class="st">&#39;B4&#39;</span>])<span class="op">.</span><span class="fu">rename</span>([<span class="st">&#39;ndci&#39;</span>])<span class="op">;</span></span>
<span id="cb11-34"><a href="#cb11-34" tabindex="-1"></a></span>
<span id="cb11-35"><a href="#cb11-35" tabindex="-1"></a><span class="co">// Calculate Modified Normalized Difference Water Index (MNDWI)</span></span>
<span id="cb11-36"><a href="#cb11-36" tabindex="-1"></a><span class="co">// &#39;GREEN&#39; (B3) and &#39;SWIR1&#39; (B11)</span></span>
<span id="cb11-37"><a href="#cb11-37" tabindex="-1"></a><span class="kw">var</span> mndwi <span class="op">=</span> image<span class="op">.</span><span class="fu">normalizedDifference</span>([<span class="st">&#39;B3&#39;</span><span class="op">,</span> <span class="st">&#39;B11&#39;</span>])<span class="op">.</span><span class="fu">rename</span>([<span class="st">&#39;mndwi&#39;</span>])<span class="op">;</span> </span>
<span id="cb11-38"><a href="#cb11-38" tabindex="-1"></a></span>
<span id="cb11-39"><a href="#cb11-39" tabindex="-1"></a><span class="co">// Select all pixels with high NDCI and high MNDWI</span></span>
<span id="cb11-40"><a href="#cb11-40" tabindex="-1"></a><span class="co">// you may have to adjust the thresholds for your region</span></span>
<span id="cb11-41"><a href="#cb11-41" tabindex="-1"></a><span class="kw">var</span> algae <span class="op">=</span> ndci<span class="op">.</span><span class="fu">gt</span>(<span class="fl">0.1</span>)<span class="op">.</span><span class="fu">and</span>(mndwi<span class="op">.</span><span class="fu">gt</span>(<span class="fl">0.5</span>))<span class="op">;</span></span>
<span id="cb11-42"><a href="#cb11-42" tabindex="-1"></a></span>
<span id="cb11-43"><a href="#cb11-43" tabindex="-1"></a><span class="kw">var</span> rgbVis <span class="op">=</span> {<span class="dt">min</span><span class="op">:</span> <span class="dv">500</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span> <span class="dv">2500</span><span class="op">,</span> <span class="dt">bands</span><span class="op">:</span> [<span class="st">&#39;B4&#39;</span><span class="op">,</span> <span class="st">&#39;B3&#39;</span><span class="op">,</span> <span class="st">&#39;B2&#39;</span>]}<span class="op">;</span></span>
<span id="cb11-44"><a href="#cb11-44" tabindex="-1"></a><span class="kw">var</span> ndwiVis <span class="op">=</span> {<span class="dt">min</span><span class="op">:</span><span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span><span class="fl">0.5</span><span class="op">,</span> <span class="dt">palette</span><span class="op">:</span> [<span class="st">&#39;white&#39;</span><span class="op">,</span> <span class="st">&#39;blue&#39;</span>]}<span class="op">;</span></span>
<span id="cb11-45"><a href="#cb11-45" tabindex="-1"></a><span class="kw">var</span> ndciVis <span class="op">=</span> {<span class="dt">min</span><span class="op">:</span><span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span><span class="fl">0.5</span><span class="op">,</span> <span class="dt">palette</span><span class="op">:</span> [<span class="st">&#39;white&#39;</span><span class="op">,</span> <span class="st">&#39;red&#39;</span>]}<span class="op">;</span></span>
<span id="cb11-46"><a href="#cb11-46" tabindex="-1"></a><span class="kw">var</span> algaeVis <span class="op">=</span> {<span class="dt">min</span><span class="op">:</span><span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span><span class="dv">1</span><span class="op">,</span> <span class="dt">palette</span><span class="op">:</span> [<span class="st">&#39;white&#39;</span><span class="op">,</span> <span class="st">&#39;#31a354&#39;</span>]}<span class="op">;</span></span>
<span id="cb11-47"><a href="#cb11-47" tabindex="-1"></a></span>
<span id="cb11-48"><a href="#cb11-48" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">centerObject</span>(geometry<span class="op">,</span> <span class="dv">12</span>)<span class="op">;</span></span>
<span id="cb11-49"><a href="#cb11-49" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(image<span class="op">.</span><span class="fu">clip</span>(geometry)<span class="op">,</span> rgbVis<span class="op">,</span> <span class="st">&#39;Image&#39;</span>)<span class="op">;</span></span>
<span id="cb11-50"><a href="#cb11-50" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(mndwi<span class="op">.</span><span class="fu">clip</span>(geometry)<span class="op">,</span> ndwiVis<span class="op">,</span> <span class="st">&#39;MNDWI&#39;</span><span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span></span>
<span id="cb11-51"><a href="#cb11-51" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(ndci<span class="op">.</span><span class="fu">clip</span>(geometry)<span class="op">,</span> ndciVis<span class="op">,</span> <span class="st">&#39;NDCI&#39;</span><span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span></span>
<span id="cb11-52"><a href="#cb11-52" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(algae<span class="op">.</span><span class="fu">clip</span>(geometry)<span class="op">.</span><span class="fu">selfMask</span>()<span class="op">,</span> algaeVis<span class="op">,</span> <span class="st">&#39;Algal Bloom&#39;</span>)<span class="op">;</span></span></code></pre></div>
</div>
<div id="detect-first-year-of-water" class="section level2">
<h2>Detect First Year of Water</h2>
<p><a
href="https://code.earthengine.google.com/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3ASupplement%2FSurface_Water%2FDetect_First_Year_of_Water"
target="_blank">Open in Code Editor ↗</a></p>
<div class="sourceCode" id="cb12"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb12-1"><a href="#cb12-1" tabindex="-1"></a><span class="co">// This script shows how to determine when the water appeared </span></span>
<span id="cb12-2"><a href="#cb12-2" tabindex="-1"></a><span class="co">// for the first time at a given pixel</span></span>
<span id="cb12-3"><a href="#cb12-3" tabindex="-1"></a><span class="kw">var</span> gswYearly <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&quot;JRC/GSW1_3/YearlyHistory&quot;</span>) </span>
<span id="cb12-4"><a href="#cb12-4" tabindex="-1"></a></span>
<span id="cb12-5"><a href="#cb12-5" tabindex="-1"></a><span class="co">// Filter to select the year range for analysis</span></span>
<span id="cb12-6"><a href="#cb12-6" tabindex="-1"></a><span class="kw">var</span> startYear <span class="op">=</span> <span class="dv">1990</span></span>
<span id="cb12-7"><a href="#cb12-7" tabindex="-1"></a><span class="kw">var</span> endYear <span class="op">=</span> <span class="dv">2019</span></span>
<span id="cb12-8"><a href="#cb12-8" tabindex="-1"></a></span>
<span id="cb12-9"><a href="#cb12-9" tabindex="-1"></a></span>
<span id="cb12-10"><a href="#cb12-10" tabindex="-1"></a><span class="kw">var</span> filtered <span class="op">=</span> gswYearly</span>
<span id="cb12-11"><a href="#cb12-11" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">gte</span>(<span class="st">&#39;year&#39;</span><span class="op">,</span> startYear))</span>
<span id="cb12-12"><a href="#cb12-12" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">lte</span>(<span class="st">&#39;year&#39;</span><span class="op">,</span> endYear))</span>
<span id="cb12-13"><a href="#cb12-13" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(filtered<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;waterClass&#39;</span>)<span class="op">,</span> {}<span class="op">,</span> <span class="st">&#39;Water History&#39;</span><span class="op">,</span> <span class="kw">false</span>)</span>
<span id="cb12-14"><a href="#cb12-14" tabindex="-1"></a></span>
<span id="cb12-15"><a href="#cb12-15" tabindex="-1"></a><span class="kw">var</span> maskNonWater <span class="op">=</span> <span class="kw">function</span>(image) {</span>
<span id="cb12-16"><a href="#cb12-16" tabindex="-1"></a>  <span class="co">// Mask all pixels that are not seasonal or permanent water</span></span>
<span id="cb12-17"><a href="#cb12-17" tabindex="-1"></a>  <span class="co">// Pixel values</span></span>
<span id="cb12-18"><a href="#cb12-18" tabindex="-1"></a>  <span class="co">// 2 = Seasonal Water</span></span>
<span id="cb12-19"><a href="#cb12-19" tabindex="-1"></a>  <span class="co">// 3 = Permanent Water</span></span>
<span id="cb12-20"><a href="#cb12-20" tabindex="-1"></a>  <span class="co">// Return a binary image with only water pixels</span></span>
<span id="cb12-21"><a href="#cb12-21" tabindex="-1"></a>  <span class="cf">return</span> image<span class="op">.</span><span class="fu">gte</span>(<span class="dv">2</span>)<span class="op">.</span><span class="fu">selfMask</span>()</span>
<span id="cb12-22"><a href="#cb12-22" tabindex="-1"></a>    <span class="op">.</span><span class="fu">copyProperties</span>(image<span class="op">,</span> [<span class="st">&#39;year&#39;</span>])</span>
<span id="cb12-23"><a href="#cb12-23" tabindex="-1"></a>}</span>
<span id="cb12-24"><a href="#cb12-24" tabindex="-1"></a></span>
<span id="cb12-25"><a href="#cb12-25" tabindex="-1"></a><span class="kw">var</span> addYearBand <span class="op">=</span> <span class="kw">function</span> (image) {</span>
<span id="cb12-26"><a href="#cb12-26" tabindex="-1"></a>  <span class="kw">var</span> year <span class="op">=</span> image<span class="op">.</span><span class="fu">get</span>(<span class="st">&#39;year&#39;</span>)<span class="op">;</span></span>
<span id="cb12-27"><a href="#cb12-27" tabindex="-1"></a>  <span class="kw">var</span> yearImage <span class="op">=</span> ee<span class="op">.</span><span class="at">Image</span><span class="op">.</span><span class="fu">constant</span>(year)<span class="op">.</span><span class="fu">toShort</span>()<span class="op">;</span></span>
<span id="cb12-28"><a href="#cb12-28" tabindex="-1"></a>  <span class="cf">return</span> image<span class="op">.</span><span class="fu">addBands</span>(yearImage)<span class="op">.</span><span class="fu">rename</span>([<span class="st">&#39;water&#39;</span><span class="op">,</span> <span class="st">&#39;year&#39;</span>])</span>
<span id="cb12-29"><a href="#cb12-29" tabindex="-1"></a>}</span>
<span id="cb12-30"><a href="#cb12-30" tabindex="-1"></a></span>
<span id="cb12-31"><a href="#cb12-31" tabindex="-1"></a><span class="kw">var</span> processed <span class="op">=</span> filtered</span>
<span id="cb12-32"><a href="#cb12-32" tabindex="-1"></a>  <span class="op">.</span><span class="fu">map</span>(maskNonWater)</span>
<span id="cb12-33"><a href="#cb12-33" tabindex="-1"></a>  <span class="op">.</span><span class="fu">map</span>(addYearBand)</span>
<span id="cb12-34"><a href="#cb12-34" tabindex="-1"></a>  </span>
<span id="cb12-35"><a href="#cb12-35" tabindex="-1"></a><span class="co">// Understanding Multi-input reducers</span></span>
<span id="cb12-36"><a href="#cb12-36" tabindex="-1"></a><span class="kw">var</span> myList <span class="op">=</span> ee<span class="op">.</span><span class="fu">List</span>([[<span class="dv">3</span><span class="op">,</span><span class="dv">2</span>]<span class="op">,</span> [<span class="dv">4</span><span class="op">,</span><span class="dv">5</span>]<span class="op">,</span> [<span class="dv">1</span><span class="op">,</span><span class="dv">9</span>]<span class="op">,</span> [<span class="dv">1</span><span class="op">,</span><span class="dv">6</span>]<span class="op">,</span> [<span class="dv">9</span><span class="op">,</span><span class="dv">7</span>]])</span>
<span id="cb12-37"><a href="#cb12-37" tabindex="-1"></a><span class="co">// ee.Reducer.min(2) will sort by first element of each item</span></span>
<span id="cb12-38"><a href="#cb12-38" tabindex="-1"></a><span class="co">// and return that item</span></span>
<span id="cb12-39"><a href="#cb12-39" tabindex="-1"></a><span class="fu">print</span>(myList<span class="op">.</span><span class="fu">reduce</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">min</span>(<span class="dv">2</span>)))</span>
<span id="cb12-40"><a href="#cb12-40" tabindex="-1"></a><span class="co">// We now apply this to our collection</span></span>
<span id="cb12-41"><a href="#cb12-41" tabindex="-1"></a></span>
<span id="cb12-42"><a href="#cb12-42" tabindex="-1"></a><span class="co">// Our collection has 40 2-band images</span></span>
<span id="cb12-43"><a href="#cb12-43" tabindex="-1"></a><span class="co">// &#39;water&#39; and &#39;year&#39;</span></span>
<span id="cb12-44"><a href="#cb12-44" tabindex="-1"></a><span class="co">// Applying a reducer we will get a single 2-band image</span></span>
<span id="cb12-45"><a href="#cb12-45" tabindex="-1"></a><span class="co">// where each pixel will have the value from the first water pixel</span></span>
<span id="cb12-46"><a href="#cb12-46" tabindex="-1"></a><span class="co">// and corresponding year</span></span>
<span id="cb12-47"><a href="#cb12-47" tabindex="-1"></a><span class="kw">var</span> result <span class="op">=</span> processed<span class="op">.</span><span class="fu">reduce</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">min</span>(<span class="dv">2</span>))<span class="op">.</span><span class="fu">rename</span>([<span class="st">&#39;water&#39;</span><span class="op">,</span> <span class="st">&#39;year&#39;</span>])</span>
<span id="cb12-48"><a href="#cb12-48" tabindex="-1"></a></span>
<span id="cb12-49"><a href="#cb12-49" tabindex="-1"></a><span class="kw">var</span> gsw <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(<span class="st">&quot;JRC/GSW1_3/GlobalSurfaceWater&quot;</span>)</span>
<span id="cb12-50"><a href="#cb12-50" tabindex="-1"></a><span class="kw">var</span> permanentWater <span class="op">=</span> gsw<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;seasonality&#39;</span>)<span class="op">.</span><span class="fu">gte</span>(<span class="dv">5</span>)</span>
<span id="cb12-51"><a href="#cb12-51" tabindex="-1"></a><span class="kw">var</span> newWaterYear <span class="op">=</span> result<span class="op">.</span><span class="fu">select</span>([<span class="st">&#39;year&#39;</span>])<span class="op">.</span><span class="fu">updateMask</span>(permanentWater<span class="op">.</span><span class="fu">not</span>())</span>
<span id="cb12-52"><a href="#cb12-52" tabindex="-1"></a></span>
<span id="cb12-53"><a href="#cb12-53" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">setCenter</span>(<span class="fl">79.899</span><span class="op">,</span> <span class="fl">12.164</span><span class="op">,</span> <span class="dv">17</span>)</span>
<span id="cb12-54"><a href="#cb12-54" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">setOptions</span>(<span class="st">&#39;SATELLITE&#39;</span>)</span>
<span id="cb12-55"><a href="#cb12-55" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(newWaterYear<span class="op">,</span> </span>
<span id="cb12-56"><a href="#cb12-56" tabindex="-1"></a>  {<span class="dt">min</span><span class="op">:</span> startYear<span class="op">,</span> <span class="dt">max</span><span class="op">:</span> endYear<span class="op">,</span> <span class="dt">palette</span><span class="op">:</span> [<span class="st">&#39;white&#39;</span><span class="op">,</span> <span class="st">&#39;purple&#39;</span>]}<span class="op">,</span></span>
<span id="cb12-57"><a href="#cb12-57" tabindex="-1"></a>  <span class="st">&#39;Year of First Water&#39;</span>)</span>
<span id="cb12-58"><a href="#cb12-58" tabindex="-1"></a></span>
<span id="cb12-59"><a href="#cb12-59" tabindex="-1"></a><span class="co">// Convert the pixels to vectors and label them</span></span>
<span id="cb12-60"><a href="#cb12-60" tabindex="-1"></a><span class="kw">var</span> vectors <span class="op">=</span> newWaterYear<span class="op">.</span><span class="fu">reduceToVectors</span>({</span>
<span id="cb12-61"><a href="#cb12-61" tabindex="-1"></a>  <span class="dt">geometry</span><span class="op">:</span> <span class="bu">Map</span><span class="op">.</span><span class="fu">getBounds</span>(<span class="kw">true</span>)<span class="op">,</span></span>
<span id="cb12-62"><a href="#cb12-62" tabindex="-1"></a>  <span class="dt">scale</span><span class="op">:</span> <span class="dv">30</span><span class="op">,</span></span>
<span id="cb12-63"><a href="#cb12-63" tabindex="-1"></a>  <span class="dt">eightConnected</span><span class="op">:</span> <span class="kw">true</span></span>
<span id="cb12-64"><a href="#cb12-64" tabindex="-1"></a>})</span>
<span id="cb12-65"><a href="#cb12-65" tabindex="-1"></a></span>
<span id="cb12-66"><a href="#cb12-66" tabindex="-1"></a><span class="co">// 3rd party package for labelling</span></span>
<span id="cb12-67"><a href="#cb12-67" tabindex="-1"></a><span class="kw">var</span> style <span class="op">=</span> <span class="pp">require</span>(<span class="st">&#39;users/gena/packages:style&#39;</span>)</span>
<span id="cb12-68"><a href="#cb12-68" tabindex="-1"></a><span class="kw">var</span> textProperties <span class="op">=</span> { <span class="dt">textColor</span><span class="op">:</span> <span class="st">&#39;ffffff&#39;</span><span class="op">,</span> <span class="dt">fontSize</span><span class="op">:</span> <span class="dv">12</span><span class="op">,</span> <span class="dt">outlineColor</span><span class="op">:</span> <span class="st">&#39;000000&#39;</span>}</span>
<span id="cb12-69"><a href="#cb12-69" tabindex="-1"></a><span class="kw">var</span> labels <span class="op">=</span> style<span class="op">.</span><span class="at">Feature</span><span class="op">.</span><span class="fu">label</span>(vectors<span class="op">,</span> <span class="st">&#39;label&#39;</span><span class="op">,</span> textProperties)</span>
<span id="cb12-70"><a href="#cb12-70" tabindex="-1"></a></span>
<span id="cb12-71"><a href="#cb12-71" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(labels<span class="op">,</span> {}<span class="op">,</span> <span class="st">&#39;labels&#39;</span>)</span></code></pre></div>
</div>
<div id="otsu-dynamic-thresholding" class="section level2">
<h2>Otsu Dynamic Thresholding</h2>
<p><a
href="https://code.earthengine.google.com/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3ASupplement%2FSurface_Water%2FOtsu_Dynamic_Thresholding"
target="_blank">Open in Code Editor ↗</a></p>
<div class="sourceCode" id="cb13"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb13-1"><a href="#cb13-1" tabindex="-1"></a><span class="kw">var</span> admin2 <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">&quot;FAO/GAUL_SIMPLIFIED_500m/2015/level2&quot;</span>)<span class="op">;</span></span>
<span id="cb13-2"><a href="#cb13-2" tabindex="-1"></a><span class="kw">var</span> s2 <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&quot;COPERNICUS/S2_SR_HARMONIZED&quot;</span>)<span class="op">;</span></span>
<span id="cb13-3"><a href="#cb13-3" tabindex="-1"></a></span>
<span id="cb13-4"><a href="#cb13-4" tabindex="-1"></a><span class="kw">var</span> selected <span class="op">=</span> admin2<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;ADM2_NAME&#39;</span><span class="op">,</span> <span class="st">&#39;Bangalore Urban&#39;</span>))</span>
<span id="cb13-5"><a href="#cb13-5" tabindex="-1"></a><span class="kw">var</span> geometry <span class="op">=</span> selected<span class="op">.</span><span class="fu">geometry</span>()</span>
<span id="cb13-6"><a href="#cb13-6" tabindex="-1"></a></span>
<span id="cb13-7"><a href="#cb13-7" tabindex="-1"></a><span class="kw">var</span> filtered <span class="op">=</span> s2<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">lt</span>(<span class="st">&#39;CLOUDY_PIXEL_PERCENTAGE&#39;</span><span class="op">,</span> <span class="dv">30</span>))</span>
<span id="cb13-8"><a href="#cb13-8" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(<span class="st">&#39;2019-01-01&#39;</span><span class="op">,</span> <span class="st">&#39;2020-01-01&#39;</span>))</span>
<span id="cb13-9"><a href="#cb13-9" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">bounds</span>(geometry))</span>
<span id="cb13-10"><a href="#cb13-10" tabindex="-1"></a></span>
<span id="cb13-11"><a href="#cb13-11" tabindex="-1"></a><span class="co">// Load the Cloud Score+ collection</span></span>
<span id="cb13-12"><a href="#cb13-12" tabindex="-1"></a><span class="kw">var</span> csPlus <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&#39;GOOGLE/CLOUD_SCORE_PLUS/V1/S2_HARMONIZED&#39;</span>)<span class="op">;</span></span>
<span id="cb13-13"><a href="#cb13-13" tabindex="-1"></a><span class="kw">var</span> csPlusBands <span class="op">=</span> csPlus<span class="op">.</span><span class="fu">first</span>()<span class="op">.</span><span class="fu">bandNames</span>()<span class="op">;</span></span>
<span id="cb13-14"><a href="#cb13-14" tabindex="-1"></a></span>
<span id="cb13-15"><a href="#cb13-15" tabindex="-1"></a><span class="co">// We need to add Cloud Score + bands to each Sentinel-2</span></span>
<span id="cb13-16"><a href="#cb13-16" tabindex="-1"></a><span class="co">// image in the collection</span></span>
<span id="cb13-17"><a href="#cb13-17" tabindex="-1"></a><span class="co">// This is done using the linkCollection() function</span></span>
<span id="cb13-18"><a href="#cb13-18" tabindex="-1"></a><span class="kw">var</span> filteredS2WithCs <span class="op">=</span> filtered<span class="op">.</span><span class="fu">linkCollection</span>(csPlus<span class="op">,</span> csPlusBands)<span class="op">;</span></span>
<span id="cb13-19"><a href="#cb13-19" tabindex="-1"></a></span>
<span id="cb13-20"><a href="#cb13-20" tabindex="-1"></a><span class="co">// Function to mask pixels with low CS+ QA scores.</span></span>
<span id="cb13-21"><a href="#cb13-21" tabindex="-1"></a><span class="kw">function</span> <span class="fu">maskLowQA</span>(image) {</span>
<span id="cb13-22"><a href="#cb13-22" tabindex="-1"></a>  <span class="kw">var</span> qaBand <span class="op">=</span> <span class="st">&#39;cs&#39;</span><span class="op">;</span></span>
<span id="cb13-23"><a href="#cb13-23" tabindex="-1"></a>  <span class="kw">var</span> clearThreshold <span class="op">=</span> <span class="fl">0.5</span><span class="op">;</span></span>
<span id="cb13-24"><a href="#cb13-24" tabindex="-1"></a>  <span class="kw">var</span> mask <span class="op">=</span> image<span class="op">.</span><span class="fu">select</span>(qaBand)<span class="op">.</span><span class="fu">gte</span>(clearThreshold)<span class="op">;</span></span>
<span id="cb13-25"><a href="#cb13-25" tabindex="-1"></a>  <span class="cf">return</span> image<span class="op">.</span><span class="fu">updateMask</span>(mask)<span class="op">;</span></span>
<span id="cb13-26"><a href="#cb13-26" tabindex="-1"></a>}</span>
<span id="cb13-27"><a href="#cb13-27" tabindex="-1"></a></span>
<span id="cb13-28"><a href="#cb13-28" tabindex="-1"></a><span class="kw">var</span> filteredMasked <span class="op">=</span> filteredS2WithCs</span>
<span id="cb13-29"><a href="#cb13-29" tabindex="-1"></a>  <span class="op">.</span><span class="fu">map</span>(maskLowQA)</span>
<span id="cb13-30"><a href="#cb13-30" tabindex="-1"></a>  <span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;B.*&#39;</span>)<span class="op">;</span></span>
<span id="cb13-31"><a href="#cb13-31" tabindex="-1"></a>  </span>
<span id="cb13-32"><a href="#cb13-32" tabindex="-1"></a><span class="kw">var</span> image <span class="op">=</span> filteredMasked<span class="op">.</span><span class="fu">median</span>()<span class="op">.</span><span class="fu">clip</span>(geometry)<span class="op">;</span> </span>
<span id="cb13-33"><a href="#cb13-33" tabindex="-1"></a></span>
<span id="cb13-34"><a href="#cb13-34" tabindex="-1"></a><span class="kw">var</span> mndwi <span class="op">=</span> image<span class="op">.</span><span class="fu">normalizedDifference</span>([<span class="st">&#39;B3&#39;</span><span class="op">,</span> <span class="st">&#39;B11&#39;</span>])<span class="op">.</span><span class="fu">rename</span>([<span class="st">&#39;mndwi&#39;</span>])<span class="op">;</span></span>
<span id="cb13-35"><a href="#cb13-35" tabindex="-1"></a></span>
<span id="cb13-36"><a href="#cb13-36" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(mndwi<span class="op">,</span> {<span class="dt">min</span><span class="op">:</span><span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span><span class="fl">0.8</span><span class="op">,</span> <span class="dt">palette</span><span class="op">:</span> [<span class="st">&#39;white&#39;</span><span class="op">,</span> <span class="st">&#39;blue&#39;</span>]}<span class="op">,</span> <span class="st">&#39;MNDWI&#39;</span>)<span class="op">;</span></span>
<span id="cb13-37"><a href="#cb13-37" tabindex="-1"></a></span>
<span id="cb13-38"><a href="#cb13-38" tabindex="-1"></a><span class="co">// Simple Thresholding</span></span>
<span id="cb13-39"><a href="#cb13-39" tabindex="-1"></a><span class="kw">var</span> waterMndwi <span class="op">=</span> mndwi<span class="op">.</span><span class="fu">gt</span>(<span class="dv">0</span>)</span>
<span id="cb13-40"><a href="#cb13-40" tabindex="-1"></a></span>
<span id="cb13-41"><a href="#cb13-41" tabindex="-1"></a><span class="co">// Otsu Thresholding</span></span>
<span id="cb13-42"><a href="#cb13-42" tabindex="-1"></a><span class="co">// Source https://code.earthengine.google.com/e9c699d7b5ef811d0a67c02756473e9d</span></span>
<span id="cb13-43"><a href="#cb13-43" tabindex="-1"></a></span>
<span id="cb13-44"><a href="#cb13-44" tabindex="-1"></a><span class="co">// Use lower scale to avoid edges from small buildings</span></span>
<span id="cb13-45"><a href="#cb13-45" tabindex="-1"></a><span class="kw">var</span> scale <span class="op">=</span> <span class="dv">100</span></span>
<span id="cb13-46"><a href="#cb13-46" tabindex="-1"></a><span class="kw">var</span> bounds <span class="op">=</span> geometry</span>
<span id="cb13-47"><a href="#cb13-47" tabindex="-1"></a><span class="kw">var</span> cannyThreshold <span class="op">=</span> <span class="fl">0.7</span></span>
<span id="cb13-48"><a href="#cb13-48" tabindex="-1"></a><span class="kw">var</span> cannySigma <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb13-49"><a href="#cb13-49" tabindex="-1"></a><span class="kw">var</span> minValue <span class="op">=</span> <span class="op">-</span><span class="fl">0.2</span></span>
<span id="cb13-50"><a href="#cb13-50" tabindex="-1"></a><span class="co">// Set debug=false if you do not want the charts</span></span>
<span id="cb13-51"><a href="#cb13-51" tabindex="-1"></a><span class="kw">var</span> debug <span class="op">=</span> <span class="kw">true</span></span>
<span id="cb13-52"><a href="#cb13-52" tabindex="-1"></a><span class="co">// Set this higher to discard smaller edges</span></span>
<span id="cb13-53"><a href="#cb13-53" tabindex="-1"></a><span class="kw">var</span> minEdgeLength <span class="op">=</span> <span class="dv">40</span></span>
<span id="cb13-54"><a href="#cb13-54" tabindex="-1"></a><span class="kw">var</span> th <span class="op">=</span> <span class="fu">computeThresholdUsingOtsu</span>(</span>
<span id="cb13-55"><a href="#cb13-55" tabindex="-1"></a>  mndwi<span class="op">,</span> scale<span class="op">,</span> bounds<span class="op">,</span> cannyThreshold<span class="op">,</span> cannySigma<span class="op">,</span> minValue<span class="op">,</span> debug<span class="op">,</span> minEdgeLength)</span>
<span id="cb13-56"><a href="#cb13-56" tabindex="-1"></a><span class="fu">print</span>(<span class="st">&#39;Threshold&#39;</span><span class="op">,</span> th)</span>
<span id="cb13-57"><a href="#cb13-57" tabindex="-1"></a><span class="kw">var</span> waterOtsu <span class="op">=</span> mndwi<span class="op">.</span><span class="fu">gt</span>(th)<span class="op">;</span></span>
<span id="cb13-58"><a href="#cb13-58" tabindex="-1"></a></span>
<span id="cb13-59"><a href="#cb13-59" tabindex="-1"></a><span class="kw">var</span> rgbVis <span class="op">=</span> {<span class="dt">min</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span> <span class="fl">0.3</span><span class="op">,</span> <span class="dt">bands</span><span class="op">:</span> [<span class="st">&#39;B4&#39;</span><span class="op">,</span> <span class="st">&#39;B3&#39;</span><span class="op">,</span> <span class="st">&#39;B2&#39;</span>]}<span class="op">;</span></span>
<span id="cb13-60"><a href="#cb13-60" tabindex="-1"></a><span class="kw">var</span> waterVis <span class="op">=</span> {<span class="dt">min</span><span class="op">:</span><span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span><span class="dv">1</span><span class="op">,</span> <span class="dt">palette</span><span class="op">:</span> [<span class="st">&#39;white&#39;</span><span class="op">,</span> <span class="st">&#39;black&#39;</span>]}</span>
<span id="cb13-61"><a href="#cb13-61" tabindex="-1"></a></span>
<span id="cb13-62"><a href="#cb13-62" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">centerObject</span>(geometry<span class="op">,</span> <span class="dv">10</span>)</span>
<span id="cb13-63"><a href="#cb13-63" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(image<span class="op">,</span> rgbVis<span class="op">,</span> <span class="st">&#39;Image&#39;</span>)<span class="op">;</span></span>
<span id="cb13-64"><a href="#cb13-64" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(waterMndwi<span class="op">.</span><span class="fu">selfMask</span>()<span class="op">,</span> waterVis<span class="op">,</span> <span class="st">&#39;MNDWI - Simple threshold&#39;</span>)</span>
<span id="cb13-65"><a href="#cb13-65" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(waterOtsu<span class="op">.</span><span class="fu">selfMask</span>()<span class="op">,</span> waterVis<span class="op">,</span> <span class="st">&#39;MNDWI with Otsu Thresholding&#39;</span>) </span>
<span id="cb13-66"><a href="#cb13-66" tabindex="-1"></a></span>
<span id="cb13-67"><a href="#cb13-67" tabindex="-1"></a></span>
<span id="cb13-68"><a href="#cb13-68" tabindex="-1"></a><span class="co">/***</span></span>
<span id="cb13-69"><a href="#cb13-69" tabindex="-1"></a><span class="co"> * Compute a threshold using Otsu method (bimodal)</span></span>
<span id="cb13-70"><a href="#cb13-70" tabindex="-1"></a><span class="co"> */</span></span>
<span id="cb13-71"><a href="#cb13-71" tabindex="-1"></a><span class="kw">function</span> <span class="fu">computeThresholdUsingOtsu</span>(image<span class="op">,</span> scale<span class="op">,</span> bounds<span class="op">,</span> cannyThreshold<span class="op">,</span> cannySigma<span class="op">,</span> minValue<span class="op">,</span> debug<span class="op">,</span> minEdgeLength<span class="op">,</span> minEdgeGradient<span class="op">,</span> minEdgeValue) {</span>
<span id="cb13-72"><a href="#cb13-72" tabindex="-1"></a>    <span class="co">// clip image edges</span></span>
<span id="cb13-73"><a href="#cb13-73" tabindex="-1"></a>    <span class="kw">var</span> bufferDistance <span class="op">=</span> ee<span class="op">.</span><span class="fu">Number</span>(scale)<span class="op">.</span><span class="fu">multiply</span>(<span class="dv">10</span>)<span class="op">.</span><span class="fu">multiply</span>(<span class="op">-</span><span class="dv">1</span>)</span>
<span id="cb13-74"><a href="#cb13-74" tabindex="-1"></a>    <span class="kw">var</span> mask <span class="op">=</span> image<span class="op">.</span><span class="fu">mask</span>()<span class="op">.</span><span class="fu">clip</span>(bounds<span class="op">.</span><span class="fu">buffer</span>(bufferDistance))<span class="op">;</span></span>
<span id="cb13-75"><a href="#cb13-75" tabindex="-1"></a></span>
<span id="cb13-76"><a href="#cb13-76" tabindex="-1"></a>    <span class="co">// detect sharp changes</span></span>
<span id="cb13-77"><a href="#cb13-77" tabindex="-1"></a>    <span class="kw">var</span> edge <span class="op">=</span> ee<span class="op">.</span><span class="at">Algorithms</span><span class="op">.</span><span class="fu">CannyEdgeDetector</span>(image<span class="op">,</span> cannyThreshold<span class="op">,</span> cannySigma)<span class="op">;</span></span>
<span id="cb13-78"><a href="#cb13-78" tabindex="-1"></a>    edge <span class="op">=</span> edge<span class="op">.</span><span class="fu">multiply</span>(mask)<span class="op">;</span></span>
<span id="cb13-79"><a href="#cb13-79" tabindex="-1"></a>    </span>
<span id="cb13-80"><a href="#cb13-80" tabindex="-1"></a>    <span class="cf">if</span>(minEdgeLength) {</span>
<span id="cb13-81"><a href="#cb13-81" tabindex="-1"></a>        <span class="kw">var</span> connected <span class="op">=</span> edge<span class="op">.</span><span class="fu">mask</span>(edge)<span class="op">.</span><span class="fu">lt</span>(cannyThreshold)<span class="op">.</span><span class="fu">connectedPixelCount</span>(<span class="dv">200</span><span class="op">,</span> <span class="kw">true</span>)<span class="op">;</span></span>
<span id="cb13-82"><a href="#cb13-82" tabindex="-1"></a></span>
<span id="cb13-83"><a href="#cb13-83" tabindex="-1"></a>        <span class="kw">var</span> edgeLong <span class="op">=</span> connected<span class="op">.</span><span class="fu">gte</span>(minEdgeLength)<span class="op">;</span></span>
<span id="cb13-84"><a href="#cb13-84" tabindex="-1"></a></span>
<span id="cb13-85"><a href="#cb13-85" tabindex="-1"></a>        <span class="cf">if</span>(debug) {</span>
<span id="cb13-86"><a href="#cb13-86" tabindex="-1"></a>          <span class="fu">print</span>(<span class="st">&#39;Edge length: &#39;</span><span class="op">,</span> ui<span class="op">.</span><span class="at">Chart</span><span class="op">.</span><span class="at">image</span><span class="op">.</span><span class="fu">histogram</span>(connected<span class="op">,</span> bounds<span class="op">,</span> scale<span class="op">,</span> buckets))</span>
<span id="cb13-87"><a href="#cb13-87" tabindex="-1"></a>          </span>
<span id="cb13-88"><a href="#cb13-88" tabindex="-1"></a>          <span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(edge<span class="op">.</span><span class="fu">mask</span>(edge)<span class="op">,</span> {<span class="dt">palette</span><span class="op">:</span>[<span class="st">&#39;ff0000&#39;</span>]}<span class="op">,</span> <span class="st">&#39;edges (short)&#39;</span><span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span></span>
<span id="cb13-89"><a href="#cb13-89" tabindex="-1"></a>        }</span>
<span id="cb13-90"><a href="#cb13-90" tabindex="-1"></a></span>
<span id="cb13-91"><a href="#cb13-91" tabindex="-1"></a>        edge <span class="op">=</span> edgeLong<span class="op">;</span></span>
<span id="cb13-92"><a href="#cb13-92" tabindex="-1"></a>    }</span>
<span id="cb13-93"><a href="#cb13-93" tabindex="-1"></a>    </span>
<span id="cb13-94"><a href="#cb13-94" tabindex="-1"></a>    <span class="co">// buffer around NDWI edges</span></span>
<span id="cb13-95"><a href="#cb13-95" tabindex="-1"></a>    <span class="kw">var</span> edgeBuffer <span class="op">=</span> edge<span class="op">.</span><span class="fu">focal_max</span>(ee<span class="op">.</span><span class="fu">Number</span>(scale)<span class="op">,</span> <span class="st">&#39;square&#39;</span><span class="op">,</span> <span class="st">&#39;meters&#39;</span>)<span class="op">;</span></span>
<span id="cb13-96"><a href="#cb13-96" tabindex="-1"></a>    <span class="cf">if</span>(minEdgeValue) {</span>
<span id="cb13-97"><a href="#cb13-97" tabindex="-1"></a>      <span class="kw">var</span> edgeMin <span class="op">=</span> image<span class="op">.</span><span class="fu">reduceNeighborhood</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">min</span>()<span class="op">,</span> ee<span class="op">.</span><span class="at">Kernel</span><span class="op">.</span><span class="fu">circle</span>(ee<span class="op">.</span><span class="fu">Number</span>(scale)<span class="op">,</span> <span class="st">&#39;meters&#39;</span>))</span>
<span id="cb13-98"><a href="#cb13-98" tabindex="-1"></a></span>
<span id="cb13-99"><a href="#cb13-99" tabindex="-1"></a>      edgeBuffer <span class="op">=</span> edgeBuffer<span class="op">.</span><span class="fu">updateMask</span>(edgeMin<span class="op">.</span><span class="fu">gt</span>(minEdgeValue))</span>
<span id="cb13-100"><a href="#cb13-100" tabindex="-1"></a></span>
<span id="cb13-101"><a href="#cb13-101" tabindex="-1"></a>      <span class="cf">if</span>(debug) {</span>
<span id="cb13-102"><a href="#cb13-102" tabindex="-1"></a>        <span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(edge<span class="op">.</span><span class="fu">updateMask</span>(edgeBuffer)<span class="op">,</span> {<span class="dt">palette</span><span class="op">:</span>[<span class="st">&#39;ff0000&#39;</span>]}<span class="op">,</span> <span class="st">&#39;edge min&#39;</span><span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span></span>
<span id="cb13-103"><a href="#cb13-103" tabindex="-1"></a>      }</span>
<span id="cb13-104"><a href="#cb13-104" tabindex="-1"></a>    }</span>
<span id="cb13-105"><a href="#cb13-105" tabindex="-1"></a></span>
<span id="cb13-106"><a href="#cb13-106" tabindex="-1"></a>    <span class="cf">if</span>(minEdgeGradient) {</span>
<span id="cb13-107"><a href="#cb13-107" tabindex="-1"></a>      <span class="kw">var</span> edgeGradient <span class="op">=</span> image<span class="op">.</span><span class="fu">gradient</span>()<span class="op">.</span><span class="fu">abs</span>()<span class="op">.</span><span class="fu">reduce</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">max</span>())<span class="op">.</span><span class="fu">updateMask</span>(edgeBuffer<span class="op">.</span><span class="fu">mask</span>())</span>
<span id="cb13-108"><a href="#cb13-108" tabindex="-1"></a></span>
<span id="cb13-109"><a href="#cb13-109" tabindex="-1"></a>      <span class="kw">var</span> edgeGradientTh <span class="op">=</span> ee<span class="op">.</span><span class="fu">Number</span>(edgeGradient<span class="op">.</span><span class="fu">reduceRegion</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">percentile</span>([minEdgeGradient])<span class="op">,</span> bounds<span class="op">,</span> scale)<span class="op">.</span><span class="fu">values</span>()<span class="op">.</span><span class="fu">get</span>(<span class="dv">0</span>))</span>
<span id="cb13-110"><a href="#cb13-110" tabindex="-1"></a></span>
<span id="cb13-111"><a href="#cb13-111" tabindex="-1"></a>      <span class="cf">if</span>(debug) {e</span>
<span id="cb13-112"><a href="#cb13-112" tabindex="-1"></a>        <span class="fu">print</span>(<span class="st">&#39;Edge gradient threshold: &#39;</span><span class="op">,</span> edgeGradientTh)</span>
<span id="cb13-113"><a href="#cb13-113" tabindex="-1"></a>        </span>
<span id="cb13-114"><a href="#cb13-114" tabindex="-1"></a>        <span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(edgeGradient<span class="op">.</span><span class="fu">mask</span>(edgeGradient)<span class="op">,</span> {<span class="dt">palette</span><span class="op">:</span>[<span class="st">&#39;ff0000&#39;</span>]}<span class="op">,</span> <span class="st">&#39;edge gradient&#39;</span><span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span></span>
<span id="cb13-115"><a href="#cb13-115" tabindex="-1"></a></span>
<span id="cb13-116"><a href="#cb13-116" tabindex="-1"></a>        <span class="fu">print</span>(<span class="st">&#39;Edge gradient: &#39;</span><span class="op">,</span> ui<span class="op">.</span><span class="at">Chart</span><span class="op">.</span><span class="at">image</span><span class="op">.</span><span class="fu">histogram</span>(edgeGradient<span class="op">,</span> bounds<span class="op">,</span> scale<span class="op">,</span> buckets))</span>
<span id="cb13-117"><a href="#cb13-117" tabindex="-1"></a>      }</span>
<span id="cb13-118"><a href="#cb13-118" tabindex="-1"></a>      </span>
<span id="cb13-119"><a href="#cb13-119" tabindex="-1"></a>      edgeBuffer <span class="op">=</span> edgeBuffer<span class="op">.</span><span class="fu">updateMask</span>(edgeGradient<span class="op">.</span><span class="fu">gt</span>(edgeGradientTh))</span>
<span id="cb13-120"><a href="#cb13-120" tabindex="-1"></a>    }</span>
<span id="cb13-121"><a href="#cb13-121" tabindex="-1"></a></span>
<span id="cb13-122"><a href="#cb13-122" tabindex="-1"></a>    edge <span class="op">=</span> edge<span class="op">.</span><span class="fu">updateMask</span>(edgeBuffer)</span>
<span id="cb13-123"><a href="#cb13-123" tabindex="-1"></a>    <span class="kw">var</span> edgeBuffer <span class="op">=</span> edge<span class="op">.</span><span class="fu">focal_max</span>(ee<span class="op">.</span><span class="fu">Number</span>(scale)<span class="op">.</span><span class="fu">multiply</span>(<span class="dv">1</span>)<span class="op">,</span> <span class="st">&#39;square&#39;</span><span class="op">,</span> <span class="st">&#39;meters&#39;</span>)<span class="op">;</span></span>
<span id="cb13-124"><a href="#cb13-124" tabindex="-1"></a>    <span class="kw">var</span> imageEdge <span class="op">=</span> image<span class="op">.</span><span class="fu">mask</span>(edgeBuffer)<span class="op">;</span></span>
<span id="cb13-125"><a href="#cb13-125" tabindex="-1"></a></span>
<span id="cb13-126"><a href="#cb13-126" tabindex="-1"></a>    <span class="cf">if</span>(debug) {</span>
<span id="cb13-127"><a href="#cb13-127" tabindex="-1"></a>      <span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(imageEdge<span class="op">,</span> {<span class="dt">palette</span><span class="op">:</span>[<span class="st">&#39;222200&#39;</span><span class="op">,</span> <span class="st">&#39;ffff00&#39;</span>]}<span class="op">,</span> <span class="st">&#39;image edge buffer&#39;</span><span class="op">,</span> <span class="kw">false</span>)</span>
<span id="cb13-128"><a href="#cb13-128" tabindex="-1"></a>    }</span>
<span id="cb13-129"><a href="#cb13-129" tabindex="-1"></a>    </span>
<span id="cb13-130"><a href="#cb13-130" tabindex="-1"></a>    <span class="co">// compute threshold using Otsu thresholding</span></span>
<span id="cb13-131"><a href="#cb13-131" tabindex="-1"></a>    <span class="kw">var</span> buckets <span class="op">=</span> <span class="dv">100</span><span class="op">;</span></span>
<span id="cb13-132"><a href="#cb13-132" tabindex="-1"></a>    <span class="kw">var</span> hist <span class="op">=</span> ee<span class="op">.</span><span class="fu">Dictionary</span>(ee<span class="op">.</span><span class="fu">Dictionary</span>(imageEdge<span class="op">.</span><span class="fu">reduceRegion</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">histogram</span>(buckets)<span class="op">,</span> bounds<span class="op">,</span> scale))<span class="op">.</span><span class="fu">values</span>()<span class="op">.</span><span class="fu">get</span>(<span class="dv">0</span>))<span class="op">;</span></span>
<span id="cb13-133"><a href="#cb13-133" tabindex="-1"></a>    <span class="kw">var</span> threshold <span class="op">=</span> ee<span class="op">.</span><span class="at">Algorithms</span><span class="op">.</span><span class="fu">If</span>(hist<span class="op">.</span><span class="fu">contains</span>(<span class="st">&#39;bucketMeans&#39;</span>)<span class="op">,</span> <span class="fu">otsu</span>(hist)<span class="op">,</span> minValue)<span class="op">;</span></span>
<span id="cb13-134"><a href="#cb13-134" tabindex="-1"></a>    threshold <span class="op">=</span> ee<span class="op">.</span><span class="fu">Number</span>(threshold)</span>
<span id="cb13-135"><a href="#cb13-135" tabindex="-1"></a></span>
<span id="cb13-136"><a href="#cb13-136" tabindex="-1"></a>    <span class="cf">if</span>(debug) {</span>
<span id="cb13-137"><a href="#cb13-137" tabindex="-1"></a>        <span class="co">// experimental</span></span>
<span id="cb13-138"><a href="#cb13-138" tabindex="-1"></a>        <span class="co">// var jrc = ee.Image(&#39;JRC/GSW1_0/GlobalSurfaceWater&#39;).select(&#39;occurrence&#39;)</span></span>
<span id="cb13-139"><a href="#cb13-139" tabindex="-1"></a>        <span class="co">// var jrcTh = ee.Number(ee.Dictionary(jrc.updateMask(edge).reduceRegion(ee.Reducer.mode(), bounds, scale)).values().get(0))</span></span>
<span id="cb13-140"><a href="#cb13-140" tabindex="-1"></a>        <span class="co">// var water = jrc.gt(jrcTh)</span></span>
<span id="cb13-141"><a href="#cb13-141" tabindex="-1"></a>        <span class="co">// Map.addLayer(jrc, {palette: [&#39;000000&#39;, &#39;ffff00&#39;]}, &#39;JRC&#39;)</span></span>
<span id="cb13-142"><a href="#cb13-142" tabindex="-1"></a>        <span class="co">// print(&#39;JRC occurrence (edge)&#39;, ui.Chart.image.histogram(jrc.updateMask(edge), bounds, scale, buckets))</span></span>
<span id="cb13-143"><a href="#cb13-143" tabindex="-1"></a></span>
<span id="cb13-144"><a href="#cb13-144" tabindex="-1"></a>        <span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(edge<span class="op">.</span><span class="fu">mask</span>(edge)<span class="op">,</span> {<span class="dt">palette</span><span class="op">:</span>[<span class="st">&#39;ff0000&#39;</span>]}<span class="op">,</span> <span class="st">&#39;edges&#39;</span><span class="op">,</span> <span class="kw">true</span>)<span class="op">;</span></span>
<span id="cb13-145"><a href="#cb13-145" tabindex="-1"></a></span>
<span id="cb13-146"><a href="#cb13-146" tabindex="-1"></a>        <span class="fu">print</span>(<span class="st">&#39;Threshold: &#39;</span><span class="op">,</span> threshold)<span class="op">;</span></span>
<span id="cb13-147"><a href="#cb13-147" tabindex="-1"></a></span>
<span id="cb13-148"><a href="#cb13-148" tabindex="-1"></a>        <span class="fu">print</span>(<span class="st">&#39;Image values:&#39;</span><span class="op">,</span> ui<span class="op">.</span><span class="at">Chart</span><span class="op">.</span><span class="at">image</span><span class="op">.</span><span class="fu">histogram</span>(image<span class="op">,</span> bounds<span class="op">,</span> scale<span class="op">,</span> buckets))<span class="op">;</span></span>
<span id="cb13-149"><a href="#cb13-149" tabindex="-1"></a>        <span class="fu">print</span>(<span class="st">&#39;Image values (edge): &#39;</span><span class="op">,</span> ui<span class="op">.</span><span class="at">Chart</span><span class="op">.</span><span class="at">image</span><span class="op">.</span><span class="fu">histogram</span>(imageEdge<span class="op">,</span> bounds<span class="op">,</span> scale<span class="op">,</span> buckets))<span class="op">;</span></span>
<span id="cb13-150"><a href="#cb13-150" tabindex="-1"></a>        <span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(mask<span class="op">.</span><span class="fu">mask</span>(mask)<span class="op">,</span> {<span class="dt">palette</span><span class="op">:</span>[<span class="st">&#39;000000&#39;</span>]}<span class="op">,</span> <span class="st">&#39;image mask&#39;</span><span class="op">,</span> <span class="kw">false</span>)<span class="op">;</span></span>
<span id="cb13-151"><a href="#cb13-151" tabindex="-1"></a>    }</span>
<span id="cb13-152"><a href="#cb13-152" tabindex="-1"></a></span>
<span id="cb13-153"><a href="#cb13-153" tabindex="-1"></a>    <span class="cf">return</span> minValue <span class="op">!==</span> <span class="st">&#39;undefined&#39;</span> <span class="op">?</span> threshold<span class="op">.</span><span class="fu">max</span>(minValue) <span class="op">:</span> threshold<span class="op">;</span></span>
<span id="cb13-154"><a href="#cb13-154" tabindex="-1"></a>}</span>
<span id="cb13-155"><a href="#cb13-155" tabindex="-1"></a></span>
<span id="cb13-156"><a href="#cb13-156" tabindex="-1"></a><span class="kw">function</span> <span class="fu">otsu</span>(histogram) {</span>
<span id="cb13-157"><a href="#cb13-157" tabindex="-1"></a>    histogram <span class="op">=</span> ee<span class="op">.</span><span class="fu">Dictionary</span>(histogram)<span class="op">;</span></span>
<span id="cb13-158"><a href="#cb13-158" tabindex="-1"></a></span>
<span id="cb13-159"><a href="#cb13-159" tabindex="-1"></a>    <span class="kw">var</span> counts <span class="op">=</span> ee<span class="op">.</span><span class="fu">Array</span>(histogram<span class="op">.</span><span class="fu">get</span>(<span class="st">&#39;histogram&#39;</span>))<span class="op">;</span></span>
<span id="cb13-160"><a href="#cb13-160" tabindex="-1"></a>    <span class="kw">var</span> means <span class="op">=</span> ee<span class="op">.</span><span class="fu">Array</span>(histogram<span class="op">.</span><span class="fu">get</span>(<span class="st">&#39;bucketMeans&#39;</span>))<span class="op">;</span></span>
<span id="cb13-161"><a href="#cb13-161" tabindex="-1"></a>    <span class="kw">var</span> size <span class="op">=</span> means<span class="op">.</span><span class="fu">length</span>()<span class="op">.</span><span class="fu">get</span>([<span class="dv">0</span>])<span class="op">;</span></span>
<span id="cb13-162"><a href="#cb13-162" tabindex="-1"></a>    <span class="kw">var</span> total <span class="op">=</span> counts<span class="op">.</span><span class="fu">reduce</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">sum</span>()<span class="op">,</span> [<span class="dv">0</span>])<span class="op">.</span><span class="fu">get</span>([<span class="dv">0</span>])<span class="op">;</span></span>
<span id="cb13-163"><a href="#cb13-163" tabindex="-1"></a>    <span class="kw">var</span> sum <span class="op">=</span> means<span class="op">.</span><span class="fu">multiply</span>(counts)<span class="op">.</span><span class="fu">reduce</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">sum</span>()<span class="op">,</span> [<span class="dv">0</span>])<span class="op">.</span><span class="fu">get</span>([<span class="dv">0</span>])<span class="op">;</span></span>
<span id="cb13-164"><a href="#cb13-164" tabindex="-1"></a>    <span class="kw">var</span> mean <span class="op">=</span> sum<span class="op">.</span><span class="fu">divide</span>(total)<span class="op">;</span></span>
<span id="cb13-165"><a href="#cb13-165" tabindex="-1"></a></span>
<span id="cb13-166"><a href="#cb13-166" tabindex="-1"></a>    <span class="kw">var</span> indices <span class="op">=</span> ee<span class="op">.</span><span class="at">List</span><span class="op">.</span><span class="fu">sequence</span>(<span class="dv">1</span><span class="op">,</span> size)<span class="op">;</span></span>
<span id="cb13-167"><a href="#cb13-167" tabindex="-1"></a></span>
<span id="cb13-168"><a href="#cb13-168" tabindex="-1"></a>    <span class="co">// Compute between sum of squares, where each mean partitions the data.</span></span>
<span id="cb13-169"><a href="#cb13-169" tabindex="-1"></a>    <span class="kw">var</span> bss <span class="op">=</span> indices<span class="op">.</span><span class="fu">map</span>(<span class="kw">function</span>(i) {</span>
<span id="cb13-170"><a href="#cb13-170" tabindex="-1"></a>        <span class="kw">var</span> aCounts <span class="op">=</span> counts<span class="op">.</span><span class="fu">slice</span>(<span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> i)<span class="op">;</span></span>
<span id="cb13-171"><a href="#cb13-171" tabindex="-1"></a>        <span class="kw">var</span> aCount <span class="op">=</span> aCounts<span class="op">.</span><span class="fu">reduce</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">sum</span>()<span class="op">,</span> [<span class="dv">0</span>])<span class="op">.</span><span class="fu">get</span>([<span class="dv">0</span>])<span class="op">;</span></span>
<span id="cb13-172"><a href="#cb13-172" tabindex="-1"></a>        <span class="kw">var</span> aMeans <span class="op">=</span> means<span class="op">.</span><span class="fu">slice</span>(<span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> i)<span class="op">;</span></span>
<span id="cb13-173"><a href="#cb13-173" tabindex="-1"></a>        <span class="kw">var</span> aMean <span class="op">=</span> aMeans<span class="op">.</span><span class="fu">multiply</span>(aCounts)</span>
<span id="cb13-174"><a href="#cb13-174" tabindex="-1"></a>            <span class="op">.</span><span class="fu">reduce</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">sum</span>()<span class="op">,</span> [<span class="dv">0</span>])<span class="op">.</span><span class="fu">get</span>([<span class="dv">0</span>])</span>
<span id="cb13-175"><a href="#cb13-175" tabindex="-1"></a>            <span class="op">.</span><span class="fu">divide</span>(aCount)<span class="op">;</span></span>
<span id="cb13-176"><a href="#cb13-176" tabindex="-1"></a>        <span class="kw">var</span> bCount <span class="op">=</span> total<span class="op">.</span><span class="fu">subtract</span>(aCount)<span class="op">;</span></span>
<span id="cb13-177"><a href="#cb13-177" tabindex="-1"></a>        <span class="kw">var</span> bMean <span class="op">=</span> sum<span class="op">.</span><span class="fu">subtract</span>(aCount<span class="op">.</span><span class="fu">multiply</span>(aMean))<span class="op">.</span><span class="fu">divide</span>(bCount)<span class="op">;</span></span>
<span id="cb13-178"><a href="#cb13-178" tabindex="-1"></a>        <span class="cf">return</span> aCount<span class="op">.</span><span class="fu">multiply</span>(aMean<span class="op">.</span><span class="fu">subtract</span>(mean)<span class="op">.</span><span class="fu">pow</span>(<span class="dv">2</span>))<span class="op">.</span><span class="fu">add</span>(</span>
<span id="cb13-179"><a href="#cb13-179" tabindex="-1"></a>            bCount<span class="op">.</span><span class="fu">multiply</span>(bMean<span class="op">.</span><span class="fu">subtract</span>(mean)<span class="op">.</span><span class="fu">pow</span>(<span class="dv">2</span>)))<span class="op">;</span></span>
<span id="cb13-180"><a href="#cb13-180" tabindex="-1"></a>    })<span class="op">;</span></span>
<span id="cb13-181"><a href="#cb13-181" tabindex="-1"></a></span>
<span id="cb13-182"><a href="#cb13-182" tabindex="-1"></a>    <span class="co">// Return the mean value corresponding to the maximum BSS.</span></span>
<span id="cb13-183"><a href="#cb13-183" tabindex="-1"></a>    <span class="cf">return</span> means<span class="op">.</span><span class="fu">sort</span>(bss)<span class="op">.</span><span class="fu">get</span>([<span class="op">-</span><span class="dv">1</span>])<span class="op">;</span></span>
<span id="cb13-184"><a href="#cb13-184" tabindex="-1"></a>}<span class="op">;</span></span></code></pre></div>
</div>
<div id="smoothing-vectors" class="section level2">
<h2>Smoothing Vectors</h2>
<p><a
href="https://code.earthengine.google.com/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3ASupplement%2FSurface_Water%2FSmoothing_Vectors"
target="_blank">Open in Code Editor ↗</a></p>
<div class="sourceCode" id="cb14"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb14-1"><a href="#cb14-1" tabindex="-1"></a><span class="kw">var</span> gsw <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(<span class="st">&quot;JRC/GSW1_3/GlobalSurfaceWater&quot;</span>)<span class="op">;</span></span>
<span id="cb14-2"><a href="#cb14-2" tabindex="-1"></a><span class="kw">var</span> hydrobasins <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">&quot;WWF/HydroSHEDS/v1/Basins/hybas_7&quot;</span>)<span class="op">;</span></span>
<span id="cb14-3"><a href="#cb14-3" tabindex="-1"></a><span class="kw">var</span> basin <span class="op">=</span> hydrobasins<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;HYBAS_ID&#39;</span><span class="op">,</span> <span class="dv">4071139640</span>))</span>
<span id="cb14-4"><a href="#cb14-4" tabindex="-1"></a><span class="kw">var</span> geometry <span class="op">=</span> basin<span class="op">.</span><span class="fu">geometry</span>()</span>
<span id="cb14-5"><a href="#cb14-5" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">centerObject</span>(geometry<span class="op">,</span> <span class="dv">10</span>)</span>
<span id="cb14-6"><a href="#cb14-6" tabindex="-1"></a></span>
<span id="cb14-7"><a href="#cb14-7" tabindex="-1"></a><span class="kw">var</span> water <span class="op">=</span> gsw<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;max_extent&#39;</span>)<span class="op">;</span></span>
<span id="cb14-8"><a href="#cb14-8" tabindex="-1"></a></span>
<span id="cb14-9"><a href="#cb14-9" tabindex="-1"></a><span class="kw">var</span> clipped <span class="op">=</span> water<span class="op">.</span><span class="fu">clip</span>(geometry)</span>
<span id="cb14-10"><a href="#cb14-10" tabindex="-1"></a></span>
<span id="cb14-11"><a href="#cb14-11" tabindex="-1"></a><span class="kw">var</span> visParams <span class="op">=</span> {<span class="dt">min</span><span class="op">:</span><span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span><span class="dv">1</span><span class="op">,</span> <span class="dt">palette</span><span class="op">:</span> [<span class="st">&#39;white&#39;</span><span class="op">,</span><span class="st">&#39;blue&#39;</span>]}</span>
<span id="cb14-12"><a href="#cb14-12" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(clipped<span class="op">,</span> visParams<span class="op">,</span> <span class="st">&#39;Surface Water&#39;</span><span class="op">,</span> <span class="kw">false</span>) </span>
<span id="cb14-13"><a href="#cb14-13" tabindex="-1"></a></span>
<span id="cb14-14"><a href="#cb14-14" tabindex="-1"></a><span class="co">// Do unmask() to replace masked pixels with 0</span></span>
<span id="cb14-15"><a href="#cb14-15" tabindex="-1"></a><span class="co">// This avoids extra pixels along the edges</span></span>
<span id="cb14-16"><a href="#cb14-16" tabindex="-1"></a><span class="kw">var</span> clipped <span class="op">=</span> clipped<span class="op">.</span><span class="fu">unmask</span>(<span class="dv">0</span>)</span>
<span id="cb14-17"><a href="#cb14-17" tabindex="-1"></a><span class="co">// Perform a morphological closing to fill holes in waterbodies</span></span>
<span id="cb14-18"><a href="#cb14-18" tabindex="-1"></a><span class="kw">var</span> waterProcessed <span class="op">=</span> clipped</span>
<span id="cb14-19"><a href="#cb14-19" tabindex="-1"></a>  <span class="op">.</span><span class="fu">focal_max</span>({</span>
<span id="cb14-20"><a href="#cb14-20" tabindex="-1"></a>    <span class="st">&#39;radius&#39;</span><span class="op">:</span><span class="dv">30</span><span class="op">,</span></span>
<span id="cb14-21"><a href="#cb14-21" tabindex="-1"></a>    <span class="st">&#39;units&#39;</span><span class="op">:</span> <span class="st">&#39;meters&#39;</span><span class="op">,</span></span>
<span id="cb14-22"><a href="#cb14-22" tabindex="-1"></a>    <span class="st">&#39;kernelType&#39;</span><span class="op">:</span> <span class="st">&#39;square&#39;</span>})</span>
<span id="cb14-23"><a href="#cb14-23" tabindex="-1"></a>  <span class="op">.</span><span class="fu">focal_min</span>({</span>
<span id="cb14-24"><a href="#cb14-24" tabindex="-1"></a>    <span class="st">&#39;radius&#39;</span><span class="op">:</span><span class="dv">30</span><span class="op">,</span></span>
<span id="cb14-25"><a href="#cb14-25" tabindex="-1"></a>    <span class="st">&#39;units&#39;</span><span class="op">:</span> <span class="st">&#39;meters&#39;</span><span class="op">,</span></span>
<span id="cb14-26"><a href="#cb14-26" tabindex="-1"></a>    <span class="st">&#39;kernelType&#39;</span><span class="op">:</span> <span class="st">&#39;square&#39;</span>})<span class="op">;</span></span>
<span id="cb14-27"><a href="#cb14-27" tabindex="-1"></a>    </span>
<span id="cb14-28"><a href="#cb14-28" tabindex="-1"></a><span class="kw">var</span> waterProcessed <span class="op">=</span> waterProcessed<span class="op">.</span><span class="fu">resample</span>(<span class="st">&#39;bicubic&#39;</span>)</span>
<span id="cb14-29"><a href="#cb14-29" tabindex="-1"></a></span>
<span id="cb14-30"><a href="#cb14-30" tabindex="-1"></a><span class="kw">var</span> vector <span class="op">=</span> waterProcessed<span class="op">.</span><span class="fu">reduceToVectors</span>({</span>
<span id="cb14-31"><a href="#cb14-31" tabindex="-1"></a>  <span class="dt">reducer</span><span class="op">:</span> ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">countEvery</span>()<span class="op">,</span></span>
<span id="cb14-32"><a href="#cb14-32" tabindex="-1"></a>  <span class="dt">geometry</span><span class="op">:</span> geometry<span class="op">,</span></span>
<span id="cb14-33"><a href="#cb14-33" tabindex="-1"></a>  <span class="dt">scale</span><span class="op">:</span> <span class="dv">10</span><span class="op">,</span></span>
<span id="cb14-34"><a href="#cb14-34" tabindex="-1"></a>  <span class="dt">maxPixels</span><span class="op">:</span> <span class="fl">1e10</span><span class="op">,</span></span>
<span id="cb14-35"><a href="#cb14-35" tabindex="-1"></a>  <span class="dt">eightConnected</span><span class="op">:</span> <span class="kw">false</span></span>
<span id="cb14-36"><a href="#cb14-36" tabindex="-1"></a>})</span>
<span id="cb14-37"><a href="#cb14-37" tabindex="-1"></a><span class="kw">var</span> filtered <span class="op">=</span> vector<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;label&#39;</span><span class="op">,</span> <span class="dv">1</span>))</span>
<span id="cb14-38"><a href="#cb14-38" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(filtered<span class="op">,</span> {<span class="dt">color</span><span class="op">:</span><span class="st">&#39;purple&#39;</span>}<span class="op">,</span> <span class="st">&#39;Surface Water Polygons&#39;</span>)</span></code></pre></div>
</div>
<div id="surface-water-explorer-split-panel-app" class="section level2">
<h2>Surface Water Explorer Split Panel App</h2>
<p><a
href="https://code.earthengine.google.com/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3ASupplement%2FSurface_Water%2FSurface_Water_Explorer_Split_Panel_App"
target="_blank">Open in Code Editor ↗</a></p>
<div class="sourceCode" id="cb15"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb15-1"><a href="#cb15-1" tabindex="-1"></a><span class="kw">var</span> admin2 <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">&quot;FAO/GAUL_SIMPLIFIED_500m/2015/level2&quot;</span>)<span class="op">;</span></span>
<span id="cb15-2"><a href="#cb15-2" tabindex="-1"></a><span class="kw">var</span> gswYearly <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&quot;JRC/GSW1_3/YearlyHistory&quot;</span>)<span class="op">;</span></span>
<span id="cb15-3"><a href="#cb15-3" tabindex="-1"></a><span class="co">// Panels are the main container widgets</span></span>
<span id="cb15-4"><a href="#cb15-4" tabindex="-1"></a><span class="kw">var</span> mainPanel <span class="op">=</span> ui<span class="op">.</span><span class="fu">Panel</span>({</span>
<span id="cb15-5"><a href="#cb15-5" tabindex="-1"></a>  <span class="dt">style</span><span class="op">:</span> {<span class="dt">width</span><span class="op">:</span> <span class="st">&#39;300px&#39;</span>}</span>
<span id="cb15-6"><a href="#cb15-6" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb15-7"><a href="#cb15-7" tabindex="-1"></a></span>
<span id="cb15-8"><a href="#cb15-8" tabindex="-1"></a></span>
<span id="cb15-9"><a href="#cb15-9" tabindex="-1"></a><span class="kw">var</span> title <span class="op">=</span> ui<span class="op">.</span><span class="fu">Label</span>({</span>
<span id="cb15-10"><a href="#cb15-10" tabindex="-1"></a>  <span class="dt">value</span><span class="op">:</span> <span class="st">&#39;Surface Water Explorer&#39;</span><span class="op">,</span></span>
<span id="cb15-11"><a href="#cb15-11" tabindex="-1"></a>  <span class="dt">style</span><span class="op">:</span> {<span class="st">&#39;fontSize&#39;</span><span class="op">:</span> <span class="st">&#39;24px&#39;</span>}</span>
<span id="cb15-12"><a href="#cb15-12" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb15-13"><a href="#cb15-13" tabindex="-1"></a><span class="co">// You can add widgets to the panel</span></span>
<span id="cb15-14"><a href="#cb15-14" tabindex="-1"></a>mainPanel<span class="op">.</span><span class="fu">add</span>(title)</span>
<span id="cb15-15"><a href="#cb15-15" tabindex="-1"></a></span>
<span id="cb15-16"><a href="#cb15-16" tabindex="-1"></a><span class="co">// You can even add panels to other panels</span></span>
<span id="cb15-17"><a href="#cb15-17" tabindex="-1"></a><span class="kw">var</span> admin2Panel <span class="op">=</span> ui<span class="op">.</span><span class="fu">Panel</span>()</span>
<span id="cb15-18"><a href="#cb15-18" tabindex="-1"></a>mainPanel<span class="op">.</span><span class="fu">add</span>(admin2Panel)<span class="op">;</span></span>
<span id="cb15-19"><a href="#cb15-19" tabindex="-1"></a></span>
<span id="cb15-20"><a href="#cb15-20" tabindex="-1"></a><span class="co">// Let&#39;s add a dropdown with the names of admin2 regions</span></span>
<span id="cb15-21"><a href="#cb15-21" tabindex="-1"></a><span class="co">// We need to get all admin2 names and creat a ui.Select object</span></span>
<span id="cb15-22"><a href="#cb15-22" tabindex="-1"></a><span class="kw">var</span> filtered <span class="op">=</span> admin2<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;ADM1_NAME&#39;</span><span class="op">,</span> <span class="st">&#39;Karnataka&#39;</span>))</span>
<span id="cb15-23"><a href="#cb15-23" tabindex="-1"></a><span class="kw">var</span> admin2Names <span class="op">=</span> filtered<span class="op">.</span><span class="fu">aggregate_array</span>(<span class="st">&#39;ADM2_NAME&#39;</span>)</span>
<span id="cb15-24"><a href="#cb15-24" tabindex="-1"></a></span>
<span id="cb15-25"><a href="#cb15-25" tabindex="-1"></a><span class="co">// We define a function that will be called when the user selects a value</span></span>
<span id="cb15-26"><a href="#cb15-26" tabindex="-1"></a>admin2Names<span class="op">.</span><span class="fu">evaluate</span>(<span class="kw">function</span>(names){</span>
<span id="cb15-27"><a href="#cb15-27" tabindex="-1"></a>  <span class="kw">var</span> dropDown <span class="op">=</span> ui<span class="op">.</span><span class="fu">Select</span>({</span>
<span id="cb15-28"><a href="#cb15-28" tabindex="-1"></a>    <span class="dt">placeholder</span><span class="op">:</span> <span class="st">&#39;select a region&#39;</span><span class="op">,</span></span>
<span id="cb15-29"><a href="#cb15-29" tabindex="-1"></a>    <span class="dt">items</span><span class="op">:</span> names<span class="op">,</span></span>
<span id="cb15-30"><a href="#cb15-30" tabindex="-1"></a>    <span class="dt">onChange</span><span class="op">:</span> display</span>
<span id="cb15-31"><a href="#cb15-31" tabindex="-1"></a>  })</span>
<span id="cb15-32"><a href="#cb15-32" tabindex="-1"></a>  admin2Panel<span class="op">.</span><span class="fu">add</span>(dropDown)</span>
<span id="cb15-33"><a href="#cb15-33" tabindex="-1"></a>})</span>
<span id="cb15-34"><a href="#cb15-34" tabindex="-1"></a></span>
<span id="cb15-35"><a href="#cb15-35" tabindex="-1"></a><span class="kw">var</span> resultPanel <span class="op">=</span> ui<span class="op">.</span><span class="fu">Panel</span>()<span class="op">;</span></span>
<span id="cb15-36"><a href="#cb15-36" tabindex="-1"></a></span>
<span id="cb15-37"><a href="#cb15-37" tabindex="-1"></a><span class="kw">var</span> areaLabel1 <span class="op">=</span> ui<span class="op">.</span><span class="fu">Label</span>()</span>
<span id="cb15-38"><a href="#cb15-38" tabindex="-1"></a><span class="kw">var</span> areaLabel2 <span class="op">=</span> ui<span class="op">.</span><span class="fu">Label</span>()</span>
<span id="cb15-39"><a href="#cb15-39" tabindex="-1"></a></span>
<span id="cb15-40"><a href="#cb15-40" tabindex="-1"></a>resultPanel<span class="op">.</span><span class="fu">add</span>(areaLabel1)</span>
<span id="cb15-41"><a href="#cb15-41" tabindex="-1"></a>resultPanel<span class="op">.</span><span class="fu">add</span>(areaLabel2)</span>
<span id="cb15-42"><a href="#cb15-42" tabindex="-1"></a></span>
<span id="cb15-43"><a href="#cb15-43" tabindex="-1"></a>mainPanel<span class="op">.</span><span class="fu">add</span>(resultPanel)<span class="op">;</span></span>
<span id="cb15-44"><a href="#cb15-44" tabindex="-1"></a></span>
<span id="cb15-45"><a href="#cb15-45" tabindex="-1"></a><span class="co">// This function will be called when the user changes the value in the dropdown</span></span>
<span id="cb15-46"><a href="#cb15-46" tabindex="-1"></a><span class="kw">var</span> display <span class="op">=</span> <span class="kw">function</span>(admin2Name) {</span>
<span id="cb15-47"><a href="#cb15-47" tabindex="-1"></a>  areaLabel1<span class="op">.</span><span class="fu">setValue</span>(<span class="st">&#39;&#39;</span>)</span>
<span id="cb15-48"><a href="#cb15-48" tabindex="-1"></a>  areaLabel2<span class="op">.</span><span class="fu">setValue</span>(<span class="st">&#39;&#39;</span>)</span>
<span id="cb15-49"><a href="#cb15-49" tabindex="-1"></a></span>
<span id="cb15-50"><a href="#cb15-50" tabindex="-1"></a>  <span class="kw">var</span> selected <span class="op">=</span> ee<span class="op">.</span><span class="fu">Feature</span>(</span>
<span id="cb15-51"><a href="#cb15-51" tabindex="-1"></a>    filtered<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;ADM2_NAME&#39;</span><span class="op">,</span> admin2Name))<span class="op">.</span><span class="fu">first</span>())</span>
<span id="cb15-52"><a href="#cb15-52" tabindex="-1"></a>  <span class="kw">var</span> geometry <span class="op">=</span> selected<span class="op">.</span><span class="fu">geometry</span>()</span>
<span id="cb15-53"><a href="#cb15-53" tabindex="-1"></a>  leftMap<span class="op">.</span><span class="fu">layers</span>()<span class="op">.</span><span class="fu">reset</span>()</span>
<span id="cb15-54"><a href="#cb15-54" tabindex="-1"></a>  rightMap<span class="op">.</span><span class="fu">layers</span>()<span class="op">.</span><span class="fu">reset</span>()</span>
<span id="cb15-55"><a href="#cb15-55" tabindex="-1"></a>  leftMap<span class="op">.</span><span class="fu">addLayer</span>(geometry<span class="op">,</span> {<span class="dt">color</span><span class="op">:</span> <span class="st">&#39;grey&#39;</span>}<span class="op">,</span> admin2Name)</span>
<span id="cb15-56"><a href="#cb15-56" tabindex="-1"></a>  rightMap<span class="op">.</span><span class="fu">addLayer</span>(geometry<span class="op">,</span> {<span class="dt">color</span><span class="op">:</span> <span class="st">&#39;grey&#39;</span>}<span class="op">,</span> admin2Name)</span>
<span id="cb15-57"><a href="#cb15-57" tabindex="-1"></a></span>
<span id="cb15-58"><a href="#cb15-58" tabindex="-1"></a>  leftMap<span class="op">.</span><span class="fu">centerObject</span>(geometry<span class="op">,</span> <span class="dv">10</span>)</span>
<span id="cb15-59"><a href="#cb15-59" tabindex="-1"></a>  <span class="kw">var</span> visParams <span class="op">=</span> {<span class="dt">min</span><span class="op">:</span><span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span><span class="dv">1</span><span class="op">,</span> <span class="dt">palette</span><span class="op">:</span> [<span class="st">&#39;white&#39;</span><span class="op">,</span><span class="st">&#39;blue&#39;</span>]}</span>
<span id="cb15-60"><a href="#cb15-60" tabindex="-1"></a></span>
<span id="cb15-61"><a href="#cb15-61" tabindex="-1"></a>  <span class="kw">var</span> gswYearFiltered <span class="op">=</span> gswYearly<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;year&#39;</span><span class="op">,</span> <span class="dv">2010</span>))</span>
<span id="cb15-62"><a href="#cb15-62" tabindex="-1"></a>  <span class="kw">var</span> gsw2010 <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(gswYearFiltered<span class="op">.</span><span class="fu">first</span>())<span class="op">.</span><span class="fu">clip</span>(geometry)</span>
<span id="cb15-63"><a href="#cb15-63" tabindex="-1"></a>  <span class="kw">var</span> water2010 <span class="op">=</span> gsw2010<span class="op">.</span><span class="fu">eq</span>(<span class="dv">2</span>)<span class="op">.</span><span class="fu">or</span>(gsw2010<span class="op">.</span><span class="fu">eq</span>(<span class="dv">3</span>))<span class="op">.</span><span class="fu">rename</span>(<span class="st">&#39;water&#39;</span>)<span class="op">.</span><span class="fu">selfMask</span>()</span>
<span id="cb15-64"><a href="#cb15-64" tabindex="-1"></a>  </span>
<span id="cb15-65"><a href="#cb15-65" tabindex="-1"></a>  leftMap<span class="op">.</span><span class="fu">addLayer</span>(water2010<span class="op">,</span> visParams<span class="op">,</span> <span class="st">&#39;2010 Water&#39;</span>)</span>
<span id="cb15-66"><a href="#cb15-66" tabindex="-1"></a>  </span>
<span id="cb15-67"><a href="#cb15-67" tabindex="-1"></a>  <span class="kw">var</span> gswYearFiltered <span class="op">=</span> gswYearly<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;year&#39;</span><span class="op">,</span> <span class="dv">2020</span>))</span>
<span id="cb15-68"><a href="#cb15-68" tabindex="-1"></a>  <span class="kw">var</span> gsw2020 <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(gswYearFiltered<span class="op">.</span><span class="fu">first</span>())<span class="op">.</span><span class="fu">clip</span>(geometry)</span>
<span id="cb15-69"><a href="#cb15-69" tabindex="-1"></a>  <span class="kw">var</span> water2020 <span class="op">=</span> gsw2020<span class="op">.</span><span class="fu">eq</span>(<span class="dv">2</span>)<span class="op">.</span><span class="fu">or</span>(gsw2020<span class="op">.</span><span class="fu">eq</span>(<span class="dv">3</span>))<span class="op">.</span><span class="fu">rename</span>(<span class="st">&#39;water&#39;</span>)<span class="op">.</span><span class="fu">selfMask</span>()</span>
<span id="cb15-70"><a href="#cb15-70" tabindex="-1"></a>  </span>
<span id="cb15-71"><a href="#cb15-71" tabindex="-1"></a>  rightMap<span class="op">.</span><span class="fu">addLayer</span>(water2020<span class="op">,</span> visParams<span class="op">,</span> <span class="st">&#39;2020 Water&#39;</span>)</span>
<span id="cb15-72"><a href="#cb15-72" tabindex="-1"></a>  </span>
<span id="cb15-73"><a href="#cb15-73" tabindex="-1"></a>   <span class="kw">var</span> area2010 <span class="op">=</span> water2010<span class="op">.</span><span class="fu">multiply</span>(ee<span class="op">.</span><span class="at">Image</span><span class="op">.</span><span class="fu">pixelArea</span>())<span class="op">.</span><span class="fu">reduceRegion</span>({</span>
<span id="cb15-74"><a href="#cb15-74" tabindex="-1"></a>    <span class="dt">reducer</span><span class="op">:</span> ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">sum</span>()<span class="op">,</span></span>
<span id="cb15-75"><a href="#cb15-75" tabindex="-1"></a>    <span class="dt">geometry</span><span class="op">:</span> geometry<span class="op">,</span></span>
<span id="cb15-76"><a href="#cb15-76" tabindex="-1"></a>    <span class="dt">scale</span><span class="op">:</span> <span class="dv">30</span><span class="op">,</span></span>
<span id="cb15-77"><a href="#cb15-77" tabindex="-1"></a>    <span class="dt">maxPixels</span><span class="op">:</span> <span class="fl">1e9</span></span>
<span id="cb15-78"><a href="#cb15-78" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb15-79"><a href="#cb15-79" tabindex="-1"></a>  </span>
<span id="cb15-80"><a href="#cb15-80" tabindex="-1"></a>  <span class="kw">var</span> waterArea2010 <span class="op">=</span> ee<span class="op">.</span><span class="fu">Number</span>(area2010<span class="op">.</span><span class="fu">get</span>(<span class="st">&#39;water&#39;</span>))<span class="op">.</span><span class="fu">divide</span>(<span class="dv">10000</span>)<span class="op">.</span><span class="fu">round</span>()<span class="op">;</span></span>
<span id="cb15-81"><a href="#cb15-81" tabindex="-1"></a>  waterArea2010<span class="op">.</span><span class="fu">evaluate</span>(<span class="kw">function</span>(result) {</span>
<span id="cb15-82"><a href="#cb15-82" tabindex="-1"></a>    <span class="kw">var</span> text <span class="op">=</span> <span class="st">&#39;Surface Water Area 2010: &#39;</span> <span class="op">+</span> result <span class="op">+</span> <span class="st">&#39; Hectares&#39;</span></span>
<span id="cb15-83"><a href="#cb15-83" tabindex="-1"></a>    areaLabel1<span class="op">.</span><span class="fu">setValue</span>(text)</span>
<span id="cb15-84"><a href="#cb15-84" tabindex="-1"></a>  })</span>
<span id="cb15-85"><a href="#cb15-85" tabindex="-1"></a>  </span>
<span id="cb15-86"><a href="#cb15-86" tabindex="-1"></a>  <span class="kw">var</span> area2020 <span class="op">=</span> water2020<span class="op">.</span><span class="fu">multiply</span>(ee<span class="op">.</span><span class="at">Image</span><span class="op">.</span><span class="fu">pixelArea</span>())<span class="op">.</span><span class="fu">reduceRegion</span>({</span>
<span id="cb15-87"><a href="#cb15-87" tabindex="-1"></a>    <span class="dt">reducer</span><span class="op">:</span> ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">sum</span>()<span class="op">,</span></span>
<span id="cb15-88"><a href="#cb15-88" tabindex="-1"></a>    <span class="dt">geometry</span><span class="op">:</span> geometry<span class="op">,</span></span>
<span id="cb15-89"><a href="#cb15-89" tabindex="-1"></a>    <span class="dt">scale</span><span class="op">:</span> <span class="dv">30</span><span class="op">,</span></span>
<span id="cb15-90"><a href="#cb15-90" tabindex="-1"></a>    <span class="dt">maxPixels</span><span class="op">:</span> <span class="fl">1e9</span></span>
<span id="cb15-91"><a href="#cb15-91" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb15-92"><a href="#cb15-92" tabindex="-1"></a>  </span>
<span id="cb15-93"><a href="#cb15-93" tabindex="-1"></a>  <span class="kw">var</span> waterArea2020 <span class="op">=</span> ee<span class="op">.</span><span class="fu">Number</span>(area2020<span class="op">.</span><span class="fu">get</span>(<span class="st">&#39;water&#39;</span>))<span class="op">.</span><span class="fu">divide</span>(<span class="dv">10000</span>)<span class="op">.</span><span class="fu">round</span>()<span class="op">;</span></span>
<span id="cb15-94"><a href="#cb15-94" tabindex="-1"></a>  waterArea2020<span class="op">.</span><span class="fu">evaluate</span>(<span class="kw">function</span>(result) {</span>
<span id="cb15-95"><a href="#cb15-95" tabindex="-1"></a>    <span class="kw">var</span> text <span class="op">=</span> <span class="st">&#39;Surface Water Area 2020: &#39;</span> <span class="op">+</span> result <span class="op">+</span> <span class="st">&#39; Hectares&#39;</span></span>
<span id="cb15-96"><a href="#cb15-96" tabindex="-1"></a>    areaLabel2<span class="op">.</span><span class="fu">setValue</span>(text)</span>
<span id="cb15-97"><a href="#cb15-97" tabindex="-1"></a>  })</span>
<span id="cb15-98"><a href="#cb15-98" tabindex="-1"></a>}</span>
<span id="cb15-99"><a href="#cb15-99" tabindex="-1"></a></span>
<span id="cb15-100"><a href="#cb15-100" tabindex="-1"></a></span>
<span id="cb15-101"><a href="#cb15-101" tabindex="-1"></a><span class="co">// Create two maps.</span></span>
<span id="cb15-102"><a href="#cb15-102" tabindex="-1"></a><span class="kw">var</span> center <span class="op">=</span> {<span class="dt">lon</span><span class="op">:</span> <span class="fl">76.43</span><span class="op">,</span> <span class="dt">lat</span><span class="op">:</span> <span class="fl">12.41</span><span class="op">,</span> <span class="dt">zoom</span><span class="op">:</span> <span class="dv">8</span>}<span class="op">;</span></span>
<span id="cb15-103"><a href="#cb15-103" tabindex="-1"></a></span>
<span id="cb15-104"><a href="#cb15-104" tabindex="-1"></a><span class="kw">var</span> leftMap <span class="op">=</span> ui<span class="op">.</span><span class="fu">Map</span>(center)<span class="op">;</span></span>
<span id="cb15-105"><a href="#cb15-105" tabindex="-1"></a><span class="kw">var</span> rightMap <span class="op">=</span> ui<span class="op">.</span><span class="fu">Map</span>(center)<span class="op">;</span></span>
<span id="cb15-106"><a href="#cb15-106" tabindex="-1"></a></span>
<span id="cb15-107"><a href="#cb15-107" tabindex="-1"></a><span class="co">// Link them together.</span></span>
<span id="cb15-108"><a href="#cb15-108" tabindex="-1"></a><span class="kw">var</span> linker <span class="op">=</span> <span class="kw">new</span> ui<span class="op">.</span><span class="at">Map</span><span class="op">.</span><span class="fu">Linker</span>([leftMap<span class="op">,</span> rightMap])<span class="op">;</span></span>
<span id="cb15-109"><a href="#cb15-109" tabindex="-1"></a></span>
<span id="cb15-110"><a href="#cb15-110" tabindex="-1"></a><span class="co">// Create a split panel with the two maps.</span></span>
<span id="cb15-111"><a href="#cb15-111" tabindex="-1"></a><span class="kw">var</span> splitPanel <span class="op">=</span> ui<span class="op">.</span><span class="fu">SplitPanel</span>({</span>
<span id="cb15-112"><a href="#cb15-112" tabindex="-1"></a>  <span class="dt">firstPanel</span><span class="op">:</span> leftMap<span class="op">,</span></span>
<span id="cb15-113"><a href="#cb15-113" tabindex="-1"></a>  <span class="dt">secondPanel</span><span class="op">:</span> rightMap<span class="op">,</span></span>
<span id="cb15-114"><a href="#cb15-114" tabindex="-1"></a>  <span class="dt">orientation</span><span class="op">:</span> <span class="st">&#39;horizontal&#39;</span><span class="op">,</span></span>
<span id="cb15-115"><a href="#cb15-115" tabindex="-1"></a>  <span class="dt">wipe</span><span class="op">:</span> <span class="kw">true</span></span>
<span id="cb15-116"><a href="#cb15-116" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb15-117"><a href="#cb15-117" tabindex="-1"></a></span>
<span id="cb15-118"><a href="#cb15-118" tabindex="-1"></a><span class="kw">var</span> yearLabel1 <span class="op">=</span> ui<span class="op">.</span><span class="fu">Label</span>({<span class="dt">value</span><span class="op">:</span> <span class="st">&#39;2010&#39;</span><span class="op">,</span></span>
<span id="cb15-119"><a href="#cb15-119" tabindex="-1"></a>  <span class="dt">style</span><span class="op">:</span> {<span class="st">&#39;fontSize&#39;</span><span class="op">:</span> <span class="st">&#39;20px&#39;</span><span class="op">,</span> <span class="dt">backgroundColor</span><span class="op">:</span> <span class="st">&#39;#f7f7f7&#39;</span><span class="op">,</span> <span class="dt">position</span><span class="op">:</span><span class="st">&#39;top-left&#39;</span>}})<span class="op">;</span></span>
<span id="cb15-120"><a href="#cb15-120" tabindex="-1"></a><span class="kw">var</span> yearLabel2 <span class="op">=</span> ui<span class="op">.</span><span class="fu">Label</span>({<span class="dt">value</span><span class="op">:</span> <span class="st">&#39;2020&#39;</span><span class="op">,</span></span>
<span id="cb15-121"><a href="#cb15-121" tabindex="-1"></a>  <span class="dt">style</span><span class="op">:</span> {<span class="st">&#39;fontSize&#39;</span><span class="op">:</span> <span class="st">&#39;20px&#39;</span><span class="op">,</span> <span class="dt">backgroundColor</span><span class="op">:</span> <span class="st">&#39;#f7f7f7&#39;</span><span class="op">,</span> <span class="dt">position</span><span class="op">:</span><span class="st">&#39;top-right&#39;</span>}})<span class="op">;</span></span>
<span id="cb15-122"><a href="#cb15-122" tabindex="-1"></a></span>
<span id="cb15-123"><a href="#cb15-123" tabindex="-1"></a>leftMap<span class="op">.</span><span class="fu">setControlVisibility</span>(<span class="kw">false</span>)<span class="op">;</span></span>
<span id="cb15-124"><a href="#cb15-124" tabindex="-1"></a>rightMap<span class="op">.</span><span class="fu">setControlVisibility</span>(<span class="kw">false</span>)<span class="op">;</span></span>
<span id="cb15-125"><a href="#cb15-125" tabindex="-1"></a></span>
<span id="cb15-126"><a href="#cb15-126" tabindex="-1"></a>leftMap<span class="op">.</span><span class="fu">add</span>(yearLabel1)</span>
<span id="cb15-127"><a href="#cb15-127" tabindex="-1"></a>rightMap<span class="op">.</span><span class="fu">add</span>(yearLabel2)</span>
<span id="cb15-128"><a href="#cb15-128" tabindex="-1"></a></span>
<span id="cb15-129"><a href="#cb15-129" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">setCenter</span>(<span class="fl">76.43</span><span class="op">,</span> <span class="fl">12.41</span><span class="op">,</span> <span class="dv">8</span>)</span>
<span id="cb15-130"><a href="#cb15-130" tabindex="-1"></a>ui<span class="op">.</span><span class="at">root</span><span class="op">.</span><span class="fu">clear</span>()</span>
<span id="cb15-131"><a href="#cb15-131" tabindex="-1"></a>ui<span class="op">.</span><span class="at">root</span><span class="op">.</span><span class="fu">add</span>(splitPanel)<span class="op">;</span></span>
<span id="cb15-132"><a href="#cb15-132" tabindex="-1"></a>ui<span class="op">.</span><span class="at">root</span><span class="op">.</span><span class="fu">add</span>(mainPanel)<span class="op">;</span> </span></code></pre></div>
</div>
<div id="unsupervised-clustering" class="section level2">
<h2>Unsupervised Clustering</h2>
<p><a
href="https://code.earthengine.google.com/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3ASupplement%2FSurface_Water%2FUnsupervised_Clustering"
target="_blank">Open in Code Editor ↗</a></p>
<div class="sourceCode" id="cb16"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb16-1"><a href="#cb16-1" tabindex="-1"></a><span class="co">/*</span></span>
<span id="cb16-2"><a href="#cb16-2" tabindex="-1"></a><span class="co">GEE adaptation of the &#39;waterdetect&#39; algorithm</span></span>
<span id="cb16-3"><a href="#cb16-3" tabindex="-1"></a></span>
<span id="cb16-4"><a href="#cb16-4" tabindex="-1"></a><span class="co">Copyright (c) 2021 Ujaval Gandhi.</span></span>
<span id="cb16-5"><a href="#cb16-5" tabindex="-1"></a><span class="co">This work is licensed under the terms of the MIT license.  </span></span>
<span id="cb16-6"><a href="#cb16-6" tabindex="-1"></a><span class="co">For a copy, see https://opensource.org/licenses/MIT</span></span>
<span id="cb16-7"><a href="#cb16-7" tabindex="-1"></a></span>
<span id="cb16-8"><a href="#cb16-8" tabindex="-1"></a><span class="co">Reference: https://github.com/cordmaur/WaterDetect</span></span>
<span id="cb16-9"><a href="#cb16-9" tabindex="-1"></a><span class="co">Cordeiro, M. C. R.; Martinez, J.-M.; Peña-Luque, S. </span></span>
<span id="cb16-10"><a href="#cb16-10" tabindex="-1"></a><span class="co">Automatic Water Detection from Multidimensional Hierarchical Clustering for Sentinel-2 Images</span></span>
<span id="cb16-11"><a href="#cb16-11" tabindex="-1"></a><span class="co">and a Comparison with Level 2A Processors. </span></span>
<span id="cb16-12"><a href="#cb16-12" tabindex="-1"></a><span class="co">Remote Sensing of Environment 2021, 253, 112209. https://doi.org/10.1016/j.rse.2020.112209.</span></span>
<span id="cb16-13"><a href="#cb16-13" tabindex="-1"></a><span class="co">*/</span></span>
<span id="cb16-14"><a href="#cb16-14" tabindex="-1"></a></span>
<span id="cb16-15"><a href="#cb16-15" tabindex="-1"></a><span class="co">// Create a composite for the selected region</span></span>
<span id="cb16-16"><a href="#cb16-16" tabindex="-1"></a><span class="kw">var</span> admin2 <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">&quot;FAO/GAUL_SIMPLIFIED_500m/2015/level2&quot;</span>)<span class="op">;</span></span>
<span id="cb16-17"><a href="#cb16-17" tabindex="-1"></a><span class="kw">var</span> s2 <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&quot;COPERNICUS/S2_SR_HARMONIZED&quot;</span>)<span class="op">;</span></span>
<span id="cb16-18"><a href="#cb16-18" tabindex="-1"></a></span>
<span id="cb16-19"><a href="#cb16-19" tabindex="-1"></a><span class="kw">var</span> selected <span class="op">=</span> admin2<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;ADM2_NAME&#39;</span><span class="op">,</span> <span class="st">&#39;Bangalore Urban&#39;</span>))</span>
<span id="cb16-20"><a href="#cb16-20" tabindex="-1"></a><span class="kw">var</span> geometry <span class="op">=</span> selected<span class="op">.</span><span class="fu">geometry</span>()</span>
<span id="cb16-21"><a href="#cb16-21" tabindex="-1"></a></span>
<span id="cb16-22"><a href="#cb16-22" tabindex="-1"></a><span class="kw">var</span> filtered <span class="op">=</span> s2<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">lt</span>(<span class="st">&#39;CLOUDY_PIXEL_PERCENTAGE&#39;</span><span class="op">,</span> <span class="dv">30</span>))</span>
<span id="cb16-23"><a href="#cb16-23" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(<span class="st">&#39;2019-01-01&#39;</span><span class="op">,</span> <span class="st">&#39;2020-01-01&#39;</span>))</span>
<span id="cb16-24"><a href="#cb16-24" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">bounds</span>(geometry))</span>
<span id="cb16-25"><a href="#cb16-25" tabindex="-1"></a>  <span class="op">.</span><span class="fu">map</span>(maskS2clouds)<span class="op">;</span></span>
<span id="cb16-26"><a href="#cb16-26" tabindex="-1"></a>  </span>
<span id="cb16-27"><a href="#cb16-27" tabindex="-1"></a><span class="co">// Load the Cloud Score+ collection</span></span>
<span id="cb16-28"><a href="#cb16-28" tabindex="-1"></a><span class="kw">var</span> csPlus <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&#39;GOOGLE/CLOUD_SCORE_PLUS/V1/S2_HARMONIZED&#39;</span>)<span class="op">;</span></span>
<span id="cb16-29"><a href="#cb16-29" tabindex="-1"></a><span class="kw">var</span> csPlusBands <span class="op">=</span> csPlus<span class="op">.</span><span class="fu">first</span>()<span class="op">.</span><span class="fu">bandNames</span>()<span class="op">;</span></span>
<span id="cb16-30"><a href="#cb16-30" tabindex="-1"></a></span>
<span id="cb16-31"><a href="#cb16-31" tabindex="-1"></a><span class="co">// We need to add Cloud Score + bands to each Sentinel-2</span></span>
<span id="cb16-32"><a href="#cb16-32" tabindex="-1"></a><span class="co">// image in the collection</span></span>
<span id="cb16-33"><a href="#cb16-33" tabindex="-1"></a><span class="co">// This is done using the linkCollection() function</span></span>
<span id="cb16-34"><a href="#cb16-34" tabindex="-1"></a><span class="kw">var</span> filteredS2WithCs <span class="op">=</span> filtered<span class="op">.</span><span class="fu">linkCollection</span>(csPlus<span class="op">,</span> csPlusBands)<span class="op">;</span></span>
<span id="cb16-35"><a href="#cb16-35" tabindex="-1"></a></span>
<span id="cb16-36"><a href="#cb16-36" tabindex="-1"></a><span class="co">// Function to mask pixels with low CS+ QA scores.</span></span>
<span id="cb16-37"><a href="#cb16-37" tabindex="-1"></a><span class="kw">function</span> <span class="fu">maskLowQA</span>(image) {</span>
<span id="cb16-38"><a href="#cb16-38" tabindex="-1"></a>  <span class="kw">var</span> qaBand <span class="op">=</span> <span class="st">&#39;cs&#39;</span><span class="op">;</span></span>
<span id="cb16-39"><a href="#cb16-39" tabindex="-1"></a>  <span class="kw">var</span> clearThreshold <span class="op">=</span> <span class="fl">0.5</span><span class="op">;</span></span>
<span id="cb16-40"><a href="#cb16-40" tabindex="-1"></a>  <span class="kw">var</span> mask <span class="op">=</span> image<span class="op">.</span><span class="fu">select</span>(qaBand)<span class="op">.</span><span class="fu">gte</span>(clearThreshold)<span class="op">;</span></span>
<span id="cb16-41"><a href="#cb16-41" tabindex="-1"></a>  <span class="cf">return</span> image<span class="op">.</span><span class="fu">updateMask</span>(mask)<span class="op">;</span></span>
<span id="cb16-42"><a href="#cb16-42" tabindex="-1"></a>}</span>
<span id="cb16-43"><a href="#cb16-43" tabindex="-1"></a></span>
<span id="cb16-44"><a href="#cb16-44" tabindex="-1"></a><span class="kw">var</span> filteredMasked <span class="op">=</span> filteredS2WithCs</span>
<span id="cb16-45"><a href="#cb16-45" tabindex="-1"></a>  <span class="op">.</span><span class="fu">map</span>(maskLowQA)</span>
<span id="cb16-46"><a href="#cb16-46" tabindex="-1"></a>  <span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;B.*&#39;</span>)<span class="op">;</span></span>
<span id="cb16-47"><a href="#cb16-47" tabindex="-1"></a></span>
<span id="cb16-48"><a href="#cb16-48" tabindex="-1"></a><span class="kw">var</span> image <span class="op">=</span> filteredMasked<span class="op">.</span><span class="fu">median</span>()<span class="op">.</span><span class="fu">clip</span>(geometry)<span class="op">;</span> </span>
<span id="cb16-49"><a href="#cb16-49" tabindex="-1"></a></span>
<span id="cb16-50"><a href="#cb16-50" tabindex="-1"></a></span>
<span id="cb16-51"><a href="#cb16-51" tabindex="-1"></a><span class="co">// Calculate  Normalized Difference Vegetation Index (NDWI)</span></span>
<span id="cb16-52"><a href="#cb16-52" tabindex="-1"></a><span class="co">// &#39;GREEN&#39; (B3) and &#39;NIR&#39; (B8)</span></span>
<span id="cb16-53"><a href="#cb16-53" tabindex="-1"></a><span class="kw">var</span> ndwi <span class="op">=</span> image<span class="op">.</span><span class="fu">normalizedDifference</span>([<span class="st">&#39;B3&#39;</span><span class="op">,</span> <span class="st">&#39;B8&#39;</span>])<span class="op">.</span><span class="fu">rename</span>([<span class="st">&#39;ndwi&#39;</span>])<span class="op">;</span></span>
<span id="cb16-54"><a href="#cb16-54" tabindex="-1"></a> </span>
<span id="cb16-55"><a href="#cb16-55" tabindex="-1"></a><span class="co">// Calculate Modified Normalized Difference Water Index (MNDWI)</span></span>
<span id="cb16-56"><a href="#cb16-56" tabindex="-1"></a><span class="co">// &#39;GREEN&#39; (B3) and &#39;SWIR1&#39; (B11)</span></span>
<span id="cb16-57"><a href="#cb16-57" tabindex="-1"></a><span class="kw">var</span> mndwi <span class="op">=</span> image<span class="op">.</span><span class="fu">normalizedDifference</span>([<span class="st">&#39;B3&#39;</span><span class="op">,</span> <span class="st">&#39;B11&#39;</span>])<span class="op">.</span><span class="fu">rename</span>([<span class="st">&#39;mndwi&#39;</span>])<span class="op">;</span> </span>
<span id="cb16-58"><a href="#cb16-58" tabindex="-1"></a></span>
<span id="cb16-59"><a href="#cb16-59" tabindex="-1"></a><span class="co">// Select the MIR (SWIR2) band (B12)</span></span>
<span id="cb16-60"><a href="#cb16-60" tabindex="-1"></a><span class="kw">var</span> mir2 <span class="op">=</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;B12&#39;</span>)<span class="op">.</span><span class="fu">multiply</span>(<span class="fl">0.0001</span>)<span class="op">.</span><span class="fu">rename</span>(<span class="st">&#39;mir2&#39;</span>)</span>
<span id="cb16-61"><a href="#cb16-61" tabindex="-1"></a></span>
<span id="cb16-62"><a href="#cb16-62" tabindex="-1"></a><span class="co">// Use [NDWI, MNDWI, Mir2] combination</span></span>
<span id="cb16-63"><a href="#cb16-63" tabindex="-1"></a><span class="co">// If these do not work well for your region, try other</span></span>
<span id="cb16-64"><a href="#cb16-64" tabindex="-1"></a><span class="co">// band combinations given at</span></span>
<span id="cb16-65"><a href="#cb16-65" tabindex="-1"></a><span class="co">// https://github.com/cordmaur/WaterDetect/blob/master/WaterDetect.ini</span></span>
<span id="cb16-66"><a href="#cb16-66" tabindex="-1"></a><span class="kw">var</span> stackedImage <span class="op">=</span> ndwi<span class="op">.</span><span class="fu">addBands</span>(mndwi)<span class="op">.</span><span class="fu">addBands</span>(mir2)</span>
<span id="cb16-67"><a href="#cb16-67" tabindex="-1"></a></span>
<span id="cb16-68"><a href="#cb16-68" tabindex="-1"></a><span class="co">// Make the training dataset for unsupervised clustering</span></span>
<span id="cb16-69"><a href="#cb16-69" tabindex="-1"></a><span class="kw">var</span> training <span class="op">=</span> stackedImage<span class="op">.</span><span class="fu">sample</span>({</span>
<span id="cb16-70"><a href="#cb16-70" tabindex="-1"></a>  <span class="dt">region</span><span class="op">:</span> geometry<span class="op">,</span></span>
<span id="cb16-71"><a href="#cb16-71" tabindex="-1"></a>  <span class="dt">scale</span><span class="op">:</span> <span class="dv">20</span><span class="op">,</span></span>
<span id="cb16-72"><a href="#cb16-72" tabindex="-1"></a>  <span class="dt">numPixels</span><span class="op">:</span> <span class="dv">1000</span></span>
<span id="cb16-73"><a href="#cb16-73" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb16-74"><a href="#cb16-74" tabindex="-1"></a><span class="fu">print</span>(training<span class="op">.</span><span class="fu">first</span>())</span>
<span id="cb16-75"><a href="#cb16-75" tabindex="-1"></a></span>
<span id="cb16-76"><a href="#cb16-76" tabindex="-1"></a><span class="co">// Instantiate the clusterer and train it.</span></span>
<span id="cb16-77"><a href="#cb16-77" tabindex="-1"></a><span class="kw">var</span> clusterer <span class="op">=</span> ee<span class="op">.</span><span class="at">Clusterer</span><span class="op">.</span><span class="fu">wekaCascadeKMeans</span>({</span>
<span id="cb16-78"><a href="#cb16-78" tabindex="-1"></a>  <span class="dt">minClusters</span><span class="op">:</span> <span class="dv">2</span><span class="op">,</span></span>
<span id="cb16-79"><a href="#cb16-79" tabindex="-1"></a>  <span class="dt">maxClusters</span><span class="op">:</span> <span class="dv">10</span>})<span class="op">.</span><span class="fu">train</span>(training)<span class="op">;</span></span>
<span id="cb16-80"><a href="#cb16-80" tabindex="-1"></a></span>
<span id="cb16-81"><a href="#cb16-81" tabindex="-1"></a><span class="co">// Cluster the stacked image</span></span>
<span id="cb16-82"><a href="#cb16-82" tabindex="-1"></a><span class="kw">var</span> clustered <span class="op">=</span> stackedImage<span class="op">.</span><span class="fu">cluster</span>(clusterer)<span class="op">;</span></span>
<span id="cb16-83"><a href="#cb16-83" tabindex="-1"></a></span>
<span id="cb16-84"><a href="#cb16-84" tabindex="-1"></a><span class="co">// We need to identify which of the clusters represent water</span></span>
<span id="cb16-85"><a href="#cb16-85" tabindex="-1"></a><span class="co">// We use the MNDWI band and select the cluster with the </span></span>
<span id="cb16-86"><a href="#cb16-86" tabindex="-1"></a><span class="co">// highest average MNDWI values of all pixels within the cluster</span></span>
<span id="cb16-87"><a href="#cb16-87" tabindex="-1"></a></span>
<span id="cb16-88"><a href="#cb16-88" tabindex="-1"></a><span class="co">// Calculate the stats on MNDWI band, grouped by clusters</span></span>
<span id="cb16-89"><a href="#cb16-89" tabindex="-1"></a><span class="kw">var</span> stats <span class="op">=</span> mndwi<span class="op">.</span><span class="fu">addBands</span>(clustered)<span class="op">.</span><span class="fu">reduceRegion</span>({</span>
<span id="cb16-90"><a href="#cb16-90" tabindex="-1"></a>  <span class="dt">reducer</span><span class="op">:</span> ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">mean</span>()<span class="op">.</span><span class="fu">group</span>({</span>
<span id="cb16-91"><a href="#cb16-91" tabindex="-1"></a>    <span class="dt">groupField</span><span class="op">:</span> <span class="dv">1</span><span class="op">,</span></span>
<span id="cb16-92"><a href="#cb16-92" tabindex="-1"></a>    <span class="dt">groupName</span><span class="op">:</span> <span class="st">&#39;cluster&#39;</span><span class="op">,</span></span>
<span id="cb16-93"><a href="#cb16-93" tabindex="-1"></a>  })<span class="op">,</span></span>
<span id="cb16-94"><a href="#cb16-94" tabindex="-1"></a>  <span class="dt">geometry</span><span class="op">:</span> geometry<span class="op">,</span></span>
<span id="cb16-95"><a href="#cb16-95" tabindex="-1"></a>  <span class="dt">scale</span><span class="op">:</span> <span class="dv">100</span><span class="op">,</span></span>
<span id="cb16-96"><a href="#cb16-96" tabindex="-1"></a>  <span class="dt">maxPixels</span><span class="op">:</span> <span class="fl">1e8</span></span>
<span id="cb16-97"><a href="#cb16-97" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb16-98"><a href="#cb16-98" tabindex="-1"></a><span class="fu">print</span>(stats)</span>
<span id="cb16-99"><a href="#cb16-99" tabindex="-1"></a></span>
<span id="cb16-100"><a href="#cb16-100" tabindex="-1"></a><span class="co">// Extract the cluster-wise stats as a list of lists</span></span>
<span id="cb16-101"><a href="#cb16-101" tabindex="-1"></a><span class="co">// We get a list in the following format</span></span>
<span id="cb16-102"><a href="#cb16-102" tabindex="-1"></a><span class="co">// [[avg_mndwi, cluster_number], [avg_mndwi, cluster_number] ...]]</span></span>
<span id="cb16-103"><a href="#cb16-103" tabindex="-1"></a><span class="kw">var</span> groupStats <span class="op">=</span> ee<span class="op">.</span><span class="fu">List</span>(stats<span class="op">.</span><span class="fu">get</span>(<span class="st">&#39;groups&#39;</span>))</span>
<span id="cb16-104"><a href="#cb16-104" tabindex="-1"></a></span>
<span id="cb16-105"><a href="#cb16-105" tabindex="-1"></a><span class="kw">var</span> groupStatsLists <span class="op">=</span> groupStats<span class="op">.</span><span class="fu">map</span>(<span class="kw">function</span>(item) {</span>
<span id="cb16-106"><a href="#cb16-106" tabindex="-1"></a>      <span class="kw">var</span> areaDict <span class="op">=</span> ee<span class="op">.</span><span class="fu">Dictionary</span>(item)</span>
<span id="cb16-107"><a href="#cb16-107" tabindex="-1"></a>      <span class="kw">var</span> clusterNumber <span class="op">=</span> ee<span class="op">.</span><span class="fu">Number</span>(</span>
<span id="cb16-108"><a href="#cb16-108" tabindex="-1"></a>        areaDict<span class="op">.</span><span class="fu">get</span>(<span class="st">&#39;cluster&#39;</span>))</span>
<span id="cb16-109"><a href="#cb16-109" tabindex="-1"></a>      <span class="kw">var</span> mndwi <span class="op">=</span> ee<span class="op">.</span><span class="fu">Number</span>(</span>
<span id="cb16-110"><a href="#cb16-110" tabindex="-1"></a>        areaDict<span class="op">.</span><span class="fu">get</span>(<span class="st">&#39;mean&#39;</span>))</span>
<span id="cb16-111"><a href="#cb16-111" tabindex="-1"></a>      <span class="cf">return</span> ee<span class="op">.</span><span class="fu">List</span>([mndwi<span class="op">,</span> clusterNumber])</span>
<span id="cb16-112"><a href="#cb16-112" tabindex="-1"></a>    })</span>
<span id="cb16-113"><a href="#cb16-113" tabindex="-1"></a>    </span>
<span id="cb16-114"><a href="#cb16-114" tabindex="-1"></a><span class="co">// Use the ee.Reducer.max() on the list of lists</span></span>
<span id="cb16-115"><a href="#cb16-115" tabindex="-1"></a><span class="co">// It will pick the list with the highest MNDWI</span></span>
<span id="cb16-116"><a href="#cb16-116" tabindex="-1"></a><span class="kw">var</span> waterClusterList <span class="op">=</span> ee<span class="op">.</span><span class="fu">Dictionary</span>(ee<span class="op">.</span><span class="fu">List</span>(groupStatsLists)</span>
<span id="cb16-117"><a href="#cb16-117" tabindex="-1"></a>  <span class="op">.</span><span class="fu">reduce</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">max</span>(<span class="dv">2</span>)))<span class="op">;</span></span>
<span id="cb16-118"><a href="#cb16-118" tabindex="-1"></a></span>
<span id="cb16-119"><a href="#cb16-119" tabindex="-1"></a><span class="co">// Extract the cluster number</span></span>
<span id="cb16-120"><a href="#cb16-120" tabindex="-1"></a><span class="kw">var</span> waterCluster <span class="op">=</span> ee<span class="op">.</span><span class="fu">Number</span>(waterClusterList<span class="op">.</span><span class="fu">get</span>(<span class="st">&#39;max1&#39;</span>))<span class="op">;</span></span>
<span id="cb16-121"><a href="#cb16-121" tabindex="-1"></a></span>
<span id="cb16-122"><a href="#cb16-122" tabindex="-1"></a><span class="co">// Select all pixels from the water cluster and mask everything else</span></span>
<span id="cb16-123"><a href="#cb16-123" tabindex="-1"></a><span class="kw">var</span> water <span class="op">=</span> clustered<span class="op">.</span><span class="fu">eq</span>(waterCluster)<span class="op">.</span><span class="fu">selfMask</span>()<span class="op">;</span></span>
<span id="cb16-124"><a href="#cb16-124" tabindex="-1"></a></span>
<span id="cb16-125"><a href="#cb16-125" tabindex="-1"></a><span class="co">// The original waterdetect algorithm has an additional step</span></span>
<span id="cb16-126"><a href="#cb16-126" tabindex="-1"></a><span class="co">// to train a supervised classifier using the water vs. non-water</span></span>
<span id="cb16-127"><a href="#cb16-127" tabindex="-1"></a><span class="co">// samples detected from the procedure above.</span></span>
<span id="cb16-128"><a href="#cb16-128" tabindex="-1"></a><span class="co">// In our testing, there was no significant improvement to the</span></span>
<span id="cb16-129"><a href="#cb16-129" tabindex="-1"></a><span class="co">// output, so we have not added that step.</span></span>
<span id="cb16-130"><a href="#cb16-130" tabindex="-1"></a></span>
<span id="cb16-131"><a href="#cb16-131" tabindex="-1"></a><span class="co">// Visualize the results</span></span>
<span id="cb16-132"><a href="#cb16-132" tabindex="-1"></a><span class="kw">var</span> rgbVis <span class="op">=</span> {<span class="dt">min</span><span class="op">:</span> <span class="fl">0.0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span> <span class="fl">0.3</span><span class="op">,</span> <span class="dt">bands</span><span class="op">:</span> [<span class="st">&#39;B4&#39;</span><span class="op">,</span> <span class="st">&#39;B3&#39;</span><span class="op">,</span> <span class="st">&#39;B2&#39;</span>]}<span class="op">;</span></span>
<span id="cb16-133"><a href="#cb16-133" tabindex="-1"></a><span class="kw">var</span> waterVis <span class="op">=</span> {<span class="dt">min</span><span class="op">:</span><span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span><span class="dv">1</span><span class="op">,</span> <span class="dt">palette</span><span class="op">:</span> [<span class="st">&#39;white&#39;</span><span class="op">,</span> <span class="st">&#39;blue&#39;</span>]}<span class="op">;</span></span>
<span id="cb16-134"><a href="#cb16-134" tabindex="-1"></a></span>
<span id="cb16-135"><a href="#cb16-135" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">setCenter</span>(<span class="fl">77.61</span><span class="op">,</span> <span class="fl">13.08</span><span class="op">,</span> <span class="dv">14</span>)<span class="op">;</span></span>
<span id="cb16-136"><a href="#cb16-136" tabindex="-1"></a></span>
<span id="cb16-137"><a href="#cb16-137" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">centerObject</span>(geometry<span class="op">,</span> <span class="dv">10</span>)<span class="op">;</span></span>
<span id="cb16-138"><a href="#cb16-138" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(image<span class="op">,</span> rgbVis<span class="op">,</span> <span class="st">&#39;Image&#39;</span>)<span class="op">;</span></span>
<span id="cb16-139"><a href="#cb16-139" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(clustered<span class="op">.</span><span class="fu">randomVisualizer</span>()<span class="op">,</span> {}<span class="op">,</span> <span class="st">&#39;clusters&#39;</span>)<span class="op">;</span></span>
<span id="cb16-140"><a href="#cb16-140" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(water<span class="op">,</span> waterVis<span class="op">,</span> <span class="st">&#39;water&#39;</span>)<span class="op">;</span></span>
<span id="cb16-141"><a href="#cb16-141" tabindex="-1"></a></span>
<span id="cb16-142"><a href="#cb16-142" tabindex="-1"></a><span class="co">// Interactive visualization may time-out for large images</span></span>
<span id="cb16-143"><a href="#cb16-143" tabindex="-1"></a><span class="co">// Export the image to use the batch processing mode</span></span>
<span id="cb16-144"><a href="#cb16-144" tabindex="-1"></a>Export<span class="op">.</span><span class="at">image</span><span class="op">.</span><span class="fu">toDrive</span>({</span>
<span id="cb16-145"><a href="#cb16-145" tabindex="-1"></a>  <span class="dt">image</span><span class="op">:</span> water<span class="op">,</span></span>
<span id="cb16-146"><a href="#cb16-146" tabindex="-1"></a>  <span class="dt">description</span><span class="op">:</span> <span class="st">&#39;Water_Cluster&#39;</span><span class="op">,</span></span>
<span id="cb16-147"><a href="#cb16-147" tabindex="-1"></a>  <span class="dt">folder</span><span class="op">:</span> <span class="st">&#39;earthengine&#39;</span><span class="op">,</span></span>
<span id="cb16-148"><a href="#cb16-148" tabindex="-1"></a>  <span class="dt">fileNamePrefix</span><span class="op">:</span> <span class="st">&#39;water_cluster&#39;</span><span class="op">,</span></span>
<span id="cb16-149"><a href="#cb16-149" tabindex="-1"></a>  <span class="dt">region</span><span class="op">:</span> geometry<span class="op">,</span></span>
<span id="cb16-150"><a href="#cb16-150" tabindex="-1"></a>  <span class="dt">scale</span><span class="op">:</span> <span class="dv">20</span><span class="op">,</span></span>
<span id="cb16-151"><a href="#cb16-151" tabindex="-1"></a>  <span class="dt">maxPixels</span><span class="op">:</span> <span class="fl">1e10</span>})<span class="op">;</span></span></code></pre></div>
</div>
<div id="dynamic-world-water-detection" class="section level2">
<h2>Dynamic World Water Detection</h2>
<div class="figure" style="text-align: center">
<img src="images/gee_water_resources_management/dw_water.png" alt="Detecting Surface Water with Dynamic World" width="75%" />
<p class="caption">
Detecting Surface Water with Dynamic World
</p>
</div>
<p><a
href="https://code.earthengine.google.co.in/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3ASupplement%2FSurface_Water%2FDynamic_World_Water_Detection"
target="_blank">Open in Code Editor ↗</a></p>
<div class="sourceCode" id="cb17"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb17-1"><a href="#cb17-1" tabindex="-1"></a><span class="co">// Example script showing how to extract water pixels</span></span>
<span id="cb17-2"><a href="#cb17-2" tabindex="-1"></a><span class="co">// from the Dynamic World dataset.</span></span>
<span id="cb17-3"><a href="#cb17-3" tabindex="-1"></a></span>
<span id="cb17-4"><a href="#cb17-4" tabindex="-1"></a><span class="co">// Choose a region</span></span>
<span id="cb17-5"><a href="#cb17-5" tabindex="-1"></a><span class="kw">var</span> geometry <span class="op">=</span> ee<span class="op">.</span><span class="at">Geometry</span><span class="op">.</span><span class="fu">Polygon</span>([[</span>
<span id="cb17-6"><a href="#cb17-6" tabindex="-1"></a>  [<span class="fl">76.37422</span><span class="op">,</span> <span class="fl">12.5721</span>]<span class="op">,</span></span>
<span id="cb17-7"><a href="#cb17-7" tabindex="-1"></a>  [<span class="fl">76.37422</span><span class="op">,</span> <span class="fl">12.3736</span>]<span class="op">,</span></span>
<span id="cb17-8"><a href="#cb17-8" tabindex="-1"></a>  [<span class="fl">76.62073</span><span class="op">,</span> <span class="fl">12.3736</span>]<span class="op">,</span></span>
<span id="cb17-9"><a href="#cb17-9" tabindex="-1"></a>  [<span class="fl">76.62073</span><span class="op">,</span> <span class="fl">12.5721</span>]]</span>
<span id="cb17-10"><a href="#cb17-10" tabindex="-1"></a>])<span class="op">;</span></span>
<span id="cb17-11"><a href="#cb17-11" tabindex="-1"></a></span>
<span id="cb17-12"><a href="#cb17-12" tabindex="-1"></a><span class="co">// Choose a time period</span></span>
<span id="cb17-13"><a href="#cb17-13" tabindex="-1"></a><span class="co">// Some months may not have enough cloud-free observations</span></span>
<span id="cb17-14"><a href="#cb17-14" tabindex="-1"></a><span class="co">// Increase the time period if you have gaps in your results</span></span>
<span id="cb17-15"><a href="#cb17-15" tabindex="-1"></a><span class="kw">var</span> year <span class="op">=</span> <span class="dv">2023</span><span class="op">;</span></span>
<span id="cb17-16"><a href="#cb17-16" tabindex="-1"></a><span class="kw">var</span> month <span class="op">=</span> <span class="dv">1</span><span class="op">;</span> </span>
<span id="cb17-17"><a href="#cb17-17" tabindex="-1"></a><span class="kw">var</span> startDate <span class="op">=</span> ee<span class="op">.</span><span class="at">Date</span><span class="op">.</span><span class="fu">fromYMD</span>(year<span class="op">,</span> month<span class="op">,</span> <span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb17-18"><a href="#cb17-18" tabindex="-1"></a><span class="kw">var</span> endDate <span class="op">=</span> startDate<span class="op">.</span><span class="fu">advance</span>(<span class="dv">1</span><span class="op">,</span> <span class="st">&#39;month&#39;</span>)<span class="op">;</span></span>
<span id="cb17-19"><a href="#cb17-19" tabindex="-1"></a></span>
<span id="cb17-20"><a href="#cb17-20" tabindex="-1"></a><span class="co">// Create and Visualize the Dynamic World probability composite</span></span>
<span id="cb17-21"><a href="#cb17-21" tabindex="-1"></a><span class="co">// for the chosen region and time period</span></span>
<span id="cb17-22"><a href="#cb17-22" tabindex="-1"></a></span>
<span id="cb17-23"><a href="#cb17-23" tabindex="-1"></a><span class="co">// Filter the Dynamic World collection</span></span>
<span id="cb17-24"><a href="#cb17-24" tabindex="-1"></a><span class="kw">var</span> dwFiltered <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&#39;GOOGLE/DYNAMICWORLD/V1&#39;</span>)</span>
<span id="cb17-25"><a href="#cb17-25" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(startDate<span class="op">,</span> endDate))</span>
<span id="cb17-26"><a href="#cb17-26" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">bounds</span>(geometry))<span class="op">;</span></span>
<span id="cb17-27"><a href="#cb17-27" tabindex="-1"></a></span>
<span id="cb17-28"><a href="#cb17-28" tabindex="-1"></a><span class="co">// Select probability bands and compute mean probability during the period</span></span>
<span id="cb17-29"><a href="#cb17-29" tabindex="-1"></a></span>
<span id="cb17-30"><a href="#cb17-30" tabindex="-1"></a><span class="kw">var</span> probabilityBands <span class="op">=</span> [</span>
<span id="cb17-31"><a href="#cb17-31" tabindex="-1"></a>  <span class="st">&#39;water&#39;</span><span class="op">,</span> <span class="st">&#39;trees&#39;</span><span class="op">,</span> <span class="st">&#39;grass&#39;</span><span class="op">,</span> <span class="st">&#39;flooded_vegetation&#39;</span><span class="op">,</span> <span class="st">&#39;crops&#39;</span><span class="op">,</span></span>
<span id="cb17-32"><a href="#cb17-32" tabindex="-1"></a>  <span class="st">&#39;shrub_and_scrub&#39;</span><span class="op">,</span> <span class="st">&#39;built&#39;</span><span class="op">,</span> <span class="st">&#39;bare&#39;</span><span class="op">,</span> <span class="st">&#39;snow_and_ice&#39;</span></span>
<span id="cb17-33"><a href="#cb17-33" tabindex="-1"></a>]<span class="op">;</span></span>
<span id="cb17-34"><a href="#cb17-34" tabindex="-1"></a></span>
<span id="cb17-35"><a href="#cb17-35" tabindex="-1"></a><span class="kw">var</span> probabilityImage <span class="op">=</span> dwFiltered<span class="op">.</span><span class="fu">select</span>(probabilityBands)<span class="op">.</span><span class="fu">mean</span>()<span class="op">;</span></span>
<span id="cb17-36"><a href="#cb17-36" tabindex="-1"></a></span>
<span id="cb17-37"><a href="#cb17-37" tabindex="-1"></a><span class="co">// Create and Visualize the Sentinel-2 composite</span></span>
<span id="cb17-38"><a href="#cb17-38" tabindex="-1"></a><span class="co">// for the chosen region and time period</span></span>
<span id="cb17-39"><a href="#cb17-39" tabindex="-1"></a><span class="kw">var</span> s2 <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&#39;COPERNICUS/S2_HARMONIZED&#39;</span>)<span class="op">;</span></span>
<span id="cb17-40"><a href="#cb17-40" tabindex="-1"></a></span>
<span id="cb17-41"><a href="#cb17-41" tabindex="-1"></a><span class="kw">var</span> filtered <span class="op">=</span> s2<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">lt</span>(<span class="st">&#39;CLOUDY_PIXEL_PERCENTAGE&#39;</span><span class="op">,</span> <span class="dv">30</span>))</span>
<span id="cb17-42"><a href="#cb17-42" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(startDate<span class="op">,</span> endDate))</span>
<span id="cb17-43"><a href="#cb17-43" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">bounds</span>(geometry))<span class="op">;</span></span>
<span id="cb17-44"><a href="#cb17-44" tabindex="-1"></a></span>
<span id="cb17-45"><a href="#cb17-45" tabindex="-1"></a><span class="kw">var</span> medianComposite <span class="op">=</span> filtered<span class="op">.</span><span class="fu">median</span>()<span class="op">;</span></span>
<span id="cb17-46"><a href="#cb17-46" tabindex="-1"></a></span>
<span id="cb17-47"><a href="#cb17-47" tabindex="-1"></a><span class="kw">var</span> rgbVis <span class="op">=</span> {</span>
<span id="cb17-48"><a href="#cb17-48" tabindex="-1"></a>  <span class="dt">min</span><span class="op">:</span> <span class="fl">0.0</span><span class="op">,</span></span>
<span id="cb17-49"><a href="#cb17-49" tabindex="-1"></a>  <span class="dt">max</span><span class="op">:</span> <span class="dv">3000</span><span class="op">,</span></span>
<span id="cb17-50"><a href="#cb17-50" tabindex="-1"></a>  <span class="dt">bands</span><span class="op">:</span> [<span class="st">&#39;B4&#39;</span><span class="op">,</span> <span class="st">&#39;B3&#39;</span><span class="op">,</span> <span class="st">&#39;B2&#39;</span>]<span class="op">,</span> </span>
<span id="cb17-51"><a href="#cb17-51" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb17-52"><a href="#cb17-52" tabindex="-1"></a></span>
<span id="cb17-53"><a href="#cb17-53" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">centerObject</span>(geometry)<span class="op">;</span></span>
<span id="cb17-54"><a href="#cb17-54" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(medianComposite<span class="op">.</span><span class="fu">clip</span>(geometry)<span class="op">,</span> rgbVis<span class="op">,</span> <span class="st">&#39;S2 Image&#39;</span>)<span class="op">;</span></span>
<span id="cb17-55"><a href="#cb17-55" tabindex="-1"></a></span>
<span id="cb17-56"><a href="#cb17-56" tabindex="-1"></a><span class="co">// Visualize water probability</span></span>
<span id="cb17-57"><a href="#cb17-57" tabindex="-1"></a><span class="kw">var</span> probabilityVis <span class="op">=</span> {</span>
<span id="cb17-58"><a href="#cb17-58" tabindex="-1"></a>  <span class="dt">min</span><span class="op">:</span><span class="dv">0</span><span class="op">,</span> </span>
<span id="cb17-59"><a href="#cb17-59" tabindex="-1"></a>  <span class="dt">max</span><span class="op">:</span><span class="dv">1</span><span class="op">,</span></span>
<span id="cb17-60"><a href="#cb17-60" tabindex="-1"></a>  <span class="dt">bands</span><span class="op">:</span> [<span class="st">&#39;water&#39;</span>]<span class="op">,</span></span>
<span id="cb17-61"><a href="#cb17-61" tabindex="-1"></a>  <span class="dt">palette</span><span class="op">:</span> [<span class="st">&#39;#f1eef6&#39;</span><span class="op">,</span><span class="st">&#39;#bdc9e1&#39;</span><span class="op">,</span><span class="st">&#39;#74a9cf&#39;</span><span class="op">,</span><span class="st">&#39;#2b8cbe&#39;</span><span class="op">,</span><span class="st">&#39;#045a8d&#39;</span>]}<span class="op">;</span></span>
<span id="cb17-62"><a href="#cb17-62" tabindex="-1"></a>  </span>
<span id="cb17-63"><a href="#cb17-63" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(probabilityImage<span class="op">.</span><span class="fu">clip</span>(geometry)<span class="op">,</span> probabilityVis<span class="op">,</span> <span class="st">&#39;Water Probability&#39;</span>)<span class="op">;</span></span>
<span id="cb17-64"><a href="#cb17-64" tabindex="-1"></a></span>
<span id="cb17-65"><a href="#cb17-65" tabindex="-1"></a></span>
<span id="cb17-66"><a href="#cb17-66" tabindex="-1"></a><span class="co">// **************************************************************</span></span>
<span id="cb17-67"><a href="#cb17-67" tabindex="-1"></a><span class="co">// 2. Extract Water</span></span>
<span id="cb17-68"><a href="#cb17-68" tabindex="-1"></a><span class="co">// **************************************************************</span></span>
<span id="cb17-69"><a href="#cb17-69" tabindex="-1"></a></span>
<span id="cb17-70"><a href="#cb17-70" tabindex="-1"></a><span class="co">// Select a threshold for water probability</span></span>
<span id="cb17-71"><a href="#cb17-71" tabindex="-1"></a><span class="kw">var</span> waterThreshold <span class="op">=</span> <span class="fl">0.5</span><span class="op">;</span></span>
<span id="cb17-72"><a href="#cb17-72" tabindex="-1"></a></span>
<span id="cb17-73"><a href="#cb17-73" tabindex="-1"></a><span class="co">// Select all pixels where &#39;water&#39; probability is &gt; threshold</span></span>
<span id="cb17-74"><a href="#cb17-74" tabindex="-1"></a><span class="co">// The result is a binary image</span></span>
<span id="cb17-75"><a href="#cb17-75" tabindex="-1"></a><span class="kw">var</span> water <span class="op">=</span> probabilityImage<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;water&#39;</span>)<span class="op">.</span><span class="fu">gt</span>(waterThreshold)<span class="op">;</span></span>
<span id="cb17-76"><a href="#cb17-76" tabindex="-1"></a></span>
<span id="cb17-77"><a href="#cb17-77" tabindex="-1"></a><span class="co">// [Optional] Include riparian vegetation around the banks</span></span>
<span id="cb17-78"><a href="#cb17-78" tabindex="-1"></a><span class="co">// var floodedVegetationThreshold = 0.3;</span></span>
<span id="cb17-79"><a href="#cb17-79" tabindex="-1"></a><span class="co">// var water = probabilityImage.select(&#39;water&#39;).gt(waterThreshold)</span></span>
<span id="cb17-80"><a href="#cb17-80" tabindex="-1"></a><span class="co">//   .or(probabilityImage.select(&#39;flooded_vegetation&#39;).gt(floodedVegetationThreshold));</span></span>
<span id="cb17-81"><a href="#cb17-81" tabindex="-1"></a></span>
<span id="cb17-82"><a href="#cb17-82" tabindex="-1"></a><span class="co">// Visualize the water image</span></span>
<span id="cb17-83"><a href="#cb17-83" tabindex="-1"></a><span class="kw">var</span> waterVis <span class="op">=</span> {<span class="dt">min</span><span class="op">:</span><span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span><span class="dv">1</span><span class="op">,</span> <span class="dt">palette</span><span class="op">:</span> [<span class="st">&#39;white&#39;</span><span class="op">,</span> <span class="st">&#39;blue&#39;</span>]}<span class="op">;</span></span>
<span id="cb17-84"><a href="#cb17-84" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(water<span class="op">.</span><span class="fu">clip</span>(geometry)<span class="op">,</span> waterVis<span class="op">,</span> <span class="st">&#39;Detected Water&#39;</span>)<span class="op">;</span></span></code></pre></div>
</div>
</div>
<div id="sar" class="section level1">
<h1>SAR</h1>
<div id="sentinel-1-ard-pre-processing" class="section level2">
<h2>Sentinel-1 ARD Pre-Processing</h2>
<p>This example script shows how to apply a Gamma MAP (Maximum
A-posterior) Speckle Filter and Radiometric Terrain Correction to
Sentinel-1 images using the Analysis Ready Data (ARD) preparation
framework published by Mullissa, A. et. al.</p>
<div class="figure" style="text-align: center">
<img src="images/gee_water_resources_management/gamma_map.png" alt="Gamma MAP Speckle filtering" width="100%" />
<p class="caption">
Gamma MAP Speckle filtering
</p>
</div>
<p><a
href="https://code.earthengine.google.com/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3ASupplement%2FSAR%2FS1_ARD_Preprocessing"
target="_blank">Open in Code Editor ↗</a></p>
<div class="sourceCode" id="cb18"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb18-1"><a href="#cb18-1" tabindex="-1"></a><span class="co">// Example script that shows how to pre-process SAR data</span></span>
<span id="cb18-2"><a href="#cb18-2" tabindex="-1"></a><span class="co">// using Analysis Ready Data (ARD) Framework from</span></span>
<span id="cb18-3"><a href="#cb18-3" tabindex="-1"></a><span class="co">// https://github.com/adugnag/gee_s1_ard/tree/main</span></span>
<span id="cb18-4"><a href="#cb18-4" tabindex="-1"></a></span>
<span id="cb18-5"><a href="#cb18-5" tabindex="-1"></a><span class="co">// Mullissa, A.; Vollrath, A.; Odongo-Braun, C.; Slagter, B.;</span></span>
<span id="cb18-6"><a href="#cb18-6" tabindex="-1"></a><span class="co">// Balling, J.; Gou, Y.; Gorelick, N.; Reiche, J. </span></span>
<span id="cb18-7"><a href="#cb18-7" tabindex="-1"></a><span class="co">// Sentinel-1 SAR Backscatter Analysis Ready Data Preparation </span></span>
<span id="cb18-8"><a href="#cb18-8" tabindex="-1"></a><span class="co">// in Google Earth Engine. Remote Sens. 2021, 13, 1954. </span></span>
<span id="cb18-9"><a href="#cb18-9" tabindex="-1"></a><span class="co">// https://doi.org/10.3390/rs13101954</span></span>
<span id="cb18-10"><a href="#cb18-10" tabindex="-1"></a></span>
<span id="cb18-11"><a href="#cb18-11" tabindex="-1"></a><span class="co">// This script applies GAMMA MAP filter with border noise</span></span>
<span id="cb18-12"><a href="#cb18-12" tabindex="-1"></a><span class="co">// removal and radiometric terrain correction</span></span>
<span id="cb18-13"><a href="#cb18-13" tabindex="-1"></a><span class="kw">var</span> admin2 <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">&quot;FAO/GAUL_SIMPLIFIED_500m/2015/level2&quot;</span>)<span class="op">;</span></span>
<span id="cb18-14"><a href="#cb18-14" tabindex="-1"></a><span class="kw">var</span> hydrosheds <span class="op">=</span> ee<span class="op">.</span><span class="fu">Image</span>(<span class="st">&quot;WWF/HydroSHEDS/03VFDEM&quot;</span>)<span class="op">;</span></span>
<span id="cb18-15"><a href="#cb18-15" tabindex="-1"></a>    </span>
<span id="cb18-16"><a href="#cb18-16" tabindex="-1"></a><span class="kw">var</span> startDate <span class="op">=</span> <span class="st">&#39;2018-08-10&#39;</span></span>
<span id="cb18-17"><a href="#cb18-17" tabindex="-1"></a><span class="kw">var</span> endDate <span class="op">=</span> <span class="st">&#39;2018-08-23&#39;</span></span>
<span id="cb18-18"><a href="#cb18-18" tabindex="-1"></a></span>
<span id="cb18-19"><a href="#cb18-19" tabindex="-1"></a><span class="kw">var</span> selected <span class="op">=</span> admin2<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;ADM2_NAME&#39;</span><span class="op">,</span> <span class="st">&#39;Ernakulam&#39;</span>))</span>
<span id="cb18-20"><a href="#cb18-20" tabindex="-1"></a><span class="kw">var</span> geometry <span class="op">=</span> selected<span class="op">.</span><span class="fu">geometry</span>()</span>
<span id="cb18-21"><a href="#cb18-21" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(geometry<span class="op">,</span> {<span class="dt">color</span><span class="op">:</span> <span class="st">&#39;grey&#39;</span>}<span class="op">,</span> <span class="st">&#39;Selected Admin-2&#39;</span>)</span>
<span id="cb18-22"><a href="#cb18-22" tabindex="-1"></a></span>
<span id="cb18-23"><a href="#cb18-23" tabindex="-1"></a><span class="co">// ************************************************************</span></span>
<span id="cb18-24"><a href="#cb18-24" tabindex="-1"></a><span class="co">// Sentinel-1 ARD Pre-Processing</span></span>
<span id="cb18-25"><a href="#cb18-25" tabindex="-1"></a><span class="co">// ************************************************************</span></span>
<span id="cb18-26"><a href="#cb18-26" tabindex="-1"></a><span class="kw">var</span> wrapper <span class="op">=</span> <span class="pp">require</span>(<span class="st">&#39;users/adugnagirma/gee_s1_ard:wrapper&#39;</span>)<span class="op">;</span></span>
<span id="cb18-27"><a href="#cb18-27" tabindex="-1"></a><span class="kw">var</span> helper <span class="op">=</span> <span class="pp">require</span>(<span class="st">&#39;users/adugnagirma/gee_s1_ard:utilities&#39;</span>)<span class="op">;</span></span>
<span id="cb18-28"><a href="#cb18-28" tabindex="-1"></a></span>
<span id="cb18-29"><a href="#cb18-29" tabindex="-1"></a><span class="co">//-----------------------------------------------------------//</span></span>
<span id="cb18-30"><a href="#cb18-30" tabindex="-1"></a><span class="co">// DEFINE PARAMETERS</span></span>
<span id="cb18-31"><a href="#cb18-31" tabindex="-1"></a><span class="co">//-----------------------------------------------------------//</span></span>
<span id="cb18-32"><a href="#cb18-32" tabindex="-1"></a></span>
<span id="cb18-33"><a href="#cb18-33" tabindex="-1"></a><span class="kw">var</span> parameters <span class="op">=</span> {</span>
<span id="cb18-34"><a href="#cb18-34" tabindex="-1"></a>  <span class="co">//1. Data Selection</span></span>
<span id="cb18-35"><a href="#cb18-35" tabindex="-1"></a>  <span class="dt">START_DATE</span><span class="op">:</span> <span class="st">&#39;2018-08-10&#39;</span><span class="op">,</span></span>
<span id="cb18-36"><a href="#cb18-36" tabindex="-1"></a>  <span class="dt">STOP_DATE</span><span class="op">:</span> <span class="st">&#39;2018-08-23&#39;</span><span class="op">,</span></span>
<span id="cb18-37"><a href="#cb18-37" tabindex="-1"></a>  <span class="dt">POLARIZATION</span><span class="op">:</span><span class="st">&#39;VVVH&#39;</span><span class="op">,</span></span>
<span id="cb18-38"><a href="#cb18-38" tabindex="-1"></a>  <span class="dt">ORBIT</span> <span class="op">:</span> <span class="st">&#39;DESCENDING&#39;</span><span class="op">,</span></span>
<span id="cb18-39"><a href="#cb18-39" tabindex="-1"></a>  <span class="dt">GEOMETRY</span><span class="op">:</span> geometry<span class="op">,</span> </span>
<span id="cb18-40"><a href="#cb18-40" tabindex="-1"></a>  </span>
<span id="cb18-41"><a href="#cb18-41" tabindex="-1"></a>  <span class="co">//2. Additional Border noise correction</span></span>
<span id="cb18-42"><a href="#cb18-42" tabindex="-1"></a>  <span class="dt">APPLY_ADDITIONAL_BORDER_NOISE_CORRECTION</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb18-43"><a href="#cb18-43" tabindex="-1"></a>  </span>
<span id="cb18-44"><a href="#cb18-44" tabindex="-1"></a>  <span class="co">//3.Speckle filter</span></span>
<span id="cb18-45"><a href="#cb18-45" tabindex="-1"></a>  <span class="dt">APPLY_SPECKLE_FILTERING</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb18-46"><a href="#cb18-46" tabindex="-1"></a>  <span class="dt">SPECKLE_FILTER_FRAMEWORK</span><span class="op">:</span> <span class="st">&#39;MULTI&#39;</span><span class="op">,</span></span>
<span id="cb18-47"><a href="#cb18-47" tabindex="-1"></a>  <span class="dt">SPECKLE_FILTER</span><span class="op">:</span> <span class="st">&#39;GAMMA MAP&#39;</span><span class="op">,</span></span>
<span id="cb18-48"><a href="#cb18-48" tabindex="-1"></a>  <span class="dt">SPECKLE_FILTER_KERNEL_SIZE</span><span class="op">:</span> <span class="dv">9</span><span class="op">,</span></span>
<span id="cb18-49"><a href="#cb18-49" tabindex="-1"></a>  <span class="dt">SPECKLE_FILTER_NR_OF_IMAGES</span><span class="op">:</span> <span class="dv">10</span><span class="op">,</span></span>
<span id="cb18-50"><a href="#cb18-50" tabindex="-1"></a>  </span>
<span id="cb18-51"><a href="#cb18-51" tabindex="-1"></a>  <span class="co">//4. Radiometric terrain normalization</span></span>
<span id="cb18-52"><a href="#cb18-52" tabindex="-1"></a>  <span class="dt">APPLY_TERRAIN_FLATTENING</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb18-53"><a href="#cb18-53" tabindex="-1"></a>  <span class="dt">DEM</span><span class="op">:</span> ee<span class="op">.</span><span class="fu">Image</span>(<span class="st">&#39;USGS/SRTMGL1_003&#39;</span>)<span class="op">,</span></span>
<span id="cb18-54"><a href="#cb18-54" tabindex="-1"></a>  <span class="dt">TERRAIN_FLATTENING_MODEL</span><span class="op">:</span> <span class="st">&#39;VOLUME&#39;</span><span class="op">,</span></span>
<span id="cb18-55"><a href="#cb18-55" tabindex="-1"></a>  <span class="dt">TERRAIN_FLATTENING_ADDITIONAL_LAYOVER_SHADOW_BUFFER</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb18-56"><a href="#cb18-56" tabindex="-1"></a>  </span>
<span id="cb18-57"><a href="#cb18-57" tabindex="-1"></a>  <span class="co">//5. Output</span></span>
<span id="cb18-58"><a href="#cb18-58" tabindex="-1"></a>  <span class="dt">FORMAT</span> <span class="op">:</span> <span class="st">&#39;DB&#39;</span><span class="op">,</span></span>
<span id="cb18-59"><a href="#cb18-59" tabindex="-1"></a>  <span class="dt">CLIP_TO_ROI</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb18-60"><a href="#cb18-60" tabindex="-1"></a>  <span class="dt">SAVE_ASSETS</span><span class="op">:</span> <span class="kw">false</span></span>
<span id="cb18-61"><a href="#cb18-61" tabindex="-1"></a>}</span>
<span id="cb18-62"><a href="#cb18-62" tabindex="-1"></a></span>
<span id="cb18-63"><a href="#cb18-63" tabindex="-1"></a><span class="co">// Preprocess the S1 collection</span></span>
<span id="cb18-64"><a href="#cb18-64" tabindex="-1"></a><span class="kw">var</span> output <span class="op">=</span> wrapper<span class="op">.</span><span class="fu">s1_preproc</span>(parameters)<span class="op">;</span></span>
<span id="cb18-65"><a href="#cb18-65" tabindex="-1"></a><span class="kw">var</span> s1 <span class="op">=</span> output[<span class="dv">0</span>]</span>
<span id="cb18-66"><a href="#cb18-66" tabindex="-1"></a><span class="kw">var</span> s1_preprocess <span class="op">=</span> output[<span class="dv">1</span>]</span>
<span id="cb18-67"><a href="#cb18-67" tabindex="-1"></a></span>
<span id="cb18-68"><a href="#cb18-68" tabindex="-1"></a><span class="co">// Function to add VV/VH ratio band</span></span>
<span id="cb18-69"><a href="#cb18-69" tabindex="-1"></a><span class="kw">var</span> addRatioBand <span class="op">=</span> <span class="kw">function</span>(image) {</span>
<span id="cb18-70"><a href="#cb18-70" tabindex="-1"></a>  <span class="kw">var</span> ratioBand <span class="op">=</span> image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;VV&#39;</span>)</span>
<span id="cb18-71"><a href="#cb18-71" tabindex="-1"></a>    <span class="op">.</span><span class="fu">divide</span>(image<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;VH&#39;</span>))<span class="op">.</span><span class="fu">rename</span>(<span class="st">&#39;VV/VH&#39;</span>)</span>
<span id="cb18-72"><a href="#cb18-72" tabindex="-1"></a>  <span class="cf">return</span> image<span class="op">.</span><span class="fu">addBands</span>(ratioBand)</span>
<span id="cb18-73"><a href="#cb18-73" tabindex="-1"></a>}</span>
<span id="cb18-74"><a href="#cb18-74" tabindex="-1"></a></span>
<span id="cb18-75"><a href="#cb18-75" tabindex="-1"></a><span class="co">// Convert to DB and Add VV/VH ratio band</span></span>
<span id="cb18-76"><a href="#cb18-76" tabindex="-1"></a><span class="kw">var</span> speckleFiltered <span class="op">=</span> s1_preprocess</span>
<span id="cb18-77"><a href="#cb18-77" tabindex="-1"></a>  <span class="op">.</span><span class="fu">map</span>(helper<span class="op">.</span><span class="at">lin_to_db</span>)</span>
<span id="cb18-78"><a href="#cb18-78" tabindex="-1"></a>  <span class="op">.</span><span class="fu">map</span>(addRatioBand)<span class="op">;</span></span>
<span id="cb18-79"><a href="#cb18-79" tabindex="-1"></a></span>
<span id="cb18-80"><a href="#cb18-80" tabindex="-1"></a><span class="co">// Visualize</span></span>
<span id="cb18-81"><a href="#cb18-81" tabindex="-1"></a><span class="kw">var</span> sarComposite <span class="op">=</span> speckleFiltered<span class="op">.</span><span class="fu">mosaic</span>()<span class="op">.</span><span class="fu">clip</span>(geometry)<span class="op">;</span></span>
<span id="cb18-82"><a href="#cb18-82" tabindex="-1"></a></span>
<span id="cb18-83"><a href="#cb18-83" tabindex="-1"></a><span class="kw">var</span> visParams <span class="op">=</span> {</span>
<span id="cb18-84"><a href="#cb18-84" tabindex="-1"></a>  <span class="dt">bands</span><span class="op">:</span> [<span class="st">&#39;VV&#39;</span><span class="op">,</span> <span class="st">&#39;VH&#39;</span><span class="op">,</span> <span class="st">&#39;VV/VH&#39;</span>]<span class="op">,</span></span>
<span id="cb18-85"><a href="#cb18-85" tabindex="-1"></a>  <span class="dt">min</span><span class="op">:</span>[<span class="op">-</span><span class="dv">25</span><span class="op">,</span> <span class="op">-</span><span class="dv">25</span><span class="op">,</span> <span class="dv">0</span>]<span class="op">,</span></span>
<span id="cb18-86"><a href="#cb18-86" tabindex="-1"></a>  <span class="dt">max</span><span class="op">:</span>[<span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">2</span>]</span>
<span id="cb18-87"><a href="#cb18-87" tabindex="-1"></a>}</span>
<span id="cb18-88"><a href="#cb18-88" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(sarComposite<span class="op">,</span> visParams<span class="op">,</span> <span class="st">&#39;SAR RGB Visualization&#39;</span>)<span class="op">;</span> </span></code></pre></div>
</div>
<div id="sar-water-detection" class="section level2">
<h2>SAR Water Detection</h2>
<p><a
href="https://code.earthengine.google.co.in/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3ASupplement%2FSAR%2FSAR_Water_Detection"
target="_blank">Open in Code Editor ↗</a></p>
<div class="sourceCode" id="cb19"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb19-1"><a href="#cb19-1" tabindex="-1"></a><span class="co">// Script showing how to use Sentinel-1 data and</span></span>
<span id="cb19-2"><a href="#cb19-2" tabindex="-1"></a><span class="co">// static thresholding for water detection</span></span>
<span id="cb19-3"><a href="#cb19-3" tabindex="-1"></a></span>
<span id="cb19-4"><a href="#cb19-4" tabindex="-1"></a><span class="kw">var</span> hydrobasins <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">&quot;WWF/HydroSHEDS/v1/Basins/hybas_7&quot;</span>)<span class="op">;</span></span>
<span id="cb19-5"><a href="#cb19-5" tabindex="-1"></a><span class="kw">var</span> basin <span class="op">=</span> hydrobasins<span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">eq</span>(<span class="st">&#39;HYBAS_ID&#39;</span><span class="op">,</span> <span class="dv">4071139640</span>))<span class="op">;</span></span>
<span id="cb19-6"><a href="#cb19-6" tabindex="-1"></a><span class="kw">var</span> geometry <span class="op">=</span> basin<span class="op">.</span><span class="fu">geometry</span>()<span class="op">;</span></span>
<span id="cb19-7"><a href="#cb19-7" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(basin<span class="op">,</span> {<span class="dt">color</span><span class="op">:</span> <span class="st">&#39;grey&#39;</span>}<span class="op">,</span> <span class="st">&#39;Arkavathy Sub Basin&#39;</span>)</span>
<span id="cb19-8"><a href="#cb19-8" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">centerObject</span>(geometry<span class="op">,</span> <span class="dv">12</span>)<span class="op">;</span></span>
<span id="cb19-9"><a href="#cb19-9" tabindex="-1"></a></span>
<span id="cb19-10"><a href="#cb19-10" tabindex="-1"></a></span>
<span id="cb19-11"><a href="#cb19-11" tabindex="-1"></a><span class="co">// Use Sentinel-1 ARD Pre-Processing</span></span>
<span id="cb19-12"><a href="#cb19-12" tabindex="-1"></a><span class="co">// See https://github.com/adugnag/gee_s1_ard/</span></span>
<span id="cb19-13"><a href="#cb19-13" tabindex="-1"></a><span class="kw">var</span> wrapper <span class="op">=</span> <span class="pp">require</span>(<span class="st">&#39;users/adugnagirma/gee_s1_ard:wrapper&#39;</span>)<span class="op">;</span></span>
<span id="cb19-14"><a href="#cb19-14" tabindex="-1"></a><span class="kw">var</span> helper <span class="op">=</span> <span class="pp">require</span>(<span class="st">&#39;users/adugnagirma/gee_s1_ard:utilities&#39;</span>)<span class="op">;</span></span>
<span id="cb19-15"><a href="#cb19-15" tabindex="-1"></a></span>
<span id="cb19-16"><a href="#cb19-16" tabindex="-1"></a></span>
<span id="cb19-17"><a href="#cb19-17" tabindex="-1"></a><span class="kw">var</span> parameters <span class="op">=</span> {</span>
<span id="cb19-18"><a href="#cb19-18" tabindex="-1"></a>  <span class="co">// Input</span></span>
<span id="cb19-19"><a href="#cb19-19" tabindex="-1"></a>  <span class="dt">START_DATE</span><span class="op">:</span> <span class="st">&#39;2019-01-01&#39;</span><span class="op">,</span></span>
<span id="cb19-20"><a href="#cb19-20" tabindex="-1"></a>  <span class="dt">STOP_DATE</span><span class="op">:</span> <span class="st">&#39;2020-01-01&#39;</span><span class="op">,</span></span>
<span id="cb19-21"><a href="#cb19-21" tabindex="-1"></a>  <span class="dt">POLARIZATION</span><span class="op">:</span><span class="st">&#39;VVVH&#39;</span><span class="op">,</span></span>
<span id="cb19-22"><a href="#cb19-22" tabindex="-1"></a>  <span class="dt">ORBIT</span> <span class="op">:</span> <span class="st">&#39;DESCENDING&#39;</span><span class="op">,</span></span>
<span id="cb19-23"><a href="#cb19-23" tabindex="-1"></a>  <span class="dt">GEOMETRY</span><span class="op">:</span> geometry<span class="op">,</span> </span>
<span id="cb19-24"><a href="#cb19-24" tabindex="-1"></a></span>
<span id="cb19-25"><a href="#cb19-25" tabindex="-1"></a>  <span class="co">// Speckle filter</span></span>
<span id="cb19-26"><a href="#cb19-26" tabindex="-1"></a>  <span class="dt">APPLY_SPECKLE_FILTERING</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb19-27"><a href="#cb19-27" tabindex="-1"></a>  <span class="dt">SPECKLE_FILTER_FRAMEWORK</span><span class="op">:</span> <span class="st">&#39;MONO&#39;</span><span class="op">,</span></span>
<span id="cb19-28"><a href="#cb19-28" tabindex="-1"></a>  <span class="dt">SPECKLE_FILTER</span><span class="op">:</span> <span class="st">&#39;REFINED LEE&#39;</span><span class="op">,</span></span>
<span id="cb19-29"><a href="#cb19-29" tabindex="-1"></a></span>
<span id="cb19-30"><a href="#cb19-30" tabindex="-1"></a>  <span class="co">// Output</span></span>
<span id="cb19-31"><a href="#cb19-31" tabindex="-1"></a>  <span class="dt">FORMAT</span> <span class="op">:</span> <span class="st">&#39;DB&#39;</span><span class="op">,</span></span>
<span id="cb19-32"><a href="#cb19-32" tabindex="-1"></a>  <span class="dt">CLIP_TO_ROI</span><span class="op">:</span> <span class="kw">true</span><span class="op">,</span></span>
<span id="cb19-33"><a href="#cb19-33" tabindex="-1"></a>  <span class="dt">SAVE_ASSETS</span><span class="op">:</span> <span class="kw">false</span></span>
<span id="cb19-34"><a href="#cb19-34" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb19-35"><a href="#cb19-35" tabindex="-1"></a></span>
<span id="cb19-36"><a href="#cb19-36" tabindex="-1"></a><span class="co">// Preprocess the S1 collection</span></span>
<span id="cb19-37"><a href="#cb19-37" tabindex="-1"></a><span class="kw">var</span> output <span class="op">=</span> wrapper<span class="op">.</span><span class="fu">s1_preproc</span>(parameters)<span class="op">;</span></span>
<span id="cb19-38"><a href="#cb19-38" tabindex="-1"></a><span class="kw">var</span> s1 <span class="op">=</span> output[<span class="dv">0</span>]<span class="op">;</span></span>
<span id="cb19-39"><a href="#cb19-39" tabindex="-1"></a><span class="kw">var</span> s1_preprocess <span class="op">=</span> output[<span class="dv">1</span>]<span class="op">;</span></span>
<span id="cb19-40"><a href="#cb19-40" tabindex="-1"></a></span>
<span id="cb19-41"><a href="#cb19-41" tabindex="-1"></a><span class="co">// Convert to DB</span></span>
<span id="cb19-42"><a href="#cb19-42" tabindex="-1"></a><span class="kw">var</span> speckleFiltered <span class="op">=</span> s1_preprocess</span>
<span id="cb19-43"><a href="#cb19-43" tabindex="-1"></a>  <span class="op">.</span><span class="fu">map</span>(helper<span class="op">.</span><span class="at">lin_to_db</span>)<span class="op">;</span></span>
<span id="cb19-44"><a href="#cb19-44" tabindex="-1"></a></span>
<span id="cb19-45"><a href="#cb19-45" tabindex="-1"></a><span class="co">// Mean is preferred for SAR data</span></span>
<span id="cb19-46"><a href="#cb19-46" tabindex="-1"></a><span class="kw">var</span> sarComposite <span class="op">=</span> speckleFiltered<span class="op">.</span><span class="fu">mean</span>()<span class="op">.</span><span class="fu">select</span>(<span class="st">&#39;VH&#39;</span>)<span class="op">;</span></span>
<span id="cb19-47"><a href="#cb19-47" tabindex="-1"></a><span class="kw">var</span> threshold <span class="op">=</span> <span class="op">-</span><span class="dv">25</span><span class="op">;</span></span>
<span id="cb19-48"><a href="#cb19-48" tabindex="-1"></a><span class="kw">var</span> sarWater <span class="op">=</span> sarComposite<span class="op">.</span><span class="fu">lt</span>(threshold)<span class="op">;</span></span>
<span id="cb19-49"><a href="#cb19-49" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(sarWater<span class="op">.</span><span class="fu">clip</span>(geometry)<span class="op">.</span><span class="fu">selfMask</span>()<span class="op">,</span> {<span class="dt">min</span><span class="op">:</span><span class="dv">0</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span><span class="dv">1</span><span class="op">,</span> <span class="dt">palette</span><span class="op">:</span> [<span class="st">&#39;blue&#39;</span>]}<span class="op">,</span> <span class="st">&#39;Water&#39;</span>)</span></code></pre></div>
</div>
</div>
<div id="time-series-analysis" class="section level1">
<h1>Time Series Analysis</h1>
<div id="mann-kendall-test" class="section level2">
<h2>Mann Kendall Test</h2>
<p><a
href="https://code.earthengine.google.com/?scriptPath=users%2Fujavalgandhi%2FGEE-Water-Resources-Management%3ASupplement%2FTime_Series_Analysis%2FMann_Kendall_Test"
target="_blank">Open in Code Editor ↗</a></p>
<div class="sourceCode" id="cb20"><pre
class="sourceCode js"><code class="sourceCode javascript"><span id="cb20-1"><a href="#cb20-1" tabindex="-1"></a><span class="kw">var</span> taluks <span class="op">=</span> ee<span class="op">.</span><span class="fu">FeatureCollection</span>(<span class="st">&quot;users/ujavalgandhi/gee-water-resources/kgis_taluks&quot;</span>)<span class="op">;</span></span>
<span id="cb20-2"><a href="#cb20-2" tabindex="-1"></a><span class="kw">var</span> chirps <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(<span class="st">&#39;UCSB-CHG/CHIRPS/PENTAD&#39;</span>)</span>
<span id="cb20-3"><a href="#cb20-3" tabindex="-1"></a></span>
<span id="cb20-4"><a href="#cb20-4" tabindex="-1"></a></span>
<span id="cb20-5"><a href="#cb20-5" tabindex="-1"></a><span class="co">// We will compute the trend of total seasonal rainfall</span></span>
<span id="cb20-6"><a href="#cb20-6" tabindex="-1"></a></span>
<span id="cb20-7"><a href="#cb20-7" tabindex="-1"></a><span class="co">// Introducting calendarRange()</span></span>
<span id="cb20-8"><a href="#cb20-8" tabindex="-1"></a><span class="kw">var</span> julyImages <span class="op">=</span> chirps</span>
<span id="cb20-9"><a href="#cb20-9" tabindex="-1"></a>  <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">calendarRange</span>(<span class="dv">7</span><span class="op">,</span> <span class="dv">7</span><span class="op">,</span> <span class="st">&#39;month&#39;</span>))</span>
<span id="cb20-10"><a href="#cb20-10" tabindex="-1"></a><span class="fu">print</span>(julyImages)</span>
<span id="cb20-11"><a href="#cb20-11" tabindex="-1"></a></span>
<span id="cb20-12"><a href="#cb20-12" tabindex="-1"></a><span class="co">// Rainy season is June - September</span></span>
<span id="cb20-13"><a href="#cb20-13" tabindex="-1"></a><span class="kw">var</span> createSeasonalImage <span class="op">=</span> <span class="kw">function</span>(year) {</span>
<span id="cb20-14"><a href="#cb20-14" tabindex="-1"></a>  <span class="kw">var</span> startDate <span class="op">=</span> ee<span class="op">.</span><span class="at">Date</span><span class="op">.</span><span class="fu">fromYMD</span>(year<span class="op">,</span> <span class="dv">6</span><span class="op">,</span> <span class="dv">1</span>)</span>
<span id="cb20-15"><a href="#cb20-15" tabindex="-1"></a>  <span class="kw">var</span> endDate <span class="op">=</span> ee<span class="op">.</span><span class="at">Date</span><span class="op">.</span><span class="fu">fromYMD</span>(year<span class="op">,</span> <span class="dv">9</span><span class="op">,</span> <span class="dv">30</span>)</span>
<span id="cb20-16"><a href="#cb20-16" tabindex="-1"></a>  <span class="kw">var</span> seasonFiltered <span class="op">=</span> chirps</span>
<span id="cb20-17"><a href="#cb20-17" tabindex="-1"></a>    <span class="op">.</span><span class="fu">filter</span>(ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">date</span>(startDate<span class="op">,</span> endDate))</span>
<span id="cb20-18"><a href="#cb20-18" tabindex="-1"></a>  <span class="co">// Calculate total precipitation</span></span>
<span id="cb20-19"><a href="#cb20-19" tabindex="-1"></a>  <span class="kw">var</span> total <span class="op">=</span> seasonFiltered<span class="op">.</span><span class="fu">reduce</span>(ee<span class="op">.</span><span class="at">Reducer</span><span class="op">.</span><span class="fu">sum</span>())</span>
<span id="cb20-20"><a href="#cb20-20" tabindex="-1"></a>  <span class="cf">return</span> total<span class="op">.</span><span class="fu">set</span>({</span>
<span id="cb20-21"><a href="#cb20-21" tabindex="-1"></a>    <span class="st">&#39;system:time_start&#39;</span><span class="op">:</span> startDate<span class="op">.</span><span class="fu">millis</span>()<span class="op">,</span></span>
<span id="cb20-22"><a href="#cb20-22" tabindex="-1"></a>    <span class="st">&#39;system:time_end&#39;</span><span class="op">:</span> endDate<span class="op">.</span><span class="fu">millis</span>()<span class="op">,</span></span>
<span id="cb20-23"><a href="#cb20-23" tabindex="-1"></a>    <span class="st">&#39;year&#39;</span><span class="op">:</span> year<span class="op">,</span></span>
<span id="cb20-24"><a href="#cb20-24" tabindex="-1"></a>  })</span>
<span id="cb20-25"><a href="#cb20-25" tabindex="-1"></a>}</span>
<span id="cb20-26"><a href="#cb20-26" tabindex="-1"></a></span>
<span id="cb20-27"><a href="#cb20-27" tabindex="-1"></a></span>
<span id="cb20-28"><a href="#cb20-28" tabindex="-1"></a></span>
<span id="cb20-29"><a href="#cb20-29" tabindex="-1"></a><span class="co">// Aggregate Precipitation Data to get Annual Time-Series</span></span>
<span id="cb20-30"><a href="#cb20-30" tabindex="-1"></a><span class="kw">var</span> years <span class="op">=</span> ee<span class="op">.</span><span class="at">List</span><span class="op">.</span><span class="fu">sequence</span>(<span class="dv">1981</span><span class="op">,</span> <span class="dv">2013</span>)</span>
<span id="cb20-31"><a href="#cb20-31" tabindex="-1"></a><span class="kw">var</span> yearlyImages <span class="op">=</span> years<span class="op">.</span><span class="fu">map</span>(createSeasonalImage)</span>
<span id="cb20-32"><a href="#cb20-32" tabindex="-1"></a><span class="fu">print</span>(yearlyImages)</span>
<span id="cb20-33"><a href="#cb20-33" tabindex="-1"></a></span>
<span id="cb20-34"><a href="#cb20-34" tabindex="-1"></a><span class="kw">var</span> yearlyCol <span class="op">=</span> ee<span class="op">.</span><span class="at">ImageCollection</span><span class="op">.</span><span class="fu">fromImages</span>(yearlyImages)</span>
<span id="cb20-35"><a href="#cb20-35" tabindex="-1"></a></span>
<span id="cb20-36"><a href="#cb20-36" tabindex="-1"></a></span>
<span id="cb20-37"><a href="#cb20-37" tabindex="-1"></a><span class="co">// Join the time series to itself</span></span>
<span id="cb20-38"><a href="#cb20-38" tabindex="-1"></a><span class="kw">var</span> afterFilter <span class="op">=</span> ee<span class="op">.</span><span class="at">Filter</span><span class="op">.</span><span class="fu">lessThan</span>({</span>
<span id="cb20-39"><a href="#cb20-39" tabindex="-1"></a>  <span class="dt">leftField</span><span class="op">:</span> <span class="st">&#39;system:time_start&#39;</span><span class="op">,</span></span>
<span id="cb20-40"><a href="#cb20-40" tabindex="-1"></a>  <span class="dt">rightField</span><span class="op">:</span> <span class="st">&#39;system:time_start&#39;</span></span>
<span id="cb20-41"><a href="#cb20-41" tabindex="-1"></a>})<span class="op">;</span></span>
<span id="cb20-42"><a href="#cb20-42" tabindex="-1"></a></span>
<span id="cb20-43"><a href="#cb20-43" tabindex="-1"></a><span class="kw">var</span> joined <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(ee<span class="op">.</span><span class="at">Join</span><span class="op">.</span><span class="fu">saveAll</span>(<span class="st">&#39;after&#39;</span>)<span class="op">.</span><span class="fu">apply</span>({</span>
<span id="cb20-44"><a href="#cb20-44" tabindex="-1"></a>  <span class="dt">primary</span><span class="op">:</span> yearlyCol<span class="op">,</span></span>
<span id="cb20-45"><a href="#cb20-45" tabindex="-1"></a>  <span class="dt">secondary</span><span class="op">:</span> yearlyCol<span class="op">,</span></span>
<span id="cb20-46"><a href="#cb20-46" tabindex="-1"></a>  <span class="dt">condition</span><span class="op">:</span> afterFilter</span>
<span id="cb20-47"><a href="#cb20-47" tabindex="-1"></a>}))<span class="op">;</span></span>
<span id="cb20-48"><a href="#cb20-48" tabindex="-1"></a><span class="fu">print</span>(joined)</span>
<span id="cb20-49"><a href="#cb20-49" tabindex="-1"></a></span>
<span id="cb20-50"><a href="#cb20-50" tabindex="-1"></a><span class="co">// Mann-Kendall trend test</span></span>
<span id="cb20-51"><a href="#cb20-51" tabindex="-1"></a><span class="kw">var</span> sign <span class="op">=</span> <span class="kw">function</span>(i<span class="op">,</span> j) { <span class="co">// i and j are images</span></span>
<span id="cb20-52"><a href="#cb20-52" tabindex="-1"></a>  <span class="cf">return</span> ee<span class="op">.</span><span class="fu">Image</span>(j)<span class="op">.</span><span class="fu">neq</span>(i) <span class="co">// Zero case</span></span>
<span id="cb20-53"><a href="#cb20-53" tabindex="-1"></a>      <span class="op">.</span><span class="fu">multiply</span>(ee<span class="op">.</span><span class="fu">Image</span>(j)<span class="op">.</span><span class="fu">subtract</span>(i)<span class="op">.</span><span class="fu">clamp</span>(<span class="op">-</span><span class="dv">1</span><span class="op">,</span> <span class="dv">1</span>))<span class="op">.</span><span class="fu">int</span>()<span class="op">;</span></span>
<span id="cb20-54"><a href="#cb20-54" tabindex="-1"></a>}<span class="op">;</span></span>
<span id="cb20-55"><a href="#cb20-55" tabindex="-1"></a></span>
<span id="cb20-56"><a href="#cb20-56" tabindex="-1"></a><span class="kw">var</span> kendall <span class="op">=</span> ee<span class="op">.</span><span class="fu">ImageCollection</span>(joined<span class="op">.</span><span class="fu">map</span>(<span class="kw">function</span>(current) {</span>
<span id="cb20-57"><a href="#cb20-57" tabindex="-1"></a>  <span class="kw">var</span> afterCollection <span class="op">=</span> ee<span class="op">.</span><span class="at">ImageCollection</span><span class="op">.</span><span class="fu">fromImages</span>(current<span class="op">.</span><span class="fu">get</span>(<span class="st">&#39;after&#39;</span>))<span class="op">;</span></span>
<span id="cb20-58"><a href="#cb20-58" tabindex="-1"></a>  <span class="cf">return</span> afterCollection<span class="op">.</span><span class="fu">map</span>(<span class="kw">function</span>(image) {</span>
<span id="cb20-59"><a href="#cb20-59" tabindex="-1"></a>    <span class="co">// The unmask is to prevent accumulation of masked pixels that</span></span>
<span id="cb20-60"><a href="#cb20-60" tabindex="-1"></a>    <span class="co">// result from the undefined case of when either current or image</span></span>
<span id="cb20-61"><a href="#cb20-61" tabindex="-1"></a>    <span class="co">// is masked.  It won&#39;t affect the sum, since it&#39;s unmasked to zero.</span></span>
<span id="cb20-62"><a href="#cb20-62" tabindex="-1"></a>    <span class="cf">return</span> ee<span class="op">.</span><span class="fu">Image</span>(<span class="fu">sign</span>(current<span class="op">,</span> image))<span class="op">.</span><span class="fu">unmask</span>(<span class="dv">0</span>)<span class="op">;</span></span>
<span id="cb20-63"><a href="#cb20-63" tabindex="-1"></a>  })<span class="op">;</span></span>
<span id="cb20-64"><a href="#cb20-64" tabindex="-1"></a>  <span class="co">// Set parallelScale to avoid User memory limit exceeded.</span></span>
<span id="cb20-65"><a href="#cb20-65" tabindex="-1"></a>})<span class="op">.</span><span class="fu">flatten</span>())<span class="op">.</span><span class="fu">reduce</span>(<span class="st">&#39;sum&#39;</span><span class="op">,</span> <span class="dv">2</span>)<span class="op">;</span></span>
<span id="cb20-66"><a href="#cb20-66" tabindex="-1"></a></span>
<span id="cb20-67"><a href="#cb20-67" tabindex="-1"></a><span class="kw">var</span> palette <span class="op">=</span> [<span class="st">&#39;red&#39;</span><span class="op">,</span> <span class="st">&#39;white&#39;</span><span class="op">,</span> <span class="st">&#39;green&#39;</span>]<span class="op">;</span></span>
<span id="cb20-68"><a href="#cb20-68" tabindex="-1"></a><span class="co">// Stretch this as necessary.</span></span>
<span id="cb20-69"><a href="#cb20-69" tabindex="-1"></a><span class="bu">Map</span><span class="op">.</span><span class="fu">addLayer</span>(kendall<span class="op">,</span> {<span class="dt">min</span><span class="op">:-</span><span class="dv">30</span><span class="op">,</span> <span class="dt">max</span><span class="op">:</span> <span class="dv">30</span><span class="op">,</span> <span class="dt">palette</span><span class="op">:</span> palette}<span class="op">,</span> <span class="st">&#39;kendall&#39;</span>)<span class="op">;</span> </span></code></pre></div>
</div>
</div>
<div id="license" class="section level1">
<h1>License</h1>
<p>The course material (text, images, presentation, videos) is licensed
under a <a href="https://creativecommons.org/licenses/by/4.0/">Creative
Commons Attribution 4.0 International License</a>.</p>
<p>The code (scripts, Jupyter notebooks) is licensed under the MIT
License. For a copy, see <a href="https://opensource.org/licenses/MIT"
class="uri">https://opensource.org/licenses/MIT</a></p>
<p>Kindly give appropriate credit to the original author as below:</p>
<p>Copyright © 2021 Ujaval Gandhi <a
href="https://spatialthoughts.com">www.spatialthoughts.com</a></p>
</div>
<div id="citing-and-referencing" class="section level1">
<h1>Citing and Referencing</h1>
<p>You can cite the course materials as follows</p>
<ul>
<li>Gandhi, Ujaval, 2021. <em>Google Earth Engine for Water Resources
Management</em> Course. Spatial Thoughts. <a
href="https://courses.spatialthoughts.com/gee-water-resources-management.html"
class="uri">https://courses.spatialthoughts.com/gee-water-resources-management.html</a></li>
</ul>
<hr />
<p><strong>This course is offered as an instructor-led online class.
Visit <a href="https://spatialthoughts.com/events/">Spatial Thoughts</a>
to know details of upcoming sessions.</strong></p>
</div>

<!-- Comment Section Powered by utterances -->
<div id="comments">
  <hr />
  <p>If you want to report any issues with this page, please comment below.</p>
<script src="https://utteranc.es/client.js"
        repo="spatialthoughts/courses"
        issue-term="title"
        label="comment"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>
</div>



</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.odd').parent('tbody').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open');
  });
});
</script>

<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
