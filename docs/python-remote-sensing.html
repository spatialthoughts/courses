<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />


<meta name="author" content="Ujaval Gandhi" />


<title>Cloud-based Remote Sensing with Python (Full Course)</title>

<script src="site_libs/header-attrs-2.29/header-attrs.js"></script>
<script src="site_libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/flatly.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<style>h1 {font-size: 34px;}
       h1.title {font-size: 38px;}
       h2 {font-size: 30px;}
       h3 {font-size: 24px;}
       h4 {font-size: 18px;}
       h5 {font-size: 16px;}
       h6 {font-size: 12px;}
       code {color: inherit; background-color: rgba(0, 0, 0, 0.04);}
       pre:not([class]) { background-color: white }</style>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<link href="site_libs/pagedtable-1.1/css/pagedtable.css" rel="stylesheet" />
<script src="site_libs/pagedtable-1.1/js/pagedtable.js"></script>
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-PDGF11RK4Z"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-PDGF11RK4Z');
</script>

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>



<style type="text/css">
  code {
    white-space: pre;
  }
  .sourceCode {
    overflow: visible;
  }
</style>
<style type="text/css" data-origin="pandoc">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */

</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    var j = 0;
    while (j < rules.length) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") {
        j++;
        continue;
      }
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') {
        j++;
        continue;
      }
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>







<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
details > summary > p:only-child {
  display: inline;
}
pre code {
  padding: 0;
}
</style>


<style type="text/css">
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #adb5bd;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script type="text/javascript">
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark the anchor link active (and if it's in a dropdown, also mark that active)
  var dropdown = menuAnchor.closest('li.dropdown');
  if (window.bootstrap) { // Bootstrap 4+
    menuAnchor.addClass('active');
    dropdown.find('> .dropdown-toggle').addClass('active');
  } else { // Bootstrap 3
    menuAnchor.parent().addClass('active');
    dropdown.addClass('active');
  }

  // Navbar adjustments
  var navHeight = $(".navbar").first().height() + 15;
  var style = document.createElement('style');
  var pt = "padding-top: " + navHeight + "px; ";
  var mt = "margin-top: -" + navHeight + "px; ";
  var css = "";
  // offset scroll position for anchor links (for fixed navbar)
  for (var i = 1; i <= 6; i++) {
    css += ".section h" + i + "{ " + pt + mt + "}\n";
  }
  style.innerHTML = "body {" + pt + "padding-bottom: 40px; }\n" + css;
  document.head.appendChild(style);
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before, .tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "\e259";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "\e258";
  font-family: 'Glyphicons Halflings';
  border: none;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->




</head>

<body>


<div class="container-fluid main-container">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-bs-toggle="collapse" data-target="#navbar" data-bs-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">Courses</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="http://spatialthoughts.com">Back to Main Site</a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li>
  <a href="#">Back to Top</a>
</li>
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div id="header">



<h1 class="title toc-ignore">Cloud-based Remote Sensing with Python
(Full Course)</h1>
<h3 class="subtitle">A guide to working with Earth Observation datasets
using XArray, Dask and STAC.</h3>
<h4 class="author">Ujaval Gandhi</h4>

</div>

<div id="TOC">
<ul>
<li><a href="#introduction" id="toc-introduction">Introduction</a></li>
<li><a href="#learning-xarray" id="toc-learning-xarray">1. Learning
XArray</a>
<ul>
<li><a href="#computing-indices" id="toc-computing-indices">Computing
Indices</a></li>
<li><a href="#cloud-masking" id="toc-cloud-masking">Cloud
Masking</a></li>
<li><a href="#extracting-time-series"
id="toc-extracting-time-series">Extracting Time Series</a></li>
<li><a href="#processing-time-series"
id="toc-processing-time-series">Processing Time-Series</a></li>
</ul></li>
<li><a href="#scaling-computation-with-dask"
id="toc-scaling-computation-with-dask">2. Scaling Computation with
Dask</a>
<ul>
<li><a href="#calculating-zonal-statistics"
id="toc-calculating-zonal-statistics">Calculating Zonal
Statistics</a></li>
</ul></li>
<li><a href="#license" id="toc-license">License</a></li>
</ul>
</div>

<div style="page-break-after: always;"></div>
<hr />
<p><img src="images/spatial_thoughts_logo.png" width="250pt" style="display: block; margin: auto;" /></p>
<hr />
<blockquote>
<p>Note: This course is under active development and not complete
yet!</p>
</blockquote>
<div style="page-break-after: always;"></div>
<div id="introduction" class="section level1">
<h1>Introduction</h1>
<p>This is an advanced-level course that teaches you how to use
open-source Python libraries to process earth observation dataset using
cloud and parallel-computing technologies. We have designed this course
to help you build the required skills in a structured way and offer
flexibility in where your data is stored and how it is processed.</p>
<div style="page-break-after: always;"></div>
</div>
<div id="learning-xarray" class="section level1">
<h1>1. Learning XArray</h1>
<p><a href="https://docs.xarray.dev/en/stable/"><code>XArray</code></a>
has emerged as one of the key Python libraries to work with gridded
raster datasets. It can natively handle time-series data making it ideal
for working with Remote Sensing datasets. It builds on NumPy/Pandas for
fast arrays/indexing and is orders of magnitude faster than other Python
libraries like <code>rasterio</code>. It has a growing ecosystem of
extensions <code>rioxarray</code>, <code>xarray-spatial</code>,
<code>XEE</code> and more allowing it to be used for geospatial
analysis. In this section, we will learn the fundamentals of XArray with
a focus on earth observation data processing. XArray offers the
flexibility to seamlessly work with local datasets along with
cloud-hosted datasets in a variety of optimized data formats.</p>
<div id="computing-indices" class="section level2">
<h2>Computing Indices</h2>
<p><a
href="https://colab.research.google.com/github/spatialthoughts/courses/blob/master/code/python_remote_sensing/computing_indices.ipynb"><img
src="https://colab.research.google.com/assets/colab-badge.svg"
alt="Open In Colab" /></a></p>
<div id="overview" class="section level3">
<h3>Overview</h3>
<p>In this section, we will take a single Sentinel-2 L1C scene
downloaded from the <a
href="https://dataspace.copernicus.eu/">Copernicus Browser</a> and learn
how to read it using XArray, visualize it and compute spectral
indices.</p>
</div>
<div id="setup-and-data-download" class="section level3">
<h3>Setup and Data Download</h3>
<p>The following blocks of code will install the required packages and
download the datasets to your Colab environment.</p>
<div class="sourceCode" id="cb1"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="op">%%</span>capture</span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a><span class="cf">if</span> <span class="st">&#39;google.colab&#39;</span> <span class="kw">in</span> <span class="bu">str</span>(get_ipython()):</span>
<span id="cb1-3"><a href="#cb1-3" tabindex="-1"></a>  <span class="op">!</span>pip install rioxarray</span>
<span id="cb1-4"><a href="#cb1-4" tabindex="-1"></a>  <span class="op">!</span>pip install jupyter<span class="op">-</span>server<span class="op">-</span>proxy</span></code></pre></div>
<div class="sourceCode" id="cb2"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb2-2"><a href="#cb2-2" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb2-3"><a href="#cb2-3" tabindex="-1"></a><span class="im">import</span> xarray <span class="im">as</span> xr</span>
<span id="cb2-4"><a href="#cb2-4" tabindex="-1"></a><span class="im">import</span> rioxarray <span class="im">as</span> rxr</span>
<span id="cb2-5"><a href="#cb2-5" tabindex="-1"></a><span class="im">import</span> zipfile</span>
<span id="cb2-6"><a href="#cb2-6" tabindex="-1"></a><span class="im">import</span> geopandas <span class="im">as</span> gpd</span></code></pre></div>
<div class="sourceCode" id="cb3"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a><span class="im">from</span> dask.distributed <span class="im">import</span> Client</span>
<span id="cb3-2"><a href="#cb3-2" tabindex="-1"></a>client <span class="op">=</span> Client()  <span class="co"># set up local cluster on the machine</span></span>
<span id="cb3-3"><a href="#cb3-3" tabindex="-1"></a>client</span></code></pre></div>
<div class="sourceCode" id="cb4"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a>data_folder <span class="op">=</span> <span class="st">&#39;data&#39;</span></span>
<span id="cb4-2"><a href="#cb4-2" tabindex="-1"></a>output_folder <span class="op">=</span> <span class="st">&#39;output&#39;</span></span>
<span id="cb4-3"><a href="#cb4-3" tabindex="-1"></a></span>
<span id="cb4-4"><a href="#cb4-4" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> os.path.exists(data_folder):</span>
<span id="cb4-5"><a href="#cb4-5" tabindex="-1"></a>    os.mkdir(data_folder)</span>
<span id="cb4-6"><a href="#cb4-6" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> os.path.exists(output_folder):</span>
<span id="cb4-7"><a href="#cb4-7" tabindex="-1"></a>    os.mkdir(output_folder)</span></code></pre></div>
<div class="sourceCode" id="cb5"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a><span class="kw">def</span> download(url):</span>
<span id="cb5-2"><a href="#cb5-2" tabindex="-1"></a>    filename <span class="op">=</span> os.path.join(data_folder, os.path.basename(url))</span>
<span id="cb5-3"><a href="#cb5-3" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> os.path.exists(filename):</span>
<span id="cb5-4"><a href="#cb5-4" tabindex="-1"></a>        <span class="im">from</span> urllib.request <span class="im">import</span> urlretrieve</span>
<span id="cb5-5"><a href="#cb5-5" tabindex="-1"></a>        local, _ <span class="op">=</span> urlretrieve(url, filename)</span>
<span id="cb5-6"><a href="#cb5-6" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&#39;Downloaded &#39;</span> <span class="op">+</span> local)</span>
<span id="cb5-7"><a href="#cb5-7" tabindex="-1"></a></span>
<span id="cb5-8"><a href="#cb5-8" tabindex="-1"></a>s2_scene <span class="op">=</span> <span class="st">&#39;S2A_MSIL1C_20230212T050931_N0509_R019_T43PGQ_20230212T065641.SAFE.zip&#39;</span></span>
<span id="cb5-9"><a href="#cb5-9" tabindex="-1"></a>data_url <span class="op">=</span> <span class="st">&#39;https://storage.googleapis.com/spatialthoughts-public-data/&#39;</span></span>
<span id="cb5-10"><a href="#cb5-10" tabindex="-1"></a></span>
<span id="cb5-11"><a href="#cb5-11" tabindex="-1"></a>download(data_url <span class="op">+</span> <span class="st">&#39;s2/&#39;</span> <span class="op">+</span> s2_scene)</span>
<span id="cb5-12"><a href="#cb5-12" tabindex="-1"></a></span>
<span id="cb5-13"><a href="#cb5-13" tabindex="-1"></a>aoi <span class="op">=</span> <span class="st">&#39;bangalore.geojson&#39;</span></span>
<span id="cb5-14"><a href="#cb5-14" tabindex="-1"></a>download(data_url <span class="op">+</span> aoi)</span></code></pre></div>
</div>
<div id="data-pre-processing" class="section level3">
<h3>Data Pre-Processing</h3>
<p>We first unzip the zip archive and create a XArray Dataset from the
individual band images.</p>
<div class="sourceCode" id="cb6"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a>s2_filepath <span class="op">=</span> os.path.join(data_folder, s2_scene)</span>
<span id="cb6-2"><a href="#cb6-2" tabindex="-1"></a></span>
<span id="cb6-3"><a href="#cb6-3" tabindex="-1"></a><span class="cf">with</span> zipfile.ZipFile(s2_filepath) <span class="im">as</span> zf:</span>
<span id="cb6-4"><a href="#cb6-4" tabindex="-1"></a>  zf.extractall(data_folder)</span></code></pre></div>
<p>Sentinel-2 images come as individual JPEG2000 rasters for each band.
The image files are located in the
<code>GRANULE/{SCENE_ID}/IMG_DATA/</code> subfolder. We find the files
and read them using <code>rioxarray</code>.</p>
<div class="sourceCode" id="cb7"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a><span class="im">import</span> glob</span>
<span id="cb7-2"><a href="#cb7-2" tabindex="-1"></a>s2_folder <span class="op">=</span> s2_filepath[:<span class="op">-</span><span class="dv">4</span>]</span>
<span id="cb7-3"><a href="#cb7-3" tabindex="-1"></a></span>
<span id="cb7-4"><a href="#cb7-4" tabindex="-1"></a>band_files <span class="op">=</span> {}</span>
<span id="cb7-5"><a href="#cb7-5" tabindex="-1"></a></span>
<span id="cb7-6"><a href="#cb7-6" tabindex="-1"></a><span class="cf">for</span> filepath <span class="kw">in</span> glob.glob(</span>
<span id="cb7-7"><a href="#cb7-7" tabindex="-1"></a>    os.path.join(s2_folder, <span class="st">&#39;GRANULE&#39;</span>, <span class="st">&#39;*&#39;</span>, <span class="st">&#39;IMG_DATA&#39;</span>, <span class="st">&#39;*B*.jp2&#39;</span>)):</span>
<span id="cb7-8"><a href="#cb7-8" tabindex="-1"></a>  filename <span class="op">=</span> os.path.basename(filepath)</span>
<span id="cb7-9"><a href="#cb7-9" tabindex="-1"></a>  <span class="co"># Extract the part of the filename containing band name such as &#39;B01&#39;</span></span>
<span id="cb7-10"><a href="#cb7-10" tabindex="-1"></a>  band_name <span class="op">=</span> os.path.splitext(filename)[<span class="dv">0</span>].split(<span class="st">&#39;_&#39;</span>)[<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb7-11"><a href="#cb7-11" tabindex="-1"></a>  band_files[band_name] <span class="op">=</span> filepath</span>
<span id="cb7-12"><a href="#cb7-12" tabindex="-1"></a></span>
<span id="cb7-13"><a href="#cb7-13" tabindex="-1"></a>band_files</span></code></pre></div>
<pre><code>{&#39;B05&#39;: &#39;data/S2A_MSIL1C_20230212T050931_N0509_R019_T43PGQ_20230212T065641.SAFE/GRANULE/L1C_T43PGQ_A039913_20230212T051514/IMG_DATA/T43PGQ_20230212T050931_B05.jp2&#39;,
 &#39;B8A&#39;: &#39;data/S2A_MSIL1C_20230212T050931_N0509_R019_T43PGQ_20230212T065641.SAFE/GRANULE/L1C_T43PGQ_A039913_20230212T051514/IMG_DATA/T43PGQ_20230212T050931_B8A.jp2&#39;,
 &#39;B07&#39;: &#39;data/S2A_MSIL1C_20230212T050931_N0509_R019_T43PGQ_20230212T065641.SAFE/GRANULE/L1C_T43PGQ_A039913_20230212T051514/IMG_DATA/T43PGQ_20230212T050931_B07.jp2&#39;,
 &#39;B01&#39;: &#39;data/S2A_MSIL1C_20230212T050931_N0509_R019_T43PGQ_20230212T065641.SAFE/GRANULE/L1C_T43PGQ_A039913_20230212T051514/IMG_DATA/T43PGQ_20230212T050931_B01.jp2&#39;,
 &#39;B12&#39;: &#39;data/S2A_MSIL1C_20230212T050931_N0509_R019_T43PGQ_20230212T065641.SAFE/GRANULE/L1C_T43PGQ_A039913_20230212T051514/IMG_DATA/T43PGQ_20230212T050931_B12.jp2&#39;,
 &#39;B10&#39;: &#39;data/S2A_MSIL1C_20230212T050931_N0509_R019_T43PGQ_20230212T065641.SAFE/GRANULE/L1C_T43PGQ_A039913_20230212T051514/IMG_DATA/T43PGQ_20230212T050931_B10.jp2&#39;,
 &#39;B08&#39;: &#39;data/S2A_MSIL1C_20230212T050931_N0509_R019_T43PGQ_20230212T065641.SAFE/GRANULE/L1C_T43PGQ_A039913_20230212T051514/IMG_DATA/T43PGQ_20230212T050931_B08.jp2&#39;,
 &#39;B06&#39;: &#39;data/S2A_MSIL1C_20230212T050931_N0509_R019_T43PGQ_20230212T065641.SAFE/GRANULE/L1C_T43PGQ_A039913_20230212T051514/IMG_DATA/T43PGQ_20230212T050931_B06.jp2&#39;,
 &#39;B04&#39;: &#39;data/S2A_MSIL1C_20230212T050931_N0509_R019_T43PGQ_20230212T065641.SAFE/GRANULE/L1C_T43PGQ_A039913_20230212T051514/IMG_DATA/T43PGQ_20230212T050931_B04.jp2&#39;,
 &#39;B09&#39;: &#39;data/S2A_MSIL1C_20230212T050931_N0509_R019_T43PGQ_20230212T065641.SAFE/GRANULE/L1C_T43PGQ_A039913_20230212T051514/IMG_DATA/T43PGQ_20230212T050931_B09.jp2&#39;,
 &#39;B02&#39;: &#39;data/S2A_MSIL1C_20230212T050931_N0509_R019_T43PGQ_20230212T065641.SAFE/GRANULE/L1C_T43PGQ_A039913_20230212T051514/IMG_DATA/T43PGQ_20230212T050931_B02.jp2&#39;,
 &#39;B11&#39;: &#39;data/S2A_MSIL1C_20230212T050931_N0509_R019_T43PGQ_20230212T065641.SAFE/GRANULE/L1C_T43PGQ_A039913_20230212T051514/IMG_DATA/T43PGQ_20230212T050931_B11.jp2&#39;,
 &#39;B03&#39;: &#39;data/S2A_MSIL1C_20230212T050931_N0509_R019_T43PGQ_20230212T065641.SAFE/GRANULE/L1C_T43PGQ_A039913_20230212T051514/IMG_DATA/T43PGQ_20230212T050931_B03.jp2&#39;}</code></pre>
<p>Different Sentinel-2 bands have different spatial resolutions. To put
them in the same array, their dimensions must match. So we combine bands
of similar resolutions and resample others to match them.</p>
<ul>
<li>B04, B03, B02 and B08 = 10m</li>
<li>B12, B11, B07, B06, B05 and B08A = 20m</li>
<li>B10, B09, B1 = 60m</li>
</ul>
<div class="sourceCode" id="cb9"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a>b4 <span class="op">=</span> rxr.open_rasterio(python<span class="op">-</span>remote<span class="op">-</span>sensing<span class="op">-</span>output<span class="op">/</span>band_files[<span class="st">&#39;B04&#39;</span>], chunks<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb9-2"><a href="#cb9-2" tabindex="-1"></a>b3 <span class="op">=</span> rxr.open_rasterio(python<span class="op">-</span>remote<span class="op">-</span>sensing<span class="op">-</span>output<span class="op">/</span>band_files[<span class="st">&#39;B03&#39;</span>], chunks<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb9-3"><a href="#cb9-3" tabindex="-1"></a>b2 <span class="op">=</span> rxr.open_rasterio(python<span class="op">-</span>remote<span class="op">-</span>sensing<span class="op">-</span>output<span class="op">/</span>band_files[<span class="st">&#39;B02&#39;</span>], chunks<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb9-4"><a href="#cb9-4" tabindex="-1"></a>b8 <span class="op">=</span> rxr.open_rasterio(python<span class="op">-</span>remote<span class="op">-</span>sensing<span class="op">-</span>output<span class="op">/</span>band_files[<span class="st">&#39;B08&#39;</span>], chunks<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb9-5"><a href="#cb9-5" tabindex="-1"></a></span>
<span id="cb9-6"><a href="#cb9-6" tabindex="-1"></a>stack1 <span class="op">=</span> xr.concat([b4, b3, b2, b8], dim<span class="op">=</span><span class="st">&#39;band&#39;</span>).assign_coords(</span>
<span id="cb9-7"><a href="#cb9-7" tabindex="-1"></a>    band<span class="op">=</span>[<span class="st">&#39;B04&#39;</span>, <span class="st">&#39;B03&#39;</span>, <span class="st">&#39;B02&#39;</span>, <span class="st">&#39;B08&#39;</span>])</span></code></pre></div>
<div class="sourceCode" id="cb10"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" tabindex="-1"></a>b5 <span class="op">=</span> rxr.open_rasterio(python<span class="op">-</span>remote<span class="op">-</span>sensing<span class="op">-</span>output<span class="op">/</span>band_files[<span class="st">&#39;B05&#39;</span>], chunks<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb10-2"><a href="#cb10-2" tabindex="-1"></a>b6 <span class="op">=</span> rxr.open_rasterio(python<span class="op">-</span>remote<span class="op">-</span>sensing<span class="op">-</span>output<span class="op">/</span>band_files[<span class="st">&#39;B07&#39;</span>], chunks<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb10-3"><a href="#cb10-3" tabindex="-1"></a>b7<span class="op">=</span> rxr.open_rasterio(python<span class="op">-</span>remote<span class="op">-</span>sensing<span class="op">-</span>output<span class="op">/</span>band_files[<span class="st">&#39;B07&#39;</span>], chunks<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb10-4"><a href="#cb10-4" tabindex="-1"></a>b8a <span class="op">=</span> rxr.open_rasterio(python<span class="op">-</span>remote<span class="op">-</span>sensing<span class="op">-</span>output<span class="op">/</span>band_files[<span class="st">&#39;B8A&#39;</span>], chunks<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb10-5"><a href="#cb10-5" tabindex="-1"></a>b11 <span class="op">=</span> rxr.open_rasterio(python<span class="op">-</span>remote<span class="op">-</span>sensing<span class="op">-</span>output<span class="op">/</span>band_files[<span class="st">&#39;B11&#39;</span>], chunks<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb10-6"><a href="#cb10-6" tabindex="-1"></a>b12 <span class="op">=</span> rxr.open_rasterio(python<span class="op">-</span>remote<span class="op">-</span>sensing<span class="op">-</span>output<span class="op">/</span>band_files[<span class="st">&#39;B12&#39;</span>], chunks<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb10-7"><a href="#cb10-7" tabindex="-1"></a></span>
<span id="cb10-8"><a href="#cb10-8" tabindex="-1"></a>stack2 <span class="op">=</span> xr.concat([b5, b6, b7, b8a, b11, b12], dim<span class="op">=</span><span class="st">&#39;band&#39;</span>).assign_coords(</span>
<span id="cb10-9"><a href="#cb10-9" tabindex="-1"></a>    band<span class="op">=</span>[<span class="st">&#39;B05&#39;</span>, <span class="st">&#39;B06&#39;</span>, <span class="st">&#39;B07&#39;</span>, <span class="st">&#39;B8A&#39;</span>, <span class="st">&#39;B11&#39;</span>, <span class="st">&#39;B12&#39;</span>])</span></code></pre></div>
<p>Now we reproject the bands to match the resolution of the 10m bands
using <code>reproject_match()</code></p>
<div class="sourceCode" id="cb11"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" tabindex="-1"></a>stack2 <span class="op">=</span> stack2.rio.reproject_match(stack1)</span></code></pre></div>
<p>Both band stacks now have the same resolution and hence the same X
and Y dimensions. We can now combine them across the <code>band</code>
dimension. The Sentinel-2 scenes come with NoData value of 0. So we set
the correct NoData value before further processing.</p>
<div class="sourceCode" id="cb12"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" tabindex="-1"></a>scene <span class="op">=</span> xr.concat([stack1, stack2], dim<span class="op">=</span><span class="st">&#39;band&#39;</span>)</span>
<span id="cb12-2"><a href="#cb12-2" tabindex="-1"></a>scene <span class="op">=</span> scene.where(scene <span class="op">!=</span> <span class="dv">0</span>)</span>
<span id="cb12-3"><a href="#cb12-3" tabindex="-1"></a>scene</span></code></pre></div>
<p>We will clip the scene to the geometry of the GeoJSON file. We must
ensure that the projection of the GeoDataFrame and the XArray DataArray
match.</p>
<div class="sourceCode" id="cb13"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" tabindex="-1"></a>aoi_path <span class="op">=</span> os.path.join(data_folder, aoi)</span>
<span id="cb13-2"><a href="#cb13-2" tabindex="-1"></a>aoi_gdf <span class="op">=</span> gpd.read_file(aoi_path)</span>
<span id="cb13-3"><a href="#cb13-3" tabindex="-1"></a>geometry <span class="op">=</span> aoi_gdf.to_crs(scene.rio.crs).geometry</span>
<span id="cb13-4"><a href="#cb13-4" tabindex="-1"></a>clipped <span class="op">=</span> scene.rio.clip(geometry)</span>
<span id="cb13-5"><a href="#cb13-5" tabindex="-1"></a>clipped</span></code></pre></div>
<p>Sentinel-2 pixel values need to be converted to reflectances using
the following formula:</p>
<p><code>ρ   =  (L1C_DN + RADIO_ADD_OFFSET) / QUANTIFICATION_VALUE</code></p>
<p><code>QUANTIFICATION_VALUE</code> for all S2 scenes is
<strong>10000</strong> and starting from January 22,2023, all new scenes
have a <code>RADIO_ADD_OFFSET</code> of <strong>-1000</strong></p>
<div class="sourceCode" id="cb14"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" tabindex="-1"></a>scaled <span class="op">=</span> (clipped <span class="op">-</span> <span class="dv">1000</span>)<span class="op">/</span><span class="dv">10000</span></span></code></pre></div>
</div>
<div id="visualization" class="section level3">
<h3>Visualization</h3>
<p>We can visualize a 3-band composite image.</p>
<div class="sourceCode" id="cb15"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb15-2"><a href="#cb15-2" tabindex="-1"></a>fig.set_size_inches(<span class="dv">5</span>,<span class="dv">5</span>)</span>
<span id="cb15-3"><a href="#cb15-3" tabindex="-1"></a>scaled.sel(band<span class="op">=</span>[<span class="st">&#39;B04&#39;</span>, <span class="st">&#39;B03&#39;</span>, <span class="st">&#39;B02&#39;</span>]).plot.imshow(</span>
<span id="cb15-4"><a href="#cb15-4" tabindex="-1"></a>    ax<span class="op">=</span>ax,</span>
<span id="cb15-5"><a href="#cb15-5" tabindex="-1"></a>    robust<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb15-6"><a href="#cb15-6" tabindex="-1"></a>ax.set_title(<span class="st">&#39;RGB Visualization&#39;</span>)</span>
<span id="cb15-7"><a href="#cb15-7" tabindex="-1"></a>ax.set_axis_off()</span>
<span id="cb15-8"><a href="#cb15-8" tabindex="-1"></a>plt.show()</span></code></pre></div>
<p><img
src="python-remote-sensing-output/computing_indices_files/computing_indices_24_0.png" /></p>
<div class="sourceCode" id="cb16"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb16-2"><a href="#cb16-2" tabindex="-1"></a>fig.set_size_inches(<span class="dv">5</span>,<span class="dv">5</span>)</span>
<span id="cb16-3"><a href="#cb16-3" tabindex="-1"></a>scaled.sel(band<span class="op">=</span>[<span class="st">&#39;B08&#39;</span>, <span class="st">&#39;B04&#39;</span>, <span class="st">&#39;B03&#39;</span>]).plot.imshow(</span>
<span id="cb16-4"><a href="#cb16-4" tabindex="-1"></a>    ax<span class="op">=</span>ax,</span>
<span id="cb16-5"><a href="#cb16-5" tabindex="-1"></a>    robust<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb16-6"><a href="#cb16-6" tabindex="-1"></a>ax.set_title(<span class="st">&#39;NRG Visualization&#39;</span>)</span>
<span id="cb16-7"><a href="#cb16-7" tabindex="-1"></a>ax.set_axis_off()</span>
<span id="cb16-8"><a href="#cb16-8" tabindex="-1"></a>plt.show()</span></code></pre></div>
<p><img
src="python-remote-sensing-output/computing_indices_files/computing_indices_25_0.png" /></p>
</div>
<div id="calculating-indices" class="section level3">
<h3>Calculating Indices</h3>
<div class="sourceCode" id="cb17"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" tabindex="-1"></a>red <span class="op">=</span> scaled.sel(band<span class="op">=</span><span class="st">&#39;B04&#39;</span>)</span>
<span id="cb17-2"><a href="#cb17-2" tabindex="-1"></a>nir <span class="op">=</span> scaled.sel(band<span class="op">=</span><span class="st">&#39;B08&#39;</span>)</span>
<span id="cb17-3"><a href="#cb17-3" tabindex="-1"></a></span>
<span id="cb17-4"><a href="#cb17-4" tabindex="-1"></a>ndvi <span class="op">=</span> (nir <span class="op">-</span> red)<span class="op">/</span>(nir <span class="op">+</span> red)</span></code></pre></div>
<p>Let’s visualize the results.</p>
<div class="sourceCode" id="cb18"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" tabindex="-1"></a>cbar_kwargs <span class="op">=</span> {</span>
<span id="cb18-2"><a href="#cb18-2" tabindex="-1"></a>    <span class="st">&#39;orientation&#39;</span>:<span class="st">&#39;horizontal&#39;</span>,</span>
<span id="cb18-3"><a href="#cb18-3" tabindex="-1"></a>    <span class="st">&#39;fraction&#39;</span>: <span class="fl">0.025</span>,</span>
<span id="cb18-4"><a href="#cb18-4" tabindex="-1"></a>    <span class="st">&#39;pad&#39;</span>: <span class="fl">0.05</span>,</span>
<span id="cb18-5"><a href="#cb18-5" tabindex="-1"></a>    <span class="st">&#39;extend&#39;</span>:<span class="st">&#39;neither&#39;</span></span>
<span id="cb18-6"><a href="#cb18-6" tabindex="-1"></a>}</span></code></pre></div>
<div class="sourceCode" id="cb19"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb19-2"><a href="#cb19-2" tabindex="-1"></a>fig.set_size_inches(<span class="dv">5</span>,<span class="dv">5</span>)</span>
<span id="cb19-3"><a href="#cb19-3" tabindex="-1"></a>ndvi.plot.imshow(</span>
<span id="cb19-4"><a href="#cb19-4" tabindex="-1"></a>    ax<span class="op">=</span>ax,</span>
<span id="cb19-5"><a href="#cb19-5" tabindex="-1"></a>    cmap<span class="op">=</span><span class="st">&#39;Greens&#39;</span>,</span>
<span id="cb19-6"><a href="#cb19-6" tabindex="-1"></a>    robust<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb19-7"><a href="#cb19-7" tabindex="-1"></a>    cbar_kwargs<span class="op">=</span>cbar_kwargs)</span>
<span id="cb19-8"><a href="#cb19-8" tabindex="-1"></a>ax.set_title(<span class="st">&#39;NDVI&#39;</span>)</span>
<span id="cb19-9"><a href="#cb19-9" tabindex="-1"></a>ax.set_axis_off()</span>
<span id="cb19-10"><a href="#cb19-10" tabindex="-1"></a>plt.show()</span></code></pre></div>
<p><img
src="python-remote-sensing-output/computing_indices_files/computing_indices_30_0.png" /></p>
<div class="sourceCode" id="cb20"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" tabindex="-1"></a>green <span class="op">=</span> scaled.sel(band<span class="op">=</span><span class="st">&#39;B03&#39;</span>)</span>
<span id="cb20-2"><a href="#cb20-2" tabindex="-1"></a>swir1 <span class="op">=</span> scaled.sel(band<span class="op">=</span><span class="st">&#39;B11&#39;</span>)</span>
<span id="cb20-3"><a href="#cb20-3" tabindex="-1"></a></span>
<span id="cb20-4"><a href="#cb20-4" tabindex="-1"></a>mndwi <span class="op">=</span> (green <span class="op">-</span> swir1)<span class="op">/</span>(green <span class="op">+</span> swir1)</span></code></pre></div>
<div class="sourceCode" id="cb21"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb21-2"><a href="#cb21-2" tabindex="-1"></a>fig.set_size_inches(<span class="dv">5</span>,<span class="dv">5</span>)</span>
<span id="cb21-3"><a href="#cb21-3" tabindex="-1"></a>mndwi.plot.imshow(</span>
<span id="cb21-4"><a href="#cb21-4" tabindex="-1"></a>    ax<span class="op">=</span>ax,</span>
<span id="cb21-5"><a href="#cb21-5" tabindex="-1"></a>    cmap<span class="op">=</span><span class="st">&#39;Blues&#39;</span>,</span>
<span id="cb21-6"><a href="#cb21-6" tabindex="-1"></a>    robust<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb21-7"><a href="#cb21-7" tabindex="-1"></a>    cbar_kwargs<span class="op">=</span>cbar_kwargs)</span>
<span id="cb21-8"><a href="#cb21-8" tabindex="-1"></a>ax.set_title(<span class="st">&#39;MNDWI&#39;</span>)</span>
<span id="cb21-9"><a href="#cb21-9" tabindex="-1"></a>ax.set_axis_off()</span>
<span id="cb21-10"><a href="#cb21-10" tabindex="-1"></a>plt.show()</span></code></pre></div>
<pre><code>/usr/local/lib/python3.10/dist-packages/distributed/client.py:3160: UserWarning: Sending large graph of size 328.52 MiB.
This may cause some slowdown.
Consider scattering data ahead of time and using futures.
  warnings.warn(</code></pre>
<p><img
src="python-remote-sensing-output/computing_indices_files/computing_indices_32_1.png" /></p>
<div class="sourceCode" id="cb23"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" tabindex="-1"></a>red <span class="op">=</span> scaled.sel(band<span class="op">=</span><span class="st">&#39;B04&#39;</span>)</span>
<span id="cb23-2"><a href="#cb23-2" tabindex="-1"></a>nir <span class="op">=</span> scaled.sel(band<span class="op">=</span><span class="st">&#39;B08&#39;</span>)</span>
<span id="cb23-3"><a href="#cb23-3" tabindex="-1"></a></span>
<span id="cb23-4"><a href="#cb23-4" tabindex="-1"></a>savi <span class="op">=</span> <span class="fl">1.5</span> <span class="op">*</span> ((nir <span class="op">-</span> red) <span class="op">/</span> (nir <span class="op">+</span> red <span class="op">+</span> <span class="fl">0.5</span>))</span></code></pre></div>
<div class="sourceCode" id="cb24"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb24-2"><a href="#cb24-2" tabindex="-1"></a>fig.set_size_inches(<span class="dv">5</span>,<span class="dv">5</span>)</span>
<span id="cb24-3"><a href="#cb24-3" tabindex="-1"></a>savi.plot.imshow(</span>
<span id="cb24-4"><a href="#cb24-4" tabindex="-1"></a>    ax<span class="op">=</span>ax,</span>
<span id="cb24-5"><a href="#cb24-5" tabindex="-1"></a>    cmap<span class="op">=</span><span class="st">&#39;Greens&#39;</span>,</span>
<span id="cb24-6"><a href="#cb24-6" tabindex="-1"></a>    robust<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb24-7"><a href="#cb24-7" tabindex="-1"></a>    cbar_kwargs<span class="op">=</span>cbar_kwargs)</span>
<span id="cb24-8"><a href="#cb24-8" tabindex="-1"></a>ax.set_title(<span class="st">&#39;SAVI&#39;</span>)</span>
<span id="cb24-9"><a href="#cb24-9" tabindex="-1"></a>ax.set_axis_off()</span>
<span id="cb24-10"><a href="#cb24-10" tabindex="-1"></a>plt.show()</span></code></pre></div>
<p><img
src="python-remote-sensing-output/computing_indices_files/computing_indices_34_0.png" /></p>
</div>
<div id="saving-the-results" class="section level3">
<h3>Saving the results</h3>
<div class="sourceCode" id="cb25"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" tabindex="-1"></a>files <span class="op">=</span> {</span>
<span id="cb25-2"><a href="#cb25-2" tabindex="-1"></a>    <span class="st">&#39;clipped.tif&#39;</span>: scaled,</span>
<span id="cb25-3"><a href="#cb25-3" tabindex="-1"></a>    <span class="st">&#39;ndvi.tif&#39;</span>: ndvi,</span>
<span id="cb25-4"><a href="#cb25-4" tabindex="-1"></a>    <span class="st">&#39;mndwi.tif&#39;</span>: mndwi,</span>
<span id="cb25-5"><a href="#cb25-5" tabindex="-1"></a>    <span class="st">&#39;savi.tif&#39;</span>: savi</span>
<span id="cb25-6"><a href="#cb25-6" tabindex="-1"></a>}</span>
<span id="cb25-7"><a href="#cb25-7" tabindex="-1"></a></span>
<span id="cb25-8"><a href="#cb25-8" tabindex="-1"></a><span class="cf">for</span> <span class="bu">file</span> <span class="kw">in</span> files:</span>
<span id="cb25-9"><a href="#cb25-9" tabindex="-1"></a>  output_path <span class="op">=</span> os.path.join(output_folder, <span class="bu">file</span>)</span>
<span id="cb25-10"><a href="#cb25-10" tabindex="-1"></a>  files[<span class="bu">file</span>].rio.to_raster(output_path, driver<span class="op">=</span><span class="st">&#39;COG&#39;</span>)</span></code></pre></div>
</div>
<div id="exercise" class="section level3">
<h3>Exercise</h3>
<p>Calculate the Normalized Difference Built-Up Index (NDBI) for the
image and visualize the built-up area using a ‘red’ palette</p>
<p>Hint: <code>NDBI = (SWIR1 – NIR) / (SWIR1 + NIR)</code></p>
</div>
</div>
<div id="cloud-masking" class="section level2">
<h2>Cloud Masking</h2>
<p><a
href="https://colab.research.google.com/github/spatialthoughts/courses/blob/master/code/python_remote_sensing/cloud_masking.ipynb"><img
src="https://colab.research.google.com/assets/colab-badge.svg"
alt="Open In Colab" /></a></p>
<div id="overview-1" class="section level3">
<h3>Overview</h3>
<p>In this section, we will take a single Landsat 8 scene downloaded
from the <a href="https://earthexplorer.usgs.gov/">USGS
EarthExplorer</a> and learn how to read it using XArray, visualize it
and mask clouds.</p>
</div>
<div id="setup-and-data-download-1" class="section level3">
<h3>Setup and Data Download</h3>
<p>The following blocks of code will install the required packages and
download the datasets to your Colab environment.</p>
<div class="sourceCode" id="cb26"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" tabindex="-1"></a><span class="op">%%</span>capture</span>
<span id="cb26-2"><a href="#cb26-2" tabindex="-1"></a><span class="cf">if</span> <span class="st">&#39;google.colab&#39;</span> <span class="kw">in</span> <span class="bu">str</span>(get_ipython()):</span>
<span id="cb26-3"><a href="#cb26-3" tabindex="-1"></a>  <span class="op">!</span>pip install rioxarray</span>
<span id="cb26-4"><a href="#cb26-4" tabindex="-1"></a>  <span class="op">!</span>pip install jupyter<span class="op">-</span>server<span class="op">-</span>proxy</span></code></pre></div>
<div class="sourceCode" id="cb27"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb27-2"><a href="#cb27-2" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb27-3"><a href="#cb27-3" tabindex="-1"></a><span class="im">import</span> xarray <span class="im">as</span> xr</span>
<span id="cb27-4"><a href="#cb27-4" tabindex="-1"></a><span class="im">import</span> rioxarray <span class="im">as</span> rxr</span>
<span id="cb27-5"><a href="#cb27-5" tabindex="-1"></a><span class="im">import</span> zipfile</span>
<span id="cb27-6"><a href="#cb27-6" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span></code></pre></div>
<div class="sourceCode" id="cb28"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" tabindex="-1"></a>data_folder <span class="op">=</span> <span class="st">&#39;data&#39;</span></span>
<span id="cb28-2"><a href="#cb28-2" tabindex="-1"></a>output_folder <span class="op">=</span> <span class="st">&#39;output&#39;</span></span>
<span id="cb28-3"><a href="#cb28-3" tabindex="-1"></a></span>
<span id="cb28-4"><a href="#cb28-4" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> os.path.exists(data_folder):</span>
<span id="cb28-5"><a href="#cb28-5" tabindex="-1"></a>    os.mkdir(data_folder)</span>
<span id="cb28-6"><a href="#cb28-6" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> os.path.exists(output_folder):</span>
<span id="cb28-7"><a href="#cb28-7" tabindex="-1"></a>    os.mkdir(output_folder)</span></code></pre></div>
<div class="sourceCode" id="cb29"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" tabindex="-1"></a><span class="kw">def</span> download(url):</span>
<span id="cb29-2"><a href="#cb29-2" tabindex="-1"></a>    filename <span class="op">=</span> os.path.join(data_folder, os.path.basename(url))</span>
<span id="cb29-3"><a href="#cb29-3" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> os.path.exists(filename):</span>
<span id="cb29-4"><a href="#cb29-4" tabindex="-1"></a>        <span class="im">from</span> urllib.request <span class="im">import</span> urlretrieve</span>
<span id="cb29-5"><a href="#cb29-5" tabindex="-1"></a>        local, _ <span class="op">=</span> urlretrieve(url, filename)</span>
<span id="cb29-6"><a href="#cb29-6" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&#39;Downloaded &#39;</span> <span class="op">+</span> local)</span>
<span id="cb29-7"><a href="#cb29-7" tabindex="-1"></a>landsat_scene <span class="op">=</span> <span class="st">&#39;LC08_L2SP_144052_20190209_20200829_02_T1.zip&#39;</span></span>
<span id="cb29-8"><a href="#cb29-8" tabindex="-1"></a>data_url <span class="op">=</span> <span class="st">&#39;https://storage.googleapis.com/spatialthoughts-public-data/&#39;</span></span>
<span id="cb29-9"><a href="#cb29-9" tabindex="-1"></a></span>
<span id="cb29-10"><a href="#cb29-10" tabindex="-1"></a>download(data_url <span class="op">+</span> <span class="st">&#39;landsat/&#39;</span> <span class="op">+</span> landsat_scene)</span></code></pre></div>
</div>
<div id="data-pre-processing-1" class="section level3">
<h3>Data Pre-Processing</h3>
<p>We first unzip the zip archive and create a XArray Dataset from the
individual band images.</p>
<div class="sourceCode" id="cb30"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" tabindex="-1"></a>landsat_filepath <span class="op">=</span> os.path.join(data_folder, landsat_scene)</span>
<span id="cb30-2"><a href="#cb30-2" tabindex="-1"></a></span>
<span id="cb30-3"><a href="#cb30-3" tabindex="-1"></a><span class="cf">with</span> zipfile.ZipFile(landsat_filepath) <span class="im">as</span> zf:</span>
<span id="cb30-4"><a href="#cb30-4" tabindex="-1"></a>  zf.extractall(data_folder)</span></code></pre></div>
<p>Sentinel-2 images come as individual GeoTIFF rasters for each band.
The image band files cotaining data from the OLI sensor are named such
as <code>*_SR_B1.TIF</code>, <code>*_SR_B2.TIF</code> etc. We find the
files and read them using <code>rioxarray</code>.</p>
<div class="sourceCode" id="cb31"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" tabindex="-1"></a><span class="im">import</span> glob</span>
<span id="cb31-2"><a href="#cb31-2" tabindex="-1"></a></span>
<span id="cb31-3"><a href="#cb31-3" tabindex="-1"></a>band_files <span class="op">=</span> {}</span>
<span id="cb31-4"><a href="#cb31-4" tabindex="-1"></a></span>
<span id="cb31-5"><a href="#cb31-5" tabindex="-1"></a><span class="cf">for</span> filepath <span class="kw">in</span> glob.glob(</span>
<span id="cb31-6"><a href="#cb31-6" tabindex="-1"></a>    os.path.join(data_folder, <span class="st">&#39;*SR_B*.TIF&#39;</span>)):</span>
<span id="cb31-7"><a href="#cb31-7" tabindex="-1"></a>  filename <span class="op">=</span> os.path.basename(filepath)</span>
<span id="cb31-8"><a href="#cb31-8" tabindex="-1"></a>  <span class="co"># Extract the part of the filename containing band name such as &#39;B01&#39;</span></span>
<span id="cb31-9"><a href="#cb31-9" tabindex="-1"></a>  band_name <span class="op">=</span> os.path.splitext(filename)[<span class="dv">0</span>].split(<span class="st">&#39;_&#39;</span>)[<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb31-10"><a href="#cb31-10" tabindex="-1"></a>  band_files[band_name] <span class="op">=</span> filepath</span>
<span id="cb31-11"><a href="#cb31-11" tabindex="-1"></a></span>
<span id="cb31-12"><a href="#cb31-12" tabindex="-1"></a>band_files</span></code></pre></div>
<p>We read the bands using <code>rioxarray</code> and combine them into
a single DataArray.</p>
<div class="sourceCode" id="cb32"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" tabindex="-1"></a>bands <span class="op">=</span> []</span>
<span id="cb32-2"><a href="#cb32-2" tabindex="-1"></a></span>
<span id="cb32-3"><a href="#cb32-3" tabindex="-1"></a><span class="cf">for</span> band_name, band_path <span class="kw">in</span> band_files.items():</span>
<span id="cb32-4"><a href="#cb32-4" tabindex="-1"></a>  ds <span class="op">=</span> rxr.open_rasterio(band_path, chunks<span class="op">=</span><span class="va">True</span>, masked<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb32-5"><a href="#cb32-5" tabindex="-1"></a>  ds.name <span class="op">=</span> band_name</span>
<span id="cb32-6"><a href="#cb32-6" tabindex="-1"></a>  bands.append(ds)</span>
<span id="cb32-7"><a href="#cb32-7" tabindex="-1"></a></span>
<span id="cb32-8"><a href="#cb32-8" tabindex="-1"></a>scene <span class="op">=</span> xr.concat(bands, dim<span class="op">=</span><span class="st">&#39;band&#39;</span>).assign_coords(</span>
<span id="cb32-9"><a href="#cb32-9" tabindex="-1"></a>    band<span class="op">=</span><span class="bu">list</span>(python<span class="op">-</span>remote<span class="op">-</span>sensing<span class="op">-</span>output<span class="op">/</span>band_files.keys()))</span>
<span id="cb32-10"><a href="#cb32-10" tabindex="-1"></a>scene</span></code></pre></div>
<p>Landsat Collection 2 surface reflectance has a scale factor of
<code>0.0000275</code> and an additional offset of <code>-0.2</code> per
pixel. We apply the scale and offset to get the reflectance values</p>
<div class="sourceCode" id="cb33"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" tabindex="-1"></a>scaled <span class="op">=</span> (scene<span class="op">*</span><span class="fl">0.0000275</span>) <span class="op">-</span> <span class="fl">0.2</span></span></code></pre></div>
</div>
<div id="visualization-1" class="section level3">
<h3>Visualization</h3>
<p>We can visualize a 3-band composite image.</p>
<div class="sourceCode" id="cb34"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb34-2"><a href="#cb34-2" tabindex="-1"></a>fig.set_size_inches(<span class="dv">5</span>,<span class="dv">5</span>)</span>
<span id="cb34-3"><a href="#cb34-3" tabindex="-1"></a>scaled.sel(band<span class="op">=</span>[<span class="st">&#39;B4&#39;</span>, <span class="st">&#39;B3&#39;</span>, <span class="st">&#39;B2&#39;</span>]).plot.imshow(</span>
<span id="cb34-4"><a href="#cb34-4" tabindex="-1"></a>    ax<span class="op">=</span>ax,</span>
<span id="cb34-5"><a href="#cb34-5" tabindex="-1"></a>    robust<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb34-6"><a href="#cb34-6" tabindex="-1"></a>ax.set_title(<span class="st">&#39;RGB Visualization&#39;</span>)</span>
<span id="cb34-7"><a href="#cb34-7" tabindex="-1"></a>ax.set_axis_off()</span>
<span id="cb34-8"><a href="#cb34-8" tabindex="-1"></a>plt.show()</span></code></pre></div>
<p><img
src="python-remote-sensing-output/cloud_masking_files/cloud_masking_16_0.png" /></p>
</div>
<div id="applying-a-cloud-mask" class="section level3">
<h3>Applying a Cloud Mask</h3>
<p>Most satellite providers store pixel quality information as bitmasks.
This allows the providers to store a lot more information in an
efficient way. Bitmasks can be hard to understand. Please read our post
on <a
href="https://spatialthoughts.com/2021/08/19/qa-bands-bitmasks-gee/">Working
with QA Bands and Bitmasks in Google Earth Engine</a> to understand the
concepts. Here we apply the same concept using a Python implementation
of bitmasking adapted from Google Earth Engine.</p>
<p>Read the QA band which comes with a filename ending with
<code>*QA_PIXEL.TIF</code>.</p>
<div class="sourceCode" id="cb35"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" tabindex="-1"></a><span class="cf">for</span> qa_filepath <span class="kw">in</span> glob.glob(</span>
<span id="cb35-2"><a href="#cb35-2" tabindex="-1"></a>    os.path.join(data_folder, <span class="st">&#39;*QA_PIXEL.TIF&#39;</span>)):</span>
<span id="cb35-3"><a href="#cb35-3" tabindex="-1"></a>  <span class="cf">break</span></span>
<span id="cb35-4"><a href="#cb35-4" tabindex="-1"></a></span>
<span id="cb35-5"><a href="#cb35-5" tabindex="-1"></a>pixel_qa <span class="op">=</span> rxr.open_rasterio(qa_filepath, chunks<span class="op">=</span><span class="va">True</span>, masked<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb35-6"><a href="#cb35-6" tabindex="-1"></a>pixel_qa.name <span class="op">=</span> <span class="st">&#39;pixel_qa&#39;</span></span>
<span id="cb35-7"><a href="#cb35-7" tabindex="-1"></a>pixel_qa</span></code></pre></div>
<div class="sourceCode" id="cb36"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" tabindex="-1"></a>pixel_qa <span class="op">=</span> pixel_qa.squeeze().astype(<span class="st">&#39;int64&#39;</span>)</span>
<span id="cb36-2"><a href="#cb36-2" tabindex="-1"></a>pixel_qa</span></code></pre></div>
<p>The 16-bit pixel value is determined by setting each of the bits to 0
or 1.</p>
<p>Since we are interested in clouds, the first 5 bits are relevant</p>
<table>
<thead>
<tr class="header">
<th>Bit</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>Fill</td>
</tr>
<tr class="even">
<td>1</td>
<td>Dilated Cloud</td>
</tr>
<tr class="odd">
<td>2</td>
<td>Cirrus</td>
</tr>
<tr class="even">
<td>3</td>
<td>Cloud</td>
</tr>
<tr class="odd">
<td>4</td>
<td>Cloud Shadow</td>
</tr>
</tbody>
</table>
<p>We create a mask using the <code>np.bitwise_and()</code> function
against the binary number <code>11111</code>. The result will be 0 only
if all the bits are set to 0 indicating clear conditions.</p>
<div class="sourceCode" id="cb37"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" tabindex="-1"></a>mask <span class="op">=</span> xr.full_like(pixel_qa, <span class="bu">int</span>(<span class="st">&#39;11111&#39;</span>, <span class="dv">2</span>))</span>
<span id="cb37-2"><a href="#cb37-2" tabindex="-1"></a>qa_mask <span class="op">=</span> np.bitwise_and(pixel_qa, mask) <span class="op">==</span> (<span class="dv">0</span>)</span>
<span id="cb37-3"><a href="#cb37-3" tabindex="-1"></a>qa_mask</span></code></pre></div>
<div class="sourceCode" id="cb38"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" tabindex="-1"></a>scene_masked <span class="op">=</span> scaled.where(qa_mask)</span>
<span id="cb38-2"><a href="#cb38-2" tabindex="-1"></a>scene_masked</span></code></pre></div>
<div class="sourceCode" id="cb39"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb39-2"><a href="#cb39-2" tabindex="-1"></a>fig.set_size_inches(<span class="dv">5</span>,<span class="dv">5</span>)</span>
<span id="cb39-3"><a href="#cb39-3" tabindex="-1"></a>scene_masked.sel(band<span class="op">=</span>[<span class="st">&#39;B4&#39;</span>, <span class="st">&#39;B3&#39;</span>, <span class="st">&#39;B2&#39;</span>]).plot.imshow(</span>
<span id="cb39-4"><a href="#cb39-4" tabindex="-1"></a>    ax<span class="op">=</span>ax,</span>
<span id="cb39-5"><a href="#cb39-5" tabindex="-1"></a>    robust<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb39-6"><a href="#cb39-6" tabindex="-1"></a>ax.set_title(<span class="st">&#39;RGB Visualization&#39;</span>)</span>
<span id="cb39-7"><a href="#cb39-7" tabindex="-1"></a>ax.set_axis_off()</span>
<span id="cb39-8"><a href="#cb39-8" tabindex="-1"></a>plt.show()</span></code></pre></div>
<p><img
src="python-remote-sensing-output/cloud_masking_files/cloud_masking_24_0.png" /></p>
<p>Let’s write the resulting masked as a multi-band GeoTIFF file using
rioxarray. We convert the DataArray to a DataSet with each band being a
separate variable. This results in a much nicer GeoTIFF that is
compatible with desktop software.</p>
<div class="sourceCode" id="cb40"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" tabindex="-1"></a>output_file <span class="op">=</span> <span class="st">&#39;landsat_masked.tif&#39;</span></span>
<span id="cb40-2"><a href="#cb40-2" tabindex="-1"></a>output_path <span class="op">=</span> os.path.join(output_folder, output_file)</span>
<span id="cb40-3"><a href="#cb40-3" tabindex="-1"></a></span>
<span id="cb40-4"><a href="#cb40-4" tabindex="-1"></a>output_ds <span class="op">=</span> scene_masked.to_dataset(<span class="st">&#39;band&#39;</span>)</span>
<span id="cb40-5"><a href="#cb40-5" tabindex="-1"></a>output_ds[[<span class="st">&#39;B4&#39;</span>, <span class="st">&#39;B3&#39;</span>, <span class="st">&#39;B2&#39;</span>]].rio.to_raster(output_path, compress<span class="op">=</span><span class="st">&#39;deflate&#39;</span>)</span></code></pre></div>
</div>
</div>
<div id="extracting-time-series" class="section level2">
<h2>Extracting Time Series</h2>
<p><a
href="https://colab.research.google.com/github/spatialthoughts/courses/blob/master/code/python_remote_sensing/extracting_time_series.ipynb"><img
src="https://colab.research.google.com/assets/colab-badge.svg"
alt="Open In Colab" /></a></p>
<div id="overview-2" class="section level3">
<h3>Overview</h3>
<p>In this section, we will work with MODIS Vegetation Indices Version
6.1 data which are generated every 16 days at 250 meter (m) spatial
resolution. This dataset provides Normalised Differnece Vegetation Index
(NDVI) and Enhanced Vegetation Index (EVI) processed from the MODIS
data. The source data was downloaded and processed via <a
href="https://appeears.earthdatacloud.nasa.gov/">AρρEEARS</a> which
allows for pre-processing of the data into user-specified AOIs.</p>
<p>Here we will working with GeoTIFF files in EPSG:4326 projection and
clipped to the state boundary of Karnataka, India. We will learn how to
load all the files into a single XArray Dataset, apply a cloud-mask and
extract a time-series of NDVI and EVI values.</p>
</div>
<div id="setup-and-data-download-2" class="section level3">
<h3>Setup and Data Download</h3>
<p>The following blocks of code will install the required packages and
download the datasets to your Colab environment.</p>
<div class="sourceCode" id="cb41"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" tabindex="-1"></a><span class="op">%%</span>capture</span>
<span id="cb41-2"><a href="#cb41-2" tabindex="-1"></a><span class="cf">if</span> <span class="st">&#39;google.colab&#39;</span> <span class="kw">in</span> <span class="bu">str</span>(get_ipython()):</span>
<span id="cb41-3"><a href="#cb41-3" tabindex="-1"></a>    <span class="op">!</span>apt install libspatialindex<span class="op">-</span>dev</span>
<span id="cb41-4"><a href="#cb41-4" tabindex="-1"></a>    <span class="op">!</span>pip install fiona shapely pyproj rtree</span>
<span id="cb41-5"><a href="#cb41-5" tabindex="-1"></a>    <span class="op">!</span>pip install geopandas</span>
<span id="cb41-6"><a href="#cb41-6" tabindex="-1"></a>    <span class="op">!</span>pip install rioxarray</span></code></pre></div>
<div class="sourceCode" id="cb42"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" tabindex="-1"></a><span class="im">import</span> datetime</span>
<span id="cb42-2"><a href="#cb42-2" tabindex="-1"></a><span class="im">import</span> glob</span>
<span id="cb42-3"><a href="#cb42-3" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb42-4"><a href="#cb42-4" tabindex="-1"></a><span class="im">import</span> re</span>
<span id="cb42-5"><a href="#cb42-5" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb42-6"><a href="#cb42-6" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb42-7"><a href="#cb42-7" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb42-8"><a href="#cb42-8" tabindex="-1"></a><span class="im">import</span> geopandas <span class="im">as</span> gpd</span>
<span id="cb42-9"><a href="#cb42-9" tabindex="-1"></a><span class="im">import</span> xarray <span class="im">as</span> xr</span>
<span id="cb42-10"><a href="#cb42-10" tabindex="-1"></a><span class="im">import</span> rioxarray <span class="im">as</span> rxr</span>
<span id="cb42-11"><a href="#cb42-11" tabindex="-1"></a><span class="im">import</span> zipfile</span></code></pre></div>
<div class="sourceCode" id="cb43"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" tabindex="-1"></a>data_folder <span class="op">=</span> <span class="st">&#39;data&#39;</span></span>
<span id="cb43-2"><a href="#cb43-2" tabindex="-1"></a>output_folder <span class="op">=</span> <span class="st">&#39;output&#39;</span></span>
<span id="cb43-3"><a href="#cb43-3" tabindex="-1"></a></span>
<span id="cb43-4"><a href="#cb43-4" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> os.path.exists(data_folder):</span>
<span id="cb43-5"><a href="#cb43-5" tabindex="-1"></a>    os.mkdir(data_folder)</span>
<span id="cb43-6"><a href="#cb43-6" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> os.path.exists(output_folder):</span>
<span id="cb43-7"><a href="#cb43-7" tabindex="-1"></a>    os.mkdir(output_folder)</span></code></pre></div>
<div class="sourceCode" id="cb44"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" tabindex="-1"></a><span class="kw">def</span> download(url):</span>
<span id="cb44-2"><a href="#cb44-2" tabindex="-1"></a>    filename <span class="op">=</span> os.path.join(data_folder, os.path.basename(url))</span>
<span id="cb44-3"><a href="#cb44-3" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> os.path.exists(filename):</span>
<span id="cb44-4"><a href="#cb44-4" tabindex="-1"></a>        <span class="im">from</span> urllib.request <span class="im">import</span> urlretrieve</span>
<span id="cb44-5"><a href="#cb44-5" tabindex="-1"></a>        local, _ <span class="op">=</span> urlretrieve(url, filename)</span>
<span id="cb44-6"><a href="#cb44-6" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&#39;Downloaded &#39;</span> <span class="op">+</span> local)</span>
<span id="cb44-7"><a href="#cb44-7" tabindex="-1"></a></span>
<span id="cb44-8"><a href="#cb44-8" tabindex="-1"></a></span>
<span id="cb44-9"><a href="#cb44-9" tabindex="-1"></a>filename <span class="op">=</span> <span class="st">&#39;modis_vegetation_indices_2020.zip&#39;</span></span>
<span id="cb44-10"><a href="#cb44-10" tabindex="-1"></a>url <span class="op">=</span> <span class="st">&#39;https://storage.googleapis.com/spatialthoughts-public-data/&#39;</span> <span class="op">+</span> filename</span>
<span id="cb44-11"><a href="#cb44-11" tabindex="-1"></a></span>
<span id="cb44-12"><a href="#cb44-12" tabindex="-1"></a>download(url)</span></code></pre></div>
<pre><code>Downloaded data/modis_vegetation_indices_2020.zip</code></pre>
</div>
<div id="data-pre-processing-2" class="section level3">
<h3>Data Pre-Processing</h3>
<p>First we unzip and extract the images to a folder.</p>
<div class="sourceCode" id="cb46"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" tabindex="-1"></a>zipfile_path <span class="op">=</span> os.path.join(data_folder, filename)</span>
<span id="cb46-2"><a href="#cb46-2" tabindex="-1"></a><span class="cf">with</span> zipfile.ZipFile(zipfile_path) <span class="im">as</span> zf:</span>
<span id="cb46-3"><a href="#cb46-3" tabindex="-1"></a>  zf.extractall(data_folder)</span></code></pre></div>
<p>The timestamp for the image is part of the filename. We write a
function to parse the filename and extract the timestamps.</p>
<div class="sourceCode" id="cb47"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" tabindex="-1"></a><span class="kw">def</span> path_to_datetimeindex(filepath):</span>
<span id="cb47-2"><a href="#cb47-2" tabindex="-1"></a>  filename <span class="op">=</span> os.path.basename(filepath)</span>
<span id="cb47-3"><a href="#cb47-3" tabindex="-1"></a>  pattern <span class="op">=</span> <span class="vs">r&#39;doy(\d+)&#39;</span></span>
<span id="cb47-4"><a href="#cb47-4" tabindex="-1"></a>  match <span class="op">=</span> re.search(pattern, filepath)</span>
<span id="cb47-5"><a href="#cb47-5" tabindex="-1"></a>  <span class="cf">if</span> match:</span>
<span id="cb47-6"><a href="#cb47-6" tabindex="-1"></a>      doy_value <span class="op">=</span> match.group(<span class="dv">1</span>)</span>
<span id="cb47-7"><a href="#cb47-7" tabindex="-1"></a>      timestamp <span class="op">=</span> datetime.datetime.strptime(doy_value, <span class="st">&#39;%Y%j&#39;</span>)</span>
<span id="cb47-8"><a href="#cb47-8" tabindex="-1"></a>      <span class="cf">return</span> timestamp</span>
<span id="cb47-9"><a href="#cb47-9" tabindex="-1"></a>  <span class="cf">else</span>:</span>
<span id="cb47-10"><a href="#cb47-10" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&#39;Could not extract DOY from filename&#39;</span>, filename)</span>
<span id="cb47-11"><a href="#cb47-11" tabindex="-1"></a></span>
<span id="cb47-12"><a href="#cb47-12" tabindex="-1"></a></span>
<span id="cb47-13"><a href="#cb47-13" tabindex="-1"></a>timestamps <span class="op">=</span> []</span>
<span id="cb47-14"><a href="#cb47-14" tabindex="-1"></a>filepaths <span class="op">=</span> []</span>
<span id="cb47-15"><a href="#cb47-15" tabindex="-1"></a></span>
<span id="cb47-16"><a href="#cb47-16" tabindex="-1"></a>files <span class="op">=</span> os.path.join(data_folder, <span class="st">&#39;modis_vegetation_indices_2020&#39;</span>, <span class="st">&#39;*.tif&#39;</span>)</span>
<span id="cb47-17"><a href="#cb47-17" tabindex="-1"></a><span class="cf">for</span> filepath <span class="kw">in</span> glob.glob(files):</span>
<span id="cb47-18"><a href="#cb47-18" tabindex="-1"></a>  timestamp <span class="op">=</span> path_to_datetimeindex(filepath)</span>
<span id="cb47-19"><a href="#cb47-19" tabindex="-1"></a>  filepaths.append(filepath)</span>
<span id="cb47-20"><a href="#cb47-20" tabindex="-1"></a>  timestamps.append(timestamp)</span>
<span id="cb47-21"><a href="#cb47-21" tabindex="-1"></a></span>
<span id="cb47-22"><a href="#cb47-22" tabindex="-1"></a>unique_timestamps <span class="op">=</span> <span class="bu">sorted</span>(<span class="bu">set</span>(timestamps))</span></code></pre></div>
<p>Iterate through each file and read it using XArray. There are 3 files
for each time-step. One file each for <code>NDV</code>, <code>EVI</code>
and <code>DetailedQA</code> information. We extract the first 2-bits of
information from the <code>DetailedQA</code> band into a new band named
<code>SummaryQA</code>. These 4 bands are combined into a single array
for each time-step and then combine all the arrays into a single array
with a <code>time</code> dimension.</p>
<div class="sourceCode" id="cb48"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" tabindex="-1"></a>scenes <span class="op">=</span> []</span>
<span id="cb48-2"><a href="#cb48-2" tabindex="-1"></a></span>
<span id="cb48-3"><a href="#cb48-3" tabindex="-1"></a><span class="cf">for</span> timestamp <span class="kw">in</span> unique_timestamps:</span>
<span id="cb48-4"><a href="#cb48-4" tabindex="-1"></a>  ndvi_filepattern <span class="op">=</span> <span class="vs">r&#39;NDVI_doy</span><span class="sc">{}</span><span class="vs">&#39;</span>.<span class="bu">format</span>(timestamp.strftime(<span class="st">&#39;%Y%j&#39;</span>))</span>
<span id="cb48-5"><a href="#cb48-5" tabindex="-1"></a>  evi_filepattern <span class="op">=</span> <span class="vs">r&#39;EVI_doy</span><span class="sc">{}</span><span class="vs">&#39;</span>.<span class="bu">format</span>(timestamp.strftime(<span class="st">&#39;%Y%j&#39;</span>))</span>
<span id="cb48-6"><a href="#cb48-6" tabindex="-1"></a>  qa_filepattern <span class="op">=</span> <span class="vs">r&#39;VI_Quality_doy</span><span class="sc">{}</span><span class="vs">&#39;</span>.<span class="bu">format</span>(timestamp.strftime(<span class="st">&#39;%Y%j&#39;</span>))</span>
<span id="cb48-7"><a href="#cb48-7" tabindex="-1"></a>  ndvi_filepath <span class="op">=</span> [filepath <span class="cf">for</span> filepath <span class="kw">in</span> filepaths <span class="cf">if</span> re.search(ndvi_filepattern, filepath)][<span class="dv">0</span>]</span>
<span id="cb48-8"><a href="#cb48-8" tabindex="-1"></a>  evi_filepath <span class="op">=</span> [filepath <span class="cf">for</span> filepath <span class="kw">in</span> filepaths <span class="cf">if</span> re.search(evi_filepattern, filepath)][<span class="dv">0</span>]</span>
<span id="cb48-9"><a href="#cb48-9" tabindex="-1"></a>  qa_filepath <span class="op">=</span> [filepath <span class="cf">for</span> filepath <span class="kw">in</span> filepaths <span class="cf">if</span> re.search(qa_filepattern, filepath)][<span class="dv">0</span>]</span>
<span id="cb48-10"><a href="#cb48-10" tabindex="-1"></a></span>
<span id="cb48-11"><a href="#cb48-11" tabindex="-1"></a>  ndvi_band <span class="op">=</span> rxr.open_rasterio(ndvi_filepath, chunks<span class="op">=</span>{<span class="st">&#39;x&#39;</span>:<span class="dv">512</span>, <span class="st">&#39;y&#39;</span>:<span class="dv">512</span>})</span>
<span id="cb48-12"><a href="#cb48-12" tabindex="-1"></a>  ndvi_band.name <span class="op">=</span> <span class="st">&#39;NDVI&#39;</span></span>
<span id="cb48-13"><a href="#cb48-13" tabindex="-1"></a>  evi_band <span class="op">=</span> rxr.open_rasterio(evi_filepath, chunks<span class="op">=</span>{<span class="st">&#39;x&#39;</span>:<span class="dv">512</span>, <span class="st">&#39;y&#39;</span>:<span class="dv">512</span>})</span>
<span id="cb48-14"><a href="#cb48-14" tabindex="-1"></a>  evi_band.name <span class="op">=</span> <span class="st">&#39;EVI&#39;</span></span>
<span id="cb48-15"><a href="#cb48-15" tabindex="-1"></a>  qa_band <span class="op">=</span> rxr.open_rasterio(qa_filepath, chunks<span class="op">=</span>{<span class="st">&#39;x&#39;</span>:<span class="dv">512</span>, <span class="st">&#39;y&#39;</span>:<span class="dv">512</span>})</span>
<span id="cb48-16"><a href="#cb48-16" tabindex="-1"></a>  qa_band.name <span class="op">=</span> <span class="st">&#39;DetailedQA&#39;</span></span>
<span id="cb48-17"><a href="#cb48-17" tabindex="-1"></a></span>
<span id="cb48-18"><a href="#cb48-18" tabindex="-1"></a>  <span class="co"># First 2 bits are MODLAND QA Bits with summary information</span></span>
<span id="cb48-19"><a href="#cb48-19" tabindex="-1"></a>  <span class="co"># Extract the value of the 2-bits using bitwise AND operation</span></span>
<span id="cb48-20"><a href="#cb48-20" tabindex="-1"></a>  summary_qa <span class="op">=</span> qa_band <span class="op">&amp;</span> <span class="bn">0b11</span></span>
<span id="cb48-21"><a href="#cb48-21" tabindex="-1"></a>  qa_band.name <span class="op">=</span> <span class="st">&#39;SummaryQA&#39;</span></span>
<span id="cb48-22"><a href="#cb48-22" tabindex="-1"></a></span>
<span id="cb48-23"><a href="#cb48-23" tabindex="-1"></a>  <span class="co"># Pixel values need to be scaled with the scale_factor</span></span>
<span id="cb48-24"><a href="#cb48-24" tabindex="-1"></a>  scale_factor <span class="op">=</span> <span class="fl">0.0001</span></span>
<span id="cb48-25"><a href="#cb48-25" tabindex="-1"></a>  scaled_bands <span class="op">=</span> [ndvi_band <span class="op">*</span> scale_factor, evi_band <span class="op">*</span> scale_factor, qa_band, summary_qa]</span>
<span id="cb48-26"><a href="#cb48-26" tabindex="-1"></a>  scene <span class="op">=</span> xr.concat(scaled_bands, dim<span class="op">=</span><span class="st">&#39;band&#39;</span>)</span>
<span id="cb48-27"><a href="#cb48-27" tabindex="-1"></a>  scenes.append(scene)</span></code></pre></div>
<div class="sourceCode" id="cb49"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" tabindex="-1"></a>time_var <span class="op">=</span> xr.Variable(<span class="st">&#39;time&#39;</span>, <span class="bu">list</span>(unique_timestamps))</span>
<span id="cb49-2"><a href="#cb49-2" tabindex="-1"></a></span>
<span id="cb49-3"><a href="#cb49-3" tabindex="-1"></a>time_series_scenes <span class="op">=</span> xr.concat(scenes, dim<span class="op">=</span>time_var)</span>
<span id="cb49-4"><a href="#cb49-4" tabindex="-1"></a>time_series_scenes</span></code></pre></div>
<div class="sourceCode" id="cb50"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" tabindex="-1"></a>time_series_scenes <span class="op">=</span> time_series_scenes.assign_coords(band<span class="op">=</span>[<span class="st">&#39;NDVI&#39;</span>, <span class="st">&#39;EVI&#39;</span>, <span class="st">&#39;DetailedQA&#39;</span>, <span class="st">&#39;SummaryQA&#39;</span>])</span>
<span id="cb50-2"><a href="#cb50-2" tabindex="-1"></a>time_series_scenes</span></code></pre></div>
</div>
<div id="cloud-masking-1" class="section level3">
<h3>Cloud Masking</h3>
<p>As described in the <a
href="https://vip.arizona.edu/documents/MODIS/MODIS_VI_UsersGuide_June_2015_C6.pdf">MODIS
VI User Guide</a> MOD13Q1/A1 QA band contains pixel values representing
overall pixel quality.</p>
<table>
<thead>
<tr class="header">
<th>Value</th>
<th>Summary QA</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>-1</td>
<td>Fill/No Data</td>
<td>Not Processed</td>
</tr>
<tr class="even">
<td>0</td>
<td>Good Data</td>
<td>Use with confidence</td>
</tr>
<tr class="odd">
<td>1</td>
<td>Marginal data</td>
<td>Useful, but look at other QA information</td>
</tr>
<tr class="even">
<td>2</td>
<td>Snow/Ice</td>
<td>Target covered with snow/ice</td>
</tr>
<tr class="odd">
<td>3</td>
<td>Cloudy</td>
<td>Target not visible, covered with cloud</td>
</tr>
</tbody>
</table>
<p>We select all pixels with values 0 or 1 and mask all pixels with snow
or cloud.</p>
<div class="sourceCode" id="cb51"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb51-1"><a href="#cb51-1" tabindex="-1"></a>summary_qa <span class="op">=</span> time_series_scenes.sel(band<span class="op">=</span><span class="st">&#39;SummaryQA&#39;</span>)</span>
<span id="cb51-2"><a href="#cb51-2" tabindex="-1"></a>time_series_scenes_masked <span class="op">=</span> time_series_scenes.sel(band<span class="op">=</span>[<span class="st">&#39;NDVI&#39;</span>, <span class="st">&#39;EVI&#39;</span>]).where(summary_qa <span class="op">&lt;=</span> <span class="dv">1</span>)</span>
<span id="cb51-3"><a href="#cb51-3" tabindex="-1"></a>time_series_scenes_masked</span></code></pre></div>
</div>
<div id="extracting-the-time-series" class="section level3">
<h3>Extracting the time-series</h3>
<p>We extract the time-series at a specific X,Y coordinate.</p>
<div class="sourceCode" id="cb52"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1" tabindex="-1"></a>time_series <span class="op">=</span> time_series_scenes.sel(band<span class="op">=</span>[<span class="st">&#39;NDVI&#39;</span>, <span class="st">&#39;EVI&#39;</span>]).interp(y<span class="op">=</span><span class="fl">13.16</span>, x<span class="op">=</span><span class="fl">77.35</span>)</span></code></pre></div>
<p>This time-series has cloudy pixels which show up as anomalous NDVI
and EVI values.</p>
<div class="sourceCode" id="cb53"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb53-1"><a href="#cb53-1" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb53-2"><a href="#cb53-2" tabindex="-1"></a></span>
<span id="cb53-3"><a href="#cb53-3" tabindex="-1"></a>fig.set_size_inches(<span class="dv">15</span>, <span class="dv">7</span>)</span>
<span id="cb53-4"><a href="#cb53-4" tabindex="-1"></a>time_series.plot.line(ax<span class="op">=</span>ax, x<span class="op">=</span><span class="st">&#39;time&#39;</span>, marker<span class="op">=</span><span class="st">&#39;o&#39;</span>, linestyle<span class="op">=</span><span class="st">&#39;-&#39;</span>, linewidth<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb53-5"><a href="#cb53-5" tabindex="-1"></a>plt.show()</span></code></pre></div>
<p><img
src="python-remote-sensing-output/extracting_time_series_files/extracting_time_series_21_0.png" /></p>
<p>Let’s plot the cloud-masked time-series.</p>
<div class="sourceCode" id="cb54"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb54-1"><a href="#cb54-1" tabindex="-1"></a>time_series_masked <span class="op">=</span> time_series_scenes_masked.sel(band<span class="op">=</span>[<span class="st">&#39;NDVI&#39;</span>, <span class="st">&#39;EVI&#39;</span>]).interp(y<span class="op">=</span><span class="fl">13.16</span>, x<span class="op">=</span><span class="fl">77.35</span>)</span></code></pre></div>
<div class="sourceCode" id="cb55"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb55-1"><a href="#cb55-1" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb55-2"><a href="#cb55-2" tabindex="-1"></a>fig.set_size_inches(<span class="dv">15</span>, <span class="dv">7</span>)</span>
<span id="cb55-3"><a href="#cb55-3" tabindex="-1"></a>time_series_masked.plot.line(ax<span class="op">=</span>ax, x<span class="op">=</span><span class="st">&#39;time&#39;</span>, marker<span class="op">=</span><span class="st">&#39;o&#39;</span>, linestyle<span class="op">=</span><span class="st">&#39;-&#39;</span>, linewidth<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb55-4"><a href="#cb55-4" tabindex="-1"></a>plt.show()</span></code></pre></div>
<p><img
src="python-remote-sensing-output/extracting_time_series_files/extracting_time_series_24_0.png" /></p>
<p>This looks much better, but we have gaps in the time-series due to
masked cloudy-pixels. Replace them with linearly interpolated
values.</p>
<div class="sourceCode" id="cb56"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb56-1"><a href="#cb56-1" tabindex="-1"></a>time_series_masked_interpolated <span class="op">=</span> time_series_masked.chunk(<span class="bu">dict</span>(time<span class="op">=-</span><span class="dv">1</span>)).interpolate_na(<span class="st">&#39;time&#39;</span>)</span></code></pre></div>
<div class="sourceCode" id="cb57"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb57-1"><a href="#cb57-1" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb57-2"><a href="#cb57-2" tabindex="-1"></a>fig.set_size_inches(<span class="dv">15</span>, <span class="dv">7</span>)</span>
<span id="cb57-3"><a href="#cb57-3" tabindex="-1"></a>time_series_masked_interpolated.plot.line(ax<span class="op">=</span>ax, x<span class="op">=</span><span class="st">&#39;time&#39;</span>, marker<span class="op">=</span><span class="st">&#39;o&#39;</span>, linestyle<span class="op">=</span><span class="st">&#39;-&#39;</span>, linewidth<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb57-4"><a href="#cb57-4" tabindex="-1"></a>plt.show()</span></code></pre></div>
<p><img
src="python-remote-sensing-output/extracting_time_series_files/extracting_time_series_27_0.png" /></p>
<p>We can set the series colors to our choice of colors using Matplotlib
Cycler.</p>
<div class="sourceCode" id="cb58"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb58-1"><a href="#cb58-1" tabindex="-1"></a><span class="im">from</span> cycler <span class="im">import</span> cycler</span>
<span id="cb58-2"><a href="#cb58-2" tabindex="-1"></a><span class="im">import</span> matplotlib <span class="im">as</span> mpl</span>
<span id="cb58-3"><a href="#cb58-3" tabindex="-1"></a></span>
<span id="cb58-4"><a href="#cb58-4" tabindex="-1"></a>colorlist <span class="op">=</span> [<span class="st">&#39;#006837&#39;</span>, <span class="st">&#39;#78c679&#39;</span>]</span>
<span id="cb58-5"><a href="#cb58-5" tabindex="-1"></a>custom_cycler <span class="op">=</span> cycler(color<span class="op">=</span>colorlist)</span>
<span id="cb58-6"><a href="#cb58-6" tabindex="-1"></a></span>
<span id="cb58-7"><a href="#cb58-7" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb58-8"><a href="#cb58-8" tabindex="-1"></a>ax.set_prop_cycle(custom_cycler)</span>
<span id="cb58-9"><a href="#cb58-9" tabindex="-1"></a></span>
<span id="cb58-10"><a href="#cb58-10" tabindex="-1"></a>fig.set_size_inches(<span class="dv">15</span>, <span class="dv">7</span>)</span>
<span id="cb58-11"><a href="#cb58-11" tabindex="-1"></a>time_series_masked_interpolated.plot.line(ax<span class="op">=</span>ax, x<span class="op">=</span><span class="st">&#39;time&#39;</span>, marker<span class="op">=</span><span class="st">&#39;o&#39;</span>, linestyle<span class="op">=</span><span class="st">&#39;-&#39;</span>, linewidth<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb58-12"><a href="#cb58-12" tabindex="-1"></a>plt.show()</span></code></pre></div>
<p><img
src="python-remote-sensing-output/extracting_time_series_files/extracting_time_series_29_0.png" /></p>
<p>We can use <code>to_pandas()</code> method to convert the DataArray
into a Pandas DataFrame. The masked pixels are NaN values that we can
fill with a NoData value of -9999.</p>
<div class="sourceCode" id="cb59"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb59-1"><a href="#cb59-1" tabindex="-1"></a>df <span class="op">=</span> time_series_masked.to_pandas()</span>
<span id="cb59-2"><a href="#cb59-2" tabindex="-1"></a>df <span class="op">=</span> df.fillna(<span class="op">-</span><span class="dv">9999</span>)</span>
<span id="cb59-3"><a href="#cb59-3" tabindex="-1"></a>df</span></code></pre></div>
<p>Save the DataFrame as a CSV file.</p>
<div class="sourceCode" id="cb60"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb60-1"><a href="#cb60-1" tabindex="-1"></a>output_filename <span class="op">=</span> <span class="st">&#39;original_time_series.csv&#39;</span></span>
<span id="cb60-2"><a href="#cb60-2" tabindex="-1"></a>output_filepath <span class="op">=</span> os.path.join(output_folder, output_filename)</span>
<span id="cb60-3"><a href="#cb60-3" tabindex="-1"></a>df.reset_index().to_csv(output_filepath, index<span class="op">=</span><span class="va">False</span>)</span></code></pre></div>
</div>
<div id="exercise-1" class="section level3">
<h3>Exercise</h3>
<p>Create another CSV file <code>interpolated_time_series.csv</code>
containing the linearly interpolated NDVI and EVI values.</p>
</div>
</div>
<div id="processing-time-series" class="section level2">
<h2>Processing Time-Series</h2>
<p><a
href="https://colab.research.google.com/github/spatialthoughts/courses/blob/master/code/python_remote_sensing/time_series_processing_xee.ipynb"><img
src="https://colab.research.google.com/assets/colab-badge.svg"
alt="Open In Colab" /></a></p>
<div id="overview-3" class="section level3">
<h3>Overview</h3>
<p>Google Earth Engine (GEE) is a cloud-based platform that has a large
public data catalog and computing infrastructure. The <a
href="https://github.com/google/Xee">XEE</a> extension makes it possible
to obtain pre-processed data cube directly from GEE as a XArray Dataset.
In this section, we will learn how to process the GEE data using XArray
and Dask on local compute infrastructure using the time-series
processing capabilities of XArray.</p>
<p>We will obtain a datacube of cloud-masked Sentinel-2 images for a
year over a chosen region and apply temporal aggregation to obtain mean
monthly NDVI images.</p>
<p><em>Note: You must have a Google Earth Engine account to complete
this section. If you do not have one, <a
href="https://courses.spatialthoughts.com/gee-sign-up.html">follow our
guide</a> to sign up.</em></p>
</div>
<div id="setup-and-data-download-3" class="section level3">
<h3>Setup and Data Download</h3>
<p>The following blocks of code will install the required packages and
download the datasets to your Colab environment.</p>
<div class="sourceCode" id="cb61"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb61-1"><a href="#cb61-1" tabindex="-1"></a><span class="op">%%</span>capture</span>
<span id="cb61-2"><a href="#cb61-2" tabindex="-1"></a><span class="cf">if</span> <span class="st">&#39;google.colab&#39;</span> <span class="kw">in</span> <span class="bu">str</span>(get_ipython()):</span>
<span id="cb61-3"><a href="#cb61-3" tabindex="-1"></a>    <span class="op">!</span>pip install <span class="op">--</span>upgrade xee</span>
<span id="cb61-4"><a href="#cb61-4" tabindex="-1"></a>    <span class="op">!</span>pip install rioxarray</span></code></pre></div>
<div class="sourceCode" id="cb62"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb62-1"><a href="#cb62-1" tabindex="-1"></a></span>
<span id="cb62-2"><a href="#cb62-2" tabindex="-1"></a><span class="im">import</span> ee</span>
<span id="cb62-3"><a href="#cb62-3" tabindex="-1"></a><span class="im">import</span> xarray</span>
<span id="cb62-4"><a href="#cb62-4" tabindex="-1"></a><span class="im">import</span> rioxarray <span class="im">as</span> rxr</span>
<span id="cb62-5"><a href="#cb62-5" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb62-6"><a href="#cb62-6" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb62-7"><a href="#cb62-7" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb62-8"><a href="#cb62-8" tabindex="-1"></a><span class="im">import</span> datetime</span>
<span id="cb62-9"><a href="#cb62-9" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span></code></pre></div>
<div class="sourceCode" id="cb63"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb63-1"><a href="#cb63-1" tabindex="-1"></a>output_folder <span class="op">=</span> <span class="st">&#39;output&#39;</span></span>
<span id="cb63-2"><a href="#cb63-2" tabindex="-1"></a></span>
<span id="cb63-3"><a href="#cb63-3" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> os.path.exists(output_folder):</span>
<span id="cb63-4"><a href="#cb63-4" tabindex="-1"></a>    os.mkdir(output_folder)</span></code></pre></div>
<p>We initialize Google Earth Engine API.You must have a Google Cloud
Project associated with your GEE account. Replace the
<code>cloud_project</code> with your own project from <a
href="https://console.cloud.google.com/">Google Cloud Console</a>. Here
we are using the <a
href="https://developers.google.com/earth-engine/cloud/highvolume">High
Volume Endpoint</a> which is recommended when working with XEE.</p>
<div class="sourceCode" id="cb64"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb64-1"><a href="#cb64-1" tabindex="-1"></a>cloud_project <span class="op">=</span> <span class="st">&#39;spatialthoughts&#39;</span></span>
<span id="cb64-2"><a href="#cb64-2" tabindex="-1"></a></span>
<span id="cb64-3"><a href="#cb64-3" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb64-4"><a href="#cb64-4" tabindex="-1"></a>    ee.Initialize(project<span class="op">=</span>cloud_project, opt_url<span class="op">=</span><span class="st">&#39;https://earthengine-highvolume.googleapis.com&#39;</span>)</span>
<span id="cb64-5"><a href="#cb64-5" tabindex="-1"></a><span class="cf">except</span>:</span>
<span id="cb64-6"><a href="#cb64-6" tabindex="-1"></a>    ee.Authenticate()</span>
<span id="cb64-7"><a href="#cb64-7" tabindex="-1"></a>    ee.Initialize(project<span class="op">=</span>cloud_project, opt_url<span class="op">=</span><span class="st">&#39;https://earthengine-highvolume.googleapis.com&#39;</span>)</span></code></pre></div>
</div>
<div id="data-pre-processing-3" class="section level3">
<h3>Data Pre-Processing</h3>
<p>We start with the Sentinel-2 collection, apply a cloud mask and
compute NDVI using the Google Earth Engine API.</p>
<div class="sourceCode" id="cb65"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb65-1"><a href="#cb65-1" tabindex="-1"></a>s2 <span class="op">=</span> ee.ImageCollection(<span class="st">&#39;COPERNICUS/S2_HARMONIZED&#39;</span>)</span>
<span id="cb65-2"><a href="#cb65-2" tabindex="-1"></a>geometry <span class="op">=</span> ee.Geometry.Polygon([[</span>
<span id="cb65-3"><a href="#cb65-3" tabindex="-1"></a>  [<span class="fl">82.60642647743225</span>, <span class="fl">27.16350437805251</span>],</span>
<span id="cb65-4"><a href="#cb65-4" tabindex="-1"></a>  [<span class="fl">82.60984897613525</span>, <span class="fl">27.1618529901377</span>],</span>
<span id="cb65-5"><a href="#cb65-5" tabindex="-1"></a>  [<span class="fl">82.61088967323303</span>, <span class="fl">27.163695288375266</span>],</span>
<span id="cb65-6"><a href="#cb65-6" tabindex="-1"></a>  [<span class="fl">82.60757446289062</span>, <span class="fl">27.16517483230927</span>]</span>
<span id="cb65-7"><a href="#cb65-7" tabindex="-1"></a>]])</span>
<span id="cb65-8"><a href="#cb65-8" tabindex="-1"></a></span>
<span id="cb65-9"><a href="#cb65-9" tabindex="-1"></a>filtered <span class="op">=</span> s2 <span class="op">\</span></span>
<span id="cb65-10"><a href="#cb65-10" tabindex="-1"></a>  .<span class="bu">filter</span>(ee.Filter.date(<span class="st">&#39;2019-01-01&#39;</span>, <span class="st">&#39;2020-01-01&#39;</span>)) <span class="op">\</span></span>
<span id="cb65-11"><a href="#cb65-11" tabindex="-1"></a>  .<span class="bu">filter</span>(ee.Filter.lt(<span class="st">&#39;CLOUDY_PIXEL_PERCENTAGE&#39;</span>, <span class="dv">30</span>)) <span class="op">\</span></span>
<span id="cb65-12"><a href="#cb65-12" tabindex="-1"></a>  .<span class="bu">filter</span>(ee.Filter.bounds(geometry))</span>
<span id="cb65-13"><a href="#cb65-13" tabindex="-1"></a></span>
<span id="cb65-14"><a href="#cb65-14" tabindex="-1"></a><span class="co"># Write a function for Cloud masking</span></span>
<span id="cb65-15"><a href="#cb65-15" tabindex="-1"></a><span class="kw">def</span> maskS2clouds(image):</span>
<span id="cb65-16"><a href="#cb65-16" tabindex="-1"></a>  qa <span class="op">=</span> image.select(<span class="st">&#39;QA60&#39;</span>)</span>
<span id="cb65-17"><a href="#cb65-17" tabindex="-1"></a>  cloudBitMask <span class="op">=</span> <span class="dv">1</span> <span class="op">&lt;&lt;</span> <span class="dv">10</span></span>
<span id="cb65-18"><a href="#cb65-18" tabindex="-1"></a>  cirrusBitMask <span class="op">=</span> <span class="dv">1</span> <span class="op">&lt;&lt;</span> <span class="dv">11</span></span>
<span id="cb65-19"><a href="#cb65-19" tabindex="-1"></a>  mask <span class="op">=</span> qa.bitwiseAnd(cloudBitMask).eq(<span class="dv">0</span>).And(</span>
<span id="cb65-20"><a href="#cb65-20" tabindex="-1"></a>             qa.bitwiseAnd(cirrusBitMask).eq(<span class="dv">0</span>))</span>
<span id="cb65-21"><a href="#cb65-21" tabindex="-1"></a>  <span class="cf">return</span> image.updateMask(mask).multiply(<span class="fl">0.0001</span>) <span class="op">\</span></span>
<span id="cb65-22"><a href="#cb65-22" tabindex="-1"></a>      .select(<span class="st">&#39;B.*&#39;</span>) <span class="op">\</span></span>
<span id="cb65-23"><a href="#cb65-23" tabindex="-1"></a>      .copyProperties(image, [<span class="st">&#39;system:time_start&#39;</span>])</span>
<span id="cb65-24"><a href="#cb65-24" tabindex="-1"></a></span>
<span id="cb65-25"><a href="#cb65-25" tabindex="-1"></a>filtered <span class="op">=</span> filtered.<span class="bu">map</span>(maskS2clouds)</span>
<span id="cb65-26"><a href="#cb65-26" tabindex="-1"></a><span class="co"># Write a function that computes NDVI for an image and adds it as a band</span></span>
<span id="cb65-27"><a href="#cb65-27" tabindex="-1"></a><span class="kw">def</span> addNDVI(image):</span>
<span id="cb65-28"><a href="#cb65-28" tabindex="-1"></a>  ndvi <span class="op">=</span> image.normalizedDifference([<span class="st">&#39;B8&#39;</span>, <span class="st">&#39;B4&#39;</span>]).rename(<span class="st">&#39;ndvi&#39;</span>)</span>
<span id="cb65-29"><a href="#cb65-29" tabindex="-1"></a>  <span class="cf">return</span> image.addBands(ndvi)</span>
<span id="cb65-30"><a href="#cb65-30" tabindex="-1"></a></span>
<span id="cb65-31"><a href="#cb65-31" tabindex="-1"></a><span class="co"># Map the function over the collection</span></span>
<span id="cb65-32"><a href="#cb65-32" tabindex="-1"></a>withNdvi <span class="op">=</span> filtered.<span class="bu">map</span>(addNDVI)</span></code></pre></div>
<p>Now we have an ImageCollection that we want to get it as a XArray
Dataset. We define the region of interest and extract the
ImageCollection using the ‘ee’ engine.</p>
<p><code>scale</code> in XEE behaves differently than in GEE API. The
value of the <code>scale</code> is in the units of the CRS. So to get
the data at 10 meters resolution, we must also specify a CRS that has
the unit of meters.</p>
<div class="sourceCode" id="cb66"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb66-1"><a href="#cb66-1" tabindex="-1"></a>ds <span class="op">=</span> xarray.open_dataset(</span>
<span id="cb66-2"><a href="#cb66-2" tabindex="-1"></a>    withNdvi.select(<span class="st">&#39;ndvi&#39;</span>),</span>
<span id="cb66-3"><a href="#cb66-3" tabindex="-1"></a>    engine<span class="op">=</span><span class="st">&#39;ee&#39;</span>,</span>
<span id="cb66-4"><a href="#cb66-4" tabindex="-1"></a>    crs<span class="op">=</span><span class="st">&#39;EPSG:3857&#39;</span>,</span>
<span id="cb66-5"><a href="#cb66-5" tabindex="-1"></a>    scale<span class="op">=</span><span class="dv">10</span>,</span>
<span id="cb66-6"><a href="#cb66-6" tabindex="-1"></a>    geometry<span class="op">=</span>geometry,</span>
<span id="cb66-7"><a href="#cb66-7" tabindex="-1"></a>)</span></code></pre></div>
<div class="sourceCode" id="cb67"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb67-1"><a href="#cb67-1" tabindex="-1"></a>ds</span></code></pre></div>
<p>Since we want to work with coordinates in latitude and longitude, we
reproject the raster to <code>EPSG:4326</code>. This requires renaming
and reordering the dimentions to those expected by rioxarray.</p>
<div class="sourceCode" id="cb68"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb68-1"><a href="#cb68-1" tabindex="-1"></a>ds_reprojected <span class="op">=</span> ds<span class="op">\</span></span>
<span id="cb68-2"><a href="#cb68-2" tabindex="-1"></a>  .rename({<span class="st">&#39;Y&#39;</span>: <span class="st">&#39;y&#39;</span>, <span class="st">&#39;X&#39;</span>: <span class="st">&#39;x&#39;</span>}) <span class="op">\</span></span>
<span id="cb68-3"><a href="#cb68-3" tabindex="-1"></a>  .transpose(<span class="st">&#39;time&#39;</span>, <span class="st">&#39;y&#39;</span>, <span class="st">&#39;x&#39;</span>) <span class="op">\</span></span>
<span id="cb68-4"><a href="#cb68-4" tabindex="-1"></a>  .rio.reproject(<span class="st">&#39;EPSG:4326&#39;</span>)</span>
<span id="cb68-5"><a href="#cb68-5" tabindex="-1"></a>ds_reprojected</span></code></pre></div>
<p>Select the <code>ndvi</code> variable. Split the datacube into
‘chunks’ to allow parallel processing using Dask.</p>
<div class="sourceCode" id="cb69"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb69-1"><a href="#cb69-1" tabindex="-1"></a>original_time_series <span class="op">=</span> ds_reprojected.ndvi.chunk(<span class="st">&#39;auto&#39;</span>)</span>
<span id="cb69-2"><a href="#cb69-2" tabindex="-1"></a>original_time_series</span></code></pre></div>
</div>
<div id="aggregating-the-time-series" class="section level3">
<h3>Aggregating the Time-Series</h3>
<p>We have a irregular time-series with a lot of noise. Let’s create a
monthly NDVI time-series by computing the monthly average NDVI. We can
use XArray’s <code>resample()</code> method to aggregate the time-series
by Months and coompute the mean. We specify <em>time</em> as
<code>MS</code> to indicate aggregating by month start and
<em>label</em> as <code>left</code> to indicate we want the start of the
month as our series labels.</p>
<p>Reference <a
href="https://pandas.pydata.org/pandas-docs/stable/user_guide/timeseries.html#offset-aliases">Pandas
Offset Aliases</a></p>
<div class="sourceCode" id="cb70"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb70-1"><a href="#cb70-1" tabindex="-1"></a>time_series_aggregated <span class="op">=</span> original_time_series.resample(time<span class="op">=</span><span class="st">&#39;MS&#39;</span>, label<span class="op">=</span><span class="st">&#39;left&#39;</span>).mean()</span>
<span id="cb70-2"><a href="#cb70-2" tabindex="-1"></a>time_series_aggregated</span></code></pre></div>
<p>Plot and Extract the Time-Series at a Single Location</p>
<div class="sourceCode" id="cb71"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb71-1"><a href="#cb71-1" tabindex="-1"></a>original_ts <span class="op">=</span> original_time_series.interp(x<span class="op">=</span><span class="fl">82.607376</span>, y<span class="op">=</span><span class="fl">27.164335</span>).compute()</span>
<span id="cb71-2"><a href="#cb71-2" tabindex="-1"></a>aggregated_ts <span class="op">=</span> time_series_aggregated.interp(x<span class="op">=</span><span class="fl">82.607376</span>, y<span class="op">=</span><span class="fl">27.164335</span>).compute()</span></code></pre></div>
<div class="sourceCode" id="cb72"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb72-1"><a href="#cb72-1" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb72-2"><a href="#cb72-2" tabindex="-1"></a>fig.set_size_inches(<span class="dv">15</span>, <span class="dv">7</span>)</span>
<span id="cb72-3"><a href="#cb72-3" tabindex="-1"></a>original_ts.plot.line(</span>
<span id="cb72-4"><a href="#cb72-4" tabindex="-1"></a>    ax<span class="op">=</span>ax, x<span class="op">=</span><span class="st">&#39;time&#39;</span>,</span>
<span id="cb72-5"><a href="#cb72-5" tabindex="-1"></a>    marker<span class="op">=</span><span class="st">&#39;^&#39;</span>, color<span class="op">=</span><span class="st">&#39;#66c2a4&#39;</span>, linestyle<span class="op">=</span><span class="st">&#39;--&#39;</span>, linewidth<span class="op">=</span><span class="dv">1</span>, markersize<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb72-6"><a href="#cb72-6" tabindex="-1"></a>aggregated_ts.plot.line(</span>
<span id="cb72-7"><a href="#cb72-7" tabindex="-1"></a>    ax<span class="op">=</span>ax, x<span class="op">=</span><span class="st">&#39;time&#39;</span>,</span>
<span id="cb72-8"><a href="#cb72-8" tabindex="-1"></a>    marker<span class="op">=</span><span class="st">&#39;o&#39;</span>, color<span class="op">=</span><span class="st">&#39;#238b45&#39;</span>, linestyle<span class="op">=</span><span class="st">&#39;-&#39;</span>, linewidth<span class="op">=</span><span class="dv">1</span>, markersize<span class="op">=</span><span class="dv">4</span>)</span>
<span id="cb72-9"><a href="#cb72-9" tabindex="-1"></a></span>
<span id="cb72-10"><a href="#cb72-10" tabindex="-1"></a>ax.set_title(<span class="st">&#39;Original vs. Monthly NDVI Time-Series&#39;</span>, size <span class="op">=</span> <span class="dv">18</span>)</span>
<span id="cb72-11"><a href="#cb72-11" tabindex="-1"></a></span>
<span id="cb72-12"><a href="#cb72-12" tabindex="-1"></a>plt.show()</span></code></pre></div>
<p><img
src="python-remote-sensing-output/time_series_processing_xee_files/time_series_processing_xee_21_0.png" /></p>
</div>
<div id="downloading-time-series-images" class="section level3">
<h3>Downloading Time-Series Images</h3>
<p>Save the processed monthly NDVI images using <code>rioxarray</code>
as GeoTIFF files.</p>
<div class="sourceCode" id="cb73"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb73-1"><a href="#cb73-1" tabindex="-1"></a><span class="cf">for</span> time <span class="kw">in</span> time_series_aggregated.time.values:</span>
<span id="cb73-2"><a href="#cb73-2" tabindex="-1"></a>  image <span class="op">=</span> time_series_aggregated.sel(time<span class="op">=</span>time)</span>
<span id="cb73-3"><a href="#cb73-3" tabindex="-1"></a>  date <span class="op">=</span> np.datetime_as_string(time, unit<span class="op">=</span><span class="st">&#39;M&#39;</span>)</span>
<span id="cb73-4"><a href="#cb73-4" tabindex="-1"></a>  output_file <span class="op">=</span> <span class="ss">f&#39;</span><span class="sc">{</span>date<span class="sc">}</span><span class="ss">.tif&#39;</span></span>
<span id="cb73-5"><a href="#cb73-5" tabindex="-1"></a>  output_path <span class="op">=</span> os.path.join(output_folder, output_file)</span>
<span id="cb73-6"><a href="#cb73-6" tabindex="-1"></a>  image.rio.to_raster(output_path, driver<span class="op">=</span><span class="st">&#39;COG&#39;</span>)</span>
<span id="cb73-7"><a href="#cb73-7" tabindex="-1"></a>  <span class="bu">print</span>(<span class="ss">f&#39;Created file at </span><span class="sc">{</span>output_path<span class="sc">}</span><span class="ss">&#39;</span>)</span></code></pre></div>
</div>
<div id="exercise-2" class="section level3">
<h3>Exercise</h3>
<p>Aggregate the time-series to 15-day interval. Apply gap-filling to
fill missing values.</p>
<p><em>Hint: Refer to Reference <a
href="https://pandas.pydata.org/pandas-docs/stable/user_guide/timeseries.html#offset-aliases">Pandas
Offset Aliases</a> for appropriate string value for the time
parameter.</em></p>
</div>
</div>
</div>
<div id="scaling-computation-with-dask" class="section level1">
<h1>2. Scaling Computation with Dask</h1>
<p><a href="https://www.dask.org/"><code>Dask</code></a> is a python
library to run your computation in parallel across many machines. Dask
has built-in support for key geospatial packages like XArray and Pandas
allowing you to scale your computation easily. You can choose to run
your code in parallel on your laptop, a machine in the cloud, local or
cloud cluster of machines etc.</p>
<div id="calculating-zonal-statistics" class="section level2">
<h2>Calculating Zonal Statistics</h2>
<p><a
href="https://colab.research.google.com/github/spatialthoughts/courses/blob/master/code/python_remote_sensing/zonal_statistics.ipynb"><img
src="https://colab.research.google.com/assets/colab-badge.svg"
alt="Open In Colab" /></a></p>
<div id="overview-4" class="section level3">
<h3>Overview</h3>
<p>Zonal Statistics is used to summarises the values of a raster dataset
within the zones of a vector dataset. Here we select all Admin1 units of
a country and calculate a sum of nighttime light pixel intensities over
multiple years. This is a large computation that is enabled by
cloud-hosted NightTime Lights data in the Cloud-Optimized GeoTIFF (COG)
format and parallel computing on a local dask cluster.</p>
</div>
<div id="setup-and-data-download-4" class="section level3">
<h3>Setup and Data Download</h3>
<p>The following blocks of code will install the required packages and
download the datasets to your Colab environment.</p>
<div class="sourceCode" id="cb74"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb74-1"><a href="#cb74-1" tabindex="-1"></a><span class="op">%%</span>capture</span>
<span id="cb74-2"><a href="#cb74-2" tabindex="-1"></a><span class="cf">if</span> <span class="st">&#39;google.colab&#39;</span> <span class="kw">in</span> <span class="bu">str</span>(get_ipython()):</span>
<span id="cb74-3"><a href="#cb74-3" tabindex="-1"></a>    <span class="op">!</span>apt install libspatialindex<span class="op">-</span>dev</span>
<span id="cb74-4"><a href="#cb74-4" tabindex="-1"></a>    <span class="op">!</span>pip install fiona shapely pyproj rtree</span>
<span id="cb74-5"><a href="#cb74-5" tabindex="-1"></a>    <span class="op">!</span>pip install geopandas</span>
<span id="cb74-6"><a href="#cb74-6" tabindex="-1"></a>    <span class="op">!</span>pip install rioxarray</span>
<span id="cb74-7"><a href="#cb74-7" tabindex="-1"></a>    <span class="op">!</span>pip install regionmask</span></code></pre></div>
<div class="sourceCode" id="cb75"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb75-1"><a href="#cb75-1" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb75-2"><a href="#cb75-2" tabindex="-1"></a><span class="im">import</span> glob</span>
<span id="cb75-3"><a href="#cb75-3" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb75-4"><a href="#cb75-4" tabindex="-1"></a><span class="im">import</span> geopandas <span class="im">as</span> gpd</span>
<span id="cb75-5"><a href="#cb75-5" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb75-6"><a href="#cb75-6" tabindex="-1"></a><span class="im">import</span> xarray <span class="im">as</span> xr</span>
<span id="cb75-7"><a href="#cb75-7" tabindex="-1"></a><span class="im">import</span> rioxarray <span class="im">as</span> rxr</span>
<span id="cb75-8"><a href="#cb75-8" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb75-9"><a href="#cb75-9" tabindex="-1"></a><span class="im">from</span> datetime <span class="im">import</span> datetime</span>
<span id="cb75-10"><a href="#cb75-10" tabindex="-1"></a><span class="im">import</span> dask</span>
<span id="cb75-11"><a href="#cb75-11" tabindex="-1"></a><span class="im">import</span> regionmask</span></code></pre></div>
<div class="sourceCode" id="cb76"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb76-1"><a href="#cb76-1" tabindex="-1"></a><span class="im">import</span> warnings</span>
<span id="cb76-2"><a href="#cb76-2" tabindex="-1"></a><span class="im">import</span> rasterio</span>
<span id="cb76-3"><a href="#cb76-3" tabindex="-1"></a>warnings.filterwarnings(<span class="st">&quot;ignore&quot;</span>, category<span class="op">=</span>rasterio.RasterioDeprecationWarning)</span></code></pre></div>
<div class="sourceCode" id="cb77"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb77-1"><a href="#cb77-1" tabindex="-1"></a><span class="im">from</span> dask.distributed <span class="im">import</span> Client, progress</span>
<span id="cb77-2"><a href="#cb77-2" tabindex="-1"></a>client <span class="op">=</span> Client()  <span class="co"># set up local cluster on the machine</span></span>
<span id="cb77-3"><a href="#cb77-3" tabindex="-1"></a>client</span></code></pre></div>
<div class="sourceCode" id="cb78"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb78-1"><a href="#cb78-1" tabindex="-1"></a>dask.config.<span class="bu">set</span>({<span class="st">&quot;array.slicing.split_large_chunks&quot;</span>: <span class="va">False</span>})</span>
<span id="cb78-2"><a href="#cb78-2" tabindex="-1"></a>dask.config.<span class="bu">set</span>({<span class="st">&#39;array.chunk-size&#39;</span>: <span class="st">&#39;32MiB&#39;</span>})</span></code></pre></div>
<div class="sourceCode" id="cb79"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb79-1"><a href="#cb79-1" tabindex="-1"></a>data_folder <span class="op">=</span> <span class="st">&#39;data&#39;</span></span>
<span id="cb79-2"><a href="#cb79-2" tabindex="-1"></a>output_folder <span class="op">=</span> <span class="st">&#39;output&#39;</span></span>
<span id="cb79-3"><a href="#cb79-3" tabindex="-1"></a></span>
<span id="cb79-4"><a href="#cb79-4" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> os.path.exists(data_folder):</span>
<span id="cb79-5"><a href="#cb79-5" tabindex="-1"></a>    os.mkdir(data_folder)</span>
<span id="cb79-6"><a href="#cb79-6" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> os.path.exists(output_folder):</span>
<span id="cb79-7"><a href="#cb79-7" tabindex="-1"></a>    os.mkdir(output_folder)</span></code></pre></div>
<div class="sourceCode" id="cb80"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb80-1"><a href="#cb80-1" tabindex="-1"></a><span class="kw">def</span> download(url):</span>
<span id="cb80-2"><a href="#cb80-2" tabindex="-1"></a>    filename <span class="op">=</span> os.path.join(data_folder, os.path.basename(url))</span>
<span id="cb80-3"><a href="#cb80-3" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> os.path.exists(filename):</span>
<span id="cb80-4"><a href="#cb80-4" tabindex="-1"></a>        <span class="im">from</span> urllib.request <span class="im">import</span> urlretrieve</span>
<span id="cb80-5"><a href="#cb80-5" tabindex="-1"></a>        local, _ <span class="op">=</span> urlretrieve(url, filename)</span>
<span id="cb80-6"><a href="#cb80-6" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&#39;Downloaded &#39;</span> <span class="op">+</span> local)</span>
<span id="cb80-7"><a href="#cb80-7" tabindex="-1"></a></span>
<span id="cb80-8"><a href="#cb80-8" tabindex="-1"></a>admin1_zipfile <span class="op">=</span> <span class="st">&#39;ne_10m_admin_1_states_provinces.zip&#39;</span></span>
<span id="cb80-9"><a href="#cb80-9" tabindex="-1"></a>admin1_url <span class="op">=</span> <span class="st">&#39;https://naciscdn.org/naturalearth/10m/cultural/&#39;</span></span>
<span id="cb80-10"><a href="#cb80-10" tabindex="-1"></a></span>
<span id="cb80-11"><a href="#cb80-11" tabindex="-1"></a>download(admin1_url <span class="op">+</span> admin1_zipfile)</span></code></pre></div>
</div>
<div id="data-pre-processing-4" class="section level3">
<h3>Data Pre-Processing</h3>
<p>First we will read the GDL shapefile and filter to a country. The
‘adm1_code’ column contains a unique id for all the counties present in
the state, but it is of <code>object</code> type. We need to convert it
to <code>int</code> type to be used in xarray.</p>
<div class="sourceCode" id="cb81"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb81-1"><a href="#cb81-1" tabindex="-1"></a>country_code <span class="op">=</span> <span class="st">&#39;LK&#39;</span></span>
<span id="cb81-2"><a href="#cb81-2" tabindex="-1"></a>admin1_file_path <span class="op">=</span> os.path.join(data_folder, admin1_zipfile)</span>
<span id="cb81-3"><a href="#cb81-3" tabindex="-1"></a></span>
<span id="cb81-4"><a href="#cb81-4" tabindex="-1"></a>admin1_df <span class="op">=</span> gpd.read_file(admin1_file_path)</span>
<span id="cb81-5"><a href="#cb81-5" tabindex="-1"></a></span>
<span id="cb81-6"><a href="#cb81-6" tabindex="-1"></a>zones <span class="op">=</span> admin1_df[admin1_df[<span class="st">&#39;iso_a2&#39;</span>] <span class="op">==</span> country_code][[<span class="st">&#39;adm1_code&#39;</span>, <span class="st">&#39;name&#39;</span>, <span class="st">&#39;iso_a2&#39;</span>, <span class="st">&#39;geometry&#39;</span>]].copy()</span>
<span id="cb81-7"><a href="#cb81-7" tabindex="-1"></a>zones[<span class="st">&#39;id&#39;</span>] <span class="op">=</span> zones.reset_index().index <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb81-8"><a href="#cb81-8" tabindex="-1"></a>zones</span></code></pre></div>
<div class="sourceCode" id="cb82"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb82-1"><a href="#cb82-1" tabindex="-1"></a>bbox <span class="op">=</span> zones.total_bounds</span>
<span id="cb82-2"><a href="#cb82-2" tabindex="-1"></a>bbox</span></code></pre></div>
<p>Next we read the NTL files and create an XArray object.</p>
<p>These files were download from <a
href="https://dataverse.harvard.edu/dataset.xhtml?persistentId=doi:10.7910/DVN/YGIVCD">Harvard
Dataverse</a> and converted to Cloud-Optimized GeoTIFFs using GDAL.</p>
<p>Example command</p>
<pre><code>gdalwarp -of COG 2021_HasMask/LongNTL_2021.tif 2021.tif \
 -te -180 -90 180 90 -dstnodata 0 \
 -co COMPRESS=DEFLATE -co PREDICTOR=2 -co NUM_THREADS=ALL_CPUS</code></pre>
<p>The resulting files are now hosted on a Google Cloud Storage
bucket.</p>
<div class="sourceCode" id="cb84"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb84-1"><a href="#cb84-1" tabindex="-1"></a>start_year <span class="op">=</span> <span class="dv">2015</span></span>
<span id="cb84-2"><a href="#cb84-2" tabindex="-1"></a>end_year <span class="op">=</span> <span class="dv">2020</span></span></code></pre></div>
<div class="sourceCode" id="cb85"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb85-1"><a href="#cb85-1" tabindex="-1"></a></span>
<span id="cb85-2"><a href="#cb85-2" tabindex="-1"></a>ntl_folder <span class="op">=</span> <span class="st">&#39;https://storage.googleapis.com/spatialthoughts-public-data/ntl/npp_viirs_ntl&#39;</span></span>
<span id="cb85-3"><a href="#cb85-3" tabindex="-1"></a></span>
<span id="cb85-4"><a href="#cb85-4" tabindex="-1"></a>da_list <span class="op">=</span> []</span>
<span id="cb85-5"><a href="#cb85-5" tabindex="-1"></a></span>
<span id="cb85-6"><a href="#cb85-6" tabindex="-1"></a><span class="cf">for</span> year <span class="kw">in</span> <span class="bu">range</span>(start_year, end_year <span class="op">+</span> <span class="dv">1</span>):</span>
<span id="cb85-7"><a href="#cb85-7" tabindex="-1"></a>  cog_url <span class="op">=</span> <span class="ss">f&#39;</span><span class="sc">{</span>ntl_folder<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>year<span class="sc">}</span><span class="ss">.tif&#39;</span></span>
<span id="cb85-8"><a href="#cb85-8" tabindex="-1"></a>  da <span class="op">=</span> rxr.open_rasterio(</span>
<span id="cb85-9"><a href="#cb85-9" tabindex="-1"></a>      cog_url,</span>
<span id="cb85-10"><a href="#cb85-10" tabindex="-1"></a>      chunks<span class="op">=</span><span class="va">True</span>).rio.clip_box(<span class="op">*</span>bbox)</span>
<span id="cb85-11"><a href="#cb85-11" tabindex="-1"></a>  dt <span class="op">=</span> pd.to_datetime(year, <span class="bu">format</span><span class="op">=</span><span class="st">&#39;%Y&#39;</span>)</span>
<span id="cb85-12"><a href="#cb85-12" tabindex="-1"></a>  da <span class="op">=</span> da.assign_coords(time <span class="op">=</span> dt)</span>
<span id="cb85-13"><a href="#cb85-13" tabindex="-1"></a>  da <span class="op">=</span> da.expand_dims(dim<span class="op">=</span><span class="st">&quot;time&quot;</span>)</span>
<span id="cb85-14"><a href="#cb85-14" tabindex="-1"></a>  da_list.append(da)</span></code></pre></div>
<div class="sourceCode" id="cb86"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb86-1"><a href="#cb86-1" tabindex="-1"></a>ntl_datacube <span class="op">=</span> xr.concat(da_list, dim<span class="op">=</span><span class="st">&#39;time&#39;</span>).chunk(<span class="st">&#39;auto&#39;</span>)</span>
<span id="cb86-2"><a href="#cb86-2" tabindex="-1"></a>ntl_datacube</span></code></pre></div>
<div class="sourceCode" id="cb87"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb87-1"><a href="#cb87-1" tabindex="-1"></a>ntl_datacube <span class="op">=</span> ntl_datacube.sel(band<span class="op">=</span><span class="dv">1</span>, drop<span class="op">=</span><span class="va">True</span>)</span></code></pre></div>
</div>
<div id="zonal-stats" class="section level3">
<h3>Zonal Stats</h3>
<p>Now we will extract the sum of the raster pixel values for every
admin1 region in the selected countrey.</p>
<p>First, we need to convert the GeoDataFrame to a XArray Dataset. We
will be using the <code>regionmask</code> module for that. It takes
geodataframe, it’s unique value as integer and converts the geodataframe
into a <code>xarray dataset</code> having dimension and coordinates same
as of given input xarray dataset</p>
<div class="sourceCode" id="cb88"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb88-1"><a href="#cb88-1" tabindex="-1"></a><span class="co"># Create mask of multiple regions from shapefile</span></span>
<span id="cb88-2"><a href="#cb88-2" tabindex="-1"></a>mask <span class="op">=</span> regionmask.mask_3D_geopandas(</span>
<span id="cb88-3"><a href="#cb88-3" tabindex="-1"></a>        zones,</span>
<span id="cb88-4"><a href="#cb88-4" tabindex="-1"></a>        ntl_datacube.x,</span>
<span id="cb88-5"><a href="#cb88-5" tabindex="-1"></a>        ntl_datacube.y,</span>
<span id="cb88-6"><a href="#cb88-6" tabindex="-1"></a>        drop<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb88-7"><a href="#cb88-7" tabindex="-1"></a>        numbers<span class="op">=</span><span class="st">&quot;id&quot;</span>,</span>
<span id="cb88-8"><a href="#cb88-8" tabindex="-1"></a>        overlap<span class="op">=</span><span class="va">True</span></span>
<span id="cb88-9"><a href="#cb88-9" tabindex="-1"></a>    )</span></code></pre></div>
<div class="sourceCode" id="cb89"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb89-1"><a href="#cb89-1" tabindex="-1"></a>ntl_datacube <span class="op">=</span> ntl_datacube.where(mask).chunk(<span class="st">&#39;auto&#39;</span>)</span>
<span id="cb89-2"><a href="#cb89-2" tabindex="-1"></a>ntl_datacube</span></code></pre></div>
<div class="sourceCode" id="cb90"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb90-1"><a href="#cb90-1" tabindex="-1"></a>grouped <span class="op">=</span> ntl_datacube.groupby(<span class="st">&#39;time&#39;</span>).<span class="bu">sum</span>([<span class="st">&#39;x&#39;</span>,<span class="st">&#39;y&#39;</span>])</span>
<span id="cb90-2"><a href="#cb90-2" tabindex="-1"></a>grouped</span></code></pre></div>
<div class="sourceCode" id="cb91"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb91-1"><a href="#cb91-1" tabindex="-1"></a><span class="op">%</span>time grouped <span class="op">=</span> grouped.compute()</span></code></pre></div>
<div class="sourceCode" id="cb92"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb92-1"><a href="#cb92-1" tabindex="-1"></a>stats <span class="op">=</span> grouped.drop(<span class="st">&#39;spatial_ref&#39;</span>).to_dataframe(<span class="st">&#39;sum&#39;</span>).reset_index()</span>
<span id="cb92-2"><a href="#cb92-2" tabindex="-1"></a>stats</span></code></pre></div>
<div class="sourceCode" id="cb93"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb93-1"><a href="#cb93-1" tabindex="-1"></a>stats[<span class="st">&#39;year&#39;</span>] <span class="op">=</span> stats.time.dt.year</span>
<span id="cb93-2"><a href="#cb93-2" tabindex="-1"></a>stats <span class="op">=</span> stats.rename(columns<span class="op">=</span>{<span class="st">&#39;region&#39;</span>: <span class="st">&#39;id&#39;</span>})</span>
<span id="cb93-3"><a href="#cb93-3" tabindex="-1"></a>stats</span></code></pre></div>
<div class="sourceCode" id="cb94"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb94-1"><a href="#cb94-1" tabindex="-1"></a>results <span class="op">=</span> zones.merge(stats, on<span class="op">=</span><span class="st">&#39;id&#39;</span>)</span>
<span id="cb94-2"><a href="#cb94-2" tabindex="-1"></a>results</span></code></pre></div>
<p>Finally, we save the result to disk.</p>
<div class="sourceCode" id="cb95"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb95-1"><a href="#cb95-1" tabindex="-1"></a>output <span class="op">=</span> results[[<span class="st">&#39;adm1_code&#39;</span>, <span class="st">&#39;name&#39;</span>, <span class="st">&#39;iso_a2&#39;</span>, <span class="st">&#39;year&#39;</span>, <span class="st">&#39;sum&#39;</span>]]</span>
<span id="cb95-2"><a href="#cb95-2" tabindex="-1"></a>output</span></code></pre></div>
<div class="sourceCode" id="cb96"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb96-1"><a href="#cb96-1" tabindex="-1"></a>output_file <span class="op">=</span> <span class="st">&#39;output.csv&#39;</span></span>
<span id="cb96-2"><a href="#cb96-2" tabindex="-1"></a>output_path <span class="op">=</span> os.path.join(output_folder, output_file)</span>
<span id="cb96-3"><a href="#cb96-3" tabindex="-1"></a></span>
<span id="cb96-4"><a href="#cb96-4" tabindex="-1"></a>output.to_csv(output_path, index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb96-5"><a href="#cb96-5" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&#39;Successfully written output file at </span><span class="sc">{}</span><span class="st">&#39;</span>.<span class="bu">format</span>(output_path))</span></code></pre></div>
</div>
<div id="exercise-3" class="section level3">
<h3>Exercise</h3>
<p>Change the code to calculate the Zonal Statistics for all admin1
units in your chosen country.</p>
<hr />
</div>
</div>
</div>
<div id="license" class="section level1">
<h1>License</h1>
<p>This course material is licensed under a <a
href="https://creativecommons.org/licenses/by/4.0/">Creative Commons
Attribution 4.0 International (CC BY 4.0)</a>. You are free to re-use
and adapt the material but are required to give appropriate credit to
the original author as below:</p>
<p><em>Cloud-basd Remote Sensing with Python Course</em> by Ujaval
Gandhi <a
href="https://spatialthoughts.com">www.spatialthoughts.com</a></p>
<hr />
<p><strong>This course is offered as an instructor-led online class.
Visit <a href="https://spatialthoughts.com/events">Spatial Thoughts</a>
to know details of upcoming sessions.</strong></p>
<hr />
<p>© 2023 Spatial Thoughts <a
href="https://spatialthoughts.com">www.spatialthoughts.com</a></p>
</div>

<!-- Comment Section Powered by utterances -->
<div id="comments">
  <hr />
  <p>If you want to report any issues with this page, please comment below.</p>
<script src="https://utteranc.es/client.js"
        repo="spatialthoughts/courses"
        issue-term="title"
        label="comment"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>
</div>



</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.odd').parent('tbody').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open');
  });
});
</script>

<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
