<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />


<meta name="author" content="Ujaval Gandhi" />


<title>Scalable Remote Sensing Workflows with Xarray (Full Workshop)</title>

<script src="site_libs/header-attrs-2.10/header-attrs.js"></script>
<script src="site_libs/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/flatly.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<style>h1 {font-size: 34px;}
       h1.title {font-size: 38px;}
       h2 {font-size: 30px;}
       h3 {font-size: 24px;}
       h4 {font-size: 18px;}
       h5 {font-size: 16px;}
       h6 {font-size: 12px;}
       code {color: inherit; background-color: rgba(0, 0, 0, 0.04);}
       pre:not([class]) { background-color: white }</style>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<link href="site_libs/pagedtable-1.1/css/pagedtable.css" rel="stylesheet" />
<script src="site_libs/pagedtable-1.1/js/pagedtable.js"></script>
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-PDGF11RK4Z"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-PDGF11RK4Z');
</script>

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>


<style type="text/css">
  code {
    white-space: pre;
  }
  .sourceCode {
    overflow: visible;
  }
</style>
<style type="text/css" data-origin="pandoc">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */

</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    for (var j = 0; j < rules.length; j++) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") continue;
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') continue;
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>







<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
pre code {
  padding: 0;
}
</style>


<style type="text/css">
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #adb5bd;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script type="text/javascript">
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.tab('show');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');

  // Navbar adjustments
  var navHeight = $(".navbar").first().height() + 15;
  var style = document.createElement('style');
  var pt = "padding-top: " + navHeight + "px; ";
  var mt = "margin-top: -" + navHeight + "px; ";
  var css = "";
  // offset scroll position for anchor links (for fixed navbar)
  for (var i = 1; i <= 6; i++) {
    css += ".section h" + i + "{ " + pt + mt + "}\n";
  }
  style.innerHTML = "body {" + pt + "padding-bottom: 40px; }\n" + css;
  document.head.appendChild(style);
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "&#xe258;";
  border: none;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->




</head>

<body>


<div class="container-fluid main-container">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">Courses</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="http://spatialthoughts.com">Back to Main Site</a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li>
  <a href="#">Back to Top</a>
</li>
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div id="header">



<h1 class="title toc-ignore">Scalable Remote Sensing Workflows with
Xarray (Full Workshop)</h1>
<h3 class="subtitle">A structured introduction to XArray, STAC and Dask
with use-cases focused on cloud-based remote sensing applications.</h3>
<h4 class="author">Ujaval Gandhi</h4>

</div>

<div id="TOC">
<ul>
<li><a href="#introduction" id="toc-introduction">Introduction</a></li>
<li><a href="#notebooks-and-datasets"
id="toc-notebooks-and-datasets">Notebooks and Datasets</a></li>
<li><a href="#hello-colab" id="toc-hello-colab">Hello Colab</a></li>
<li><a href="#xarray-basics" id="toc-xarray-basics">1. XArray
Basics</a></li>
<li><a href="#stac-and-dask-basics" id="toc-stac-and-dask-basics">2.
STAC and Dask Basics</a></li>
<li><a href="#calculating-spectral-indices"
id="toc-calculating-spectral-indices">3. Calculating Spectral
Indices</a></li>
<li><a href="#masking-clouds" id="toc-masking-clouds">4. Masking
Clouds</a></li>
<li><a href="#extracting-time-series" id="toc-extracting-time-series">5.
Extracting Time-Series</a></li>
<li><a href="#license" id="toc-license">License</a></li>
</ul>
</div>

<div style="page-break-after: always;"></div>
<hr />
<p><img src="images/spatial_thoughts_logo.png" width="250pt" style="display: block; margin: auto;" /></p>
<hr />
<div style="page-break-after: always;"></div>
<div id="introduction" class="section level1">
<h1>Introduction</h1>
<p>XArray is a powerful Python package for working with climate and
earth observation datasets. Inspired by libraries like pandas - it is
particularly suited for working with multi-dimensional time-series
raster datasets. With the growing ecosystem of spatial extensions like
rioxarray and xarray-spatial and built-in support for parallel computing
with Dask, it has become the de-facto standard for working with large
spatio-temporal raster datasets. This workshop will show you how you can
use it to effectively process large volumes of earth observation data
using cloud-based datasets.</p>
</div>
<div id="notebooks-and-datasets" class="section level1">
<h1>Notebooks and Datasets</h1>
<p>This workshop uses Google Colab for all exercises. You do not need to
install any packages or download any datasets.</p>
<p>The notebooks can be accessed by clicking on the <img
src="https://colab.research.google.com/assets/colab-badge.svg"
alt="Open In Colab" /> buttons at the beginning of each section. Once
you have opened the notebook in Colab, you can copy it to your own
account by going to <em>File → Save a Copy in Drive</em>.</p>
<p><img src="images/common/colab1.png" width="75%" style="display: block; margin: auto;" /></p>
<p>Once the notebooks are saved to your drive, you will be able to
modify the code and save the updated copy. You can also click the
<em>Share</em> button and share a link to the notebook with others.</p>
<p><img src="images/common/colab2.png" width="75%" style="display: block; margin: auto;" /></p>
</div>
<div id="hello-colab" class="section level1">
<h1>Hello Colab</h1>
<p><a
href="https://colab.research.google.com/github/spatialthoughts/python-dataviz-web/blob/main/00_hello_colab.ipynb"><img
src="https://colab.research.google.com/assets/colab-badge.svg"
alt="Open In Colab" /></a></p>
<p><a href="https://colab.research.google.com/">Google Colab</a> is a
hosted Jupyter notebook environment that allows anyone to run Python
code via a web-browser. It provides you free computation and data
storage that can be utilized by your Python code.</p>
<p>You can click the <code>+Code</code> button to create a new cell and
enter a block of code. To run the code, click the <strong>Run
Code</strong> button next to the cell, or press <code>Shirt+Enter</code>
key.</p>
<div class="sourceCode" id="cb1"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&#39;Hello World&#39;</span>)</span></code></pre></div>
<div id="package-management" class="section level3">
<h3>Package Management</h3>
<p>Colab comes pre-installed with many Python packages. You can use a
package by simply importing it.</p>
<div class="sourceCode" id="cb2"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb2-2"><a href="#cb2-2" tabindex="-1"></a><span class="im">import</span> geopandas <span class="im">as</span> gpd</span></code></pre></div>
<p>Each Colab notebook instance is run on a Ubuntu Linux machine in the
cloud. If you want to install any packages, you can run a command by
prefixing the command with a <code>!</code>. For example, you can
install third-party packages via <code>pip</code> using the command
<code>!pip</code>.</p>
<blockquote>
<p>Tip: If you want to list all pre-install packages and their versions
in your Colab environemnt, you can run <code>!pip list -v</code>.</p>
</blockquote>
<div class="sourceCode" id="cb3"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a><span class="op">!</span>pip install rioxarray</span></code></pre></div>
<div class="sourceCode" id="cb4"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a><span class="im">import</span> rioxarray</span></code></pre></div>
</div>
<div id="data-management" class="section level3">
<h3>Data Management</h3>
<p>Colab provides 100GB of disk space along with your notebook. This can
be used to store your data, intermediate outputs and results.</p>
<p>The code below will create 2 folders named ‘data’ and ‘output’ in
your local filesystem.</p>
<div class="sourceCode" id="cb5"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb5-2"><a href="#cb5-2" tabindex="-1"></a></span>
<span id="cb5-3"><a href="#cb5-3" tabindex="-1"></a>data_folder <span class="op">=</span> <span class="st">&#39;data&#39;</span></span>
<span id="cb5-4"><a href="#cb5-4" tabindex="-1"></a>output_folder <span class="op">=</span> <span class="st">&#39;output&#39;</span></span>
<span id="cb5-5"><a href="#cb5-5" tabindex="-1"></a></span>
<span id="cb5-6"><a href="#cb5-6" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> os.path.exists(data_folder):</span>
<span id="cb5-7"><a href="#cb5-7" tabindex="-1"></a>    os.mkdir(data_folder)</span>
<span id="cb5-8"><a href="#cb5-8" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> os.path.exists(output_folder):</span>
<span id="cb5-9"><a href="#cb5-9" tabindex="-1"></a>    os.mkdir(output_folder)</span></code></pre></div>
<p>We can download some data from the internet and store it in the Colab
environment. Below is a helper function to download a file from a
URL.</p>
<div class="sourceCode" id="cb6"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a><span class="im">import</span> requests</span>
<span id="cb6-2"><a href="#cb6-2" tabindex="-1"></a></span>
<span id="cb6-3"><a href="#cb6-3" tabindex="-1"></a><span class="kw">def</span> download(url):</span>
<span id="cb6-4"><a href="#cb6-4" tabindex="-1"></a>    filename <span class="op">=</span> os.path.join(data_folder, os.path.basename(url))</span>
<span id="cb6-5"><a href="#cb6-5" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> os.path.exists(filename):</span>
<span id="cb6-6"><a href="#cb6-6" tabindex="-1"></a>      <span class="cf">with</span> requests.get(url, stream<span class="op">=</span><span class="va">True</span>, allow_redirects<span class="op">=</span><span class="va">True</span>) <span class="im">as</span> r:</span>
<span id="cb6-7"><a href="#cb6-7" tabindex="-1"></a>          <span class="cf">with</span> <span class="bu">open</span>(filename, <span class="st">&#39;wb&#39;</span>) <span class="im">as</span> f:</span>
<span id="cb6-8"><a href="#cb6-8" tabindex="-1"></a>              <span class="cf">for</span> chunk <span class="kw">in</span> r.iter_content(chunk_size<span class="op">=</span><span class="dv">8192</span>):</span>
<span id="cb6-9"><a href="#cb6-9" tabindex="-1"></a>                  f.write(chunk)</span>
<span id="cb6-10"><a href="#cb6-10" tabindex="-1"></a>      <span class="bu">print</span>(<span class="st">&#39;Downloaded&#39;</span>, filename)</span></code></pre></div>
<p>Let’s download the <a
href="https://www.naturalearthdata.com/downloads/10m-cultural-vectors/">Populated
Places</a> dataset from Natural Earth.</p>
<div class="sourceCode" id="cb7"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a>download(<span class="st">&#39;https://naciscdn.org/naturalearth/10m/cultural/&#39;</span> <span class="op">+</span></span>
<span id="cb7-2"><a href="#cb7-2" tabindex="-1"></a>         <span class="st">&#39;ne_10m_populated_places_simple.zip&#39;</span>)</span></code></pre></div>
<p>The file is now in our local filesystem. We can construct the path to
the data folder and read it using <code>geopandas</code></p>
<div class="sourceCode" id="cb8"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a><span class="bu">file</span> <span class="op">=</span> <span class="st">&#39;ne_10m_populated_places_simple.zip&#39;</span></span>
<span id="cb8-2"><a href="#cb8-2" tabindex="-1"></a>filepath <span class="op">=</span> os.path.join(data_folder, <span class="bu">file</span>)</span>
<span id="cb8-3"><a href="#cb8-3" tabindex="-1"></a>places <span class="op">=</span> gpd.read_file(filepath)</span></code></pre></div>
<p>Let’s do some data processing and write the results to a new file.
The code below will filter all places which are also country
capitals.</p>
<div class="sourceCode" id="cb9"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a>capitals <span class="op">=</span> places[places[<span class="st">&#39;adm0cap&#39;</span>] <span class="op">==</span> <span class="dv">1</span>]</span>
<span id="cb9-2"><a href="#cb9-2" tabindex="-1"></a>capitals</span></code></pre></div>
<p>We can write the results to the disk as a GeoPackage file.</p>
<div class="sourceCode" id="cb10"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" tabindex="-1"></a>output_file <span class="op">=</span> <span class="st">&#39;capitals.gpkg&#39;</span></span>
<span id="cb10-2"><a href="#cb10-2" tabindex="-1"></a>output_path <span class="op">=</span> os.path.join(output_folder, output_file)</span>
<span id="cb10-3"><a href="#cb10-3" tabindex="-1"></a>capitals.to_file(driver<span class="op">=</span><span class="st">&#39;GPKG&#39;</span>, filename<span class="op">=</span>output_path)</span></code></pre></div>
<p>You can open the <strong>Files</strong> tab from the left-hand panel
in Colab and browse to the <code>output</code> folder. Locate the
<code>capitals.gpkg</code> file and click the <strong>⋮</strong> button
and select <em>Download</em> to download the file locally.</p>
</div>
</div>
<div id="xarray-basics" class="section level1">
<h1>1. XArray Basics</h1>
<p><a
href="https://colab.research.google.com/github/spatialthoughts/courses/blob/master/code/python_remote_sensing/01_xarray_basics.ipynb"><img
src="https://colab.research.google.com/assets/colab-badge.svg"
alt="Open In Colab" /></a></p>
<div id="overview" class="section level2">
<h2>Overview</h2>
<p><a href="https://docs.xarray.dev/en/stable/"><code>XArray</code></a>
has emerged as one of the key Python libraries to work with gridded
raster datasets. It can natively handle time-series data making it ideal
for working with Remote Sensing datasets. It builds on NumPy/Pandas for
fast arrays/indexing and is orders of magnitude faster than other Python
libraries like <code>rasterio</code>. It has a growing ecosystem of
extensions <code>rioxarray</code>, <code>xarray-spatial</code>,
<code>XEE</code> and more allowing it to be used for geospatial
analysis. XArray offers the flexibility to seamlessly work with local
datasets along with cloud-hosted datasets in a variety of optimized data
formats.</p>
<p>In this section, we will learn about XArray basics and learn how to
work with a time-series of Sentinel-2 satellite imagery to create and
visualize a median composite image.</p>
</div>
<div id="setup-and-data-download" class="section level2">
<h2>Setup and Data Download</h2>
<p>The following blocks of code will install the required packages and
download the datasets to your Colab environment.</p>
<div class="sourceCode" id="cb11"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" tabindex="-1"></a><span class="op">%%</span>capture</span>
<span id="cb11-2"><a href="#cb11-2" tabindex="-1"></a><span class="cf">if</span> <span class="st">&#39;google.colab&#39;</span> <span class="kw">in</span> <span class="bu">str</span>(get_ipython()):</span>
<span id="cb11-3"><a href="#cb11-3" tabindex="-1"></a>    <span class="op">!</span>pip install pystac<span class="op">-</span>client odc<span class="op">-</span>stac rioxarray dask</span></code></pre></div>
<div class="sourceCode" id="cb12"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb12-2"><a href="#cb12-2" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb12-3"><a href="#cb12-3" tabindex="-1"></a><span class="im">import</span> pystac_client</span>
<span id="cb12-4"><a href="#cb12-4" tabindex="-1"></a><span class="im">from</span> odc.stac <span class="im">import</span> stac_load</span>
<span id="cb12-5"><a href="#cb12-5" tabindex="-1"></a><span class="im">import</span> xarray <span class="im">as</span> xr</span>
<span id="cb12-6"><a href="#cb12-6" tabindex="-1"></a><span class="im">import</span> rioxarray <span class="im">as</span> rxr</span></code></pre></div>
<div class="sourceCode" id="cb13"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" tabindex="-1"></a>data_folder <span class="op">=</span> <span class="st">&#39;data&#39;</span></span>
<span id="cb13-2"><a href="#cb13-2" tabindex="-1"></a>output_folder <span class="op">=</span> <span class="st">&#39;output&#39;</span></span>
<span id="cb13-3"><a href="#cb13-3" tabindex="-1"></a></span>
<span id="cb13-4"><a href="#cb13-4" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> os.path.exists(data_folder):</span>
<span id="cb13-5"><a href="#cb13-5" tabindex="-1"></a>    os.mkdir(data_folder)</span>
<span id="cb13-6"><a href="#cb13-6" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> os.path.exists(output_folder):</span>
<span id="cb13-7"><a href="#cb13-7" tabindex="-1"></a>    os.mkdir(output_folder)</span></code></pre></div>
</div>
<div id="get-satellite-imagery" class="section level2">
<h2>Get Satellite Imagery</h2>
<p>We define a location and time of interest to get some satellite
imagery.</p>
<div class="sourceCode" id="cb14"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" tabindex="-1"></a>latitude <span class="op">=</span> <span class="fl">27.163</span></span>
<span id="cb14-2"><a href="#cb14-2" tabindex="-1"></a>longitude <span class="op">=</span> <span class="fl">82.608</span></span>
<span id="cb14-3"><a href="#cb14-3" tabindex="-1"></a>year <span class="op">=</span> <span class="dv">2023</span></span></code></pre></div>
<p>Let’s use Element84 search endpoint to look for items from the
sentinel-2-l2a collection on AWS.</p>
<div class="sourceCode" id="cb15"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" tabindex="-1"></a>catalog <span class="op">=</span> pystac_client.Client.<span class="bu">open</span>(</span>
<span id="cb15-2"><a href="#cb15-2" tabindex="-1"></a>    <span class="st">&#39;https://earth-search.aws.element84.com/v1&#39;</span>)</span>
<span id="cb15-3"><a href="#cb15-3" tabindex="-1"></a></span>
<span id="cb15-4"><a href="#cb15-4" tabindex="-1"></a><span class="co"># Define a small bounding box around the chosen point</span></span>
<span id="cb15-5"><a href="#cb15-5" tabindex="-1"></a>km2deg <span class="op">=</span> <span class="fl">1.0</span> <span class="op">/</span> <span class="dv">111</span></span>
<span id="cb15-6"><a href="#cb15-6" tabindex="-1"></a>x, y <span class="op">=</span> (longitude, latitude)</span>
<span id="cb15-7"><a href="#cb15-7" tabindex="-1"></a>r <span class="op">=</span> <span class="dv">1</span> <span class="op">*</span> km2deg  <span class="co"># radius in degrees</span></span>
<span id="cb15-8"><a href="#cb15-8" tabindex="-1"></a>bbox <span class="op">=</span> (x <span class="op">-</span> r, y <span class="op">-</span> r, x <span class="op">+</span> r, y <span class="op">+</span> r)</span>
<span id="cb15-9"><a href="#cb15-9" tabindex="-1"></a></span>
<span id="cb15-10"><a href="#cb15-10" tabindex="-1"></a>search <span class="op">=</span> catalog.search(</span>
<span id="cb15-11"><a href="#cb15-11" tabindex="-1"></a>    collections<span class="op">=</span>[<span class="st">&#39;sentinel-2-c1-l2a&#39;</span>],</span>
<span id="cb15-12"><a href="#cb15-12" tabindex="-1"></a>    bbox<span class="op">=</span>bbox,</span>
<span id="cb15-13"><a href="#cb15-13" tabindex="-1"></a>    datetime<span class="op">=</span><span class="ss">f&#39;</span><span class="sc">{</span>year<span class="sc">}</span><span class="ss">&#39;</span>,</span>
<span id="cb15-14"><a href="#cb15-14" tabindex="-1"></a>    query<span class="op">=</span>{<span class="st">&#39;eo:cloud_cover&#39;</span>: {<span class="st">&#39;lt&#39;</span>: <span class="dv">30</span>}},</span>
<span id="cb15-15"><a href="#cb15-15" tabindex="-1"></a>)</span>
<span id="cb15-16"><a href="#cb15-16" tabindex="-1"></a>items <span class="op">=</span> search.item_collection()</span></code></pre></div>
<p>Load the matching images as a XArray Dataset.</p>
<div class="sourceCode" id="cb16"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" tabindex="-1"></a>ds <span class="op">=</span> stac_load(</span>
<span id="cb16-2"><a href="#cb16-2" tabindex="-1"></a>    items,</span>
<span id="cb16-3"><a href="#cb16-3" tabindex="-1"></a>    bands<span class="op">=</span>[<span class="st">&#39;red&#39;</span>, <span class="st">&#39;green&#39;</span>, <span class="st">&#39;blue&#39;</span>, <span class="st">&#39;nir&#39;</span>],</span>
<span id="cb16-4"><a href="#cb16-4" tabindex="-1"></a>    resolution<span class="op">=</span><span class="dv">10</span>,</span>
<span id="cb16-5"><a href="#cb16-5" tabindex="-1"></a>    bbox<span class="op">=</span>bbox,</span>
<span id="cb16-6"><a href="#cb16-6" tabindex="-1"></a>    chunks<span class="op">=</span>{},  <span class="co"># &lt;-- use Dask</span></span>
<span id="cb16-7"><a href="#cb16-7" tabindex="-1"></a>    groupby<span class="op">=</span><span class="st">&#39;solar_day&#39;</span>,</span>
<span id="cb16-8"><a href="#cb16-8" tabindex="-1"></a>)</span>
<span id="cb16-9"><a href="#cb16-9" tabindex="-1"></a>ds</span></code></pre></div>
<div class="sourceCode" id="cb17"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" tabindex="-1"></a><span class="op">%%</span>time</span>
<span id="cb17-2"><a href="#cb17-2" tabindex="-1"></a>ds <span class="op">=</span> ds.compute()</span></code></pre></div>
</div>
<div id="xarray-terminology" class="section level2">
<h2>XArray Terminology</h2>
<p>We now have a <code>xarray.Dataset</code> object. Let’s understand
what is contained in a Dataset.</p>
<ul>
<li><em>Variables</em>: This is similar to a band in a raster dataset.
Each variable contains an array of values.</li>
<li><em>Dimensions</em>: This is similar to number of array axes.</li>
<li><em>Coordinates</em>: These are the labels for values in each
dimension.</li>
<li><em>Attributes</em>: This is the metadata associated with the
dataset.</li>
</ul>
<p><img src='https://courses.spatialthoughts.com/images/common/xarray_terminology.png' width=800/></p>
<p>A Dataset consists of one or more <code>xarray.DataArray</code>
object. This is the main object that consists of a single variable with
dimension names, coordinates and attributes. You can access each
variable using <code>dataset.variable_name</code> syntax.</p>
<div class="sourceCode" id="cb18"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" tabindex="-1"></a>da <span class="op">=</span> ds.red</span>
<span id="cb18-2"><a href="#cb18-2" tabindex="-1"></a>da</span></code></pre></div>
</div>
<div id="selecting-data" class="section level2">
<h2>Selecting Data</h2>
<p>XArray provides a very powerful way to select subsets of data, using
similar framework as Pandas. Similar to Panda’s <code>loc</code> and
<code>iloc</code> methods, XArray provides <code>sel</code> and
<code>isel</code> methods. Since DataArray dimensions have names, these
methods allow you to specify which dimension to query.</p>
<p>Let’s select the temperature anomany values for the last time step.
Since we know the index (-1) of the datam we can use <code>isel</code>
method.</p>
<div class="sourceCode" id="cb19"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" tabindex="-1"></a>da.isel(time<span class="op">=-</span><span class="dv">1</span>)</span></code></pre></div>
<p>You can call <code>.values</code> on a DataArray to get an array of
the values.</p>
<div class="sourceCode" id="cb20"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" tabindex="-1"></a>da.isel(time<span class="op">=-</span><span class="dv">1</span>).values</span></code></pre></div>
<p>You can query for a values at using multiple dimensions.</p>
<div class="sourceCode" id="cb21"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" tabindex="-1"></a>da.isel(time<span class="op">=-</span><span class="dv">1</span>, x<span class="op">=-</span><span class="dv">1</span>, y<span class="op">=-</span><span class="dv">1</span>).values</span></code></pre></div>
<p>We can also specify a value to query using the <code>sel()</code>
method.</p>
<p>Let’s see what are the values of <code>time</code> variable.</p>
<div class="sourceCode" id="cb22"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" tabindex="-1"></a>dates <span class="op">=</span> da.time.values</span>
<span id="cb22-2"><a href="#cb22-2" tabindex="-1"></a>dates</span></code></pre></div>
<p>We can query using the value of a coordinate using the
<code>sel()</code> method.</p>
<div class="sourceCode" id="cb23"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" tabindex="-1"></a>da.sel(time<span class="op">=</span><span class="st">&#39;2023-12-16&#39;</span>)</span></code></pre></div>
<p>The <code>sel()</code> method also support nearest neighbor lookups.
This is useful when you do not know the exact label of the dimension,
but want to find the closest one.</p>
<blockquote>
<p>Tip: You can use <code>interp()</code> instead of <code>sel()</code>
to interpolate the value instead of closest lookup.</p>
</blockquote>
<div class="sourceCode" id="cb24"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" tabindex="-1"></a>da.sel(time<span class="op">=</span><span class="st">&#39;2023-01-01&#39;</span>, method<span class="op">=</span><span class="st">&#39;nearest&#39;</span>)</span></code></pre></div>
<p>The <code>sel()</code> method also allows specifying range of values
using Python’s built-in <code>slice()</code> function. The code below
will select all observations during January 2023.</p>
<div class="sourceCode" id="cb25"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" tabindex="-1"></a>da.sel(time<span class="op">=</span><span class="bu">slice</span>(<span class="st">&#39;2023-01-01&#39;</span>, <span class="st">&#39;2023-01-31&#39;</span>))</span></code></pre></div>
</div>
<div id="aggregating-data" class="section level2">
<h2>Aggregating Data</h2>
<p>A very-powerful feature of XArray is the ability to easily aggregate
data across dimensions - making it ideal for many remote sensing
analysis. Let’s create a median composite from all the individual
images.</p>
<p>We apply the <code>.median()</code> aggregation across the
<code>time</code> dimension.</p>
<div class="sourceCode" id="cb26"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" tabindex="-1"></a>median <span class="op">=</span> ds.median(dim<span class="op">=</span><span class="st">&#39;time&#39;</span>)</span>
<span id="cb26-2"><a href="#cb26-2" tabindex="-1"></a>median</span></code></pre></div>
</div>
<div id="visualizing-data" class="section level2">
<h2>Visualizing Data</h2>
<p>XArray provides a <code>plot.imshow()</code> method based on
Matplotlib to plot DataArrays.</p>
<p>Reference : <a
href="https://docs.xarray.dev/en/stable/generated/xarray.plot.imshow.html">xarray.plot.imshow</a></p>
<p>To visualize our Dataset, we first convert it to a DataArray using
the <code>to_array()</code> method. All the variables will be converted
to a new dimension. Since our variables are image bands, we give the
name of the new dimesion as <code>band</code>.</p>
<div class="sourceCode" id="cb27"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" tabindex="-1"></a>median_da <span class="op">=</span> median.to_array(<span class="st">&#39;band&#39;</span>)</span>
<span id="cb27-2"><a href="#cb27-2" tabindex="-1"></a>median_da</span></code></pre></div>
<p>The easy way to visualize the data without the outliers is to pass
the parameter <code>robust=True</code>. This will use the 2nd and 98th
percentiles of the data to compute the color limits. We also specify the
<code>set_aspect('equal')</code> to ensure the original aspect ratio is
maintained and the image is not stretched.</p>
<div class="sourceCode" id="cb28"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb28-2"><a href="#cb28-2" tabindex="-1"></a>fig.set_size_inches(<span class="dv">5</span>,<span class="dv">5</span>)</span>
<span id="cb28-3"><a href="#cb28-3" tabindex="-1"></a>median_da.sel(band<span class="op">=</span>[<span class="st">&#39;red&#39;</span>, <span class="st">&#39;green&#39;</span>, <span class="st">&#39;blue&#39;</span>]).plot.imshow(</span>
<span id="cb28-4"><a href="#cb28-4" tabindex="-1"></a>    ax<span class="op">=</span>ax,</span>
<span id="cb28-5"><a href="#cb28-5" tabindex="-1"></a>    robust<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb28-6"><a href="#cb28-6" tabindex="-1"></a>ax.set_title(<span class="st">&#39;RGB Visualization&#39;</span>)</span>
<span id="cb28-7"><a href="#cb28-7" tabindex="-1"></a>ax.set_axis_off()</span>
<span id="cb28-8"><a href="#cb28-8" tabindex="-1"></a>ax.set_aspect(<span class="st">&#39;equal&#39;</span>)</span>
<span id="cb28-9"><a href="#cb28-9" tabindex="-1"></a>plt.show()</span></code></pre></div>
<p><img
src="python-remote-sensing-output/01_xarray_basics_files/01_xarray_basics_41_0.png" /></p>
<p>We can save the resulting median compositeas a multi-band GeoTIFF
file.</p>
<div class="sourceCode" id="cb29"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" tabindex="-1"></a>output_file <span class="op">=</span> <span class="st">&#39;median_composite.tif&#39;</span></span>
<span id="cb29-2"><a href="#cb29-2" tabindex="-1"></a>output_file_path <span class="op">=</span> os.path.join(output_folder, output_file)</span>
<span id="cb29-3"><a href="#cb29-3" tabindex="-1"></a>median_da.rio.to_raster(output_file_path, compress<span class="op">=</span><span class="st">&#39;LZW&#39;</span>)</span></code></pre></div>
</div>
<div id="exercise" class="section level2">
<h2>Exercise</h2>
<p>Display the median composite for the month of May.</p>
<p>The snippet below takes our time-series and aggregate it to a monthly
median composites <code>groupby()</code> method.</p>
<div class="sourceCode" id="cb30"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" tabindex="-1"></a>monthly <span class="op">=</span> ds.groupby(<span class="st">&#39;time.month&#39;</span>).median(dim<span class="op">=</span><span class="st">&#39;time&#39;</span>)</span>
<span id="cb30-2"><a href="#cb30-2" tabindex="-1"></a>monthly</span></code></pre></div>
<p>You now have a new dimension named <code>month</code>. Start your
exercise by first converting the Dataset to a DataArray. Then extract
the data for the chosen month using <code>sel()</code> method and plot
it.</p>
</div>
</div>
<div id="stac-and-dask-basics" class="section level1">
<h1>2. STAC and Dask Basics</h1>
<p><a
href="https://colab.research.google.com/github/spatialthoughts/courses/blob/master/code/python_remote_sensing/02_stac_dask_basics"><img
src="https://colab.research.google.com/assets/colab-badge.svg"
alt="Open In Colab" /></a></p>
<div id="overview-1" class="section level2">
<h2>Overview</h2>
<p>In this section, we will learn the basics of querying cloud-hosted
data via <a href="https://stacspec.org/en">STAC</a> and leverage
parallel computing via <a
href="https://tutorial.xarray.dev/intermediate/xarray_and_dask.html">Dask</a>.</p>
<p>We will learn how to query a catalog of Sentinel-2 images to find the
least-cloudy scene over a chosen area, visualize it and download it as a
GeoTIFF file.</p>
</div>
<div id="setup-and-data-download-1" class="section level2">
<h2>Setup and Data Download</h2>
<p>The following blocks of code will install the required packages and
download the datasets to your Colab environment.</p>
<div class="sourceCode" id="cb31"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" tabindex="-1"></a><span class="op">%%</span>capture</span>
<span id="cb31-2"><a href="#cb31-2" tabindex="-1"></a><span class="cf">if</span> <span class="st">&#39;google.colab&#39;</span> <span class="kw">in</span> <span class="bu">str</span>(get_ipython()):</span>
<span id="cb31-3"><a href="#cb31-3" tabindex="-1"></a>    <span class="op">!</span>pip install pystac<span class="op">-</span>client odc<span class="op">-</span>stac rioxarray dask jupyter<span class="op">-</span>server<span class="op">-</span>proxy</span></code></pre></div>
<div class="sourceCode" id="cb32"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb32-2"><a href="#cb32-2" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb32-3"><a href="#cb32-3" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb32-4"><a href="#cb32-4" tabindex="-1"></a><span class="im">import</span> pystac_client</span>
<span id="cb32-5"><a href="#cb32-5" tabindex="-1"></a><span class="im">from</span> odc <span class="im">import</span> stac</span>
<span id="cb32-6"><a href="#cb32-6" tabindex="-1"></a><span class="im">import</span> xarray <span class="im">as</span> xr</span>
<span id="cb32-7"><a href="#cb32-7" tabindex="-1"></a><span class="im">import</span> rioxarray <span class="im">as</span> rxr</span></code></pre></div>
</div>
<div id="dask" class="section level2">
<h2>Dask</h2>
<p><a href="https://www.dask.org/"><code>Dask</code></a> is a python
library to run your computation in parallel across many machines. Dask
has built-in support for key geospatial packages like XArray and Pandas
allowing you to scale your computation easily. You can choose to run
your code in parallel on your laptop, a machine in the cloud, local or
cloud cluster of machines etc.</p>
<div class="sourceCode" id="cb33"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" tabindex="-1"></a><span class="im">from</span> dask.distributed <span class="im">import</span> Client</span>
<span id="cb33-2"><a href="#cb33-2" tabindex="-1"></a>client <span class="op">=</span> Client()  <span class="co"># set up local cluster on the machine</span></span>
<span id="cb33-3"><a href="#cb33-3" tabindex="-1"></a>client</span></code></pre></div>
<p>f you are running this notebook in Colab, you will need to create and
use a proxy URL to see the dashboard running on the local server.</p>
<div class="sourceCode" id="cb34"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" tabindex="-1"></a><span class="cf">if</span> <span class="st">&#39;google.colab&#39;</span> <span class="kw">in</span> <span class="bu">str</span>(get_ipython()):</span>
<span id="cb34-2"><a href="#cb34-2" tabindex="-1"></a>    <span class="im">from</span> google.colab <span class="im">import</span> output</span>
<span id="cb34-3"><a href="#cb34-3" tabindex="-1"></a>    port_to_expose <span class="op">=</span> <span class="dv">8787</span>  <span class="co"># This is the default port for Dask dashboard</span></span>
<span id="cb34-4"><a href="#cb34-4" tabindex="-1"></a>    <span class="bu">print</span>(output.eval_js(<span class="ss">f&#39;google.colab.kernel.proxyPort(</span><span class="sc">{</span>port_to_expose<span class="sc">}</span><span class="ss">)&#39;</span>))</span></code></pre></div>
</div>
<div id="spatio-temporal-asset-catalog-stac" class="section level2">
<h2>Spatio Temporal Asset Catalog (STAC)</h2>
<p>Spatio Temporal Asset Catalog (STAC) is an open standard for
specifying and querying geospatial data. Data provider can share
catalogs of satellite imagery ,climate datasets, LIDAR data, vector data
etc. and specify asset metadata according to the STAC specifications.
All STAC catalogs can be queried to find matching assets by time,
location or metadata.</p>
<p>You can browse all available catalogs at <a
href="https://stacindex.org/" class="uri">https://stacindex.org/</a></p>
<p>Let’s use <a
href="https://stacindex.org/catalogs/earth-search#/">Earth Search by
Element 84</a> STAC API Catalog to look for items from the
sentinel-2-l2a collection on AWS.</p>
<div class="sourceCode" id="cb35"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" tabindex="-1"></a>catalog <span class="op">=</span> pystac_client.Client.<span class="bu">open</span>(</span>
<span id="cb35-2"><a href="#cb35-2" tabindex="-1"></a>    <span class="st">&#39;https://earth-search.aws.element84.com/v1&#39;</span>)</span></code></pre></div>
<p>We define a location and time of interest to get some satellite
imagery.</p>
<div class="sourceCode" id="cb36"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" tabindex="-1"></a>latitude <span class="op">=</span> <span class="fl">27.163</span></span>
<span id="cb36-2"><a href="#cb36-2" tabindex="-1"></a>longitude <span class="op">=</span> <span class="fl">82.608</span></span>
<span id="cb36-3"><a href="#cb36-3" tabindex="-1"></a>year <span class="op">=</span> <span class="dv">2023</span></span></code></pre></div>
<div class="sourceCode" id="cb37"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" tabindex="-1"></a><span class="co"># Define a small bounding box around the chosen point</span></span>
<span id="cb37-2"><a href="#cb37-2" tabindex="-1"></a>km2deg <span class="op">=</span> <span class="fl">1.0</span> <span class="op">/</span> <span class="dv">111</span></span>
<span id="cb37-3"><a href="#cb37-3" tabindex="-1"></a>x, y <span class="op">=</span> (longitude, latitude)</span>
<span id="cb37-4"><a href="#cb37-4" tabindex="-1"></a>r <span class="op">=</span> <span class="dv">1</span> <span class="op">*</span> km2deg  <span class="co"># radius in degrees</span></span>
<span id="cb37-5"><a href="#cb37-5" tabindex="-1"></a>bbox <span class="op">=</span> (x <span class="op">-</span> r, y <span class="op">-</span> r, x <span class="op">+</span> r, y <span class="op">+</span> r)</span></code></pre></div>
<p>Search the catalog for matching items.</p>
<div class="sourceCode" id="cb38"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" tabindex="-1"></a>search <span class="op">=</span> catalog.search(</span>
<span id="cb38-2"><a href="#cb38-2" tabindex="-1"></a>    collections<span class="op">=</span>[<span class="st">&#39;sentinel-2-c1-l2a&#39;</span>],</span>
<span id="cb38-3"><a href="#cb38-3" tabindex="-1"></a>    bbox<span class="op">=</span>bbox,</span>
<span id="cb38-4"><a href="#cb38-4" tabindex="-1"></a>    datetime<span class="op">=</span><span class="ss">f&#39;</span><span class="sc">{</span>year<span class="sc">}</span><span class="ss">&#39;</span></span>
<span id="cb38-5"><a href="#cb38-5" tabindex="-1"></a>)</span>
<span id="cb38-6"><a href="#cb38-6" tabindex="-1"></a>items <span class="op">=</span> search.item_collection()</span>
<span id="cb38-7"><a href="#cb38-7" tabindex="-1"></a>items</span></code></pre></div>
<p>We can apply some additional metadata filters to look for images with
less cloud cover and granules with less nodata pixels.</p>
<div class="sourceCode" id="cb39"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" tabindex="-1"></a>search <span class="op">=</span> catalog.search(</span>
<span id="cb39-2"><a href="#cb39-2" tabindex="-1"></a>    collections<span class="op">=</span>[<span class="st">&#39;sentinel-2-c1-l2a&#39;</span>],</span>
<span id="cb39-3"><a href="#cb39-3" tabindex="-1"></a>    bbox<span class="op">=</span>bbox,</span>
<span id="cb39-4"><a href="#cb39-4" tabindex="-1"></a>    datetime<span class="op">=</span><span class="ss">f&#39;</span><span class="sc">{</span>year<span class="sc">}</span><span class="ss">&#39;</span>,</span>
<span id="cb39-5"><a href="#cb39-5" tabindex="-1"></a>    query<span class="op">=</span>{<span class="st">&#39;eo:cloud_cover&#39;</span>: {<span class="st">&#39;lt&#39;</span>: <span class="dv">30</span>}, <span class="st">&#39;s2:nodata_pixel_percentage&#39;</span>: {<span class="st">&#39;lt&#39;</span>: <span class="dv">10</span>}}</span>
<span id="cb39-6"><a href="#cb39-6" tabindex="-1"></a>)</span>
<span id="cb39-7"><a href="#cb39-7" tabindex="-1"></a>items <span class="op">=</span> search.item_collection()</span>
<span id="cb39-8"><a href="#cb39-8" tabindex="-1"></a>items</span></code></pre></div>
<p>We can also sort the results by some metadata. Here we sort by cloud
cover.</p>
<div class="sourceCode" id="cb40"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" tabindex="-1"></a>search <span class="op">=</span> catalog.search(</span>
<span id="cb40-2"><a href="#cb40-2" tabindex="-1"></a>    collections<span class="op">=</span>[<span class="st">&#39;sentinel-2-c1-l2a&#39;</span>],</span>
<span id="cb40-3"><a href="#cb40-3" tabindex="-1"></a>    bbox<span class="op">=</span>bbox,</span>
<span id="cb40-4"><a href="#cb40-4" tabindex="-1"></a>    datetime<span class="op">=</span><span class="ss">f&#39;</span><span class="sc">{</span>year<span class="sc">}</span><span class="ss">&#39;</span>,</span>
<span id="cb40-5"><a href="#cb40-5" tabindex="-1"></a>    query<span class="op">=</span>{<span class="st">&#39;eo:cloud_cover&#39;</span>: {<span class="st">&#39;lt&#39;</span>: <span class="dv">30</span>}, <span class="st">&#39;s2:nodata_pixel_percentage&#39;</span>: {<span class="st">&#39;lt&#39;</span>: <span class="dv">10</span>}},</span>
<span id="cb40-6"><a href="#cb40-6" tabindex="-1"></a>    sortby<span class="op">=</span>[{<span class="st">&#39;field&#39;</span>: <span class="st">&#39;properties.eo:cloud_cover&#39;</span>, <span class="st">&#39;direction&#39;</span>: <span class="st">&#39;asc&#39;</span>}]</span>
<span id="cb40-7"><a href="#cb40-7" tabindex="-1"></a></span>
<span id="cb40-8"><a href="#cb40-8" tabindex="-1"></a>)</span>
<span id="cb40-9"><a href="#cb40-9" tabindex="-1"></a>items <span class="op">=</span> search.item_collection()</span>
<span id="cb40-10"><a href="#cb40-10" tabindex="-1"></a>items</span></code></pre></div>
</div>
<div id="load-stac-images-to-xarray" class="section level2">
<h2>Load STAC Images to XArray</h2>
<p>Load the matching images as a XArray Dataset.</p>
<div class="sourceCode" id="cb41"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" tabindex="-1"></a>ds <span class="op">=</span> stac.load(</span>
<span id="cb41-2"><a href="#cb41-2" tabindex="-1"></a>    items,</span>
<span id="cb41-3"><a href="#cb41-3" tabindex="-1"></a>    bands<span class="op">=</span>[<span class="st">&#39;red&#39;</span>, <span class="st">&#39;green&#39;</span>, <span class="st">&#39;blue&#39;</span>, <span class="st">&#39;nir&#39;</span>],</span>
<span id="cb41-4"><a href="#cb41-4" tabindex="-1"></a>    resolution<span class="op">=</span><span class="dv">10</span>,</span>
<span id="cb41-5"><a href="#cb41-5" tabindex="-1"></a>    chunks<span class="op">=</span>{},  <span class="co"># &lt;-- use Dask</span></span>
<span id="cb41-6"><a href="#cb41-6" tabindex="-1"></a>    groupby<span class="op">=</span><span class="st">&#39;solar_day&#39;</span>,</span>
<span id="cb41-7"><a href="#cb41-7" tabindex="-1"></a>    preserve_original_order<span class="op">=</span><span class="va">True</span></span>
<span id="cb41-8"><a href="#cb41-8" tabindex="-1"></a>)</span>
<span id="cb41-9"><a href="#cb41-9" tabindex="-1"></a>ds</span></code></pre></div>
<p>Use<a
href="https://docs.xarray.dev/en/latest/generated/xarray.Dataset.nbytes.html"><code>xarray.Dataset.nbytes</code></a>
property to check the size of the loaded dataset.</p>
<div class="sourceCode" id="cb42"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f&#39;DataSet size: </span><span class="sc">{</span>ds<span class="sc">.</span>nbytes<span class="op">/</span><span class="fl">1e6</span><span class="sc">:.2f}</span><span class="ss"> MB.&#39;</span>)</span></code></pre></div>
</div>
<div id="select-a-single-scene" class="section level2">
<h2>Select a Single Scene</h2>
<p>Let’s work with a single scene for now. We will use the first item
from our search (the least cloudy scene). When the items are loaded as a
XArray Dataset, the <code>time</code> dimension is sorted. We get the
timestamp of the least cloudy scene and select it from the dataset.</p>
<div class="sourceCode" id="cb43"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" tabindex="-1"></a>timestamp <span class="op">=</span> pd.to_datetime(items[<span class="dv">0</span>].properties[<span class="st">&#39;datetime&#39;</span>]).tz_convert(<span class="va">None</span>)</span>
<span id="cb43-2"><a href="#cb43-2" tabindex="-1"></a>scene <span class="op">=</span> ds.sel(time<span class="op">=</span>timestamp)</span>
<span id="cb43-3"><a href="#cb43-3" tabindex="-1"></a>scene</span></code></pre></div>
<div class="sourceCode" id="cb44"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f&#39;Scene size: </span><span class="sc">{</span>scene<span class="sc">.</span>nbytes<span class="op">/</span><span class="fl">1e6</span><span class="sc">:.2f}</span><span class="ss"> MB.&#39;</span>)</span></code></pre></div>
<p>This scene is small enough to fit into RAM, so let’s call
<code>compute()</code> to load this into memory. Dask will query the
cloud-hosted dataset to fetch the required pixels. As we setup a Dask
LocalCluster, the process will be paralellized across all available
cores of the machine. Once you run the cell, look at the Dask Diagnostic
Dashboard to see the data processing in action.</p>
<div class="sourceCode" id="cb45"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" tabindex="-1"></a><span class="op">%%</span>time</span>
<span id="cb45-2"><a href="#cb45-2" tabindex="-1"></a>scene <span class="op">=</span> scene.compute()</span></code></pre></div>
<div class="sourceCode" id="cb46"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" tabindex="-1"></a>scene</span></code></pre></div>
<p>The Sentinel-2 scenes come with NoData value of 0. So we set the
correct NoData value before further processing.</p>
<div class="sourceCode" id="cb47"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" tabindex="-1"></a>scene <span class="op">=</span> scene.where(scene <span class="op">!=</span> <span class="dv">0</span>)</span>
<span id="cb47-2"><a href="#cb47-2" tabindex="-1"></a>scene</span></code></pre></div>
<p>Each band of the scene is saved with integer pixel values (data type
<code>uint16</code>). This help save the storage cost as storing the
reflectance values as floating point numbers (data type
<code>float64</code>) requires more storage. We need to convert the raw
pixel values to reflectances by applying the <em>scale</em> and
<em>offset</em> values. The <a
href="https://github.com/Element84/earth-search">Earth Search STAC
API</a> does not apply the scale/offset automatically to Sentinel-2
scene and they are supplied in the <code>raster:bands</code> metadata
for each band. The scale and offset for sentinel-2 scenes captured after
Jan 25, 2022 is <code>0.0001</code> and <code>-0.1</code>
respectively.</p>
<div class="sourceCode" id="cb48"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" tabindex="-1"></a>scale <span class="op">=</span> <span class="fl">0.0001</span></span>
<span id="cb48-2"><a href="#cb48-2" tabindex="-1"></a>offset <span class="op">=</span> <span class="op">-</span><span class="fl">0.1</span></span>
<span id="cb48-3"><a href="#cb48-3" tabindex="-1"></a>scene <span class="op">=</span> scene<span class="op">*</span>scale <span class="op">+</span> offset</span></code></pre></div>
</div>
<div id="visualize-the-scene" class="section level2">
<h2>Visualize the Scene</h2>
<p>To visualize our Dataset, we first convert it to a DataArray using
the <code>to_array()</code> method. All the variables will be converted
to a new dimension. Since our variables are image bands, we give the
name of the new dimesion as band.</p>
<div class="sourceCode" id="cb49"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" tabindex="-1"></a>scene_da <span class="op">=</span> scene.to_array(<span class="st">&#39;band&#39;</span>)</span>
<span id="cb49-2"><a href="#cb49-2" tabindex="-1"></a>scene_da</span></code></pre></div>
<p>We can create a low-resolution preview by resampling the DataArray
from its native resolution. The raster metadata is stored in the <a
href="https://corteva.github.io/rioxarray/stable/rioxarray.html#rioxarray-rio-accessors">rio
accessor</a>. This is enabled by the <code>rioxarray</code> library
which provides geospatial functions on top of xarray.</p>
<div class="sourceCode" id="cb50"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&#39;CRS:&#39;</span>, scene_da.rio.crs)</span>
<span id="cb50-2"><a href="#cb50-2" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&#39;Resolution:&#39;</span>, scene_da.rio.resolution())</span></code></pre></div>
<p>This is a fairly large scene with a lot of pixels. For visualizing,
we resample it to a lower resolution preview. When plotting the image,
the <code>robust=True</code> option applies a <em>98-percentile</em>
stretch to find the optimal min/max values for visualization.</p>
<div class="sourceCode" id="cb51"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb51-1"><a href="#cb51-1" tabindex="-1"></a>preview <span class="op">=</span> scene_da.rio.reproject(</span>
<span id="cb51-2"><a href="#cb51-2" tabindex="-1"></a>    scene_da.rio.crs, resolution<span class="op">=</span><span class="dv">300</span></span>
<span id="cb51-3"><a href="#cb51-3" tabindex="-1"></a>)</span>
<span id="cb51-4"><a href="#cb51-4" tabindex="-1"></a></span>
<span id="cb51-5"><a href="#cb51-5" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb51-6"><a href="#cb51-6" tabindex="-1"></a>fig.set_size_inches(<span class="dv">5</span>,<span class="dv">5</span>)</span>
<span id="cb51-7"><a href="#cb51-7" tabindex="-1"></a>preview.sel(band<span class="op">=</span>[<span class="st">&#39;red&#39;</span>, <span class="st">&#39;green&#39;</span>, <span class="st">&#39;blue&#39;</span>]).plot.imshow(</span>
<span id="cb51-8"><a href="#cb51-8" tabindex="-1"></a>    ax<span class="op">=</span>ax,</span>
<span id="cb51-9"><a href="#cb51-9" tabindex="-1"></a>    robust<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb51-10"><a href="#cb51-10" tabindex="-1"></a>ax.set_title(<span class="st">&#39;RGB Visualization&#39;</span>)</span>
<span id="cb51-11"><a href="#cb51-11" tabindex="-1"></a>ax.set_axis_off()</span>
<span id="cb51-12"><a href="#cb51-12" tabindex="-1"></a>ax.set_aspect(<span class="st">&#39;equal&#39;</span>)</span>
<span id="cb51-13"><a href="#cb51-13" tabindex="-1"></a>plt.show()</span></code></pre></div>
</div>
<div id="save-the-scene-to-disk" class="section level2">
<h2>Save the Scene to Disk</h2>
<div class="sourceCode" id="cb52"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1" tabindex="-1"></a>scene_id <span class="op">=</span> items[<span class="dv">0</span>].<span class="bu">id</span></span>
<span id="cb52-2"><a href="#cb52-2" tabindex="-1"></a>output_da <span class="op">=</span> scene_da.sel(band<span class="op">=</span>[<span class="st">&#39;red&#39;</span>, <span class="st">&#39;green&#39;</span>, <span class="st">&#39;blue&#39;</span>])</span>
<span id="cb52-3"><a href="#cb52-3" tabindex="-1"></a>output_file <span class="op">=</span> <span class="ss">f&#39;</span><span class="sc">{</span>scene_id<span class="sc">}</span><span class="ss">.tif&#39;</span></span></code></pre></div>
<p>Rather than saving it to the temporary machine where Colab is
running, we can save it to our own Google Drive. This will ensure the
image will be available to us even after existing Google Colab.</p>
<p>Run the following cell to authenticate and mount the Google
Drive.</p>
<div class="sourceCode" id="cb53"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb53-1"><a href="#cb53-1" tabindex="-1"></a><span class="im">from</span> google.colab <span class="im">import</span> drive</span>
<span id="cb53-2"><a href="#cb53-2" tabindex="-1"></a>drive.mount(<span class="st">&#39;/content/drive&#39;</span>)</span></code></pre></div>
<div class="sourceCode" id="cb54"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb54-1"><a href="#cb54-1" tabindex="-1"></a>drive_folder_root <span class="op">=</span> <span class="st">&#39;/content/drive/MyDrive&#39;</span></span>
<span id="cb54-2"><a href="#cb54-2" tabindex="-1"></a>output_file_path <span class="op">=</span> os.path.join(drive_folder_root, output_file)</span>
<span id="cb54-3"><a href="#cb54-3" tabindex="-1"></a>output_da.rio.to_raster(output_file_path, compress<span class="op">=</span><span class="st">&#39;LZW&#39;</span>)</span></code></pre></div>
</div>
</div>
<div id="calculating-spectral-indices" class="section level1">
<h1>3. Calculating Spectral Indices</h1>
<p><a
href="https://colab.research.google.com/github/spatialthoughts/courses/blob/master/code/python_remote_sensing/03_calculating_indices.ipynb"><img
src="https://colab.research.google.com/assets/colab-badge.svg"
alt="Open In Colab" /></a></p>
<div id="overview-2" class="section level2">
<h2>Overview</h2>
<p>Spectral indices are core to many remote sensing analysis. In this
section, we will learn how can we perform calculations using XArray.</p>
<p>We will take a single Sentinel-2 scene and calculate spectral indices
like NDVI, MNDWI and SAVI.</p>
</div>
<div id="setup-and-data-download-2" class="section level2">
<h2>Setup and Data Download</h2>
<p>The following blocks of code will install the required packages and
download the datasets to your Colab environment.</p>
<div class="sourceCode" id="cb55"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb55-1"><a href="#cb55-1" tabindex="-1"></a><span class="op">%%</span>capture</span>
<span id="cb55-2"><a href="#cb55-2" tabindex="-1"></a><span class="cf">if</span> <span class="st">&#39;google.colab&#39;</span> <span class="kw">in</span> <span class="bu">str</span>(get_ipython()):</span>
<span id="cb55-3"><a href="#cb55-3" tabindex="-1"></a>    <span class="op">!</span>pip install pystac<span class="op">-</span>client odc<span class="op">-</span>stac rioxarray dask jupyter<span class="op">-</span>server<span class="op">-</span>proxy</span></code></pre></div>
<div class="sourceCode" id="cb56"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb56-1"><a href="#cb56-1" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb56-2"><a href="#cb56-2" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb56-3"><a href="#cb56-3" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb56-4"><a href="#cb56-4" tabindex="-1"></a><span class="im">import</span> pystac_client</span>
<span id="cb56-5"><a href="#cb56-5" tabindex="-1"></a><span class="im">from</span> odc <span class="im">import</span> stac</span>
<span id="cb56-6"><a href="#cb56-6" tabindex="-1"></a><span class="im">import</span> xarray <span class="im">as</span> xr</span>
<span id="cb56-7"><a href="#cb56-7" tabindex="-1"></a><span class="im">import</span> rioxarray <span class="im">as</span> rxr</span></code></pre></div>
<div class="sourceCode" id="cb57"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb57-1"><a href="#cb57-1" tabindex="-1"></a><span class="im">from</span> dask.distributed <span class="im">import</span> Client</span>
<span id="cb57-2"><a href="#cb57-2" tabindex="-1"></a>client <span class="op">=</span> Client()  <span class="co"># set up local cluster on the machine</span></span>
<span id="cb57-3"><a href="#cb57-3" tabindex="-1"></a>client</span></code></pre></div>
<p>f you are running this notebook in Colab, you will need to create and
use a proxy URL to see the dashboard running on the local server.</p>
<div class="sourceCode" id="cb58"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb58-1"><a href="#cb58-1" tabindex="-1"></a><span class="cf">if</span> <span class="st">&#39;google.colab&#39;</span> <span class="kw">in</span> <span class="bu">str</span>(get_ipython()):</span>
<span id="cb58-2"><a href="#cb58-2" tabindex="-1"></a>    <span class="im">from</span> google.colab <span class="im">import</span> output</span>
<span id="cb58-3"><a href="#cb58-3" tabindex="-1"></a>    port_to_expose <span class="op">=</span> <span class="dv">8787</span>  <span class="co"># This is the default port for Dask dashboard</span></span>
<span id="cb58-4"><a href="#cb58-4" tabindex="-1"></a>    <span class="bu">print</span>(output.eval_js(<span class="ss">f&#39;google.colab.kernel.proxyPort(</span><span class="sc">{</span>port_to_expose<span class="sc">}</span><span class="ss">)&#39;</span>))</span></code></pre></div>
</div>
<div id="get-a-sentinel-2-scene" class="section level2">
<h2>Get a Sentinel-2 Scene</h2>
<p>We define a location and time of interest to get some satellite
imagery.</p>
<div class="sourceCode" id="cb59"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb59-1"><a href="#cb59-1" tabindex="-1"></a>latitude <span class="op">=</span> <span class="fl">27.163</span></span>
<span id="cb59-2"><a href="#cb59-2" tabindex="-1"></a>longitude <span class="op">=</span> <span class="fl">82.608</span></span>
<span id="cb59-3"><a href="#cb59-3" tabindex="-1"></a>year <span class="op">=</span> <span class="dv">2023</span></span></code></pre></div>
<div class="sourceCode" id="cb60"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb60-1"><a href="#cb60-1" tabindex="-1"></a><span class="co"># Define a small bounding box around the chosen point</span></span>
<span id="cb60-2"><a href="#cb60-2" tabindex="-1"></a>km2deg <span class="op">=</span> <span class="fl">1.0</span> <span class="op">/</span> <span class="dv">111</span></span>
<span id="cb60-3"><a href="#cb60-3" tabindex="-1"></a>x, y <span class="op">=</span> (longitude, latitude)</span>
<span id="cb60-4"><a href="#cb60-4" tabindex="-1"></a>r <span class="op">=</span> <span class="dv">1</span> <span class="op">*</span> km2deg  <span class="co"># radius in degrees</span></span>
<span id="cb60-5"><a href="#cb60-5" tabindex="-1"></a>bbox <span class="op">=</span> (x <span class="op">-</span> r, y <span class="op">-</span> r, x <span class="op">+</span> r, y <span class="op">+</span> r)</span></code></pre></div>
<p>Search the catalog for matching items.</p>
<div class="sourceCode" id="cb61"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb61-1"><a href="#cb61-1" tabindex="-1"></a><span class="co"># Query the STAC Catalog</span></span>
<span id="cb61-2"><a href="#cb61-2" tabindex="-1"></a>catalog <span class="op">=</span> pystac_client.Client.<span class="bu">open</span>(</span>
<span id="cb61-3"><a href="#cb61-3" tabindex="-1"></a>    <span class="st">&#39;https://earth-search.aws.element84.com/v1&#39;</span>)</span>
<span id="cb61-4"><a href="#cb61-4" tabindex="-1"></a></span>
<span id="cb61-5"><a href="#cb61-5" tabindex="-1"></a>search <span class="op">=</span> catalog.search(</span>
<span id="cb61-6"><a href="#cb61-6" tabindex="-1"></a>    collections<span class="op">=</span>[<span class="st">&#39;sentinel-2-c1-l2a&#39;</span>],</span>
<span id="cb61-7"><a href="#cb61-7" tabindex="-1"></a>    bbox<span class="op">=</span>bbox,</span>
<span id="cb61-8"><a href="#cb61-8" tabindex="-1"></a>    datetime<span class="op">=</span><span class="ss">f&#39;</span><span class="sc">{</span>year<span class="sc">}</span><span class="ss">&#39;</span>,</span>
<span id="cb61-9"><a href="#cb61-9" tabindex="-1"></a>    query<span class="op">=</span>{<span class="st">&#39;eo:cloud_cover&#39;</span>: {<span class="st">&#39;lt&#39;</span>: <span class="dv">30</span>}, <span class="st">&#39;s2:nodata_pixel_percentage&#39;</span>: {<span class="st">&#39;lt&#39;</span>: <span class="dv">10</span>}},</span>
<span id="cb61-10"><a href="#cb61-10" tabindex="-1"></a>    sortby<span class="op">=</span>[{<span class="st">&#39;field&#39;</span>: <span class="st">&#39;properties.eo:cloud_cover&#39;</span>, <span class="st">&#39;direction&#39;</span>: <span class="st">&#39;asc&#39;</span>}]</span>
<span id="cb61-11"><a href="#cb61-11" tabindex="-1"></a></span>
<span id="cb61-12"><a href="#cb61-12" tabindex="-1"></a>)</span>
<span id="cb61-13"><a href="#cb61-13" tabindex="-1"></a>items <span class="op">=</span> search.item_collection()</span>
<span id="cb61-14"><a href="#cb61-14" tabindex="-1"></a></span>
<span id="cb61-15"><a href="#cb61-15" tabindex="-1"></a><span class="co"># Load to XArray</span></span>
<span id="cb61-16"><a href="#cb61-16" tabindex="-1"></a>ds <span class="op">=</span> stac.load(</span>
<span id="cb61-17"><a href="#cb61-17" tabindex="-1"></a>    items,</span>
<span id="cb61-18"><a href="#cb61-18" tabindex="-1"></a>    bands<span class="op">=</span>[<span class="st">&#39;red&#39;</span>, <span class="st">&#39;green&#39;</span>, <span class="st">&#39;blue&#39;</span>, <span class="st">&#39;nir&#39;</span>, <span class="st">&#39;swir16&#39;</span>],</span>
<span id="cb61-19"><a href="#cb61-19" tabindex="-1"></a>    resolution<span class="op">=</span><span class="dv">10</span>,</span>
<span id="cb61-20"><a href="#cb61-20" tabindex="-1"></a>    chunks<span class="op">=</span>{},  <span class="co"># &lt;-- use Dask</span></span>
<span id="cb61-21"><a href="#cb61-21" tabindex="-1"></a>    groupby<span class="op">=</span><span class="st">&#39;solar_day&#39;</span>,</span>
<span id="cb61-22"><a href="#cb61-22" tabindex="-1"></a>    preserve_original_order<span class="op">=</span><span class="va">True</span></span>
<span id="cb61-23"><a href="#cb61-23" tabindex="-1"></a>)</span>
<span id="cb61-24"><a href="#cb61-24" tabindex="-1"></a></span>
<span id="cb61-25"><a href="#cb61-25" tabindex="-1"></a><span class="co"># Select the first scene</span></span>
<span id="cb61-26"><a href="#cb61-26" tabindex="-1"></a>timestamp <span class="op">=</span> pd.to_datetime(items[<span class="dv">0</span>].properties[<span class="st">&#39;datetime&#39;</span>]).tz_convert(<span class="va">None</span>)</span>
<span id="cb61-27"><a href="#cb61-27" tabindex="-1"></a>scene <span class="op">=</span> ds.sel(time<span class="op">=</span>timestamp)</span>
<span id="cb61-28"><a href="#cb61-28" tabindex="-1"></a><span class="co"># Mask nodata values</span></span>
<span id="cb61-29"><a href="#cb61-29" tabindex="-1"></a>scene <span class="op">=</span> scene.where(scene <span class="op">!=</span> <span class="dv">0</span>)</span>
<span id="cb61-30"><a href="#cb61-30" tabindex="-1"></a><span class="co"># Apply scale/offset</span></span>
<span id="cb61-31"><a href="#cb61-31" tabindex="-1"></a>scale <span class="op">=</span> <span class="fl">0.0001</span></span>
<span id="cb61-32"><a href="#cb61-32" tabindex="-1"></a>offset <span class="op">=</span> <span class="op">-</span><span class="fl">0.1</span></span>
<span id="cb61-33"><a href="#cb61-33" tabindex="-1"></a>scene <span class="op">=</span> scene<span class="op">*</span>scale <span class="op">+</span> offset</span></code></pre></div>
</div>
<div id="visualize-the-scene-1" class="section level2">
<h2>Visualize the Scene</h2>
<p>To visualize our Dataset, we first convert it to a DataArray using
the <code>to_array()</code> method. All the variables will be converted
to a new dimension. Since our variables are image bands, we give the
name of the new dimesion as band.</p>
<div class="sourceCode" id="cb62"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb62-1"><a href="#cb62-1" tabindex="-1"></a>scene_da <span class="op">=</span> scene.to_array(<span class="st">&#39;band&#39;</span>)</span></code></pre></div>
<p>Rather than loading the entire scene into memory, we resample it to a
lower resolution preview and render it.</p>
<div class="sourceCode" id="cb63"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb63-1"><a href="#cb63-1" tabindex="-1"></a>preview <span class="op">=</span> scene_da.rio.reproject(</span>
<span id="cb63-2"><a href="#cb63-2" tabindex="-1"></a>    scene.rio.crs, resolution<span class="op">=</span><span class="dv">300</span></span>
<span id="cb63-3"><a href="#cb63-3" tabindex="-1"></a>)</span>
<span id="cb63-4"><a href="#cb63-4" tabindex="-1"></a></span>
<span id="cb63-5"><a href="#cb63-5" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb63-6"><a href="#cb63-6" tabindex="-1"></a>fig.set_size_inches(<span class="dv">5</span>,<span class="dv">5</span>)</span>
<span id="cb63-7"><a href="#cb63-7" tabindex="-1"></a>preview.sel(band<span class="op">=</span>[<span class="st">&#39;red&#39;</span>, <span class="st">&#39;green&#39;</span>, <span class="st">&#39;blue&#39;</span>]).plot.imshow(</span>
<span id="cb63-8"><a href="#cb63-8" tabindex="-1"></a>    ax<span class="op">=</span>ax,</span>
<span id="cb63-9"><a href="#cb63-9" tabindex="-1"></a>    robust<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb63-10"><a href="#cb63-10" tabindex="-1"></a>ax.set_title(<span class="st">&#39;RGB Visualization&#39;</span>)</span>
<span id="cb63-11"><a href="#cb63-11" tabindex="-1"></a>ax.set_axis_off()</span>
<span id="cb63-12"><a href="#cb63-12" tabindex="-1"></a>ax.set_aspect(<span class="st">&#39;equal&#39;</span>)</span>
<span id="cb63-13"><a href="#cb63-13" tabindex="-1"></a>plt.show()</span></code></pre></div>
<p>We can also view a False Color Composite (FCC) with a different
combination of spectral bands.</p>
<div class="sourceCode" id="cb64"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb64-1"><a href="#cb64-1" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb64-2"><a href="#cb64-2" tabindex="-1"></a>fig.set_size_inches(<span class="dv">5</span>,<span class="dv">5</span>)</span>
<span id="cb64-3"><a href="#cb64-3" tabindex="-1"></a>preview.sel(band<span class="op">=</span>[<span class="st">&#39;nir&#39;</span>, <span class="st">&#39;red&#39;</span>, <span class="st">&#39;green&#39;</span>]).plot.imshow(</span>
<span id="cb64-4"><a href="#cb64-4" tabindex="-1"></a>    ax<span class="op">=</span>ax,</span>
<span id="cb64-5"><a href="#cb64-5" tabindex="-1"></a>    robust<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb64-6"><a href="#cb64-6" tabindex="-1"></a>ax.set_title(<span class="st">&#39;NRG Visualization&#39;</span>)</span>
<span id="cb64-7"><a href="#cb64-7" tabindex="-1"></a>ax.set_axis_off()</span>
<span id="cb64-8"><a href="#cb64-8" tabindex="-1"></a>plt.show()</span></code></pre></div>
</div>
<div id="calculate-spectral-indices" class="section level2">
<h2>Calculate Spectral Indices</h2>
<p>The Normalized Difference Vegetation Index (NDVI) is calculated using
the following formula:</p>
<p><code>NDVI = (NIR - Red)/(NIR + Red)</code></p>
<p>Where: * NIR = Near-Infrared band reflectance * Red = Red band
reflectance</p>
<div class="sourceCode" id="cb65"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb65-1"><a href="#cb65-1" tabindex="-1"></a>red <span class="op">=</span> scene_da.sel(band<span class="op">=</span><span class="st">&#39;red&#39;</span>)</span>
<span id="cb65-2"><a href="#cb65-2" tabindex="-1"></a>nir <span class="op">=</span> scene_da.sel(band<span class="op">=</span><span class="st">&#39;nir&#39;</span>)</span>
<span id="cb65-3"><a href="#cb65-3" tabindex="-1"></a></span>
<span id="cb65-4"><a href="#cb65-4" tabindex="-1"></a>ndvi <span class="op">=</span> (nir <span class="op">-</span> red)<span class="op">/</span>(nir <span class="op">+</span> red)</span>
<span id="cb65-5"><a href="#cb65-5" tabindex="-1"></a>ndvi</span></code></pre></div>
<p>Let’s visualize the results.</p>
<div class="sourceCode" id="cb66"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb66-1"><a href="#cb66-1" tabindex="-1"></a>ndvi_preview <span class="op">=</span> ndvi.rio.reproject(</span>
<span id="cb66-2"><a href="#cb66-2" tabindex="-1"></a>    ndvi.rio.crs, resolution<span class="op">=</span><span class="dv">300</span></span>
<span id="cb66-3"><a href="#cb66-3" tabindex="-1"></a>)</span>
<span id="cb66-4"><a href="#cb66-4" tabindex="-1"></a>cbar_kwargs <span class="op">=</span> {</span>
<span id="cb66-5"><a href="#cb66-5" tabindex="-1"></a>    <span class="st">&#39;orientation&#39;</span>:<span class="st">&#39;horizontal&#39;</span>,</span>
<span id="cb66-6"><a href="#cb66-6" tabindex="-1"></a>    <span class="st">&#39;fraction&#39;</span>: <span class="fl">0.025</span>,</span>
<span id="cb66-7"><a href="#cb66-7" tabindex="-1"></a>    <span class="st">&#39;pad&#39;</span>: <span class="fl">0.05</span>,</span>
<span id="cb66-8"><a href="#cb66-8" tabindex="-1"></a>    <span class="st">&#39;extend&#39;</span>:<span class="st">&#39;neither&#39;</span></span>
<span id="cb66-9"><a href="#cb66-9" tabindex="-1"></a>}</span>
<span id="cb66-10"><a href="#cb66-10" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb66-11"><a href="#cb66-11" tabindex="-1"></a>fig.set_size_inches(<span class="dv">5</span>,<span class="dv">5</span>)</span>
<span id="cb66-12"><a href="#cb66-12" tabindex="-1"></a>ndvi_preview.plot.imshow(</span>
<span id="cb66-13"><a href="#cb66-13" tabindex="-1"></a>    ax<span class="op">=</span>ax,</span>
<span id="cb66-14"><a href="#cb66-14" tabindex="-1"></a>    cmap<span class="op">=</span><span class="st">&#39;Greens&#39;</span>,</span>
<span id="cb66-15"><a href="#cb66-15" tabindex="-1"></a>    robust<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb66-16"><a href="#cb66-16" tabindex="-1"></a>    cbar_kwargs<span class="op">=</span>cbar_kwargs)</span>
<span id="cb66-17"><a href="#cb66-17" tabindex="-1"></a>ax.set_title(<span class="st">&#39;NDVI&#39;</span>)</span>
<span id="cb66-18"><a href="#cb66-18" tabindex="-1"></a>ax.set_axis_off()</span>
<span id="cb66-19"><a href="#cb66-19" tabindex="-1"></a>plt.show()</span></code></pre></div>
<p>The Modified Normalized Difference Water Index (MNDWI) is calculated
using the following formula:</p>
<p><code>MNDWI = (Green - SWIR1)/(Green + SWIR1)</code></p>
<p>Where: * Green = Green band reflectance * SWIR1 = Short-wave infrared
band 1 reflectance</p>
<div class="sourceCode" id="cb67"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb67-1"><a href="#cb67-1" tabindex="-1"></a>green <span class="op">=</span> scene_da.sel(band<span class="op">=</span><span class="st">&#39;green&#39;</span>)</span>
<span id="cb67-2"><a href="#cb67-2" tabindex="-1"></a>swir16 <span class="op">=</span> scene_da.sel(band<span class="op">=</span><span class="st">&#39;swir16&#39;</span>)</span>
<span id="cb67-3"><a href="#cb67-3" tabindex="-1"></a>mndwi <span class="op">=</span> (green <span class="op">-</span> swir16)<span class="op">/</span>(green <span class="op">+</span> swir16)</span></code></pre></div>
<p>The Soil Adjusted Vegetation Index (SAVI) is calculated using the
following formula:</p>
<p><code>SAVI = (1 + L) * ((NIR - Red)/(NIR + Red + L))</code></p>
<p>Where: * NIR = Near-Infrared band reflectance * Red = Red band
reflectance * L = Soil brightness correction factor (typically 0.5 for
moderate vegetation)</p>
<div class="sourceCode" id="cb68"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb68-1"><a href="#cb68-1" tabindex="-1"></a>savi <span class="op">=</span> <span class="fl">1.5</span> <span class="op">*</span> ((nir <span class="op">-</span> red) <span class="op">/</span> (nir <span class="op">+</span> red <span class="op">+</span> <span class="fl">0.5</span>))</span></code></pre></div>
</div>
<div id="save-the-computed-indices" class="section level2">
<h2>Save the Computed Indices</h2>
<p>Rather than saving it to the temporary machine where Colab is
running, we can save it to our own Google Drive. This will ensure the
image will be available to us even after existing Google Colab.</p>
<p>Run the following cell to authenticate and mount the Google
Drive.</p>
<div class="sourceCode" id="cb69"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb69-1"><a href="#cb69-1" tabindex="-1"></a><span class="im">from</span> google.colab <span class="im">import</span> drive</span>
<span id="cb69-2"><a href="#cb69-2" tabindex="-1"></a>drive.mount(<span class="st">&#39;/content/drive&#39;</span>)</span></code></pre></div>
<div class="sourceCode" id="cb70"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb70-1"><a href="#cb70-1" tabindex="-1"></a>drive_folder_root <span class="op">=</span> <span class="st">&#39;MyDrive&#39;</span></span>
<span id="cb70-2"><a href="#cb70-2" tabindex="-1"></a>output_folder <span class="op">=</span> <span class="st">&#39;data&#39;</span></span>
<span id="cb70-3"><a href="#cb70-3" tabindex="-1"></a>output_folder_path <span class="op">=</span> os.path.join(</span>
<span id="cb70-4"><a href="#cb70-4" tabindex="-1"></a>    <span class="st">&#39;/content/drive&#39;</span>, drive_folder_root, output_folder)</span>
<span id="cb70-5"><a href="#cb70-5" tabindex="-1"></a></span>
<span id="cb70-6"><a href="#cb70-6" tabindex="-1"></a><span class="co"># Check if Google Drive is mounted</span></span>
<span id="cb70-7"><a href="#cb70-7" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> os.path.exists(<span class="st">&#39;/content/drive&#39;</span>):</span>
<span id="cb70-8"><a href="#cb70-8" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;Google Drive is not mounted. Please run the cell above to mount your drive.&quot;</span>)</span>
<span id="cb70-9"><a href="#cb70-9" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb70-10"><a href="#cb70-10" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> os.path.exists(output_folder_path):</span>
<span id="cb70-11"><a href="#cb70-11" tabindex="-1"></a>        os.makedirs(output_folder_path)</span></code></pre></div>
<div class="sourceCode" id="cb71"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb71-1"><a href="#cb71-1" tabindex="-1"></a>files <span class="op">=</span> {</span>
<span id="cb71-2"><a href="#cb71-2" tabindex="-1"></a>    <span class="st">&#39;ndvi.tif&#39;</span>: ndvi,</span>
<span id="cb71-3"><a href="#cb71-3" tabindex="-1"></a>    <span class="st">&#39;mndwi.tif&#39;</span>: mndwi,</span>
<span id="cb71-4"><a href="#cb71-4" tabindex="-1"></a>    <span class="st">&#39;savi.tif&#39;</span>: savi</span>
<span id="cb71-5"><a href="#cb71-5" tabindex="-1"></a>}</span>
<span id="cb71-6"><a href="#cb71-6" tabindex="-1"></a></span>
<span id="cb71-7"><a href="#cb71-7" tabindex="-1"></a><span class="cf">for</span> <span class="bu">file</span> <span class="kw">in</span> files:</span>
<span id="cb71-8"><a href="#cb71-8" tabindex="-1"></a>  output_path <span class="op">=</span> os.path.join(output_folder_path, <span class="bu">file</span>)</span>
<span id="cb71-9"><a href="#cb71-9" tabindex="-1"></a>  files[<span class="bu">file</span>].rio.to_raster(output_path, driver<span class="op">=</span><span class="st">&#39;COG&#39;</span>)</span>
<span id="cb71-10"><a href="#cb71-10" tabindex="-1"></a>  <span class="bu">print</span>(<span class="ss">f&#39;Saved </span><span class="sc">{</span><span class="bu">file</span><span class="sc">}</span><span class="ss"> to </span><span class="sc">{</span>output_path<span class="sc">}</span><span class="ss">&#39;</span>)</span></code></pre></div>
</div>
</div>
<div id="masking-clouds" class="section level1">
<h1>4. Masking Clouds</h1>
<p><a
href="https://colab.research.google.com/github/spatialthoughts/courses/blob/master/code/python_remote_sensing/04_masking_clouds.ipynb"><img
src="https://colab.research.google.com/assets/colab-badge.svg"
alt="Open In Colab" /></a></p>
<div id="overview-3" class="section level2">
<h2>Overview</h2>
<p>When working with optical satellite imagery, we need to ensure the
cloudy-pixels are removed from analysis. Most providers supply QA bands
detailing locations of cloudy pixels. There are also third-party
cloud-masking packages that can be used to locate and mask cloudy
pixels.</p>
<p>In this section, we will use the Scene Classification (SCL) band
supplied with Sentinel-2 Level-2A images to remove clouds and
cloud-shadows from a scene.</p>
</div>
<div id="setup-and-data-download-3" class="section level2">
<h2>Setup and Data Download</h2>
<p>The following blocks of code will install the required packages and
download the datasets to your Colab environment.</p>
<div class="sourceCode" id="cb72"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb72-1"><a href="#cb72-1" tabindex="-1"></a><span class="op">%%</span>capture</span>
<span id="cb72-2"><a href="#cb72-2" tabindex="-1"></a><span class="cf">if</span> <span class="st">&#39;google.colab&#39;</span> <span class="kw">in</span> <span class="bu">str</span>(get_ipython()):</span>
<span id="cb72-3"><a href="#cb72-3" tabindex="-1"></a>    <span class="op">!</span>pip install pystac<span class="op">-</span>client odc<span class="op">-</span>stac rioxarray dask jupyter<span class="op">-</span>server<span class="op">-</span>proxy</span></code></pre></div>
<div class="sourceCode" id="cb73"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb73-1"><a href="#cb73-1" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb73-2"><a href="#cb73-2" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb73-3"><a href="#cb73-3" tabindex="-1"></a><span class="im">from</span> matplotlib.colors <span class="im">import</span> ListedColormap</span>
<span id="cb73-4"><a href="#cb73-4" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb73-5"><a href="#cb73-5" tabindex="-1"></a><span class="im">import</span> pystac_client</span>
<span id="cb73-6"><a href="#cb73-6" tabindex="-1"></a><span class="im">from</span> odc <span class="im">import</span> stac</span>
<span id="cb73-7"><a href="#cb73-7" tabindex="-1"></a><span class="im">import</span> xarray <span class="im">as</span> xr</span>
<span id="cb73-8"><a href="#cb73-8" tabindex="-1"></a><span class="im">import</span> rioxarray <span class="im">as</span> rxr</span></code></pre></div>
<div class="sourceCode" id="cb74"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb74-1"><a href="#cb74-1" tabindex="-1"></a><span class="im">from</span> dask.distributed <span class="im">import</span> Client</span>
<span id="cb74-2"><a href="#cb74-2" tabindex="-1"></a>client <span class="op">=</span> Client()  <span class="co"># set up local cluster on the machine</span></span>
<span id="cb74-3"><a href="#cb74-3" tabindex="-1"></a>client</span></code></pre></div>
<p>f you are running this notebook in Colab, you will need to create and
use a proxy URL to see the dashboard running on the local server.</p>
<div class="sourceCode" id="cb75"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb75-1"><a href="#cb75-1" tabindex="-1"></a><span class="cf">if</span> <span class="st">&#39;google.colab&#39;</span> <span class="kw">in</span> <span class="bu">str</span>(get_ipython()):</span>
<span id="cb75-2"><a href="#cb75-2" tabindex="-1"></a>    <span class="im">from</span> google.colab <span class="im">import</span> output</span>
<span id="cb75-3"><a href="#cb75-3" tabindex="-1"></a>    port_to_expose <span class="op">=</span> <span class="dv">8787</span>  <span class="co"># This is the default port for Dask dashboard</span></span>
<span id="cb75-4"><a href="#cb75-4" tabindex="-1"></a>    <span class="bu">print</span>(output.eval_js(<span class="ss">f&#39;google.colab.kernel.proxyPort(</span><span class="sc">{</span>port_to_expose<span class="sc">}</span><span class="ss">)&#39;</span>))</span></code></pre></div>
</div>
<div id="get-a-sentinel-2-scene-1" class="section level2">
<h2>Get a Sentinel-2 Scene</h2>
<p>We define a location and time of interest to get some satellite
imagery.</p>
<div class="sourceCode" id="cb76"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb76-1"><a href="#cb76-1" tabindex="-1"></a>latitude <span class="op">=</span> <span class="fl">27.163</span></span>
<span id="cb76-2"><a href="#cb76-2" tabindex="-1"></a>longitude <span class="op">=</span> <span class="fl">82.608</span></span>
<span id="cb76-3"><a href="#cb76-3" tabindex="-1"></a>year <span class="op">=</span> <span class="dv">2023</span></span></code></pre></div>
<div class="sourceCode" id="cb77"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb77-1"><a href="#cb77-1" tabindex="-1"></a><span class="co"># Define a small bounding box around the chosen point</span></span>
<span id="cb77-2"><a href="#cb77-2" tabindex="-1"></a>km2deg <span class="op">=</span> <span class="fl">1.0</span> <span class="op">/</span> <span class="dv">111</span></span>
<span id="cb77-3"><a href="#cb77-3" tabindex="-1"></a>x, y <span class="op">=</span> (longitude, latitude)</span>
<span id="cb77-4"><a href="#cb77-4" tabindex="-1"></a>r <span class="op">=</span> <span class="dv">1</span> <span class="op">*</span> km2deg  <span class="co"># radius in degrees</span></span>
<span id="cb77-5"><a href="#cb77-5" tabindex="-1"></a>bbox <span class="op">=</span> (x <span class="op">-</span> r, y <span class="op">-</span> r, x <span class="op">+</span> r, y <span class="op">+</span> r)</span></code></pre></div>
<p>Search the catalog for matching items. This time we use
<code>'direction': 'desc'</code> in the <code>sortby</code> parameter to
get results where the first scene has the highest cloud-cover.</p>
<div class="sourceCode" id="cb78"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb78-1"><a href="#cb78-1" tabindex="-1"></a><span class="co"># Query the STAC Catalog</span></span>
<span id="cb78-2"><a href="#cb78-2" tabindex="-1"></a>catalog <span class="op">=</span> pystac_client.Client.<span class="bu">open</span>(</span>
<span id="cb78-3"><a href="#cb78-3" tabindex="-1"></a>    <span class="st">&#39;https://earth-search.aws.element84.com/v1&#39;</span>)</span>
<span id="cb78-4"><a href="#cb78-4" tabindex="-1"></a></span>
<span id="cb78-5"><a href="#cb78-5" tabindex="-1"></a>search <span class="op">=</span> catalog.search(</span>
<span id="cb78-6"><a href="#cb78-6" tabindex="-1"></a>    collections<span class="op">=</span>[<span class="st">&#39;sentinel-2-c1-l2a&#39;</span>],</span>
<span id="cb78-7"><a href="#cb78-7" tabindex="-1"></a>    bbox<span class="op">=</span>bbox,</span>
<span id="cb78-8"><a href="#cb78-8" tabindex="-1"></a>    datetime<span class="op">=</span><span class="ss">f&#39;</span><span class="sc">{</span>year<span class="sc">}</span><span class="ss">&#39;</span>,</span>
<span id="cb78-9"><a href="#cb78-9" tabindex="-1"></a>    query<span class="op">=</span>{</span>
<span id="cb78-10"><a href="#cb78-10" tabindex="-1"></a>        <span class="st">&#39;eo:cloud_cover&#39;</span>: {<span class="st">&#39;lt&#39;</span>: <span class="dv">50</span>},</span>
<span id="cb78-11"><a href="#cb78-11" tabindex="-1"></a>        <span class="st">&#39;s2:nodata_pixel_percentage&#39;</span>: {<span class="st">&#39;lt&#39;</span>: <span class="dv">10</span>}},</span>
<span id="cb78-12"><a href="#cb78-12" tabindex="-1"></a>    sortby<span class="op">=</span>[</span>
<span id="cb78-13"><a href="#cb78-13" tabindex="-1"></a>        {<span class="st">&#39;field&#39;</span>: <span class="st">&#39;properties.eo:cloud_cover&#39;</span>,</span>
<span id="cb78-14"><a href="#cb78-14" tabindex="-1"></a>         <span class="st">&#39;direction&#39;</span>: <span class="st">&#39;desc&#39;</span>}</span>
<span id="cb78-15"><a href="#cb78-15" tabindex="-1"></a>        ]</span>
<span id="cb78-16"><a href="#cb78-16" tabindex="-1"></a></span>
<span id="cb78-17"><a href="#cb78-17" tabindex="-1"></a>)</span>
<span id="cb78-18"><a href="#cb78-18" tabindex="-1"></a>items <span class="op">=</span> search.item_collection()</span>
<span id="cb78-19"><a href="#cb78-19" tabindex="-1"></a></span>
<span id="cb78-20"><a href="#cb78-20" tabindex="-1"></a><span class="co"># Load to XArray</span></span>
<span id="cb78-21"><a href="#cb78-21" tabindex="-1"></a>ds <span class="op">=</span> stac.load(</span>
<span id="cb78-22"><a href="#cb78-22" tabindex="-1"></a>    items,</span>
<span id="cb78-23"><a href="#cb78-23" tabindex="-1"></a>    bands<span class="op">=</span>[<span class="st">&#39;red&#39;</span>, <span class="st">&#39;green&#39;</span>, <span class="st">&#39;blue&#39;</span>, <span class="st">&#39;scl&#39;</span>],</span>
<span id="cb78-24"><a href="#cb78-24" tabindex="-1"></a>    resolution<span class="op">=</span><span class="dv">10</span>,</span>
<span id="cb78-25"><a href="#cb78-25" tabindex="-1"></a>    chunks<span class="op">=</span>{},  <span class="co"># &lt;-- use Dask</span></span>
<span id="cb78-26"><a href="#cb78-26" tabindex="-1"></a>    groupby<span class="op">=</span><span class="st">&#39;solar_day&#39;</span>,</span>
<span id="cb78-27"><a href="#cb78-27" tabindex="-1"></a>    preserve_original_order<span class="op">=</span><span class="va">True</span></span>
<span id="cb78-28"><a href="#cb78-28" tabindex="-1"></a>)</span>
<span id="cb78-29"><a href="#cb78-29" tabindex="-1"></a></span>
<span id="cb78-30"><a href="#cb78-30" tabindex="-1"></a><span class="co"># Select the first scene</span></span>
<span id="cb78-31"><a href="#cb78-31" tabindex="-1"></a>timestamp <span class="op">=</span> pd.to_datetime(items[<span class="dv">0</span>].properties[<span class="st">&#39;datetime&#39;</span>]).tz_convert(<span class="va">None</span>)</span>
<span id="cb78-32"><a href="#cb78-32" tabindex="-1"></a>scene <span class="op">=</span> ds.sel(time<span class="op">=</span>timestamp)</span>
<span id="cb78-33"><a href="#cb78-33" tabindex="-1"></a><span class="co"># Mask nodata values</span></span>
<span id="cb78-34"><a href="#cb78-34" tabindex="-1"></a>scene <span class="op">=</span> scene.where(scene <span class="op">!=</span> <span class="dv">0</span>)</span>
<span id="cb78-35"><a href="#cb78-35" tabindex="-1"></a><span class="co"># Apply scale/offset</span></span>
<span id="cb78-36"><a href="#cb78-36" tabindex="-1"></a>scale <span class="op">=</span> <span class="fl">0.0001</span></span>
<span id="cb78-37"><a href="#cb78-37" tabindex="-1"></a>offset <span class="op">=</span> <span class="op">-</span><span class="fl">0.1</span></span>
<span id="cb78-38"><a href="#cb78-38" tabindex="-1"></a><span class="co"># Select spectral bands (all except &#39;scl&#39;)</span></span>
<span id="cb78-39"><a href="#cb78-39" tabindex="-1"></a>data_bands <span class="op">=</span> [band <span class="cf">for</span> band <span class="kw">in</span> scene.data_vars <span class="cf">if</span> band <span class="op">!=</span> <span class="st">&#39;scl&#39;</span>]</span>
<span id="cb78-40"><a href="#cb78-40" tabindex="-1"></a><span class="cf">for</span> band <span class="kw">in</span> data_bands:</span>
<span id="cb78-41"><a href="#cb78-41" tabindex="-1"></a>  scene[band] <span class="op">=</span> scene[band] <span class="op">*</span> scale <span class="op">+</span> offset</span></code></pre></div>
</div>
<div id="visualize-the-scene-2" class="section level2">
<h2>Visualize the Scene</h2>
<p>The clouds will have a much higher reflectance, so
<code>robust=True</code> will not give us appropriate visualization. We
supply hardcoded min/max values as 0 and 0.3 which is the normal range
of reflectance values of earth targets.</p>
<div class="sourceCode" id="cb79"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb79-1"><a href="#cb79-1" tabindex="-1"></a>scene_da <span class="op">=</span> scene.to_array(<span class="st">&#39;band&#39;</span>)</span>
<span id="cb79-2"><a href="#cb79-2" tabindex="-1"></a></span>
<span id="cb79-3"><a href="#cb79-3" tabindex="-1"></a>preview <span class="op">=</span> scene_da.rio.reproject(</span>
<span id="cb79-4"><a href="#cb79-4" tabindex="-1"></a>    scene_da.rio.crs, resolution<span class="op">=</span><span class="dv">300</span></span>
<span id="cb79-5"><a href="#cb79-5" tabindex="-1"></a>)</span>
<span id="cb79-6"><a href="#cb79-6" tabindex="-1"></a></span>
<span id="cb79-7"><a href="#cb79-7" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb79-8"><a href="#cb79-8" tabindex="-1"></a>fig.set_size_inches(<span class="dv">5</span>,<span class="dv">5</span>)</span>
<span id="cb79-9"><a href="#cb79-9" tabindex="-1"></a>preview.sel(band<span class="op">=</span>[<span class="st">&#39;red&#39;</span>, <span class="st">&#39;green&#39;</span>, <span class="st">&#39;blue&#39;</span>]).plot.imshow(</span>
<span id="cb79-10"><a href="#cb79-10" tabindex="-1"></a>    ax<span class="op">=</span>ax,</span>
<span id="cb79-11"><a href="#cb79-11" tabindex="-1"></a>    vmin<span class="op">=</span><span class="dv">0</span>, vmax<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb79-12"><a href="#cb79-12" tabindex="-1"></a>ax.set_title(<span class="st">&#39;RGB Visualization&#39;</span>)</span>
<span id="cb79-13"><a href="#cb79-13" tabindex="-1"></a>ax.set_axis_off()</span>
<span id="cb79-14"><a href="#cb79-14" tabindex="-1"></a>ax.set_aspect(<span class="st">&#39;equal&#39;</span>)</span>
<span id="cb79-15"><a href="#cb79-15" tabindex="-1"></a>plt.show()</span></code></pre></div>
</div>
<div id="create-a-cloud-mask" class="section level2">
<h2>Create a Cloud Mask</h2>
<p>The Scene Classification (SCL) band has each pixel classified into
one of the following classes.</p>
<table>
<colgroup>
<col width="13%" />
<col width="86%" />
</colgroup>
<thead>
<tr>
<th>Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>No Data</td>
</tr>
<tr>
<td>1</td>
<td>Saturated or defective pixel</td>
</tr>
<tr>
<td>2</td>
<td>Dark area pixels</td>
</tr>
<tr>
<td>3</td>
<td>Cloud shadows</td>
</tr>
<tr>
<td>4</td>
<td>Vegetation</td>
</tr>
<tr>
<td>5</td>
<td>Not vegetated</td>
</tr>
<tr>
<td>6</td>
<td>Water</td>
</tr>
<tr>
<td>7</td>
<td>Clouds Low Probability / Unclassified</td>
</tr>
<tr>
<td>8</td>
<td>Cloud medium probability</td>
</tr>
<tr>
<td>9</td>
<td>Cloud high probability</td>
</tr>
<tr>
<td>10</td>
<td>Thin cirrus</td>
</tr>
<tr>
<td>11</td>
<td>Snow / Ice</td>
</tr>
</tbody>
</table>
<p>We select the types of pixels we want to mask. Let’s create a mask
that will remove all pixels marked <code>Cloud shadows (3)</code>,
<code>Cloud Medium Probability (8)</code>,
<code>Cloud High Probability (9)</code> and
<code>Thin Cirrus (10)</code>.</p>
<div class="sourceCode" id="cb80"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb80-1"><a href="#cb80-1" tabindex="-1"></a>mask <span class="op">=</span> scene.scl.isin([<span class="dv">3</span>,<span class="dv">8</span>,<span class="dv">9</span>,<span class="dv">10</span>])</span></code></pre></div>
<p>Visualize the mask by overlaying it on the scene.</p>
<div class="sourceCode" id="cb81"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb81-1"><a href="#cb81-1" tabindex="-1"></a>mask_preview <span class="op">=</span> mask.astype(<span class="st">&#39;uint8&#39;</span>).rio.reproject(</span>
<span id="cb81-2"><a href="#cb81-2" tabindex="-1"></a>    mask.rio.crs, resolution<span class="op">=</span><span class="dv">300</span></span>
<span id="cb81-3"><a href="#cb81-3" tabindex="-1"></a>)</span>
<span id="cb81-4"><a href="#cb81-4" tabindex="-1"></a></span>
<span id="cb81-5"><a href="#cb81-5" tabindex="-1"></a>fig, (ax0, ax1) <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">2</span>)</span>
<span id="cb81-6"><a href="#cb81-6" tabindex="-1"></a>fig.set_size_inches(<span class="dv">10</span>,<span class="dv">5</span>)</span>
<span id="cb81-7"><a href="#cb81-7" tabindex="-1"></a>preview.sel(band<span class="op">=</span>[<span class="st">&#39;red&#39;</span>, <span class="st">&#39;green&#39;</span>, <span class="st">&#39;blue&#39;</span>]).plot.imshow(</span>
<span id="cb81-8"><a href="#cb81-8" tabindex="-1"></a>    ax<span class="op">=</span>ax0,</span>
<span id="cb81-9"><a href="#cb81-9" tabindex="-1"></a>    vmin<span class="op">=</span><span class="dv">0</span>, vmax<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb81-10"><a href="#cb81-10" tabindex="-1"></a>ax0.set_title(<span class="st">&#39;RGB Visualization&#39;</span>)</span>
<span id="cb81-11"><a href="#cb81-11" tabindex="-1"></a></span>
<span id="cb81-12"><a href="#cb81-12" tabindex="-1"></a>preview.sel(band<span class="op">=</span>[<span class="st">&#39;red&#39;</span>, <span class="st">&#39;green&#39;</span>, <span class="st">&#39;blue&#39;</span>]).plot.imshow(</span>
<span id="cb81-13"><a href="#cb81-13" tabindex="-1"></a>    ax<span class="op">=</span>ax1,</span>
<span id="cb81-14"><a href="#cb81-14" tabindex="-1"></a>    vmin<span class="op">=</span><span class="dv">0</span>, vmax<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb81-15"><a href="#cb81-15" tabindex="-1"></a></span>
<span id="cb81-16"><a href="#cb81-16" tabindex="-1"></a><span class="co"># RGBA: Transparent, Red</span></span>
<span id="cb81-17"><a href="#cb81-17" tabindex="-1"></a>mask_colormap <span class="op">=</span> ListedColormap([<span class="st">&#39;#00000000&#39;</span>, <span class="st">&#39;#FF0000FF&#39;</span>])</span>
<span id="cb81-18"><a href="#cb81-18" tabindex="-1"></a>mask_preview.plot.imshow(</span>
<span id="cb81-19"><a href="#cb81-19" tabindex="-1"></a>    ax<span class="op">=</span>ax1,</span>
<span id="cb81-20"><a href="#cb81-20" tabindex="-1"></a>    cmap<span class="op">=</span>mask_colormap,</span>
<span id="cb81-21"><a href="#cb81-21" tabindex="-1"></a>    add_colorbar<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb81-22"><a href="#cb81-22" tabindex="-1"></a></span>
<span id="cb81-23"><a href="#cb81-23" tabindex="-1"></a>ax1.set_title(<span class="st">&#39;Cloud Mask&#39;</span>)</span>
<span id="cb81-24"><a href="#cb81-24" tabindex="-1"></a><span class="cf">for</span> ax <span class="kw">in</span> (ax0, ax1):</span>
<span id="cb81-25"><a href="#cb81-25" tabindex="-1"></a>  ax.set_axis_off()</span>
<span id="cb81-26"><a href="#cb81-26" tabindex="-1"></a>  ax.set_aspect(<span class="st">&#39;equal&#39;</span>)</span>
<span id="cb81-27"><a href="#cb81-27" tabindex="-1"></a>plt.show()</span></code></pre></div>
<p>Once we are satisfied that the mask looks good, we go ahead and apply
the mask on the scene.</p>
<div class="sourceCode" id="cb82"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb82-1"><a href="#cb82-1" tabindex="-1"></a><span class="co"># Apply the mask to all the data bands</span></span>
<span id="cb82-2"><a href="#cb82-2" tabindex="-1"></a>scene_masked <span class="op">=</span> scene[data_bands].where(<span class="op">~</span>mask)</span></code></pre></div>
</div>
<div id="save-the-results" class="section level2">
<h2>Save the Results</h2>
<p>Rather than saving it to the temporary machine where Colab is
running, we can save it to our own Google Drive. This will ensure the
image will be available to us even after existing Google Colab.</p>
<p>Run the following cell to authenticate and mount the Google
Drive.</p>
<div class="sourceCode" id="cb83"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb83-1"><a href="#cb83-1" tabindex="-1"></a><span class="im">from</span> google.colab <span class="im">import</span> drive</span>
<span id="cb83-2"><a href="#cb83-2" tabindex="-1"></a>drive.mount(<span class="st">&#39;/content/drive&#39;</span>)</span></code></pre></div>
<div class="sourceCode" id="cb84"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb84-1"><a href="#cb84-1" tabindex="-1"></a>drive_folder_root <span class="op">=</span> <span class="st">&#39;MyDrive&#39;</span></span>
<span id="cb84-2"><a href="#cb84-2" tabindex="-1"></a>output_folder <span class="op">=</span> <span class="st">&#39;data&#39;</span></span>
<span id="cb84-3"><a href="#cb84-3" tabindex="-1"></a>output_folder_path <span class="op">=</span> os.path.join(</span>
<span id="cb84-4"><a href="#cb84-4" tabindex="-1"></a>    <span class="st">&#39;/content/drive&#39;</span>, drive_folder_root, output_folder)</span>
<span id="cb84-5"><a href="#cb84-5" tabindex="-1"></a></span>
<span id="cb84-6"><a href="#cb84-6" tabindex="-1"></a><span class="co"># Check if Google Drive is mounted</span></span>
<span id="cb84-7"><a href="#cb84-7" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> os.path.exists(<span class="st">&#39;/content/drive&#39;</span>):</span>
<span id="cb84-8"><a href="#cb84-8" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;Google Drive is not mounted. Please run the cell above to mount your drive.&quot;</span>)</span>
<span id="cb84-9"><a href="#cb84-9" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb84-10"><a href="#cb84-10" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> os.path.exists(output_folder_path):</span>
<span id="cb84-11"><a href="#cb84-11" tabindex="-1"></a>        os.makedirs(output_folder_path)</span></code></pre></div>
<div class="sourceCode" id="cb85"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb85-1"><a href="#cb85-1" tabindex="-1"></a>scene_id <span class="op">=</span> items[<span class="dv">0</span>].<span class="bu">id</span></span>
<span id="cb85-2"><a href="#cb85-2" tabindex="-1"></a></span>
<span id="cb85-3"><a href="#cb85-3" tabindex="-1"></a><span class="co"># Convert to DataArray for saving</span></span>
<span id="cb85-4"><a href="#cb85-4" tabindex="-1"></a>output_masked_da <span class="op">=</span> scene_masked.to_array(<span class="st">&#39;band&#39;</span>).sel(band<span class="op">=</span>[<span class="st">&#39;red&#39;</span>, <span class="st">&#39;green&#39;</span>, <span class="st">&#39;blue&#39;</span>])</span>
<span id="cb85-5"><a href="#cb85-5" tabindex="-1"></a>output_file_masked <span class="op">=</span> <span class="ss">f&#39;</span><span class="sc">{</span>scene_id<span class="sc">}</span><span class="ss">_masked.tif&#39;</span></span>
<span id="cb85-6"><a href="#cb85-6" tabindex="-1"></a>output_file_path <span class="op">=</span> os.path.join(output_folder_path, output_file_masked)</span>
<span id="cb85-7"><a href="#cb85-7" tabindex="-1"></a></span>
<span id="cb85-8"><a href="#cb85-8" tabindex="-1"></a>output_masked_da.rio.to_raster(output_file_path, compress<span class="op">=</span><span class="st">&#39;LZW&#39;</span>)</span></code></pre></div>
</div>
</div>
<div id="extracting-time-series" class="section level1">
<h1>5. Extracting Time-Series</h1>
<p><a
href="https://colab.research.google.com/github/spatialthoughts/courses/blob/master/code/python_remote_sensing/05_extracting_time_series.ipynb"><img
src="https://colab.research.google.com/assets/colab-badge.svg"
alt="Open In Colab" /></a></p>
<div id="overview-4" class="section level2">
<h2>Overview</h2>
<p>We are now ready to scale our analysis. Having learned how to
calculate spectral indices and do cloud masking for a single scene - we
can easily apply these operations to the entire data-cube and extract
the results at at one or more locations. Cloud-optimized data formats
and Dask ensure that we fetch and process only a small amount of data
that is required to compute the results at the pixels of interest.</p>
<p>In this section, we will get all Sentinel-2 scenes collected over our
region of interest, apply a cloud-mask, calculate NDVI and extract a
time-series of NDVI at a single location. We will also use XArray’s
built-in time-series processing functions to interpolat and smooth the
results.</p>
</div>
<div id="setup-and-data-download-4" class="section level2">
<h2>Setup and Data Download</h2>
<p>The following blocks of code will install the required packages and
download the datasets to your Colab environment.</p>
<div class="sourceCode" id="cb86"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb86-1"><a href="#cb86-1" tabindex="-1"></a><span class="op">%%</span>capture</span>
<span id="cb86-2"><a href="#cb86-2" tabindex="-1"></a><span class="cf">if</span> <span class="st">&#39;google.colab&#39;</span> <span class="kw">in</span> <span class="bu">str</span>(get_ipython()):</span>
<span id="cb86-3"><a href="#cb86-3" tabindex="-1"></a>    <span class="op">!</span>pip install pystac<span class="op">-</span>client odc<span class="op">-</span>stac rioxarray dask jupyter<span class="op">-</span>server<span class="op">-</span>proxy</span></code></pre></div>
<div class="sourceCode" id="cb87"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb87-1"><a href="#cb87-1" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb87-2"><a href="#cb87-2" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb87-3"><a href="#cb87-3" tabindex="-1"></a><span class="im">import</span> pystac_client</span>
<span id="cb87-4"><a href="#cb87-4" tabindex="-1"></a><span class="im">from</span> odc <span class="im">import</span> stac</span>
<span id="cb87-5"><a href="#cb87-5" tabindex="-1"></a><span class="im">import</span> xarray <span class="im">as</span> xr</span>
<span id="cb87-6"><a href="#cb87-6" tabindex="-1"></a><span class="im">import</span> rioxarray <span class="im">as</span> rxr</span>
<span id="cb87-7"><a href="#cb87-7" tabindex="-1"></a><span class="im">import</span> pyproj</span></code></pre></div>
<div class="sourceCode" id="cb88"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb88-1"><a href="#cb88-1" tabindex="-1"></a><span class="im">from</span> dask.distributed <span class="im">import</span> Client</span>
<span id="cb88-2"><a href="#cb88-2" tabindex="-1"></a>client <span class="op">=</span> Client()  <span class="co"># set up local cluster on the machine</span></span>
<span id="cb88-3"><a href="#cb88-3" tabindex="-1"></a>client</span></code></pre></div>
<p>f you are running this notebook in Colab, you will need to create and
use a proxy URL to see the dashboard running on the local server.</p>
<div class="sourceCode" id="cb89"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb89-1"><a href="#cb89-1" tabindex="-1"></a><span class="cf">if</span> <span class="st">&#39;google.colab&#39;</span> <span class="kw">in</span> <span class="bu">str</span>(get_ipython()):</span>
<span id="cb89-2"><a href="#cb89-2" tabindex="-1"></a>    <span class="im">from</span> google.colab <span class="im">import</span> output</span>
<span id="cb89-3"><a href="#cb89-3" tabindex="-1"></a>    port_to_expose <span class="op">=</span> <span class="dv">8787</span>  <span class="co"># This is the default port for Dask dashboard</span></span>
<span id="cb89-4"><a href="#cb89-4" tabindex="-1"></a>    <span class="bu">print</span>(output.eval_js(<span class="ss">f&#39;google.colab.kernel.proxyPort(</span><span class="sc">{</span>port_to_expose<span class="sc">}</span><span class="ss">)&#39;</span>))</span></code></pre></div>
<div class="sourceCode" id="cb90"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb90-1"><a href="#cb90-1" tabindex="-1"></a>data_folder <span class="op">=</span> <span class="st">&#39;data&#39;</span></span>
<span id="cb90-2"><a href="#cb90-2" tabindex="-1"></a>output_folder <span class="op">=</span> <span class="st">&#39;output&#39;</span></span>
<span id="cb90-3"><a href="#cb90-3" tabindex="-1"></a></span>
<span id="cb90-4"><a href="#cb90-4" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> os.path.exists(data_folder):</span>
<span id="cb90-5"><a href="#cb90-5" tabindex="-1"></a>    os.mkdir(data_folder)</span>
<span id="cb90-6"><a href="#cb90-6" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> os.path.exists(output_folder):</span>
<span id="cb90-7"><a href="#cb90-7" tabindex="-1"></a>    os.mkdir(output_folder)</span></code></pre></div>
</div>
<div id="get-satellite-imagery-using-stac-api" class="section level2">
<h2>Get Satellite Imagery using STAC API</h2>
<p>We define a location and time of interest to get some satellite
imagery.</p>
<div class="sourceCode" id="cb91"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb91-1"><a href="#cb91-1" tabindex="-1"></a>latitude <span class="op">=</span> <span class="fl">27.163</span></span>
<span id="cb91-2"><a href="#cb91-2" tabindex="-1"></a>longitude <span class="op">=</span> <span class="fl">82.608</span></span>
<span id="cb91-3"><a href="#cb91-3" tabindex="-1"></a>year <span class="op">=</span> <span class="dv">2023</span></span></code></pre></div>
<div class="sourceCode" id="cb92"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb92-1"><a href="#cb92-1" tabindex="-1"></a><span class="co"># Define a small bounding box around the chosen point</span></span>
<span id="cb92-2"><a href="#cb92-2" tabindex="-1"></a>km2deg <span class="op">=</span> <span class="fl">1.0</span> <span class="op">/</span> <span class="dv">111</span></span>
<span id="cb92-3"><a href="#cb92-3" tabindex="-1"></a>x, y <span class="op">=</span> (longitude, latitude)</span>
<span id="cb92-4"><a href="#cb92-4" tabindex="-1"></a>r <span class="op">=</span> <span class="dv">1</span> <span class="op">*</span> km2deg  <span class="co"># radius in degrees</span></span>
<span id="cb92-5"><a href="#cb92-5" tabindex="-1"></a>bbox <span class="op">=</span> (x <span class="op">-</span> r, y <span class="op">-</span> r, x <span class="op">+</span> r, y <span class="op">+</span> r)</span></code></pre></div>
<p>Let’s use Element84 search endpoint to look for items from the
sentinel-2-l2a collection on AWS.</p>
<div class="sourceCode" id="cb93"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb93-1"><a href="#cb93-1" tabindex="-1"></a>catalog <span class="op">=</span> pystac_client.Client.<span class="bu">open</span>(</span>
<span id="cb93-2"><a href="#cb93-2" tabindex="-1"></a>    <span class="st">&#39;https://earth-search.aws.element84.com/v1&#39;</span>)</span>
<span id="cb93-3"><a href="#cb93-3" tabindex="-1"></a></span>
<span id="cb93-4"><a href="#cb93-4" tabindex="-1"></a>search <span class="op">=</span> catalog.search(</span>
<span id="cb93-5"><a href="#cb93-5" tabindex="-1"></a>    collections<span class="op">=</span>[<span class="st">&#39;sentinel-2-c1-l2a&#39;</span>],</span>
<span id="cb93-6"><a href="#cb93-6" tabindex="-1"></a>    bbox<span class="op">=</span>bbox,</span>
<span id="cb93-7"><a href="#cb93-7" tabindex="-1"></a>    datetime<span class="op">=</span><span class="ss">f&#39;</span><span class="sc">{</span>year<span class="sc">}</span><span class="ss">&#39;</span>,</span>
<span id="cb93-8"><a href="#cb93-8" tabindex="-1"></a>    query<span class="op">=</span>{<span class="st">&#39;eo:cloud_cover&#39;</span>: {<span class="st">&#39;lt&#39;</span>: <span class="dv">30</span>}},</span>
<span id="cb93-9"><a href="#cb93-9" tabindex="-1"></a>)</span>
<span id="cb93-10"><a href="#cb93-10" tabindex="-1"></a>items <span class="op">=</span> search.item_collection()</span></code></pre></div>
<p>Load the matching images as a XArray Dataset.</p>
<div class="sourceCode" id="cb94"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb94-1"><a href="#cb94-1" tabindex="-1"></a><span class="co"># Query the STAC Catalog</span></span>
<span id="cb94-2"><a href="#cb94-2" tabindex="-1"></a>catalog <span class="op">=</span> pystac_client.Client.<span class="bu">open</span>(</span>
<span id="cb94-3"><a href="#cb94-3" tabindex="-1"></a>    <span class="st">&#39;https://earth-search.aws.element84.com/v1&#39;</span>)</span>
<span id="cb94-4"><a href="#cb94-4" tabindex="-1"></a></span>
<span id="cb94-5"><a href="#cb94-5" tabindex="-1"></a>search <span class="op">=</span> catalog.search(</span>
<span id="cb94-6"><a href="#cb94-6" tabindex="-1"></a>    collections<span class="op">=</span>[<span class="st">&#39;sentinel-2-c1-l2a&#39;</span>],</span>
<span id="cb94-7"><a href="#cb94-7" tabindex="-1"></a>    bbox<span class="op">=</span>bbox,</span>
<span id="cb94-8"><a href="#cb94-8" tabindex="-1"></a>    datetime<span class="op">=</span><span class="ss">f&#39;</span><span class="sc">{</span>year<span class="sc">}</span><span class="ss">&#39;</span>,</span>
<span id="cb94-9"><a href="#cb94-9" tabindex="-1"></a>    query<span class="op">=</span>{</span>
<span id="cb94-10"><a href="#cb94-10" tabindex="-1"></a>        <span class="st">&#39;eo:cloud_cover&#39;</span>: {<span class="st">&#39;lt&#39;</span>: <span class="dv">30</span>},</span>
<span id="cb94-11"><a href="#cb94-11" tabindex="-1"></a>    }</span>
<span id="cb94-12"><a href="#cb94-12" tabindex="-1"></a>)</span>
<span id="cb94-13"><a href="#cb94-13" tabindex="-1"></a>items <span class="op">=</span> search.item_collection()</span>
<span id="cb94-14"><a href="#cb94-14" tabindex="-1"></a></span>
<span id="cb94-15"><a href="#cb94-15" tabindex="-1"></a><span class="co"># Load to XArray</span></span>
<span id="cb94-16"><a href="#cb94-16" tabindex="-1"></a>ds <span class="op">=</span> stac.load(</span>
<span id="cb94-17"><a href="#cb94-17" tabindex="-1"></a>    items,</span>
<span id="cb94-18"><a href="#cb94-18" tabindex="-1"></a>    bands<span class="op">=</span>[<span class="st">&#39;red&#39;</span>, <span class="st">&#39;green&#39;</span>, <span class="st">&#39;blue&#39;</span>, <span class="st">&#39;nir&#39;</span>, <span class="st">&#39;scl&#39;</span>],</span>
<span id="cb94-19"><a href="#cb94-19" tabindex="-1"></a>    bbox<span class="op">=</span>bbox, <span class="co"># &lt;-- load data only for the bbox</span></span>
<span id="cb94-20"><a href="#cb94-20" tabindex="-1"></a>    resolution<span class="op">=</span><span class="dv">10</span>,</span>
<span id="cb94-21"><a href="#cb94-21" tabindex="-1"></a>    chunks<span class="op">=</span>{},  <span class="co"># &lt;-- use Dask</span></span>
<span id="cb94-22"><a href="#cb94-22" tabindex="-1"></a>    groupby<span class="op">=</span><span class="st">&#39;solar_day&#39;</span>,</span>
<span id="cb94-23"><a href="#cb94-23" tabindex="-1"></a>    preserve_original_order<span class="op">=</span><span class="va">True</span></span>
<span id="cb94-24"><a href="#cb94-24" tabindex="-1"></a>)</span>
<span id="cb94-25"><a href="#cb94-25" tabindex="-1"></a>ds</span></code></pre></div>
</div>
<div id="processing-data" class="section level2">
<h2>Processing Data</h2>
<p>We have a data cube of multiple scenes collected through the year. As
XArray supports vectorized operations, we can work with the entire
DataSet the same way we would process a single scene.</p>
<p>The Sentinel-2 scenes come with NoData value of 0. So we set the
correct NoData value before further processing.</p>
<div class="sourceCode" id="cb95"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb95-1"><a href="#cb95-1" tabindex="-1"></a><span class="co"># Mask nodata values</span></span>
<span id="cb95-2"><a href="#cb95-2" tabindex="-1"></a>ds <span class="op">=</span> ds.where(ds <span class="op">!=</span> <span class="dv">0</span>)</span></code></pre></div>
<p>Apply scale and offset to all spectral bands</p>
<div class="sourceCode" id="cb96"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb96-1"><a href="#cb96-1" tabindex="-1"></a><span class="co"># Apply scale/offset</span></span>
<span id="cb96-2"><a href="#cb96-2" tabindex="-1"></a>scale <span class="op">=</span> <span class="fl">0.0001</span></span>
<span id="cb96-3"><a href="#cb96-3" tabindex="-1"></a>offset <span class="op">=</span> <span class="op">-</span><span class="fl">0.1</span></span>
<span id="cb96-4"><a href="#cb96-4" tabindex="-1"></a><span class="co"># Select spectral bands (all except &#39;scl&#39;)</span></span>
<span id="cb96-5"><a href="#cb96-5" tabindex="-1"></a>data_bands <span class="op">=</span> [band <span class="cf">for</span> band <span class="kw">in</span> ds.data_vars <span class="cf">if</span> band <span class="op">!=</span> <span class="st">&#39;scl&#39;</span>]</span>
<span id="cb96-6"><a href="#cb96-6" tabindex="-1"></a><span class="cf">for</span> band <span class="kw">in</span> data_bands:</span>
<span id="cb96-7"><a href="#cb96-7" tabindex="-1"></a>  ds[band] <span class="op">=</span> ds[band] <span class="op">*</span> scale <span class="op">+</span> offset</span></code></pre></div>
<p>Apply the cloud mask</p>
<div class="sourceCode" id="cb97"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb97-1"><a href="#cb97-1" tabindex="-1"></a>ds <span class="op">=</span> ds[data_bands].where(<span class="op">~</span>ds.scl.isin([<span class="dv">3</span>,<span class="dv">8</span>,<span class="dv">9</span>,<span class="dv">10</span>]))</span>
<span id="cb97-2"><a href="#cb97-2" tabindex="-1"></a>ds</span></code></pre></div>
<p>Calculate NDVI and add it as a data variable.</p>
<div class="sourceCode" id="cb98"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb98-1"><a href="#cb98-1" tabindex="-1"></a>red <span class="op">=</span> ds[<span class="st">&#39;red&#39;</span>]</span>
<span id="cb98-2"><a href="#cb98-2" tabindex="-1"></a>nir <span class="op">=</span> ds[<span class="st">&#39;nir&#39;</span>]</span>
<span id="cb98-3"><a href="#cb98-3" tabindex="-1"></a></span>
<span id="cb98-4"><a href="#cb98-4" tabindex="-1"></a>ndvi <span class="op">=</span> (nir <span class="op">-</span> red)<span class="op">/</span>(nir <span class="op">+</span> red)</span>
<span id="cb98-5"><a href="#cb98-5" tabindex="-1"></a>ds[<span class="st">&#39;ndvi&#39;</span>] <span class="op">=</span> ndvi</span>
<span id="cb98-6"><a href="#cb98-6" tabindex="-1"></a>ds</span></code></pre></div>
</div>
<div id="extracting-time-series-1" class="section level2">
<h2>Extracting Time-Series</h2>
<p>We have a dataset with cloud-masked NDVI values at each pixel of each
scene. Remember that none of these values are computed yet. Dask has a
graph of all the operations that would be required to calculate the
results.</p>
<p>We can now query this results for values at our chosen location. Once
we run <code>compute()</code> - Dask will fetch the required tiles from
the source data and run the operations to give us the results.</p>
<p>Our location coordinates are in EPSG:4326 Lat/Lon. Convert it to the
CRS of the dataset so we can query it.</p>
<div class="sourceCode" id="cb99"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb99-1"><a href="#cb99-1" tabindex="-1"></a>crs <span class="op">=</span> ds.rio.crs</span>
<span id="cb99-2"><a href="#cb99-2" tabindex="-1"></a>transformer <span class="op">=</span> pyproj.Transformer.from_crs(<span class="st">&#39;EPSG:4326&#39;</span>, crs, always_xy<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb99-3"><a href="#cb99-3" tabindex="-1"></a>x, y <span class="op">=</span> transformer.transform(longitude, latitude)</span>
<span id="cb99-4"><a href="#cb99-4" tabindex="-1"></a>x,y</span></code></pre></div>
<p>Query NDVI values at the coordinates.</p>
<div class="sourceCode" id="cb100"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb100-1"><a href="#cb100-1" tabindex="-1"></a>time_series <span class="op">=</span> ds.ndvi <span class="op">\</span></span>
<span id="cb100-2"><a href="#cb100-2" tabindex="-1"></a>  .interp(y<span class="op">=</span>y, x<span class="op">=</span>x, method<span class="op">=</span><span class="st">&#39;nearest&#39;</span>)</span></code></pre></div>
<p>Run the calculation and load the results into memory.</p>
<div class="sourceCode" id="cb101"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb101-1"><a href="#cb101-1" tabindex="-1"></a><span class="op">%%</span>time</span>
<span id="cb101-2"><a href="#cb101-2" tabindex="-1"></a>time_series <span class="op">=</span> time_series.compute()</span></code></pre></div>
<p>Plot the time-series.</p>
<div class="sourceCode" id="cb102"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb102-1"><a href="#cb102-1" tabindex="-1"></a><span class="im">import</span> matplotlib.dates <span class="im">as</span> mdates</span>
<span id="cb102-2"><a href="#cb102-2" tabindex="-1"></a></span>
<span id="cb102-3"><a href="#cb102-3" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb102-4"><a href="#cb102-4" tabindex="-1"></a>fig.set_size_inches(<span class="dv">15</span>, <span class="dv">7</span>)</span>
<span id="cb102-5"><a href="#cb102-5" tabindex="-1"></a></span>
<span id="cb102-6"><a href="#cb102-6" tabindex="-1"></a>time_series.plot.line(</span>
<span id="cb102-7"><a href="#cb102-7" tabindex="-1"></a>    ax<span class="op">=</span>ax, x<span class="op">=</span><span class="st">&#39;time&#39;</span>,</span>
<span id="cb102-8"><a href="#cb102-8" tabindex="-1"></a>    marker<span class="op">=</span><span class="st">&#39;o&#39;</span>, color<span class="op">=</span><span class="st">&#39;#238b45&#39;</span>,</span>
<span id="cb102-9"><a href="#cb102-9" tabindex="-1"></a>    linestyle<span class="op">=</span><span class="st">&#39;-&#39;</span>, linewidth<span class="op">=</span><span class="dv">1</span>, markersize<span class="op">=</span><span class="dv">4</span>)</span>
<span id="cb102-10"><a href="#cb102-10" tabindex="-1"></a></span>
<span id="cb102-11"><a href="#cb102-11" tabindex="-1"></a><span class="co"># Format the x-axis to display dates as YYYY-MM</span></span>
<span id="cb102-12"><a href="#cb102-12" tabindex="-1"></a>ax.xaxis.set_major_formatter(mdates.DateFormatter(<span class="st">&#39;%Y-%m&#39;</span>))</span>
<span id="cb102-13"><a href="#cb102-13" tabindex="-1"></a>ax.xaxis.set_major_locator(mdates.MonthLocator(interval<span class="op">=</span><span class="dv">2</span>))</span>
<span id="cb102-14"><a href="#cb102-14" tabindex="-1"></a></span>
<span id="cb102-15"><a href="#cb102-15" tabindex="-1"></a>ax.set_title(<span class="st">&#39;NDVI Time-Series&#39;</span>)</span>
<span id="cb102-16"><a href="#cb102-16" tabindex="-1"></a>plt.show()</span></code></pre></div>
<p><img
src="python-remote-sensing-output/05_extracting_time_series_files/05_extracting_time_series_34_0.png" /></p>
</div>
<div id="interpolate-and-smooth-the-time-series" class="section level2">
<h2>Interpolate and Smooth the time-series</h2>
<p>We use XArray’s excellent time-series processing functionality to
smooth the time-series and remove noise.</p>
<div class="sourceCode" id="cb103"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb103-1"><a href="#cb103-1" tabindex="-1"></a><span class="co"># As we are proceesing the time-series,</span></span>
<span id="cb103-2"><a href="#cb103-2" tabindex="-1"></a><span class="co"># it needs to be in a single chunk along the time dimension</span></span>
<span id="cb103-3"><a href="#cb103-3" tabindex="-1"></a>time_series <span class="op">=</span> time_series.chunk(<span class="bu">dict</span>(time<span class="op">=-</span><span class="dv">1</span>))</span></code></pre></div>
<p>First, we resample the time-series to have a value every 5-days and
fill the missing values with linear interpolation. Then we apply a
moving-window smoothing to remove noise.</p>
<div class="sourceCode" id="cb104"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb104-1"><a href="#cb104-1" tabindex="-1"></a>time_series_resampled <span class="op">=</span> time_series<span class="op">\</span></span>
<span id="cb104-2"><a href="#cb104-2" tabindex="-1"></a>  .resample(time<span class="op">=</span><span class="st">&#39;5d&#39;</span>).mean(dim<span class="op">=</span><span class="st">&#39;time&#39;</span>).chunk(<span class="bu">dict</span>(time<span class="op">=-</span><span class="dv">1</span>))</span>
<span id="cb104-3"><a href="#cb104-3" tabindex="-1"></a>time_series_interpolated <span class="op">=</span> time_series_resampled <span class="op">\</span></span>
<span id="cb104-4"><a href="#cb104-4" tabindex="-1"></a>  .interpolate_na(<span class="st">&#39;time&#39;</span>, use_coordinate<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb104-5"><a href="#cb104-5" tabindex="-1"></a>time_series_smoothed <span class="op">=</span> time_series_interpolated <span class="op">\</span></span>
<span id="cb104-6"><a href="#cb104-6" tabindex="-1"></a>  .rolling(time<span class="op">=</span><span class="dv">3</span>, min_periods<span class="op">=</span><span class="dv">1</span>, center<span class="op">=</span><span class="va">True</span>).mean()</span></code></pre></div>
<div class="sourceCode" id="cb105"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb105-1"><a href="#cb105-1" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb105-2"><a href="#cb105-2" tabindex="-1"></a>fig.set_size_inches(<span class="dv">15</span>, <span class="dv">7</span>)</span>
<span id="cb105-3"><a href="#cb105-3" tabindex="-1"></a>time_series.plot.line(</span>
<span id="cb105-4"><a href="#cb105-4" tabindex="-1"></a>    ax<span class="op">=</span>ax, x<span class="op">=</span><span class="st">&#39;time&#39;</span>,</span>
<span id="cb105-5"><a href="#cb105-5" tabindex="-1"></a>    marker<span class="op">=</span><span class="st">&#39;^&#39;</span>, color<span class="op">=</span><span class="st">&#39;#66c2a4&#39;</span>,</span>
<span id="cb105-6"><a href="#cb105-6" tabindex="-1"></a>    linestyle<span class="op">=</span><span class="st">&#39;--&#39;</span>, linewidth<span class="op">=</span><span class="dv">1</span>, markersize<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb105-7"><a href="#cb105-7" tabindex="-1"></a>time_series_smoothed.plot.line(</span>
<span id="cb105-8"><a href="#cb105-8" tabindex="-1"></a>    ax<span class="op">=</span>ax, x<span class="op">=</span><span class="st">&#39;time&#39;</span>,</span>
<span id="cb105-9"><a href="#cb105-9" tabindex="-1"></a>    marker<span class="op">=</span><span class="st">&#39;o&#39;</span>, color<span class="op">=</span><span class="st">&#39;#238b45&#39;</span>,</span>
<span id="cb105-10"><a href="#cb105-10" tabindex="-1"></a>    linestyle<span class="op">=</span><span class="st">&#39;-&#39;</span>, linewidth<span class="op">=</span><span class="dv">1</span>, markersize<span class="op">=</span><span class="dv">4</span>)</span>
<span id="cb105-11"><a href="#cb105-11" tabindex="-1"></a></span>
<span id="cb105-12"><a href="#cb105-12" tabindex="-1"></a><span class="co"># Format the x-axis to display dates as YYYY-MM</span></span>
<span id="cb105-13"><a href="#cb105-13" tabindex="-1"></a>ax.xaxis.set_major_formatter(mdates.DateFormatter(<span class="st">&#39;%Y-%m&#39;</span>))</span>
<span id="cb105-14"><a href="#cb105-14" tabindex="-1"></a>ax.xaxis.set_major_locator(mdates.MonthLocator(interval<span class="op">=</span><span class="dv">2</span>))</span>
<span id="cb105-15"><a href="#cb105-15" tabindex="-1"></a></span>
<span id="cb105-16"><a href="#cb105-16" tabindex="-1"></a>ax.set_title(<span class="st">&#39;Original vs. Smoothed NDVI Time-Series&#39;</span>)</span>
<span id="cb105-17"><a href="#cb105-17" tabindex="-1"></a></span>
<span id="cb105-18"><a href="#cb105-18" tabindex="-1"></a>plt.show()</span></code></pre></div>
<p><img
src="python-remote-sensing-output/05_extracting_time_series_files/05_extracting_time_series_39_0.png" /></p>
</div>
<div id="save-the-time-series." class="section level2">
<h2>Save the Time-Series.</h2>
<p>Convert the extracted time-series to a Pandas DataFrame.</p>
<div class="sourceCode" id="cb106"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb106-1"><a href="#cb106-1" tabindex="-1"></a>df <span class="op">=</span> time_series_smoothed.to_pandas().reset_index()</span>
<span id="cb106-2"><a href="#cb106-2" tabindex="-1"></a>df.head()</span></code></pre></div>
<p>Save the DataFrame as a CSV file.</p>
<div class="sourceCode" id="cb107"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb107-1"><a href="#cb107-1" tabindex="-1"></a>output_filename <span class="op">=</span> <span class="st">&#39;ndvi_time_series.csv&#39;</span></span>
<span id="cb107-2"><a href="#cb107-2" tabindex="-1"></a>output_filepath <span class="op">=</span> os.path.join(output_folder, output_filename)</span>
<span id="cb107-3"><a href="#cb107-3" tabindex="-1"></a>df.to_csv(output_filepath, index<span class="op">=</span><span class="va">False</span>)</span></code></pre></div>
<hr />
</div>
</div>
<div id="license" class="section level1">
<h1>License</h1>
<p>This workshop material is licensed under a <a
href="https://creativecommons.org/licenses/by/4.0/">Creative Commons
Attribution 4.0 International (CC BY 4.0)</a>. You are free to re-use
and adapt the material but are required to give appropriate credit to
the original author as below:</p>
<p><em>Scalable Remote Sensing Workflows with Xarray</em> workshop by
Ujaval Gandhi <a
href="https://spatialthoughts.com">www.spatialthoughts.com</a></p>
<hr />
<p>© 2025 Spatial Thoughts <a
href="https://spatialthoughts.com">www.spatialthoughts.com</a></p>
</div>

<!-- Comment Section Powered by utterances -->
<div id="comments">
  <hr />
  <p>If you want to report any issues with this page, please comment below.</p>
<script src="https://utteranc.es/client.js"
        repo="spatialthoughts/courses"
        issue-term="title"
        label="comment"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>
</div>



</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.odd').parent('tbody').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open');
  });
});
</script>

<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
