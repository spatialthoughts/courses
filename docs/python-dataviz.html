<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />


<meta name="author" content="Ujaval Gandhi" />


<title>Mapping and Data Visualization with Python (Full Course)</title>

<script src="site_libs/header-attrs-2.29/header-attrs.js"></script>
<script src="site_libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/flatly.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<style>h1 {font-size: 34px;}
       h1.title {font-size: 38px;}
       h2 {font-size: 30px;}
       h3 {font-size: 24px;}
       h4 {font-size: 18px;}
       h5 {font-size: 16px;}
       h6 {font-size: 12px;}
       code {color: inherit; background-color: rgba(0, 0, 0, 0.04);}
       pre:not([class]) { background-color: white }</style>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<link href="site_libs/pagedtable-1.1/css/pagedtable.css" rel="stylesheet" />
<script src="site_libs/pagedtable-1.1/js/pagedtable.js"></script>
<style>
.copy-btn {
  position: absolute;
  top: 5px;
  right: 5px;
  padding: 4px 8px;
  font-size: 18px;
  background: #969696;
  color: white;
  border: none;
  border-radius: 3px;
  cursor: pointer;
  opacity: 0.7;
  transition: opacity 0.3s;
}

.copy-btn:hover {
  opacity: 1;
}

.copy-btn.copied {
  background: #636363;
}

pre {
  position: relative;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Find all code blocks
  const codeBlocks = document.querySelectorAll('pre code');
  
  codeBlocks.forEach(function(codeBlock) {
    const pre = codeBlock.parentElement;
    
    // Create copy button
    const button = document.createElement('button');
    button.className = 'copy-btn';
    button.textContent = '⎘';
    
    // Add button to pre element
    pre.appendChild(button);
    
    // Add click event
    button.addEventListener('click', function() {
      // Create temporary textarea to copy text
      const textarea = document.createElement('textarea');
      textarea.value = codeBlock.textContent;
      document.body.appendChild(textarea);
      textarea.select();
      document.execCommand('copy');
      document.body.removeChild(textarea);
      
      // Update button text
      button.textContent = 'Copied!';
      button.classList.add('copied');
      
      // Reset button after 2 seconds
      setTimeout(function() {
        button.textContent = '⎘';
        button.classList.remove('copied');
      }, 2000);
    });
  });
});
</script>

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>



<style type="text/css">
  code {
    white-space: pre;
  }
  .sourceCode {
    overflow: visible;
  }
</style>
<style type="text/css" data-origin="pandoc">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */

</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    var j = 0;
    while (j < rules.length) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") {
        j++;
        continue;
      }
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') {
        j++;
        continue;
      }
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>







<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
details > summary > p:only-child {
  display: inline;
}
pre code {
  padding: 0;
}
</style>


<style type="text/css">
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #adb5bd;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script type="text/javascript">
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark the anchor link active (and if it's in a dropdown, also mark that active)
  var dropdown = menuAnchor.closest('li.dropdown');
  if (window.bootstrap) { // Bootstrap 4+
    menuAnchor.addClass('active');
    dropdown.find('> .dropdown-toggle').addClass('active');
  } else { // Bootstrap 3
    menuAnchor.parent().addClass('active');
    dropdown.addClass('active');
  }

  // Navbar adjustments
  var navHeight = $(".navbar").first().height() + 15;
  var style = document.createElement('style');
  var pt = "padding-top: " + navHeight + "px; ";
  var mt = "margin-top: -" + navHeight + "px; ";
  var css = "";
  // offset scroll position for anchor links (for fixed navbar)
  for (var i = 1; i <= 6; i++) {
    css += ".section h" + i + "{ " + pt + mt + "}\n";
  }
  style.innerHTML = "body {" + pt + "padding-bottom: 40px; }\n" + css;
  document.head.appendChild(style);
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before, .tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "\e259";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "\e258";
  font-family: 'Glyphicons Halflings';
  border: none;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->




</head>

<body>


<div class="container-fluid main-container">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-bs-toggle="collapse" data-target="#navbar" data-bs-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">Courses</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="http://spatialthoughts.com">Back to Main Site</a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li>
  <a href="#">Back to Top</a>
</li>
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div id="header">



<h1 class="title toc-ignore">Mapping and Data Visualization with Python
(Full Course)</h1>
<h3 class="subtitle">A comprehensive guide for creating static and
dynamic visualizations with spatial data.</h3>
<h4 class="author">Ujaval Gandhi</h4>

</div>

<div id="TOC">
<ul>
<li><a href="#introduction" id="toc-introduction">Introduction</a></li>
<li><a href="#get-the-course-videos" id="toc-get-the-course-videos">Get
the Course Videos</a>
<ul>
<li><a href="#youtube" id="toc-youtube">YouTube</a></li>
<li><a href="#vimeo" id="toc-vimeo">Vimeo</a></li>
</ul></li>
<li><a href="#notebooks-and-datasets"
id="toc-notebooks-and-datasets">Notebooks and Datasets</a></li>
<li><a href="#hello-colab" id="toc-hello-colab">Hello Colab</a>
<ul>
<li><a href="#package-management" id="toc-package-management">Package
Management</a></li>
<li><a href="#data-management" id="toc-data-management">Data
Management</a></li>
</ul></li>
<li><a href="#matplotlib-basics" id="toc-matplotlib-basics">Matplotlib
Basics</a>
<ul>
<li><a href="#setup" id="toc-setup">Setup</a></li>
<li><a href="#concepts" id="toc-concepts">Concepts</a></li>
<li><a href="#exercise" id="toc-exercise">Exercise</a></li>
</ul></li>
<li><a href="#creating-charts" id="toc-creating-charts">Creating
Charts</a>
<ul>
<li><a href="#overview" id="toc-overview">Overview</a></li>
<li><a href="#setup-and-data-download"
id="toc-setup-and-data-download">Setup and Data Download</a></li>
<li><a href="#create-a-pie-chart" id="toc-create-a-pie-chart">Create a
Pie-Chart</a></li>
<li><a href="#create-a-bar-chart" id="toc-create-a-bar-chart">Create a
Bar Chart</a></li>
<li><a href="#exercise-1" id="toc-exercise-1">Exercise</a></li>
</ul></li>
<li><a href="#creating-maps" id="toc-creating-maps">Creating Maps</a>
<ul>
<li><a href="#overview-1" id="toc-overview-1">Overview</a></li>
<li><a href="#setup-and-data-download-1"
id="toc-setup-and-data-download-1">Setup and Data Download</a></li>
<li><a href="#data-pre-processing" id="toc-data-pre-processing">Data
Pre-Processing</a></li>
<li><a href="#create-a-choropleth-map"
id="toc-create-a-choropleth-map">Create a Choropleth Map</a></li>
<li><a href="#exercise-2" id="toc-exercise-2">Exercise</a></li>
</ul></li>
<li><a href="#using-basemaps" id="toc-using-basemaps">Using Basemaps</a>
<ul>
<li><a href="#overview-2" id="toc-overview-2">Overview</a></li>
<li><a href="#setup-and-data-download-2"
id="toc-setup-and-data-download-2">Setup and Data Download</a></li>
<li><a href="#data-pre-processing-1" id="toc-data-pre-processing-1">Data
Pre-Processing</a></li>
<li><a href="#create-a-multi-layer-map"
id="toc-create-a-multi-layer-map">Create a Multi-Layer Map</a></li>
<li><a href="#add-a-basemap" id="toc-add-a-basemap">Add A
BaseMap</a></li>
<li><a href="#exercise-3" id="toc-exercise-3">Exercise</a></li>
</ul></li>
<li><a href="#xarray-basics" id="toc-xarray-basics">XArray Basics</a>
<ul>
<li><a href="#overview-3" id="toc-overview-3">Overview</a></li>
<li><a href="#setup-and-data-download-3"
id="toc-setup-and-data-download-3">Setup and Data Download</a></li>
<li><a href="#get-satellite-imagery-using-stac-api"
id="toc-get-satellite-imagery-using-stac-api">Get Satellite Imagery
using STAC API</a></li>
<li><a href="#xarray-terminology" id="toc-xarray-terminology">XArray
Terminology</a></li>
<li><a href="#selecting-data" id="toc-selecting-data">Selecting
Data</a></li>
<li><a href="#aggregating-data" id="toc-aggregating-data">Aggregating
Data</a></li>
<li><a href="#visualizing-data" id="toc-visualizing-data">Visualizing
Data</a></li>
<li><a href="#exercise-4" id="toc-exercise-4">Exercise</a></li>
</ul></li>
<li><a href="#mapping-gridded-datasets"
id="toc-mapping-gridded-datasets">Mapping Gridded Datasets</a>
<ul>
<li><a href="#overview-4" id="toc-overview-4">Overview</a></li>
<li><a href="#setup-and-data-download-4"
id="toc-setup-and-data-download-4">Setup and Data Download</a></li>
<li><a href="#data-pre-processing-2" id="toc-data-pre-processing-2">Data
Pre-Processing</a></li>
<li><a href="#plotting-using-matplotlib"
id="toc-plotting-using-matplotlib">Plotting using Matplotlib</a></li>
<li><a href="#plotting-using-cartopy"
id="toc-plotting-using-cartopy">Plotting using CartoPy</a></li>
<li><a href="#exercise-5" id="toc-exercise-5">Exercise</a></li>
</ul></li>
<li><a href="#visualizing-rasters"
id="toc-visualizing-rasters">Visualizing Rasters</a>
<ul>
<li><a href="#overview-5" id="toc-overview-5">Overview</a></li>
<li><a href="#setup-and-data-download-5"
id="toc-setup-and-data-download-5">Setup and Data Download</a></li>
<li><a href="#rioxarray-basics" id="toc-rioxarray-basics">Rioxarray
Basics</a></li>
<li><a href="#plotting-multiple-rasters"
id="toc-plotting-multiple-rasters">Plotting Multiple Rasters</a></li>
<li><a href="#merging-rasters" id="toc-merging-rasters">Merging
Rasters</a></li>
<li><a href="#annotating-plots" id="toc-annotating-plots">Annotating
Plots</a></li>
<li><a href="#exercise-6" id="toc-exercise-6">Exercise</a></li>
</ul></li>
<li><a href="#assignment" id="toc-assignment">Assignment</a>
<ul>
<li><a href="#overview-6" id="toc-overview-6">Overview</a></li>
<li><a href="#setup-and-data-download-6"
id="toc-setup-and-data-download-6">Setup and Data Download</a></li>
<li><a href="#data-pre-processing-3" id="toc-data-pre-processing-3">Data
Pre-Processing</a></li>
</ul></li>
<li><a href="#interactive-maps-with-folium"
id="toc-interactive-maps-with-folium">Interactive Maps with Folium</a>
<ul>
<li><a href="#overview-7" id="toc-overview-7">Overview</a></li>
<li><a href="#setup-1" id="toc-setup-1">Setup</a></li>
<li><a href="#folium-basics" id="toc-folium-basics">Folium
Basics</a></li>
<li><a href="#exercise-7" id="toc-exercise-7">Exercise</a></li>
</ul></li>
<li><a href="#multi-layer-interactive-maps"
id="toc-multi-layer-interactive-maps">Multi-layer Interactive Maps</a>
<ul>
<li><a href="#overview-8" id="toc-overview-8">Overview</a></li>
<li><a href="#setup-and-data-download-7"
id="toc-setup-and-data-download-7">Setup and Data Download</a></li>
<li><a href="#using-geopandas-explore"
id="toc-using-geopandas-explore">Using GeoPandas explore()</a></li>
<li><a href="#create-multi-layer-maps"
id="toc-create-multi-layer-maps">Create Multi-layer Maps</a></li>
<li><a href="#exercise-8" id="toc-exercise-8">Exercise</a></li>
</ul></li>
<li><a href="#leafmap-basics" id="toc-leafmap-basics">Leafmap Basics</a>
<ul>
<li><a href="#overview-9" id="toc-overview-9">Overview</a></li>
<li><a href="#setup-and-data-download-8"
id="toc-setup-and-data-download-8">Setup and Data Download</a></li>
<li><a href="#creating-a-map" id="toc-creating-a-map">Creating a
Map</a></li>
<li><a href="#adding-data-layers" id="toc-adding-data-layers">Adding
Data Layers</a></li>
<li><a href="#exercise-9" id="toc-exercise-9">Exercise</a></li>
</ul></li>
<li><a href="#streamlit-basics" id="toc-streamlit-basics">Streamlit
Basics</a>
<ul>
<li><a href="#installation-and-setting-up-the-environment"
id="toc-installation-and-setting-up-the-environment">Installation and
Setting up the Environment</a></li>
<li><a href="#create-a-simple-dashboard"
id="toc-create-a-simple-dashboard">Create a Simple Dashboard</a></li>
<li><a href="#exercise-10" id="toc-exercise-10">Exercise</a></li>
<li><a href="#create-a-simple-geocoder-app"
id="toc-create-a-simple-geocoder-app">Create a Simple Geocoder
App</a></li>
<li><a href="#exercise-11" id="toc-exercise-11">Exercise</a></li>
</ul></li>
<li><a href="#building-mapping-apps-with-leafmap-and-streamlit"
id="toc-building-mapping-apps-with-leafmap-and-streamlit">Building
Mapping Apps with Leafmap and Streamlit</a>
<ul>
<li><a href="#create-a-mapping-dashboard"
id="toc-create-a-mapping-dashboard">Create a Mapping Dashboard</a></li>
</ul></li>
<li><a href="#publishing-apps-with-streamlit-cloud"
id="toc-publishing-apps-with-streamlit-cloud">Publishing Apps with
Streamlit Cloud</a>
<ul>
<li><a href="#upload-the-app-to-github"
id="toc-upload-the-app-to-github">Upload the app to GitHub</a></li>
<li><a href="#add-app-dependencies" id="toc-add-app-dependencies">Add
App dependencies</a></li>
<li><a href="#replace-sensitive-data-with-secrets"
id="toc-replace-sensitive-data-with-secrets">Replace Sensitive Data with
Secrets</a></li>
<li><a href="#deploy-your-app" id="toc-deploy-your-app">Deploy your
App</a></li>
</ul></li>
<li><a href="#supplement" id="toc-supplement">Supplement</a>
<ul>
<li><a href="#folium" id="toc-folium">Folium</a>
<ul>
<li><a href="#displaying-text-on-folium-maps"
id="toc-displaying-text-on-folium-maps">Displaying Text on Folium
Maps</a></li>
</ul></li>
<li><a href="#contextily" id="toc-contextily">Contextily</a>
<ul>
<li><a href="#creating-an-artistic-rendering-of-a-city"
id="toc-creating-an-artistic-rendering-of-a-city">Creating an Artistic
Rendering of a City</a></li>
</ul></li>
<li><a href="#advanced-plotting" id="toc-advanced-plotting">Advanced
Plotting</a>
<ul>
<li><a href="#using-matplotlib-themes-and-custom-fonts"
id="toc-using-matplotlib-themes-and-custom-fonts">Using Matplotlib
Themes and Custom Fonts</a></li>
<li><a href="#creating-a-stacked-bar-chart"
id="toc-creating-a-stacked-bar-chart">Creating A Stacked Bar
Chart</a></li>
<li><a href="#elevation-profile-plot-from-a-gps-track"
id="toc-elevation-profile-plot-from-a-gps-track">Elevation Profile Plot
from a GPS Track</a></li>
<li><a href="#creating-a-globe-visualization"
id="toc-creating-a-globe-visualization">Creating a Globe
Visualization</a></li>
<li><a href="#visualizing-monthly-composites"
id="toc-visualizing-monthly-composites">Visualizing Monthly
Composites</a></li>
<li><a href="#creating-maps-with-cartographic-elements"
id="toc-creating-maps-with-cartographic-elements">Creating Maps with
Cartographic Elements</a></li>
<li><a href="#labeling-features" id="toc-labeling-features">Labeling
Features</a></li>
<li><a href="#creating-time-series-charts"
id="toc-creating-time-series-charts">Creating Time-Series
Charts</a></li>
<li><a href="#feature-correlation-matrix"
id="toc-feature-correlation-matrix">Feature Correlation Matrix</a></li>
<li><a href="#matplotlib-anatomy" id="toc-matplotlib-anatomy">Matplotlib
Anatomy</a></li>
</ul></li>
<li><a href="#animation" id="toc-animation">Animation</a>
<ul>
<li><a href="#creating-animated-maps"
id="toc-creating-animated-maps">Creating Animated Maps</a></li>
</ul></li>
<li><a href="#leafmap" id="toc-leafmap">Leafmap</a>
<ul>
<li><a href="#downloading-and-visualizing-osm-data-with-leafmap"
id="toc-downloading-and-visualizing-osm-data-with-leafmap">Downloading
and Visualizing OSM Data with LeafMap</a></li>
<li><a href="#visualizing-large-vector-datasets-with-lonboard"
id="toc-visualizing-large-vector-datasets-with-lonboard">Visualizing
Large Vector Datasets with Lonboard</a></li>
</ul></li>
<li><a href="#streamlit" id="toc-streamlit">Streamlit</a>
<ul>
<li><a href="#interactive-mapping-dashboard"
id="toc-interactive-mapping-dashboard">Interactive Mapping
Dashboard</a></li>
<li><a href="#bouding-box-app" id="toc-bouding-box-app">Bouding Box
App</a></li>
</ul></li>
</ul></li>
<li><a href="#resources" id="toc-resources">Resources</a></li>
<li><a href="#data-credits" id="toc-data-credits">Data Credits</a></li>
<li><a href="#license" id="toc-license">License</a></li>
</ul>
</div>

<div style="page-break-after: always;"></div>
<hr />
<p><img src="images/spatial_thoughts_logo.png" width="250pt" style="display: block; margin: auto;" /></p>
<hr />
<div style="page-break-after: always;"></div>
<div id="introduction" class="section level1">
<h1>Introduction</h1>
<p>This is an intermediate-level course that teaches you how to use
Python for creating charts, plots, animations, and maps.</p>
<p><a
href="https://www.youtube.com/watch?v=E8v9aLebKyY&amp;list=PLppGmFLhQ1HLzGl8auwYkdUMu_z0Hz7G6"
target="_blank"><img
src="https://img.youtube.com/vi/E8v9aLebKyY/mqdefault.jpg"
alt="Watch the video" /></a></p>
<p><a
href="https://www.youtube.com/watch?v=E8v9aLebKyY&amp;list=PLppGmFLhQ1HLzGl8auwYkdUMu_z0Hz7G6"
target="_blank">Watch the Video ↗</a></p>
<p><a
href="https://docs.google.com/presentation/d/1Mc8O7zXJt-0LwUocPjpfjvkqYj-0qRnUMUIFpftVZFw/edit?usp=sharing"
target="_blank">Access the Presentation ↗</a></p>
</div>
<div id="get-the-course-videos" class="section level1">
<h1>Get the Course Videos</h1>
<p>The course is accompanied by a set of videos covering the all the
modules. These videos are recorded from our live instructor-led classes
and are edited to make them easier to consume for self-study. We have 2
versions of the videos:</p>
<div id="youtube" class="section level3">
<h3>YouTube</h3>
<p>We have created a YouTube Playlist with separate videos for each
notebook and exercise to enable effective online-learning. <a
href="https://www.youtube.com/watch?v=E8v9aLebKyY&amp;list=PLppGmFLhQ1HLzGl8auwYkdUMu_z0Hz7G6"
target="_blank">Access the YouTube Playlist ↗</a></p>
</div>
<div id="vimeo" class="section level3">
<h3>Vimeo</h3>
<p>We are also making combined full-length video for each module
available on Vimeo. These videos can be downloaded for offline learning.
<a href="https://vimeo.com/showcase/11442350?share=copy"
target="_blank">Access the Vimeo Playlist ↗</a></p>
</div>
</div>
<div id="notebooks-and-datasets" class="section level1">
<h1>Notebooks and Datasets</h1>
<p>This course uses Google Colab for all exercises. You do not need to
install any packages or download any datasets.</p>
<p>The notebooks can be accessed by clicking on the <img
src="https://colab.research.google.com/assets/colab-badge.svg"
alt="Open In Colab" /> buttons at the beginning of each section. Once
you have opened the notebook in Colab, you can copy it to your own
account by going to <em>File → Save a Copy in Drive</em>.</p>
<p><img src="images/python_dataviz/colab1.png" width="75%" style="display: block; margin: auto;" /></p>
<p>Once the notebooks are saved to your drive, you will be able to
modify the code and save the updated copy. You can also click the
<em>Share</em> button and share a link to the notebook with others.</p>
<p><img src="images/python_dataviz/colab2.png" width="75%" style="display: block; margin: auto;" /></p>
<div style="page-break-after: always;"></div>
</div>
<div id="hello-colab" class="section level1">
<h1>Hello Colab</h1>
<p><a
href="https://colab.research.google.com/github/spatialthoughts/python-dataviz-web/blob/main/00_hello_colab.ipynb"><img
src="https://colab.research.google.com/assets/colab-badge.svg"
alt="Open In Colab" /></a></p>
<p><a href="https://colab.research.google.com/">Google Colab</a> is a
hosted Jupyter notebook environment that allows anyone to run Python
code via a web-browser. It provides you free computation and data
storage that can be utilized by your Python code.</p>
<p>You can click the <code>+Code</code> button to create a new cell and
enter a block of code. To run the code, click the <strong>Run
Code</strong> button next to the cell, or press <code>Shirt+Enter</code>
key.</p>
<div class="sourceCode" id="cb1"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&#39;Hello World&#39;</span>)</span></code></pre></div>
<div id="package-management" class="section level3">
<h3>Package Management</h3>
<p>Colab comes pre-installed with many Python packages. You can use a
package by simply importing it.</p>
<div class="sourceCode" id="cb2"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb2-2"><a href="#cb2-2" tabindex="-1"></a><span class="im">import</span> geopandas <span class="im">as</span> gpd</span></code></pre></div>
<p>Each Colab notebook instance is run on a Ubuntu Linux machine in the
cloud. If you want to install any packages, you can run a command by
prefixing the command with a <code>!</code>. For example, you can
install third-party packages via <code>pip</code> using the command
<code>!pip</code>.</p>
<blockquote>
<p>Tip: If you want to list all pre-install packages and their versions
in your Colab environemnt, you can run <code>!pip list -v</code>.</p>
</blockquote>
<div class="sourceCode" id="cb3"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a><span class="op">!</span>pip install rioxarray</span></code></pre></div>
<div class="sourceCode" id="cb4"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a><span class="im">import</span> rioxarray</span></code></pre></div>
</div>
<div id="data-management" class="section level3">
<h3>Data Management</h3>
<p>Colab provides 100GB of disk space along with your notebook. This can
be used to store your data, intermediate outputs and results.</p>
<p>The code below will create 2 folders named ‘data’ and ‘output’ in
your local filesystem.</p>
<div class="sourceCode" id="cb5"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb5-2"><a href="#cb5-2" tabindex="-1"></a></span>
<span id="cb5-3"><a href="#cb5-3" tabindex="-1"></a>data_folder <span class="op">=</span> <span class="st">&#39;data&#39;</span></span>
<span id="cb5-4"><a href="#cb5-4" tabindex="-1"></a>output_folder <span class="op">=</span> <span class="st">&#39;output&#39;</span></span>
<span id="cb5-5"><a href="#cb5-5" tabindex="-1"></a></span>
<span id="cb5-6"><a href="#cb5-6" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> os.path.exists(data_folder):</span>
<span id="cb5-7"><a href="#cb5-7" tabindex="-1"></a>    os.mkdir(data_folder)</span>
<span id="cb5-8"><a href="#cb5-8" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> os.path.exists(output_folder):</span>
<span id="cb5-9"><a href="#cb5-9" tabindex="-1"></a>    os.mkdir(output_folder)</span></code></pre></div>
<p>We can download some data from the internet and store it in the Colab
environment. Below is a helper function to download a file from a
URL.</p>
<div class="sourceCode" id="cb6"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a><span class="im">import</span> requests</span>
<span id="cb6-2"><a href="#cb6-2" tabindex="-1"></a></span>
<span id="cb6-3"><a href="#cb6-3" tabindex="-1"></a><span class="kw">def</span> download(url):</span>
<span id="cb6-4"><a href="#cb6-4" tabindex="-1"></a>    filename <span class="op">=</span> os.path.join(data_folder, os.path.basename(url))</span>
<span id="cb6-5"><a href="#cb6-5" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> os.path.exists(filename):</span>
<span id="cb6-6"><a href="#cb6-6" tabindex="-1"></a>      <span class="cf">with</span> requests.get(url, stream<span class="op">=</span><span class="va">True</span>, allow_redirects<span class="op">=</span><span class="va">True</span>) <span class="im">as</span> r:</span>
<span id="cb6-7"><a href="#cb6-7" tabindex="-1"></a>          <span class="cf">with</span> <span class="bu">open</span>(filename, <span class="st">&#39;wb&#39;</span>) <span class="im">as</span> f:</span>
<span id="cb6-8"><a href="#cb6-8" tabindex="-1"></a>              <span class="cf">for</span> chunk <span class="kw">in</span> r.iter_content(chunk_size<span class="op">=</span><span class="dv">8192</span>):</span>
<span id="cb6-9"><a href="#cb6-9" tabindex="-1"></a>                  f.write(chunk)</span>
<span id="cb6-10"><a href="#cb6-10" tabindex="-1"></a>      <span class="bu">print</span>(<span class="st">&#39;Downloaded&#39;</span>, filename)</span></code></pre></div>
<p>Let’s download the <a
href="https://www.naturalearthdata.com/downloads/10m-cultural-vectors/">Populated
Places</a> dataset from Natural Earth.</p>
<div class="sourceCode" id="cb7"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a>download(<span class="st">&#39;https://naciscdn.org/naturalearth/10m/cultural/&#39;</span> <span class="op">+</span></span>
<span id="cb7-2"><a href="#cb7-2" tabindex="-1"></a>         <span class="st">&#39;ne_10m_populated_places_simple.zip&#39;</span>)</span></code></pre></div>
<p>The file is now in our local filesystem. We can construct the path to
the data folder and read it using <code>geopandas</code></p>
<div class="sourceCode" id="cb8"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a><span class="bu">file</span> <span class="op">=</span> <span class="st">&#39;ne_10m_populated_places_simple.zip&#39;</span></span>
<span id="cb8-2"><a href="#cb8-2" tabindex="-1"></a>filepath <span class="op">=</span> os.path.join(data_folder, <span class="bu">file</span>)</span>
<span id="cb8-3"><a href="#cb8-3" tabindex="-1"></a>places <span class="op">=</span> gpd.read_file(filepath)</span></code></pre></div>
<p>Let’s do some data processing and write the results to a new file.
The code below will filter all places which are also country
capitals.</p>
<div class="sourceCode" id="cb9"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a>capitals <span class="op">=</span> places[places[<span class="st">&#39;adm0cap&#39;</span>] <span class="op">==</span> <span class="dv">1</span>]</span>
<span id="cb9-2"><a href="#cb9-2" tabindex="-1"></a>capitals</span></code></pre></div>
<p>We can write the results to the disk as a GeoPackage file.</p>
<div class="sourceCode" id="cb10"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" tabindex="-1"></a>output_file <span class="op">=</span> <span class="st">&#39;capitals.gpkg&#39;</span></span>
<span id="cb10-2"><a href="#cb10-2" tabindex="-1"></a>output_path <span class="op">=</span> os.path.join(output_folder, output_file)</span>
<span id="cb10-3"><a href="#cb10-3" tabindex="-1"></a>capitals.to_file(driver<span class="op">=</span><span class="st">&#39;GPKG&#39;</span>, filename<span class="op">=</span>output_path)</span></code></pre></div>
<p>You can open the <strong>Files</strong> tab from the left-hand panel
in Colab and browse to the <code>output</code> folder. Locate the
<code>capitals.gpkg</code> file and click the <strong>⋮</strong> button
and select <em>Download</em> to download the file locally.</p>
<hr />
</div>
</div>
<div id="matplotlib-basics" class="section level1">
<h1>Matplotlib Basics</h1>
<p><a
href="https://www.youtube.com/watch?v=IlVFJ3MUllQ&amp;list=PLppGmFLhQ1HLzGl8auwYkdUMu_z0Hz7G6&amp;index=3"
target="_blank"><img
src="https://img.youtube.com/vi/IlVFJ3MUllQ/mqdefault.jpg"
alt="Watch the Video" /></a></p>
<p><a
href="https://www.youtube.com/watch?v=IlVFJ3MUllQ&amp;list=PLppGmFLhQ1HLzGl8auwYkdUMu_z0Hz7G6&amp;index=3"
target="_blank">Watch the Video ↗</a></p>
<p><a
href="https://docs.google.com/presentation/d/1KjHC137pQQkl8Fs9Pj6T7wzBn-Mrj04vfRJ8bp-wLzE/edit?usp=sharing"
target="_blank">View the Presentation ↗</a></p>
<p><a
href="https://colab.research.google.com/github/spatialthoughts/python-dataviz-web/blob/main/01_matplotlib_basics.ipynb"><img
src="https://colab.research.google.com/assets/colab-badge.svg"
alt="Open In Colab" /></a></p>
<p>This notebook introduces the <a
href="https://matplotlib.org/">Matplotlib</a> library. This is one of
the core Python packages for data visualization and is used by many
spatial and non-spatial packages to create charts and maps.</p>
<div id="setup" class="section level2">
<h2>Setup</h2>
<p>Most of the Matplotlib functionality is available in the
<code>pyplot</code> submodule, and by convention is imported as
<code>plt</code></p>
<div class="sourceCode" id="cb11"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb11-2"><a href="#cb11-2" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span></code></pre></div>
<div class="sourceCode" id="cb12"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" tabindex="-1"></a>data_folder <span class="op">=</span> <span class="st">&#39;data&#39;</span></span>
<span id="cb12-2"><a href="#cb12-2" tabindex="-1"></a>output_folder <span class="op">=</span> <span class="st">&#39;output&#39;</span></span>
<span id="cb12-3"><a href="#cb12-3" tabindex="-1"></a></span>
<span id="cb12-4"><a href="#cb12-4" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> os.path.exists(data_folder):</span>
<span id="cb12-5"><a href="#cb12-5" tabindex="-1"></a>    os.mkdir(data_folder)</span>
<span id="cb12-6"><a href="#cb12-6" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> os.path.exists(output_folder):</span>
<span id="cb12-7"><a href="#cb12-7" tabindex="-1"></a>    os.mkdir(output_folder)</span></code></pre></div>
</div>
<div id="concepts" class="section level2">
<h2>Concepts</h2>
<p>It is important to understand the 2 matplotlib objects</p>
<ul>
<li>Figure: This is the main container of the plot. A figure can contain
multiple plots inside it</li>
<li>Axes: Axes refers to an individual plot or graph. A figure contains
1 or more axes.</li>
</ul>
<p><img src='https://courses.spatialthoughts.com/images/python_dataviz/matplotlib_terminology.png' width=800/></p>
<p>We create a figure and a single subplot. Specifying 1 row and 1
column for the <code>subplots()</code> function create a figure and an
axes within it. Even if we have a single plot in the figure, it is
useful to use this logic of intialization so it is consistent across
different scripts.</p>
<div class="sourceCode" id="cb13"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb13-2"><a href="#cb13-2" tabindex="-1"></a>fig.set_size_inches(<span class="dv">5</span>,<span class="dv">5</span>)</span>
<span id="cb13-3"><a href="#cb13-3" tabindex="-1"></a>plt.show()</span></code></pre></div>
<p>First, let’s learn how to plot a single point using matplotlib. Let’s
say we want to display a point at the coordinate (0.5, 0.5).</p>
<div class="sourceCode" id="cb14"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" tabindex="-1"></a>point <span class="op">=</span> (<span class="fl">0.5</span>, <span class="fl">0.5</span>)</span></code></pre></div>
<p>We display the point using the <code>plot()</code> function. The
<code>plot()</code> function expects at least 2 arguments, first one
being one or more x coordinates and the second one being one or more y
coordinates. Remember that once a plot is displayed using
<code>plt.show()</code>, it displays the plot and empties the figure. So
you’ll have to create it again.</p>
<p>Reference: <a
href="https://matplotlib.org/stable/api/_as_gen/matplotlib.pyplot.plot.html">matplotlib.pyplot.plot</a></p>
<div class="sourceCode" id="cb15"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb15-2"><a href="#cb15-2" tabindex="-1"></a>fig.set_size_inches(<span class="dv">5</span>,<span class="dv">5</span>)</span>
<span id="cb15-3"><a href="#cb15-3" tabindex="-1"></a>ax.plot(point[<span class="dv">0</span>], point[<span class="dv">1</span>], color<span class="op">=</span><span class="st">&#39;green&#39;</span>, marker<span class="op">=</span><span class="st">&#39;o&#39;</span>)</span>
<span id="cb15-4"><a href="#cb15-4" tabindex="-1"></a>plt.show()</span></code></pre></div>
<p>Note: Understanding <code>*args</code> and <code>**kwargs</code></p>
<p>Python functions accept 2 types of arguments. - <em>Non Keyword
Arguments</em>: These are referred as <code>*args</code>. When the
number of arguments that a function takes is not fixed, it is specified
as <code>*args</code>. In the function <code>plot()</code> above, you
can specify 1 argument, 2 arguments or even 6 arguments and the function
will respond accordingly. - <em>Keyword Arguments</em>: These are
referred as <code>**kwargs</code>. These are specified as
<code>key=value</code> pairs and usually used to specify optional
parameters. These should always be specified after the non-keyword
arguments. The <code>color='green'</code> in the <code>plot()</code>
function is a keyword argument.</p>
<p>One problematic area for plotting geospatial data using matplotlib is
that geospatial data is typically represented as a list of x and y
coordinates. Let’s say we want to plot the following 3 points defined as
a list of (x,y) tuples.</p>
<div class="sourceCode" id="cb16"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" tabindex="-1"></a>points <span class="op">=</span> [(<span class="fl">0.1</span>, <span class="fl">0.5</span>), (<span class="fl">0.5</span>, <span class="fl">0.5</span>), (<span class="fl">0.9</span>, <span class="fl">0.5</span>)]</span></code></pre></div>
<p>But to plot it, <code>matplotlib</code> require 2 separate lists or x
and y coordinates. Here we can use the <code>zip()</code> function to
create list of x and y coordinates.</p>
<div class="sourceCode" id="cb17"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" tabindex="-1"></a>x, y <span class="op">=</span> <span class="bu">zip</span>(<span class="op">*</span>points)</span>
<span id="cb17-2"><a href="#cb17-2" tabindex="-1"></a><span class="bu">print</span>(x)</span>
<span id="cb17-3"><a href="#cb17-3" tabindex="-1"></a><span class="bu">print</span>(y)</span></code></pre></div>
<p>Now these can be plotted using the <code>plot()</code> method. We
specify keyword arguments <code>color</code> and
<code>marker</code>.</p>
<div class="sourceCode" id="cb18"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb18-2"><a href="#cb18-2" tabindex="-1"></a>fig.set_size_inches(<span class="dv">5</span>,<span class="dv">5</span>)</span>
<span id="cb18-3"><a href="#cb18-3" tabindex="-1"></a>ax.plot(x, y, color<span class="op">=</span><span class="st">&#39;green&#39;</span>, marker<span class="op">=</span><span class="st">&#39;o&#39;</span>)</span>
<span id="cb18-4"><a href="#cb18-4" tabindex="-1"></a>plt.show()</span></code></pre></div>
<div class="sourceCode" id="cb19"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb19-2"><a href="#cb19-2" tabindex="-1"></a>fig.set_size_inches(<span class="dv">5</span>,<span class="dv">5</span>)</span>
<span id="cb19-3"><a href="#cb19-3" tabindex="-1"></a>ax.plot(x, y, color<span class="op">=</span><span class="st">&#39;green&#39;</span>, marker<span class="op">=</span><span class="st">&#39;o&#39;</span>, linestyle<span class="op">=</span><span class="st">&#39;None&#39;</span>)</span>
<span id="cb19-4"><a href="#cb19-4" tabindex="-1"></a>plt.show()</span></code></pre></div>
<p>You can save the figure using the <code>savefig()</code> method.
Remember to save the figure <em>before</em> calling
<code>plt.show()</code> otherwise the figure would be empty.</p>
<div class="sourceCode" id="cb20"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb20-2"><a href="#cb20-2" tabindex="-1"></a>fig.set_size_inches(<span class="dv">5</span>,<span class="dv">5</span>)</span>
<span id="cb20-3"><a href="#cb20-3" tabindex="-1"></a>ax.plot(x, y, color<span class="op">=</span><span class="st">&#39;green&#39;</span>, marker<span class="op">=</span><span class="st">&#39;o&#39;</span>, linestyle<span class="op">=</span><span class="st">&#39;None&#39;</span>)</span>
<span id="cb20-4"><a href="#cb20-4" tabindex="-1"></a></span>
<span id="cb20-5"><a href="#cb20-5" tabindex="-1"></a>output_folder <span class="op">=</span> <span class="st">&#39;output&#39;</span></span>
<span id="cb20-6"><a href="#cb20-6" tabindex="-1"></a>output_path <span class="op">=</span> os.path.join(output_folder, <span class="st">&#39;simple.png&#39;</span>)</span>
<span id="cb20-7"><a href="#cb20-7" tabindex="-1"></a>plt.savefig(output_path)</span>
<span id="cb20-8"><a href="#cb20-8" tabindex="-1"></a></span>
<span id="cb20-9"><a href="#cb20-9" tabindex="-1"></a>plt.show()</span></code></pre></div>
<p><img
src="python-dataviz-output/01_matplotlib_basics_files/01_matplotlib_basics_22_0.png" /></p>
<p>Matplotlib provides many specialized functions for different types of
plots. <code>scatter()</code> for Scatter Charts, <code>bar()</code> for
Bar Charts and so on. You can use them directly, but in practice they
are used via higher-level libraries like <code>pandas</code>. In the
next section, we will see how to create such charts.</p>
</div>
<div id="exercise" class="section level2">
<h2>Exercise</h2>
<p>Create a plot that displays the 2 given points with their x,y
coordinates with different symbology.</p>
<ul>
<li><code>point1</code>: Plot it with green color and a triangle
marker.</li>
<li><code>point2</code>: Plot it with red color and a circle
marker.</li>
</ul>
<p><img src='https://courses.spatialthoughts.com/images/python_dataviz/points.png' width=300/></p>
<p>Use the code block as your starting point and refer to <a
href="https://matplotlib.org/stable/api/_as_gen/matplotlib.pyplot.plot.html">matplotlib.pyplot.plot</a>
documentation for help.</p>
<blockquote>
<p>Hint: You can call <code>plot()</code> multiple times to add new data
to the same Axes.</p>
</blockquote>
<div class="sourceCode" id="cb21"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb21-2"><a href="#cb21-2" tabindex="-1"></a></span>
<span id="cb21-3"><a href="#cb21-3" tabindex="-1"></a>point1 <span class="op">=</span> (<span class="dv">4</span>, <span class="dv">1</span>)</span>
<span id="cb21-4"><a href="#cb21-4" tabindex="-1"></a>point2 <span class="op">=</span> (<span class="dv">3</span>, <span class="dv">4</span>)</span></code></pre></div>
<hr />
</div>
</div>
<div id="creating-charts" class="section level1">
<h1>Creating Charts</h1>
<p><a
href="https://colab.research.google.com/github/spatialthoughts/python-dataviz-web/blob/main/02_creating_charts.ipynb"><img
src="https://colab.research.google.com/assets/colab-badge.svg"
alt="Open In Colab" /></a></p>
<div id="overview" class="section level2">
<h2>Overview</h2>
<p>Pandas allows you to read structured datasets and visualize them
using the <code>plot()</code> method. By default, Pandas uses
<code>matplotlib</code> to create the plots.</p>
<p>In this notebook, we will take work with open dataset of crime in
London.</p>
</div>
<div id="setup-and-data-download" class="section level2">
<h2>Setup and Data Download</h2>
<p>The following blocks of code will install the required packages and
download the datasets to your Colab environment.</p>
<div class="sourceCode" id="cb22"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb22-2"><a href="#cb22-2" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb22-3"><a href="#cb22-3" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb22-4"><a href="#cb22-4" tabindex="-1"></a><span class="im">import</span> requests</span></code></pre></div>
<div class="sourceCode" id="cb23"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" tabindex="-1"></a>data_folder <span class="op">=</span> <span class="st">&#39;data&#39;</span></span>
<span id="cb23-2"><a href="#cb23-2" tabindex="-1"></a>output_folder <span class="op">=</span> <span class="st">&#39;output&#39;</span></span>
<span id="cb23-3"><a href="#cb23-3" tabindex="-1"></a></span>
<span id="cb23-4"><a href="#cb23-4" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> os.path.exists(data_folder):</span>
<span id="cb23-5"><a href="#cb23-5" tabindex="-1"></a>    os.mkdir(data_folder)</span>
<span id="cb23-6"><a href="#cb23-6" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> os.path.exists(output_folder):</span>
<span id="cb23-7"><a href="#cb23-7" tabindex="-1"></a>    os.mkdir(output_folder)</span></code></pre></div>
<div class="sourceCode" id="cb24"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" tabindex="-1"></a><span class="kw">def</span> download(url):</span>
<span id="cb24-2"><a href="#cb24-2" tabindex="-1"></a>    filename <span class="op">=</span> os.path.join(data_folder, os.path.basename(url))</span>
<span id="cb24-3"><a href="#cb24-3" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> os.path.exists(filename):</span>
<span id="cb24-4"><a href="#cb24-4" tabindex="-1"></a>      <span class="cf">with</span> requests.get(url, stream<span class="op">=</span><span class="va">True</span>, allow_redirects<span class="op">=</span><span class="va">True</span>) <span class="im">as</span> r:</span>
<span id="cb24-5"><a href="#cb24-5" tabindex="-1"></a>          <span class="cf">with</span> <span class="bu">open</span>(filename, <span class="st">&#39;wb&#39;</span>) <span class="im">as</span> f:</span>
<span id="cb24-6"><a href="#cb24-6" tabindex="-1"></a>              <span class="cf">for</span> chunk <span class="kw">in</span> r.iter_content(chunk_size<span class="op">=</span><span class="dv">8192</span>):</span>
<span id="cb24-7"><a href="#cb24-7" tabindex="-1"></a>                  f.write(chunk)</span>
<span id="cb24-8"><a href="#cb24-8" tabindex="-1"></a>      <span class="bu">print</span>(<span class="st">&#39;Downloaded&#39;</span>, filename)</span></code></pre></div>
<p>We have 12 different CSV files containing crime data for each month
of 2020. We download each of them to the data folder.</p>
<div class="sourceCode" id="cb25"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" tabindex="-1"></a>files <span class="op">=</span> [</span>
<span id="cb25-2"><a href="#cb25-2" tabindex="-1"></a>  <span class="st">&#39;2020-01-metropolitan-street.csv&#39;</span>,</span>
<span id="cb25-3"><a href="#cb25-3" tabindex="-1"></a>  <span class="st">&#39;2020-02-metropolitan-street.csv&#39;</span>,</span>
<span id="cb25-4"><a href="#cb25-4" tabindex="-1"></a>  <span class="st">&#39;2020-03-metropolitan-street.csv&#39;</span>,</span>
<span id="cb25-5"><a href="#cb25-5" tabindex="-1"></a>  <span class="st">&#39;2020-04-metropolitan-street.csv&#39;</span>,</span>
<span id="cb25-6"><a href="#cb25-6" tabindex="-1"></a>  <span class="st">&#39;2020-05-metropolitan-street.csv&#39;</span>,</span>
<span id="cb25-7"><a href="#cb25-7" tabindex="-1"></a>  <span class="st">&#39;2020-06-metropolitan-street.csv&#39;</span>,</span>
<span id="cb25-8"><a href="#cb25-8" tabindex="-1"></a>  <span class="st">&#39;2020-07-metropolitan-street.csv&#39;</span>,</span>
<span id="cb25-9"><a href="#cb25-9" tabindex="-1"></a>  <span class="st">&#39;2020-08-metropolitan-street.csv&#39;</span>,</span>
<span id="cb25-10"><a href="#cb25-10" tabindex="-1"></a>  <span class="st">&#39;2020-09-metropolitan-street.csv&#39;</span>,</span>
<span id="cb25-11"><a href="#cb25-11" tabindex="-1"></a>  <span class="st">&#39;2020-10-metropolitan-street.csv&#39;</span>,</span>
<span id="cb25-12"><a href="#cb25-12" tabindex="-1"></a>  <span class="st">&#39;2020-11-metropolitan-street.csv&#39;</span>,</span>
<span id="cb25-13"><a href="#cb25-13" tabindex="-1"></a>  <span class="st">&#39;2020-12-metropolitan-street.csv&#39;</span></span>
<span id="cb25-14"><a href="#cb25-14" tabindex="-1"></a>]</span>
<span id="cb25-15"><a href="#cb25-15" tabindex="-1"></a></span>
<span id="cb25-16"><a href="#cb25-16" tabindex="-1"></a></span>
<span id="cb25-17"><a href="#cb25-17" tabindex="-1"></a>data_url <span class="op">=</span> <span class="st">&#39;https://github.com/spatialthoughts/python-dataviz-web/releases/&#39;</span> \</span>
<span id="cb25-18"><a href="#cb25-18" tabindex="-1"></a>  <span class="st">&#39;download/police.uk/&#39;</span></span>
<span id="cb25-19"><a href="#cb25-19" tabindex="-1"></a></span>
<span id="cb25-20"><a href="#cb25-20" tabindex="-1"></a><span class="cf">for</span> f <span class="kw">in</span> files:</span>
<span id="cb25-21"><a href="#cb25-21" tabindex="-1"></a>  url <span class="op">=</span> os.path.join(data_url <span class="op">+</span> f)</span>
<span id="cb25-22"><a href="#cb25-22" tabindex="-1"></a>  download(url)</span></code></pre></div>
<p>It will be helpful to merge all 12 CSV files into a single dataframe.
We can use <code>pd.concat()</code> to merge a list of dataframes.</p>
<div class="sourceCode" id="cb26"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" tabindex="-1"></a>dataframe_list <span class="op">=</span> []</span>
<span id="cb26-2"><a href="#cb26-2" tabindex="-1"></a></span>
<span id="cb26-3"><a href="#cb26-3" tabindex="-1"></a><span class="cf">for</span> f <span class="kw">in</span> files:</span>
<span id="cb26-4"><a href="#cb26-4" tabindex="-1"></a>    filepath <span class="op">=</span> os.path.join(data_folder, f)</span>
<span id="cb26-5"><a href="#cb26-5" tabindex="-1"></a>    df <span class="op">=</span> pd.read_csv(filepath)</span>
<span id="cb26-6"><a href="#cb26-6" tabindex="-1"></a>    dataframe_list.append(df)</span>
<span id="cb26-7"><a href="#cb26-7" tabindex="-1"></a></span>
<span id="cb26-8"><a href="#cb26-8" tabindex="-1"></a>merged_df <span class="op">=</span> pd.concat(dataframe_list)</span></code></pre></div>
<p>The resulting dataframe consists of over 1 million records of various
crimes recorded in London in the year 2020.</p>
<div class="sourceCode" id="cb27"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" tabindex="-1"></a>merged_df</span></code></pre></div>
</div>
<div id="create-a-pie-chart" class="section level2">
<h2>Create a Pie-Chart</h2>
<p>Let’s create a pie-chart showing the distribution of different types
of crime. Pandas <code>groupby()</code> function allows us to calculate
group statistics.</p>
<div class="sourceCode" id="cb28"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" tabindex="-1"></a>type_counts <span class="op">=</span> merged_df.groupby(<span class="st">&#39;Crime type&#39;</span>).size()</span>
<span id="cb28-2"><a href="#cb28-2" tabindex="-1"></a>type_counts</span></code></pre></div>
<p>We now uses the <code>plot()</code> method to create the chart. This
method is a wrapper around <code>matplotlib</code> and can accept
supported arguments from it.</p>
<p>Reference: <a
href="https://pandas.pydata.org/docs/reference/api/pandas.DataFrame.plot.html"><code>pandas.DataFrame.plot</code></a></p>
<div class="sourceCode" id="cb29"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb29-2"><a href="#cb29-2" tabindex="-1"></a>fig.set_size_inches(<span class="dv">15</span>,<span class="dv">10</span>)</span>
<span id="cb29-3"><a href="#cb29-3" tabindex="-1"></a>type_counts.plot(kind<span class="op">=</span><span class="st">&#39;pie&#39;</span>, ax<span class="op">=</span>ax)</span>
<span id="cb29-4"><a href="#cb29-4" tabindex="-1"></a>plt.show()</span></code></pre></div>
<p>Let’s customize the chart. First we use <code>set_title()</code>
method to add a title to the chart and <code>set_ylabel()</code> to
remove the empty y-axis label. Lastly, we use the
<code>plt.tight_layout()</code> to remove the extra whitespace around
the plot.</p>
<div class="sourceCode" id="cb30"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb30-2"><a href="#cb30-2" tabindex="-1"></a>fig.set_size_inches(<span class="dv">15</span>,<span class="dv">10</span>)</span>
<span id="cb30-3"><a href="#cb30-3" tabindex="-1"></a></span>
<span id="cb30-4"><a href="#cb30-4" tabindex="-1"></a>type_counts.plot(kind<span class="op">=</span><span class="st">&#39;pie&#39;</span>, ax<span class="op">=</span>ax)</span>
<span id="cb30-5"><a href="#cb30-5" tabindex="-1"></a></span>
<span id="cb30-6"><a href="#cb30-6" tabindex="-1"></a>ax.set_title(<span class="st">&#39;Crime Types&#39;</span>, fontsize <span class="op">=</span> <span class="dv">18</span>)</span>
<span id="cb30-7"><a href="#cb30-7" tabindex="-1"></a>ax.set_ylabel(<span class="st">&#39;&#39;</span>)</span>
<span id="cb30-8"><a href="#cb30-8" tabindex="-1"></a></span>
<span id="cb30-9"><a href="#cb30-9" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb30-10"><a href="#cb30-10" tabindex="-1"></a>plt.show()</span></code></pre></div>
<p>Matplotlib plots offer unlimited possibilities to customize your
charts. Let’s see some of the options available to customize the
pie-chart.</p>
<ul>
<li><code>wedgeprops</code>: Customize the look of each ‘wedge’ of the
pie.</li>
<li><code>textprops</code>: Set the text properties of labels.</li>
</ul>
<p>Reference: <a
href="https://matplotlib.org/stable/api/_as_gen/matplotlib.pyplot.pie.html"><code>matplotlib.pyplot.pie</code></a></p>
<div class="sourceCode" id="cb31"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" tabindex="-1"></a>wedgeprops<span class="op">=</span>{<span class="st">&#39;linewidth&#39;</span>: <span class="dv">3</span>, <span class="st">&#39;edgecolor&#39;</span>: <span class="st">&#39;white&#39;</span>}</span>
<span id="cb31-2"><a href="#cb31-2" tabindex="-1"></a>textprops<span class="op">=</span> {<span class="st">&#39;fontsize&#39;</span>: <span class="dv">10</span>, <span class="st">&#39;fontstyle&#39;</span>: <span class="st">&#39;italic&#39;</span>}</span>
<span id="cb31-3"><a href="#cb31-3" tabindex="-1"></a></span>
<span id="cb31-4"><a href="#cb31-4" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb31-5"><a href="#cb31-5" tabindex="-1"></a>fig.set_size_inches(<span class="dv">15</span>,<span class="dv">10</span>)</span>
<span id="cb31-6"><a href="#cb31-6" tabindex="-1"></a></span>
<span id="cb31-7"><a href="#cb31-7" tabindex="-1"></a>type_counts.plot(kind<span class="op">=</span><span class="st">&#39;pie&#39;</span>, ax<span class="op">=</span>ax,</span>
<span id="cb31-8"><a href="#cb31-8" tabindex="-1"></a>                 wedgeprops<span class="op">=</span>wedgeprops,</span>
<span id="cb31-9"><a href="#cb31-9" tabindex="-1"></a>                 textprops<span class="op">=</span>textprops</span>
<span id="cb31-10"><a href="#cb31-10" tabindex="-1"></a>                 )</span>
<span id="cb31-11"><a href="#cb31-11" tabindex="-1"></a></span>
<span id="cb31-12"><a href="#cb31-12" tabindex="-1"></a>ax.set_title(<span class="st">&#39;Crime Types&#39;</span>, fontsize <span class="op">=</span> <span class="dv">18</span>)</span>
<span id="cb31-13"><a href="#cb31-13" tabindex="-1"></a>ax.set_ylabel(<span class="st">&#39;&#39;</span>)</span>
<span id="cb31-14"><a href="#cb31-14" tabindex="-1"></a></span>
<span id="cb31-15"><a href="#cb31-15" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb31-16"><a href="#cb31-16" tabindex="-1"></a>plt.show()</span></code></pre></div>
<p><img
src="python-dataviz-output/02_creating_charts_files/02_creating_charts_19_0.png" /></p>
</div>
<div id="create-a-bar-chart" class="section level2">
<h2>Create a Bar Chart</h2>
<p>We can also chart the trend of crime over the year. For this, let’s
group the data by month.</p>
<div class="sourceCode" id="cb32"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" tabindex="-1"></a>monthly_counts <span class="op">=</span> merged_df.groupby(<span class="st">&#39;Month&#39;</span>).size()</span>
<span id="cb32-2"><a href="#cb32-2" tabindex="-1"></a>monthly_counts</span></code></pre></div>
<div class="sourceCode" id="cb33"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb33-2"><a href="#cb33-2" tabindex="-1"></a>fig.set_size_inches(<span class="dv">15</span>,<span class="dv">7</span>)</span>
<span id="cb33-3"><a href="#cb33-3" tabindex="-1"></a>monthly_counts.plot(kind<span class="op">=</span><span class="st">&#39;bar&#39;</span>, ax<span class="op">=</span>ax)</span>
<span id="cb33-4"><a href="#cb33-4" tabindex="-1"></a>plt.show()</span></code></pre></div>
<p>As we learnt earlier, we can add multiple plots on the same Axes. We
can add a <code>line</code> chart along with the <code>bar</code> chart
to show the trendline as well. Lastly we add the titles and axis labels
to finish the chart.</p>
<div class="sourceCode" id="cb34"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb34-2"><a href="#cb34-2" tabindex="-1"></a>fig.set_size_inches(<span class="dv">15</span>,<span class="dv">7</span>)</span>
<span id="cb34-3"><a href="#cb34-3" tabindex="-1"></a></span>
<span id="cb34-4"><a href="#cb34-4" tabindex="-1"></a>monthly_counts.plot(kind<span class="op">=</span><span class="st">&#39;bar&#39;</span>, ax<span class="op">=</span>ax)</span>
<span id="cb34-5"><a href="#cb34-5" tabindex="-1"></a>monthly_counts.plot(kind<span class="op">=</span><span class="st">&#39;line&#39;</span>, ax<span class="op">=</span>ax, color<span class="op">=</span><span class="st">&#39;red&#39;</span>, marker<span class="op">=</span><span class="st">&#39;o&#39;</span>)</span>
<span id="cb34-6"><a href="#cb34-6" tabindex="-1"></a></span>
<span id="cb34-7"><a href="#cb34-7" tabindex="-1"></a>ax.set_title(<span class="st">&#39;Total Crime by Month&#39;</span>)</span>
<span id="cb34-8"><a href="#cb34-8" tabindex="-1"></a>ax.set_ylabel(<span class="st">&#39;Total Incidents&#39;</span>)</span>
<span id="cb34-9"><a href="#cb34-9" tabindex="-1"></a></span>
<span id="cb34-10"><a href="#cb34-10" tabindex="-1"></a>plt.show()</span></code></pre></div>
<p><img
src="python-dataviz-output/02_creating_charts_files/02_creating_charts_24_0.png" /></p>
</div>
<div id="exercise-1" class="section level2">
<h2>Exercise</h2>
<p>Plot the trend of Bicycle thefts as a line chart.</p>
<p><img src='https://courses.spatialthoughts.com/images/python_dataviz/bicycle_thefts.png' width=800/></p>
<p>The cell below filters the <code>merged_df</code> dataframe to select
incidents of ‘Bicycle theft’. Group the results by months and plot the
results.</p>
<div class="sourceCode" id="cb35"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" tabindex="-1"></a>bicycle_thefts <span class="op">=</span> merged_df[merged_df[<span class="st">&#39;Crime type&#39;</span>] <span class="op">==</span> <span class="st">&#39;Bicycle theft&#39;</span>]</span></code></pre></div>
<hr />
</div>
</div>
<div id="creating-maps" class="section level1">
<h1>Creating Maps</h1>
<p><a
href="https://colab.research.google.com/github/spatialthoughts/python-dataviz-web/blob/main/03_creating_maps.ipynb"><img
src="https://colab.research.google.com/assets/colab-badge.svg"
alt="Open In Colab" /></a></p>
<div id="overview-1" class="section level2">
<h2>Overview</h2>
<p>Similar to Pandas, GeoPandas has a <code>plot()</code> method that
can plot geospatial data using Matplotlib.</p>
<p>We will work with census data to create a choropleth map of
population density. We will start with a shapefile of census tracts, and
join it with tabular data to get a GeoDataframe with census tract
geometry and correponding populations.</p>
</div>
<div id="setup-and-data-download-1" class="section level2">
<h2>Setup and Data Download</h2>
<p>The following blocks of code will install the required packages and
download the datasets to your Colab environment.</p>
<div class="sourceCode" id="cb36"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" tabindex="-1"></a><span class="op">%%</span>capture</span>
<span id="cb36-2"><a href="#cb36-2" tabindex="-1"></a><span class="cf">if</span> <span class="st">&#39;google.colab&#39;</span> <span class="kw">in</span> <span class="bu">str</span>(get_ipython()):</span>
<span id="cb36-3"><a href="#cb36-3" tabindex="-1"></a>  <span class="op">!</span>pip install mapclassify</span></code></pre></div>
<div class="sourceCode" id="cb37"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" tabindex="-1"></a><span class="im">import</span> geopandas <span class="im">as</span> gpd</span>
<span id="cb37-2"><a href="#cb37-2" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb37-3"><a href="#cb37-3" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb37-4"><a href="#cb37-4" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb37-5"><a href="#cb37-5" tabindex="-1"></a><span class="im">import</span> requests</span></code></pre></div>
<div class="sourceCode" id="cb38"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" tabindex="-1"></a>data_folder <span class="op">=</span> <span class="st">&#39;data&#39;</span></span>
<span id="cb38-2"><a href="#cb38-2" tabindex="-1"></a>output_folder <span class="op">=</span> <span class="st">&#39;output&#39;</span></span>
<span id="cb38-3"><a href="#cb38-3" tabindex="-1"></a></span>
<span id="cb38-4"><a href="#cb38-4" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> os.path.exists(data_folder):</span>
<span id="cb38-5"><a href="#cb38-5" tabindex="-1"></a>    os.mkdir(data_folder)</span>
<span id="cb38-6"><a href="#cb38-6" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> os.path.exists(output_folder):</span>
<span id="cb38-7"><a href="#cb38-7" tabindex="-1"></a>    os.mkdir(output_folder)</span></code></pre></div>
<div class="sourceCode" id="cb39"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" tabindex="-1"></a><span class="kw">def</span> download(url):</span>
<span id="cb39-2"><a href="#cb39-2" tabindex="-1"></a>    filename <span class="op">=</span> os.path.join(data_folder, os.path.basename(url))</span>
<span id="cb39-3"><a href="#cb39-3" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> os.path.exists(filename):</span>
<span id="cb39-4"><a href="#cb39-4" tabindex="-1"></a>      <span class="cf">with</span> requests.get(url, stream<span class="op">=</span><span class="va">True</span>, allow_redirects<span class="op">=</span><span class="va">True</span>) <span class="im">as</span> r:</span>
<span id="cb39-5"><a href="#cb39-5" tabindex="-1"></a>          <span class="cf">with</span> <span class="bu">open</span>(filename, <span class="st">&#39;wb&#39;</span>) <span class="im">as</span> f:</span>
<span id="cb39-6"><a href="#cb39-6" tabindex="-1"></a>              <span class="cf">for</span> chunk <span class="kw">in</span> r.iter_content(chunk_size<span class="op">=</span><span class="dv">8192</span>):</span>
<span id="cb39-7"><a href="#cb39-7" tabindex="-1"></a>                  f.write(chunk)</span>
<span id="cb39-8"><a href="#cb39-8" tabindex="-1"></a>      <span class="bu">print</span>(<span class="st">&#39;Downloaded&#39;</span>, filename)</span></code></pre></div>
<p>We will download the the census tracts shapefile and a CSV file
containing a variety of population statistics for each tract.</p>
<div class="sourceCode" id="cb40"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" tabindex="-1"></a>shapefile_name <span class="op">=</span> <span class="st">&#39;tl_2019_06_tract&#39;</span></span>
<span id="cb40-2"><a href="#cb40-2" tabindex="-1"></a>shapefile_exts <span class="op">=</span> [<span class="st">&#39;.shp&#39;</span>, <span class="st">&#39;.shx&#39;</span>, <span class="st">&#39;.dbf&#39;</span>, <span class="st">&#39;.prj&#39;</span>]</span>
<span id="cb40-3"><a href="#cb40-3" tabindex="-1"></a>data_url <span class="op">=</span> <span class="st">&#39;https://github.com/spatialthoughts/python-dataviz-web/releases/&#39;</span> \</span>
<span id="cb40-4"><a href="#cb40-4" tabindex="-1"></a>  <span class="st">&#39;download/census/&#39;</span></span>
<span id="cb40-5"><a href="#cb40-5" tabindex="-1"></a></span>
<span id="cb40-6"><a href="#cb40-6" tabindex="-1"></a><span class="cf">for</span> ext <span class="kw">in</span> shapefile_exts:</span>
<span id="cb40-7"><a href="#cb40-7" tabindex="-1"></a>  url <span class="op">=</span> data_url <span class="op">+</span> shapefile_name <span class="op">+</span> ext</span>
<span id="cb40-8"><a href="#cb40-8" tabindex="-1"></a>  download(url)</span>
<span id="cb40-9"><a href="#cb40-9" tabindex="-1"></a></span>
<span id="cb40-10"><a href="#cb40-10" tabindex="-1"></a>csv_name <span class="op">=</span> <span class="st">&#39;ACSST5Y2019.S0101_data.csv&#39;</span></span>
<span id="cb40-11"><a href="#cb40-11" tabindex="-1"></a>download(data_url <span class="op">+</span> csv_name)</span></code></pre></div>
</div>
<div id="data-pre-processing" class="section level2">
<h2>Data Pre-Processing</h2>
<p>Let’s read the census tracts shapefile and the CSV file containing
population counts.</p>
<div class="sourceCode" id="cb41"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" tabindex="-1"></a>shapefile_path <span class="op">=</span> os.path.join(data_folder, shapefile_name <span class="op">+</span> <span class="st">&#39;.shp&#39;</span>)</span>
<span id="cb41-2"><a href="#cb41-2" tabindex="-1"></a>tracts <span class="op">=</span> gpd.read_file(shapefile_path)</span>
<span id="cb41-3"><a href="#cb41-3" tabindex="-1"></a>tracts</span></code></pre></div>
<p>We now read the file containing a variety of population statistics
for each tract. We read this file as a Pandas DataFrame. The CSV file
contains an extra row before the header, so we specify
<code>skiprows=[1]</code> to skip reading it.</p>
<div class="sourceCode" id="cb42"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" tabindex="-1"></a>csv_path <span class="op">=</span> os.path.join(data_folder, csv_name)</span>
<span id="cb42-2"><a href="#cb42-2" tabindex="-1"></a>table <span class="op">=</span> pd.read_csv(csv_path, skiprows<span class="op">=</span>[<span class="dv">1</span>])</span>
<span id="cb42-3"><a href="#cb42-3" tabindex="-1"></a>table</span></code></pre></div>
<p>To join this DataFrame with the GeoDataFrame, we need a column with
unique identifiers. We use the <code>GEOID</code> column and process the
id so they match exactly in both datasets.</p>
<div class="sourceCode" id="cb43"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" tabindex="-1"></a>filtered <span class="op">=</span> table[[<span class="st">&#39;GEO_ID&#39;</span>,<span class="st">&#39;NAME&#39;</span>, <span class="st">&#39;S0101_C01_001E&#39;</span>]]</span>
<span id="cb43-2"><a href="#cb43-2" tabindex="-1"></a>filtered <span class="op">=</span> filtered.rename(columns <span class="op">=</span> {<span class="st">&#39;S0101_C01_001E&#39;</span>: <span class="st">&#39;Population&#39;</span>, <span class="st">&#39;GEO_ID&#39;</span>: <span class="st">&#39;GEOID&#39;</span>})</span>
<span id="cb43-3"><a href="#cb43-3" tabindex="-1"></a></span>
<span id="cb43-4"><a href="#cb43-4" tabindex="-1"></a>filtered[<span class="st">&#39;GEOID&#39;</span>] <span class="op">=</span> filtered.GEOID.<span class="bu">str</span>[<span class="op">-</span><span class="dv">11</span>:]</span></code></pre></div>
<p>Finally, we do a table join using the <code>merge</code> method.</p>
<div class="sourceCode" id="cb44"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" tabindex="-1"></a>gdf <span class="op">=</span> tracts.merge(filtered, on<span class="op">=</span><span class="st">&#39;GEOID&#39;</span>)</span>
<span id="cb44-2"><a href="#cb44-2" tabindex="-1"></a>gdf</span></code></pre></div>
<p>For creating a choropleth map, we must normalize the population
counts. US Census Bureau <a
href="https://www.census.gov/quickfacts/fact/note/US/LND110210">recommends</a>
calculating the population density by dividing the total population by
the land area. The original shapefile contains a column
<code>ALAND</code> with the land area in square kilometers. Using it, we
compute a new column <code>density</code> containing the persons per
square kilometer.</p>
<div class="sourceCode" id="cb45"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" tabindex="-1"></a>gdf[<span class="st">&#39;density&#39;</span>] <span class="op">=</span> <span class="fl">1e6</span><span class="op">*</span>gdf[<span class="st">&#39;Population&#39;</span>]<span class="op">/</span>gdf[<span class="st">&#39;ALAND&#39;</span>]</span>
<span id="cb45-2"><a href="#cb45-2" tabindex="-1"></a>gdf</span></code></pre></div>
</div>
<div id="create-a-choropleth-map" class="section level2">
<h2>Create a Choropleth Map</h2>
<p>The <code>plot()</code> method will render the data to a plot.</p>
<p>Reference: <a
href="https://geopandas.org/en/stable/docs/reference/api/geopandas.GeoDataFrame.plot.html">geopandas.GeoDataFrame.plot</a></p>
<div class="sourceCode" id="cb46"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb46-2"><a href="#cb46-2" tabindex="-1"></a>fig.set_size_inches(<span class="dv">10</span>,<span class="dv">10</span>)</span>
<span id="cb46-3"><a href="#cb46-3" tabindex="-1"></a>gdf.plot(ax<span class="op">=</span>ax)</span>
<span id="cb46-4"><a href="#cb46-4" tabindex="-1"></a>plt.show()</span></code></pre></div>
<p>You can supply additional style options to change the appearance of
the map. <code>facecolor</code> and <code>edgecolor</code> parameters
are used to determine the fill and outline colors respectively. The
stroke width can be adjusted using the <code>linewidth</code>
parameter.</p>
<div class="sourceCode" id="cb47"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb47-2"><a href="#cb47-2" tabindex="-1"></a>fig.set_size_inches(<span class="dv">10</span>,<span class="dv">10</span>)</span>
<span id="cb47-3"><a href="#cb47-3" tabindex="-1"></a>gdf.plot(ax<span class="op">=</span>ax, facecolor<span class="op">=</span><span class="st">&#39;#f0f0f0&#39;</span>, edgecolor<span class="op">=</span><span class="st">&#39;#de2d26&#39;</span>, linewidth<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb47-4"><a href="#cb47-4" tabindex="-1"></a></span>
<span id="cb47-5"><a href="#cb47-5" tabindex="-1"></a>plt.show()</span></code></pre></div>
<p>We have the population density for each tract in the
<code>density</code> column. We can assign a color to each polygon based
on the value in this column - resulting in a choropleth map.
Additionally, we need to specify a color ramp using <code>cmap</code>
and classification scheme using <code>scheme</code>. The classification
schedule will determine how the continuous data will be classified into
discrete bins.</p>
<blockquote>
<p>Tip: You can add <code>_r</code> to any color ramp name to get a
<strong>r</strong>eversed version of that ramp.</p>
</blockquote>
<p>References: - <a
href="https://matplotlib.org/stable/tutorials/colors/colormaps.html">Matplotlib
Colormaps</a> - <a
href="https://pysal.org/mapclassify/generated/mapclassify.classify.html#mapclassify.classify">Mapclassify
Classification Schemes</a></p>
<div class="sourceCode" id="cb48"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb48-2"><a href="#cb48-2" tabindex="-1"></a>fig.set_size_inches(<span class="dv">10</span>,<span class="dv">10</span>)</span>
<span id="cb48-3"><a href="#cb48-3" tabindex="-1"></a>gdf.plot(ax<span class="op">=</span>ax, column<span class="op">=</span><span class="st">&#39;density&#39;</span>, cmap<span class="op">=</span><span class="st">&#39;RdYlGn_r&#39;</span>, scheme<span class="op">=</span><span class="st">&#39;quantiles&#39;</span>)</span>
<span id="cb48-4"><a href="#cb48-4" tabindex="-1"></a>plt.show()</span></code></pre></div>
<p>Instead of the class breaks being determined by the classification
scheme, we can also manually specify the ranges. This is preferable so
we can have a human-interpretable legend. The <code>legend=True</code>
parameter adds a legend to our plot.</p>
<div class="sourceCode" id="cb49"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb49-2"><a href="#cb49-2" tabindex="-1"></a>fig.set_size_inches(<span class="dv">10</span>,<span class="dv">10</span>)</span>
<span id="cb49-3"><a href="#cb49-3" tabindex="-1"></a></span>
<span id="cb49-4"><a href="#cb49-4" tabindex="-1"></a>classification_kwds<span class="op">=</span>{</span>
<span id="cb49-5"><a href="#cb49-5" tabindex="-1"></a>  <span class="st">&#39;bins&#39;</span>: [<span class="dv">1</span>,<span class="dv">10</span>,<span class="dv">25</span>,<span class="dv">50</span>,<span class="dv">100</span>, <span class="dv">250</span>, <span class="dv">500</span>, <span class="dv">1000</span>, <span class="dv">5000</span>]</span>
<span id="cb49-6"><a href="#cb49-6" tabindex="-1"></a>}</span>
<span id="cb49-7"><a href="#cb49-7" tabindex="-1"></a>gdf.plot(ax<span class="op">=</span>ax, column<span class="op">=</span><span class="st">&#39;density&#39;</span>, cmap<span class="op">=</span><span class="st">&#39;RdYlGn_r&#39;</span>, scheme<span class="op">=</span><span class="st">&#39;User_Defined&#39;</span>,</span>
<span id="cb49-8"><a href="#cb49-8" tabindex="-1"></a>         classification_kwds<span class="op">=</span>classification_kwds, legend<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb49-9"><a href="#cb49-9" tabindex="-1"></a></span>
<span id="cb49-10"><a href="#cb49-10" tabindex="-1"></a>plt.show()</span></code></pre></div>
<p>We can supply legend customization options via the
<code>legend_kwds</code> parameter and adjust the legend position,
formatting of the text, and add a legend title. We can also manually
adjust the legend entries, to give a more legible labels.</p>
<div class="sourceCode" id="cb50"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" tabindex="-1"></a>legend_kwds<span class="op">=</span> {</span>
<span id="cb50-2"><a href="#cb50-2" tabindex="-1"></a>  <span class="st">&#39;loc&#39;</span>: <span class="st">&#39;upper right&#39;</span>,</span>
<span id="cb50-3"><a href="#cb50-3" tabindex="-1"></a>  <span class="st">&#39;bbox_to_anchor&#39;</span>: (<span class="fl">0.8</span>, <span class="fl">0.9</span>),</span>
<span id="cb50-4"><a href="#cb50-4" tabindex="-1"></a>  <span class="st">&#39;fmt&#39;</span>: <span class="st">&#39;</span><span class="sc">{:&lt;5.0f}</span><span class="st">&#39;</span>,</span>
<span id="cb50-5"><a href="#cb50-5" tabindex="-1"></a>  <span class="st">&#39;frameon&#39;</span>: <span class="va">False</span>,</span>
<span id="cb50-6"><a href="#cb50-6" tabindex="-1"></a>  <span class="st">&#39;fontsize&#39;</span>: <span class="dv">8</span>,</span>
<span id="cb50-7"><a href="#cb50-7" tabindex="-1"></a>  <span class="st">&#39;title&#39;</span>: <span class="st">&#39;persons/sq.km.&#39;</span></span>
<span id="cb50-8"><a href="#cb50-8" tabindex="-1"></a>}</span>
<span id="cb50-9"><a href="#cb50-9" tabindex="-1"></a>classification_kwds<span class="op">=</span>{</span>
<span id="cb50-10"><a href="#cb50-10" tabindex="-1"></a>  <span class="st">&#39;bins&#39;</span>:[<span class="dv">1</span>,<span class="dv">10</span>,<span class="dv">25</span>,<span class="dv">50</span>,<span class="dv">100</span>, <span class="dv">250</span>, <span class="dv">500</span>, <span class="dv">1000</span>, <span class="dv">5000</span>]</span>
<span id="cb50-11"><a href="#cb50-11" tabindex="-1"></a>}</span>
<span id="cb50-12"><a href="#cb50-12" tabindex="-1"></a></span>
<span id="cb50-13"><a href="#cb50-13" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb50-14"><a href="#cb50-14" tabindex="-1"></a>fig.set_size_inches(<span class="dv">10</span>,<span class="dv">10</span>)</span>
<span id="cb50-15"><a href="#cb50-15" tabindex="-1"></a>gdf.plot(ax<span class="op">=</span>ax, column<span class="op">=</span><span class="st">&#39;density&#39;</span>, cmap<span class="op">=</span><span class="st">&#39;RdYlGn_r&#39;</span>, scheme<span class="op">=</span><span class="st">&#39;User_Defined&#39;</span>,</span>
<span id="cb50-16"><a href="#cb50-16" tabindex="-1"></a>         classification_kwds<span class="op">=</span>classification_kwds,</span>
<span id="cb50-17"><a href="#cb50-17" tabindex="-1"></a>         legend<span class="op">=</span><span class="va">True</span>, legend_kwds<span class="op">=</span>legend_kwds)</span>
<span id="cb50-18"><a href="#cb50-18" tabindex="-1"></a></span>
<span id="cb50-19"><a href="#cb50-19" tabindex="-1"></a>ax.set_axis_off()</span>
<span id="cb50-20"><a href="#cb50-20" tabindex="-1"></a></span>
<span id="cb50-21"><a href="#cb50-21" tabindex="-1"></a><span class="co"># Change the last entry in the legend to &#39;&gt;5000&#39;</span></span>
<span id="cb50-22"><a href="#cb50-22" tabindex="-1"></a>legend <span class="op">=</span> ax.get_legend()</span>
<span id="cb50-23"><a href="#cb50-23" tabindex="-1"></a>legend.texts[<span class="op">-</span><span class="dv">1</span>].set_text(<span class="st">&#39;&gt; 5000&#39;</span>)</span>
<span id="cb50-24"><a href="#cb50-24" tabindex="-1"></a></span>
<span id="cb50-25"><a href="#cb50-25" tabindex="-1"></a>plt.show()</span></code></pre></div>
<p>Once we are happy with the look, we add a title and save the result
as a PNG file. Remember to call <code>plt.savefig()</code> before
showing the plot as the plot gets emptied after being shown.</p>
<div class="sourceCode" id="cb51"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb51-1"><a href="#cb51-1" tabindex="-1"></a>legend_kwds<span class="op">=</span> {</span>
<span id="cb51-2"><a href="#cb51-2" tabindex="-1"></a>  <span class="st">&#39;loc&#39;</span>: <span class="st">&#39;upper right&#39;</span>,</span>
<span id="cb51-3"><a href="#cb51-3" tabindex="-1"></a>  <span class="st">&#39;bbox_to_anchor&#39;</span>: (<span class="fl">0.8</span>, <span class="fl">0.9</span>),</span>
<span id="cb51-4"><a href="#cb51-4" tabindex="-1"></a>  <span class="st">&#39;fmt&#39;</span>: <span class="st">&#39;</span><span class="sc">{:&lt;5.0f}</span><span class="st">&#39;</span>,</span>
<span id="cb51-5"><a href="#cb51-5" tabindex="-1"></a>  <span class="st">&#39;frameon&#39;</span>: <span class="va">False</span>,</span>
<span id="cb51-6"><a href="#cb51-6" tabindex="-1"></a>  <span class="st">&#39;fontsize&#39;</span>: <span class="dv">8</span>,</span>
<span id="cb51-7"><a href="#cb51-7" tabindex="-1"></a>  <span class="st">&#39;title&#39;</span>: <span class="st">&#39;persons/sq.km.&#39;</span></span>
<span id="cb51-8"><a href="#cb51-8" tabindex="-1"></a>}</span>
<span id="cb51-9"><a href="#cb51-9" tabindex="-1"></a>classification_kwds<span class="op">=</span>{</span>
<span id="cb51-10"><a href="#cb51-10" tabindex="-1"></a>  <span class="st">&#39;bins&#39;</span>:[<span class="dv">1</span>,<span class="dv">10</span>,<span class="dv">25</span>,<span class="dv">50</span>,<span class="dv">100</span>, <span class="dv">250</span>, <span class="dv">500</span>, <span class="dv">1000</span>, <span class="dv">5000</span>]</span>
<span id="cb51-11"><a href="#cb51-11" tabindex="-1"></a>}</span>
<span id="cb51-12"><a href="#cb51-12" tabindex="-1"></a></span>
<span id="cb51-13"><a href="#cb51-13" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb51-14"><a href="#cb51-14" tabindex="-1"></a>fig.set_size_inches(<span class="dv">10</span>,<span class="dv">10</span>)</span>
<span id="cb51-15"><a href="#cb51-15" tabindex="-1"></a>gdf.plot(ax<span class="op">=</span>ax, column<span class="op">=</span><span class="st">&#39;density&#39;</span>, cmap<span class="op">=</span><span class="st">&#39;RdYlGn_r&#39;</span>, scheme<span class="op">=</span><span class="st">&#39;User_Defined&#39;</span>,</span>
<span id="cb51-16"><a href="#cb51-16" tabindex="-1"></a>         classification_kwds<span class="op">=</span>classification_kwds,</span>
<span id="cb51-17"><a href="#cb51-17" tabindex="-1"></a>         legend<span class="op">=</span><span class="va">True</span>, legend_kwds<span class="op">=</span>legend_kwds)</span>
<span id="cb51-18"><a href="#cb51-18" tabindex="-1"></a></span>
<span id="cb51-19"><a href="#cb51-19" tabindex="-1"></a>ax.set_axis_off()</span>
<span id="cb51-20"><a href="#cb51-20" tabindex="-1"></a></span>
<span id="cb51-21"><a href="#cb51-21" tabindex="-1"></a><span class="co"># Change the last entry in the legend to &#39;&gt;5000&#39;</span></span>
<span id="cb51-22"><a href="#cb51-22" tabindex="-1"></a>legend <span class="op">=</span> ax.get_legend()</span>
<span id="cb51-23"><a href="#cb51-23" tabindex="-1"></a>legend.texts[<span class="op">-</span><span class="dv">1</span>].set_text(<span class="st">&#39;&gt; 5000&#39;</span>)</span>
<span id="cb51-24"><a href="#cb51-24" tabindex="-1"></a></span>
<span id="cb51-25"><a href="#cb51-25" tabindex="-1"></a><span class="co"># Add a title</span></span>
<span id="cb51-26"><a href="#cb51-26" tabindex="-1"></a>ax.set_title(<span class="st">&#39;California Population Density (2019)&#39;</span>, size <span class="op">=</span> <span class="dv">18</span>)</span>
<span id="cb51-27"><a href="#cb51-27" tabindex="-1"></a></span>
<span id="cb51-28"><a href="#cb51-28" tabindex="-1"></a>output_path <span class="op">=</span> os.path.join(output_folder, <span class="st">&#39;california_pop.png&#39;</span>)</span>
<span id="cb51-29"><a href="#cb51-29" tabindex="-1"></a>plt.savefig(output_path, dpi<span class="op">=</span><span class="dv">300</span>)</span>
<span id="cb51-30"><a href="#cb51-30" tabindex="-1"></a></span>
<span id="cb51-31"><a href="#cb51-31" tabindex="-1"></a>plt.show()</span></code></pre></div>
<p><img
src="python-dataviz-output/03_creating_maps_files/03_creating_maps_31_0.png" /></p>
</div>
<div id="exercise-2" class="section level2">
<h2>Exercise</h2>
<ol style="list-style-type: decimal">
<li>Plot the census tracts geodataframe <code>tracts</code> with just
outlines and no fill color.</li>
<li>Display the map zoomed-in around the San Francisco area between
Latitudes from <code>37.71</code> to <code>37.82</code> and Longitudes
from <code>-122.53</code> to <code>-122.36</code>.</li>
</ol>
<p><img src='https://courses.spatialthoughts.com/images/python_dataviz/sf.png' width=600/></p>
<p>Use the code block below as your starting point.</p>
<p>Hints:</p>
<ul>
<li>Set the <code>facecolor</code> option to <code>'none'</code> for no
fills. Refer to the <a
href="https://geopandas.org/en/stable/docs/reference/api/geopandas.GeoDataFrame.plot.html"><em>style_kwds</em>
parameter</a> of the <code>plot()</code> method for more details.</li>
<li>Use the <a
href="https://matplotlib.org/stable/api/_as_gen/matplotlib.axes.Axes.set_xlim.html"><code>set_xlim()</code></a>
and <a
href="https://matplotlib.org/stable/api/_as_gen/matplotlib.axes.Axes.set_ylim.html"><code>set_ylim()</code></a>
methods to set the view area of the Axes. <em>Remember that Latitudes
are Y-coordinates and Longitudes are X-Coordinates.</em></li>
</ul>
<div class="sourceCode" id="cb52"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb52-2"><a href="#cb52-2" tabindex="-1"></a>fig.set_size_inches(<span class="dv">7</span>,<span class="dv">7</span>)</span>
<span id="cb52-3"><a href="#cb52-3" tabindex="-1"></a>tracts.plot(ax<span class="op">=</span>ax)</span>
<span id="cb52-4"><a href="#cb52-4" tabindex="-1"></a>plt.show()</span></code></pre></div>
<hr />
</div>
</div>
<div id="using-basemaps" class="section level1">
<h1>Using Basemaps</h1>
<p><a
href="https://colab.research.google.com/github/spatialthoughts/python-dataviz-web/blob/main/04_using_basemaps.ipynb"><img
src="https://colab.research.google.com/assets/colab-badge.svg"
alt="Open In Colab" /></a></p>
<div id="overview-2" class="section level2">
<h2>Overview</h2>
<p>Creating geospatial visualizations often require overlaying your data
on a basemap. <a
href="https://contextily.readthedocs.io/en/latest/">Contextily</a> is a
package that allows you to fetch various basemaps from the internet and
add them to your plot as static images.</p>
<p>We will learn how to take a shapefile showing the path of the <a
href="https://svs.gsfc.nasa.gov/4518">2017 Solar Eclipse</a> and create
a map with a topographic basemap. NASA also provides similar data for
other eclipses, including the <a
href="https://svs.gsfc.nasa.gov/5123/">2024 Total Solar Eclipse</a>.</p>
</div>
<div id="setup-and-data-download-2" class="section level2">
<h2>Setup and Data Download</h2>
<p>The following blocks of code will install the required packages and
download the datasets to your Colab environment.</p>
<div class="sourceCode" id="cb53"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb53-1"><a href="#cb53-1" tabindex="-1"></a><span class="op">%%</span>capture</span>
<span id="cb53-2"><a href="#cb53-2" tabindex="-1"></a><span class="cf">if</span> <span class="st">&#39;google.colab&#39;</span> <span class="kw">in</span> <span class="bu">str</span>(get_ipython()):</span>
<span id="cb53-3"><a href="#cb53-3" tabindex="-1"></a>  <span class="op">!</span>pip install contextily</span></code></pre></div>
<div class="sourceCode" id="cb54"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb54-1"><a href="#cb54-1" tabindex="-1"></a><span class="im">import</span> contextily <span class="im">as</span> cx</span>
<span id="cb54-2"><a href="#cb54-2" tabindex="-1"></a><span class="im">import</span> geopandas <span class="im">as</span> gpd</span>
<span id="cb54-3"><a href="#cb54-3" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb54-4"><a href="#cb54-4" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb54-5"><a href="#cb54-5" tabindex="-1"></a><span class="im">import</span> requests</span>
<span id="cb54-6"><a href="#cb54-6" tabindex="-1"></a><span class="im">import</span> shapely</span></code></pre></div>
<div class="sourceCode" id="cb55"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb55-1"><a href="#cb55-1" tabindex="-1"></a>data_folder <span class="op">=</span> <span class="st">&#39;data&#39;</span></span>
<span id="cb55-2"><a href="#cb55-2" tabindex="-1"></a>output_folder <span class="op">=</span> <span class="st">&#39;output&#39;</span></span>
<span id="cb55-3"><a href="#cb55-3" tabindex="-1"></a></span>
<span id="cb55-4"><a href="#cb55-4" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> os.path.exists(data_folder):</span>
<span id="cb55-5"><a href="#cb55-5" tabindex="-1"></a>    os.mkdir(data_folder)</span>
<span id="cb55-6"><a href="#cb55-6" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> os.path.exists(output_folder):</span>
<span id="cb55-7"><a href="#cb55-7" tabindex="-1"></a>    os.mkdir(output_folder)</span></code></pre></div>
<div class="sourceCode" id="cb56"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb56-1"><a href="#cb56-1" tabindex="-1"></a><span class="kw">def</span> download(url):</span>
<span id="cb56-2"><a href="#cb56-2" tabindex="-1"></a>    filename <span class="op">=</span> os.path.join(data_folder, os.path.basename(url))</span>
<span id="cb56-3"><a href="#cb56-3" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> os.path.exists(filename):</span>
<span id="cb56-4"><a href="#cb56-4" tabindex="-1"></a>      <span class="cf">with</span> requests.get(url, stream<span class="op">=</span><span class="va">True</span>, allow_redirects<span class="op">=</span><span class="va">True</span>) <span class="im">as</span> r:</span>
<span id="cb56-5"><a href="#cb56-5" tabindex="-1"></a>          <span class="cf">with</span> <span class="bu">open</span>(filename, <span class="st">&#39;wb&#39;</span>) <span class="im">as</span> f:</span>
<span id="cb56-6"><a href="#cb56-6" tabindex="-1"></a>              <span class="cf">for</span> chunk <span class="kw">in</span> r.iter_content(chunk_size<span class="op">=</span><span class="dv">8192</span>):</span>
<span id="cb56-7"><a href="#cb56-7" tabindex="-1"></a>                  f.write(chunk)</span>
<span id="cb56-8"><a href="#cb56-8" tabindex="-1"></a>      <span class="bu">print</span>(<span class="st">&#39;Downloaded&#39;</span>, filename)</span></code></pre></div>
<div class="sourceCode" id="cb57"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb57-1"><a href="#cb57-1" tabindex="-1"></a>path_shapefile <span class="op">=</span> <span class="st">&#39;upath17&#39;</span></span>
<span id="cb57-2"><a href="#cb57-2" tabindex="-1"></a>umbra_shapefile <span class="op">=</span> <span class="st">&#39;umbra17&#39;</span></span>
<span id="cb57-3"><a href="#cb57-3" tabindex="-1"></a>penumbra_shapefile <span class="op">=</span> <span class="st">&#39;penum17&#39;</span></span>
<span id="cb57-4"><a href="#cb57-4" tabindex="-1"></a></span>
<span id="cb57-5"><a href="#cb57-5" tabindex="-1"></a>shapefile_exts <span class="op">=</span> [<span class="st">&#39;.shp&#39;</span>, <span class="st">&#39;.shx&#39;</span>, <span class="st">&#39;.dbf&#39;</span>, <span class="st">&#39;.prj&#39;</span>]</span>
<span id="cb57-6"><a href="#cb57-6" tabindex="-1"></a>data_url <span class="op">=</span> <span class="st">&#39;https://github.com/spatialthoughts/python-dataviz-web/releases/&#39;</span> \</span>
<span id="cb57-7"><a href="#cb57-7" tabindex="-1"></a>  <span class="st">&#39;download/eclipse/&#39;</span></span>
<span id="cb57-8"><a href="#cb57-8" tabindex="-1"></a></span>
<span id="cb57-9"><a href="#cb57-9" tabindex="-1"></a><span class="cf">for</span> shapefile <span class="kw">in</span> [path_shapefile, umbra_shapefile, penumbra_shapefile]:</span>
<span id="cb57-10"><a href="#cb57-10" tabindex="-1"></a>  <span class="cf">for</span> ext <span class="kw">in</span> shapefile_exts:</span>
<span id="cb57-11"><a href="#cb57-11" tabindex="-1"></a>    url <span class="op">=</span> data_url <span class="op">+</span> shapefile <span class="op">+</span> ext</span>
<span id="cb57-12"><a href="#cb57-12" tabindex="-1"></a>    download(url)</span></code></pre></div>
</div>
<div id="data-pre-processing-1" class="section level2">
<h2>Data Pre-Processing</h2>
<div class="sourceCode" id="cb58"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb58-1"><a href="#cb58-1" tabindex="-1"></a>path_shapefile_path <span class="op">=</span> os.path.join(</span>
<span id="cb58-2"><a href="#cb58-2" tabindex="-1"></a>    data_folder, path_shapefile <span class="op">+</span> <span class="st">&#39;.shp&#39;</span>)</span>
<span id="cb58-3"><a href="#cb58-3" tabindex="-1"></a>path_gdf <span class="op">=</span> gpd.read_file(path_shapefile_path)</span>
<span id="cb58-4"><a href="#cb58-4" tabindex="-1"></a>path_gdf</span></code></pre></div>
<div class="sourceCode" id="cb59"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb59-1"><a href="#cb59-1" tabindex="-1"></a>umbra_shapefile_path <span class="op">=</span> os.path.join(</span>
<span id="cb59-2"><a href="#cb59-2" tabindex="-1"></a>    data_folder, umbra_shapefile <span class="op">+</span> <span class="st">&#39;.shp&#39;</span>)</span>
<span id="cb59-3"><a href="#cb59-3" tabindex="-1"></a>umbra_gdf <span class="op">=</span> gpd.read_file(umbra_shapefile_path)</span>
<span id="cb59-4"><a href="#cb59-4" tabindex="-1"></a>umbra_gdf[:<span class="dv">5</span>]</span></code></pre></div>
</div>
<div id="create-a-multi-layer-map" class="section level2">
<h2>Create a Multi-Layer Map</h2>
<p>We can show a GeoDataFrame using the <code>plot()</code> method.</p>
<div class="sourceCode" id="cb60"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb60-1"><a href="#cb60-1" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb60-2"><a href="#cb60-2" tabindex="-1"></a>fig.set_size_inches(<span class="dv">15</span>,<span class="dv">7</span>)</span>
<span id="cb60-3"><a href="#cb60-3" tabindex="-1"></a>path_gdf.plot(</span>
<span id="cb60-4"><a href="#cb60-4" tabindex="-1"></a>    ax<span class="op">=</span>ax,</span>
<span id="cb60-5"><a href="#cb60-5" tabindex="-1"></a>    facecolor<span class="op">=</span><span class="st">&#39;#969696&#39;</span>,</span>
<span id="cb60-6"><a href="#cb60-6" tabindex="-1"></a>    edgecolor<span class="op">=</span><span class="st">&#39;none&#39;</span>,</span>
<span id="cb60-7"><a href="#cb60-7" tabindex="-1"></a>    alpha<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb60-8"><a href="#cb60-8" tabindex="-1"></a>plt.show()</span></code></pre></div>
<p>To add another layer to our plot, we can simply render another
GeoDataFrame on the same Axes.</p>
<div class="sourceCode" id="cb61"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb61-1"><a href="#cb61-1" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb61-2"><a href="#cb61-2" tabindex="-1"></a>fig.set_size_inches(<span class="dv">15</span>,<span class="dv">7</span>)</span>
<span id="cb61-3"><a href="#cb61-3" tabindex="-1"></a>path_gdf.plot(</span>
<span id="cb61-4"><a href="#cb61-4" tabindex="-1"></a>    ax<span class="op">=</span>ax,</span>
<span id="cb61-5"><a href="#cb61-5" tabindex="-1"></a>    facecolor<span class="op">=</span><span class="st">&#39;#969696&#39;</span>,</span>
<span id="cb61-6"><a href="#cb61-6" tabindex="-1"></a>    edgecolor<span class="op">=</span><span class="st">&#39;none&#39;</span>,</span>
<span id="cb61-7"><a href="#cb61-7" tabindex="-1"></a>    alpha<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb61-8"><a href="#cb61-8" tabindex="-1"></a></span>
<span id="cb61-9"><a href="#cb61-9" tabindex="-1"></a>umbra_gdf.plot(</span>
<span id="cb61-10"><a href="#cb61-10" tabindex="-1"></a>    ax<span class="op">=</span>ax,</span>
<span id="cb61-11"><a href="#cb61-11" tabindex="-1"></a>    facecolor<span class="op">=</span><span class="st">&#39;#252525&#39;</span>,</span>
<span id="cb61-12"><a href="#cb61-12" tabindex="-1"></a>    edgecolor<span class="op">=</span><span class="st">&#39;none&#39;</span>)</span>
<span id="cb61-13"><a href="#cb61-13" tabindex="-1"></a></span>
<span id="cb61-14"><a href="#cb61-14" tabindex="-1"></a>plt.show()</span></code></pre></div>
</div>
<div id="add-a-basemap" class="section level2">
<h2>Add A BaseMap</h2>
<p>The visualization is not useful as it is missing context. We want to
overlay this on a basemap to understand where the eclipse was visible
from. We can choose from a variety of basemap tiles. There are over 200
basemap styles included in the library. Let’s see them using the
<code>providers</code> property.</p>
<div class="sourceCode" id="cb62"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb62-1"><a href="#cb62-1" tabindex="-1"></a>providers <span class="op">=</span> cx.providers</span>
<span id="cb62-2"><a href="#cb62-2" tabindex="-1"></a>providers</span></code></pre></div>
<p>Some of the providers are open-access while others require
registration and obtaining an API key. We can filter the list to only
open-access providers.</p>
<div class="sourceCode" id="cb63"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb63-1"><a href="#cb63-1" tabindex="-1"></a>open_access_providers <span class="op">=</span> providers.<span class="bu">filter</span>(requires_token<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb63-2"><a href="#cb63-2" tabindex="-1"></a>open_access_providers</span></code></pre></div>
<p>For overlaying the eclipse path, let’s use the <em>OpenTopoMap</em>
basemap. We need to specify a CRS for the map. For now, let’s use the
CRS of the original shapefile.</p>
<div class="sourceCode" id="cb64"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb64-1"><a href="#cb64-1" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb64-2"><a href="#cb64-2" tabindex="-1"></a>fig.set_size_inches(<span class="dv">15</span>,<span class="dv">7</span>)</span>
<span id="cb64-3"><a href="#cb64-3" tabindex="-1"></a></span>
<span id="cb64-4"><a href="#cb64-4" tabindex="-1"></a>path_gdf.plot(</span>
<span id="cb64-5"><a href="#cb64-5" tabindex="-1"></a>    ax<span class="op">=</span>ax,</span>
<span id="cb64-6"><a href="#cb64-6" tabindex="-1"></a>    facecolor<span class="op">=</span><span class="st">&#39;#969696&#39;</span>,</span>
<span id="cb64-7"><a href="#cb64-7" tabindex="-1"></a>    edgecolor<span class="op">=</span><span class="st">&#39;none&#39;</span>,</span>
<span id="cb64-8"><a href="#cb64-8" tabindex="-1"></a>    alpha<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb64-9"><a href="#cb64-9" tabindex="-1"></a></span>
<span id="cb64-10"><a href="#cb64-10" tabindex="-1"></a>umbra_gdf.plot(</span>
<span id="cb64-11"><a href="#cb64-11" tabindex="-1"></a>    ax<span class="op">=</span>ax,</span>
<span id="cb64-12"><a href="#cb64-12" tabindex="-1"></a>    facecolor<span class="op">=</span><span class="st">&#39;#252525&#39;</span>,</span>
<span id="cb64-13"><a href="#cb64-13" tabindex="-1"></a>    edgecolor<span class="op">=</span><span class="st">&#39;none&#39;</span>)</span>
<span id="cb64-14"><a href="#cb64-14" tabindex="-1"></a></span>
<span id="cb64-15"><a href="#cb64-15" tabindex="-1"></a>cx.add_basemap(</span>
<span id="cb64-16"><a href="#cb64-16" tabindex="-1"></a>    ax,</span>
<span id="cb64-17"><a href="#cb64-17" tabindex="-1"></a>    crs<span class="op">=</span>path_gdf.crs,</span>
<span id="cb64-18"><a href="#cb64-18" tabindex="-1"></a>    source<span class="op">=</span>cx.providers.OpenTopoMap)</span>
<span id="cb64-19"><a href="#cb64-19" tabindex="-1"></a></span>
<span id="cb64-20"><a href="#cb64-20" tabindex="-1"></a>plt.show()</span></code></pre></div>
<p>We can request higher resolution tiles by specifying the
<code>zoom</code> parameter. But increasing zoom level means many more
tiles need to be downloaded. Contextily has some utility functions to
find out the zoom level and corresponding tiles that needs to be
downloaded.</p>
<div class="sourceCode" id="cb65"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb65-1"><a href="#cb65-1" tabindex="-1"></a>zoom_level <span class="op">=</span> cx.tile._calculate_zoom(<span class="op">*</span>path_gdf.total_bounds)</span>
<span id="cb65-2"><a href="#cb65-2" tabindex="-1"></a>zoom_level</span></code></pre></div>
<div class="sourceCode" id="cb66"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb66-1"><a href="#cb66-1" tabindex="-1"></a>cx.howmany(<span class="op">*</span>path_gdf.total_bounds, <span class="dv">4</span>, ll<span class="op">=</span><span class="va">True</span>)</span></code></pre></div>
<div class="sourceCode" id="cb67"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb67-1"><a href="#cb67-1" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb67-2"><a href="#cb67-2" tabindex="-1"></a>fig.set_size_inches(<span class="dv">15</span>,<span class="dv">7</span>)</span>
<span id="cb67-3"><a href="#cb67-3" tabindex="-1"></a></span>
<span id="cb67-4"><a href="#cb67-4" tabindex="-1"></a>path_gdf.plot(</span>
<span id="cb67-5"><a href="#cb67-5" tabindex="-1"></a>    ax<span class="op">=</span>ax,</span>
<span id="cb67-6"><a href="#cb67-6" tabindex="-1"></a>    facecolor<span class="op">=</span><span class="st">&#39;#969696&#39;</span>,</span>
<span id="cb67-7"><a href="#cb67-7" tabindex="-1"></a>    edgecolor<span class="op">=</span><span class="st">&#39;none&#39;</span>,</span>
<span id="cb67-8"><a href="#cb67-8" tabindex="-1"></a>    alpha<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb67-9"><a href="#cb67-9" tabindex="-1"></a></span>
<span id="cb67-10"><a href="#cb67-10" tabindex="-1"></a>umbra_gdf.plot(</span>
<span id="cb67-11"><a href="#cb67-11" tabindex="-1"></a>    ax<span class="op">=</span>ax,</span>
<span id="cb67-12"><a href="#cb67-12" tabindex="-1"></a>    facecolor<span class="op">=</span><span class="st">&#39;#252525&#39;</span>,</span>
<span id="cb67-13"><a href="#cb67-13" tabindex="-1"></a>    edgecolor<span class="op">=</span><span class="st">&#39;none&#39;</span>)</span>
<span id="cb67-14"><a href="#cb67-14" tabindex="-1"></a></span>
<span id="cb67-15"><a href="#cb67-15" tabindex="-1"></a>cx.add_basemap(</span>
<span id="cb67-16"><a href="#cb67-16" tabindex="-1"></a>    ax,</span>
<span id="cb67-17"><a href="#cb67-17" tabindex="-1"></a>    crs<span class="op">=</span>path_gdf.crs,</span>
<span id="cb67-18"><a href="#cb67-18" tabindex="-1"></a>    source<span class="op">=</span>cx.providers.OpenTopoMap,</span>
<span id="cb67-19"><a href="#cb67-19" tabindex="-1"></a>    zoom<span class="op">=</span><span class="dv">4</span>)</span>
<span id="cb67-20"><a href="#cb67-20" tabindex="-1"></a></span>
<span id="cb67-21"><a href="#cb67-21" tabindex="-1"></a>plt.show()</span></code></pre></div>
<p>As this eclipse primarily covers the United States, we can create a
visualization in a CRS suited for the region. We reproject the layers to
the US National Atlas Equal Area projection and set the map extent to
the bounds of the continental united states.</p>
<div class="sourceCode" id="cb68"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb68-1"><a href="#cb68-1" tabindex="-1"></a>crs <span class="op">=</span> <span class="st">&#39;EPSG:9311&#39;</span></span>
<span id="cb68-2"><a href="#cb68-2" tabindex="-1"></a></span>
<span id="cb68-3"><a href="#cb68-3" tabindex="-1"></a>path_reprojected <span class="op">=</span> path_gdf.to_crs(crs)</span>
<span id="cb68-4"><a href="#cb68-4" tabindex="-1"></a>umbra_reprojected <span class="op">=</span> umbra_gdf.to_crs(crs)</span>
<span id="cb68-5"><a href="#cb68-5" tabindex="-1"></a></span>
<span id="cb68-6"><a href="#cb68-6" tabindex="-1"></a><span class="co"># Use the bounding box coordinates for continental us</span></span>
<span id="cb68-7"><a href="#cb68-7" tabindex="-1"></a>usa <span class="op">=</span> shapely.geometry.box(<span class="op">-</span><span class="dv">125</span>, <span class="dv">24</span>, <span class="op">-</span><span class="dv">66</span>, <span class="dv">49</span>)</span>
<span id="cb68-8"><a href="#cb68-8" tabindex="-1"></a>usa_gdf <span class="op">=</span> gpd.GeoDataFrame(geometry<span class="op">=</span>[usa], crs<span class="op">=</span><span class="st">&#39;EPSG:4326&#39;</span>)</span>
<span id="cb68-9"><a href="#cb68-9" tabindex="-1"></a>usa_gdf_reprojected <span class="op">=</span> usa_gdf.to_crs(crs)</span>
<span id="cb68-10"><a href="#cb68-10" tabindex="-1"></a>bounds <span class="op">=</span> usa_gdf_reprojected.total_bounds</span></code></pre></div>
<div class="sourceCode" id="cb69"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb69-1"><a href="#cb69-1" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb69-2"><a href="#cb69-2" tabindex="-1"></a>fig.set_size_inches(<span class="dv">15</span>,<span class="dv">7</span>)</span>
<span id="cb69-3"><a href="#cb69-3" tabindex="-1"></a></span>
<span id="cb69-4"><a href="#cb69-4" tabindex="-1"></a><span class="co"># Set the bounds</span></span>
<span id="cb69-5"><a href="#cb69-5" tabindex="-1"></a>ax.set_xlim(bounds[<span class="dv">0</span>], bounds[<span class="dv">2</span>])</span>
<span id="cb69-6"><a href="#cb69-6" tabindex="-1"></a>ax.set_ylim(bounds[<span class="dv">1</span>], bounds[<span class="dv">3</span>])</span>
<span id="cb69-7"><a href="#cb69-7" tabindex="-1"></a></span>
<span id="cb69-8"><a href="#cb69-8" tabindex="-1"></a>path_reprojected.plot(</span>
<span id="cb69-9"><a href="#cb69-9" tabindex="-1"></a>    ax<span class="op">=</span>ax,</span>
<span id="cb69-10"><a href="#cb69-10" tabindex="-1"></a>    facecolor<span class="op">=</span><span class="st">&#39;#969696&#39;</span>,</span>
<span id="cb69-11"><a href="#cb69-11" tabindex="-1"></a>    edgecolor<span class="op">=</span><span class="st">&#39;none&#39;</span>,</span>
<span id="cb69-12"><a href="#cb69-12" tabindex="-1"></a>    alpha<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb69-13"><a href="#cb69-13" tabindex="-1"></a></span>
<span id="cb69-14"><a href="#cb69-14" tabindex="-1"></a>umbra_reprojected.plot(</span>
<span id="cb69-15"><a href="#cb69-15" tabindex="-1"></a>    ax<span class="op">=</span>ax,</span>
<span id="cb69-16"><a href="#cb69-16" tabindex="-1"></a>    facecolor<span class="op">=</span><span class="st">&#39;#252525&#39;</span>,</span>
<span id="cb69-17"><a href="#cb69-17" tabindex="-1"></a>    edgecolor<span class="op">=</span><span class="st">&#39;none&#39;</span>)</span>
<span id="cb69-18"><a href="#cb69-18" tabindex="-1"></a></span>
<span id="cb69-19"><a href="#cb69-19" tabindex="-1"></a>cx.add_basemap(</span>
<span id="cb69-20"><a href="#cb69-20" tabindex="-1"></a>    ax,</span>
<span id="cb69-21"><a href="#cb69-21" tabindex="-1"></a>    crs<span class="op">=</span>path_reprojected.crs,</span>
<span id="cb69-22"><a href="#cb69-22" tabindex="-1"></a>    source<span class="op">=</span>cx.providers.OpenTopoMap,</span>
<span id="cb69-23"><a href="#cb69-23" tabindex="-1"></a>    zoom<span class="op">=</span><span class="dv">5</span>)</span>
<span id="cb69-24"><a href="#cb69-24" tabindex="-1"></a></span>
<span id="cb69-25"><a href="#cb69-25" tabindex="-1"></a>ax.set_axis_off()</span>
<span id="cb69-26"><a href="#cb69-26" tabindex="-1"></a>ax.set_title(<span class="st">&#39;2017 Total Solar Eclipse Path&#39;</span>, size <span class="op">=</span> <span class="dv">18</span>)</span>
<span id="cb69-27"><a href="#cb69-27" tabindex="-1"></a></span>
<span id="cb69-28"><a href="#cb69-28" tabindex="-1"></a>plt.show()</span></code></pre></div>
<p><img
src="python-dataviz-output/04_using_basemaps_files/04_using_basemaps_29_0.png" /></p>
</div>
<div id="exercise-3" class="section level2">
<h2>Exercise</h2>
<ol style="list-style-type: decimal">
<li>Our eclipse dataset also contains polygons for penumbra contours.
Add them to the visualization. This layer has a column
<code>Obscur</code> that contains the obscuration value (the fraction of
the Sun’s area covered by the Moon). Style the contours by the
obscuration value and add it to the map.</li>
<li>Instead of the OpenTopoMap, create a visualization using another
basemap. Some options to try are <code>Esri.WorldTerrain</code>,
<code>CartoDB.Positron</code> and <code>USGS.USTopo</code>.</li>
</ol>
<p><img src='https://courses.spatialthoughts.com/images/python_dataviz/eclipse_path.png' width=800/></p>
<p>The code below reads and re-projects the penumbra shapefile.</p>
<div class="sourceCode" id="cb70"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb70-1"><a href="#cb70-1" tabindex="-1"></a>penumbra_shapefile_path <span class="op">=</span> os.path.join(</span>
<span id="cb70-2"><a href="#cb70-2" tabindex="-1"></a>    data_folder, penumbra_shapefile <span class="op">+</span> <span class="st">&#39;.shp&#39;</span>)</span>
<span id="cb70-3"><a href="#cb70-3" tabindex="-1"></a>penumbra_gdf <span class="op">=</span> gpd.read_file(penumbra_shapefile_path)</span>
<span id="cb70-4"><a href="#cb70-4" tabindex="-1"></a>penumbra_reprojected <span class="op">=</span> penumbra_gdf.to_crs(crs)</span>
<span id="cb70-5"><a href="#cb70-5" tabindex="-1"></a>penumbra_reprojected</span></code></pre></div>
<p>You can use the code block below for creating the visualization. It
render the Penumbra polygons by the <code>Obsur</code> column using a
transparency value of <code>0.2</code> (20%). Complete the exercise by
rendering the Path and Umbra layers on top and add a basemap of your
choice.</p>
<div class="sourceCode" id="cb71"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb71-1"><a href="#cb71-1" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb71-2"><a href="#cb71-2" tabindex="-1"></a>fig.set_size_inches(<span class="dv">15</span>,<span class="dv">7</span>)</span>
<span id="cb71-3"><a href="#cb71-3" tabindex="-1"></a></span>
<span id="cb71-4"><a href="#cb71-4" tabindex="-1"></a><span class="co"># Set the bounds</span></span>
<span id="cb71-5"><a href="#cb71-5" tabindex="-1"></a>ax.set_xlim(bounds[<span class="dv">0</span>], bounds[<span class="dv">2</span>])</span>
<span id="cb71-6"><a href="#cb71-6" tabindex="-1"></a>ax.set_ylim(bounds[<span class="dv">1</span>], bounds[<span class="dv">3</span>])</span>
<span id="cb71-7"><a href="#cb71-7" tabindex="-1"></a></span>
<span id="cb71-8"><a href="#cb71-8" tabindex="-1"></a>penumbra_reprojected.plot(</span>
<span id="cb71-9"><a href="#cb71-9" tabindex="-1"></a>    ax<span class="op">=</span>ax,</span>
<span id="cb71-10"><a href="#cb71-10" tabindex="-1"></a>    column<span class="op">=</span><span class="st">&#39;Obscur&#39;</span>,</span>
<span id="cb71-11"><a href="#cb71-11" tabindex="-1"></a>    cmap<span class="op">=</span><span class="st">&#39;Greys&#39;</span>,</span>
<span id="cb71-12"><a href="#cb71-12" tabindex="-1"></a>    linewidth<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb71-13"><a href="#cb71-13" tabindex="-1"></a>    alpha<span class="op">=</span><span class="fl">0.2</span></span>
<span id="cb71-14"><a href="#cb71-14" tabindex="-1"></a>)</span>
<span id="cb71-15"><a href="#cb71-15" tabindex="-1"></a></span>
<span id="cb71-16"><a href="#cb71-16" tabindex="-1"></a>ax.set_axis_off()</span>
<span id="cb71-17"><a href="#cb71-17" tabindex="-1"></a>ax.set_title(<span class="st">&#39;2017 Total Solar Eclipse Path&#39;</span>, size <span class="op">=</span> <span class="dv">18</span>)</span>
<span id="cb71-18"><a href="#cb71-18" tabindex="-1"></a></span>
<span id="cb71-19"><a href="#cb71-19" tabindex="-1"></a>plt.show()</span></code></pre></div>
<hr />
</div>
</div>
<div id="xarray-basics" class="section level1">
<h1>XArray Basics</h1>
<p><a
href="https://www.youtube.com/watch?v=ikR4SAQt2sY&amp;list=PLppGmFLhQ1HLzGl8auwYkdUMu_z0Hz7G6&amp;index=9"
target="_blank"><img
src="https://img.youtube.com/vi/ikR4SAQt2sY/mqdefault.jpg"
alt="Watch the Video" /></a></p>
<p><a
href="https://www.youtube.com/watch?v=ikR4SAQt2sY&amp;list=PLppGmFLhQ1HLzGl8auwYkdUMu_z0Hz7G6&amp;index=9"
target="_blank">Watch the Video ↗</a></p>
<p><a
href="https://docs.google.com/presentation/d/1k6mVu-u2Fq5OuAB8WJWngRh2GcTAst1SfripWrHo0J0/edit?usp=sharing"
target="_blank">View the Presentation ↗</a></p>
<p><a
href="https://colab.research.google.com/github/spatialthoughts/python-dataviz-web/blob/main/05_xarray_basics.ipynb"><img
src="https://colab.research.google.com/assets/colab-badge.svg"
alt="Open In Colab" /></a></p>
<div id="overview-3" class="section level2">
<h2>Overview</h2>
<p>Xarray is an evolution of rasterio and is inspired by libraries like
pandas to work with raster datasets. It is particularly suited for
working with multi-dimensional time-series raster datasets. It also
integrates tightly with dask that allows one to scale raster data
processing using parallel computing. XArray provides <a
href="https://xarray.pydata.org/en/stable/user-guide/plotting.html">Plotting
Functions</a> based on Matplotlib.</p>
<p>In this section, we will learn about XArray basics and learn how to
work with a time-series of Sentinel-2 satellite imagery to create and
visualize a median composite image.</p>
</div>
<div id="setup-and-data-download-3" class="section level2">
<h2>Setup and Data Download</h2>
<p>The following blocks of code will install the required packages and
download the datasets to your Colab environment.</p>
<div class="sourceCode" id="cb72"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb72-1"><a href="#cb72-1" tabindex="-1"></a><span class="op">%%</span>capture</span>
<span id="cb72-2"><a href="#cb72-2" tabindex="-1"></a><span class="cf">if</span> <span class="st">&#39;google.colab&#39;</span> <span class="kw">in</span> <span class="bu">str</span>(get_ipython()):</span>
<span id="cb72-3"><a href="#cb72-3" tabindex="-1"></a>    <span class="op">!</span>pip install pystac<span class="op">-</span>client odc<span class="op">-</span>stac rioxarray dask</span></code></pre></div>
<div class="sourceCode" id="cb73"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb73-1"><a href="#cb73-1" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb73-2"><a href="#cb73-2" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb73-3"><a href="#cb73-3" tabindex="-1"></a><span class="im">import</span> pystac_client</span>
<span id="cb73-4"><a href="#cb73-4" tabindex="-1"></a><span class="im">from</span> odc.stac <span class="im">import</span> stac_load</span>
<span id="cb73-5"><a href="#cb73-5" tabindex="-1"></a><span class="im">import</span> xarray <span class="im">as</span> xr</span>
<span id="cb73-6"><a href="#cb73-6" tabindex="-1"></a><span class="im">import</span> rioxarray <span class="im">as</span> rxr</span></code></pre></div>
<div class="sourceCode" id="cb74"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb74-1"><a href="#cb74-1" tabindex="-1"></a>data_folder <span class="op">=</span> <span class="st">&#39;data&#39;</span></span>
<span id="cb74-2"><a href="#cb74-2" tabindex="-1"></a>output_folder <span class="op">=</span> <span class="st">&#39;output&#39;</span></span>
<span id="cb74-3"><a href="#cb74-3" tabindex="-1"></a></span>
<span id="cb74-4"><a href="#cb74-4" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> os.path.exists(data_folder):</span>
<span id="cb74-5"><a href="#cb74-5" tabindex="-1"></a>    os.mkdir(data_folder)</span>
<span id="cb74-6"><a href="#cb74-6" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> os.path.exists(output_folder):</span>
<span id="cb74-7"><a href="#cb74-7" tabindex="-1"></a>    os.mkdir(output_folder)</span></code></pre></div>
</div>
<div id="get-satellite-imagery-using-stac-api" class="section level2">
<h2>Get Satellite Imagery using STAC API</h2>
<p>We define a location and time of interest to get some satellite
imagery.</p>
<div class="sourceCode" id="cb75"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb75-1"><a href="#cb75-1" tabindex="-1"></a>latitude <span class="op">=</span> <span class="fl">27.163</span></span>
<span id="cb75-2"><a href="#cb75-2" tabindex="-1"></a>longitude <span class="op">=</span> <span class="fl">82.608</span></span>
<span id="cb75-3"><a href="#cb75-3" tabindex="-1"></a>year <span class="op">=</span> <span class="dv">2023</span></span></code></pre></div>
<p>Let’s use Element84 search endpoint to look for items from the
sentinel-2-l2a collection on AWS.</p>
<div class="sourceCode" id="cb76"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb76-1"><a href="#cb76-1" tabindex="-1"></a>catalog <span class="op">=</span> pystac_client.Client.<span class="bu">open</span>(</span>
<span id="cb76-2"><a href="#cb76-2" tabindex="-1"></a>    <span class="st">&#39;https://earth-search.aws.element84.com/v1&#39;</span>)</span>
<span id="cb76-3"><a href="#cb76-3" tabindex="-1"></a></span>
<span id="cb76-4"><a href="#cb76-4" tabindex="-1"></a><span class="co"># Define a small bounding box around the chosen point</span></span>
<span id="cb76-5"><a href="#cb76-5" tabindex="-1"></a>km2deg <span class="op">=</span> <span class="fl">1.0</span> <span class="op">/</span> <span class="dv">111</span></span>
<span id="cb76-6"><a href="#cb76-6" tabindex="-1"></a>x, y <span class="op">=</span> (longitude, latitude)</span>
<span id="cb76-7"><a href="#cb76-7" tabindex="-1"></a>r <span class="op">=</span> <span class="dv">1</span> <span class="op">*</span> km2deg  <span class="co"># radius in degrees</span></span>
<span id="cb76-8"><a href="#cb76-8" tabindex="-1"></a>bbox <span class="op">=</span> (x <span class="op">-</span> r, y <span class="op">-</span> r, x <span class="op">+</span> r, y <span class="op">+</span> r)</span>
<span id="cb76-9"><a href="#cb76-9" tabindex="-1"></a></span>
<span id="cb76-10"><a href="#cb76-10" tabindex="-1"></a>search <span class="op">=</span> catalog.search(</span>
<span id="cb76-11"><a href="#cb76-11" tabindex="-1"></a>    collections<span class="op">=</span>[<span class="st">&#39;sentinel-2-c1-l2a&#39;</span>],</span>
<span id="cb76-12"><a href="#cb76-12" tabindex="-1"></a>    bbox<span class="op">=</span>bbox,</span>
<span id="cb76-13"><a href="#cb76-13" tabindex="-1"></a>    datetime<span class="op">=</span><span class="ss">f&#39;</span><span class="sc">{</span>year<span class="sc">}</span><span class="ss">&#39;</span>,</span>
<span id="cb76-14"><a href="#cb76-14" tabindex="-1"></a>    query<span class="op">=</span>{<span class="st">&#39;eo:cloud_cover&#39;</span>: {<span class="st">&#39;lt&#39;</span>: <span class="dv">30</span>}},</span>
<span id="cb76-15"><a href="#cb76-15" tabindex="-1"></a>)</span>
<span id="cb76-16"><a href="#cb76-16" tabindex="-1"></a>items <span class="op">=</span> search.item_collection()</span></code></pre></div>
<p>Load the matching images as a XArray Dataset.</p>
<div class="sourceCode" id="cb77"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb77-1"><a href="#cb77-1" tabindex="-1"></a>ds <span class="op">=</span> stac_load(</span>
<span id="cb77-2"><a href="#cb77-2" tabindex="-1"></a>    items,</span>
<span id="cb77-3"><a href="#cb77-3" tabindex="-1"></a>    bands<span class="op">=</span>[<span class="st">&#39;red&#39;</span>, <span class="st">&#39;green&#39;</span>, <span class="st">&#39;blue&#39;</span>, <span class="st">&#39;nir&#39;</span>],</span>
<span id="cb77-4"><a href="#cb77-4" tabindex="-1"></a>    resolution<span class="op">=</span><span class="dv">10</span>,</span>
<span id="cb77-5"><a href="#cb77-5" tabindex="-1"></a>    bbox<span class="op">=</span>bbox,</span>
<span id="cb77-6"><a href="#cb77-6" tabindex="-1"></a>    chunks<span class="op">=</span>{},  <span class="co"># &lt;-- use Dask</span></span>
<span id="cb77-7"><a href="#cb77-7" tabindex="-1"></a>    groupby<span class="op">=</span><span class="st">&#39;solar_day&#39;</span>,</span>
<span id="cb77-8"><a href="#cb77-8" tabindex="-1"></a>)</span>
<span id="cb77-9"><a href="#cb77-9" tabindex="-1"></a>ds</span></code></pre></div>
<div class="sourceCode" id="cb78"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb78-1"><a href="#cb78-1" tabindex="-1"></a><span class="op">%%</span>time</span>
<span id="cb78-2"><a href="#cb78-2" tabindex="-1"></a>ds <span class="op">=</span> ds.compute()</span></code></pre></div>
</div>
<div id="xarray-terminology" class="section level2">
<h2>XArray Terminology</h2>
<p>We now have a <code>xarray.Dataset</code> object. Let’s understand
what is contained in a Dataset.</p>
<ul>
<li><em>Variables</em>: This is similar to a band in a raster dataset.
Each variable contains an array of values.</li>
<li><em>Dimensions</em>: This is similar to number of array axes.</li>
<li><em>Coordinates</em>: These are the labels for values in each
dimension.</li>
<li><em>Attributes</em>: This is the metadata associated with the
dataset.</li>
</ul>
<p><img src='https://courses.spatialthoughts.com/images/python_dataviz/xarray_terminology.png' width=800/></p>
<p>A Dataset consists of one or more <code>xarray.DataArray</code>
object. This is the main object that consists of a single variable with
dimension names, coordinates and attributes. You can access each
variable using <code>dataset.variable_name</code> syntax.</p>
<div class="sourceCode" id="cb79"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb79-1"><a href="#cb79-1" tabindex="-1"></a>da <span class="op">=</span> ds.red</span>
<span id="cb79-2"><a href="#cb79-2" tabindex="-1"></a>da</span></code></pre></div>
</div>
<div id="selecting-data" class="section level2">
<h2>Selecting Data</h2>
<p>XArray provides a very powerful way to select subsets of data, using
similar framework as Pandas. Similar to Panda’s <code>loc</code> and
<code>iloc</code> methods, XArray provides <code>sel</code> and
<code>isel</code> methods. Since DataArray dimensions have names, these
methods allow you to specify which dimension to query.</p>
<p>Let’s select the temperature anomany values for the last time step.
Since we know the index (-1) of the datam we can use <code>isel</code>
method.</p>
<div class="sourceCode" id="cb80"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb80-1"><a href="#cb80-1" tabindex="-1"></a>da.isel(time<span class="op">=-</span><span class="dv">1</span>)</span></code></pre></div>
<p>You can call <code>.values</code> on a DataArray to get an array of
the values.</p>
<div class="sourceCode" id="cb81"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb81-1"><a href="#cb81-1" tabindex="-1"></a>da.isel(time<span class="op">=-</span><span class="dv">1</span>).values</span></code></pre></div>
<p>You can query for a values at using multiple dimensions.</p>
<div class="sourceCode" id="cb82"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb82-1"><a href="#cb82-1" tabindex="-1"></a>da.isel(time<span class="op">=-</span><span class="dv">1</span>, x<span class="op">=-</span><span class="dv">1</span>, y<span class="op">=-</span><span class="dv">1</span>).values</span></code></pre></div>
<p>We can also specify a value to query using the <code>sel()</code>
method.</p>
<p>Let’s see what are the values of <code>time</code> variable.</p>
<div class="sourceCode" id="cb83"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb83-1"><a href="#cb83-1" tabindex="-1"></a>dates <span class="op">=</span> da.time.values</span>
<span id="cb83-2"><a href="#cb83-2" tabindex="-1"></a>dates</span></code></pre></div>
<p>We can query using the value of a coordinate using the
<code>sel()</code> method.</p>
<div class="sourceCode" id="cb84"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb84-1"><a href="#cb84-1" tabindex="-1"></a>da.sel(time<span class="op">=</span><span class="st">&#39;2023-12-16&#39;</span>)</span></code></pre></div>
<p>The <code>sel()</code> method also support nearest neighbor lookups.
This is useful when you do not know the exact label of the dimension,
but want to find the closest one.</p>
<blockquote>
<p>Tip: You can use <code>interp()</code> instead of <code>sel()</code>
to interpolate the value instead of closest lookup.</p>
</blockquote>
<div class="sourceCode" id="cb85"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb85-1"><a href="#cb85-1" tabindex="-1"></a>da.sel(time<span class="op">=</span><span class="st">&#39;2023-01-01&#39;</span>, method<span class="op">=</span><span class="st">&#39;nearest&#39;</span>)</span></code></pre></div>
<p>The <code>sel()</code> method also allows specifying range of values
using Python’s built-in <code>slice()</code> function. The code below
will select all observations during January 2023.</p>
<div class="sourceCode" id="cb86"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb86-1"><a href="#cb86-1" tabindex="-1"></a>da.sel(time<span class="op">=</span><span class="bu">slice</span>(<span class="st">&#39;2023-01-01&#39;</span>, <span class="st">&#39;2023-01-31&#39;</span>))</span></code></pre></div>
</div>
<div id="aggregating-data" class="section level2">
<h2>Aggregating Data</h2>
<p>A very-powerful feature of XArray is the ability to easily aggregate
data across dimensions - making it ideal for many remote sensing
analysis. Let’s create a median composite from all the individual
images.</p>
<p>We apply the <code>.median()</code> aggregation across the
<code>time</code> dimension.</p>
<div class="sourceCode" id="cb87"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb87-1"><a href="#cb87-1" tabindex="-1"></a>median <span class="op">=</span> ds.median(dim<span class="op">=</span><span class="st">&#39;time&#39;</span>)</span>
<span id="cb87-2"><a href="#cb87-2" tabindex="-1"></a>median</span></code></pre></div>
</div>
<div id="visualizing-data" class="section level2">
<h2>Visualizing Data</h2>
<p>XArray provides a <code>plot.imshow()</code> method based on
Matplotlib to plot DataArrays.</p>
<p>Reference : <a
href="https://docs.xarray.dev/en/stable/generated/xarray.plot.imshow.html">xarray.plot.imshow</a></p>
<p>To visualize our Dataset, we first convert it to a DataArray using
the <code>to_array()</code> method. All the variables will be converted
to a new dimension. Since our variables are image bands, we give the
name of the new dimesion as <code>band</code>.</p>
<div class="sourceCode" id="cb88"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb88-1"><a href="#cb88-1" tabindex="-1"></a>median_da <span class="op">=</span> median.to_array(<span class="st">&#39;band&#39;</span>)</span>
<span id="cb88-2"><a href="#cb88-2" tabindex="-1"></a>median_da</span></code></pre></div>
<p>The easy way to visualize the data without the outliers is to pass
the parameter <code>robust=True</code>. This will use the 2nd and 98th
percentiles of the data to compute the color limits. We also specify the
<code>set_aspect('equal')</code> to ensure the original aspect ratio is
maintained and the image is not stretched.</p>
<div class="sourceCode" id="cb89"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb89-1"><a href="#cb89-1" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb89-2"><a href="#cb89-2" tabindex="-1"></a>fig.set_size_inches(<span class="dv">5</span>,<span class="dv">5</span>)</span>
<span id="cb89-3"><a href="#cb89-3" tabindex="-1"></a>median_da.sel(band<span class="op">=</span>[<span class="st">&#39;red&#39;</span>, <span class="st">&#39;green&#39;</span>, <span class="st">&#39;blue&#39;</span>]).plot.imshow(</span>
<span id="cb89-4"><a href="#cb89-4" tabindex="-1"></a>    ax<span class="op">=</span>ax,</span>
<span id="cb89-5"><a href="#cb89-5" tabindex="-1"></a>    robust<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb89-6"><a href="#cb89-6" tabindex="-1"></a>ax.set_title(<span class="st">&#39;RGB Visualization&#39;</span>)</span>
<span id="cb89-7"><a href="#cb89-7" tabindex="-1"></a>ax.set_axis_off()</span>
<span id="cb89-8"><a href="#cb89-8" tabindex="-1"></a>ax.set_aspect(<span class="st">&#39;equal&#39;</span>)</span>
<span id="cb89-9"><a href="#cb89-9" tabindex="-1"></a>plt.show()</span></code></pre></div>
<p><img
src="python-dataviz-output/05_xarray_basics_files/05_xarray_basics_41_0.png" /></p>
<p>We can save the resulting median compositeas a multi-band GeoTIFF
file.</p>
<div class="sourceCode" id="cb90"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb90-1"><a href="#cb90-1" tabindex="-1"></a>output_file <span class="op">=</span> <span class="st">&#39;median_composite.tif&#39;</span></span>
<span id="cb90-2"><a href="#cb90-2" tabindex="-1"></a>output_file_path <span class="op">=</span> os.path.join(output_folder, output_file)</span>
<span id="cb90-3"><a href="#cb90-3" tabindex="-1"></a>median_da.rio.to_raster(output_file_path, compress<span class="op">=</span><span class="st">&#39;LZW&#39;</span>)</span></code></pre></div>
</div>
<div id="exercise-4" class="section level2">
<h2>Exercise</h2>
<p>Display the median composite for the month of May.</p>
<p>The snippet below takes our time-series and aggregate it to a monthly
median composites <code>groupby()</code> method.</p>
<div class="sourceCode" id="cb91"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb91-1"><a href="#cb91-1" tabindex="-1"></a>monthly <span class="op">=</span> ds.groupby(<span class="st">&#39;time.month&#39;</span>).median(dim<span class="op">=</span><span class="st">&#39;time&#39;</span>)</span>
<span id="cb91-2"><a href="#cb91-2" tabindex="-1"></a>monthly</span></code></pre></div>
<p>You now have a new dimension named <code>month</code>. Start your
exercise by first converting the Dataset to a DataArray. Then extract
the data for the chosen month using <code>sel()</code> method and plot
it.</p>
<hr />
</div>
</div>
<div id="mapping-gridded-datasets" class="section level1">
<h1>Mapping Gridded Datasets</h1>
<p><a
href="https://colab.research.google.com/github/spatialthoughts/python-dataviz-web/blob/main/06_mapping_gridded_datasets.ipynb"><img
src="https://colab.research.google.com/assets/colab-badge.svg"
alt="Open In Colab" /></a></p>
<div id="overview-4" class="section level2">
<h2>Overview</h2>
<p>In this section, we will take the <a
href="https://data.giss.nasa.gov/gistemp/">Gridded Monthly Temperature
Anomaly Data</a> from 1880-present from GISTEMP and visualize the
temperature anomaly for any year.</p>
</div>
<div id="setup-and-data-download-4" class="section level2">
<h2>Setup and Data Download</h2>
<p>The following blocks of code will install the required packages and
download the datasets to your Colab environment.</p>
<div class="sourceCode" id="cb92"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb92-1"><a href="#cb92-1" tabindex="-1"></a><span class="op">%%</span>capture</span>
<span id="cb92-2"><a href="#cb92-2" tabindex="-1"></a><span class="cf">if</span> <span class="st">&#39;google.colab&#39;</span> <span class="kw">in</span> <span class="bu">str</span>(get_ipython()):</span>
<span id="cb92-3"><a href="#cb92-3" tabindex="-1"></a>  <span class="op">!</span>pip install cartopy netCDF4</span></code></pre></div>
<div class="sourceCode" id="cb93"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb93-1"><a href="#cb93-1" tabindex="-1"></a><span class="im">import</span> cartopy</span>
<span id="cb93-2"><a href="#cb93-2" tabindex="-1"></a><span class="im">import</span> cartopy.crs <span class="im">as</span> ccrs</span>
<span id="cb93-3"><a href="#cb93-3" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb93-4"><a href="#cb93-4" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb93-5"><a href="#cb93-5" tabindex="-1"></a><span class="im">import</span> xarray <span class="im">as</span> xr</span></code></pre></div>
<div class="sourceCode" id="cb94"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb94-1"><a href="#cb94-1" tabindex="-1"></a>data_folder <span class="op">=</span> <span class="st">&#39;data&#39;</span></span>
<span id="cb94-2"><a href="#cb94-2" tabindex="-1"></a>output_folder <span class="op">=</span> <span class="st">&#39;output&#39;</span></span>
<span id="cb94-3"><a href="#cb94-3" tabindex="-1"></a></span>
<span id="cb94-4"><a href="#cb94-4" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> os.path.exists(data_folder):</span>
<span id="cb94-5"><a href="#cb94-5" tabindex="-1"></a>    os.mkdir(data_folder)</span>
<span id="cb94-6"><a href="#cb94-6" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> os.path.exists(output_folder):</span>
<span id="cb94-7"><a href="#cb94-7" tabindex="-1"></a>    os.mkdir(output_folder)</span></code></pre></div>
<div class="sourceCode" id="cb95"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb95-1"><a href="#cb95-1" tabindex="-1"></a><span class="kw">def</span> download(url):</span>
<span id="cb95-2"><a href="#cb95-2" tabindex="-1"></a>    filename <span class="op">=</span> os.path.join(data_folder, os.path.basename(url))</span>
<span id="cb95-3"><a href="#cb95-3" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> os.path.exists(filename):</span>
<span id="cb95-4"><a href="#cb95-4" tabindex="-1"></a>        <span class="im">from</span> urllib.request <span class="im">import</span> urlretrieve</span>
<span id="cb95-5"><a href="#cb95-5" tabindex="-1"></a>        local, _ <span class="op">=</span> urlretrieve(url, filename)</span>
<span id="cb95-6"><a href="#cb95-6" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&#39;Downloaded &#39;</span> <span class="op">+</span> local)</span>
<span id="cb95-7"><a href="#cb95-7" tabindex="-1"></a></span>
<span id="cb95-8"><a href="#cb95-8" tabindex="-1"></a>filename <span class="op">=</span> <span class="st">&#39;gistemp1200_GHCNv4_ERSSTv5.nc&#39;</span></span>
<span id="cb95-9"><a href="#cb95-9" tabindex="-1"></a></span>
<span id="cb95-10"><a href="#cb95-10" tabindex="-1"></a>data_url <span class="op">=</span> <span class="st">&#39;https://github.com/spatialthoughts/python-dataviz-web/releases/&#39;</span> \</span>
<span id="cb95-11"><a href="#cb95-11" tabindex="-1"></a>  <span class="st">&#39;download/gistemp/&#39;</span></span>
<span id="cb95-12"><a href="#cb95-12" tabindex="-1"></a></span>
<span id="cb95-13"><a href="#cb95-13" tabindex="-1"></a>download(data_url <span class="op">+</span> filename)</span></code></pre></div>
</div>
<div id="data-pre-processing-2" class="section level2">
<h2>Data Pre-Processing</h2>
<p>We read the data using <code>XArray</code> and select the
<code>tempanomaly</code> variable.</p>
<div class="sourceCode" id="cb96"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb96-1"><a href="#cb96-1" tabindex="-1"></a>file_path <span class="op">=</span> os.path.join(data_folder, filename)</span>
<span id="cb96-2"><a href="#cb96-2" tabindex="-1"></a>ds <span class="op">=</span> xr.open_dataset(file_path)</span>
<span id="cb96-3"><a href="#cb96-3" tabindex="-1"></a>da <span class="op">=</span> ds.tempanomaly</span>
<span id="cb96-4"><a href="#cb96-4" tabindex="-1"></a>da</span></code></pre></div>
<p>We have monthly anomalies from 1880-present. Let’s aggregate it to
mean yealy anomalies.</p>
<div class="sourceCode" id="cb97"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb97-1"><a href="#cb97-1" tabindex="-1"></a>yearly <span class="op">=</span> da.groupby(<span class="st">&#39;time.year&#39;</span>).mean(dim<span class="op">=</span><span class="st">&#39;time&#39;</span>)</span>
<span id="cb97-2"><a href="#cb97-2" tabindex="-1"></a>yearly</span></code></pre></div>
</div>
<div id="plotting-using-matplotlib" class="section level2">
<h2>Plotting using Matplotlib</h2>
<p>Let’s extract the data for one of the years.</p>
<div class="sourceCode" id="cb98"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb98-1"><a href="#cb98-1" tabindex="-1"></a>year <span class="op">=</span> <span class="dv">2023</span></span></code></pre></div>
<p>We can use the <code>.sel()</code> method to query using the value of
the <code>year</code> dimension.</p>
<div class="sourceCode" id="cb99"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb99-1"><a href="#cb99-1" tabindex="-1"></a>anomaly <span class="op">=</span> yearly.sel(year<span class="op">=</span>year)</span>
<span id="cb99-2"><a href="#cb99-2" tabindex="-1"></a>anomaly</span></code></pre></div>
<div class="sourceCode" id="cb100"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb100-1"><a href="#cb100-1" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb100-2"><a href="#cb100-2" tabindex="-1"></a>fig.set_size_inches(<span class="dv">15</span>, <span class="dv">7</span>)</span>
<span id="cb100-3"><a href="#cb100-3" tabindex="-1"></a>anomaly.plot.imshow(ax<span class="op">=</span>ax)</span>
<span id="cb100-4"><a href="#cb100-4" tabindex="-1"></a>plt.show()</span></code></pre></div>
<p>We can customize the plot using Matplotlib’s options.</p>
<div class="sourceCode" id="cb101"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb101-1"><a href="#cb101-1" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb101-2"><a href="#cb101-2" tabindex="-1"></a>fig.set_size_inches(<span class="dv">15</span>, <span class="dv">7</span>)</span>
<span id="cb101-3"><a href="#cb101-3" tabindex="-1"></a></span>
<span id="cb101-4"><a href="#cb101-4" tabindex="-1"></a>anomaly.plot.imshow(ax<span class="op">=</span>ax,</span>
<span id="cb101-5"><a href="#cb101-5" tabindex="-1"></a>    vmin<span class="op">=-</span><span class="dv">3</span>, vmax<span class="op">=</span><span class="dv">3</span>, add_labels<span class="op">=</span><span class="va">False</span>, cmap<span class="op">=</span><span class="st">&#39;coolwarm&#39;</span>)</span>
<span id="cb101-6"><a href="#cb101-6" tabindex="-1"></a></span>
<span id="cb101-7"><a href="#cb101-7" tabindex="-1"></a>ax.set_title(<span class="ss">f&#39;Temperature Anomaly in </span><span class="sc">{</span>year<span class="sc">}</span><span class="ss"> (°K)&#39;</span>, fontsize <span class="op">=</span> <span class="dv">14</span>)</span>
<span id="cb101-8"><a href="#cb101-8" tabindex="-1"></a></span>
<span id="cb101-9"><a href="#cb101-9" tabindex="-1"></a>plt.show()</span></code></pre></div>
</div>
<div id="plotting-using-cartopy" class="section level2">
<h2>Plotting using CartoPy</h2>
<p>To create more informative map visualization, we need to reproject
this grid to another projection. CartoPy supports a wide range of
projections and can plot them using matplotlib. CartoPy creates a
GeoAxes object and replaces the default Axes with it. This allows you to
plot the data on a specified projection.</p>
<p>We start as usual by create a subplot but specify an additional
argument to set the CRS from CartoPy.</p>
<p>Reference: <a
href="https://scitools.org.uk/cartopy/docs/latest/reference/crs.html?highlight=list#list-of-projections">CartoPy
List of Projections</a></p>
<div class="sourceCode" id="cb102"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb102-1"><a href="#cb102-1" tabindex="-1"></a>projection <span class="op">=</span> ccrs.Orthographic(<span class="dv">0</span>, <span class="dv">30</span>)</span>
<span id="cb102-2"><a href="#cb102-2" tabindex="-1"></a></span>
<span id="cb102-3"><a href="#cb102-3" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">1</span>, subplot_kw<span class="op">=</span>{<span class="st">&#39;projection&#39;</span>: projection})</span>
<span id="cb102-4"><a href="#cb102-4" tabindex="-1"></a>fig.set_size_inches(<span class="dv">5</span>,<span class="dv">5</span>)</span>
<span id="cb102-5"><a href="#cb102-5" tabindex="-1"></a></span>
<span id="cb102-6"><a href="#cb102-6" tabindex="-1"></a>anomaly.plot.imshow(ax<span class="op">=</span>ax,</span>
<span id="cb102-7"><a href="#cb102-7" tabindex="-1"></a>    vmin<span class="op">=-</span><span class="dv">3</span>, vmax<span class="op">=</span><span class="dv">3</span>, cmap<span class="op">=</span><span class="st">&#39;coolwarm&#39;</span>,</span>
<span id="cb102-8"><a href="#cb102-8" tabindex="-1"></a>    transform<span class="op">=</span>ccrs.PlateCarree())</span>
<span id="cb102-9"><a href="#cb102-9" tabindex="-1"></a></span>
<span id="cb102-10"><a href="#cb102-10" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb102-11"><a href="#cb102-11" tabindex="-1"></a>plt.show()</span></code></pre></div>
<p>We can further customize the map by adjusting the colorbar.</p>
<p>Reference: <a
href="https://matplotlib.org/stable/api/_as_gen/matplotlib.pyplot.colorbar.html">matplotlib.pyplot.colorbar</a></p>
<div class="sourceCode" id="cb103"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb103-1"><a href="#cb103-1" tabindex="-1"></a>projection <span class="op">=</span> ccrs.Orthographic(<span class="dv">0</span>, <span class="dv">30</span>)</span>
<span id="cb103-2"><a href="#cb103-2" tabindex="-1"></a></span>
<span id="cb103-3"><a href="#cb103-3" tabindex="-1"></a>cbar_kwargs <span class="op">=</span> {</span>
<span id="cb103-4"><a href="#cb103-4" tabindex="-1"></a>    <span class="st">&#39;orientation&#39;</span>:<span class="st">&#39;horizontal&#39;</span>,</span>
<span id="cb103-5"><a href="#cb103-5" tabindex="-1"></a>    <span class="st">&#39;fraction&#39;</span>: <span class="fl">0.025</span>,</span>
<span id="cb103-6"><a href="#cb103-6" tabindex="-1"></a>    <span class="st">&#39;pad&#39;</span>: <span class="fl">0.05</span>,</span>
<span id="cb103-7"><a href="#cb103-7" tabindex="-1"></a>    <span class="st">&#39;extend&#39;</span>:<span class="st">&#39;neither&#39;</span></span>
<span id="cb103-8"><a href="#cb103-8" tabindex="-1"></a>}</span>
<span id="cb103-9"><a href="#cb103-9" tabindex="-1"></a></span>
<span id="cb103-10"><a href="#cb103-10" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">1</span>, subplot_kw<span class="op">=</span>{<span class="st">&#39;projection&#39;</span>: projection})</span>
<span id="cb103-11"><a href="#cb103-11" tabindex="-1"></a>fig.set_size_inches(<span class="dv">8</span>, <span class="dv">8</span>)</span>
<span id="cb103-12"><a href="#cb103-12" tabindex="-1"></a>anomaly.plot.imshow(</span>
<span id="cb103-13"><a href="#cb103-13" tabindex="-1"></a>    ax<span class="op">=</span>ax,</span>
<span id="cb103-14"><a href="#cb103-14" tabindex="-1"></a>    vmin<span class="op">=-</span><span class="dv">3</span>, vmax<span class="op">=</span><span class="dv">3</span>, cmap<span class="op">=</span><span class="st">&#39;coolwarm&#39;</span>,</span>
<span id="cb103-15"><a href="#cb103-15" tabindex="-1"></a>    transform<span class="op">=</span>ccrs.PlateCarree(),</span>
<span id="cb103-16"><a href="#cb103-16" tabindex="-1"></a>    add_labels<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb103-17"><a href="#cb103-17" tabindex="-1"></a>    cbar_kwargs<span class="op">=</span>cbar_kwargs)</span>
<span id="cb103-18"><a href="#cb103-18" tabindex="-1"></a></span>
<span id="cb103-19"><a href="#cb103-19" tabindex="-1"></a>ax.coastlines()</span>
<span id="cb103-20"><a href="#cb103-20" tabindex="-1"></a>plt.title(<span class="ss">f&#39;Temperature Anomaly in </span><span class="sc">{</span>year<span class="sc">}</span><span class="ss"> (°K)&#39;</span>, fontsize <span class="op">=</span> <span class="dv">14</span>)</span>
<span id="cb103-21"><a href="#cb103-21" tabindex="-1"></a></span>
<span id="cb103-22"><a href="#cb103-22" tabindex="-1"></a>output_folder <span class="op">=</span> <span class="st">&#39;output&#39;</span></span>
<span id="cb103-23"><a href="#cb103-23" tabindex="-1"></a>output_path <span class="op">=</span> os.path.join(output_folder, <span class="st">&#39;anomaly.jpg&#39;</span>)</span>
<span id="cb103-24"><a href="#cb103-24" tabindex="-1"></a>plt.savefig(output_path, dpi<span class="op">=</span><span class="dv">300</span>)</span>
<span id="cb103-25"><a href="#cb103-25" tabindex="-1"></a>plt.show()</span></code></pre></div>
<p><img
src="python-dataviz-output/06_mapping_gridded_datasets_files/06_mapping_gridded_datasets_22_0.png" /></p>
</div>
<div id="exercise-5" class="section level2">
<h2>Exercise</h2>
<p>Display the map in the Equal Earth projection.</p>
<p><img src='https://courses.spatialthoughts.com/images/python_dataviz/anomaly.png' width=400/></p>
<hr />
</div>
</div>
<div id="visualizing-rasters" class="section level1">
<h1>Visualizing Rasters</h1>
<p><a
href="https://colab.research.google.com/github/spatialthoughts/python-dataviz-web/blob/main/07_visualizing_rasters.ipynb"><img
src="https://colab.research.google.com/assets/colab-badge.svg"
alt="Open In Colab" /></a></p>
<div id="overview-5" class="section level2">
<h2>Overview</h2>
<p>In the previous notebook, we learnt how to use <a
href="http://xarray.pydata.org/">Xarray</a> to work with gridded
datasets. XArray is also well suited to work with georeferenced rasters
- such as satellite imagery, population grids, or elevation data.<a
href="https://corteva.github.io/rioxarray/stable/index.html">rioxarray</a>
is an extension of xarray that makes it easy to work with geospatial
rasters.</p>
<p>In this section, we will take 4 individual SRTM tiles around the Mt.
Everest region and merge them to a single GeoTiff using RasterIO. We
will also use <code>matplotlib</code> to add labels to the final map
using annonations.</p>
</div>
<div id="setup-and-data-download-5" class="section level2">
<h2>Setup and Data Download</h2>
<p>The following blocks of code will install the required packages and
download the datasets to your Colab environment.</p>
<div class="sourceCode" id="cb104"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb104-1"><a href="#cb104-1" tabindex="-1"></a><span class="op">%%</span>capture</span>
<span id="cb104-2"><a href="#cb104-2" tabindex="-1"></a><span class="cf">if</span> <span class="st">&#39;google.colab&#39;</span> <span class="kw">in</span> <span class="bu">str</span>(get_ipython()):</span>
<span id="cb104-3"><a href="#cb104-3" tabindex="-1"></a>    <span class="op">!</span>pip install rioxarray</span></code></pre></div>
<p>By convention, <code>rioxarray</code> is imported as
<code>rxr</code>.</p>
<blockquote>
<p>Remember to always import <code>rioxarray</code> even if you are
using sub-modules such as <code>merge_arrays</code>. Importing
<code>rioxarray</code> activates the <code>rio</code> accessor which is
required for all operations.</p>
</blockquote>
<div class="sourceCode" id="cb105"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb105-1"><a href="#cb105-1" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb105-2"><a href="#cb105-2" tabindex="-1"></a><span class="im">import</span> rioxarray <span class="im">as</span> rxr</span>
<span id="cb105-3"><a href="#cb105-3" tabindex="-1"></a><span class="im">from</span> rioxarray.merge <span class="im">import</span> merge_arrays</span>
<span id="cb105-4"><a href="#cb105-4" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span></code></pre></div>
<div class="sourceCode" id="cb106"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb106-1"><a href="#cb106-1" tabindex="-1"></a>data_folder <span class="op">=</span> <span class="st">&#39;data&#39;</span></span>
<span id="cb106-2"><a href="#cb106-2" tabindex="-1"></a>output_folder <span class="op">=</span> <span class="st">&#39;output&#39;</span></span>
<span id="cb106-3"><a href="#cb106-3" tabindex="-1"></a></span>
<span id="cb106-4"><a href="#cb106-4" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> os.path.exists(data_folder):</span>
<span id="cb106-5"><a href="#cb106-5" tabindex="-1"></a>    os.mkdir(data_folder)</span>
<span id="cb106-6"><a href="#cb106-6" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> os.path.exists(output_folder):</span>
<span id="cb106-7"><a href="#cb106-7" tabindex="-1"></a>    os.mkdir(output_folder)</span></code></pre></div>
<div class="sourceCode" id="cb107"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb107-1"><a href="#cb107-1" tabindex="-1"></a><span class="kw">def</span> download(url):</span>
<span id="cb107-2"><a href="#cb107-2" tabindex="-1"></a>    filename <span class="op">=</span> os.path.join(data_folder, os.path.basename(url))</span>
<span id="cb107-3"><a href="#cb107-3" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> os.path.exists(filename):</span>
<span id="cb107-4"><a href="#cb107-4" tabindex="-1"></a>        <span class="im">from</span> urllib.request <span class="im">import</span> urlretrieve</span>
<span id="cb107-5"><a href="#cb107-5" tabindex="-1"></a>        local, _ <span class="op">=</span> urlretrieve(url, filename)</span>
<span id="cb107-6"><a href="#cb107-6" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&#39;Downloaded &#39;</span> <span class="op">+</span> local)</span>
<span id="cb107-7"><a href="#cb107-7" tabindex="-1"></a></span>
<span id="cb107-8"><a href="#cb107-8" tabindex="-1"></a>srtm_tiles <span class="op">=</span> [</span>
<span id="cb107-9"><a href="#cb107-9" tabindex="-1"></a>  <span class="st">&#39;N27E086.hgt&#39;</span>,</span>
<span id="cb107-10"><a href="#cb107-10" tabindex="-1"></a>  <span class="st">&#39;N27E087.hgt&#39;</span>,</span>
<span id="cb107-11"><a href="#cb107-11" tabindex="-1"></a>  <span class="st">&#39;N28E086.hgt&#39;</span>,</span>
<span id="cb107-12"><a href="#cb107-12" tabindex="-1"></a>  <span class="st">&#39;N28E087.hgt&#39;</span></span>
<span id="cb107-13"><a href="#cb107-13" tabindex="-1"></a>]</span>
<span id="cb107-14"><a href="#cb107-14" tabindex="-1"></a></span>
<span id="cb107-15"><a href="#cb107-15" tabindex="-1"></a>data_url <span class="op">=</span> <span class="st">&#39;https://github.com/spatialthoughts/python-dataviz-web/releases/&#39;</span> \</span>
<span id="cb107-16"><a href="#cb107-16" tabindex="-1"></a>  <span class="st">&#39;download/srtm/&#39;</span></span>
<span id="cb107-17"><a href="#cb107-17" tabindex="-1"></a></span>
<span id="cb107-18"><a href="#cb107-18" tabindex="-1"></a><span class="cf">for</span> tile <span class="kw">in</span> srtm_tiles:</span>
<span id="cb107-19"><a href="#cb107-19" tabindex="-1"></a>  url <span class="op">=</span> <span class="ss">f&#39;</span><span class="sc">{</span>data_url<span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>tile<span class="sc">}</span><span class="ss">&#39;</span></span>
<span id="cb107-20"><a href="#cb107-20" tabindex="-1"></a>  download(url)</span></code></pre></div>
</div>
<div id="rioxarray-basics" class="section level2">
<h2>Rioxarray Basics</h2>
<p>The <code>open_rasterio()</code> method from <code>rioxarray</code>
is able to read any data source supported by. the <a
href="https://rasterio.readthedocs.io/en/latest/"><code>rasterio</code></a>
library. Let’s open a single SRTM tile using <code>rioxarray</code>.</p>
<div class="sourceCode" id="cb108"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb108-1"><a href="#cb108-1" tabindex="-1"></a>filename <span class="op">=</span> <span class="st">&#39;N28E087.hgt&#39;</span></span>
<span id="cb108-2"><a href="#cb108-2" tabindex="-1"></a>file_path <span class="op">=</span> os.path.join(data_folder, filename)</span>
<span id="cb108-3"><a href="#cb108-3" tabindex="-1"></a>rds <span class="op">=</span> rxr.open_rasterio(file_path)</span></code></pre></div>
<p>The result is a <code>xarray.DataArray</code> object.</p>
<div class="sourceCode" id="cb109"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb109-1"><a href="#cb109-1" tabindex="-1"></a>rds</span></code></pre></div>
<p>You can access the pixel values using the <code>values</code>
property which returns the array’s data as a numpy array.</p>
<div class="sourceCode" id="cb110"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb110-1"><a href="#cb110-1" tabindex="-1"></a>rds.values</span></code></pre></div>
<p>A <code>xarray.DataArray</code> object also contains 1 or more
<code>coordinates</code>. Each coordinate is a 1-dimensional array
representing values along one of the data axes. In case of the 1-band
SRTM elevation data, we have 3 coordinates - <code>x</code>,
<code>y</code> and <code>band</code>.</p>
<div class="sourceCode" id="cb111"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb111-1"><a href="#cb111-1" tabindex="-1"></a>rds.coords</span></code></pre></div>
<p>The raster metadata is stored in the <a
href="https://corteva.github.io/rioxarray/stable/rioxarray.html#rioxarray-rio-accessors"><code>rio</code></a>
accessor. This is enabled by the <code>rioxarray</code> library which
provides geospatial functions on top of <code>xarray</code>.</p>
<div class="sourceCode" id="cb112"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb112-1"><a href="#cb112-1" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&#39;CRS:&#39;</span>, rds.rio.crs)</span>
<span id="cb112-2"><a href="#cb112-2" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&#39;Resolution:&#39;</span>, rds.rio.resolution())</span>
<span id="cb112-3"><a href="#cb112-3" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&#39;Bounds:&#39;</span>, rds.rio.bounds())</span>
<span id="cb112-4"><a href="#cb112-4" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&#39;Width:&#39;</span>, rds.rio.width)</span>
<span id="cb112-5"><a href="#cb112-5" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&#39;Height:&#39;</span>, rds.rio.height)</span></code></pre></div>
<div class="sourceCode" id="cb113"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb113-1"><a href="#cb113-1" tabindex="-1"></a>band1 <span class="op">=</span> rds.sel(band<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb113-2"><a href="#cb113-2" tabindex="-1"></a>band1</span></code></pre></div>
</div>
<div id="plotting-multiple-rasters" class="section level2">
<h2>Plotting Multiple Rasters</h2>
<p>Open each source file using <code>open_rasterio()</code> method and
store the resulting datasets in a list.</p>
<div class="sourceCode" id="cb114"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb114-1"><a href="#cb114-1" tabindex="-1"></a>datasets <span class="op">=</span> []</span>
<span id="cb114-2"><a href="#cb114-2" tabindex="-1"></a><span class="cf">for</span> tile <span class="kw">in</span> srtm_tiles:</span>
<span id="cb114-3"><a href="#cb114-3" tabindex="-1"></a>    path <span class="op">=</span> os.path.join(data_folder, tile)</span>
<span id="cb114-4"><a href="#cb114-4" tabindex="-1"></a>    rds <span class="op">=</span> rxr.open_rasterio(path)</span>
<span id="cb114-5"><a href="#cb114-5" tabindex="-1"></a>    band <span class="op">=</span> rds.sel(band<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb114-6"><a href="#cb114-6" tabindex="-1"></a>    datasets.append(band)</span></code></pre></div>
<p>You can visualize any <code>DataArray</code> object by calling
<code>plot()</code> method. Here we create a subplot with 1 row and 4
columns. The <code>subplots()</code> method will return a list of Axes
that we can use to render each of the source SRTM rasters. For plots
with multiple columns, the Axes will be a nested list. To easily iterate
over it, we can use <code>.flat</code> which returns a 1D iterator on
the axes.</p>
<p>While plotting the data, we can use the <code>cmap</code> option to
specify a color ramp. Here we are using the built-in <em>Greys</em>
ramp. Appending **_r** gives us the inverted ramp with blacks
representing lower elevation values. When plotting on multiple Axes, it
is useful to specify <code>set_aspect('equal')</code> so the aspect raio
of the plot is maintained even if there is not enough space.</p>
<div class="sourceCode" id="cb115"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb115-1"><a href="#cb115-1" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">4</span>)</span>
<span id="cb115-2"><a href="#cb115-2" tabindex="-1"></a>fig.set_size_inches(<span class="dv">15</span>,<span class="dv">3</span>)</span>
<span id="cb115-3"><a href="#cb115-3" tabindex="-1"></a><span class="cf">for</span> index, ax <span class="kw">in</span> <span class="bu">enumerate</span>(axes.flat):</span>
<span id="cb115-4"><a href="#cb115-4" tabindex="-1"></a>    da <span class="op">=</span> datasets[index]</span>
<span id="cb115-5"><a href="#cb115-5" tabindex="-1"></a>    im <span class="op">=</span> da.plot.imshow(ax<span class="op">=</span>ax, cmap<span class="op">=</span><span class="st">&#39;Greys_r&#39;</span>)</span>
<span id="cb115-6"><a href="#cb115-6" tabindex="-1"></a>    filename <span class="op">=</span> srtm_tiles[index]</span>
<span id="cb115-7"><a href="#cb115-7" tabindex="-1"></a>    ax.set_title(filename)</span>
<span id="cb115-8"><a href="#cb115-8" tabindex="-1"></a>    ax.set_aspect(<span class="st">&#39;equal&#39;</span>) <span class="co"># maintain aspect ratio</span></span>
<span id="cb115-9"><a href="#cb115-9" tabindex="-1"></a></span>
<span id="cb115-10"><a href="#cb115-10" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb115-11"><a href="#cb115-11" tabindex="-1"></a>plt.show()</span></code></pre></div>
</div>
<div id="merging-rasters" class="section level2">
<h2>Merging Rasters</h2>
<p>Now that you understand the basic data structure of <em>xarray</em>
and the <em>rio</em> extension, let’s use it to process some data. We
will take 4 individual SRTM tiles and merge them to a single GeoTiff.
You will note that <code>rioxarray</code> handles the CRS and transform
much better - taking care of internal details and providing a simple
API.</p>
<p>We will use the <code>merge_arrays()</code> method from the
<code>rioxarray.merge</code> module to merge the rasters. We can also
specify an optional <code>method</code> that controls how overlapping
tiles are merged. Here we have chosen <code>first</code> which takes the
value of the first raster in the overlapping region.</p>
<p>Reference: <a
href="https://corteva.github.io/rioxarray/html/rioxarray.html#rioxarray.merge.merge_arrays"><code>merge_arrays()</code></a></p>
<div class="sourceCode" id="cb116"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb116-1"><a href="#cb116-1" tabindex="-1"></a>merged <span class="op">=</span> merge_arrays(datasets, method<span class="op">=</span><span class="st">&#39;first&#39;</span>)</span>
<span id="cb116-2"><a href="#cb116-2" tabindex="-1"></a>merged</span></code></pre></div>
<p>We can now visualize the merged raster.</p>
<div class="sourceCode" id="cb117"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb117-1"><a href="#cb117-1" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots()</span>
<span id="cb117-2"><a href="#cb117-2" tabindex="-1"></a>fig.set_size_inches(<span class="dv">12</span>, <span class="dv">10</span>)</span>
<span id="cb117-3"><a href="#cb117-3" tabindex="-1"></a>merged.plot.imshow(ax<span class="op">=</span>ax, cmap<span class="op">=</span><span class="st">&#39;Greys_r&#39;</span>)</span>
<span id="cb117-4"><a href="#cb117-4" tabindex="-1"></a>ax.set_title(<span class="st">&#39;merged&#39;</span>)</span>
<span id="cb117-5"><a href="#cb117-5" tabindex="-1"></a>plt.show()</span></code></pre></div>
<p>We can save the resulting raster in any format supported by GDAL
using the <code>to_raster()</code> method. Let’s save this as a <a
href="https://gdal.org/drivers/raster/cog.html">Cloud-Optimized GeoTIFF
(COG)</a>.</p>
<div class="sourceCode" id="cb118"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb118-1"><a href="#cb118-1" tabindex="-1"></a>output_file <span class="op">=</span> <span class="st">&#39;merged.tif&#39;</span></span>
<span id="cb118-2"><a href="#cb118-2" tabindex="-1"></a>output_path <span class="op">=</span> os.path.join(output_folder, output_file)</span>
<span id="cb118-3"><a href="#cb118-3" tabindex="-1"></a>merged.rio.to_raster(output_path, driver<span class="op">=</span><span class="st">&#39;COG&#39;</span>)</span></code></pre></div>
</div>
<div id="annotating-plots" class="section level2">
<h2>Annotating Plots</h2>
<p>Sometime it is helpful to add annotations on your plot to highlight a
feature or add a text label. In this section we will learn how to use
the annotate the DEM to show the location and elevation of Mt.
Everest.</p>
<p>First, we locate the coordinates of the maximum elevation in the
<code>merged</code> DataArray using the <code>max()</code> function. We
can then use <code>where()</code> function to filter the elements where
the value equals the maximum elevation. Lastly, we run
<code>squeeze()</code> to remove the extra empty dimension from the
result.</p>
<p>References:</p>
<ul>
<li><a
href="https://docs.xarray.dev/en/stable/generated/xarray.DataArray.max.html">xarray.DataArray.max</a></li>
<li><a
href="https://docs.xarray.dev/en/stable/generated/xarray.DataArray.where.html">xarray.DataArray.where</a></li>
</ul>
<div class="sourceCode" id="cb119"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb119-1"><a href="#cb119-1" tabindex="-1"></a>max_da <span class="op">=</span> merged.where(merged<span class="op">==</span>merged.<span class="bu">max</span>(), drop<span class="op">=</span><span class="va">True</span>).squeeze()</span>
<span id="cb119-2"><a href="#cb119-2" tabindex="-1"></a>max_da</span></code></pre></div>
<p>We now extract the x,y coordinates and the value of the maximum
elevation.</p>
<div class="sourceCode" id="cb120"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb120-1"><a href="#cb120-1" tabindex="-1"></a>max_x <span class="op">=</span> max_da.x.values</span>
<span id="cb120-2"><a href="#cb120-2" tabindex="-1"></a>max_y <span class="op">=</span> max_da.y.values</span>
<span id="cb120-3"><a href="#cb120-3" tabindex="-1"></a>max_elev <span class="op">=</span> <span class="bu">int</span>(max_da.values)</span>
<span id="cb120-4"><a href="#cb120-4" tabindex="-1"></a><span class="bu">print</span>(max_x, max_y, max_elev)</span></code></pre></div>
<p>Now we plot the <code>merged</code> raster and annotate it using the
<code>annotate()</code> function.</p>
<p>Reference: <a
href="https://matplotlib.org/stable/api/_as_gen/matplotlib.pyplot.annotate.html">matplotlib.pyplot.annotate</a></p>
<div class="sourceCode" id="cb121"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb121-1"><a href="#cb121-1" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb121-2"><a href="#cb121-2" tabindex="-1"></a>fig.set_size_inches(<span class="dv">12</span>, <span class="dv">10</span>)</span>
<span id="cb121-3"><a href="#cb121-3" tabindex="-1"></a>merged.plot.imshow(ax<span class="op">=</span>ax, cmap<span class="op">=</span><span class="st">&#39;viridis&#39;</span>, add_labels<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb121-4"><a href="#cb121-4" tabindex="-1"></a>ax.plot(max_x, max_y, color<span class="op">=</span><span class="st">&#39;red&#39;</span>, marker<span class="op">=</span><span class="st">&#39;^&#39;</span>, markersize<span class="op">=</span><span class="dv">11</span>)</span>
<span id="cb121-5"><a href="#cb121-5" tabindex="-1"></a>ax.annotate(<span class="ss">f&#39;Mt. Everest (elevation:</span><span class="sc">{</span>max_elev<span class="sc">}</span><span class="ss">m)&#39;</span>,</span>
<span id="cb121-6"><a href="#cb121-6" tabindex="-1"></a>            xy<span class="op">=</span>(max_x, max_y), xycoords<span class="op">=</span><span class="st">&#39;data&#39;</span>,</span>
<span id="cb121-7"><a href="#cb121-7" tabindex="-1"></a>            xytext<span class="op">=</span>(<span class="dv">20</span>, <span class="dv">20</span>), textcoords<span class="op">=</span><span class="st">&#39;offset points&#39;</span>,</span>
<span id="cb121-8"><a href="#cb121-8" tabindex="-1"></a>            arrowprops<span class="op">=</span>{<span class="st">&#39;arrowstyle&#39;</span>:<span class="st">&#39;-&gt;&#39;</span>, <span class="st">&#39;color&#39;</span>:<span class="st">&#39;black&#39;</span>}</span>
<span id="cb121-9"><a href="#cb121-9" tabindex="-1"></a>            )</span>
<span id="cb121-10"><a href="#cb121-10" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb121-11"><a href="#cb121-11" tabindex="-1"></a>plt.show()</span></code></pre></div>
<p><img
src="python-dataviz-output/07_visualizing_rasters_files/07_visualizing_rasters_38_0.png" /></p>
</div>
<div id="exercise-6" class="section level2">
<h2>Exercise</h2>
<p>Add contours to the elevation plot below.</p>
<p><img src='https://courses.spatialthoughts.com/images/python_dataviz/contours.png' width=600/></p>
<p>Start with the code snippet below and use the <a
href="https://docs.xarray.dev/en/stable/generated/xarray.plot.contour.html"><code>xarray.plot.contour</code></a>
function to render the contours</p>
<p>Hint: Use the options <code>colors=white</code> and
<code>levels=10</code>.</p>
<div class="sourceCode" id="cb122"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb122-1"><a href="#cb122-1" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb122-2"><a href="#cb122-2" tabindex="-1"></a>fig.set_size_inches(<span class="dv">10</span>, <span class="dv">10</span>)</span>
<span id="cb122-3"><a href="#cb122-3" tabindex="-1"></a>merged.plot.imshow(</span>
<span id="cb122-4"><a href="#cb122-4" tabindex="-1"></a>    ax<span class="op">=</span>ax,</span>
<span id="cb122-5"><a href="#cb122-5" tabindex="-1"></a>    cmap<span class="op">=</span><span class="st">&#39;viridis&#39;</span>,</span>
<span id="cb122-6"><a href="#cb122-6" tabindex="-1"></a>    add_labels<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb122-7"><a href="#cb122-7" tabindex="-1"></a>    add_colorbar<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb122-8"><a href="#cb122-8" tabindex="-1"></a></span>
<span id="cb122-9"><a href="#cb122-9" tabindex="-1"></a>ax.set_axis_off()</span>
<span id="cb122-10"><a href="#cb122-10" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb122-11"><a href="#cb122-11" tabindex="-1"></a>plt.show()</span></code></pre></div>
<hr />
</div>
</div>
<div id="assignment" class="section level1">
<h1>Assignment</h1>
<p><a
href="https://colab.research.google.com/github/spatialthoughts/python-dataviz-web/blob/main/assignment.ipynb"><img
src="https://colab.research.google.com/assets/colab-badge.svg"
alt="Open In Colab" /></a></p>
<div id="overview-6" class="section level2">
<h2>Overview</h2>
<p>Your assignment is to create a colorized river basin map for your
country using the <a
href="https://www.hydrosheds.org/products/hydrorivers">HydroRIVERS</a>
data.</p>
<p>This notebook contains code to download and pre-process the data.
Your task is to plot the rivers using Matplotlib and achieve a unique
style shown below.</p>
<p><img src='https://courses.spatialthoughts.com/images/python_dataviz/assignment.png' width=800/></p>
</div>
<div id="setup-and-data-download-6" class="section level2">
<h2>Setup and Data Download</h2>
<div class="sourceCode" id="cb123"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb123-1"><a href="#cb123-1" tabindex="-1"></a><span class="im">import</span> geopandas <span class="im">as</span> gpd</span>
<span id="cb123-2"><a href="#cb123-2" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb123-3"><a href="#cb123-3" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb123-4"><a href="#cb123-4" tabindex="-1"></a><span class="im">import</span> requests</span>
<span id="cb123-5"><a href="#cb123-5" tabindex="-1"></a><span class="im">import</span> zipfile</span></code></pre></div>
<div class="sourceCode" id="cb124"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb124-1"><a href="#cb124-1" tabindex="-1"></a>data_folder <span class="op">=</span> <span class="st">&#39;data&#39;</span></span>
<span id="cb124-2"><a href="#cb124-2" tabindex="-1"></a>output_folder <span class="op">=</span> <span class="st">&#39;output&#39;</span></span>
<span id="cb124-3"><a href="#cb124-3" tabindex="-1"></a></span>
<span id="cb124-4"><a href="#cb124-4" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> os.path.exists(data_folder):</span>
<span id="cb124-5"><a href="#cb124-5" tabindex="-1"></a>    os.mkdir(data_folder)</span>
<span id="cb124-6"><a href="#cb124-6" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> os.path.exists(output_folder):</span>
<span id="cb124-7"><a href="#cb124-7" tabindex="-1"></a>    os.mkdir(output_folder)</span></code></pre></div>
<div class="sourceCode" id="cb125"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb125-1"><a href="#cb125-1" tabindex="-1"></a><span class="kw">def</span> download(url):</span>
<span id="cb125-2"><a href="#cb125-2" tabindex="-1"></a>    filename <span class="op">=</span> os.path.join(data_folder, os.path.basename(url))</span>
<span id="cb125-3"><a href="#cb125-3" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> os.path.exists(filename):</span>
<span id="cb125-4"><a href="#cb125-4" tabindex="-1"></a>      <span class="cf">with</span> requests.get(url, stream<span class="op">=</span><span class="va">True</span>, allow_redirects<span class="op">=</span><span class="va">True</span>) <span class="im">as</span> r:</span>
<span id="cb125-5"><a href="#cb125-5" tabindex="-1"></a>          <span class="cf">with</span> <span class="bu">open</span>(filename, <span class="st">&#39;wb&#39;</span>) <span class="im">as</span> f:</span>
<span id="cb125-6"><a href="#cb125-6" tabindex="-1"></a>              <span class="cf">for</span> chunk <span class="kw">in</span> r.iter_content(chunk_size<span class="op">=</span><span class="dv">8192</span>):</span>
<span id="cb125-7"><a href="#cb125-7" tabindex="-1"></a>                  f.write(chunk)</span>
<span id="cb125-8"><a href="#cb125-8" tabindex="-1"></a>      <span class="bu">print</span>(<span class="st">&#39;Downloaded&#39;</span>, filename)</span>
<span id="cb125-9"><a href="#cb125-9" tabindex="-1"></a></span>
<span id="cb125-10"><a href="#cb125-10" tabindex="-1"></a></span>
<span id="cb125-11"><a href="#cb125-11" tabindex="-1"></a>data_url <span class="op">=</span> <span class="st">&#39;https://github.com/spatialthoughts/python-dataviz-web/releases/download/&#39;</span></span>
<span id="cb125-12"><a href="#cb125-12" tabindex="-1"></a></span>
<span id="cb125-13"><a href="#cb125-13" tabindex="-1"></a><span class="co"># This is a subset of the main HydroRivers dataset of all</span></span>
<span id="cb125-14"><a href="#cb125-14" tabindex="-1"></a><span class="co"># rivers having `UPLAND_SKM` value  greater than 100 sq. km.</span></span>
<span id="cb125-15"><a href="#cb125-15" tabindex="-1"></a>hydrorivers_file <span class="op">=</span> <span class="st">&#39;hydrorivers_100.gpkg&#39;</span></span>
<span id="cb125-16"><a href="#cb125-16" tabindex="-1"></a>hydrorivers_url <span class="op">=</span> data_url <span class="op">+</span> <span class="st">&#39;hydrosheds/&#39;</span></span>
<span id="cb125-17"><a href="#cb125-17" tabindex="-1"></a></span>
<span id="cb125-18"><a href="#cb125-18" tabindex="-1"></a>countries_file <span class="op">=</span> <span class="st">&#39;ne_10m_admin_0_countries_ind.zip&#39;</span></span>
<span id="cb125-19"><a href="#cb125-19" tabindex="-1"></a>countries_url <span class="op">=</span> data_url <span class="op">+</span> <span class="st">&#39;naturalearth/&#39;</span></span>
<span id="cb125-20"><a href="#cb125-20" tabindex="-1"></a></span>
<span id="cb125-21"><a href="#cb125-21" tabindex="-1"></a></span>
<span id="cb125-22"><a href="#cb125-22" tabindex="-1"></a>download(hydrorivers_url <span class="op">+</span> hydrorivers_file)</span>
<span id="cb125-23"><a href="#cb125-23" tabindex="-1"></a>download(countries_url <span class="op">+</span> countries_file)</span></code></pre></div>
</div>
<div id="data-pre-processing-3" class="section level2">
<h2>Data Pre-Processing</h2>
<p>Read the countries shapefile.</p>
<div class="sourceCode" id="cb126"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb126-1"><a href="#cb126-1" tabindex="-1"></a>countries_filepath <span class="op">=</span> os.path.join(data_folder, countries_file)</span></code></pre></div>
<p>For the assignment, you need to pick the country for which you want
to create the map. We can print a list of values from the
<code>SOVEREIGNT</code> column of <code>country_gdf</code> GeoDataFrame
using <code>country_gdf.SOVEREIGNT.values</code> to know the names of
all countries.</p>
<div class="sourceCode" id="cb127"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb127-1"><a href="#cb127-1" tabindex="-1"></a>country_gdf <span class="op">=</span> gpd.read_file(countries_filepath)</span>
<span id="cb127-2"><a href="#cb127-2" tabindex="-1"></a><span class="bu">print</span>(<span class="bu">sorted</span>(country_gdf.SOVEREIGNT.unique()))</span></code></pre></div>
<p>Select a country name. Replace the value below with your chosen
country.</p>
<div class="sourceCode" id="cb128"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb128-1"><a href="#cb128-1" tabindex="-1"></a>country <span class="op">=</span> <span class="st">&#39;India&#39;</span></span></code></pre></div>
<p>Apply filters to select the country feature. We use an additional
filter <code>TYPE != 'Dependency'</code> to exclude overseas
territories. You may have to adjust the filter to get the correct
country polygon.</p>
<div class="sourceCode" id="cb129"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb129-1"><a href="#cb129-1" tabindex="-1"></a>selected_country <span class="op">=</span> country_gdf[</span>
<span id="cb129-2"><a href="#cb129-2" tabindex="-1"></a>    (country_gdf[<span class="st">&#39;SOVEREIGNT&#39;</span>] <span class="op">==</span> country) <span class="op">&amp;</span></span>
<span id="cb129-3"><a href="#cb129-3" tabindex="-1"></a>    (country_gdf[<span class="st">&#39;TYPE&#39;</span>] <span class="op">!=</span> <span class="st">&#39;Dependency&#39;</span>)</span>
<span id="cb129-4"><a href="#cb129-4" tabindex="-1"></a>]</span>
<span id="cb129-5"><a href="#cb129-5" tabindex="-1"></a>selected_country</span></code></pre></div>
<p>We read the river network data from HydroRivers. We specify the
<code>mask</code> parameter which clips the layer to the country
boundary while reading the data.</p>
<p><em>This step can take a few minutes depending on the size of the
country.</em></p>
<div class="sourceCode" id="cb130"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb130-1"><a href="#cb130-1" tabindex="-1"></a>hydrorivers_filepath <span class="op">=</span> os.path.join(data_folder, hydrorivers_file)</span>
<span id="cb130-2"><a href="#cb130-2" tabindex="-1"></a>river_gdf <span class="op">=</span> gpd.read_file(hydrorivers_filepath, mask<span class="op">=</span>selected_country)</span>
<span id="cb130-3"><a href="#cb130-3" tabindex="-1"></a>river_gdf</span></code></pre></div>
<p>Visualize the river network.</p>
<div class="sourceCode" id="cb131"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb131-1"><a href="#cb131-1" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">10</span>))</span>
<span id="cb131-2"><a href="#cb131-2" tabindex="-1"></a>title <span class="op">=</span> <span class="ss">f&#39;Rivers of </span><span class="sc">{</span>country<span class="sc">}</span><span class="ss">&#39;</span></span>
<span id="cb131-3"><a href="#cb131-3" tabindex="-1"></a>river_gdf.plot(ax<span class="op">=</span>ax)</span>
<span id="cb131-4"><a href="#cb131-4" tabindex="-1"></a>ax.set_title(title)</span>
<span id="cb131-5"><a href="#cb131-5" tabindex="-1"></a>ax.set_axis_off()</span>
<span id="cb131-6"><a href="#cb131-6" tabindex="-1"></a>plt.show()</span></code></pre></div>
<p>We want to style the rivers so that the width of the line is
proportional to the value in the <code>UPLAND_SKM</code> attribute. We
add a new column <code>width</code> to the GeoDataFrame by scaling the
input values to a range of target widths.</p>
<p><em>Tip: These values will play an important role in your final
visualization. Adjust these to suit the range of values for your
country.</em></p>
<div class="sourceCode" id="cb132"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb132-1"><a href="#cb132-1" tabindex="-1"></a>original_min <span class="op">=</span> <span class="dv">300</span></span>
<span id="cb132-2"><a href="#cb132-2" tabindex="-1"></a>original_max <span class="op">=</span> <span class="dv">10000</span></span>
<span id="cb132-3"><a href="#cb132-3" tabindex="-1"></a>target_min <span class="op">=</span> <span class="fl">0.2</span></span>
<span id="cb132-4"><a href="#cb132-4" tabindex="-1"></a>target_max <span class="op">=</span> <span class="fl">0.9</span></span>
<span id="cb132-5"><a href="#cb132-5" tabindex="-1"></a>scaled <span class="op">=</span> (river_gdf[<span class="st">&#39;UPLAND_SKM&#39;</span>] <span class="op">-</span> original_min) <span class="op">/</span> (original_max <span class="op">-</span> original_min)</span>
<span id="cb132-6"><a href="#cb132-6" tabindex="-1"></a>river_gdf[<span class="st">&#39;width&#39;</span>] <span class="op">=</span> scaled.clip(<span class="dv">0</span>, <span class="dv">1</span>) <span class="op">*</span> (target_max <span class="op">-</span> target_min) <span class="op">+</span> target_min</span>
<span id="cb132-7"><a href="#cb132-7" tabindex="-1"></a>river_gdf_final <span class="op">=</span> river_gdf.sort_values([<span class="st">&#39;UPLAND_SKM&#39;</span>, <span class="st">&#39;width&#39;</span>])[</span>
<span id="cb132-8"><a href="#cb132-8" tabindex="-1"></a>    [<span class="st">&#39;MAIN_RIV&#39;</span>, <span class="st">&#39;UPLAND_SKM&#39;</span>, <span class="st">&#39;width&#39;</span>, <span class="st">&#39;geometry&#39;</span>]]</span>
<span id="cb132-9"><a href="#cb132-9" tabindex="-1"></a>river_gdf_final</span></code></pre></div>
<p>Your task is to take the <code>river_gdf_final</code> GeoDataFrame
and render the river network by applying the following styling
guidelines. Refer to the <a
href="https://geopandas.org/en/stable/docs/reference/api/geopandas.GeoDataFrame.plot.html"><code>geopandas.GeoDataFrame.plot()</code></a>
documentation for parameter values and options.</p>
<ul>
<li>Assign a color to each river segment based on the value of
<code>MAIN_RIV</code> column. <em>Hint: set
<code>categorical=True</code></em>.</li>
<li>Assign width to each item based on the value in the
<code>width</code> column.</li>
<li>Set the map background to black.</li>
<li>Set the title to white and change the font to be larger.</li>
</ul>
<hr />
</div>
</div>
<div id="interactive-maps-with-folium" class="section level1">
<h1>Interactive Maps with Folium</h1>
<p><a
href="https://colab.research.google.com/github/spatialthoughts/python-dataviz-web/blob/main/08_interactive_maps_folium.ipynb"><img
src="https://colab.research.google.com/assets/colab-badge.svg"
alt="Open In Colab" /></a></p>
<div id="overview-7" class="section level2">
<h2>Overview</h2>
<p><a href="https://python-visualization.github.io/folium/">Folium</a>
is a Python library that allows you to create interactive maps based on
the popular <a href="https://leafletjs.com/">Leaflet</a> javascript
library.</p>
<p>In this section, we will learn how to create an interactive map
showing driving directions between two locations.</p>
</div>
<div id="setup-1" class="section level2">
<h2>Setup</h2>
<div class="sourceCode" id="cb133"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb133-1"><a href="#cb133-1" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb133-2"><a href="#cb133-2" tabindex="-1"></a><span class="im">import</span> folium</span>
<span id="cb133-3"><a href="#cb133-3" tabindex="-1"></a><span class="im">import</span> json</span></code></pre></div>
<div class="sourceCode" id="cb134"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb134-1"><a href="#cb134-1" tabindex="-1"></a>data_folder <span class="op">=</span> <span class="st">&#39;data&#39;</span></span>
<span id="cb134-2"><a href="#cb134-2" tabindex="-1"></a>output_folder <span class="op">=</span> <span class="st">&#39;output&#39;</span></span>
<span id="cb134-3"><a href="#cb134-3" tabindex="-1"></a></span>
<span id="cb134-4"><a href="#cb134-4" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> os.path.exists(data_folder):</span>
<span id="cb134-5"><a href="#cb134-5" tabindex="-1"></a>    os.mkdir(data_folder)</span>
<span id="cb134-6"><a href="#cb134-6" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> os.path.exists(output_folder):</span>
<span id="cb134-7"><a href="#cb134-7" tabindex="-1"></a>    os.mkdir(output_folder)</span></code></pre></div>
</div>
<div id="folium-basics" class="section level2">
<h2>Folium Basics</h2>
<p>We will learn the basics of folium by creating an interactive map
showing the driving directions between two chosen locations. Let’s start
by defining the coordinates of two cities.</p>
<div class="sourceCode" id="cb135"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb135-1"><a href="#cb135-1" tabindex="-1"></a>san_francisco <span class="op">=</span> (<span class="fl">37.7749</span>, <span class="op">-</span><span class="fl">122.4194</span>)</span>
<span id="cb135-2"><a href="#cb135-2" tabindex="-1"></a>new_york <span class="op">=</span> (<span class="fl">40.661</span>, <span class="op">-</span><span class="fl">73.944</span>)</span></code></pre></div>
<p>To create a map, we initialize the <code>folium.Map()</code> class
which creates a map object with the default basemap. To display the map
a Jupyter notebook, we can simply enter the name of the map object.</p>
<div class="sourceCode" id="cb136"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb136-1"><a href="#cb136-1" tabindex="-1"></a>m <span class="op">=</span> folium.Map()</span>
<span id="cb136-2"><a href="#cb136-2" tabindex="-1"></a>m</span></code></pre></div>
<p>The default map spans the full width of the Jupyter notebook - making
it difficult to navigate. The <code>Map()</code> constructor supports
<code>width</code> and <code>height</code> parameters that control the
size of the leaflet map, but you still end up with a lot of extra empty
space below the map. The preferred way to get a map of exact size is to
create a <em>Figure</em> first and add the map object to it.</p>
<div class="sourceCode" id="cb137"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb137-1"><a href="#cb137-1" tabindex="-1"></a><span class="im">from</span> folium <span class="im">import</span> Figure</span>
<span id="cb137-2"><a href="#cb137-2" tabindex="-1"></a>fig <span class="op">=</span> Figure(width<span class="op">=</span><span class="dv">800</span>, height<span class="op">=</span><span class="dv">400</span>)</span>
<span id="cb137-3"><a href="#cb137-3" tabindex="-1"></a>m <span class="op">=</span> folium.Map(location<span class="op">=</span>[<span class="fl">39.83</span>, <span class="op">-</span><span class="fl">98.58</span>], zoom_start<span class="op">=</span><span class="dv">4</span>, width<span class="op">=</span><span class="dv">800</span>, height<span class="op">=</span><span class="dv">400</span>)</span>
<span id="cb137-4"><a href="#cb137-4" tabindex="-1"></a>fig.add_child(m)</span></code></pre></div>
<p>The map object <code>m</code> can be manipulated by adding different
elements to it. Contrary to how Matplotlib objects work, the map object
does not get emptied when displayed. So you are able to visualize and
incrementally add elements to it. Let’s add some markers to the map
using <a
href="https://python-visualization.github.io/folium/modules.html#folium.map.Marker"><code>folium.map.Marker</code></a>
class.</p>
<div class="sourceCode" id="cb138"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb138-1"><a href="#cb138-1" tabindex="-1"></a>folium.Marker(san_francisco, popup<span class="op">=</span><span class="st">&#39;San Francisco&#39;</span>).add_to(m)</span>
<span id="cb138-2"><a href="#cb138-2" tabindex="-1"></a>folium.Marker(new_york, popup<span class="op">=</span><span class="st">&#39;New York&#39;</span>).add_to(m)</span>
<span id="cb138-3"><a href="#cb138-3" tabindex="-1"></a></span>
<span id="cb138-4"><a href="#cb138-4" tabindex="-1"></a>m</span></code></pre></div>
<p>The markers can be customized to have a different color or icons. You
can check the <a
href="https://python-visualization.github.io/folium/modules.html#folium.map.Icon"><code>folium.map.Icon</code></a>
class for options for creating icons. This class supports a vast range
of icons from the <a
href="https://fontawesome.com/search?m=free&amp;c=maps">fontawesome
icons</a> and <a
href="https://getbootstrap.com/docs/3.3/components/">bootstrap icons</a>
libraries. You can choose the name of the icon from there to use it in
your Folium map. The <code>prefix</code> parameter can be <em>fa</em>
for FontAwesome icons or <em>glyphicon</em> for Bootstrap3.</p>
<div class="sourceCode" id="cb139"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb139-1"><a href="#cb139-1" tabindex="-1"></a><span class="im">from</span> folium <span class="im">import</span> Figure</span>
<span id="cb139-2"><a href="#cb139-2" tabindex="-1"></a>fig <span class="op">=</span> Figure(width<span class="op">=</span><span class="dv">800</span>, height<span class="op">=</span><span class="dv">400</span>)</span>
<span id="cb139-3"><a href="#cb139-3" tabindex="-1"></a>m <span class="op">=</span> folium.Map(location<span class="op">=</span>[<span class="fl">39.83</span>, <span class="op">-</span><span class="fl">98.58</span>], zoom_start<span class="op">=</span><span class="dv">4</span>)</span>
<span id="cb139-4"><a href="#cb139-4" tabindex="-1"></a></span>
<span id="cb139-5"><a href="#cb139-5" tabindex="-1"></a>folium.Marker(</span>
<span id="cb139-6"><a href="#cb139-6" tabindex="-1"></a>    san_francisco,</span>
<span id="cb139-7"><a href="#cb139-7" tabindex="-1"></a>    popup<span class="op">=</span><span class="st">&#39;San Francisco&#39;</span>,</span>
<span id="cb139-8"><a href="#cb139-8" tabindex="-1"></a>    icon<span class="op">=</span>folium.Icon(</span>
<span id="cb139-9"><a href="#cb139-9" tabindex="-1"></a>        color<span class="op">=</span><span class="st">&#39;green&#39;</span>, icon<span class="op">=</span><span class="st">&#39;crosshairs&#39;</span>, prefix<span class="op">=</span><span class="st">&#39;fa&#39;</span>)</span>
<span id="cb139-10"><a href="#cb139-10" tabindex="-1"></a>    ).add_to(m)</span>
<span id="cb139-11"><a href="#cb139-11" tabindex="-1"></a></span>
<span id="cb139-12"><a href="#cb139-12" tabindex="-1"></a>folium.Marker(</span>
<span id="cb139-13"><a href="#cb139-13" tabindex="-1"></a>    new_york,</span>
<span id="cb139-14"><a href="#cb139-14" tabindex="-1"></a>    popup<span class="op">=</span><span class="st">&#39;New York&#39;</span>,</span>
<span id="cb139-15"><a href="#cb139-15" tabindex="-1"></a>    icon<span class="op">=</span>folium.Icon(</span>
<span id="cb139-16"><a href="#cb139-16" tabindex="-1"></a>        color<span class="op">=</span><span class="st">&#39;red&#39;</span>, icon<span class="op">=</span><span class="st">&#39;crosshairs&#39;</span>, prefix<span class="op">=</span><span class="st">&#39;fa&#39;</span>)</span>
<span id="cb139-17"><a href="#cb139-17" tabindex="-1"></a>    ).add_to(m)</span>
<span id="cb139-18"><a href="#cb139-18" tabindex="-1"></a></span>
<span id="cb139-19"><a href="#cb139-19" tabindex="-1"></a>fig.add_child(m)</span></code></pre></div>
<p>We will be using <a
href="https://openrouteservice.org/">OpenRouteService API</a> to
calculate the directions. Visit <a
href="https://account.heigit.org/signup">HeiGIT Sign Up</a> page and
create an account. Once your account is activated, visit your <a
href="https://account.heigit.org/manage/key">Dashboard</a>. Copy the
long string for <strong>Basic Key</strong> key and enter it below.</p>
<div class="sourceCode" id="cb140"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb140-1"><a href="#cb140-1" tabindex="-1"></a>ORS_API_KEY <span class="op">=</span> <span class="st">&#39;&#39;</span></span></code></pre></div>
<div class="sourceCode" id="cb141"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb141-1"><a href="#cb141-1" tabindex="-1"></a><span class="im">import</span> requests</span>
<span id="cb141-2"><a href="#cb141-2" tabindex="-1"></a></span>
<span id="cb141-3"><a href="#cb141-3" tabindex="-1"></a>san_francisco <span class="op">=</span> (<span class="fl">37.7749</span>, <span class="op">-</span><span class="fl">122.4194</span>)</span>
<span id="cb141-4"><a href="#cb141-4" tabindex="-1"></a>new_york <span class="op">=</span> (<span class="fl">40.661</span>, <span class="op">-</span><span class="fl">73.944</span>)</span>
<span id="cb141-5"><a href="#cb141-5" tabindex="-1"></a></span>
<span id="cb141-6"><a href="#cb141-6" tabindex="-1"></a>parameters <span class="op">=</span> {</span>
<span id="cb141-7"><a href="#cb141-7" tabindex="-1"></a>    <span class="st">&#39;api_key&#39;</span>: ORS_API_KEY,</span>
<span id="cb141-8"><a href="#cb141-8" tabindex="-1"></a>    <span class="st">&#39;start&#39;</span> : <span class="st">&#39;</span><span class="sc">{}</span><span class="st">,</span><span class="sc">{}</span><span class="st">&#39;</span>.<span class="bu">format</span>(san_francisco[<span class="dv">1</span>], san_francisco[<span class="dv">0</span>]),</span>
<span id="cb141-9"><a href="#cb141-9" tabindex="-1"></a>    <span class="st">&#39;end&#39;</span> : <span class="st">&#39;</span><span class="sc">{}</span><span class="st">,</span><span class="sc">{}</span><span class="st">&#39;</span>.<span class="bu">format</span>(new_york[<span class="dv">1</span>], new_york[<span class="dv">0</span>])</span>
<span id="cb141-10"><a href="#cb141-10" tabindex="-1"></a>}</span>
<span id="cb141-11"><a href="#cb141-11" tabindex="-1"></a></span>
<span id="cb141-12"><a href="#cb141-12" tabindex="-1"></a>response <span class="op">=</span> requests.get(</span>
<span id="cb141-13"><a href="#cb141-13" tabindex="-1"></a>    <span class="st">&#39;https://api.openrouteservice.org/v2/directions/driving-car&#39;</span>, params<span class="op">=</span>parameters)</span>
<span id="cb141-14"><a href="#cb141-14" tabindex="-1"></a></span>
<span id="cb141-15"><a href="#cb141-15" tabindex="-1"></a><span class="cf">if</span> response.status_code <span class="op">==</span> <span class="dv">200</span>:</span>
<span id="cb141-16"><a href="#cb141-16" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&#39;Request successful.&#39;</span>)</span>
<span id="cb141-17"><a href="#cb141-17" tabindex="-1"></a>    data <span class="op">=</span> response.text</span>
<span id="cb141-18"><a href="#cb141-18" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb141-19"><a href="#cb141-19" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&#39;Request failed.&#39;</span>)</span></code></pre></div>
<p>The API response is formatted as a GeoJSON string.</p>
<div class="sourceCode" id="cb142"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb142-1"><a href="#cb142-1" tabindex="-1"></a>data</span></code></pre></div>
<p>We can parse the GeoJSON as a dictionary and extract the route
summary returned by the API which contains the total driving distance in
meters.</p>
<div class="sourceCode" id="cb143"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb143-1"><a href="#cb143-1" tabindex="-1"></a>parsed_data <span class="op">=</span> json.loads(data)</span>
<span id="cb143-2"><a href="#cb143-2" tabindex="-1"></a>summary <span class="op">=</span> parsed_data[<span class="st">&#39;features&#39;</span>][<span class="dv">0</span>][<span class="st">&#39;properties&#39;</span>][<span class="st">&#39;summary&#39;</span>]</span>
<span id="cb143-3"><a href="#cb143-3" tabindex="-1"></a>distance <span class="op">=</span> <span class="bu">round</span>(summary[<span class="st">&#39;distance&#39;</span>]<span class="op">/</span><span class="dv">1000</span>)</span>
<span id="cb143-4"><a href="#cb143-4" tabindex="-1"></a>tooltip <span class="op">=</span> <span class="st">&#39;Driving Distance: </span><span class="sc">{}</span><span class="st"> km&#39;</span>.<span class="bu">format</span>(distance)</span>
<span id="cb143-5"><a href="#cb143-5" tabindex="-1"></a>tooltip</span></code></pre></div>
<p>We can use the <a
href="https://python-visualization.github.io/folium/latest/user_guide/geojson/geojson.html"><code>folium.features.GeoJson</code></a>
class to load any data in the GeoJSON format directly. We can specify a
<code>smooth_factor</code> parameter which can be used to simplify the
line displayed when zoomed-out. Setting a higher number results in
better performance.</p>
<div class="sourceCode" id="cb144"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb144-1"><a href="#cb144-1" tabindex="-1"></a>folium.GeoJson(</span>
<span id="cb144-2"><a href="#cb144-2" tabindex="-1"></a>    data,</span>
<span id="cb144-3"><a href="#cb144-3" tabindex="-1"></a>    tooltip<span class="op">=</span>tooltip,</span>
<span id="cb144-4"><a href="#cb144-4" tabindex="-1"></a>    smooth_factor<span class="op">=</span><span class="dv">1</span></span>
<span id="cb144-5"><a href="#cb144-5" tabindex="-1"></a>    ).add_to(m)</span>
<span id="cb144-6"><a href="#cb144-6" tabindex="-1"></a>m</span></code></pre></div>
<p>Folium maps can be saved to a HTML file by calling
<code>save()</code> on the map object.</p>
<div class="sourceCode" id="cb145"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb145-1"><a href="#cb145-1" tabindex="-1"></a>output_folder <span class="op">=</span> <span class="st">&#39;output&#39;</span></span>
<span id="cb145-2"><a href="#cb145-2" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> os.path.exists(output_folder):</span>
<span id="cb145-3"><a href="#cb145-3" tabindex="-1"></a>    os.mkdir(output_folder)</span>
<span id="cb145-4"><a href="#cb145-4" tabindex="-1"></a>output_path <span class="op">=</span> os.path.join(output_folder, <span class="st">&#39;directions.html&#39;</span>)</span>
<span id="cb145-5"><a href="#cb145-5" tabindex="-1"></a>m.save(output_path)</span></code></pre></div>
</div>
<div id="exercise-7" class="section level2">
<h2>Exercise</h2>
<ol style="list-style-type: decimal">
<li>Create an interactive map of driving directions between two of your
chosen cities.</li>
<li>Cutomize the marker icons to a <em>car</em> icon. Reference <a
href="https://python-visualization.github.io/folium/modules.html#folium.map.Icon"><code>folium.map.Icon</code></a>.</li>
<li>Change the route line to <em>red</em> color with a line width of 1
pixels. Reference <a
href="https://python-visualization.github.io/folium/latest/user_guide/geojson/geojson.html#Styling"><code>folium.features.GeoJSON</code>
Styling</a></li>
</ol>
<p><img src='https://courses.spatialthoughts.com/images/python_dataviz/folium_route.png' width=600/></p>
<p>Use the code block below as the starting point and replace the
variables below with those of your chosen locations and insert your own
API key.</p>
<div class="sourceCode" id="cb146"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb146-1"><a href="#cb146-1" tabindex="-1"></a><span class="im">import</span> folium</span>
<span id="cb146-2"><a href="#cb146-2" tabindex="-1"></a><span class="im">from</span> folium <span class="im">import</span> Figure</span>
<span id="cb146-3"><a href="#cb146-3" tabindex="-1"></a><span class="im">import</span> json</span>
<span id="cb146-4"><a href="#cb146-4" tabindex="-1"></a><span class="im">import</span> requests</span>
<span id="cb146-5"><a href="#cb146-5" tabindex="-1"></a></span>
<span id="cb146-6"><a href="#cb146-6" tabindex="-1"></a><span class="co">###############################</span></span>
<span id="cb146-7"><a href="#cb146-7" tabindex="-1"></a><span class="co">###  Replace Variables Below</span></span>
<span id="cb146-8"><a href="#cb146-8" tabindex="-1"></a><span class="co">###############################</span></span>
<span id="cb146-9"><a href="#cb146-9" tabindex="-1"></a>origin <span class="op">=</span> (<span class="fl">37.7749</span>, <span class="op">-</span><span class="fl">122.4194</span>)</span>
<span id="cb146-10"><a href="#cb146-10" tabindex="-1"></a>origin_name <span class="op">=</span> <span class="st">&#39;San Francisco&#39;</span></span>
<span id="cb146-11"><a href="#cb146-11" tabindex="-1"></a>destination <span class="op">=</span> (<span class="fl">40.661</span>, <span class="op">-</span><span class="fl">73.944</span>)</span>
<span id="cb146-12"><a href="#cb146-12" tabindex="-1"></a>destination_name <span class="op">=</span> <span class="st">&#39;New York&#39;</span></span>
<span id="cb146-13"><a href="#cb146-13" tabindex="-1"></a>map_center <span class="op">=</span> (<span class="fl">39.83</span>, <span class="op">-</span><span class="fl">98.58</span>)</span>
<span id="cb146-14"><a href="#cb146-14" tabindex="-1"></a>ORS_API_KEY <span class="op">=</span> <span class="st">&#39;&#39;</span></span>
<span id="cb146-15"><a href="#cb146-15" tabindex="-1"></a><span class="co">###############################</span></span>
<span id="cb146-16"><a href="#cb146-16" tabindex="-1"></a>parameters <span class="op">=</span> {</span>
<span id="cb146-17"><a href="#cb146-17" tabindex="-1"></a>    <span class="st">&#39;api_key&#39;</span>: ORS_API_KEY,</span>
<span id="cb146-18"><a href="#cb146-18" tabindex="-1"></a>    <span class="st">&#39;start&#39;</span> : <span class="st">&#39;</span><span class="sc">{}</span><span class="st">,</span><span class="sc">{}</span><span class="st">&#39;</span>.<span class="bu">format</span>(origin[<span class="dv">1</span>], origin[<span class="dv">0</span>]),</span>
<span id="cb146-19"><a href="#cb146-19" tabindex="-1"></a>    <span class="st">&#39;end&#39;</span> : <span class="st">&#39;</span><span class="sc">{}</span><span class="st">,</span><span class="sc">{}</span><span class="st">&#39;</span>.<span class="bu">format</span>(destination[<span class="dv">1</span>], destination[<span class="dv">0</span>])</span>
<span id="cb146-20"><a href="#cb146-20" tabindex="-1"></a>}</span>
<span id="cb146-21"><a href="#cb146-21" tabindex="-1"></a></span>
<span id="cb146-22"><a href="#cb146-22" tabindex="-1"></a>response <span class="op">=</span> requests.get(</span>
<span id="cb146-23"><a href="#cb146-23" tabindex="-1"></a>    <span class="st">&#39;https://api.openrouteservice.org/v2/directions/driving-car&#39;</span>, params<span class="op">=</span>parameters)</span>
<span id="cb146-24"><a href="#cb146-24" tabindex="-1"></a></span>
<span id="cb146-25"><a href="#cb146-25" tabindex="-1"></a><span class="cf">if</span> response.status_code <span class="op">==</span> <span class="dv">200</span>:</span>
<span id="cb146-26"><a href="#cb146-26" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&#39;Request successful.&#39;</span>)</span>
<span id="cb146-27"><a href="#cb146-27" tabindex="-1"></a>    data <span class="op">=</span> response.text</span>
<span id="cb146-28"><a href="#cb146-28" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb146-29"><a href="#cb146-29" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&#39;Request failed.&#39;</span>)</span>
<span id="cb146-30"><a href="#cb146-30" tabindex="-1"></a></span>
<span id="cb146-31"><a href="#cb146-31" tabindex="-1"></a>parsed_data <span class="op">=</span> json.loads(data)</span>
<span id="cb146-32"><a href="#cb146-32" tabindex="-1"></a>summary <span class="op">=</span> parsed_data[<span class="st">&#39;features&#39;</span>][<span class="dv">0</span>][<span class="st">&#39;properties&#39;</span>][<span class="st">&#39;summary&#39;</span>]</span>
<span id="cb146-33"><a href="#cb146-33" tabindex="-1"></a>distance <span class="op">=</span> <span class="bu">round</span>(summary[<span class="st">&#39;distance&#39;</span>]<span class="op">/</span><span class="dv">1000</span>)</span>
<span id="cb146-34"><a href="#cb146-34" tabindex="-1"></a>tooltip <span class="op">=</span> <span class="st">&#39;Driving Distance: </span><span class="sc">{}</span><span class="st"> km&#39;</span>.<span class="bu">format</span>(distance)</span>
<span id="cb146-35"><a href="#cb146-35" tabindex="-1"></a></span>
<span id="cb146-36"><a href="#cb146-36" tabindex="-1"></a>fig <span class="op">=</span> Figure(width<span class="op">=</span><span class="dv">800</span>, height<span class="op">=</span><span class="dv">400</span>)</span>
<span id="cb146-37"><a href="#cb146-37" tabindex="-1"></a></span>
<span id="cb146-38"><a href="#cb146-38" tabindex="-1"></a>m <span class="op">=</span> folium.Map(location<span class="op">=</span>map_center, zoom_start<span class="op">=</span><span class="dv">4</span>)</span>
<span id="cb146-39"><a href="#cb146-39" tabindex="-1"></a></span>
<span id="cb146-40"><a href="#cb146-40" tabindex="-1"></a>folium.Marker(</span>
<span id="cb146-41"><a href="#cb146-41" tabindex="-1"></a>    origin, </span>
<span id="cb146-42"><a href="#cb146-42" tabindex="-1"></a>    popup<span class="op">=</span>origin_name,</span>
<span id="cb146-43"><a href="#cb146-43" tabindex="-1"></a>    icon<span class="op">=</span>folium.Icon(</span>
<span id="cb146-44"><a href="#cb146-44" tabindex="-1"></a>        color<span class="op">=</span><span class="st">&#39;green&#39;</span>, icon<span class="op">=</span><span class="st">&#39;car&#39;</span>, prefix<span class="op">=</span><span class="st">&#39;fa&#39;</span>)</span>
<span id="cb146-45"><a href="#cb146-45" tabindex="-1"></a>    ).add_to(m)</span>
<span id="cb146-46"><a href="#cb146-46" tabindex="-1"></a></span>
<span id="cb146-47"><a href="#cb146-47" tabindex="-1"></a>folium.Marker(</span>
<span id="cb146-48"><a href="#cb146-48" tabindex="-1"></a>    destination, </span>
<span id="cb146-49"><a href="#cb146-49" tabindex="-1"></a>    popup<span class="op">=</span>destination_name,</span>
<span id="cb146-50"><a href="#cb146-50" tabindex="-1"></a>    icon<span class="op">=</span>folium.Icon(</span>
<span id="cb146-51"><a href="#cb146-51" tabindex="-1"></a>        color<span class="op">=</span><span class="st">&#39;red&#39;</span>, icon<span class="op">=</span><span class="st">&#39;car&#39;</span>, prefix<span class="op">=</span><span class="st">&#39;fa&#39;</span>)</span>
<span id="cb146-52"><a href="#cb146-52" tabindex="-1"></a>    ).add_to(m)</span>
<span id="cb146-53"><a href="#cb146-53" tabindex="-1"></a></span>
<span id="cb146-54"><a href="#cb146-54" tabindex="-1"></a>folium.GeoJson(</span>
<span id="cb146-55"><a href="#cb146-55" tabindex="-1"></a>    data,</span>
<span id="cb146-56"><a href="#cb146-56" tabindex="-1"></a>    tooltip<span class="op">=</span>tooltip,</span>
<span id="cb146-57"><a href="#cb146-57" tabindex="-1"></a>    smooth_factor<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb146-58"><a href="#cb146-58" tabindex="-1"></a>   ).add_to(m)</span>
<span id="cb146-59"><a href="#cb146-59" tabindex="-1"></a></span>
<span id="cb146-60"><a href="#cb146-60" tabindex="-1"></a></span>
<span id="cb146-61"><a href="#cb146-61" tabindex="-1"></a>fig.add_child(m)</span></code></pre></div>
<hr />
<hr />
</div>
</div>
<div id="multi-layer-interactive-maps" class="section level1">
<h1>Multi-layer Interactive Maps</h1>
<p><a
href="https://colab.research.google.com/github/spatialthoughts/python-dataviz-web/blob/main/09_multilayer_maps.ipynb"><img
src="https://colab.research.google.com/assets/colab-badge.svg"
alt="Open In Colab" /></a></p>
<p>Open the notebook named <code>09_multilayer_maps.ipynb</code>.</p>
<hr />
<div id="overview-8" class="section level2">
<h2>Overview</h2>
<p><a href="https://python-visualization.github.io/folium/">Folium</a>
supports creating maps with multiple layers. Recent versions of
GeoPandas have built-in support to create interactive folium maps from a
GeoDataFrame using the <code>explore()</code> function.</p>
<p>In this section, we will create a multi-layer interactive map using 2
vector datasets.</p>
</div>
<div id="setup-and-data-download-7" class="section level2">
<h2>Setup and Data Download</h2>
<div class="sourceCode" id="cb147"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb147-1"><a href="#cb147-1" tabindex="-1"></a><span class="op">%%</span>capture</span>
<span id="cb147-2"><a href="#cb147-2" tabindex="-1"></a><span class="cf">if</span> <span class="st">&#39;google.colab&#39;</span> <span class="kw">in</span> <span class="bu">str</span>(get_ipython()):</span>
<span id="cb147-3"><a href="#cb147-3" tabindex="-1"></a>  <span class="op">!</span>pip install mapclassify fiona</span></code></pre></div>
<div class="sourceCode" id="cb148"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb148-1"><a href="#cb148-1" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb148-2"><a href="#cb148-2" tabindex="-1"></a><span class="im">import</span> fiona</span>
<span id="cb148-3"><a href="#cb148-3" tabindex="-1"></a><span class="im">import</span> folium</span>
<span id="cb148-4"><a href="#cb148-4" tabindex="-1"></a><span class="im">from</span> folium <span class="im">import</span> Figure</span>
<span id="cb148-5"><a href="#cb148-5" tabindex="-1"></a><span class="im">import</span> geopandas <span class="im">as</span> gpd</span>
<span id="cb148-6"><a href="#cb148-6" tabindex="-1"></a><span class="im">import</span> requests</span></code></pre></div>
<div class="sourceCode" id="cb149"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb149-1"><a href="#cb149-1" tabindex="-1"></a>data_folder <span class="op">=</span> <span class="st">&#39;data&#39;</span></span>
<span id="cb149-2"><a href="#cb149-2" tabindex="-1"></a>output_folder <span class="op">=</span> <span class="st">&#39;output&#39;</span></span>
<span id="cb149-3"><a href="#cb149-3" tabindex="-1"></a></span>
<span id="cb149-4"><a href="#cb149-4" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> os.path.exists(data_folder):</span>
<span id="cb149-5"><a href="#cb149-5" tabindex="-1"></a>    os.mkdir(data_folder)</span>
<span id="cb149-6"><a href="#cb149-6" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> os.path.exists(output_folder):</span>
<span id="cb149-7"><a href="#cb149-7" tabindex="-1"></a>    os.mkdir(output_folder)</span></code></pre></div>
<div class="sourceCode" id="cb150"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb150-1"><a href="#cb150-1" tabindex="-1"></a><span class="kw">def</span> download(url):</span>
<span id="cb150-2"><a href="#cb150-2" tabindex="-1"></a>    filename <span class="op">=</span> os.path.join(data_folder, os.path.basename(url))</span>
<span id="cb150-3"><a href="#cb150-3" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> os.path.exists(filename):</span>
<span id="cb150-4"><a href="#cb150-4" tabindex="-1"></a>      <span class="cf">with</span> requests.get(url, stream<span class="op">=</span><span class="va">True</span>, allow_redirects<span class="op">=</span><span class="va">True</span>) <span class="im">as</span> r:</span>
<span id="cb150-5"><a href="#cb150-5" tabindex="-1"></a>          <span class="cf">with</span> <span class="bu">open</span>(filename, <span class="st">&#39;wb&#39;</span>) <span class="im">as</span> f:</span>
<span id="cb150-6"><a href="#cb150-6" tabindex="-1"></a>              <span class="cf">for</span> chunk <span class="kw">in</span> r.iter_content(chunk_size<span class="op">=</span><span class="dv">8192</span>):</span>
<span id="cb150-7"><a href="#cb150-7" tabindex="-1"></a>                  f.write(chunk)</span>
<span id="cb150-8"><a href="#cb150-8" tabindex="-1"></a>      <span class="bu">print</span>(<span class="st">&#39;Downloaded&#39;</span>, filename)</span></code></pre></div>
<div class="sourceCode" id="cb151"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb151-1"><a href="#cb151-1" tabindex="-1"></a>filename <span class="op">=</span> <span class="st">&#39;karnataka.gpkg&#39;</span></span>
<span id="cb151-2"><a href="#cb151-2" tabindex="-1"></a>data_url <span class="op">=</span> <span class="st">&#39;https://github.com/spatialthoughts/python-dataviz-web/releases/&#39;</span> \</span>
<span id="cb151-3"><a href="#cb151-3" tabindex="-1"></a>  <span class="st">&#39;download/osm/&#39;</span></span>
<span id="cb151-4"><a href="#cb151-4" tabindex="-1"></a>download(data_url <span class="op">+</span> filename)</span></code></pre></div>
</div>
<div id="using-geopandas-explore" class="section level2">
<h2>Using GeoPandas explore()</h2>
<p>Read the individual layers from the GeoPackage using GeoPandas. First
we use <code>fiona</code> to list all available layers in the
GeoPackage.</p>
<div class="sourceCode" id="cb152"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb152-1"><a href="#cb152-1" tabindex="-1"></a>data_pkg_path <span class="op">=</span> <span class="st">&#39;data&#39;</span></span>
<span id="cb152-2"><a href="#cb152-2" tabindex="-1"></a>filename <span class="op">=</span> <span class="st">&#39;karnataka.gpkg&#39;</span></span>
<span id="cb152-3"><a href="#cb152-3" tabindex="-1"></a>path <span class="op">=</span> os.path.join(data_pkg_path, filename)</span>
<span id="cb152-4"><a href="#cb152-4" tabindex="-1"></a>layers <span class="op">=</span> fiona.listlayers(path)</span>
<span id="cb152-5"><a href="#cb152-5" tabindex="-1"></a>layers</span></code></pre></div>
<div class="sourceCode" id="cb153"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb153-1"><a href="#cb153-1" tabindex="-1"></a>roads_gdf <span class="op">=</span> gpd.read_file(path, layer<span class="op">=</span><span class="st">&#39;karnataka_highways&#39;</span>)</span>
<span id="cb153-2"><a href="#cb153-2" tabindex="-1"></a>districts_gdf <span class="op">=</span> gpd.read_file(path, layer<span class="op">=</span><span class="st">&#39;karnataka_districts&#39;</span>)</span>
<span id="cb153-3"><a href="#cb153-3" tabindex="-1"></a>state_gdf <span class="op">=</span> gpd.read_file(path, layer<span class="op">=</span><span class="st">&#39;karnataka&#39;</span>)</span></code></pre></div>
<p>We can use the <a
href="https://geopandas.org/en/stable/docs/reference/api/geopandas.GeoDataFrame.explore.html">explore()</a>
method to create an interactive folium map from the GeoDataFrame. When
you call <code>explore()</code> a folium object is created. You can save
that object and use it to display or add more layers to the map.</p>
<div class="sourceCode" id="cb154"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb154-1"><a href="#cb154-1" tabindex="-1"></a>m <span class="op">=</span> districts_gdf.explore()</span>
<span id="cb154-2"><a href="#cb154-2" tabindex="-1"></a>m</span></code></pre></div>
<p>The default output of the <code>explore()</code> method is a
full-width folium map. If you need more control, a better approach is to
create a <code>follium.Figure</code> object and add the map to it. For
this approach we need to first compute the extent of the map.</p>
<div class="sourceCode" id="cb155"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb155-1"><a href="#cb155-1" tabindex="-1"></a>bounds <span class="op">=</span> districts_gdf.total_bounds</span>
<span id="cb155-2"><a href="#cb155-2" tabindex="-1"></a>bounds</span></code></pre></div>
<p>Now we can create a figure of the required size, and add a folium map
to it. The <code>explore()</code> function takes a <code>m</code>
agrument where we can supply an existing folium map to which to render
the GeoDataFrame.</p>
<div class="sourceCode" id="cb156"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb156-1"><a href="#cb156-1" tabindex="-1"></a>fig <span class="op">=</span> Figure(width<span class="op">=</span><span class="dv">800</span>, height<span class="op">=</span><span class="dv">400</span>)</span>
<span id="cb156-2"><a href="#cb156-2" tabindex="-1"></a></span>
<span id="cb156-3"><a href="#cb156-3" tabindex="-1"></a>m <span class="op">=</span> folium.Map()</span>
<span id="cb156-4"><a href="#cb156-4" tabindex="-1"></a>m.fit_bounds([[bounds[<span class="dv">1</span>],bounds[<span class="dv">0</span>]], [bounds[<span class="dv">3</span>],bounds[<span class="dv">2</span>]]])</span>
<span id="cb156-5"><a href="#cb156-5" tabindex="-1"></a></span>
<span id="cb156-6"><a href="#cb156-6" tabindex="-1"></a>districts_gdf.explore(m<span class="op">=</span>m)</span>
<span id="cb156-7"><a href="#cb156-7" tabindex="-1"></a></span>
<span id="cb156-8"><a href="#cb156-8" tabindex="-1"></a>fig.add_child(m)</span></code></pre></div>
<p>Folium supports a variety of basemaps. Let’s change the basemap to
use <em>Cartodb Positron</em> tiles. Additionally, we can change the
styling using the <code>color</code> and <code>style_kwds</code>
parameters.</p>
<p><em>Reference: <a
href="https://python-visualization.github.io/folium/latest/user_guide/raster_layers/tiles.html">Folium
Tiles</a></em></p>
<div class="sourceCode" id="cb157"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb157-1"><a href="#cb157-1" tabindex="-1"></a>fig <span class="op">=</span> Figure(width<span class="op">=</span><span class="dv">800</span>, height<span class="op">=</span><span class="dv">400</span>)</span>
<span id="cb157-2"><a href="#cb157-2" tabindex="-1"></a></span>
<span id="cb157-3"><a href="#cb157-3" tabindex="-1"></a>m <span class="op">=</span> folium.Map(tiles<span class="op">=</span><span class="st">&#39;Cartodb Positron&#39;</span>)</span>
<span id="cb157-4"><a href="#cb157-4" tabindex="-1"></a>m.fit_bounds([[bounds[<span class="dv">1</span>],bounds[<span class="dv">0</span>]], [bounds[<span class="dv">3</span>],bounds[<span class="dv">2</span>]]])</span>
<span id="cb157-5"><a href="#cb157-5" tabindex="-1"></a></span>
<span id="cb157-6"><a href="#cb157-6" tabindex="-1"></a>districts_gdf.explore(</span>
<span id="cb157-7"><a href="#cb157-7" tabindex="-1"></a>    m<span class="op">=</span>m,</span>
<span id="cb157-8"><a href="#cb157-8" tabindex="-1"></a>    color<span class="op">=</span><span class="st">&#39;black&#39;</span>,</span>
<span id="cb157-9"><a href="#cb157-9" tabindex="-1"></a>    style_kwds<span class="op">=</span>{<span class="st">&#39;fillOpacity&#39;</span>: <span class="fl">0.3</span>, <span class="st">&#39;weight&#39;</span>: <span class="fl">0.5</span>},</span>
<span id="cb157-10"><a href="#cb157-10" tabindex="-1"></a>  )</span>
<span id="cb157-11"><a href="#cb157-11" tabindex="-1"></a></span>
<span id="cb157-12"><a href="#cb157-12" tabindex="-1"></a>fig.add_child(m)</span></code></pre></div>
<p>Let’s add the <code>roads_gdf</code> layer to the map.</p>
<div class="sourceCode" id="cb158"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb158-1"><a href="#cb158-1" tabindex="-1"></a>roads_gdf</span></code></pre></div>
<p>The GeoDataFrame contains roads of different categories as given in
the <code>ref</code> column. Let’s add a category column so we can use
it to apply different styles to each category of the road.</p>
<div class="sourceCode" id="cb159"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb159-1"><a href="#cb159-1" tabindex="-1"></a><span class="kw">def</span> get_category(row):</span>
<span id="cb159-2"><a href="#cb159-2" tabindex="-1"></a>    ref <span class="op">=</span> <span class="bu">str</span>(row[<span class="st">&#39;ref&#39;</span>])</span>
<span id="cb159-3"><a href="#cb159-3" tabindex="-1"></a>    <span class="cf">if</span> <span class="st">&#39;NH&#39;</span> <span class="kw">in</span> ref:</span>
<span id="cb159-4"><a href="#cb159-4" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">&#39;NH&#39;</span></span>
<span id="cb159-5"><a href="#cb159-5" tabindex="-1"></a>    <span class="cf">elif</span> <span class="st">&#39;SH&#39;</span> <span class="kw">in</span> ref:</span>
<span id="cb159-6"><a href="#cb159-6" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">&#39;SH&#39;</span></span>
<span id="cb159-7"><a href="#cb159-7" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb159-8"><a href="#cb159-8" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">&#39;NA&#39;</span></span>
<span id="cb159-9"><a href="#cb159-9" tabindex="-1"></a></span>
<span id="cb159-10"><a href="#cb159-10" tabindex="-1"></a>roads_gdf[<span class="st">&#39;category&#39;</span>] <span class="op">=</span> roads_gdf.<span class="bu">apply</span>(get_category, axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb159-11"><a href="#cb159-11" tabindex="-1"></a>roads_gdf</span></code></pre></div>
<p>Now we can use the <code>category</code> column to style the layer
with different colors. Additionally, we customize the
<code>tooltip</code> to show only the selected columns when hovering
over a feature and <code>tooltip_kwds</code> to customize the name of
the column being displayed.</p>
<div class="sourceCode" id="cb160"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb160-1"><a href="#cb160-1" tabindex="-1"></a>fig <span class="op">=</span> Figure(width<span class="op">=</span><span class="dv">800</span>, height<span class="op">=</span><span class="dv">400</span>)</span>
<span id="cb160-2"><a href="#cb160-2" tabindex="-1"></a></span>
<span id="cb160-3"><a href="#cb160-3" tabindex="-1"></a>m <span class="op">=</span> folium.Map(tiles<span class="op">=</span><span class="st">&#39;Cartodb Positron&#39;</span>)</span>
<span id="cb160-4"><a href="#cb160-4" tabindex="-1"></a>m.fit_bounds([[bounds[<span class="dv">1</span>],bounds[<span class="dv">0</span>]], [bounds[<span class="dv">3</span>],bounds[<span class="dv">2</span>]]])</span>
<span id="cb160-5"><a href="#cb160-5" tabindex="-1"></a></span>
<span id="cb160-6"><a href="#cb160-6" tabindex="-1"></a>roads_gdf.explore(</span>
<span id="cb160-7"><a href="#cb160-7" tabindex="-1"></a>    m<span class="op">=</span>m,</span>
<span id="cb160-8"><a href="#cb160-8" tabindex="-1"></a>    column<span class="op">=</span><span class="st">&#39;category&#39;</span>,</span>
<span id="cb160-9"><a href="#cb160-9" tabindex="-1"></a>    categories<span class="op">=</span>[<span class="st">&#39;NH&#39;</span>, <span class="st">&#39;SH&#39;</span>],</span>
<span id="cb160-10"><a href="#cb160-10" tabindex="-1"></a>    cmap<span class="op">=</span>[<span class="st">&#39;#1f78b4&#39;</span>, <span class="st">&#39;#e31a1c&#39;</span>],</span>
<span id="cb160-11"><a href="#cb160-11" tabindex="-1"></a>    categorical<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb160-12"><a href="#cb160-12" tabindex="-1"></a>    tooltip<span class="op">=</span>[<span class="st">&#39;ref&#39;</span>],</span>
<span id="cb160-13"><a href="#cb160-13" tabindex="-1"></a>    tooltip_kwds<span class="op">=</span>{<span class="st">&#39;aliases&#39;</span>: [<span class="st">&#39;name&#39;</span>]}</span>
<span id="cb160-14"><a href="#cb160-14" tabindex="-1"></a>)</span>
<span id="cb160-15"><a href="#cb160-15" tabindex="-1"></a></span>
<span id="cb160-16"><a href="#cb160-16" tabindex="-1"></a>fig.add_child(m)</span></code></pre></div>
</div>
<div id="create-multi-layer-maps" class="section level2">
<h2>Create Multi-layer Maps</h2>
<p>When you call <code>explore()</code> a folium object is created. You
can save that object and add more layers to the same object.</p>
<div class="sourceCode" id="cb161"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb161-1"><a href="#cb161-1" tabindex="-1"></a>fig <span class="op">=</span> Figure(width<span class="op">=</span><span class="dv">800</span>, height<span class="op">=</span><span class="dv">400</span>)</span>
<span id="cb161-2"><a href="#cb161-2" tabindex="-1"></a></span>
<span id="cb161-3"><a href="#cb161-3" tabindex="-1"></a>m <span class="op">=</span> folium.Map(tiles<span class="op">=</span><span class="st">&#39;Cartodb Positron&#39;</span>)</span>
<span id="cb161-4"><a href="#cb161-4" tabindex="-1"></a>m.fit_bounds([[bounds[<span class="dv">1</span>],bounds[<span class="dv">0</span>]], [bounds[<span class="dv">3</span>],bounds[<span class="dv">2</span>]]])</span>
<span id="cb161-5"><a href="#cb161-5" tabindex="-1"></a></span>
<span id="cb161-6"><a href="#cb161-6" tabindex="-1"></a>districts_gdf.explore(</span>
<span id="cb161-7"><a href="#cb161-7" tabindex="-1"></a>    m<span class="op">=</span>m,</span>
<span id="cb161-8"><a href="#cb161-8" tabindex="-1"></a>    color<span class="op">=</span><span class="st">&#39;black&#39;</span>,</span>
<span id="cb161-9"><a href="#cb161-9" tabindex="-1"></a>    style_kwds<span class="op">=</span>{<span class="st">&#39;fillOpacity&#39;</span>: <span class="fl">0.3</span>, <span class="st">&#39;weight&#39;</span>:<span class="fl">0.5</span>},</span>
<span id="cb161-10"><a href="#cb161-10" tabindex="-1"></a>    name<span class="op">=</span><span class="st">&#39;districts&#39;</span>,</span>
<span id="cb161-11"><a href="#cb161-11" tabindex="-1"></a>    tooltip<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb161-12"><a href="#cb161-12" tabindex="-1"></a></span>
<span id="cb161-13"><a href="#cb161-13" tabindex="-1"></a>roads_gdf.explore(</span>
<span id="cb161-14"><a href="#cb161-14" tabindex="-1"></a>    m<span class="op">=</span>m,</span>
<span id="cb161-15"><a href="#cb161-15" tabindex="-1"></a>    column<span class="op">=</span><span class="st">&#39;category&#39;</span>,</span>
<span id="cb161-16"><a href="#cb161-16" tabindex="-1"></a>    categories<span class="op">=</span>[<span class="st">&#39;NH&#39;</span>, <span class="st">&#39;SH&#39;</span>],</span>
<span id="cb161-17"><a href="#cb161-17" tabindex="-1"></a>    cmap<span class="op">=</span>[<span class="st">&#39;#1f78b4&#39;</span>, <span class="st">&#39;#e31a1c&#39;</span>],</span>
<span id="cb161-18"><a href="#cb161-18" tabindex="-1"></a>    categorical<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb161-19"><a href="#cb161-19" tabindex="-1"></a>    tooltip<span class="op">=</span>[<span class="st">&#39;ref&#39;</span>],</span>
<span id="cb161-20"><a href="#cb161-20" tabindex="-1"></a>    tooltip_kwds<span class="op">=</span>{<span class="st">&#39;aliases&#39;</span>: [<span class="st">&#39;name&#39;</span>]},</span>
<span id="cb161-21"><a href="#cb161-21" tabindex="-1"></a>    name<span class="op">=</span><span class="st">&#39;highways&#39;</span></span>
<span id="cb161-22"><a href="#cb161-22" tabindex="-1"></a>)</span>
<span id="cb161-23"><a href="#cb161-23" tabindex="-1"></a></span>
<span id="cb161-24"><a href="#cb161-24" tabindex="-1"></a>fig.add_child(m)</span></code></pre></div>
<p>To make our map easier to explore, we also add a <em>Layer
Control</em> that displays the list of layers on the top-right corner
and also allows the users to turn them on or off. The <code>name</code>
parameter to the <code>explore()</code> function controls the name that
will be displayed in the layer control.</p>
<div class="sourceCode" id="cb162"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb162-1"><a href="#cb162-1" tabindex="-1"></a>folium.LayerControl().add_to(m)</span>
<span id="cb162-2"><a href="#cb162-2" tabindex="-1"></a>m</span></code></pre></div>
</div>
<div id="exercise-8" class="section level2">
<h2>Exercise</h2>
<p>Add the <code>state_gdf</code> layer to the folium map below with a
thick blue border and no fill. Save the resulting map as a HTML file on
your computer.</p>
<p>Hint: Use the <code>style_kwds</code> with <em>‘fill’</em> and
<em>‘weight’</em> options.</p>
<p><img src='https://courses.spatialthoughts.com/images/python_dataviz/folium_multilayer.png' width=600/></p>
<p>Use the code below as your starting point for the exercise.</p>
<div class="sourceCode" id="cb163"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb163-1"><a href="#cb163-1" tabindex="-1"></a>fig <span class="op">=</span> Figure(width<span class="op">=</span><span class="dv">800</span>, height<span class="op">=</span><span class="dv">400</span>)</span>
<span id="cb163-2"><a href="#cb163-2" tabindex="-1"></a></span>
<span id="cb163-3"><a href="#cb163-3" tabindex="-1"></a>m <span class="op">=</span> folium.Map(tiles<span class="op">=</span><span class="st">&#39;Cartodb Positron&#39;</span>)</span>
<span id="cb163-4"><a href="#cb163-4" tabindex="-1"></a>m.fit_bounds([[bounds[<span class="dv">1</span>],bounds[<span class="dv">0</span>]], [bounds[<span class="dv">3</span>],bounds[<span class="dv">2</span>]]])</span>
<span id="cb163-5"><a href="#cb163-5" tabindex="-1"></a></span>
<span id="cb163-6"><a href="#cb163-6" tabindex="-1"></a>districts_gdf.explore(</span>
<span id="cb163-7"><a href="#cb163-7" tabindex="-1"></a>    m<span class="op">=</span>m,</span>
<span id="cb163-8"><a href="#cb163-8" tabindex="-1"></a>    color<span class="op">=</span><span class="st">&#39;black&#39;</span>,</span>
<span id="cb163-9"><a href="#cb163-9" tabindex="-1"></a>    style_kwds<span class="op">=</span>{<span class="st">&#39;fillOpacity&#39;</span>: <span class="fl">0.3</span>, <span class="st">&#39;weight&#39;</span>:<span class="fl">0.5</span>},</span>
<span id="cb163-10"><a href="#cb163-10" tabindex="-1"></a>    name<span class="op">=</span><span class="st">&#39;districts&#39;</span>,</span>
<span id="cb163-11"><a href="#cb163-11" tabindex="-1"></a>    tooltip<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb163-12"><a href="#cb163-12" tabindex="-1"></a></span>
<span id="cb163-13"><a href="#cb163-13" tabindex="-1"></a>roads_gdf.explore(</span>
<span id="cb163-14"><a href="#cb163-14" tabindex="-1"></a>    m<span class="op">=</span>m,</span>
<span id="cb163-15"><a href="#cb163-15" tabindex="-1"></a>    column<span class="op">=</span><span class="st">&#39;category&#39;</span>,</span>
<span id="cb163-16"><a href="#cb163-16" tabindex="-1"></a>    categories<span class="op">=</span>[<span class="st">&#39;NH&#39;</span>, <span class="st">&#39;SH&#39;</span>],</span>
<span id="cb163-17"><a href="#cb163-17" tabindex="-1"></a>    cmap<span class="op">=</span>[<span class="st">&#39;#1f78b4&#39;</span>, <span class="st">&#39;#e31a1c&#39;</span>],</span>
<span id="cb163-18"><a href="#cb163-18" tabindex="-1"></a>    categorical<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb163-19"><a href="#cb163-19" tabindex="-1"></a>    tooltip<span class="op">=</span>[<span class="st">&#39;ref&#39;</span>],</span>
<span id="cb163-20"><a href="#cb163-20" tabindex="-1"></a>    name<span class="op">=</span><span class="st">&#39;highways&#39;</span>,</span>
<span id="cb163-21"><a href="#cb163-21" tabindex="-1"></a>    tooltip_kwds<span class="op">=</span>{<span class="st">&#39;aliases&#39;</span>: [<span class="st">&#39;name&#39;</span>]}</span>
<span id="cb163-22"><a href="#cb163-22" tabindex="-1"></a>)</span>
<span id="cb163-23"><a href="#cb163-23" tabindex="-1"></a></span>
<span id="cb163-24"><a href="#cb163-24" tabindex="-1"></a>fig.add_child(m)</span>
<span id="cb163-25"><a href="#cb163-25" tabindex="-1"></a>folium.LayerControl().add_to(m)</span>
<span id="cb163-26"><a href="#cb163-26" tabindex="-1"></a></span>
<span id="cb163-27"><a href="#cb163-27" tabindex="-1"></a>m</span></code></pre></div>
</div>
</div>
<div id="leafmap-basics" class="section level1">
<h1>Leafmap Basics</h1>
<p><a
href="https://colab.research.google.com/github/spatialthoughts/python-dataviz-web/blob/main/10_leafmap_basics.ipynb"><img
src="https://colab.research.google.com/assets/colab-badge.svg"
alt="Open In Colab" /></a></p>
<hr />
<div id="overview-9" class="section level2">
<h2>Overview</h2>
<p><a href="https://leafmap.org/">Leafmap</a> is a Python package for
interactive mapping that supports a wide-variety of plotting
backends.</p>
<p>We will explore the capabilities of Leafmap and create a map that
includes vector and raster layers. For a more comprehensive overview,
check out <a
href="https://leafmap.org/notebooks/00_key_features/">leafmap key
Features</a>.</p>
</div>
<div id="setup-and-data-download-8" class="section level2">
<h2>Setup and Data Download</h2>
<div class="sourceCode" id="cb164"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb164-1"><a href="#cb164-1" tabindex="-1"></a><span class="op">%%</span>capture</span>
<span id="cb164-2"><a href="#cb164-2" tabindex="-1"></a><span class="cf">if</span> <span class="st">&#39;google.colab&#39;</span> <span class="kw">in</span> <span class="bu">str</span>(get_ipython()):</span>
<span id="cb164-3"><a href="#cb164-3" tabindex="-1"></a>  <span class="op">!</span>pip install leafmap rioxarray</span></code></pre></div>
<div class="sourceCode" id="cb165"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb165-1"><a href="#cb165-1" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb165-2"><a href="#cb165-2" tabindex="-1"></a><span class="im">import</span> geopandas <span class="im">as</span> gpd</span>
<span id="cb165-3"><a href="#cb165-3" tabindex="-1"></a><span class="im">import</span> leafmap.foliumap <span class="im">as</span> leafmap</span>
<span id="cb165-4"><a href="#cb165-4" tabindex="-1"></a><span class="im">import</span> requests</span></code></pre></div>
<div class="sourceCode" id="cb166"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb166-1"><a href="#cb166-1" tabindex="-1"></a>data_folder <span class="op">=</span> <span class="st">&#39;data&#39;</span></span>
<span id="cb166-2"><a href="#cb166-2" tabindex="-1"></a>output_folder <span class="op">=</span> <span class="st">&#39;output&#39;</span></span>
<span id="cb166-3"><a href="#cb166-3" tabindex="-1"></a></span>
<span id="cb166-4"><a href="#cb166-4" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> os.path.exists(data_folder):</span>
<span id="cb166-5"><a href="#cb166-5" tabindex="-1"></a>    os.mkdir(data_folder)</span>
<span id="cb166-6"><a href="#cb166-6" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> os.path.exists(output_folder):</span>
<span id="cb166-7"><a href="#cb166-7" tabindex="-1"></a>    os.mkdir(output_folder)</span></code></pre></div>
<div class="sourceCode" id="cb167"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb167-1"><a href="#cb167-1" tabindex="-1"></a><span class="kw">def</span> download(url):</span>
<span id="cb167-2"><a href="#cb167-2" tabindex="-1"></a>    filename <span class="op">=</span> os.path.join(data_folder, os.path.basename(url))</span>
<span id="cb167-3"><a href="#cb167-3" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> os.path.exists(filename):</span>
<span id="cb167-4"><a href="#cb167-4" tabindex="-1"></a>      <span class="cf">with</span> requests.get(url, stream<span class="op">=</span><span class="va">True</span>, allow_redirects<span class="op">=</span><span class="va">True</span>) <span class="im">as</span> r:</span>
<span id="cb167-5"><a href="#cb167-5" tabindex="-1"></a>          <span class="cf">with</span> <span class="bu">open</span>(filename, <span class="st">&#39;wb&#39;</span>) <span class="im">as</span> f:</span>
<span id="cb167-6"><a href="#cb167-6" tabindex="-1"></a>              <span class="cf">for</span> chunk <span class="kw">in</span> r.iter_content(chunk_size<span class="op">=</span><span class="dv">8192</span>):</span>
<span id="cb167-7"><a href="#cb167-7" tabindex="-1"></a>                  f.write(chunk)</span>
<span id="cb167-8"><a href="#cb167-8" tabindex="-1"></a>      <span class="bu">print</span>(<span class="st">&#39;Downloaded&#39;</span>, filename)</span></code></pre></div>
<div class="sourceCode" id="cb168"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb168-1"><a href="#cb168-1" tabindex="-1"></a>json_file <span class="op">=</span> <span class="st">&#39;bangalore_wards.json&#39;</span></span>
<span id="cb168-2"><a href="#cb168-2" tabindex="-1"></a>gpkg_file <span class="op">=</span> <span class="st">&#39;bangalore_roads.gpkg&#39;</span></span>
<span id="cb168-3"><a href="#cb168-3" tabindex="-1"></a></span>
<span id="cb168-4"><a href="#cb168-4" tabindex="-1"></a>data_url <span class="op">=</span> <span class="st">&#39;https://github.com/spatialthoughts/python-dataviz-web/releases/&#39;</span> \</span>
<span id="cb168-5"><a href="#cb168-5" tabindex="-1"></a>  <span class="st">&#39;download/bangalore/&#39;</span></span>
<span id="cb168-6"><a href="#cb168-6" tabindex="-1"></a></span>
<span id="cb168-7"><a href="#cb168-7" tabindex="-1"></a><span class="cf">for</span> f <span class="kw">in</span> json_file, gpkg_file:</span>
<span id="cb168-8"><a href="#cb168-8" tabindex="-1"></a>  download(data_url <span class="op">+</span> f)</span></code></pre></div>
</div>
<div id="creating-a-map" class="section level2">
<h2>Creating a Map</h2>
<div class="sourceCode" id="cb169"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb169-1"><a href="#cb169-1" tabindex="-1"></a>m <span class="op">=</span> leafmap.Map(width<span class="op">=</span><span class="dv">800</span>, height<span class="op">=</span><span class="dv">500</span>)</span>
<span id="cb169-2"><a href="#cb169-2" tabindex="-1"></a>m</span></code></pre></div>
<p>You can change the basemap to a Google basemap and set the center of
the map. <code>leafmap.Map()</code> supports many arguments to customize
the map and available controls.</p>
<p>References:</p>
<ul>
<li><a
href="https://leafmap.org/leafmap/#leafmap.leafmap.Map"><code>leafmap.leafmap.Map</code></a></li>
<li><a
href="https://ipyleaflet.readthedocs.io/en/latest/api_reference/index.html#ipyleaflet.leaflet.Map"><code>ipyleaflet.leaflet.Map</code></a></li>
</ul>
<div class="sourceCode" id="cb170"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb170-1"><a href="#cb170-1" tabindex="-1"></a>m <span class="op">=</span> leafmap.Map(width<span class="op">=</span><span class="dv">800</span>, height<span class="op">=</span><span class="dv">500</span>, google_map<span class="op">=</span><span class="st">&#39;HYBRID&#39;</span>, center<span class="op">=</span>(<span class="fl">12.97</span>, <span class="fl">77.59</span>), zoom<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb170-2"><a href="#cb170-2" tabindex="-1"></a>m</span></code></pre></div>
</div>
<div id="adding-data-layers" class="section level2">
<h2>Adding Data Layers</h2>
<p>Leafmap’s <code>foliumap</code> module supports adding a variety of
data types along with helper functions such as
<code>set_center()</code>. Let’s add a GeoJSON file to the map using
<code>add_geojson()</code>.</p>
<p>Reference: <a
href="https://leafmap.org/foliumap/#leafmap.foliumap.Map.add_geojson">leafmap.foliumap.Map.add_geojson</a></p>
<div class="sourceCode" id="cb171"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb171-1"><a href="#cb171-1" tabindex="-1"></a>m <span class="op">=</span> leafmap.Map(width<span class="op">=</span><span class="dv">800</span>, height<span class="op">=</span><span class="dv">500</span>)</span>
<span id="cb171-2"><a href="#cb171-2" tabindex="-1"></a></span>
<span id="cb171-3"><a href="#cb171-3" tabindex="-1"></a>json_filepath <span class="op">=</span> os.path.join(data_folder, json_file)</span>
<span id="cb171-4"><a href="#cb171-4" tabindex="-1"></a></span>
<span id="cb171-5"><a href="#cb171-5" tabindex="-1"></a>m.add_geojson(json_filepath, layer_name<span class="op">=</span><span class="st">&#39;City&#39;</span>)</span>
<span id="cb171-6"><a href="#cb171-6" tabindex="-1"></a>m.set_center(<span class="fl">77.59</span>, <span class="fl">12.97</span>, <span class="dv">10</span>)</span>
<span id="cb171-7"><a href="#cb171-7" tabindex="-1"></a>m</span></code></pre></div>
<p>We can also add any vector layer that can be read by GeoPandas. Here
we add a line layer from a GeoPackage using the <code>add_gdf()</code>
function. The styling parameters can be any folium supported styles.</p>
<div class="sourceCode" id="cb172"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb172-1"><a href="#cb172-1" tabindex="-1"></a>m <span class="op">=</span> leafmap.Map(width<span class="op">=</span><span class="dv">800</span>, height<span class="op">=</span><span class="dv">500</span>)</span>
<span id="cb172-2"><a href="#cb172-2" tabindex="-1"></a></span>
<span id="cb172-3"><a href="#cb172-3" tabindex="-1"></a>gpkg_filepath <span class="op">=</span> os.path.join(data_folder, gpkg_file)</span>
<span id="cb172-4"><a href="#cb172-4" tabindex="-1"></a></span>
<span id="cb172-5"><a href="#cb172-5" tabindex="-1"></a>roads_gdf <span class="op">=</span> gpd.read_file(gpkg_filepath)</span>
<span id="cb172-6"><a href="#cb172-6" tabindex="-1"></a></span>
<span id="cb172-7"><a href="#cb172-7" tabindex="-1"></a>m.add_gdf(roads_gdf, layer_name<span class="op">=</span><span class="st">&#39;Roads&#39;</span>, style<span class="op">=</span>{<span class="st">&#39;color&#39;</span>:<span class="st">&#39;blue&#39;</span>, <span class="st">&#39;weight&#39;</span>:<span class="fl">0.5</span>})</span>
<span id="cb172-8"><a href="#cb172-8" tabindex="-1"></a>m.zoom_to_gdf(roads_gdf)</span>
<span id="cb172-9"><a href="#cb172-9" tabindex="-1"></a>m</span></code></pre></div>
<p>A very useful feature of LeafMap is the ability to load a
Cloud-Optimized GeoTIFF (COG) file directly from a URL without the need
of a server. The file is streamed directly and high-resolution tiles are
automatically fetched as you zoom in. We load a 8-bit RGB image hosted
on GitHub using the <code>add_cog_layer()</code> function.</p>
<p>Reference: <a
href="https://leafmap.org/leafmap/#leafmap.leafmap.Map.add_cog_layer"><code>leafmap.Map.add_cog_layer</code></a></p>
<div class="sourceCode" id="cb173"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb173-1"><a href="#cb173-1" tabindex="-1"></a>cog_url <span class="op">=</span> os.path.join(data_url, <span class="st">&#39;bangalore_lulc_rgb.tif&#39;</span>)</span>
<span id="cb173-2"><a href="#cb173-2" tabindex="-1"></a>cog_url</span></code></pre></div>
<div class="sourceCode" id="cb174"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb174-1"><a href="#cb174-1" tabindex="-1"></a>m <span class="op">=</span> leafmap.Map(width<span class="op">=</span><span class="dv">800</span>, height<span class="op">=</span><span class="dv">500</span>)</span>
<span id="cb174-2"><a href="#cb174-2" tabindex="-1"></a></span>
<span id="cb174-3"><a href="#cb174-3" tabindex="-1"></a>bounds <span class="op">=</span> leafmap.cog_bounds(cog_url)</span>
<span id="cb174-4"><a href="#cb174-4" tabindex="-1"></a></span>
<span id="cb174-5"><a href="#cb174-5" tabindex="-1"></a>m.add_cog_layer(cog_url, name<span class="op">=</span><span class="st">&#39;Land Use Land Cover&#39;</span>)</span>
<span id="cb174-6"><a href="#cb174-6" tabindex="-1"></a>m.zoom_to_bounds(bounds)</span>
<span id="cb174-7"><a href="#cb174-7" tabindex="-1"></a>m</span></code></pre></div>
<p>Leafmap also supports adding custom legends. We define a list of
color codes and labels for the land cover classes contained in the
<code>bangalore_lulc.tif</code> image. We can now add a legend to the
map using the <code>add_legend()</code> function.</p>
<p>Reference: <a
href="https://leafmap.org/foliumap/#leafmap.foliumap.Map.add_legend">leafmap.foliumap.Map.add_legend</a></p>
<div class="sourceCode" id="cb175"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb175-1"><a href="#cb175-1" tabindex="-1"></a>m <span class="op">=</span> leafmap.Map(width<span class="op">=</span><span class="dv">800</span>, height<span class="op">=</span><span class="dv">500</span>)</span>
<span id="cb175-2"><a href="#cb175-2" tabindex="-1"></a></span>
<span id="cb175-3"><a href="#cb175-3" tabindex="-1"></a>bounds <span class="op">=</span> leafmap.cog_bounds(cog_url)</span>
<span id="cb175-4"><a href="#cb175-4" tabindex="-1"></a></span>
<span id="cb175-5"><a href="#cb175-5" tabindex="-1"></a>m.add_cog_layer(cog_url, name<span class="op">=</span><span class="st">&#39;Land Use Land Cover&#39;</span>)</span>
<span id="cb175-6"><a href="#cb175-6" tabindex="-1"></a>m.zoom_to_bounds(bounds)</span>
<span id="cb175-7"><a href="#cb175-7" tabindex="-1"></a></span>
<span id="cb175-8"><a href="#cb175-8" tabindex="-1"></a><span class="co"># Add a Legend</span></span>
<span id="cb175-9"><a href="#cb175-9" tabindex="-1"></a>colors <span class="op">=</span> [<span class="st">&#39;#006400&#39;</span>, <span class="st">&#39;#ffbb22&#39;</span>,<span class="st">&#39;#ffff4c&#39;</span>,<span class="st">&#39;#f096ff&#39;</span>,<span class="st">&#39;#fa0000&#39;</span>,</span>
<span id="cb175-10"><a href="#cb175-10" tabindex="-1"></a>          <span class="st">&#39;#b4b4b4&#39;</span>,<span class="st">&#39;#f0f0f0&#39;</span>,<span class="st">&#39;#0064c8&#39;</span>,<span class="st">&#39;#0096a0&#39;</span>,<span class="st">&#39;#00cf75&#39;</span>,<span class="st">&#39;#fae6a0&#39;</span>]</span>
<span id="cb175-11"><a href="#cb175-11" tabindex="-1"></a>labels <span class="op">=</span> [<span class="st">&quot;Trees&quot;</span>,<span class="st">&quot;Shrubland&quot;</span>,<span class="st">&quot;Grassland&quot;</span>,<span class="st">&quot;Cropland&quot;</span>,<span class="st">&quot;Built-up&quot;</span>,</span>
<span id="cb175-12"><a href="#cb175-12" tabindex="-1"></a>          <span class="st">&quot;Barren / sparse vegetation&quot;</span>,<span class="st">&quot;Snow and ice&quot;</span>,<span class="st">&quot;Open water&quot;</span>,</span>
<span id="cb175-13"><a href="#cb175-13" tabindex="-1"></a>          <span class="st">&quot;Herbaceous wetland&quot;</span>,<span class="st">&quot;Mangroves&quot;</span>,<span class="st">&quot;Moss and lichen&quot;</span>]</span>
<span id="cb175-14"><a href="#cb175-14" tabindex="-1"></a>m.add_legend(colors<span class="op">=</span>colors, labels<span class="op">=</span>labels)</span>
<span id="cb175-15"><a href="#cb175-15" tabindex="-1"></a>m</span></code></pre></div>
<p>We can save the resulting map to a HTML file using the
<code>to_html()</code> function.</p>
<div class="sourceCode" id="cb176"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb176-1"><a href="#cb176-1" tabindex="-1"></a>m <span class="op">=</span> leafmap.Map(width<span class="op">=</span><span class="dv">800</span>, height<span class="op">=</span><span class="dv">500</span>)</span>
<span id="cb176-2"><a href="#cb176-2" tabindex="-1"></a></span>
<span id="cb176-3"><a href="#cb176-3" tabindex="-1"></a>bounds <span class="op">=</span> leafmap.cog_bounds(cog_url)</span>
<span id="cb176-4"><a href="#cb176-4" tabindex="-1"></a></span>
<span id="cb176-5"><a href="#cb176-5" tabindex="-1"></a>m.add_cog_layer(cog_url, name<span class="op">=</span><span class="st">&#39;Land Use Land Cover&#39;</span>)</span>
<span id="cb176-6"><a href="#cb176-6" tabindex="-1"></a>m.zoom_to_bounds(bounds)</span>
<span id="cb176-7"><a href="#cb176-7" tabindex="-1"></a></span>
<span id="cb176-8"><a href="#cb176-8" tabindex="-1"></a><span class="co"># Add a Legend</span></span>
<span id="cb176-9"><a href="#cb176-9" tabindex="-1"></a>colors <span class="op">=</span> [<span class="st">&#39;#006400&#39;</span>, <span class="st">&#39;#ffbb22&#39;</span>,<span class="st">&#39;#ffff4c&#39;</span>,<span class="st">&#39;#f096ff&#39;</span>,<span class="st">&#39;#fa0000&#39;</span>,</span>
<span id="cb176-10"><a href="#cb176-10" tabindex="-1"></a>          <span class="st">&#39;#b4b4b4&#39;</span>,<span class="st">&#39;#f0f0f0&#39;</span>,<span class="st">&#39;#0064c8&#39;</span>,<span class="st">&#39;#0096a0&#39;</span>,<span class="st">&#39;#00cf75&#39;</span>,<span class="st">&#39;#fae6a0&#39;</span>]</span>
<span id="cb176-11"><a href="#cb176-11" tabindex="-1"></a>labels <span class="op">=</span> [<span class="st">&quot;Trees&quot;</span>,<span class="st">&quot;Shrubland&quot;</span>,<span class="st">&quot;Grassland&quot;</span>,<span class="st">&quot;Cropland&quot;</span>,<span class="st">&quot;Built-up&quot;</span>,</span>
<span id="cb176-12"><a href="#cb176-12" tabindex="-1"></a>          <span class="st">&quot;Barren / sparse vegetation&quot;</span>,<span class="st">&quot;Snow and ice&quot;</span>,<span class="st">&quot;Open water&quot;</span>,</span>
<span id="cb176-13"><a href="#cb176-13" tabindex="-1"></a>          <span class="st">&quot;Herbaceous wetland&quot;</span>,<span class="st">&quot;Mangroves&quot;</span>,<span class="st">&quot;Moss and lichen&quot;</span>]</span>
<span id="cb176-14"><a href="#cb176-14" tabindex="-1"></a>m.add_legend(colors<span class="op">=</span>colors, labels<span class="op">=</span>labels)</span>
<span id="cb176-15"><a href="#cb176-15" tabindex="-1"></a></span>
<span id="cb176-16"><a href="#cb176-16" tabindex="-1"></a>output_file <span class="op">=</span> <span class="st">&#39;lulc.html&#39;</span></span>
<span id="cb176-17"><a href="#cb176-17" tabindex="-1"></a>output_path <span class="op">=</span> os.path.join(output_folder, output_file)</span>
<span id="cb176-18"><a href="#cb176-18" tabindex="-1"></a>m.to_html(output_path)</span></code></pre></div>
</div>
<div id="exercise-9" class="section level2">
<h2>Exercise</h2>
<p>We want to visualize a large (7.9GB) raster on the map. The URL to a
Cloud Optmized GeoTiff (COG) file hosted on Google Cloud Storage is
given below. Add the raster to the map, apply a colormap and zoom the
map to your region of interest.</p>
<p><img src='https://courses.spatialthoughts.com/images/python_dataviz/leafmap_cog.png' width=600/></p>
<p>Use the code block below as your starting point.</p>
<p>Hints:</p>
<ul>
<li>The GeoTIFF image is a single-band image with grayscale values of
night time light intensities. Specify additional <code>kwargs</code>
parameters from <a
href="https://leafmap.org/leafmap/#leafmap.leafmap.Map.add_cog_layer"><code>leafmap.Map.add_cog_layer()</code></a>.
<ul>
<li>The range of these values are between 0-60. Use
<code>rescale='0,60'</code>.</li>
<li>A grayscale image can be displayed in color using a named colormap.
For example <code>colormap_name='viridis'</code>.</li>
<li>The map automatically zooms to the extent of the COG. Turn that
behavior off by supplying <code>zoom_to_layer=False</code>.</li>
</ul></li>
<li>To zoom to your chosen region, use <a
href="https://leafmap.org/leafmap/#leafmap.leafmap.Map.zoom_to_bounds"><code>leafmap.Map.zoom_to_bounds()</code></a>
method with the bounding box in the
<code>[minx, miny, maxx, maxy]</code> format. You can use this <a
href="https://boundingbox.streamlit.app/">bounding box app</a> to find
the coordinates for your region.</li>
</ul>
<div class="sourceCode" id="cb177"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb177-1"><a href="#cb177-1" tabindex="-1"></a>gcs_bucket <span class="op">=</span> <span class="st">&#39;https://storage.googleapis.com/spatialthoughts-public-data/ntl/viirs/&#39;</span></span>
<span id="cb177-2"><a href="#cb177-2" tabindex="-1"></a>cog_url <span class="op">=</span> os.path.join(gcs_bucket, <span class="st">&#39;viirs_ntl_2021_global.tif&#39;</span>)</span></code></pre></div>
<div style="page-break-after: always;"></div>
</div>
</div>
<div id="streamlit-basics" class="section level1">
<h1>Streamlit Basics</h1>
<p>Streamlit is a Python library that allows you to create web-apps and
dashboard by just writing Python code. It provides you with a wide range
of UI widgets and layouts that can be used to build user- interfaces.
Your streamlit app is just a regular Python file with a <code>.py</code>
extension.</p>
<p><a
href="https://www.youtube.com/watch?v=FF1frIR0XoI&amp;list=PLppGmFLhQ1HLzGl8auwYkdUMu_z0Hz7G6&amp;index=21"
target="_blank"><img
src="https://img.youtube.com/vi/FF1frIR0XoI/mqdefault.jpg"
alt="Watch the Video" /></a></p>
<p><a
href="https://www.youtube.com/watch?v=FF1frIR0XoI&amp;list=PLppGmFLhQ1HLzGl8auwYkdUMu_z0Hz7G6&amp;index=21"
target="_blank">Watch the Video ↗</a></p>
<p><a
href="https://docs.google.com/presentation/d/1aHJPScvjx4ioGkBUSBm2od8FoxKwARdgBJiJ2TSfySs/edit?usp=sharing"
target="_blank">View the Presentation ↗</a></p>
<div id="installation-and-setting-up-the-environment"
class="section level2">
<h2>Installation and Setting up the Environment</h2>
<p>You need to install the <code>streamlit</code> package to create the
app. We will be using Anaconda to install <code>streamlit</code> and
related packages on your machine. Please review the <a
href="https://courses.spatialthoughts.com/python-foundation.html#installation-and-setting-up-the-environment">Anaconda
Installation Guide</a> for step-by-step instructions.</p>
<ol style="list-style-type: decimal">
<li>Once you have installed Anaconda, open <em>Anaconda Prompt</em> or a
<em>Terminal</em> and run the following commands.</li>
</ol>
<pre><code>conda update --all
conda create --name streamlit -y
conda activate streamlit</code></pre>
<ol start="2" style="list-style-type: decimal">
<li>Now your environment is ready. We will install the required
packages. First install <code>geopandas</code>.</li>
</ol>
<pre><code>conda install -c conda-forge geopandas  -y</code></pre>
<ol start="3" style="list-style-type: decimal">
<li>Next we will install <code>streamlit</code> and
<code>leafmap</code>.</li>
</ol>
<pre><code>conda install -c conda-forge streamlit streamlit-folium leafmap -y</code></pre>
<p>If the conda install completes successfully, move to Step 4.</p>
<p>Some users have reported problems where conda is not able to resolve
the environment for installing these packages. Here is an alternate
installation procedure if you face difficulties with above. After
installing geopandas, switch to using <code>pip</code> for installing
the remaining packages.</p>
<pre><code>pip install streamlit streamlit-folium leafmap</code></pre>
<ol start="4" style="list-style-type: decimal">
<li>After the installation is done, run the following command.</li>
</ol>
<pre><code>streamlit hello</code></pre>
<p><img src="images/python_dataviz/streamlit1.png" width="75%" style="display: block; margin: auto;" /></p>
<p>A new browser tab will open and display the streamlit Hello app.</p>
<p><img src="images/python_dataviz/streamlit2.png" width="75%" style="display: block; margin: auto;" /></p>
<p>Your installation is now complete. You can close the terminal window
to stop the streamlit server.</p>
</div>
<div id="create-a-simple-dashboard" class="section level2">
<h2>Create a Simple Dashboard</h2>
<p>Let’s create a simple interactive dashboard by loading a CSV file and
displaying a chart with some statistics. We will get familiar with the
streamlit app development workflow and explore different widgets and
layout elements.</p>
<p>See Live Demo: <a href="https://simpledashboard.streamlit.app/"><img
src="https://static.streamlit.io/badges/streamlit_badge_black_white.svg"
alt="A Simple Dashboard" /></a></p>
<ol style="list-style-type: decimal">
<li>Create a folder named <strong>simple_dashboard</strong> on your
Desktop.</li>
</ol>
<p><img src="images/python_dataviz/dashboard1.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="2" style="list-style-type: decimal">
<li>Open your favorite text editor and create a file with the following
content. By convention, we import <code>streamlit as st</code>. Then we
can use the <code>st.title()</code> to display the title of our
dashboard and <code>st.write()</code> to add a paragraph of text. Save
the file in the <strong>simple_dashboard</strong> folder on your desktop
as <code>app.py</code></li>
</ol>
<div class="sourceCode" id="cb183"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb183-1"><a href="#cb183-1" tabindex="-1"></a><span class="im">import</span> streamlit <span class="im">as</span> st</span>
<span id="cb183-2"><a href="#cb183-2" tabindex="-1"></a></span>
<span id="cb183-3"><a href="#cb183-3" tabindex="-1"></a>st.title(<span class="st">&#39;A Simple Dashboard&#39;</span>)</span>
<span id="cb183-4"><a href="#cb183-4" tabindex="-1"></a>st.write(<span class="st">&#39;This dashboard displays a chart for the selected region.&#39;</span>)</span></code></pre></div>
<p><img src="images/python_dataviz/dashboard2.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="3" style="list-style-type: decimal">
<li>Once the file is saved, open <em>Anaconda Prompt</em> (Windows) or
<em>Terminal</em> (Mac/Linux). Switch to the conda environment where you
have installed the required packages. We then use <code>cd</code>
command to change the current directory to the once with the
<code>app.py</code> file. Then run the following command to start the
streamlit server and launch the app.</li>
</ol>
<div class="sourceCode" id="cb184"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb184-1"><a href="#cb184-1" tabindex="-1"></a>streamlit run app.py</span></code></pre></div>
<p><img src="images/python_dataviz/dashboard3.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="4" style="list-style-type: decimal">
<li>A new browser tab will open and display the output of the app.</li>
</ol>
<p><img src="images/python_dataviz/dashboard4.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="5" style="list-style-type: decimal">
<li>Let’s read some data and display it. We load a CSV file from a URL
using Pandas and get a DataFrame object. We then use
<code>st.dataframe()</code> widget to render the dataframe. Update your
<code>app.py</code> with the following code. As you save the file, you
will notice that streamlit will detect it and display a prompt to re-run
your app. Choose <em>Always rerun</em>.</li>
</ol>
<div class="sourceCode" id="cb185"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb185-1"><a href="#cb185-1" tabindex="-1"></a><span class="im">import</span> streamlit <span class="im">as</span> st</span>
<span id="cb185-2"><a href="#cb185-2" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb185-3"><a href="#cb185-3" tabindex="-1"></a></span>
<span id="cb185-4"><a href="#cb185-4" tabindex="-1"></a></span>
<span id="cb185-5"><a href="#cb185-5" tabindex="-1"></a>st.title(<span class="st">&#39;A Simple Dashboard&#39;</span>)</span>
<span id="cb185-6"><a href="#cb185-6" tabindex="-1"></a>st.write(<span class="st">&#39;This dashboard displays a chart for the selected region.&#39;</span>)</span>
<span id="cb185-7"><a href="#cb185-7" tabindex="-1"></a></span>
<span id="cb185-8"><a href="#cb185-8" tabindex="-1"></a></span>
<span id="cb185-9"><a href="#cb185-9" tabindex="-1"></a>data_url <span class="op">=</span> <span class="st">&#39;https://github.com/spatialthoughts/python-dataviz-web/releases/&#39;</span> \</span>
<span id="cb185-10"><a href="#cb185-10" tabindex="-1"></a>      <span class="st">&#39;download/osm/&#39;</span></span>
<span id="cb185-11"><a href="#cb185-11" tabindex="-1"></a>csv_file <span class="op">=</span> <span class="st">&#39;highway_lengths_by_district.csv&#39;</span></span>
<span id="cb185-12"><a href="#cb185-12" tabindex="-1"></a></span>
<span id="cb185-13"><a href="#cb185-13" tabindex="-1"></a>url <span class="op">=</span> data_url <span class="op">+</span> csv_file</span>
<span id="cb185-14"><a href="#cb185-14" tabindex="-1"></a>df <span class="op">=</span> pd.read_csv(url)</span>
<span id="cb185-15"><a href="#cb185-15" tabindex="-1"></a></span>
<span id="cb185-16"><a href="#cb185-16" tabindex="-1"></a>st.dataframe(df)</span></code></pre></div>
<p><img src="images/python_dataviz/dashboard5.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="6" style="list-style-type: decimal">
<li>The app will now display the dataframe. The dataframe consists of 3
columns. The <code>DISTRICT</code> column contains a unique name for the
admin region. The <em>NH</em> and <em>SH</em> columns contain the length
of <em>National Highways</em> and <em>State Highways</em> in Kilometers
for each admin region. We will now create a dashboard that displays a
chart with the lengths of highways for the user-selected admin
region.</li>
</ol>
<p><img src="images/python_dataviz/dashboard6.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="7" style="list-style-type: decimal">
<li>Let’s add a dropdown menu with the list of admin regions. We first
get the names from the <code>DISTRICT</code> column and use
<code>st.selectbox()</code> to add a dropdown selector. Streamlit apps
always run the entire <code>app.py</code> whenever any selection is
changed. With our current app structure, whenever the user selected a
new admin region, the source file will be fetched again and a new
dataframe will be created. This is not required as the source data does
not change on every interaction. A good practice is to put the data
fetching in a function and use the <code>@st.cache_data</code> decorator
which will cache the results. Anytime the function is called with the
same arguments, it will return the cached version of the data instead of
fetching it.</li>
</ol>
<div class="sourceCode" id="cb186"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb186-1"><a href="#cb186-1" tabindex="-1"></a><span class="im">import</span> streamlit <span class="im">as</span> st</span>
<span id="cb186-2"><a href="#cb186-2" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb186-3"><a href="#cb186-3" tabindex="-1"></a></span>
<span id="cb186-4"><a href="#cb186-4" tabindex="-1"></a></span>
<span id="cb186-5"><a href="#cb186-5" tabindex="-1"></a>st.title(<span class="st">&#39;A Simple Dashboard&#39;</span>)</span>
<span id="cb186-6"><a href="#cb186-6" tabindex="-1"></a>st.write(<span class="st">&#39;This dashboard displays a chart for the selected region.&#39;</span>)</span>
<span id="cb186-7"><a href="#cb186-7" tabindex="-1"></a></span>
<span id="cb186-8"><a href="#cb186-8" tabindex="-1"></a><span class="at">@st.cache_data</span></span>
<span id="cb186-9"><a href="#cb186-9" tabindex="-1"></a><span class="kw">def</span> load_data():</span>
<span id="cb186-10"><a href="#cb186-10" tabindex="-1"></a>    data_url <span class="op">=</span> <span class="st">&#39;https://github.com/spatialthoughts/python-dataviz-web/releases/&#39;</span> \</span>
<span id="cb186-11"><a href="#cb186-11" tabindex="-1"></a>      <span class="st">&#39;download/osm/&#39;</span></span>
<span id="cb186-12"><a href="#cb186-12" tabindex="-1"></a>    csv_file <span class="op">=</span> <span class="st">&#39;highway_lengths_by_district.csv&#39;</span></span>
<span id="cb186-13"><a href="#cb186-13" tabindex="-1"></a></span>
<span id="cb186-14"><a href="#cb186-14" tabindex="-1"></a>    url <span class="op">=</span> data_url <span class="op">+</span> csv_file</span>
<span id="cb186-15"><a href="#cb186-15" tabindex="-1"></a>    df <span class="op">=</span> pd.read_csv(url)</span>
<span id="cb186-16"><a href="#cb186-16" tabindex="-1"></a>    </span>
<span id="cb186-17"><a href="#cb186-17" tabindex="-1"></a>    <span class="cf">return</span> df</span>
<span id="cb186-18"><a href="#cb186-18" tabindex="-1"></a></span>
<span id="cb186-19"><a href="#cb186-19" tabindex="-1"></a>df <span class="op">=</span> load_data()</span>
<span id="cb186-20"><a href="#cb186-20" tabindex="-1"></a></span>
<span id="cb186-21"><a href="#cb186-21" tabindex="-1"></a>districts <span class="op">=</span> df.DISTRICT.values</span>
<span id="cb186-22"><a href="#cb186-22" tabindex="-1"></a>district <span class="op">=</span> st.selectbox(<span class="st">&#39;Select a district&#39;</span>, districts)</span></code></pre></div>
<p><img src="images/python_dataviz/dashboard7.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="8" style="list-style-type: decimal">
<li>As the user selects an admin region from the selectbox, the selected
value is saved in the <code>district</code> variable. We use it to
filter the DataFrame to the selected district. Then we use Matplotlib to
create a bar-chart with the filtered dataframe and display it using
<code>st.pyplot()</code> widget.</li>
</ol>
<div class="sourceCode" id="cb187"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb187-1"><a href="#cb187-1" tabindex="-1"></a><span class="im">import</span> streamlit <span class="im">as</span> st</span>
<span id="cb187-2"><a href="#cb187-2" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb187-3"><a href="#cb187-3" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb187-4"><a href="#cb187-4" tabindex="-1"></a></span>
<span id="cb187-5"><a href="#cb187-5" tabindex="-1"></a></span>
<span id="cb187-6"><a href="#cb187-6" tabindex="-1"></a>st.title(<span class="st">&#39;A Simple Dashboard&#39;</span>)</span>
<span id="cb187-7"><a href="#cb187-7" tabindex="-1"></a>st.write(<span class="st">&#39;This dashboard displays a chart for the selected region.&#39;</span>)</span>
<span id="cb187-8"><a href="#cb187-8" tabindex="-1"></a></span>
<span id="cb187-9"><a href="#cb187-9" tabindex="-1"></a><span class="at">@st.cache_data</span></span>
<span id="cb187-10"><a href="#cb187-10" tabindex="-1"></a><span class="kw">def</span> load_data():</span>
<span id="cb187-11"><a href="#cb187-11" tabindex="-1"></a>    data_url <span class="op">=</span> <span class="st">&#39;https://github.com/spatialthoughts/python-dataviz-web/releases/&#39;</span> \</span>
<span id="cb187-12"><a href="#cb187-12" tabindex="-1"></a>        <span class="st">&#39;download/osm/&#39;</span></span>
<span id="cb187-13"><a href="#cb187-13" tabindex="-1"></a>    csv_file <span class="op">=</span> <span class="st">&#39;highway_lengths_by_district.csv&#39;</span></span>
<span id="cb187-14"><a href="#cb187-14" tabindex="-1"></a></span>
<span id="cb187-15"><a href="#cb187-15" tabindex="-1"></a>    url <span class="op">=</span> data_url <span class="op">+</span> csv_file</span>
<span id="cb187-16"><a href="#cb187-16" tabindex="-1"></a>    df <span class="op">=</span> pd.read_csv(url)</span>
<span id="cb187-17"><a href="#cb187-17" tabindex="-1"></a>    </span>
<span id="cb187-18"><a href="#cb187-18" tabindex="-1"></a>    <span class="cf">return</span> df</span>
<span id="cb187-19"><a href="#cb187-19" tabindex="-1"></a></span>
<span id="cb187-20"><a href="#cb187-20" tabindex="-1"></a>df <span class="op">=</span> load_data()</span>
<span id="cb187-21"><a href="#cb187-21" tabindex="-1"></a></span>
<span id="cb187-22"><a href="#cb187-22" tabindex="-1"></a>districts <span class="op">=</span> df.DISTRICT.values</span>
<span id="cb187-23"><a href="#cb187-23" tabindex="-1"></a>district <span class="op">=</span> st.selectbox(<span class="st">&#39;Select a district&#39;</span>, districts)</span>
<span id="cb187-24"><a href="#cb187-24" tabindex="-1"></a>filtered <span class="op">=</span> df[df[<span class="st">&#39;DISTRICT&#39;</span>] <span class="op">==</span> district] </span>
<span id="cb187-25"><a href="#cb187-25" tabindex="-1"></a></span>
<span id="cb187-26"><a href="#cb187-26" tabindex="-1"></a></span>
<span id="cb187-27"><a href="#cb187-27" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb187-28"><a href="#cb187-28" tabindex="-1"></a></span>
<span id="cb187-29"><a href="#cb187-29" tabindex="-1"></a>filtered.plot(kind<span class="op">=</span><span class="st">&#39;bar&#39;</span>, ax<span class="op">=</span>ax, color<span class="op">=</span>[<span class="st">&#39;#0000FF&#39;</span>, <span class="st">&#39;#FF0000&#39;</span>],</span>
<span id="cb187-30"><a href="#cb187-30" tabindex="-1"></a>    ylabel<span class="op">=</span><span class="st">&#39;Kilometers&#39;</span>, xlabel<span class="op">=</span><span class="st">&#39;Category&#39;</span>)</span>
<span id="cb187-31"><a href="#cb187-31" tabindex="-1"></a>ax.set_xticklabels([])</span>
<span id="cb187-32"><a href="#cb187-32" tabindex="-1"></a>stats <span class="op">=</span> st.pyplot(fig)</span></code></pre></div>
<p><img src="images/python_dataviz/dashboard8.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="9" style="list-style-type: decimal">
<li>Our dashboard now displays an updated chart every-time you change
the selection. Streamlit provides many other user-interface widgets.
Let’s explore some more of them. We will use
<code>st.color_picker()</code> widget to allow users to customize the
color of the bar chart. We can display 2 color-pickers side-by-side
using a column layout. We use <code>st.columns()</code> to create 2
columns <code>col1</code> and <code>col2</code>. We add a
<code>color_picker()</code> to each column with appropriate label and a
default color. If we have more than 1 widget of the same type in the
app, we need to provide a unique <code>key</code> that can be used to
identify the widget. We make some final tweaks to the chart and complete
the dashboard.</li>
</ol>
<div class="sourceCode" id="cb188"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb188-1"><a href="#cb188-1" tabindex="-1"></a><span class="im">import</span> streamlit <span class="im">as</span> st</span>
<span id="cb188-2"><a href="#cb188-2" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb188-3"><a href="#cb188-3" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb188-4"><a href="#cb188-4" tabindex="-1"></a></span>
<span id="cb188-5"><a href="#cb188-5" tabindex="-1"></a>st.title(<span class="st">&#39;A Simple Dashboard&#39;</span>)</span>
<span id="cb188-6"><a href="#cb188-6" tabindex="-1"></a>st.write(<span class="st">&#39;This dashboard displays a chart for the selected region.&#39;</span>)</span>
<span id="cb188-7"><a href="#cb188-7" tabindex="-1"></a></span>
<span id="cb188-8"><a href="#cb188-8" tabindex="-1"></a><span class="at">@st.cache_data</span></span>
<span id="cb188-9"><a href="#cb188-9" tabindex="-1"></a><span class="kw">def</span> load_data():</span>
<span id="cb188-10"><a href="#cb188-10" tabindex="-1"></a>    data_url <span class="op">=</span> <span class="st">&#39;https://github.com/spatialthoughts/python-dataviz-web/releases/&#39;</span> \</span>
<span id="cb188-11"><a href="#cb188-11" tabindex="-1"></a>        <span class="st">&#39;download/osm/&#39;</span></span>
<span id="cb188-12"><a href="#cb188-12" tabindex="-1"></a>    csv_file <span class="op">=</span> <span class="st">&#39;highway_lengths_by_district.csv&#39;</span></span>
<span id="cb188-13"><a href="#cb188-13" tabindex="-1"></a></span>
<span id="cb188-14"><a href="#cb188-14" tabindex="-1"></a>    url <span class="op">=</span> data_url <span class="op">+</span> csv_file</span>
<span id="cb188-15"><a href="#cb188-15" tabindex="-1"></a>    df <span class="op">=</span> pd.read_csv(url)</span>
<span id="cb188-16"><a href="#cb188-16" tabindex="-1"></a>    </span>
<span id="cb188-17"><a href="#cb188-17" tabindex="-1"></a>    <span class="cf">return</span> df</span>
<span id="cb188-18"><a href="#cb188-18" tabindex="-1"></a></span>
<span id="cb188-19"><a href="#cb188-19" tabindex="-1"></a>df <span class="op">=</span> load_data()</span>
<span id="cb188-20"><a href="#cb188-20" tabindex="-1"></a></span>
<span id="cb188-21"><a href="#cb188-21" tabindex="-1"></a>districts <span class="op">=</span> df.DISTRICT.values</span>
<span id="cb188-22"><a href="#cb188-22" tabindex="-1"></a>district <span class="op">=</span> st.selectbox(<span class="st">&#39;Select a district&#39;</span>, districts)</span>
<span id="cb188-23"><a href="#cb188-23" tabindex="-1"></a>filtered <span class="op">=</span> df[df[<span class="st">&#39;DISTRICT&#39;</span>] <span class="op">==</span> district] </span>
<span id="cb188-24"><a href="#cb188-24" tabindex="-1"></a></span>
<span id="cb188-25"><a href="#cb188-25" tabindex="-1"></a>col1, col2 <span class="op">=</span> st.columns(<span class="dv">2</span>)</span>
<span id="cb188-26"><a href="#cb188-26" tabindex="-1"></a></span>
<span id="cb188-27"><a href="#cb188-27" tabindex="-1"></a>nh_color <span class="op">=</span> col1.color_picker(<span class="st">&#39;Pick NH Color&#39;</span>, <span class="st">&#39;#0000FF&#39;</span>)</span>
<span id="cb188-28"><a href="#cb188-28" tabindex="-1"></a>sh_color <span class="op">=</span> col2.color_picker(<span class="st">&#39;Pick SH Color&#39;</span>, <span class="st">&#39;#FF0000&#39;</span>)</span>
<span id="cb188-29"><a href="#cb188-29" tabindex="-1"></a></span>
<span id="cb188-30"><a href="#cb188-30" tabindex="-1"></a>    </span>
<span id="cb188-31"><a href="#cb188-31" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb188-32"><a href="#cb188-32" tabindex="-1"></a></span>
<span id="cb188-33"><a href="#cb188-33" tabindex="-1"></a>filtered.plot(kind<span class="op">=</span><span class="st">&#39;bar&#39;</span>, ax<span class="op">=</span>ax, color<span class="op">=</span>[nh_color, sh_color],</span>
<span id="cb188-34"><a href="#cb188-34" tabindex="-1"></a>    ylabel<span class="op">=</span><span class="st">&#39;Kilometers&#39;</span>, xlabel<span class="op">=</span><span class="st">&#39;Category&#39;</span>)</span>
<span id="cb188-35"><a href="#cb188-35" tabindex="-1"></a>ax.set_title(<span class="st">&#39;Length of Highways&#39;</span>)</span>
<span id="cb188-36"><a href="#cb188-36" tabindex="-1"></a>ax.set_ylim(<span class="dv">0</span>, <span class="dv">2500</span>)</span>
<span id="cb188-37"><a href="#cb188-37" tabindex="-1"></a>ax.set_xticklabels([])</span>
<span id="cb188-38"><a href="#cb188-38" tabindex="-1"></a>stats <span class="op">=</span> st.pyplot(fig)</span></code></pre></div>
<p><img src="images/python_dataviz/dashboard9.png" width="75%" style="display: block; margin: auto;" /></p>
</div>
<div id="exercise-10" class="section level2">
<h2>Exercise</h2>
<p>Add a radio-button to the app that allows the user to select the
units for length between Kilometers and Miles as shown below. As the
user toggles the radio-button, you should apply the appropriate
conversion from Kilometer to Miles and update the chart.</p>
<ul>
<li>Hint1: Change <code>st.columns()</code> to have 3 columns and save
the results into 3 separate objects.
<code>col1, col2, col3 = st.columns(3)</code></li>
<li>Hint2: You can convert the values from Kilometer to Miles using
<code>filtered = filtered[['NH', 'SH']]*0.621371</code></li>
</ul>
<p><img src="images/python_dataviz/dashboard_exercise.png" width="75%" style="display: block; margin: auto;" /></p>
</div>
<div id="create-a-simple-geocoder-app" class="section level2">
<h2>Create a Simple Geocoder App</h2>
<p>Let’s create a simple app that geocodes a user query and displays the
results on a map. We will use <a
href="https://openrouteservice.org/dev/#/api-docs/geocode">OpenRouteService
Geocoding API</a> for geocoding and Folium to display the results on a
map.</p>
<p>See the live demo: <a
href="https://simplegeocoder.streamlit.app/"><img
src="https://static.streamlit.io/badges/streamlit_badge_black_white.svg"
alt="A Simple Geocoder App" /></a></p>
<ol style="list-style-type: decimal">
<li>We start by creating a new folder <strong>simple_app</strong> and
create the <code>app.py</code> with a basic layout with a title, a
description and a text input for the address.</li>
</ol>
<div class="sourceCode" id="cb189"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb189-1"><a href="#cb189-1" tabindex="-1"></a><span class="im">import</span> folium</span>
<span id="cb189-2"><a href="#cb189-2" tabindex="-1"></a><span class="im">import</span> requests</span>
<span id="cb189-3"><a href="#cb189-3" tabindex="-1"></a><span class="im">import</span> streamlit <span class="im">as</span> st</span>
<span id="cb189-4"><a href="#cb189-4" tabindex="-1"></a></span>
<span id="cb189-5"><a href="#cb189-5" tabindex="-1"></a>st.title(<span class="st">&#39;A Simple Geocoder&#39;</span>)</span>
<span id="cb189-6"><a href="#cb189-6" tabindex="-1"></a>st.markdown(<span class="st">&#39;This app uses the [OpenRouteService API](https://openrouteservice.org/) &#39;</span></span>
<span id="cb189-7"><a href="#cb189-7" tabindex="-1"></a>    <span class="st">&#39;to geocode the input address and display the results on a map.&#39;</span>)</span>
<span id="cb189-8"><a href="#cb189-8" tabindex="-1"></a>    </span>
<span id="cb189-9"><a href="#cb189-9" tabindex="-1"></a>address <span class="op">=</span> st.text_input(<span class="st">&#39;Enter an address.&#39;</span>)</span></code></pre></div>
<p><img src="images/python_dataviz/app1.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="2" style="list-style-type: decimal">
<li>Now we add a <code>geocode()</code> function that will take an
address and geocode it using OpenRouteService API.</li>
</ol>
<div class="sourceCode" id="cb190"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb190-1"><a href="#cb190-1" tabindex="-1"></a><span class="im">import</span> requests</span>
<span id="cb190-2"><a href="#cb190-2" tabindex="-1"></a><span class="im">import</span> streamlit <span class="im">as</span> st</span>
<span id="cb190-3"><a href="#cb190-3" tabindex="-1"></a></span>
<span id="cb190-4"><a href="#cb190-4" tabindex="-1"></a>st.title(<span class="st">&#39;A Simple Geocoder&#39;</span>)</span>
<span id="cb190-5"><a href="#cb190-5" tabindex="-1"></a>st.markdown(<span class="st">&#39;This app uses the [OpenRouteService API](https://openrouteservice.org/) &#39;</span></span>
<span id="cb190-6"><a href="#cb190-6" tabindex="-1"></a>  <span class="st">&#39;to geocode the input address and display the results on a map.&#39;</span>)</span>
<span id="cb190-7"><a href="#cb190-7" tabindex="-1"></a></span>
<span id="cb190-8"><a href="#cb190-8" tabindex="-1"></a>address <span class="op">=</span> st.text_input(<span class="st">&#39;Enter an address.&#39;</span>)</span>
<span id="cb190-9"><a href="#cb190-9" tabindex="-1"></a></span>
<span id="cb190-10"><a href="#cb190-10" tabindex="-1"></a>ORS_API_KEY <span class="op">=</span> <span class="st">&#39;&lt;your api key&gt;&#39;</span></span>
<span id="cb190-11"><a href="#cb190-11" tabindex="-1"></a></span>
<span id="cb190-12"><a href="#cb190-12" tabindex="-1"></a><span class="at">@st.cache_data</span></span>
<span id="cb190-13"><a href="#cb190-13" tabindex="-1"></a><span class="kw">def</span> geocode(query):</span>
<span id="cb190-14"><a href="#cb190-14" tabindex="-1"></a>    parameters <span class="op">=</span> {</span>
<span id="cb190-15"><a href="#cb190-15" tabindex="-1"></a>        <span class="st">&#39;api_key&#39;</span>: ORS_API_KEY,</span>
<span id="cb190-16"><a href="#cb190-16" tabindex="-1"></a>        <span class="st">&#39;text&#39;</span> : query</span>
<span id="cb190-17"><a href="#cb190-17" tabindex="-1"></a>    }</span>
<span id="cb190-18"><a href="#cb190-18" tabindex="-1"></a></span>
<span id="cb190-19"><a href="#cb190-19" tabindex="-1"></a>    response <span class="op">=</span> requests.get(</span>
<span id="cb190-20"><a href="#cb190-20" tabindex="-1"></a>         <span class="st">&#39;https://api.openrouteservice.org/geocode/search&#39;</span>,</span>
<span id="cb190-21"><a href="#cb190-21" tabindex="-1"></a>         params<span class="op">=</span>parameters)</span>
<span id="cb190-22"><a href="#cb190-22" tabindex="-1"></a>    <span class="cf">if</span> response.status_code <span class="op">==</span> <span class="dv">200</span>:</span>
<span id="cb190-23"><a href="#cb190-23" tabindex="-1"></a>        data <span class="op">=</span> response.json()</span>
<span id="cb190-24"><a href="#cb190-24" tabindex="-1"></a>        <span class="cf">if</span> data[<span class="st">&#39;features&#39;</span>]:</span>
<span id="cb190-25"><a href="#cb190-25" tabindex="-1"></a>            x, y <span class="op">=</span> data[<span class="st">&#39;features&#39;</span>][<span class="dv">0</span>][<span class="st">&#39;geometry&#39;</span>][<span class="st">&#39;coordinates&#39;</span>]</span>
<span id="cb190-26"><a href="#cb190-26" tabindex="-1"></a>            <span class="cf">return</span> (y, x)</span>
<span id="cb190-27"><a href="#cb190-27" tabindex="-1"></a>    </span>
<span id="cb190-28"><a href="#cb190-28" tabindex="-1"></a><span class="cf">if</span> address:</span>
<span id="cb190-29"><a href="#cb190-29" tabindex="-1"></a>    results <span class="op">=</span> geocode(address)</span>
<span id="cb190-30"><a href="#cb190-30" tabindex="-1"></a>    <span class="cf">if</span> results:</span>
<span id="cb190-31"><a href="#cb190-31" tabindex="-1"></a>        st.write(<span class="st">&#39;Geocoded Coordinates: </span><span class="sc">{}</span><span class="st">, </span><span class="sc">{}</span><span class="st">&#39;</span>.<span class="bu">format</span>(results[<span class="dv">0</span>], results[<span class="dv">1</span>]))</span>
<span id="cb190-32"><a href="#cb190-32" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb190-33"><a href="#cb190-33" tabindex="-1"></a>        st.error(<span class="st">&#39;Request failed. No results.&#39;</span>)</span></code></pre></div>
<p><img src="images/python_dataviz/app2.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="3" style="list-style-type: decimal">
<li>Now that we have coordinates, we can display it on a map using the
<a
href="https://github.com/randyzwitch/streamlit-folium"><code>st_folium</code></a>
component.</li>
</ol>
<div class="sourceCode" id="cb191"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb191-1"><a href="#cb191-1" tabindex="-1"></a><span class="im">import</span> folium</span>
<span id="cb191-2"><a href="#cb191-2" tabindex="-1"></a><span class="im">import</span> requests</span>
<span id="cb191-3"><a href="#cb191-3" tabindex="-1"></a><span class="im">import</span> streamlit <span class="im">as</span> st</span>
<span id="cb191-4"><a href="#cb191-4" tabindex="-1"></a><span class="im">from</span> streamlit_folium <span class="im">import</span> st_folium</span>
<span id="cb191-5"><a href="#cb191-5" tabindex="-1"></a></span>
<span id="cb191-6"><a href="#cb191-6" tabindex="-1"></a>st.title(<span class="st">&#39;A Simple Geocoder&#39;</span>)</span>
<span id="cb191-7"><a href="#cb191-7" tabindex="-1"></a>st.markdown(<span class="st">&#39;This app uses the [OpenRouteService API](https://openrouteservice.org/) &#39;</span></span>
<span id="cb191-8"><a href="#cb191-8" tabindex="-1"></a>    <span class="st">&#39;to geocode the input address and siplay the results on a map.&#39;</span>)</span>
<span id="cb191-9"><a href="#cb191-9" tabindex="-1"></a></span>
<span id="cb191-10"><a href="#cb191-10" tabindex="-1"></a>address <span class="op">=</span> st.text_input(<span class="st">&#39;Enter an address.&#39;</span>)</span>
<span id="cb191-11"><a href="#cb191-11" tabindex="-1"></a></span>
<span id="cb191-12"><a href="#cb191-12" tabindex="-1"></a>ORS_API_KEY <span class="op">=</span> <span class="st">&#39;&lt;your api key&gt;&#39;</span></span>
<span id="cb191-13"><a href="#cb191-13" tabindex="-1"></a></span>
<span id="cb191-14"><a href="#cb191-14" tabindex="-1"></a><span class="at">@st.cache_data</span></span>
<span id="cb191-15"><a href="#cb191-15" tabindex="-1"></a><span class="kw">def</span> geocode(query):</span>
<span id="cb191-16"><a href="#cb191-16" tabindex="-1"></a>    parameters <span class="op">=</span> {</span>
<span id="cb191-17"><a href="#cb191-17" tabindex="-1"></a>        <span class="st">&#39;api_key&#39;</span>: ORS_API_KEY,</span>
<span id="cb191-18"><a href="#cb191-18" tabindex="-1"></a>        <span class="st">&#39;text&#39;</span> : query</span>
<span id="cb191-19"><a href="#cb191-19" tabindex="-1"></a>    }</span>
<span id="cb191-20"><a href="#cb191-20" tabindex="-1"></a></span>
<span id="cb191-21"><a href="#cb191-21" tabindex="-1"></a>    response <span class="op">=</span> requests.get(</span>
<span id="cb191-22"><a href="#cb191-22" tabindex="-1"></a>         <span class="st">&#39;https://api.openrouteservice.org/geocode/search&#39;</span>,</span>
<span id="cb191-23"><a href="#cb191-23" tabindex="-1"></a>         params<span class="op">=</span>parameters)</span>
<span id="cb191-24"><a href="#cb191-24" tabindex="-1"></a>    <span class="cf">if</span> response.status_code <span class="op">==</span> <span class="dv">200</span>:</span>
<span id="cb191-25"><a href="#cb191-25" tabindex="-1"></a>        data <span class="op">=</span> response.json()</span>
<span id="cb191-26"><a href="#cb191-26" tabindex="-1"></a>        <span class="cf">if</span> data[<span class="st">&#39;features&#39;</span>]:</span>
<span id="cb191-27"><a href="#cb191-27" tabindex="-1"></a>            x, y <span class="op">=</span> data[<span class="st">&#39;features&#39;</span>][<span class="dv">0</span>][<span class="st">&#39;geometry&#39;</span>][<span class="st">&#39;coordinates&#39;</span>]</span>
<span id="cb191-28"><a href="#cb191-28" tabindex="-1"></a>            <span class="cf">return</span> (y, x)</span>
<span id="cb191-29"><a href="#cb191-29" tabindex="-1"></a>    </span>
<span id="cb191-30"><a href="#cb191-30" tabindex="-1"></a><span class="cf">if</span> address:</span>
<span id="cb191-31"><a href="#cb191-31" tabindex="-1"></a>    results <span class="op">=</span> geocode(address)</span>
<span id="cb191-32"><a href="#cb191-32" tabindex="-1"></a>    <span class="cf">if</span> results:</span>
<span id="cb191-33"><a href="#cb191-33" tabindex="-1"></a>        st.write(<span class="st">&#39;Geocoded Coordinates: </span><span class="sc">{}</span><span class="st">, </span><span class="sc">{}</span><span class="st">&#39;</span>.<span class="bu">format</span>(results[<span class="dv">0</span>], results[<span class="dv">1</span>]))</span>
<span id="cb191-34"><a href="#cb191-34" tabindex="-1"></a>        </span>
<span id="cb191-35"><a href="#cb191-35" tabindex="-1"></a>        m <span class="op">=</span> folium.Map(location<span class="op">=</span>results, zoom_start<span class="op">=</span><span class="dv">8</span>)</span>
<span id="cb191-36"><a href="#cb191-36" tabindex="-1"></a>        folium.Marker(</span>
<span id="cb191-37"><a href="#cb191-37" tabindex="-1"></a>                results,</span>
<span id="cb191-38"><a href="#cb191-38" tabindex="-1"></a>                popup<span class="op">=</span>address,</span>
<span id="cb191-39"><a href="#cb191-39" tabindex="-1"></a>                icon<span class="op">=</span>folium.Icon(color<span class="op">=</span><span class="st">&#39;green&#39;</span>, icon<span class="op">=</span><span class="st">&#39;crosshairs&#39;</span>, prefix<span class="op">=</span><span class="st">&#39;fa&#39;</span>)</span>
<span id="cb191-40"><a href="#cb191-40" tabindex="-1"></a>                ).add_to(m)</span>
<span id="cb191-41"><a href="#cb191-41" tabindex="-1"></a>        <span class="co"># call to render Folium map in Streamlit, but don&#39;t get any data back</span></span>
<span id="cb191-42"><a href="#cb191-42" tabindex="-1"></a>        <span class="co"># from the map (so that it won&#39;t rerun the app when the user interacts)</span></span>
<span id="cb191-43"><a href="#cb191-43" tabindex="-1"></a>        st_folium(m, width<span class="op">=</span><span class="dv">800</span>, returned_objects<span class="op">=</span>[])</span>
<span id="cb191-44"><a href="#cb191-44" tabindex="-1"></a>        </span>
<span id="cb191-45"><a href="#cb191-45" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb191-46"><a href="#cb191-46" tabindex="-1"></a>        st.error(<span class="st">&#39;Request failed. No results.&#39;</span>)</span></code></pre></div>
<p><img src="images/python_dataviz/app3.png" width="75%" style="display: block; margin: auto;" /></p>
</div>
<div id="exercise-11" class="section level2">
<h2>Exercise</h2>
<p>Add a dropdown menu to give the users an option to change the default
basemap of the Folium map.</p>
<ul>
<li>Hint: Add a <code>st.selectbox()</code> with basemap strings.
<code>st.selectbox('Select a basemap', ['OpenStreetMap', 'CartoDB Positron', 'CartoDB DarkMatter'])</code></li>
</ul>
<p>Reference: <a
href="https://python-visualization.github.io/folium/modules.html#module-folium.folium"><code>folium.folium.Map</code></a></p>
<p><img src="images/python_dataviz/app_exercise.png" width="75%" style="display: block; margin: auto;" /></p>
</div>
</div>
<div id="building-mapping-apps-with-leafmap-and-streamlit"
class="section level1">
<h1>Building Mapping Apps with Leafmap and Streamlit</h1>
<p>We can leverag <code>leafmap</code> to create an interactive mapping
dashboard that gives us the flexibility of using many different mapping
backends and way to read a wide-variety of spatial data formats.</p>
<div id="create-a-mapping-dashboard" class="section level2">
<h2>Create a Mapping Dashboard</h2>
<p>The code below creates an interactive mapping dashboard that displays
the statistics of the selected region.</p>
<p>See the live demo: <a
href="https://mapping-dashboard.streamlit.app/"><img
src="https://static.streamlit.io/badges/streamlit_badge_black_white.svg"
alt="A Mapping Dashboard App" /></a></p>
<ol style="list-style-type: decimal">
<li>We start by creating the app directory
<strong>mapping_dashboard</strong> and creating <code>app.py</code> with
the following content. This code creates a layout with a sidebar using
<code>st.sidebar()</code> and adds some widgets to it. Note that while
we need to use <code>st.title()</code> for the main section, we use
<code>st.sidebar.title()</code> for the sidebar.</li>
</ol>
<div class="sourceCode" id="cb192"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb192-1"><a href="#cb192-1" tabindex="-1"></a><span class="im">import</span> streamlit <span class="im">as</span> st</span>
<span id="cb192-2"><a href="#cb192-2" tabindex="-1"></a></span>
<span id="cb192-3"><a href="#cb192-3" tabindex="-1"></a>st.set_page_config(page_title<span class="op">=</span><span class="st">&#39;Dashboard&#39;</span>, layout<span class="op">=</span><span class="st">&#39;wide&#39;</span>)</span>
<span id="cb192-4"><a href="#cb192-4" tabindex="-1"></a></span>
<span id="cb192-5"><a href="#cb192-5" tabindex="-1"></a>st.title(<span class="st">&#39;Highway Dashboard&#39;</span>)</span>
<span id="cb192-6"><a href="#cb192-6" tabindex="-1"></a></span>
<span id="cb192-7"><a href="#cb192-7" tabindex="-1"></a>st.sidebar.title(<span class="st">&#39;About&#39;</span>)</span>
<span id="cb192-8"><a href="#cb192-8" tabindex="-1"></a>st.sidebar.info(<span class="st">&#39;Explore the Highway Statistics&#39;</span>)</span></code></pre></div>
<p><img src="images/python_dataviz/mapping_dashboard1.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="2" style="list-style-type: decimal">
<li>We now use <code>geopandas</code> to read 2 vector layers from a
geopackage and <code>pandas</code> to read a CSV file containing road
statistics. We put the code for data fetching inside a function and
cache it using the <code>st.cache_data</code> decorator.</li>
</ol>
<div class="sourceCode" id="cb193"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb193-1"><a href="#cb193-1" tabindex="-1"></a><span class="im">import</span> streamlit <span class="im">as</span> st</span>
<span id="cb193-2"><a href="#cb193-2" tabindex="-1"></a><span class="im">import</span> geopandas <span class="im">as</span> gpd</span>
<span id="cb193-3"><a href="#cb193-3" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb193-4"><a href="#cb193-4" tabindex="-1"></a></span>
<span id="cb193-5"><a href="#cb193-5" tabindex="-1"></a>st.set_page_config(page_title<span class="op">=</span><span class="st">&#39;Dashboard&#39;</span>, layout<span class="op">=</span><span class="st">&#39;wide&#39;</span>)</span>
<span id="cb193-6"><a href="#cb193-6" tabindex="-1"></a></span>
<span id="cb193-7"><a href="#cb193-7" tabindex="-1"></a>st.title(<span class="st">&#39;Highway Dashboard&#39;</span>)</span>
<span id="cb193-8"><a href="#cb193-8" tabindex="-1"></a></span>
<span id="cb193-9"><a href="#cb193-9" tabindex="-1"></a>st.sidebar.title(<span class="st">&#39;About&#39;</span>)</span>
<span id="cb193-10"><a href="#cb193-10" tabindex="-1"></a>st.sidebar.info(<span class="st">&#39;Explore the Highway Statistics&#39;</span>)</span>
<span id="cb193-11"><a href="#cb193-11" tabindex="-1"></a></span>
<span id="cb193-12"><a href="#cb193-12" tabindex="-1"></a></span>
<span id="cb193-13"><a href="#cb193-13" tabindex="-1"></a>data_url <span class="op">=</span> <span class="st">&#39;https://storage.googleapis.com/spatialthoughts-public-data/python-dataviz/osm/&#39;</span></span>
<span id="cb193-14"><a href="#cb193-14" tabindex="-1"></a>gpkg_file <span class="op">=</span> <span class="st">&#39;karnataka.gpkg&#39;</span></span>
<span id="cb193-15"><a href="#cb193-15" tabindex="-1"></a>csv_file <span class="op">=</span> <span class="st">&#39;highway_lengths_by_district.csv&#39;</span></span>
<span id="cb193-16"><a href="#cb193-16" tabindex="-1"></a></span>
<span id="cb193-17"><a href="#cb193-17" tabindex="-1"></a><span class="at">@st.cache_data</span></span>
<span id="cb193-18"><a href="#cb193-18" tabindex="-1"></a><span class="kw">def</span> read_gdf(url, layer):</span>
<span id="cb193-19"><a href="#cb193-19" tabindex="-1"></a>    gdf <span class="op">=</span> gpd.read_file(url, layer<span class="op">=</span>layer)</span>
<span id="cb193-20"><a href="#cb193-20" tabindex="-1"></a>    <span class="cf">return</span> gdf</span>
<span id="cb193-21"><a href="#cb193-21" tabindex="-1"></a></span>
<span id="cb193-22"><a href="#cb193-22" tabindex="-1"></a><span class="at">@st.cache_data</span></span>
<span id="cb193-23"><a href="#cb193-23" tabindex="-1"></a><span class="kw">def</span> read_csv(url):</span>
<span id="cb193-24"><a href="#cb193-24" tabindex="-1"></a>    df <span class="op">=</span> pd.read_csv(url)</span>
<span id="cb193-25"><a href="#cb193-25" tabindex="-1"></a>    <span class="cf">return</span> df</span>
<span id="cb193-26"><a href="#cb193-26" tabindex="-1"></a>    </span>
<span id="cb193-27"><a href="#cb193-27" tabindex="-1"></a>data_load_state <span class="op">=</span> st.text(<span class="st">&#39;Loading data...&#39;</span>)   </span>
<span id="cb193-28"><a href="#cb193-28" tabindex="-1"></a>gpkg_url <span class="op">=</span> data_url <span class="op">+</span> gpkg_file</span>
<span id="cb193-29"><a href="#cb193-29" tabindex="-1"></a>csv_url <span class="op">=</span> data_url <span class="op">+</span> csv_file</span>
<span id="cb193-30"><a href="#cb193-30" tabindex="-1"></a>districts_gdf <span class="op">=</span> read_gdf(gpkg_url, <span class="st">&#39;karnataka_districts&#39;</span>)</span>
<span id="cb193-31"><a href="#cb193-31" tabindex="-1"></a>roads_gdf <span class="op">=</span> read_gdf(gpkg_url, <span class="st">&#39;karnataka_highways&#39;</span>)</span>
<span id="cb193-32"><a href="#cb193-32" tabindex="-1"></a>lengths_df <span class="op">=</span> read_csv(csv_url)</span>
<span id="cb193-33"><a href="#cb193-33" tabindex="-1"></a>data_load_state.text(<span class="st">&#39;Loading data... done!&#39;</span>)</span></code></pre></div>
<p><img src="images/python_dataviz/mapping_dashboard2.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="3" style="list-style-type: decimal">
<li>Now we use the information in the CSV file to display a chart in the
sidebar.</li>
</ol>
<div class="sourceCode" id="cb194"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb194-1"><a href="#cb194-1" tabindex="-1"></a><span class="im">import</span> streamlit <span class="im">as</span> st</span>
<span id="cb194-2"><a href="#cb194-2" tabindex="-1"></a><span class="im">import</span> geopandas <span class="im">as</span> gpd</span>
<span id="cb194-3"><a href="#cb194-3" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb194-4"><a href="#cb194-4" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb194-5"><a href="#cb194-5" tabindex="-1"></a></span>
<span id="cb194-6"><a href="#cb194-6" tabindex="-1"></a>st.set_page_config(page_title<span class="op">=</span><span class="st">&#39;Dashboard&#39;</span>, layout<span class="op">=</span><span class="st">&#39;wide&#39;</span>)</span>
<span id="cb194-7"><a href="#cb194-7" tabindex="-1"></a></span>
<span id="cb194-8"><a href="#cb194-8" tabindex="-1"></a>st.title(<span class="st">&#39;Highway Dashboard&#39;</span>)</span>
<span id="cb194-9"><a href="#cb194-9" tabindex="-1"></a></span>
<span id="cb194-10"><a href="#cb194-10" tabindex="-1"></a>st.sidebar.title(<span class="st">&#39;About&#39;</span>)</span>
<span id="cb194-11"><a href="#cb194-11" tabindex="-1"></a>st.sidebar.info(<span class="st">&#39;Explore the Highway Statistics&#39;</span>)</span>
<span id="cb194-12"><a href="#cb194-12" tabindex="-1"></a></span>
<span id="cb194-13"><a href="#cb194-13" tabindex="-1"></a></span>
<span id="cb194-14"><a href="#cb194-14" tabindex="-1"></a>data_url <span class="op">=</span> <span class="st">&#39;https://github.com/spatialthoughts/python-dataviz-web/releases/&#39;</span> \</span>
<span id="cb194-15"><a href="#cb194-15" tabindex="-1"></a>        <span class="st">&#39;download/osm/&#39;</span></span>
<span id="cb194-16"><a href="#cb194-16" tabindex="-1"></a>        </span>
<span id="cb194-17"><a href="#cb194-17" tabindex="-1"></a>gpkg_file <span class="op">=</span> <span class="st">&#39;karnataka.gpkg&#39;</span></span>
<span id="cb194-18"><a href="#cb194-18" tabindex="-1"></a>csv_file <span class="op">=</span> <span class="st">&#39;highway_lengths_by_district.csv&#39;</span></span>
<span id="cb194-19"><a href="#cb194-19" tabindex="-1"></a></span>
<span id="cb194-20"><a href="#cb194-20" tabindex="-1"></a><span class="at">@st.cache_data</span></span>
<span id="cb194-21"><a href="#cb194-21" tabindex="-1"></a><span class="kw">def</span> read_gdf(url, layer):</span>
<span id="cb194-22"><a href="#cb194-22" tabindex="-1"></a>    gdf <span class="op">=</span> gpd.read_file(url, layer<span class="op">=</span>layer)</span>
<span id="cb194-23"><a href="#cb194-23" tabindex="-1"></a>    <span class="cf">return</span> gdf</span>
<span id="cb194-24"><a href="#cb194-24" tabindex="-1"></a></span>
<span id="cb194-25"><a href="#cb194-25" tabindex="-1"></a><span class="at">@st.cache_data</span></span>
<span id="cb194-26"><a href="#cb194-26" tabindex="-1"></a><span class="kw">def</span> read_csv(url):</span>
<span id="cb194-27"><a href="#cb194-27" tabindex="-1"></a>    df <span class="op">=</span> pd.read_csv(url)</span>
<span id="cb194-28"><a href="#cb194-28" tabindex="-1"></a>    <span class="cf">return</span> df</span>
<span id="cb194-29"><a href="#cb194-29" tabindex="-1"></a></span>
<span id="cb194-30"><a href="#cb194-30" tabindex="-1"></a>gpkg_url <span class="op">=</span> data_url <span class="op">+</span> gpkg_file</span>
<span id="cb194-31"><a href="#cb194-31" tabindex="-1"></a>csv_url <span class="op">=</span> data_url <span class="op">+</span> csv_file</span>
<span id="cb194-32"><a href="#cb194-32" tabindex="-1"></a>districts_gdf <span class="op">=</span> read_gdf(gpkg_url, <span class="st">&#39;karnataka_districts&#39;</span>)</span>
<span id="cb194-33"><a href="#cb194-33" tabindex="-1"></a>roads_gdf <span class="op">=</span> read_gdf(gpkg_url, <span class="st">&#39;karnataka_highways&#39;</span>)</span>
<span id="cb194-34"><a href="#cb194-34" tabindex="-1"></a>lengths_df <span class="op">=</span> read_csv(csv_url)</span>
<span id="cb194-35"><a href="#cb194-35" tabindex="-1"></a></span>
<span id="cb194-36"><a href="#cb194-36" tabindex="-1"></a><span class="co"># Create the chart</span></span>
<span id="cb194-37"><a href="#cb194-37" tabindex="-1"></a>districts <span class="op">=</span> districts_gdf.DISTRICT.values</span>
<span id="cb194-38"><a href="#cb194-38" tabindex="-1"></a>district <span class="op">=</span> st.sidebar.selectbox(<span class="st">&#39;Select a District&#39;</span>, districts)</span>
<span id="cb194-39"><a href="#cb194-39" tabindex="-1"></a></span>
<span id="cb194-40"><a href="#cb194-40" tabindex="-1"></a>district_lengths <span class="op">=</span> lengths_df[lengths_df[<span class="st">&#39;DISTRICT&#39;</span>] <span class="op">==</span> district]</span>
<span id="cb194-41"><a href="#cb194-41" tabindex="-1"></a></span>
<span id="cb194-42"><a href="#cb194-42" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb194-43"><a href="#cb194-43" tabindex="-1"></a>district_lengths.plot(kind<span class="op">=</span><span class="st">&#39;bar&#39;</span>, ax<span class="op">=</span>ax, color<span class="op">=</span>[<span class="st">&#39;blue&#39;</span>, <span class="st">&#39;red&#39;</span>],</span>
<span id="cb194-44"><a href="#cb194-44" tabindex="-1"></a>    ylabel<span class="op">=</span><span class="st">&#39;Kilometers&#39;</span>, xlabel<span class="op">=</span><span class="st">&#39;Category&#39;</span>)</span>
<span id="cb194-45"><a href="#cb194-45" tabindex="-1"></a>ax.set_xticklabels([])</span>
<span id="cb194-46"><a href="#cb194-46" tabindex="-1"></a>stats <span class="op">=</span> st.sidebar.pyplot(fig)</span></code></pre></div>
<p><img src="images/python_dataviz/mapping_dashboard3.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="4" style="list-style-type: decimal">
<li>Now we create a folium map using <code>leafmap.Map()</code> and
render the vector layers. We also add a third layer with the boundary of
the selected district to highlight the selection.</li>
</ol>
<div class="sourceCode" id="cb195"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb195-1"><a href="#cb195-1" tabindex="-1"></a><span class="im">import</span> streamlit <span class="im">as</span> st</span>
<span id="cb195-2"><a href="#cb195-2" tabindex="-1"></a><span class="im">import</span> geopandas <span class="im">as</span> gpd</span>
<span id="cb195-3"><a href="#cb195-3" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb195-4"><a href="#cb195-4" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb195-5"><a href="#cb195-5" tabindex="-1"></a><span class="im">import</span> leafmap.foliumap <span class="im">as</span> leafmap</span>
<span id="cb195-6"><a href="#cb195-6" tabindex="-1"></a></span>
<span id="cb195-7"><a href="#cb195-7" tabindex="-1"></a>st.set_page_config(page_title<span class="op">=</span><span class="st">&#39;Dashboard&#39;</span>, layout<span class="op">=</span><span class="st">&#39;wide&#39;</span>)</span>
<span id="cb195-8"><a href="#cb195-8" tabindex="-1"></a></span>
<span id="cb195-9"><a href="#cb195-9" tabindex="-1"></a>st.title(<span class="st">&#39;Highway Dashboard&#39;</span>)</span>
<span id="cb195-10"><a href="#cb195-10" tabindex="-1"></a></span>
<span id="cb195-11"><a href="#cb195-11" tabindex="-1"></a>st.sidebar.title(<span class="st">&#39;About&#39;</span>)</span>
<span id="cb195-12"><a href="#cb195-12" tabindex="-1"></a>st.sidebar.info(<span class="st">&#39;Explore the Highway Statistics&#39;</span>)</span>
<span id="cb195-13"><a href="#cb195-13" tabindex="-1"></a></span>
<span id="cb195-14"><a href="#cb195-14" tabindex="-1"></a></span>
<span id="cb195-15"><a href="#cb195-15" tabindex="-1"></a>data_url <span class="op">=</span> <span class="st">&#39;https://github.com/spatialthoughts/python-dataviz-web/releases/&#39;</span> \</span>
<span id="cb195-16"><a href="#cb195-16" tabindex="-1"></a>        <span class="st">&#39;download/osm/&#39;</span></span>
<span id="cb195-17"><a href="#cb195-17" tabindex="-1"></a>        </span>
<span id="cb195-18"><a href="#cb195-18" tabindex="-1"></a>gpkg_file <span class="op">=</span> <span class="st">&#39;karnataka.gpkg&#39;</span></span>
<span id="cb195-19"><a href="#cb195-19" tabindex="-1"></a>csv_file <span class="op">=</span> <span class="st">&#39;highway_lengths_by_district.csv&#39;</span></span>
<span id="cb195-20"><a href="#cb195-20" tabindex="-1"></a></span>
<span id="cb195-21"><a href="#cb195-21" tabindex="-1"></a><span class="at">@st.cache_data</span></span>
<span id="cb195-22"><a href="#cb195-22" tabindex="-1"></a><span class="kw">def</span> read_gdf(url, layer):</span>
<span id="cb195-23"><a href="#cb195-23" tabindex="-1"></a>    gdf <span class="op">=</span> gpd.read_file(url, layer<span class="op">=</span>layer)</span>
<span id="cb195-24"><a href="#cb195-24" tabindex="-1"></a>    <span class="cf">return</span> gdf</span>
<span id="cb195-25"><a href="#cb195-25" tabindex="-1"></a></span>
<span id="cb195-26"><a href="#cb195-26" tabindex="-1"></a><span class="at">@st.cache_data</span></span>
<span id="cb195-27"><a href="#cb195-27" tabindex="-1"></a><span class="kw">def</span> read_csv(url):</span>
<span id="cb195-28"><a href="#cb195-28" tabindex="-1"></a>    df <span class="op">=</span> pd.read_csv(url)</span>
<span id="cb195-29"><a href="#cb195-29" tabindex="-1"></a>    <span class="cf">return</span> df</span>
<span id="cb195-30"><a href="#cb195-30" tabindex="-1"></a></span>
<span id="cb195-31"><a href="#cb195-31" tabindex="-1"></a>gpkg_url <span class="op">=</span> data_url <span class="op">+</span> gpkg_file</span>
<span id="cb195-32"><a href="#cb195-32" tabindex="-1"></a>csv_url <span class="op">=</span> data_url <span class="op">+</span> csv_file</span>
<span id="cb195-33"><a href="#cb195-33" tabindex="-1"></a>districts_gdf <span class="op">=</span> read_gdf(gpkg_url, <span class="st">&#39;karnataka_districts&#39;</span>)</span>
<span id="cb195-34"><a href="#cb195-34" tabindex="-1"></a>roads_gdf <span class="op">=</span> read_gdf(gpkg_url, <span class="st">&#39;karnataka_highways&#39;</span>)</span>
<span id="cb195-35"><a href="#cb195-35" tabindex="-1"></a>lengths_df <span class="op">=</span> read_csv(csv_url)</span>
<span id="cb195-36"><a href="#cb195-36" tabindex="-1"></a></span>
<span id="cb195-37"><a href="#cb195-37" tabindex="-1"></a><span class="co"># Create the chart</span></span>
<span id="cb195-38"><a href="#cb195-38" tabindex="-1"></a>districts <span class="op">=</span> districts_gdf.DISTRICT.values</span>
<span id="cb195-39"><a href="#cb195-39" tabindex="-1"></a>district <span class="op">=</span> st.sidebar.selectbox(<span class="st">&#39;Select a District&#39;</span>, districts)</span>
<span id="cb195-40"><a href="#cb195-40" tabindex="-1"></a></span>
<span id="cb195-41"><a href="#cb195-41" tabindex="-1"></a>district_lengths <span class="op">=</span> lengths_df[lengths_df[<span class="st">&#39;DISTRICT&#39;</span>] <span class="op">==</span> district]</span>
<span id="cb195-42"><a href="#cb195-42" tabindex="-1"></a></span>
<span id="cb195-43"><a href="#cb195-43" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb195-44"><a href="#cb195-44" tabindex="-1"></a>district_lengths.plot(kind<span class="op">=</span><span class="st">&#39;bar&#39;</span>, ax<span class="op">=</span>ax, color<span class="op">=</span>[<span class="st">&#39;blue&#39;</span>, <span class="st">&#39;red&#39;</span>],</span>
<span id="cb195-45"><a href="#cb195-45" tabindex="-1"></a>    ylabel<span class="op">=</span><span class="st">&#39;Kilometers&#39;</span>, xlabel<span class="op">=</span><span class="st">&#39;Category&#39;</span>)</span>
<span id="cb195-46"><a href="#cb195-46" tabindex="-1"></a>ax.set_xticklabels([])</span>
<span id="cb195-47"><a href="#cb195-47" tabindex="-1"></a>stats <span class="op">=</span> st.sidebar.pyplot(fig)</span>
<span id="cb195-48"><a href="#cb195-48" tabindex="-1"></a></span>
<span id="cb195-49"><a href="#cb195-49" tabindex="-1"></a><span class="co">## Create the map</span></span>
<span id="cb195-50"><a href="#cb195-50" tabindex="-1"></a></span>
<span id="cb195-51"><a href="#cb195-51" tabindex="-1"></a>m <span class="op">=</span> leafmap.Map(</span>
<span id="cb195-52"><a href="#cb195-52" tabindex="-1"></a>    layers_control<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb195-53"><a href="#cb195-53" tabindex="-1"></a>    draw_control<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb195-54"><a href="#cb195-54" tabindex="-1"></a>    measure_control<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb195-55"><a href="#cb195-55" tabindex="-1"></a>    fullscreen_control<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb195-56"><a href="#cb195-56" tabindex="-1"></a>)</span>
<span id="cb195-57"><a href="#cb195-57" tabindex="-1"></a>m.add_basemap(<span class="st">&#39;CartoDB.DarkMatter&#39;</span>)</span>
<span id="cb195-58"><a href="#cb195-58" tabindex="-1"></a>m.add_gdf(</span>
<span id="cb195-59"><a href="#cb195-59" tabindex="-1"></a>    gdf<span class="op">=</span>districts_gdf,</span>
<span id="cb195-60"><a href="#cb195-60" tabindex="-1"></a>    zoom_to_layer<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb195-61"><a href="#cb195-61" tabindex="-1"></a>    layer_name<span class="op">=</span><span class="st">&#39;districts&#39;</span>,</span>
<span id="cb195-62"><a href="#cb195-62" tabindex="-1"></a>    info_mode<span class="op">=</span><span class="st">&#39;on_click&#39;</span>,</span>
<span id="cb195-63"><a href="#cb195-63" tabindex="-1"></a>    style<span class="op">=</span>{<span class="st">&#39;color&#39;</span>: <span class="st">&#39;#7fcdbb&#39;</span>, <span class="st">&#39;fillOpacity&#39;</span>: <span class="fl">0.3</span>, <span class="st">&#39;weight&#39;</span>: <span class="fl">0.5</span>},</span>
<span id="cb195-64"><a href="#cb195-64" tabindex="-1"></a>    )</span>
<span id="cb195-65"><a href="#cb195-65" tabindex="-1"></a></span>
<span id="cb195-66"><a href="#cb195-66" tabindex="-1"></a></span>
<span id="cb195-67"><a href="#cb195-67" tabindex="-1"></a>selected_gdf <span class="op">=</span> districts_gdf[districts_gdf[<span class="st">&#39;DISTRICT&#39;</span>] <span class="op">==</span> district]</span>
<span id="cb195-68"><a href="#cb195-68" tabindex="-1"></a></span>
<span id="cb195-69"><a href="#cb195-69" tabindex="-1"></a>m.add_gdf(</span>
<span id="cb195-70"><a href="#cb195-70" tabindex="-1"></a>    gdf<span class="op">=</span>selected_gdf,</span>
<span id="cb195-71"><a href="#cb195-71" tabindex="-1"></a>    layer_name<span class="op">=</span><span class="st">&#39;selected&#39;</span>,</span>
<span id="cb195-72"><a href="#cb195-72" tabindex="-1"></a>    zoom_to_layer<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb195-73"><a href="#cb195-73" tabindex="-1"></a>    info_mode<span class="op">=</span><span class="va">None</span>,</span>
<span id="cb195-74"><a href="#cb195-74" tabindex="-1"></a>    style<span class="op">=</span>{<span class="st">&#39;color&#39;</span>: <span class="st">&#39;yellow&#39;</span>, <span class="st">&#39;fill&#39;</span>: <span class="va">None</span>, <span class="st">&#39;weight&#39;</span>: <span class="dv">2</span>}</span>
<span id="cb195-75"><a href="#cb195-75" tabindex="-1"></a> )</span>
<span id="cb195-76"><a href="#cb195-76" tabindex="-1"></a></span>
<span id="cb195-77"><a href="#cb195-77" tabindex="-1"></a></span>
<span id="cb195-78"><a href="#cb195-78" tabindex="-1"></a>m_streamlit <span class="op">=</span> m.to_streamlit(<span class="dv">800</span>, <span class="dv">600</span>)</span></code></pre></div>
<p><img src="images/python_dataviz/mapping_dashboard4.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="5" style="list-style-type: decimal">
<li>We can selectively load certain layers on the map using a user-input
widget. Let’s add a checkbox that allows the user to overlay the roads
on the map.</li>
</ol>
<div class="sourceCode" id="cb196"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb196-1"><a href="#cb196-1" tabindex="-1"></a><span class="im">import</span> streamlit <span class="im">as</span> st</span>
<span id="cb196-2"><a href="#cb196-2" tabindex="-1"></a><span class="im">import</span> geopandas <span class="im">as</span> gpd</span>
<span id="cb196-3"><a href="#cb196-3" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb196-4"><a href="#cb196-4" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb196-5"><a href="#cb196-5" tabindex="-1"></a><span class="im">import</span> leafmap.foliumap <span class="im">as</span> leafmap</span>
<span id="cb196-6"><a href="#cb196-6" tabindex="-1"></a></span>
<span id="cb196-7"><a href="#cb196-7" tabindex="-1"></a>st.set_page_config(page_title<span class="op">=</span><span class="st">&#39;Dashboard&#39;</span>, layout<span class="op">=</span><span class="st">&#39;wide&#39;</span>)</span>
<span id="cb196-8"><a href="#cb196-8" tabindex="-1"></a></span>
<span id="cb196-9"><a href="#cb196-9" tabindex="-1"></a>st.title(<span class="st">&#39;Highway Dashboard&#39;</span>)</span>
<span id="cb196-10"><a href="#cb196-10" tabindex="-1"></a></span>
<span id="cb196-11"><a href="#cb196-11" tabindex="-1"></a>st.sidebar.title(<span class="st">&#39;About&#39;</span>)</span>
<span id="cb196-12"><a href="#cb196-12" tabindex="-1"></a>st.sidebar.info(<span class="st">&#39;Explore the Highway Statistics&#39;</span>)</span>
<span id="cb196-13"><a href="#cb196-13" tabindex="-1"></a></span>
<span id="cb196-14"><a href="#cb196-14" tabindex="-1"></a></span>
<span id="cb196-15"><a href="#cb196-15" tabindex="-1"></a>data_url <span class="op">=</span> <span class="st">&#39;https://github.com/spatialthoughts/python-dataviz-web/releases/&#39;</span> \</span>
<span id="cb196-16"><a href="#cb196-16" tabindex="-1"></a>        <span class="st">&#39;download/osm/&#39;</span></span>
<span id="cb196-17"><a href="#cb196-17" tabindex="-1"></a>        </span>
<span id="cb196-18"><a href="#cb196-18" tabindex="-1"></a>gpkg_file <span class="op">=</span> <span class="st">&#39;karnataka.gpkg&#39;</span></span>
<span id="cb196-19"><a href="#cb196-19" tabindex="-1"></a>csv_file <span class="op">=</span> <span class="st">&#39;highway_lengths_by_district.csv&#39;</span></span>
<span id="cb196-20"><a href="#cb196-20" tabindex="-1"></a></span>
<span id="cb196-21"><a href="#cb196-21" tabindex="-1"></a><span class="at">@st.cache_data</span></span>
<span id="cb196-22"><a href="#cb196-22" tabindex="-1"></a><span class="kw">def</span> read_gdf(url, layer):</span>
<span id="cb196-23"><a href="#cb196-23" tabindex="-1"></a>    gdf <span class="op">=</span> gpd.read_file(url, layer<span class="op">=</span>layer)</span>
<span id="cb196-24"><a href="#cb196-24" tabindex="-1"></a>    <span class="cf">return</span> gdf</span>
<span id="cb196-25"><a href="#cb196-25" tabindex="-1"></a></span>
<span id="cb196-26"><a href="#cb196-26" tabindex="-1"></a><span class="at">@st.cache_data</span></span>
<span id="cb196-27"><a href="#cb196-27" tabindex="-1"></a><span class="kw">def</span> read_csv(url):</span>
<span id="cb196-28"><a href="#cb196-28" tabindex="-1"></a>    df <span class="op">=</span> pd.read_csv(url)</span>
<span id="cb196-29"><a href="#cb196-29" tabindex="-1"></a>    <span class="cf">return</span> df</span>
<span id="cb196-30"><a href="#cb196-30" tabindex="-1"></a></span>
<span id="cb196-31"><a href="#cb196-31" tabindex="-1"></a>gpkg_url <span class="op">=</span> data_url <span class="op">+</span> gpkg_file</span>
<span id="cb196-32"><a href="#cb196-32" tabindex="-1"></a>csv_url <span class="op">=</span> data_url <span class="op">+</span> csv_file</span>
<span id="cb196-33"><a href="#cb196-33" tabindex="-1"></a>districts_gdf <span class="op">=</span> read_gdf(gpkg_url, <span class="st">&#39;karnataka_districts&#39;</span>)</span>
<span id="cb196-34"><a href="#cb196-34" tabindex="-1"></a>roads_gdf <span class="op">=</span> read_gdf(gpkg_url, <span class="st">&#39;karnataka_highways&#39;</span>)</span>
<span id="cb196-35"><a href="#cb196-35" tabindex="-1"></a>lengths_df <span class="op">=</span> read_csv(csv_url)</span>
<span id="cb196-36"><a href="#cb196-36" tabindex="-1"></a></span>
<span id="cb196-37"><a href="#cb196-37" tabindex="-1"></a><span class="co"># Create the chart</span></span>
<span id="cb196-38"><a href="#cb196-38" tabindex="-1"></a>districts <span class="op">=</span> districts_gdf.DISTRICT.values</span>
<span id="cb196-39"><a href="#cb196-39" tabindex="-1"></a>district <span class="op">=</span> st.sidebar.selectbox(<span class="st">&#39;Select a District&#39;</span>, districts)</span>
<span id="cb196-40"><a href="#cb196-40" tabindex="-1"></a>overlay <span class="op">=</span> st.sidebar.checkbox(<span class="st">&#39;Overlay roads&#39;</span>)</span>
<span id="cb196-41"><a href="#cb196-41" tabindex="-1"></a>district_lengths <span class="op">=</span> lengths_df[lengths_df[<span class="st">&#39;DISTRICT&#39;</span>] <span class="op">==</span> district]</span>
<span id="cb196-42"><a href="#cb196-42" tabindex="-1"></a></span>
<span id="cb196-43"><a href="#cb196-43" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb196-44"><a href="#cb196-44" tabindex="-1"></a>district_lengths.plot(kind<span class="op">=</span><span class="st">&#39;bar&#39;</span>, ax<span class="op">=</span>ax, color<span class="op">=</span>[<span class="st">&#39;blue&#39;</span>, <span class="st">&#39;red&#39;</span>],</span>
<span id="cb196-45"><a href="#cb196-45" tabindex="-1"></a>    ylabel<span class="op">=</span><span class="st">&#39;Kilometers&#39;</span>, xlabel<span class="op">=</span><span class="st">&#39;Category&#39;</span>)</span>
<span id="cb196-46"><a href="#cb196-46" tabindex="-1"></a>ax.get_xaxis().set_ticklabels([])</span>
<span id="cb196-47"><a href="#cb196-47" tabindex="-1"></a>ax.set_ylim(<span class="dv">0</span>, <span class="dv">2500</span>)</span>
<span id="cb196-48"><a href="#cb196-48" tabindex="-1"></a></span>
<span id="cb196-49"><a href="#cb196-49" tabindex="-1"></a>stats <span class="op">=</span> st.sidebar.pyplot(fig)</span>
<span id="cb196-50"><a href="#cb196-50" tabindex="-1"></a></span>
<span id="cb196-51"><a href="#cb196-51" tabindex="-1"></a><span class="co">## Create the map</span></span>
<span id="cb196-52"><a href="#cb196-52" tabindex="-1"></a></span>
<span id="cb196-53"><a href="#cb196-53" tabindex="-1"></a>m <span class="op">=</span> leafmap.Map(</span>
<span id="cb196-54"><a href="#cb196-54" tabindex="-1"></a>    layers_control<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb196-55"><a href="#cb196-55" tabindex="-1"></a>    draw_control<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb196-56"><a href="#cb196-56" tabindex="-1"></a>    measure_control<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb196-57"><a href="#cb196-57" tabindex="-1"></a>    fullscreen_control<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb196-58"><a href="#cb196-58" tabindex="-1"></a>)</span>
<span id="cb196-59"><a href="#cb196-59" tabindex="-1"></a>m.add_basemap(<span class="st">&#39;CartoDB.DarkMatter&#39;</span>)</span>
<span id="cb196-60"><a href="#cb196-60" tabindex="-1"></a>m.add_gdf(</span>
<span id="cb196-61"><a href="#cb196-61" tabindex="-1"></a>    gdf<span class="op">=</span>districts_gdf,</span>
<span id="cb196-62"><a href="#cb196-62" tabindex="-1"></a>    zoom_to_layer<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb196-63"><a href="#cb196-63" tabindex="-1"></a>    layer_name<span class="op">=</span><span class="st">&#39;districts&#39;</span>,</span>
<span id="cb196-64"><a href="#cb196-64" tabindex="-1"></a>    info_mode<span class="op">=</span><span class="st">&#39;on_click&#39;</span>,</span>
<span id="cb196-65"><a href="#cb196-65" tabindex="-1"></a>    style<span class="op">=</span>{<span class="st">&#39;color&#39;</span>: <span class="st">&#39;#7fcdbb&#39;</span>, <span class="st">&#39;fillOpacity&#39;</span>: <span class="fl">0.3</span>, <span class="st">&#39;weight&#39;</span>: <span class="fl">0.5</span>},</span>
<span id="cb196-66"><a href="#cb196-66" tabindex="-1"></a>    )</span>
<span id="cb196-67"><a href="#cb196-67" tabindex="-1"></a></span>
<span id="cb196-68"><a href="#cb196-68" tabindex="-1"></a><span class="cf">if</span> overlay:</span>
<span id="cb196-69"><a href="#cb196-69" tabindex="-1"></a>    m.add_gdf(</span>
<span id="cb196-70"><a href="#cb196-70" tabindex="-1"></a>        gdf<span class="op">=</span>roads_gdf,</span>
<span id="cb196-71"><a href="#cb196-71" tabindex="-1"></a>        zoom_to_layer<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb196-72"><a href="#cb196-72" tabindex="-1"></a>        layer_name<span class="op">=</span><span class="st">&#39;highways&#39;</span>,</span>
<span id="cb196-73"><a href="#cb196-73" tabindex="-1"></a>        info_mode<span class="op">=</span><span class="va">None</span>,</span>
<span id="cb196-74"><a href="#cb196-74" tabindex="-1"></a>        style<span class="op">=</span>{<span class="st">&#39;color&#39;</span>: <span class="st">&#39;#225ea8&#39;</span>, <span class="st">&#39;weight&#39;</span>: <span class="fl">1.5</span>},</span>
<span id="cb196-75"><a href="#cb196-75" tabindex="-1"></a>    )</span>
<span id="cb196-76"><a href="#cb196-76" tabindex="-1"></a>    </span>
<span id="cb196-77"><a href="#cb196-77" tabindex="-1"></a>selected_gdf <span class="op">=</span> districts_gdf[districts_gdf[<span class="st">&#39;DISTRICT&#39;</span>] <span class="op">==</span> district]</span>
<span id="cb196-78"><a href="#cb196-78" tabindex="-1"></a></span>
<span id="cb196-79"><a href="#cb196-79" tabindex="-1"></a>m.add_gdf(</span>
<span id="cb196-80"><a href="#cb196-80" tabindex="-1"></a>    gdf<span class="op">=</span>selected_gdf,</span>
<span id="cb196-81"><a href="#cb196-81" tabindex="-1"></a>    layer_name<span class="op">=</span><span class="st">&#39;selected&#39;</span>,</span>
<span id="cb196-82"><a href="#cb196-82" tabindex="-1"></a>    zoom_to_layer<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb196-83"><a href="#cb196-83" tabindex="-1"></a>    info_mode<span class="op">=</span><span class="va">None</span>,</span>
<span id="cb196-84"><a href="#cb196-84" tabindex="-1"></a>    style<span class="op">=</span>{<span class="st">&#39;color&#39;</span>: <span class="st">&#39;yellow&#39;</span>, <span class="st">&#39;fill&#39;</span>: <span class="va">None</span>, <span class="st">&#39;weight&#39;</span>: <span class="dv">2</span>}</span>
<span id="cb196-85"><a href="#cb196-85" tabindex="-1"></a> )</span>
<span id="cb196-86"><a href="#cb196-86" tabindex="-1"></a></span>
<span id="cb196-87"><a href="#cb196-87" tabindex="-1"></a></span>
<span id="cb196-88"><a href="#cb196-88" tabindex="-1"></a>m_streamlit <span class="op">=</span> m.to_streamlit(<span class="dv">800</span>, <span class="dv">600</span>)</span></code></pre></div>
<p><img src="images/python_dataviz/mapping_dashboard5.png" width="75%" style="display: block; margin: auto;" /></p>
</div>
</div>
<div id="publishing-apps-with-streamlit-cloud" class="section level1">
<h1>Publishing Apps with Streamlit Cloud</h1>
<p>Streamlit provides free hosting for your streamlit apps. In this
section, we will now learn how to deploy an app to Streamlit cloud and
configure it correctly.</p>
<div id="upload-the-app-to-github" class="section level2">
<h2>Upload the app to GitHub</h2>
<p>To run your app on Streamlit Cloud, you need to upload your app to
GitHub. Streamlit supports both private and public repositories. In this
example, we will be deploying a <em>Route Finder</em> app which you can
preview from the link below.</p>
<p>See Live Demo: <a href="https://route-finder.streamlit.app/"><img
src="https://static.streamlit.io/badges/streamlit_badge_black_white.svg"
alt="A Simple Dashboard" /></a></p>
</div>
<div id="add-app-dependencies" class="section level2">
<h2>Add App dependencies</h2>
<p>If your app needs a third-party Python package, you need to add it in
a separate file called <code>requirements.txt</code>. The packages
listed in the file will be installed on Streamlit Cloud before running
the app.</p>
<p>For our app, we have created the <code>requirements.txt</code> file
with the following content and uploaded it to GitHub in the same
directory as the <code>app.py</code></p>
<div class="sourceCode" id="cb197"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb197-1"><a href="#cb197-1" tabindex="-1"></a>streamlit</span>
<span id="cb197-2"><a href="#cb197-2" tabindex="-1"></a>folium</span>
<span id="cb197-3"><a href="#cb197-3" tabindex="-1"></a>streamlit<span class="op">-</span>folium</span></code></pre></div>
<p>You may also specify other dependencies for your app. Learn more at
<a
href="https://docs.streamlit.io/streamlit-cloud/get-started/deploy-an-app/app-dependencies">App
dependencies</a> documentation.</p>
</div>
<div id="replace-sensitive-data-with-secrets" class="section level2">
<h2>Replace Sensitive Data with Secrets</h2>
<p>It is not a good practice to store API keys or passwords in the code
as it can be seen by others and can be misused. Streamlit provides an
easy way for <a
href="https://docs.streamlit.io/streamlit-cloud/get-started/deploy-an-app/connect-to-data-sources/secrets-management">Secrets
Management</a>. You can store any key=value pairs in a separate location
and access it in the app using <code>st.secrets</code>.</p>
<p>While doing local development, you create a folder named
<code>.streamlit</code> in the app directory and store any key=value
pairs in a file named <code>secrets.toml</code>. For example, if you
want to store the ORS API Key, you can create a new file
<code>secrets.toml</code> in the <code>.streamlit</code> directory with
the following content. (Replace <code>&lt;your api key&gt;</code> with
the actual key)</p>
<pre><code>&#39;ORS_API_KEY&#39; = &#39;&lt;your api key&gt;&#39;</code></pre>
<p>Once done, the value of the ORS_API_KEY can be retrieved in the
streamlit app using <code>st.secrets['ORS_API_KEY']</code>. Your code
will now look like below.</p>
<pre><code>&#39;ORS_API_KEY&#39; = st.secrets[&#39;ORS_API_KEY&#39;]</code></pre>
<div class="sourceCode" id="cb200"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb200-1"><a href="#cb200-1" tabindex="-1"></a><span class="im">import</span> folium</span>
<span id="cb200-2"><a href="#cb200-2" tabindex="-1"></a><span class="im">import</span> streamlit <span class="im">as</span> st</span>
<span id="cb200-3"><a href="#cb200-3" tabindex="-1"></a><span class="im">from</span> streamlit_folium <span class="im">import</span> st_folium</span>
<span id="cb200-4"><a href="#cb200-4" tabindex="-1"></a><span class="im">import</span> requests</span>
<span id="cb200-5"><a href="#cb200-5" tabindex="-1"></a></span>
<span id="cb200-6"><a href="#cb200-6" tabindex="-1"></a>st.set_page_config(page_title<span class="op">=</span><span class="st">&#39;Route Finder&#39;</span>)</span>
<span id="cb200-7"><a href="#cb200-7" tabindex="-1"></a>st.title(<span class="st">&#39;Route Finder&#39;</span>)</span>
<span id="cb200-8"><a href="#cb200-8" tabindex="-1"></a></span>
<span id="cb200-9"><a href="#cb200-9" tabindex="-1"></a>st.markdown(<span class="st">&#39;This app uses the [OpenRouteService API](https://openrouteservice.org/) &#39;</span></span>
<span id="cb200-10"><a href="#cb200-10" tabindex="-1"></a>  <span class="st">&#39;to geocode and get directions between the specified origin and destination.&#39;</span>)</span>
<span id="cb200-11"><a href="#cb200-11" tabindex="-1"></a>st.text(<span class="st">&#39;Enter any city name or address below.&#39;</span>)</span>
<span id="cb200-12"><a href="#cb200-12" tabindex="-1"></a>origin <span class="op">=</span> st.text_input(<span class="st">&#39;Origin (Example: San Francisco, CA)&#39;</span>)</span>
<span id="cb200-13"><a href="#cb200-13" tabindex="-1"></a>destination <span class="op">=</span> st.text_input(<span class="st">&#39;Destination (Example: San Jose, CA)&#39;</span>)</span>
<span id="cb200-14"><a href="#cb200-14" tabindex="-1"></a>mode <span class="op">=</span> st.selectbox(<span class="st">&#39;Travel Mode&#39;</span>, [<span class="st">&#39;Car&#39;</span>, <span class="st">&#39;Walk&#39;</span>, <span class="st">&#39;Bike&#39;</span>])</span>
<span id="cb200-15"><a href="#cb200-15" tabindex="-1"></a>button <span class="op">=</span> st.button(<span class="st">&#39;Get Directions&#39;</span>)</span>
<span id="cb200-16"><a href="#cb200-16" tabindex="-1"></a></span>
<span id="cb200-17"><a href="#cb200-17" tabindex="-1"></a><span class="co"># Define a placeholder to display the distance and download button once computed.    </span></span>
<span id="cb200-18"><a href="#cb200-18" tabindex="-1"></a>placeholder <span class="op">=</span> st.empty()</span>
<span id="cb200-19"><a href="#cb200-19" tabindex="-1"></a></span>
<span id="cb200-20"><a href="#cb200-20" tabindex="-1"></a></span>
<span id="cb200-21"><a href="#cb200-21" tabindex="-1"></a>ORS_API_KEY <span class="op">=</span> st.secrets[<span class="st">&#39;ORS_API_KEY&#39;</span>]</span>
<span id="cb200-22"><a href="#cb200-22" tabindex="-1"></a></span>
<span id="cb200-23"><a href="#cb200-23" tabindex="-1"></a><span class="at">@st.cache_data</span></span>
<span id="cb200-24"><a href="#cb200-24" tabindex="-1"></a><span class="kw">def</span> geocode(query):</span>
<span id="cb200-25"><a href="#cb200-25" tabindex="-1"></a>    parameters <span class="op">=</span> {</span>
<span id="cb200-26"><a href="#cb200-26" tabindex="-1"></a>        <span class="st">&#39;api_key&#39;</span>: ORS_API_KEY,</span>
<span id="cb200-27"><a href="#cb200-27" tabindex="-1"></a>        <span class="st">&#39;text&#39;</span> : query</span>
<span id="cb200-28"><a href="#cb200-28" tabindex="-1"></a>    }</span>
<span id="cb200-29"><a href="#cb200-29" tabindex="-1"></a></span>
<span id="cb200-30"><a href="#cb200-30" tabindex="-1"></a>    response <span class="op">=</span> requests.get(</span>
<span id="cb200-31"><a href="#cb200-31" tabindex="-1"></a>         <span class="st">&#39;https://api.openrouteservice.org/geocode/search&#39;</span>,</span>
<span id="cb200-32"><a href="#cb200-32" tabindex="-1"></a>         params<span class="op">=</span>parameters)</span>
<span id="cb200-33"><a href="#cb200-33" tabindex="-1"></a>    <span class="cf">if</span> response.status_code <span class="op">==</span> <span class="dv">200</span>:</span>
<span id="cb200-34"><a href="#cb200-34" tabindex="-1"></a>     data <span class="op">=</span> response.json()</span>
<span id="cb200-35"><a href="#cb200-35" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb200-36"><a href="#cb200-36" tabindex="-1"></a>     st.error(<span class="st">&#39;Request failed.&#39;</span>)</span>
<span id="cb200-37"><a href="#cb200-37" tabindex="-1"></a>    x, y <span class="op">=</span> data[<span class="st">&#39;features&#39;</span>][<span class="dv">0</span>][<span class="st">&#39;geometry&#39;</span>][<span class="st">&#39;coordinates&#39;</span>]</span>
<span id="cb200-38"><a href="#cb200-38" tabindex="-1"></a>    <span class="cf">return</span> (y, x)</span>
<span id="cb200-39"><a href="#cb200-39" tabindex="-1"></a></span>
<span id="cb200-40"><a href="#cb200-40" tabindex="-1"></a><span class="kw">def</span> get_directions(origin_name, destination_name):    </span>
<span id="cb200-41"><a href="#cb200-41" tabindex="-1"></a>    origin_coords <span class="op">=</span> geocode(origin_name)</span>
<span id="cb200-42"><a href="#cb200-42" tabindex="-1"></a>    destination_coords <span class="op">=</span> geocode(destination_name)</span>
<span id="cb200-43"><a href="#cb200-43" tabindex="-1"></a>    parameters <span class="op">=</span> {</span>
<span id="cb200-44"><a href="#cb200-44" tabindex="-1"></a>        <span class="st">&#39;api_key&#39;</span>: ORS_API_KEY,</span>
<span id="cb200-45"><a href="#cb200-45" tabindex="-1"></a>        <span class="st">&#39;start&#39;</span> : <span class="st">&#39;</span><span class="sc">{}</span><span class="st">,</span><span class="sc">{}</span><span class="st">&#39;</span>.<span class="bu">format</span>(origin_coords[<span class="dv">1</span>], origin_coords[<span class="dv">0</span>]),</span>
<span id="cb200-46"><a href="#cb200-46" tabindex="-1"></a>        <span class="st">&#39;end&#39;</span> : <span class="st">&#39;</span><span class="sc">{}</span><span class="st">,</span><span class="sc">{}</span><span class="st">&#39;</span>.<span class="bu">format</span>(destination_coords[<span class="dv">1</span>], destination_coords[<span class="dv">0</span>])</span>
<span id="cb200-47"><a href="#cb200-47" tabindex="-1"></a>    }</span>
<span id="cb200-48"><a href="#cb200-48" tabindex="-1"></a>    mode_dict <span class="op">=</span> {</span>
<span id="cb200-49"><a href="#cb200-49" tabindex="-1"></a>        <span class="st">&#39;Car&#39;</span>: <span class="st">&#39;driving-car&#39;</span>,</span>
<span id="cb200-50"><a href="#cb200-50" tabindex="-1"></a>        <span class="st">&#39;Walk&#39;</span>: <span class="st">&#39;foot-walking&#39;</span>,</span>
<span id="cb200-51"><a href="#cb200-51" tabindex="-1"></a>        <span class="st">&#39;Bike&#39;</span>: <span class="st">&#39;cycling-regular&#39;</span></span>
<span id="cb200-52"><a href="#cb200-52" tabindex="-1"></a>    }</span>
<span id="cb200-53"><a href="#cb200-53" tabindex="-1"></a>    service_url <span class="op">=</span> <span class="st">&#39;</span><span class="sc">{}</span><span class="st">/</span><span class="sc">{}</span><span class="st">&#39;</span>.<span class="bu">format</span>(</span>
<span id="cb200-54"><a href="#cb200-54" tabindex="-1"></a>        <span class="st">&#39;https://api.openrouteservice.org/v2/directions&#39;</span>,</span>
<span id="cb200-55"><a href="#cb200-55" tabindex="-1"></a>        mode_dict[mode])</span>
<span id="cb200-56"><a href="#cb200-56" tabindex="-1"></a>    response <span class="op">=</span> requests.get(service_url, params<span class="op">=</span>parameters)</span>
<span id="cb200-57"><a href="#cb200-57" tabindex="-1"></a></span>
<span id="cb200-58"><a href="#cb200-58" tabindex="-1"></a>    <span class="cf">if</span> response.status_code <span class="op">==</span> <span class="dv">200</span>:</span>
<span id="cb200-59"><a href="#cb200-59" tabindex="-1"></a>        data <span class="op">=</span> response.json()</span>
<span id="cb200-60"><a href="#cb200-60" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb200-61"><a href="#cb200-61" tabindex="-1"></a>        st.error(<span class="st">&#39;Request failed.&#39;</span>)</span>
<span id="cb200-62"><a href="#cb200-62" tabindex="-1"></a>        </span>
<span id="cb200-63"><a href="#cb200-63" tabindex="-1"></a>    route<span class="op">=</span> data[<span class="st">&#39;features&#39;</span>][<span class="dv">0</span>][<span class="st">&#39;geometry&#39;</span>][<span class="st">&#39;coordinates&#39;</span>]</span>
<span id="cb200-64"><a href="#cb200-64" tabindex="-1"></a>    route_xy <span class="op">=</span> [(y,x) <span class="cf">for</span> x, y <span class="kw">in</span> route]</span>
<span id="cb200-65"><a href="#cb200-65" tabindex="-1"></a>    summary <span class="op">=</span> data[<span class="st">&#39;features&#39;</span>][<span class="dv">0</span>][<span class="st">&#39;properties&#39;</span>][<span class="st">&#39;summary&#39;</span>]</span>
<span id="cb200-66"><a href="#cb200-66" tabindex="-1"></a>    distance <span class="op">=</span> <span class="bu">round</span>(summary[<span class="st">&#39;distance&#39;</span>]<span class="op">/</span><span class="dv">1000</span>)</span>
<span id="cb200-67"><a href="#cb200-67" tabindex="-1"></a>    tooltip <span class="op">=</span> <span class="st">&#39;Distance by </span><span class="sc">{}</span><span class="st">: </span><span class="sc">{}</span><span class="st">km&#39;</span>.<span class="bu">format</span>(mode, distance)</span>
<span id="cb200-68"><a href="#cb200-68" tabindex="-1"></a>    <span class="cf">return</span> route_xy, tooltip</span>
<span id="cb200-69"><a href="#cb200-69" tabindex="-1"></a>    </span>
<span id="cb200-70"><a href="#cb200-70" tabindex="-1"></a></span>
<span id="cb200-71"><a href="#cb200-71" tabindex="-1"></a></span>
<span id="cb200-72"><a href="#cb200-72" tabindex="-1"></a>m <span class="op">=</span> folium.Map(location<span class="op">=</span>[<span class="fl">39.949610</span>, <span class="op">-</span><span class="fl">75.150282</span>], zoom_start<span class="op">=</span><span class="dv">5</span>)</span>
<span id="cb200-73"><a href="#cb200-73" tabindex="-1"></a><span class="cf">if</span> origin:</span>
<span id="cb200-74"><a href="#cb200-74" tabindex="-1"></a>    origin_coords <span class="op">=</span> geocode(origin)</span>
<span id="cb200-75"><a href="#cb200-75" tabindex="-1"></a>    folium.Marker(</span>
<span id="cb200-76"><a href="#cb200-76" tabindex="-1"></a>        origin_coords,</span>
<span id="cb200-77"><a href="#cb200-77" tabindex="-1"></a>        popup<span class="op">=</span>origin,</span>
<span id="cb200-78"><a href="#cb200-78" tabindex="-1"></a>        icon<span class="op">=</span>folium.Icon(color<span class="op">=</span><span class="st">&#39;green&#39;</span>, icon<span class="op">=</span><span class="st">&#39;crosshairs&#39;</span>, prefix<span class="op">=</span><span class="st">&#39;fa&#39;</span>)</span>
<span id="cb200-79"><a href="#cb200-79" tabindex="-1"></a>        ).add_to(m)</span>
<span id="cb200-80"><a href="#cb200-80" tabindex="-1"></a>    origin_bb <span class="op">=</span> [</span>
<span id="cb200-81"><a href="#cb200-81" tabindex="-1"></a>        (origin_coords[<span class="dv">0</span>] <span class="op">-</span> <span class="fl">0.05</span>, origin_coords[<span class="dv">1</span>] <span class="op">-</span> <span class="fl">0.05</span>),</span>
<span id="cb200-82"><a href="#cb200-82" tabindex="-1"></a>        (origin_coords[<span class="dv">0</span>] <span class="op">+</span> <span class="fl">0.05</span>, origin_coords[<span class="dv">1</span>] <span class="op">+</span> <span class="fl">0.05</span>)]</span>
<span id="cb200-83"><a href="#cb200-83" tabindex="-1"></a>    m.fit_bounds(origin_bb)</span>
<span id="cb200-84"><a href="#cb200-84" tabindex="-1"></a>    </span>
<span id="cb200-85"><a href="#cb200-85" tabindex="-1"></a><span class="cf">if</span> destination:</span>
<span id="cb200-86"><a href="#cb200-86" tabindex="-1"></a>    destination_coords <span class="op">=</span> geocode(destination)</span>
<span id="cb200-87"><a href="#cb200-87" tabindex="-1"></a>    folium.Marker(</span>
<span id="cb200-88"><a href="#cb200-88" tabindex="-1"></a>        destination_coords,</span>
<span id="cb200-89"><a href="#cb200-89" tabindex="-1"></a>        popup<span class="op">=</span>destination,</span>
<span id="cb200-90"><a href="#cb200-90" tabindex="-1"></a>        icon<span class="op">=</span>folium.Icon(color<span class="op">=</span><span class="st">&#39;red&#39;</span>, icon<span class="op">=</span><span class="st">&#39;crosshairs&#39;</span>, prefix<span class="op">=</span><span class="st">&#39;fa&#39;</span>)</span>
<span id="cb200-91"><a href="#cb200-91" tabindex="-1"></a>        ).add_to(m)</span>
<span id="cb200-92"><a href="#cb200-92" tabindex="-1"></a><span class="cf">if</span> origin <span class="kw">and</span> destination:</span>
<span id="cb200-93"><a href="#cb200-93" tabindex="-1"></a>    m.fit_bounds([origin_coords, destination_coords])</span>
<span id="cb200-94"><a href="#cb200-94" tabindex="-1"></a></span>
<span id="cb200-95"><a href="#cb200-95" tabindex="-1"></a><span class="cf">if</span> button:</span>
<span id="cb200-96"><a href="#cb200-96" tabindex="-1"></a>    route_xy, tooltip <span class="op">=</span> get_directions(origin, destination)</span>
<span id="cb200-97"><a href="#cb200-97" tabindex="-1"></a>    folium.PolyLine(route_xy, tooltip<span class="op">=</span>tooltip).add_to(m)</span>
<span id="cb200-98"><a href="#cb200-98" tabindex="-1"></a>    placeholder.text(tooltip)</span>
<span id="cb200-99"><a href="#cb200-99" tabindex="-1"></a>    </span>
<span id="cb200-100"><a href="#cb200-100" tabindex="-1"></a>    m.save(<span class="st">&#39;directions.html&#39;</span>)</span>
<span id="cb200-101"><a href="#cb200-101" tabindex="-1"></a>    <span class="cf">with</span> <span class="bu">open</span>(<span class="st">&#39;directions.html&#39;</span>) <span class="im">as</span> <span class="bu">file</span>:</span>
<span id="cb200-102"><a href="#cb200-102" tabindex="-1"></a>        placeholder.download_button(<span class="st">&#39;Download Directions&#39;</span>, data<span class="op">=</span><span class="bu">file</span>, file_name<span class="op">=</span><span class="st">&#39;directions.html&#39;</span>)</span>
<span id="cb200-103"><a href="#cb200-103" tabindex="-1"></a>    </span>
<span id="cb200-104"><a href="#cb200-104" tabindex="-1"></a>st_folium(m, width<span class="op">=</span><span class="dv">800</span>, returned_objects<span class="op">=</span>[])</span></code></pre></div>
<p>While deploying the app, you can configure your secrets as outlined
in the next section.</p>
</div>
<div id="deploy-your-app" class="section level2">
<h2>Deploy your App</h2>
<p>Now you are ready to deploy your app to Streamlit Cloud.</p>
<ol style="list-style-type: decimal">
<li>To deploy an app, you need to upload it on GitHub. Create a
repository and copy the folder containing the <code>app.py</code> and
<code>requirements.txt</code> to the repository. The route finder
application has been uploaded to GitHub. Visit the <a
href="https://github.com/spatialthoughts/python-dataviz-web/">GitHub
repository</a> and click <strong>Fork</strong> at the top-right corner
to create a copy of the repository.</li>
</ol>
<p><img src="images/python_dataviz/cloud01.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="2" style="list-style-type: decimal">
<li>Once done, find the app directory located at
<code>streamlit/route_finder/</code> inside your repository. Copy the
path to the <code>app.py</code>.</li>
</ol>
<p><img src="images/python_dataviz/cloud02.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="3" style="list-style-type: decimal">
<li>Visit <a href="https://streamlit.io/cloud">Streamlit Cloud</a> and
sign-in. If you do not have an account, you can click <em>Sign-up</em>
and create a new account. Once logged-in, click the <em>New app</em>
button.</li>
</ol>
<p><img src="images/python_dataviz/cloud03.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="4" style="list-style-type: decimal">
<li>When prompted whether <em>Do you already have an app?</em>, choose
<code>Yup, I have an app.</code></li>
</ol>
<p><img src="images/python_dataviz/cloud04.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="5" style="list-style-type: decimal">
<li>Click <em>Paste GitHub URL</em> and paste the URL to your streamlit
<code>app.py</code> file. Next, click <em>Advanced settings…</em></li>
</ol>
<p><img src="images/python_dataviz/cloud05.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="6" style="list-style-type: decimal">
<li>This dialog allows you to store your private information required by
your apps, such as API keys, username/password for your database, etc.
For the <strong>Route Finder</strong> app, you need to enter the API Key
for OpenRouteService. The API is maintained by HeiGIT (Heidelberg
Institute for Geoinformation Technology). Visit <a
href="https://account.heigit.org/signup">HeiGIT Sign Up page</a> and
create an account. Once your account is activated, visit your Dashboard
and copy the long string displayed under Basic Key and enter below.</li>
</ol>
<p>. Enter your API key in the following format and replace <your key>
with your actual API key. Click <em>Save</em>.</p>
<pre><code>&#39;ORS_API_KEY&#39; = &#39;&lt;your key&gt;&#39;</code></pre>
<p><img src="images/python_dataviz/cloud06.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="7" style="list-style-type: decimal">
<li>Optionally, you can choose a custom app URL. Once done, click
<em>Deploy!</em>.</li>
</ol>
<p><img src="images/python_dataviz/cloud07.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="8" style="list-style-type: decimal">
<li>Your app will now be deployed and will be accessible via the
provided URL.</li>
</ol>
<p><img src="images/python_dataviz/cloud08.png" width="75%" style="display: block; margin: auto;" /></p>
<ol start="9" style="list-style-type: decimal">
<li>You can visit your Dashboard to manage the app once it is
deployed.</li>
</ol>
<p><img src="images/python_dataviz/cloud09.png" width="75%" style="display: block; margin: auto;" /></p>
</div>
</div>
<div id="supplement" class="section level1">
<h1>Supplement</h1>
<div id="folium" class="section level2">
<h2>Folium</h2>
<p><a
href="https://colab.research.google.com/github/spatialthoughts/python-dataviz-web/blob/main/supplement_folium_text.ipynb"><img
src="https://colab.research.google.com/assets/colab-badge.svg"
alt="Open In Colab" /></a></p>
<div id="displaying-text-on-folium-maps" class="section level3">
<h3>Displaying Text on Folium Maps</h3>
<p>Folium supports <a
href="https://python-visualization.github.io/folium/latest/reference.html#folium.features.DivIcon">DivIcon</a>
markers for creating text-markers. Using this, we can render text on a
folium map easily. The example below an example of rendering markers
with airport codes.</p>
<p><img src='https://courses.spatialthoughts.com/images/python_dataviz/folium_text.png' width=600/></p>
<div class="sourceCode" id="cb202"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb202-1"><a href="#cb202-1" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb202-2"><a href="#cb202-2" tabindex="-1"></a><span class="im">import</span> folium</span>
<span id="cb202-3"><a href="#cb202-3" tabindex="-1"></a><span class="im">from</span> folium <span class="im">import</span> Figure</span>
<span id="cb202-4"><a href="#cb202-4" tabindex="-1"></a><span class="im">from</span> folium.features <span class="im">import</span> DivIcon</span>
<span id="cb202-5"><a href="#cb202-5" tabindex="-1"></a><span class="im">import</span> json</span></code></pre></div>
<div class="sourceCode" id="cb203"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb203-1"><a href="#cb203-1" tabindex="-1"></a>sfo <span class="op">=</span> (<span class="fl">37.616</span>, <span class="op">-</span><span class="fl">122.386</span>)</span>
<span id="cb203-2"><a href="#cb203-2" tabindex="-1"></a>jfk <span class="op">=</span> (<span class="fl">40.645</span>, <span class="op">-</span><span class="fl">73.782</span>)</span></code></pre></div>
<div class="sourceCode" id="cb204"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb204-1"><a href="#cb204-1" tabindex="-1"></a>fig <span class="op">=</span> Figure(width<span class="op">=</span><span class="dv">800</span>, height<span class="op">=</span><span class="dv">400</span>)</span>
<span id="cb204-2"><a href="#cb204-2" tabindex="-1"></a>m <span class="op">=</span> folium.Map(location<span class="op">=</span>[<span class="fl">39.83</span>, <span class="op">-</span><span class="fl">98.58</span>], zoom_start<span class="op">=</span><span class="dv">4</span>)</span>
<span id="cb204-3"><a href="#cb204-3" tabindex="-1"></a></span>
<span id="cb204-4"><a href="#cb204-4" tabindex="-1"></a>folium.Marker(</span>
<span id="cb204-5"><a href="#cb204-5" tabindex="-1"></a>    sfo,</span>
<span id="cb204-6"><a href="#cb204-6" tabindex="-1"></a>    popup<span class="op">=</span><span class="st">&#39;San Francisco International Airport&#39;</span>,</span>
<span id="cb204-7"><a href="#cb204-7" tabindex="-1"></a>    icon<span class="op">=</span>DivIcon(</span>
<span id="cb204-8"><a href="#cb204-8" tabindex="-1"></a>        icon_size<span class="op">=</span>(<span class="dv">150</span>,<span class="dv">36</span>),</span>
<span id="cb204-9"><a href="#cb204-9" tabindex="-1"></a>        icon_anchor<span class="op">=</span>(<span class="dv">0</span>,<span class="dv">0</span>),</span>
<span id="cb204-10"><a href="#cb204-10" tabindex="-1"></a>        html<span class="op">=</span><span class="st">&#39;&lt;div style=&quot;font-size: 24pt&quot;&gt;SFO&lt;/div&gt;&#39;</span>,</span>
<span id="cb204-11"><a href="#cb204-11" tabindex="-1"></a>    )).add_to(m)</span>
<span id="cb204-12"><a href="#cb204-12" tabindex="-1"></a></span>
<span id="cb204-13"><a href="#cb204-13" tabindex="-1"></a>folium.Marker(</span>
<span id="cb204-14"><a href="#cb204-14" tabindex="-1"></a>    jfk,</span>
<span id="cb204-15"><a href="#cb204-15" tabindex="-1"></a>    popup<span class="op">=</span><span class="st">&#39;John F. Kennedy International Airport&#39;</span>,</span>
<span id="cb204-16"><a href="#cb204-16" tabindex="-1"></a>    icon<span class="op">=</span>DivIcon(</span>
<span id="cb204-17"><a href="#cb204-17" tabindex="-1"></a>        icon_size<span class="op">=</span>(<span class="dv">150</span>,<span class="dv">36</span>),</span>
<span id="cb204-18"><a href="#cb204-18" tabindex="-1"></a>        icon_anchor<span class="op">=</span>(<span class="dv">0</span>,<span class="dv">0</span>),</span>
<span id="cb204-19"><a href="#cb204-19" tabindex="-1"></a>        html<span class="op">=</span><span class="st">&#39;&lt;div style=&quot;font-size: 24pt&quot;&gt;JFK&lt;/div&gt;&#39;</span>,</span>
<span id="cb204-20"><a href="#cb204-20" tabindex="-1"></a>    )).add_to(m)</span>
<span id="cb204-21"><a href="#cb204-21" tabindex="-1"></a></span>
<span id="cb204-22"><a href="#cb204-22" tabindex="-1"></a></span>
<span id="cb204-23"><a href="#cb204-23" tabindex="-1"></a>fig.add_child(m)</span></code></pre></div>
<hr />
</div>
</div>
<div id="contextily" class="section level2">
<h2>Contextily</h2>
<p><a
href="https://colab.research.google.com/github/spatialthoughts/python-dataviz-web/blob/main/supplement_artistic_rendering.ipynb"><img
src="https://colab.research.google.com/assets/colab-badge.svg"
alt="Open In Colab" /></a></p>
<div id="creating-an-artistic-rendering-of-a-city"
class="section level3">
<h3>Creating an Artistic Rendering of a City</h3>
<p>We can use basemap tiles from Stamen to create a high-resolution
rendering of any city using the <a
href="https://contextily.readthedocs.io/en/latest/">contextily</a>
library in Python.</p>
<p>Contextily provides an easy way to render tiles for a location using
the OpenStreetMap’s Nominatim API. Any location name from OpenStreetMap
can be geocoded and displayed using the <a
href="https://contextily.readthedocs.io/en/latest/places_guide.html">Contextily
Place API</a>.</p>
<div id="setup-2" class="section level4">
<h4>Setup</h4>
<p>The following blocks of code will install the required packages and
download the datasets to your Colab environment.</p>
<div class="sourceCode" id="cb205"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb205-1"><a href="#cb205-1" tabindex="-1"></a><span class="op">%%</span>capture</span>
<span id="cb205-2"><a href="#cb205-2" tabindex="-1"></a><span class="cf">if</span> <span class="st">&#39;google.colab&#39;</span> <span class="kw">in</span> <span class="bu">str</span>(get_ipython()):</span>
<span id="cb205-3"><a href="#cb205-3" tabindex="-1"></a>  <span class="op">!</span>pip install contextily</span></code></pre></div>
<div class="sourceCode" id="cb206"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb206-1"><a href="#cb206-1" tabindex="-1"></a><span class="im">import</span> contextily <span class="im">as</span> cx</span>
<span id="cb206-2"><a href="#cb206-2" tabindex="-1"></a><span class="im">from</span> contextily <span class="im">import</span> Place</span>
<span id="cb206-3"><a href="#cb206-3" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb206-4"><a href="#cb206-4" tabindex="-1"></a><span class="im">import</span> os</span></code></pre></div>
<div class="sourceCode" id="cb207"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb207-1"><a href="#cb207-1" tabindex="-1"></a>data_folder <span class="op">=</span> <span class="st">&#39;data&#39;</span></span>
<span id="cb207-2"><a href="#cb207-2" tabindex="-1"></a>output_folder <span class="op">=</span> <span class="st">&#39;output&#39;</span></span>
<span id="cb207-3"><a href="#cb207-3" tabindex="-1"></a></span>
<span id="cb207-4"><a href="#cb207-4" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> os.path.exists(data_folder):</span>
<span id="cb207-5"><a href="#cb207-5" tabindex="-1"></a>    os.mkdir(data_folder)</span>
<span id="cb207-6"><a href="#cb207-6" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> os.path.exists(output_folder):</span>
<span id="cb207-7"><a href="#cb207-7" tabindex="-1"></a>    os.mkdir(output_folder)</span></code></pre></div>
</div>
<div id="procedure" class="section level4">
<h4>Procedure</h4>
<p>Replace the <code>place_name</code> below with the name of your
chosen city, region or neighborhood and run it to query for its
coordinates and bounding box for OpenStreetMap. If your query fails, you
can visit <a href="https://www.openstreetmap.org/">OpenStreetMap</a> and
search for it to find the exact spelling of the place.</p>
<div class="sourceCode" id="cb208"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb208-1"><a href="#cb208-1" tabindex="-1"></a>place_name <span class="op">=</span> <span class="st">&#39;Ahmedabad, India&#39;</span></span>
<span id="cb208-2"><a href="#cb208-2" tabindex="-1"></a>place <span class="op">=</span> Place(place_name, zoom<span class="op">=</span><span class="dv">13</span>)</span></code></pre></div>
<div class="sourceCode" id="cb209"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb209-1"><a href="#cb209-1" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb209-2"><a href="#cb209-2" tabindex="-1"></a>place.plot(ax<span class="op">=</span>ax)</span>
<span id="cb209-3"><a href="#cb209-3" tabindex="-1"></a>ax.set_axis_off()</span>
<span id="cb209-4"><a href="#cb209-4" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb209-5"><a href="#cb209-5" tabindex="-1"></a>plt.show()</span></code></pre></div>
<p>You can choose from over 200 basemap styles created by different
providers. Check the available styles using
<code>contextily.providers</code>.</p>
<div class="sourceCode" id="cb210"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb210-1"><a href="#cb210-1" tabindex="-1"></a>providers <span class="op">=</span> cx.providers</span>
<span id="cb210-2"><a href="#cb210-2" tabindex="-1"></a>providers</span></code></pre></div>
<p>Let’s try the award-winning <a
href="https://www.cooperhewitt.org/2023/08/27/nda-stamen-design-watercolor-maps/"><em>Watercolor</em></a>
style by Stamen. Stamen basemaps are hosted by Stadia and require an API
key to use. You can <a href="https://stadiamaps.com/stamen/">sign-up and
obtain a free API key</a>. Once done, replace <code>YOUR-API-KEY</code>
with your actual API key below.</p>
<div class="sourceCode" id="cb211"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb211-1"><a href="#cb211-1" tabindex="-1"></a>source <span class="op">=</span> cx.providers.Stadia.StamenWatercolor(api_key<span class="op">=</span><span class="st">&#39;YOUR-API-KEY&#39;</span>)</span>
<span id="cb211-2"><a href="#cb211-2" tabindex="-1"></a>source[<span class="st">&#39;url&#39;</span>] <span class="op">=</span> source[<span class="st">&#39;url&#39;</span>] <span class="op">+</span> <span class="st">&#39;?api_key=</span><span class="sc">{api_key}</span><span class="st">&#39;</span></span>
<span id="cb211-3"><a href="#cb211-3" tabindex="-1"></a></span>
<span id="cb211-4"><a href="#cb211-4" tabindex="-1"></a>zoom <span class="op">=</span> <span class="dv">13</span></span></code></pre></div>
<div class="sourceCode" id="cb212"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb212-1"><a href="#cb212-1" tabindex="-1"></a>place <span class="op">=</span> Place(place_name, zoom<span class="op">=</span>zoom, source<span class="op">=</span>source)</span>
<span id="cb212-2"><a href="#cb212-2" tabindex="-1"></a></span>
<span id="cb212-3"><a href="#cb212-3" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb212-4"><a href="#cb212-4" tabindex="-1"></a>place.plot(ax<span class="op">=</span>ax)</span>
<span id="cb212-5"><a href="#cb212-5" tabindex="-1"></a>ax.set_axis_off()</span>
<span id="cb212-6"><a href="#cb212-6" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb212-7"><a href="#cb212-7" tabindex="-1"></a>plt.show()</span></code></pre></div>
<p>The Place API returns the rendering of the city based on its boundng
box.</p>
<div class="sourceCode" id="cb213"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb213-1"><a href="#cb213-1" tabindex="-1"></a>place <span class="op">=</span> Place(place_name)</span>
<span id="cb213-2"><a href="#cb213-2" tabindex="-1"></a>x_min, x_max, y_min, y_max <span class="op">=</span> place.bbox_map</span>
<span id="cb213-3"><a href="#cb213-3" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&#39;Original BBOX&#39;</span>, x_min, x_max, y_min, y_max)</span></code></pre></div>
<p>If we wanted to create a rendering for exact dimensions, we have to
adjust the default bounding box. Here we want to create a rendering that
will fit exactly to the chosen paper size. We compute the required ratio
and adjust the bounds so the resulting ratio matches our paper size.</p>
<div class="sourceCode" id="cb214"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb214-1"><a href="#cb214-1" tabindex="-1"></a><span class="co"># Here we are using A4 paper size in Portrait orientation</span></span>
<span id="cb214-2"><a href="#cb214-2" tabindex="-1"></a><span class="co"># Swap width and height for Landscape orientation</span></span>
<span id="cb214-3"><a href="#cb214-3" tabindex="-1"></a><span class="co"># or choose any other dimensions</span></span>
<span id="cb214-4"><a href="#cb214-4" tabindex="-1"></a>paper_height <span class="op">=</span> <span class="fl">11.69</span></span>
<span id="cb214-5"><a href="#cb214-5" tabindex="-1"></a>paper_width <span class="op">=</span> <span class="fl">8.27</span></span>
<span id="cb214-6"><a href="#cb214-6" tabindex="-1"></a></span>
<span id="cb214-7"><a href="#cb214-7" tabindex="-1"></a>ratio <span class="op">=</span> paper_width<span class="op">/</span>paper_height</span>
<span id="cb214-8"><a href="#cb214-8" tabindex="-1"></a></span>
<span id="cb214-9"><a href="#cb214-9" tabindex="-1"></a>x_size <span class="op">=</span> x_max <span class="op">-</span> x_min</span>
<span id="cb214-10"><a href="#cb214-10" tabindex="-1"></a>y_size <span class="op">=</span> y_max <span class="op">-</span> y_min</span>
<span id="cb214-11"><a href="#cb214-11" tabindex="-1"></a></span>
<span id="cb214-12"><a href="#cb214-12" tabindex="-1"></a><span class="cf">if</span> ratio <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb214-13"><a href="#cb214-13" tabindex="-1"></a>  <span class="co"># adjust width</span></span>
<span id="cb214-14"><a href="#cb214-14" tabindex="-1"></a>  x_size_required <span class="op">=</span> ratio<span class="op">*</span>(y_max <span class="op">-</span> y_min)</span>
<span id="cb214-15"><a href="#cb214-15" tabindex="-1"></a>  difference <span class="op">=</span>  x_size_required <span class="op">-</span> x_size</span>
<span id="cb214-16"><a href="#cb214-16" tabindex="-1"></a>  x_min <span class="op">=</span> x_min <span class="op">-</span> difference<span class="op">/</span><span class="dv">2</span></span>
<span id="cb214-17"><a href="#cb214-17" tabindex="-1"></a>  x_max <span class="op">=</span> x_max <span class="op">+</span> difference<span class="op">/</span><span class="dv">2</span></span>
<span id="cb214-18"><a href="#cb214-18" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb214-19"><a href="#cb214-19" tabindex="-1"></a>  <span class="co"># adjust height</span></span>
<span id="cb214-20"><a href="#cb214-20" tabindex="-1"></a>  y_size_required <span class="op">=</span> ratio<span class="op">*</span>(x_max <span class="op">-</span> x_min)</span>
<span id="cb214-21"><a href="#cb214-21" tabindex="-1"></a>  difference <span class="op">=</span>  y_size_required <span class="op">-</span> y_size</span>
<span id="cb214-22"><a href="#cb214-22" tabindex="-1"></a>  y_min <span class="op">=</span> y_min <span class="op">-</span> difference<span class="op">/</span><span class="dv">2</span></span>
<span id="cb214-23"><a href="#cb214-23" tabindex="-1"></a>  y_max <span class="op">=</span> y_max <span class="op">+</span> difference<span class="op">/</span><span class="dv">2</span></span>
<span id="cb214-24"><a href="#cb214-24" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&#39;Adjusted BBOX&#39;</span>, x_min, x_max, y_min, y_max)</span></code></pre></div>
<p>Now we have the bounding box cooridnates, we can use the
<code>bounds2img</code> method to fetch the tiles and create a map. The
final rendering is saved as a PNG file in the Colab localstorage. You
can open the <strong>Files</strong> tab from the left-hand panel in
Colab and browse to the output folder. Locate the
<code>basemap.png</code> file and click the <strong>⋮</strong> button
and select Download to download the file locally.</p>
<blockquote>
<p>Make sure to attribute the map correctly. The recommended attribution
for Stamen Watercolor tiles is <em>Map tiles by Stamen Design, under CC
BY 4.0. Data by OpenStreetMap, under CC BY SA.</em></p>
</blockquote>
<div class="sourceCode" id="cb215"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb215-1"><a href="#cb215-1" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb215-2"><a href="#cb215-2" tabindex="-1"></a>fig.set_size_inches(paper_width, paper_height)</span>
<span id="cb215-3"><a href="#cb215-3" tabindex="-1"></a></span>
<span id="cb215-4"><a href="#cb215-4" tabindex="-1"></a>basemap, extent <span class="op">=</span> cx.bounds2img(x_min, y_min, x_max, y_max, zoom<span class="op">=</span>zoom, source<span class="op">=</span>source)</span>
<span id="cb215-5"><a href="#cb215-5" tabindex="-1"></a>ax.imshow(basemap, extent<span class="op">=</span>extent)</span>
<span id="cb215-6"><a href="#cb215-6" tabindex="-1"></a></span>
<span id="cb215-7"><a href="#cb215-7" tabindex="-1"></a>ax.set_xlim(x_min, x_max)</span>
<span id="cb215-8"><a href="#cb215-8" tabindex="-1"></a>ax.set_ylim(y_min, y_max)</span>
<span id="cb215-9"><a href="#cb215-9" tabindex="-1"></a></span>
<span id="cb215-10"><a href="#cb215-10" tabindex="-1"></a>ax.set_xticks([])</span>
<span id="cb215-11"><a href="#cb215-11" tabindex="-1"></a>ax.set_yticks([])</span>
<span id="cb215-12"><a href="#cb215-12" tabindex="-1"></a></span>
<span id="cb215-13"><a href="#cb215-13" tabindex="-1"></a>plt.tight_layout(pad<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb215-14"><a href="#cb215-14" tabindex="-1"></a></span>
<span id="cb215-15"><a href="#cb215-15" tabindex="-1"></a>output_file <span class="op">=</span> <span class="st">&#39;basemap.png&#39;</span></span>
<span id="cb215-16"><a href="#cb215-16" tabindex="-1"></a>output_path <span class="op">=</span> os.path.join(output_folder, output_file)</span>
<span id="cb215-17"><a href="#cb215-17" tabindex="-1"></a>plt.savefig(output_path, dpi<span class="op">=</span><span class="dv">300</span>, bbox_inches<span class="op">=</span><span class="st">&#39;tight&#39;</span>)</span>
<span id="cb215-18"><a href="#cb215-18" tabindex="-1"></a>plt.show()</span></code></pre></div>
<p><img
src="python-dataviz-output/supplement_artistic_rendering_files/supplement_artistic_rendering_19_0.png" /></p>
</div>
</div>
</div>
<div id="advanced-plotting" class="section level2">
<h2>Advanced Plotting</h2>
<p><a
href="https://colab.research.google.com/github/spatialthoughts/python-dataviz-web/blob/main/supplement_matplotlib_themes.ipynb"><img
src="https://colab.research.google.com/assets/colab-badge.svg"
alt="Open In Colab" /></a></p>
<div id="using-matplotlib-themes-and-custom-fonts"
class="section level3">
<h3>Using Matplotlib Themes and Custom Fonts</h3>
<p>Matplotlib default style of plots is quite plain. You can easily
improve the look of the charts by applying a pre-configured stylesheet.
We can also use custom fonts to make our charts look more professional.
This notebook shows how to apply many of the built-in <a
href="https://matplotlib.org/stable/gallery/style_sheets/style_sheets_reference.html">Matplotlib
themes</a> to create aesthetically pleasing charts. We will also use the
<a href="https://pypi.org/project/pyfonts/">PyFonts</a> module to load
and use custom fonts.</p>
<div id="setup-and-data-download-9" class="section level4">
<h4>Setup and Data Download</h4>
<p>The following blocks of code will install the required packages and
download the datasets to your Colab environment.</p>
<div class="sourceCode" id="cb216"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb216-1"><a href="#cb216-1" tabindex="-1"></a><span class="op">%%</span>capture</span>
<span id="cb216-2"><a href="#cb216-2" tabindex="-1"></a><span class="cf">if</span> <span class="st">&#39;google.colab&#39;</span> <span class="kw">in</span> <span class="bu">str</span>(get_ipython()):</span>
<span id="cb216-3"><a href="#cb216-3" tabindex="-1"></a>  <span class="op">!</span>pip install pyfonts</span></code></pre></div>
<div class="sourceCode" id="cb217"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb217-1"><a href="#cb217-1" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb217-2"><a href="#cb217-2" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb217-3"><a href="#cb217-3" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb217-4"><a href="#cb217-4" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb217-5"><a href="#cb217-5" tabindex="-1"></a><span class="im">import</span> requests</span>
<span id="cb217-6"><a href="#cb217-6" tabindex="-1"></a><span class="im">import</span> pyfonts</span></code></pre></div>
<div class="sourceCode" id="cb218"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb218-1"><a href="#cb218-1" tabindex="-1"></a>data_folder <span class="op">=</span> <span class="st">&#39;data&#39;</span></span>
<span id="cb218-2"><a href="#cb218-2" tabindex="-1"></a>output_folder <span class="op">=</span> <span class="st">&#39;output&#39;</span></span>
<span id="cb218-3"><a href="#cb218-3" tabindex="-1"></a></span>
<span id="cb218-4"><a href="#cb218-4" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> os.path.exists(data_folder):</span>
<span id="cb218-5"><a href="#cb218-5" tabindex="-1"></a>    os.mkdir(data_folder)</span>
<span id="cb218-6"><a href="#cb218-6" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> os.path.exists(output_folder):</span>
<span id="cb218-7"><a href="#cb218-7" tabindex="-1"></a>    os.mkdir(output_folder)</span></code></pre></div>
<div class="sourceCode" id="cb219"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb219-1"><a href="#cb219-1" tabindex="-1"></a><span class="kw">def</span> download(url):</span>
<span id="cb219-2"><a href="#cb219-2" tabindex="-1"></a>    filename <span class="op">=</span> os.path.join(data_folder, os.path.basename(url))</span>
<span id="cb219-3"><a href="#cb219-3" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> os.path.exists(filename):</span>
<span id="cb219-4"><a href="#cb219-4" tabindex="-1"></a>      <span class="cf">with</span> requests.get(url, stream<span class="op">=</span><span class="va">True</span>, allow_redirects<span class="op">=</span><span class="va">True</span>) <span class="im">as</span> r:</span>
<span id="cb219-5"><a href="#cb219-5" tabindex="-1"></a>          <span class="cf">with</span> <span class="bu">open</span>(filename, <span class="st">&#39;wb&#39;</span>) <span class="im">as</span> f:</span>
<span id="cb219-6"><a href="#cb219-6" tabindex="-1"></a>              <span class="cf">for</span> chunk <span class="kw">in</span> r.iter_content(chunk_size<span class="op">=</span><span class="dv">8192</span>):</span>
<span id="cb219-7"><a href="#cb219-7" tabindex="-1"></a>                  f.write(chunk)</span>
<span id="cb219-8"><a href="#cb219-8" tabindex="-1"></a>      <span class="bu">print</span>(<span class="st">&#39;Downloaded&#39;</span>, filename)</span></code></pre></div>
<p>We have 12 different CSV files containing crime data for each month
of 2020. We download each of them to the data folder.</p>
<div class="sourceCode" id="cb220"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb220-1"><a href="#cb220-1" tabindex="-1"></a>files <span class="op">=</span> [</span>
<span id="cb220-2"><a href="#cb220-2" tabindex="-1"></a>  <span class="st">&#39;2020-01-metropolitan-street.csv&#39;</span>,</span>
<span id="cb220-3"><a href="#cb220-3" tabindex="-1"></a>  <span class="st">&#39;2020-02-metropolitan-street.csv&#39;</span>,</span>
<span id="cb220-4"><a href="#cb220-4" tabindex="-1"></a>  <span class="st">&#39;2020-03-metropolitan-street.csv&#39;</span>,</span>
<span id="cb220-5"><a href="#cb220-5" tabindex="-1"></a>  <span class="st">&#39;2020-04-metropolitan-street.csv&#39;</span>,</span>
<span id="cb220-6"><a href="#cb220-6" tabindex="-1"></a>  <span class="st">&#39;2020-05-metropolitan-street.csv&#39;</span>,</span>
<span id="cb220-7"><a href="#cb220-7" tabindex="-1"></a>  <span class="st">&#39;2020-06-metropolitan-street.csv&#39;</span>,</span>
<span id="cb220-8"><a href="#cb220-8" tabindex="-1"></a>  <span class="st">&#39;2020-07-metropolitan-street.csv&#39;</span>,</span>
<span id="cb220-9"><a href="#cb220-9" tabindex="-1"></a>  <span class="st">&#39;2020-08-metropolitan-street.csv&#39;</span>,</span>
<span id="cb220-10"><a href="#cb220-10" tabindex="-1"></a>  <span class="st">&#39;2020-09-metropolitan-street.csv&#39;</span>,</span>
<span id="cb220-11"><a href="#cb220-11" tabindex="-1"></a>  <span class="st">&#39;2020-10-metropolitan-street.csv&#39;</span>,</span>
<span id="cb220-12"><a href="#cb220-12" tabindex="-1"></a>  <span class="st">&#39;2020-11-metropolitan-street.csv&#39;</span>,</span>
<span id="cb220-13"><a href="#cb220-13" tabindex="-1"></a>  <span class="st">&#39;2020-12-metropolitan-street.csv&#39;</span></span>
<span id="cb220-14"><a href="#cb220-14" tabindex="-1"></a>]</span>
<span id="cb220-15"><a href="#cb220-15" tabindex="-1"></a></span>
<span id="cb220-16"><a href="#cb220-16" tabindex="-1"></a></span>
<span id="cb220-17"><a href="#cb220-17" tabindex="-1"></a>data_url <span class="op">=</span> <span class="st">&#39;https://github.com/spatialthoughts/python-dataviz-web/releases/&#39;</span> \</span>
<span id="cb220-18"><a href="#cb220-18" tabindex="-1"></a>  <span class="st">&#39;download/police.uk/&#39;</span></span>
<span id="cb220-19"><a href="#cb220-19" tabindex="-1"></a></span>
<span id="cb220-20"><a href="#cb220-20" tabindex="-1"></a><span class="cf">for</span> f <span class="kw">in</span> files:</span>
<span id="cb220-21"><a href="#cb220-21" tabindex="-1"></a>  url <span class="op">=</span> os.path.join(data_url <span class="op">+</span> f)</span>
<span id="cb220-22"><a href="#cb220-22" tabindex="-1"></a>  download(url)</span></code></pre></div>
<p>It will be helpful to merge all 12 CSV files into a single dataframe.
We can use <code>pd.concat()</code> to merge a list of dataframes.</p>
<div class="sourceCode" id="cb221"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb221-1"><a href="#cb221-1" tabindex="-1"></a>dataframe_list <span class="op">=</span> []</span>
<span id="cb221-2"><a href="#cb221-2" tabindex="-1"></a></span>
<span id="cb221-3"><a href="#cb221-3" tabindex="-1"></a><span class="cf">for</span> f <span class="kw">in</span> files:</span>
<span id="cb221-4"><a href="#cb221-4" tabindex="-1"></a>    filepath <span class="op">=</span> os.path.join(data_folder, f)</span>
<span id="cb221-5"><a href="#cb221-5" tabindex="-1"></a>    df <span class="op">=</span> pd.read_csv(filepath)</span>
<span id="cb221-6"><a href="#cb221-6" tabindex="-1"></a>    dataframe_list.append(df)</span>
<span id="cb221-7"><a href="#cb221-7" tabindex="-1"></a></span>
<span id="cb221-8"><a href="#cb221-8" tabindex="-1"></a>merged_df <span class="op">=</span> pd.concat(dataframe_list)</span></code></pre></div>
</div>
<div id="create-a-bar-chart-1" class="section level4">
<h4>Create a Bar Chart</h4>
<p>We can also chart the trend of crime over the year. For this, let’s
group the data by month.</p>
<div class="sourceCode" id="cb222"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb222-1"><a href="#cb222-1" tabindex="-1"></a>monthly_counts <span class="op">=</span> merged_df.groupby(<span class="st">&#39;Month&#39;</span>).size()</span>
<span id="cb222-2"><a href="#cb222-2" tabindex="-1"></a>monthly_counts</span></code></pre></div>
<div class="sourceCode" id="cb223"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb223-1"><a href="#cb223-1" tabindex="-1"></a><span class="co"># Use default style</span></span>
<span id="cb223-2"><a href="#cb223-2" tabindex="-1"></a>plt.style.use(<span class="st">&#39;default&#39;</span>)</span>
<span id="cb223-3"><a href="#cb223-3" tabindex="-1"></a></span>
<span id="cb223-4"><a href="#cb223-4" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb223-5"><a href="#cb223-5" tabindex="-1"></a>fig.set_size_inches(<span class="dv">12</span>,<span class="dv">6</span>)</span>
<span id="cb223-6"><a href="#cb223-6" tabindex="-1"></a>bars <span class="op">=</span> monthly_counts.plot(kind<span class="op">=</span><span class="st">&#39;bar&#39;</span>, ax<span class="op">=</span>ax)</span>
<span id="cb223-7"><a href="#cb223-7" tabindex="-1"></a></span>
<span id="cb223-8"><a href="#cb223-8" tabindex="-1"></a>ax.set_title(<span class="st">&#39;Total Crime by Month (Default Style)&#39;</span>, loc<span class="op">=</span><span class="st">&#39;left&#39;</span>, pad<span class="op">=</span><span class="dv">20</span>)</span>
<span id="cb223-9"><a href="#cb223-9" tabindex="-1"></a>ax.set_xlabel(<span class="st">&#39;&#39;</span>)</span>
<span id="cb223-10"><a href="#cb223-10" tabindex="-1"></a>ax.set_ylabel(<span class="st">&#39;Total Incidents&#39;</span>)</span>
<span id="cb223-11"><a href="#cb223-11" tabindex="-1"></a>ax.set_xticks(np.arange(<span class="bu">len</span>(monthly_counts)))</span>
<span id="cb223-12"><a href="#cb223-12" tabindex="-1"></a></span>
<span id="cb223-13"><a href="#cb223-13" tabindex="-1"></a><span class="co"># Extra: Add labels on bars</span></span>
<span id="cb223-14"><a href="#cb223-14" tabindex="-1"></a><span class="cf">for</span> bar <span class="kw">in</span> bars.patches:</span>
<span id="cb223-15"><a href="#cb223-15" tabindex="-1"></a>    height <span class="op">=</span> bar.get_height()</span>
<span id="cb223-16"><a href="#cb223-16" tabindex="-1"></a>    ax.annotate(</span>
<span id="cb223-17"><a href="#cb223-17" tabindex="-1"></a>        height,</span>
<span id="cb223-18"><a href="#cb223-18" tabindex="-1"></a>        xy<span class="op">=</span>(bar.get_x() <span class="op">+</span> bar.get_width() <span class="op">/</span> <span class="dv">2</span>, height),</span>
<span id="cb223-19"><a href="#cb223-19" tabindex="-1"></a>        xytext<span class="op">=</span>(<span class="dv">0</span>, <span class="dv">10</span>),</span>
<span id="cb223-20"><a href="#cb223-20" tabindex="-1"></a>        fontsize<span class="op">=</span><span class="dv">8</span>,</span>
<span id="cb223-21"><a href="#cb223-21" tabindex="-1"></a>        textcoords<span class="op">=</span><span class="st">&quot;offset points&quot;</span>, ha<span class="op">=</span><span class="st">&#39;center&#39;</span>, va<span class="op">=</span><span class="st">&#39;bottom&#39;</span>,</span>
<span id="cb223-22"><a href="#cb223-22" tabindex="-1"></a>        bbox<span class="op">=</span><span class="bu">dict</span>(facecolor<span class="op">=</span><span class="st">&#39;white&#39;</span>, edgecolor<span class="op">=</span><span class="st">&#39;black&#39;</span>, boxstyle<span class="op">=</span><span class="st">&#39;round&#39;</span>))</span>
<span id="cb223-23"><a href="#cb223-23" tabindex="-1"></a></span>
<span id="cb223-24"><a href="#cb223-24" tabindex="-1"></a><span class="co"># Extra: Customize X-Axis labels</span></span>
<span id="cb223-25"><a href="#cb223-25" tabindex="-1"></a></span>
<span id="cb223-26"><a href="#cb223-26" tabindex="-1"></a>labels <span class="op">=</span> []</span>
<span id="cb223-27"><a href="#cb223-27" tabindex="-1"></a><span class="cf">for</span> date <span class="kw">in</span> pd.to_datetime(monthly_counts.index):</span>
<span id="cb223-28"><a href="#cb223-28" tabindex="-1"></a>  labels.append(date.strftime(<span class="st">&#39;%b&#39;</span>))</span>
<span id="cb223-29"><a href="#cb223-29" tabindex="-1"></a>ax.set_xticklabels(labels)</span>
<span id="cb223-30"><a href="#cb223-30" tabindex="-1"></a></span>
<span id="cb223-31"><a href="#cb223-31" tabindex="-1"></a>ax.spines[<span class="st">&#39;top&#39;</span>].set_visible(<span class="va">False</span>)</span>
<span id="cb223-32"><a href="#cb223-32" tabindex="-1"></a>ax.spines[<span class="st">&#39;right&#39;</span>].set_visible(<span class="va">False</span>)</span>
<span id="cb223-33"><a href="#cb223-33" tabindex="-1"></a></span>
<span id="cb223-34"><a href="#cb223-34" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb223-35"><a href="#cb223-35" tabindex="-1"></a></span>
<span id="cb223-36"><a href="#cb223-36" tabindex="-1"></a>output_path <span class="op">=</span> os.path.join(output_folder, <span class="st">&#39;default.png&#39;</span>)</span>
<span id="cb223-37"><a href="#cb223-37" tabindex="-1"></a>plt.savefig(output_path, dpi<span class="op">=</span><span class="dv">300</span>)</span>
<span id="cb223-38"><a href="#cb223-38" tabindex="-1"></a></span>
<span id="cb223-39"><a href="#cb223-39" tabindex="-1"></a>plt.show()</span></code></pre></div>
<p><img
src="python-dataviz-output/supplement_matplotlib_themes_files/supplement_matplotlib_themes_12_0.png" /></p>
<p>Matplotlib comes with many built-in themes. Let’s see what styles are
available.</p>
<div class="sourceCode" id="cb224"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb224-1"><a href="#cb224-1" tabindex="-1"></a>plt.style.available</span></code></pre></div>
<div class="sourceCode" id="cb225"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb225-1"><a href="#cb225-1" tabindex="-1"></a><span class="co"># Use ggplot style</span></span>
<span id="cb225-2"><a href="#cb225-2" tabindex="-1"></a>plt.style.use(<span class="st">&#39;ggplot&#39;</span>)</span>
<span id="cb225-3"><a href="#cb225-3" tabindex="-1"></a></span>
<span id="cb225-4"><a href="#cb225-4" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb225-5"><a href="#cb225-5" tabindex="-1"></a>fig.set_size_inches(<span class="dv">12</span>,<span class="dv">6</span>)</span>
<span id="cb225-6"><a href="#cb225-6" tabindex="-1"></a>bars <span class="op">=</span> monthly_counts.plot(kind<span class="op">=</span><span class="st">&#39;bar&#39;</span>, ax<span class="op">=</span>ax)</span>
<span id="cb225-7"><a href="#cb225-7" tabindex="-1"></a></span>
<span id="cb225-8"><a href="#cb225-8" tabindex="-1"></a>ax.set_title(<span class="st">&#39;Total Crime by Month (ggplot)&#39;</span>, loc<span class="op">=</span><span class="st">&#39;left&#39;</span>, pad<span class="op">=</span><span class="dv">20</span>)</span>
<span id="cb225-9"><a href="#cb225-9" tabindex="-1"></a>ax.set_xlabel(<span class="st">&#39;&#39;</span>)</span>
<span id="cb225-10"><a href="#cb225-10" tabindex="-1"></a>ax.set_ylabel(<span class="st">&#39;Total Incidents&#39;</span>)</span>
<span id="cb225-11"><a href="#cb225-11" tabindex="-1"></a>ax.set_xticks(np.arange(<span class="bu">len</span>(monthly_counts)))</span>
<span id="cb225-12"><a href="#cb225-12" tabindex="-1"></a></span>
<span id="cb225-13"><a href="#cb225-13" tabindex="-1"></a><span class="co"># Extra: Add labels on bars</span></span>
<span id="cb225-14"><a href="#cb225-14" tabindex="-1"></a><span class="cf">for</span> bar <span class="kw">in</span> bars.patches:</span>
<span id="cb225-15"><a href="#cb225-15" tabindex="-1"></a>    height <span class="op">=</span> bar.get_height()</span>
<span id="cb225-16"><a href="#cb225-16" tabindex="-1"></a>    ax.annotate(</span>
<span id="cb225-17"><a href="#cb225-17" tabindex="-1"></a>        height,</span>
<span id="cb225-18"><a href="#cb225-18" tabindex="-1"></a>        xy<span class="op">=</span>(bar.get_x() <span class="op">+</span> bar.get_width() <span class="op">/</span> <span class="dv">2</span>, height),</span>
<span id="cb225-19"><a href="#cb225-19" tabindex="-1"></a>        xytext<span class="op">=</span>(<span class="dv">0</span>, <span class="dv">10</span>),</span>
<span id="cb225-20"><a href="#cb225-20" tabindex="-1"></a>        fontsize<span class="op">=</span><span class="dv">8</span>,</span>
<span id="cb225-21"><a href="#cb225-21" tabindex="-1"></a>        textcoords<span class="op">=</span><span class="st">&quot;offset points&quot;</span>, ha<span class="op">=</span><span class="st">&#39;center&#39;</span>, va<span class="op">=</span><span class="st">&#39;bottom&#39;</span>,</span>
<span id="cb225-22"><a href="#cb225-22" tabindex="-1"></a>        bbox<span class="op">=</span><span class="bu">dict</span>(facecolor<span class="op">=</span><span class="st">&#39;white&#39;</span>, edgecolor<span class="op">=</span><span class="st">&#39;black&#39;</span>, boxstyle<span class="op">=</span><span class="st">&#39;round&#39;</span>))</span>
<span id="cb225-23"><a href="#cb225-23" tabindex="-1"></a></span>
<span id="cb225-24"><a href="#cb225-24" tabindex="-1"></a><span class="co"># Extra: Customize X-Axis labels</span></span>
<span id="cb225-25"><a href="#cb225-25" tabindex="-1"></a></span>
<span id="cb225-26"><a href="#cb225-26" tabindex="-1"></a>labels <span class="op">=</span> []</span>
<span id="cb225-27"><a href="#cb225-27" tabindex="-1"></a><span class="cf">for</span> date <span class="kw">in</span> pd.to_datetime(monthly_counts.index):</span>
<span id="cb225-28"><a href="#cb225-28" tabindex="-1"></a>  labels.append(date.strftime(<span class="st">&#39;%b&#39;</span>))</span>
<span id="cb225-29"><a href="#cb225-29" tabindex="-1"></a>ax.set_xticklabels(labels)</span>
<span id="cb225-30"><a href="#cb225-30" tabindex="-1"></a></span>
<span id="cb225-31"><a href="#cb225-31" tabindex="-1"></a>ax.spines[<span class="st">&#39;top&#39;</span>].set_visible(<span class="va">False</span>)</span>
<span id="cb225-32"><a href="#cb225-32" tabindex="-1"></a>ax.spines[<span class="st">&#39;right&#39;</span>].set_visible(<span class="va">False</span>)</span>
<span id="cb225-33"><a href="#cb225-33" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb225-34"><a href="#cb225-34" tabindex="-1"></a></span>
<span id="cb225-35"><a href="#cb225-35" tabindex="-1"></a>output_path <span class="op">=</span> os.path.join(output_folder, <span class="st">&#39;seaborn.png&#39;</span>)</span>
<span id="cb225-36"><a href="#cb225-36" tabindex="-1"></a>plt.savefig(output_path, dpi<span class="op">=</span><span class="dv">300</span>)</span>
<span id="cb225-37"><a href="#cb225-37" tabindex="-1"></a></span>
<span id="cb225-38"><a href="#cb225-38" tabindex="-1"></a>plt.show()</span></code></pre></div>
<p><img
src="python-dataviz-output/supplement_matplotlib_themes_files/supplement_matplotlib_themes_15_0.png" /></p>
<p><a href="https://fonts.google.com/">Google Fonts</a> provides
open-source fonts that can be used on the web. The PyFonts package
allows us to load any of the font styles from Google Fonts using the
<code>load_google_fonts()</code> function.</p>
<div class="sourceCode" id="cb226"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb226-1"><a href="#cb226-1" tabindex="-1"></a>regular <span class="op">=</span> pyfonts.load_google_font(<span class="st">&#39;Roboto&#39;</span>)</span>
<span id="cb226-2"><a href="#cb226-2" tabindex="-1"></a>bold <span class="op">=</span> pyfonts.load_google_font(<span class="st">&#39;Roboto&#39;</span>, weight<span class="op">=</span><span class="st">&#39;bold&#39;</span>)</span>
<span id="cb226-3"><a href="#cb226-3" tabindex="-1"></a>italic <span class="op">=</span> pyfonts.load_google_font(<span class="st">&#39;Roboto&#39;</span>, italic<span class="op">=</span><span class="va">True</span>)</span></code></pre></div>
<div class="sourceCode" id="cb227"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb227-1"><a href="#cb227-1" tabindex="-1"></a><span class="co"># Use ggplot style</span></span>
<span id="cb227-2"><a href="#cb227-2" tabindex="-1"></a>plt.style.use(<span class="st">&#39;ggplot&#39;</span>)</span>
<span id="cb227-3"><a href="#cb227-3" tabindex="-1"></a></span>
<span id="cb227-4"><a href="#cb227-4" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb227-5"><a href="#cb227-5" tabindex="-1"></a>fig.set_size_inches(<span class="dv">12</span>,<span class="dv">6</span>)</span>
<span id="cb227-6"><a href="#cb227-6" tabindex="-1"></a>bars <span class="op">=</span> monthly_counts.plot(kind<span class="op">=</span><span class="st">&#39;bar&#39;</span>, ax<span class="op">=</span>ax)</span>
<span id="cb227-7"><a href="#cb227-7" tabindex="-1"></a></span>
<span id="cb227-8"><a href="#cb227-8" tabindex="-1"></a>fig.text(x<span class="op">=</span><span class="fl">0.13</span>, y<span class="op">=</span><span class="fl">0.95</span>, s<span class="op">=</span><span class="st">&#39;Total Crime by Month &#39;</span>, size<span class="op">=</span><span class="dv">20</span>, font<span class="op">=</span>bold)</span>
<span id="cb227-9"><a href="#cb227-9" tabindex="-1"></a>fig.text(x<span class="op">=</span><span class="fl">0.13</span>, y<span class="op">=</span><span class="fl">0.90</span>, s<span class="op">=</span><span class="st">&#39;Using ggplot Theme + Custom Fonts&#39;</span>, size<span class="op">=</span><span class="dv">12</span>, font<span class="op">=</span>italic)</span>
<span id="cb227-10"><a href="#cb227-10" tabindex="-1"></a></span>
<span id="cb227-11"><a href="#cb227-11" tabindex="-1"></a>ax.set_xlabel(<span class="st">&#39;&#39;</span>)</span>
<span id="cb227-12"><a href="#cb227-12" tabindex="-1"></a>ax.set_ylabel(<span class="st">&#39;Total Incidents&#39;</span>, font<span class="op">=</span>regular, size<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb227-13"><a href="#cb227-13" tabindex="-1"></a>ax.set_xticks(np.arange(<span class="bu">len</span>(monthly_counts)))</span>
<span id="cb227-14"><a href="#cb227-14" tabindex="-1"></a></span>
<span id="cb227-15"><a href="#cb227-15" tabindex="-1"></a><span class="co"># Extra: Add labels on bars</span></span>
<span id="cb227-16"><a href="#cb227-16" tabindex="-1"></a><span class="cf">for</span> bar <span class="kw">in</span> bars.patches:</span>
<span id="cb227-17"><a href="#cb227-17" tabindex="-1"></a>    height <span class="op">=</span> bar.get_height()</span>
<span id="cb227-18"><a href="#cb227-18" tabindex="-1"></a>    ax.annotate(</span>
<span id="cb227-19"><a href="#cb227-19" tabindex="-1"></a>        height,</span>
<span id="cb227-20"><a href="#cb227-20" tabindex="-1"></a>        xy<span class="op">=</span>(bar.get_x() <span class="op">+</span> bar.get_width() <span class="op">/</span> <span class="dv">2</span>, height),</span>
<span id="cb227-21"><a href="#cb227-21" tabindex="-1"></a>        xytext<span class="op">=</span>(<span class="dv">0</span>, <span class="dv">10</span>),</span>
<span id="cb227-22"><a href="#cb227-22" tabindex="-1"></a>        fontsize<span class="op">=</span><span class="dv">8</span>,</span>
<span id="cb227-23"><a href="#cb227-23" tabindex="-1"></a>        font<span class="op">=</span>regular,</span>
<span id="cb227-24"><a href="#cb227-24" tabindex="-1"></a>        textcoords<span class="op">=</span><span class="st">&quot;offset points&quot;</span>, ha<span class="op">=</span><span class="st">&#39;center&#39;</span>, va<span class="op">=</span><span class="st">&#39;bottom&#39;</span>,</span>
<span id="cb227-25"><a href="#cb227-25" tabindex="-1"></a>        bbox<span class="op">=</span><span class="bu">dict</span>(facecolor<span class="op">=</span><span class="st">&#39;white&#39;</span>, edgecolor<span class="op">=</span><span class="st">&#39;black&#39;</span>, boxstyle<span class="op">=</span><span class="st">&#39;round&#39;</span>))</span>
<span id="cb227-26"><a href="#cb227-26" tabindex="-1"></a></span>
<span id="cb227-27"><a href="#cb227-27" tabindex="-1"></a><span class="co"># Customize X-Axis labels</span></span>
<span id="cb227-28"><a href="#cb227-28" tabindex="-1"></a>labels <span class="op">=</span> []</span>
<span id="cb227-29"><a href="#cb227-29" tabindex="-1"></a><span class="cf">for</span> date <span class="kw">in</span> pd.to_datetime(monthly_counts.index):</span>
<span id="cb227-30"><a href="#cb227-30" tabindex="-1"></a>  labels.append(date.strftime(<span class="st">&#39;%b&#39;</span>))</span>
<span id="cb227-31"><a href="#cb227-31" tabindex="-1"></a>ax.set_xticklabels(labels, font<span class="op">=</span>regular)</span>
<span id="cb227-32"><a href="#cb227-32" tabindex="-1"></a></span>
<span id="cb227-33"><a href="#cb227-33" tabindex="-1"></a><span class="co"># Customize Y-Axis labels</span></span>
<span id="cb227-34"><a href="#cb227-34" tabindex="-1"></a><span class="cf">for</span> label <span class="kw">in</span> ax.get_yticklabels():</span>
<span id="cb227-35"><a href="#cb227-35" tabindex="-1"></a>    label.set_fontproperties(regular)</span>
<span id="cb227-36"><a href="#cb227-36" tabindex="-1"></a></span>
<span id="cb227-37"><a href="#cb227-37" tabindex="-1"></a>ax.spines[<span class="st">&#39;top&#39;</span>].set_visible(<span class="va">False</span>)</span>
<span id="cb227-38"><a href="#cb227-38" tabindex="-1"></a>ax.spines[<span class="st">&#39;right&#39;</span>].set_visible(<span class="va">False</span>)</span>
<span id="cb227-39"><a href="#cb227-39" tabindex="-1"></a></span>
<span id="cb227-40"><a href="#cb227-40" tabindex="-1"></a>output_path <span class="op">=</span> os.path.join(output_folder, <span class="st">&#39;ggplot.png&#39;</span>)</span>
<span id="cb227-41"><a href="#cb227-41" tabindex="-1"></a>plt.savefig(output_path, dpi<span class="op">=</span><span class="dv">300</span>)</span>
<span id="cb227-42"><a href="#cb227-42" tabindex="-1"></a></span>
<span id="cb227-43"><a href="#cb227-43" tabindex="-1"></a>plt.show()</span></code></pre></div>
<p><img
src="python-dataviz-output/supplement_matplotlib_themes_files/supplement_matplotlib_themes_18_0.png" /></p>
<p><a
href="https://colab.research.google.com/github/spatialthoughts/python-dataviz-web/blob/main/supplement_stacked_barcharts.ipynb"><img
src="https://colab.research.google.com/assets/colab-badge.svg"
alt="Open In Colab" /></a></p>
</div>
</div>
<div id="creating-a-stacked-bar-chart" class="section level3">
<h3>Creating A Stacked Bar Chart</h3>
<p>This example shows how to create a stacked chart with information
about crime type in each bar. This visualization can plot 2 variables in
a single plot.</p>
<div id="setup-and-data-download-10" class="section level4">
<h4>Setup and Data Download</h4>
<p>The following blocks of code will install the required packages and
download the datasets to your Colab environment.</p>
</div>
<div id="data-pre-processing-4" class="section level4">
<h4>Data Pre-Processing</h4>
<div class="sourceCode" id="cb228"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb228-1"><a href="#cb228-1" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb228-2"><a href="#cb228-2" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb228-3"><a href="#cb228-3" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb228-4"><a href="#cb228-4" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb228-5"><a href="#cb228-5" tabindex="-1"></a><span class="im">import</span> requests</span></code></pre></div>
<div class="sourceCode" id="cb229"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb229-1"><a href="#cb229-1" tabindex="-1"></a>data_folder <span class="op">=</span> <span class="st">&#39;data&#39;</span></span>
<span id="cb229-2"><a href="#cb229-2" tabindex="-1"></a>output_folder <span class="op">=</span> <span class="st">&#39;output&#39;</span></span>
<span id="cb229-3"><a href="#cb229-3" tabindex="-1"></a></span>
<span id="cb229-4"><a href="#cb229-4" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> os.path.exists(data_folder):</span>
<span id="cb229-5"><a href="#cb229-5" tabindex="-1"></a>    os.mkdir(data_folder)</span>
<span id="cb229-6"><a href="#cb229-6" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> os.path.exists(output_folder):</span>
<span id="cb229-7"><a href="#cb229-7" tabindex="-1"></a>    os.mkdir(output_folder)</span></code></pre></div>
<div class="sourceCode" id="cb230"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb230-1"><a href="#cb230-1" tabindex="-1"></a><span class="kw">def</span> download(url):</span>
<span id="cb230-2"><a href="#cb230-2" tabindex="-1"></a>    filename <span class="op">=</span> os.path.join(data_folder, os.path.basename(url))</span>
<span id="cb230-3"><a href="#cb230-3" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> os.path.exists(filename):</span>
<span id="cb230-4"><a href="#cb230-4" tabindex="-1"></a>      <span class="cf">with</span> requests.get(url, stream<span class="op">=</span><span class="va">True</span>, allow_redirects<span class="op">=</span><span class="va">True</span>) <span class="im">as</span> r:</span>
<span id="cb230-5"><a href="#cb230-5" tabindex="-1"></a>          <span class="cf">with</span> <span class="bu">open</span>(filename, <span class="st">&#39;wb&#39;</span>) <span class="im">as</span> f:</span>
<span id="cb230-6"><a href="#cb230-6" tabindex="-1"></a>              <span class="cf">for</span> chunk <span class="kw">in</span> r.iter_content(chunk_size<span class="op">=</span><span class="dv">8192</span>):</span>
<span id="cb230-7"><a href="#cb230-7" tabindex="-1"></a>                  f.write(chunk)</span>
<span id="cb230-8"><a href="#cb230-8" tabindex="-1"></a>      <span class="bu">print</span>(<span class="st">&#39;Downloaded&#39;</span>, filename)</span></code></pre></div>
<p>We have 12 different CSV files containing crime data for each month
of 2020. We download each of them to the data folder.</p>
<div class="sourceCode" id="cb231"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb231-1"><a href="#cb231-1" tabindex="-1"></a>files <span class="op">=</span> [</span>
<span id="cb231-2"><a href="#cb231-2" tabindex="-1"></a>  <span class="st">&#39;2020-01-metropolitan-street.csv&#39;</span>,</span>
<span id="cb231-3"><a href="#cb231-3" tabindex="-1"></a>  <span class="st">&#39;2020-02-metropolitan-street.csv&#39;</span>,</span>
<span id="cb231-4"><a href="#cb231-4" tabindex="-1"></a>  <span class="st">&#39;2020-03-metropolitan-street.csv&#39;</span>,</span>
<span id="cb231-5"><a href="#cb231-5" tabindex="-1"></a>  <span class="st">&#39;2020-04-metropolitan-street.csv&#39;</span>,</span>
<span id="cb231-6"><a href="#cb231-6" tabindex="-1"></a>  <span class="st">&#39;2020-05-metropolitan-street.csv&#39;</span>,</span>
<span id="cb231-7"><a href="#cb231-7" tabindex="-1"></a>  <span class="st">&#39;2020-06-metropolitan-street.csv&#39;</span>,</span>
<span id="cb231-8"><a href="#cb231-8" tabindex="-1"></a>  <span class="st">&#39;2020-07-metropolitan-street.csv&#39;</span>,</span>
<span id="cb231-9"><a href="#cb231-9" tabindex="-1"></a>  <span class="st">&#39;2020-08-metropolitan-street.csv&#39;</span>,</span>
<span id="cb231-10"><a href="#cb231-10" tabindex="-1"></a>  <span class="st">&#39;2020-09-metropolitan-street.csv&#39;</span>,</span>
<span id="cb231-11"><a href="#cb231-11" tabindex="-1"></a>  <span class="st">&#39;2020-10-metropolitan-street.csv&#39;</span>,</span>
<span id="cb231-12"><a href="#cb231-12" tabindex="-1"></a>  <span class="st">&#39;2020-11-metropolitan-street.csv&#39;</span>,</span>
<span id="cb231-13"><a href="#cb231-13" tabindex="-1"></a>  <span class="st">&#39;2020-12-metropolitan-street.csv&#39;</span></span>
<span id="cb231-14"><a href="#cb231-14" tabindex="-1"></a>]</span>
<span id="cb231-15"><a href="#cb231-15" tabindex="-1"></a></span>
<span id="cb231-16"><a href="#cb231-16" tabindex="-1"></a></span>
<span id="cb231-17"><a href="#cb231-17" tabindex="-1"></a>data_url <span class="op">=</span> <span class="st">&#39;https://github.com/spatialthoughts/python-dataviz-web/releases/&#39;</span> \</span>
<span id="cb231-18"><a href="#cb231-18" tabindex="-1"></a>  <span class="st">&#39;download/police.uk/&#39;</span></span>
<span id="cb231-19"><a href="#cb231-19" tabindex="-1"></a></span>
<span id="cb231-20"><a href="#cb231-20" tabindex="-1"></a><span class="cf">for</span> f <span class="kw">in</span> files:</span>
<span id="cb231-21"><a href="#cb231-21" tabindex="-1"></a>  url <span class="op">=</span> os.path.join(data_url <span class="op">+</span> f)</span>
<span id="cb231-22"><a href="#cb231-22" tabindex="-1"></a>  download(url)</span></code></pre></div>
<p>It will be helpful to merge all 12 CSV files into a single dataframe.
We can use <code>pd.concat()</code> to merge a list of dataframes.</p>
<div class="sourceCode" id="cb232"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb232-1"><a href="#cb232-1" tabindex="-1"></a>dataframe_list <span class="op">=</span> []</span>
<span id="cb232-2"><a href="#cb232-2" tabindex="-1"></a></span>
<span id="cb232-3"><a href="#cb232-3" tabindex="-1"></a><span class="cf">for</span> f <span class="kw">in</span> files:</span>
<span id="cb232-4"><a href="#cb232-4" tabindex="-1"></a>    filepath <span class="op">=</span> os.path.join(data_folder, f)</span>
<span id="cb232-5"><a href="#cb232-5" tabindex="-1"></a>    df <span class="op">=</span> pd.read_csv(filepath)</span>
<span id="cb232-6"><a href="#cb232-6" tabindex="-1"></a>    dataframe_list.append(df)</span>
<span id="cb232-7"><a href="#cb232-7" tabindex="-1"></a></span>
<span id="cb232-8"><a href="#cb232-8" tabindex="-1"></a>merged_df <span class="op">=</span> pd.concat(dataframe_list)</span></code></pre></div>
<div class="sourceCode" id="cb233"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb233-1"><a href="#cb233-1" tabindex="-1"></a>counts_by_type <span class="op">=</span> merged_df.groupby([<span class="st">&#39;Month&#39;</span>, <span class="st">&#39;Crime type&#39;</span>]).size()</span>
<span id="cb233-2"><a href="#cb233-2" tabindex="-1"></a>counts_by_type</span></code></pre></div>
<p>The result is not in a suitable format for plotting. We call
<code>unstack()</code> to create a dataframe.</p>
<div class="sourceCode" id="cb234"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb234-1"><a href="#cb234-1" tabindex="-1"></a>counts_df <span class="op">=</span> counts_by_type.unstack()</span>
<span id="cb234-2"><a href="#cb234-2" tabindex="-1"></a>counts_df</span></code></pre></div>
</div>
<div id="creating-a-chart" class="section level4">
<h4>Creating a Chart</h4>
<p>The default chart is not stacked. i.e. we get separate bars for each
crime type.</p>
<div class="sourceCode" id="cb235"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb235-1"><a href="#cb235-1" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb235-2"><a href="#cb235-2" tabindex="-1"></a>fig.set_size_inches(<span class="dv">20</span>,<span class="dv">10</span>)</span>
<span id="cb235-3"><a href="#cb235-3" tabindex="-1"></a>counts_df.plot(</span>
<span id="cb235-4"><a href="#cb235-4" tabindex="-1"></a>    kind<span class="op">=</span><span class="st">&#39;bar&#39;</span>, ax<span class="op">=</span>ax, colormap<span class="op">=</span><span class="st">&#39;tab20&#39;</span>)</span>
<span id="cb235-5"><a href="#cb235-5" tabindex="-1"></a>ax.set_ylabel(<span class="st">&#39;Number of Incidents&#39;</span>, size <span class="op">=</span> <span class="dv">15</span>)</span>
<span id="cb235-6"><a href="#cb235-6" tabindex="-1"></a>ax.set_title(<span class="st">&#39;Crime in London (2020)&#39;</span>, size <span class="op">=</span> <span class="dv">18</span>, y<span class="op">=</span><span class="fl">1.1</span>)</span>
<span id="cb235-7"><a href="#cb235-7" tabindex="-1"></a>plt.show()</span></code></pre></div>
<p><img
src="python-dataviz-output/supplement_stacked_barcharts_files/supplement_stacked_barcharts_15_0.png" /></p>
<p>We can set <code>stacked=True</code> for a stacked bar chart.</p>
<div class="sourceCode" id="cb236"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb236-1"><a href="#cb236-1" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb236-2"><a href="#cb236-2" tabindex="-1"></a>fig.set_size_inches(<span class="dv">20</span>,<span class="dv">10</span>)</span>
<span id="cb236-3"><a href="#cb236-3" tabindex="-1"></a>counts_df.plot(</span>
<span id="cb236-4"><a href="#cb236-4" tabindex="-1"></a>    kind<span class="op">=</span><span class="st">&#39;bar&#39;</span>, ax<span class="op">=</span>ax, colormap<span class="op">=</span><span class="st">&#39;tab20&#39;</span>, stacked<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb236-5"><a href="#cb236-5" tabindex="-1"></a>ax.set_ylabel(<span class="st">&#39;Number of Incidents&#39;</span>, size <span class="op">=</span> <span class="dv">15</span>)</span>
<span id="cb236-6"><a href="#cb236-6" tabindex="-1"></a>ax.set_title(<span class="st">&#39;Crime in London (2020)&#39;</span>, size <span class="op">=</span> <span class="dv">18</span>, y<span class="op">=</span><span class="fl">1.1</span>)</span>
<span id="cb236-7"><a href="#cb236-7" tabindex="-1"></a>plt.show()</span></code></pre></div>
<p><img
src="python-dataviz-output/supplement_stacked_barcharts_files/supplement_stacked_barcharts_17_0.png" /></p>
<p>We can make some final adjustments to the plot and create a
horizontal legend with a frame.</p>
<div class="sourceCode" id="cb237"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb237-1"><a href="#cb237-1" tabindex="-1"></a>legend_kwds<span class="op">=</span> {</span>
<span id="cb237-2"><a href="#cb237-2" tabindex="-1"></a>  <span class="st">&#39;loc&#39;</span>: <span class="st">&#39;upper center&#39;</span>,</span>
<span id="cb237-3"><a href="#cb237-3" tabindex="-1"></a>  <span class="st">&#39;ncols&#39;</span>: <span class="dv">5</span>,</span>
<span id="cb237-4"><a href="#cb237-4" tabindex="-1"></a>  <span class="st">&#39;bbox_to_anchor&#39;</span>: (<span class="fl">0.5</span>, <span class="fl">1.1</span>),</span>
<span id="cb237-5"><a href="#cb237-5" tabindex="-1"></a>  <span class="st">&#39;fancybox&#39;</span>: <span class="va">True</span>,</span>
<span id="cb237-6"><a href="#cb237-6" tabindex="-1"></a>  <span class="st">&#39;shadow&#39;</span>: <span class="va">True</span></span>
<span id="cb237-7"><a href="#cb237-7" tabindex="-1"></a>}</span>
<span id="cb237-8"><a href="#cb237-8" tabindex="-1"></a></span>
<span id="cb237-9"><a href="#cb237-9" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb237-10"><a href="#cb237-10" tabindex="-1"></a>fig.set_size_inches(<span class="dv">20</span>,<span class="dv">10</span>)</span>
<span id="cb237-11"><a href="#cb237-11" tabindex="-1"></a><span class="co"># We can chain .plot() and .legend() together</span></span>
<span id="cb237-12"><a href="#cb237-12" tabindex="-1"></a>counts_df <span class="op">\</span></span>
<span id="cb237-13"><a href="#cb237-13" tabindex="-1"></a>  .plot(kind<span class="op">=</span><span class="st">&#39;bar&#39;</span>, stacked<span class="op">=</span><span class="va">True</span>, ax<span class="op">=</span>ax, colormap<span class="op">=</span><span class="st">&#39;tab20&#39;</span>) <span class="op">\</span></span>
<span id="cb237-14"><a href="#cb237-14" tabindex="-1"></a>  .legend(<span class="op">**</span>legend_kwds)</span>
<span id="cb237-15"><a href="#cb237-15" tabindex="-1"></a></span>
<span id="cb237-16"><a href="#cb237-16" tabindex="-1"></a><span class="co"># Hide the top and right spines</span></span>
<span id="cb237-17"><a href="#cb237-17" tabindex="-1"></a>ax.spines[<span class="st">&#39;right&#39;</span>].set_visible(<span class="va">False</span>)</span>
<span id="cb237-18"><a href="#cb237-18" tabindex="-1"></a>ax.spines[<span class="st">&#39;top&#39;</span>].set_visible(<span class="va">False</span>)</span>
<span id="cb237-19"><a href="#cb237-19" tabindex="-1"></a></span>
<span id="cb237-20"><a href="#cb237-20" tabindex="-1"></a>ax.set_ylabel(<span class="st">&#39;Number of Incidents&#39;</span>, size <span class="op">=</span> <span class="dv">15</span>)</span>
<span id="cb237-21"><a href="#cb237-21" tabindex="-1"></a>ax.set_title(<span class="st">&#39;Crime in London (2020)&#39;</span>, size <span class="op">=</span> <span class="dv">18</span>, y<span class="op">=</span><span class="fl">1.1</span>)</span>
<span id="cb237-22"><a href="#cb237-22" tabindex="-1"></a></span>
<span id="cb237-23"><a href="#cb237-23" tabindex="-1"></a>output_folder <span class="op">=</span> <span class="st">&#39;output&#39;</span></span>
<span id="cb237-24"><a href="#cb237-24" tabindex="-1"></a>output_path <span class="op">=</span> os.path.join(output_folder, <span class="st">&#39;stacked_chart.jpg&#39;</span>)</span>
<span id="cb237-25"><a href="#cb237-25" tabindex="-1"></a>plt.savefig(output_path)</span>
<span id="cb237-26"><a href="#cb237-26" tabindex="-1"></a></span>
<span id="cb237-27"><a href="#cb237-27" tabindex="-1"></a>plt.show()</span></code></pre></div>
<p><img
src="python-dataviz-output/supplement_stacked_barcharts_files/supplement_stacked_barcharts_19_0.png" /></p>
<p><a
href="https://colab.research.google.com/github/spatialthoughts/python-dataviz-web/blob/main/supplement_elevation_profile_plot.ipynb"><img
src="https://colab.research.google.com/assets/colab-badge.svg"
alt="Open In Colab" /></a></p>
</div>
</div>
<div id="elevation-profile-plot-from-a-gps-track"
class="section level3">
<h3>Elevation Profile Plot from a GPS Track</h3>
<p>We will take a GPS track for a mountain trek recorded from Strava app
and create an elevation profile plot. We also explore some advanced
charting functions to add labels on X-axis at precise time
intervals.</p>
<div id="setup-and-data-download-11" class="section level4">
<h4>Setup and Data Download</h4>
<p>The following blocks of code will install the required packages and
download the datasets to your Colab environment.</p>
<div class="sourceCode" id="cb238"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb238-1"><a href="#cb238-1" tabindex="-1"></a><span class="im">import</span> geopandas <span class="im">as</span> gpd</span>
<span id="cb238-2"><a href="#cb238-2" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb238-3"><a href="#cb238-3" tabindex="-1"></a><span class="im">import</span> matplotlib.dates <span class="im">as</span> mdates</span>
<span id="cb238-4"><a href="#cb238-4" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb238-5"><a href="#cb238-5" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb238-6"><a href="#cb238-6" tabindex="-1"></a><span class="im">import</span> requests</span></code></pre></div>
<div class="sourceCode" id="cb239"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb239-1"><a href="#cb239-1" tabindex="-1"></a>data_folder <span class="op">=</span> <span class="st">&#39;data&#39;</span></span>
<span id="cb239-2"><a href="#cb239-2" tabindex="-1"></a>output_folder <span class="op">=</span> <span class="st">&#39;output&#39;</span></span>
<span id="cb239-3"><a href="#cb239-3" tabindex="-1"></a></span>
<span id="cb239-4"><a href="#cb239-4" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> os.path.exists(data_folder):</span>
<span id="cb239-5"><a href="#cb239-5" tabindex="-1"></a>    os.mkdir(data_folder)</span>
<span id="cb239-6"><a href="#cb239-6" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> os.path.exists(output_folder):</span>
<span id="cb239-7"><a href="#cb239-7" tabindex="-1"></a>    os.mkdir(output_folder)</span></code></pre></div>
<div class="sourceCode" id="cb240"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb240-1"><a href="#cb240-1" tabindex="-1"></a><span class="kw">def</span> download(url):</span>
<span id="cb240-2"><a href="#cb240-2" tabindex="-1"></a>    filename <span class="op">=</span> os.path.join(data_folder, os.path.basename(url))</span>
<span id="cb240-3"><a href="#cb240-3" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> os.path.exists(filename):</span>
<span id="cb240-4"><a href="#cb240-4" tabindex="-1"></a>      <span class="cf">with</span> requests.get(url, stream<span class="op">=</span><span class="va">True</span>, allow_redirects<span class="op">=</span><span class="va">True</span>) <span class="im">as</span> r:</span>
<span id="cb240-5"><a href="#cb240-5" tabindex="-1"></a>          <span class="cf">with</span> <span class="bu">open</span>(filename, <span class="st">&#39;wb&#39;</span>) <span class="im">as</span> f:</span>
<span id="cb240-6"><a href="#cb240-6" tabindex="-1"></a>              <span class="cf">for</span> chunk <span class="kw">in</span> r.iter_content(chunk_size<span class="op">=</span><span class="dv">8192</span>):</span>
<span id="cb240-7"><a href="#cb240-7" tabindex="-1"></a>                  f.write(chunk)</span>
<span id="cb240-8"><a href="#cb240-8" tabindex="-1"></a>      <span class="bu">print</span>(<span class="st">&#39;Downloaded&#39;</span>, filename)</span></code></pre></div>
<div class="sourceCode" id="cb241"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb241-1"><a href="#cb241-1" tabindex="-1"></a>filename <span class="op">=</span> <span class="st">&#39;summit.gpx&#39;</span></span>
<span id="cb241-2"><a href="#cb241-2" tabindex="-1"></a></span>
<span id="cb241-3"><a href="#cb241-3" tabindex="-1"></a>data_url <span class="op">=</span> <span class="st">&#39;https://github.com/spatialthoughts/python-dataviz-web/releases/&#39;</span> \</span>
<span id="cb241-4"><a href="#cb241-4" tabindex="-1"></a>  <span class="st">&#39;download/gps/&#39;</span></span>
<span id="cb241-5"><a href="#cb241-5" tabindex="-1"></a></span>
<span id="cb241-6"><a href="#cb241-6" tabindex="-1"></a>download(data_url <span class="op">+</span> filename)</span></code></pre></div>
</div>
<div id="data-pre-processing-5" class="section level4">
<h4>Data Pre-Processing</h4>
<div class="sourceCode" id="cb242"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb242-1"><a href="#cb242-1" tabindex="-1"></a>gpx_path <span class="op">=</span> os.path.join(data_folder, filename)</span>
<span id="cb242-2"><a href="#cb242-2" tabindex="-1"></a><span class="co"># GPX files contain many layers. Read the &#39;track_points&#39; layer</span></span>
<span id="cb242-3"><a href="#cb242-3" tabindex="-1"></a>gdf <span class="op">=</span> gpd.read_file(gpx_path, layer<span class="op">=</span><span class="st">&#39;track_points&#39;</span>)</span>
<span id="cb242-4"><a href="#cb242-4" tabindex="-1"></a>gdf <span class="op">=</span> gdf[[<span class="st">&#39;track_fid&#39;</span>,<span class="st">&#39;ele&#39;</span>, <span class="st">&#39;time&#39;</span>, <span class="st">&#39;geometry&#39;</span>]]</span>
<span id="cb242-5"><a href="#cb242-5" tabindex="-1"></a>gdf</span></code></pre></div>
<p>Let’s use the timestamp contained in the ‘time’ column as the index.
This will allow us to filter and plot the time-series data easily. We
must first convert the time column to datetime type with an appropriate
timezone.</p>
<div class="sourceCode" id="cb243"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb243-1"><a href="#cb243-1" tabindex="-1"></a>gdf[<span class="st">&#39;time&#39;</span>] <span class="op">=</span> pd.to_datetime(gdf[<span class="st">&#39;time&#39;</span>])</span>
<span id="cb243-2"><a href="#cb243-2" tabindex="-1"></a>gdf <span class="op">=</span> gdf.set_index(<span class="st">&#39;time&#39;</span>)</span>
<span id="cb243-3"><a href="#cb243-3" tabindex="-1"></a>gdf.index <span class="op">=</span> gdf.index.tz_convert(<span class="st">&#39;Asia/Kolkata&#39;</span>)</span>
<span id="cb243-4"><a href="#cb243-4" tabindex="-1"></a>gdf</span></code></pre></div>
<p>Using time as index allows us to filter the data as follows</p>
<div class="sourceCode" id="cb244"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb244-1"><a href="#cb244-1" tabindex="-1"></a>gdf_subset <span class="op">=</span> gdf[<span class="st">&#39;2022-04-04T06:15:00&#39;</span>:<span class="st">&#39;2022-04-04T10:45:00&#39;</span>]</span>
<span id="cb244-2"><a href="#cb244-2" tabindex="-1"></a>gdf_subset</span></code></pre></div>
<p>We can now plot the elevation against the timestamp using Matplotlib.
Since we have a large number of timestamps, we can use
<code>set_major_locator()</code> to define what labels will be present
on the axis.</p>
<p>Since our timestamps are timezone aware, we can also plot a timezone
name (i.e. IST) along with the label.</p>
<p>We can also use a different style for our plot. You can run
<code>plt.style.available</code> to see all available styles.</p>
<div class="sourceCode" id="cb245"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb245-1"><a href="#cb245-1" tabindex="-1"></a>plt.style.use(<span class="st">&#39;ggplot&#39;</span>)</span></code></pre></div>
<div class="sourceCode" id="cb246"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb246-1"><a href="#cb246-1" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb246-2"><a href="#cb246-2" tabindex="-1"></a>fig.set_size_inches(<span class="dv">15</span>,<span class="dv">7</span>)</span>
<span id="cb246-3"><a href="#cb246-3" tabindex="-1"></a></span>
<span id="cb246-4"><a href="#cb246-4" tabindex="-1"></a><span class="co"># We show a subset of track for the summit in a blue line</span></span>
<span id="cb246-5"><a href="#cb246-5" tabindex="-1"></a>gdf_subset[<span class="st">&#39;ele&#39;</span>].plot(kind<span class="op">=</span><span class="st">&#39;line&#39;</span>, ax<span class="op">=</span>ax, color<span class="op">=</span><span class="st">&#39;#2b8cbe&#39;</span>)</span>
<span id="cb246-6"><a href="#cb246-6" tabindex="-1"></a><span class="co"># The full track is shown with a grey fill</span></span>
<span id="cb246-7"><a href="#cb246-7" tabindex="-1"></a>ax.fill_between(gdf.index, gdf[<span class="st">&#39;ele&#39;</span>].values, color<span class="op">=</span><span class="st">&#39;grey&#39;</span>, alpha<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb246-8"><a href="#cb246-8" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb246-9"><a href="#cb246-9" tabindex="-1"></a>plt.title(<span class="st">&#39;Elevation Profile&#39;</span>, fontsize <span class="op">=</span> <span class="dv">18</span>)</span>
<span id="cb246-10"><a href="#cb246-10" tabindex="-1"></a>plt.ylabel(<span class="st">&#39;Elevation (meters)&#39;</span>, size <span class="op">=</span> <span class="dv">15</span>)</span>
<span id="cb246-11"><a href="#cb246-11" tabindex="-1"></a>plt.xlabel(<span class="va">None</span>)</span>
<span id="cb246-12"><a href="#cb246-12" tabindex="-1"></a></span>
<span id="cb246-13"><a href="#cb246-13" tabindex="-1"></a><span class="co"># Show a tick every 30 minute</span></span>
<span id="cb246-14"><a href="#cb246-14" tabindex="-1"></a>xlocator <span class="op">=</span> mdates.MinuteLocator(interval<span class="op">=</span><span class="dv">30</span>)</span>
<span id="cb246-15"><a href="#cb246-15" tabindex="-1"></a>xformat <span class="op">=</span> mdates.DateFormatter(<span class="st">&#39;%H:%M %Z&#39;</span>, tz<span class="op">=</span>gdf.index.tz)</span>
<span id="cb246-16"><a href="#cb246-16" tabindex="-1"></a></span>
<span id="cb246-17"><a href="#cb246-17" tabindex="-1"></a>ax.xaxis.set_major_locator(xlocator)</span>
<span id="cb246-18"><a href="#cb246-18" tabindex="-1"></a>ax.xaxis.set_major_formatter(xformat)</span>
<span id="cb246-19"><a href="#cb246-19" tabindex="-1"></a></span>
<span id="cb246-20"><a href="#cb246-20" tabindex="-1"></a>ax.set_ylim([<span class="dv">3200</span>, <span class="dv">3700</span>])</span>
<span id="cb246-21"><a href="#cb246-21" tabindex="-1"></a>plt.show()</span></code></pre></div>
<p><img
src="python-dataviz-output/supplement_elevation_profile_plot_files/supplement_elevation_profile_plot_15_0.png" /></p>
<p><a
href="https://colab.research.google.com/github/spatialthoughts/python-dataviz-web/blob/main/supplement_eclipse_globe.ipynb"><img
src="https://colab.research.google.com/assets/colab-badge.svg"
alt="Open In Colab" /></a></p>
</div>
</div>
<div id="creating-a-globe-visualization" class="section level3">
<h3>Creating a Globe Visualization</h3>
<p>This notebook shows how how to take a shapefile showing the path of
the <a href="https://svs.gsfc.nasa.gov/4518">2017 Solar Eclipse</a> and
create a globe visualization.</p>
<div id="setup-and-data-download-12" class="section level4">
<h4>Setup and Data Download</h4>
<p>The following blocks of code will install the required packages and
download the datasets to your Colab environment.</p>
<div class="sourceCode" id="cb247"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb247-1"><a href="#cb247-1" tabindex="-1"></a><span class="op">%%</span>capture</span>
<span id="cb247-2"><a href="#cb247-2" tabindex="-1"></a><span class="cf">if</span> <span class="st">&#39;google.colab&#39;</span> <span class="kw">in</span> <span class="bu">str</span>(get_ipython()):</span>
<span id="cb247-3"><a href="#cb247-3" tabindex="-1"></a>  <span class="op">!</span>pip install cartopy rioxarray</span></code></pre></div>
<div class="sourceCode" id="cb248"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb248-1"><a href="#cb248-1" tabindex="-1"></a><span class="im">import</span> cartopy</span>
<span id="cb248-2"><a href="#cb248-2" tabindex="-1"></a><span class="im">import</span> cartopy.crs <span class="im">as</span> ccrs</span>
<span id="cb248-3"><a href="#cb248-3" tabindex="-1"></a><span class="im">import</span> geopandas <span class="im">as</span> gpd</span>
<span id="cb248-4"><a href="#cb248-4" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb248-5"><a href="#cb248-5" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb248-6"><a href="#cb248-6" tabindex="-1"></a><span class="im">import</span> requests</span>
<span id="cb248-7"><a href="#cb248-7" tabindex="-1"></a><span class="im">import</span> rioxarray <span class="im">as</span> rxr</span>
<span id="cb248-8"><a href="#cb248-8" tabindex="-1"></a><span class="im">import</span> shapely</span>
<span id="cb248-9"><a href="#cb248-9" tabindex="-1"></a><span class="im">import</span> zipfile</span></code></pre></div>
<div class="sourceCode" id="cb249"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb249-1"><a href="#cb249-1" tabindex="-1"></a>data_folder <span class="op">=</span> <span class="st">&#39;data&#39;</span></span>
<span id="cb249-2"><a href="#cb249-2" tabindex="-1"></a>output_folder <span class="op">=</span> <span class="st">&#39;output&#39;</span></span>
<span id="cb249-3"><a href="#cb249-3" tabindex="-1"></a></span>
<span id="cb249-4"><a href="#cb249-4" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> os.path.exists(data_folder):</span>
<span id="cb249-5"><a href="#cb249-5" tabindex="-1"></a>    os.mkdir(data_folder)</span>
<span id="cb249-6"><a href="#cb249-6" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> os.path.exists(output_folder):</span>
<span id="cb249-7"><a href="#cb249-7" tabindex="-1"></a>    os.mkdir(output_folder)</span></code></pre></div>
<div class="sourceCode" id="cb250"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb250-1"><a href="#cb250-1" tabindex="-1"></a><span class="kw">def</span> download(url):</span>
<span id="cb250-2"><a href="#cb250-2" tabindex="-1"></a>    filename <span class="op">=</span> os.path.join(data_folder, os.path.basename(url))</span>
<span id="cb250-3"><a href="#cb250-3" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> os.path.exists(filename):</span>
<span id="cb250-4"><a href="#cb250-4" tabindex="-1"></a>      <span class="cf">with</span> requests.get(url, stream<span class="op">=</span><span class="va">True</span>, allow_redirects<span class="op">=</span><span class="va">True</span>) <span class="im">as</span> r:</span>
<span id="cb250-5"><a href="#cb250-5" tabindex="-1"></a>          <span class="cf">with</span> <span class="bu">open</span>(filename, <span class="st">&#39;wb&#39;</span>) <span class="im">as</span> f:</span>
<span id="cb250-6"><a href="#cb250-6" tabindex="-1"></a>              <span class="cf">for</span> chunk <span class="kw">in</span> r.iter_content(chunk_size<span class="op">=</span><span class="dv">8192</span>):</span>
<span id="cb250-7"><a href="#cb250-7" tabindex="-1"></a>                  f.write(chunk)</span>
<span id="cb250-8"><a href="#cb250-8" tabindex="-1"></a>      <span class="bu">print</span>(<span class="st">&#39;Downloaded&#39;</span>, filename)</span></code></pre></div>
<div class="sourceCode" id="cb251"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb251-1"><a href="#cb251-1" tabindex="-1"></a><span class="co"># Get the eclipse shapefiles</span></span>
<span id="cb251-2"><a href="#cb251-2" tabindex="-1"></a>path_shapefile <span class="op">=</span> <span class="st">&#39;upath17&#39;</span></span>
<span id="cb251-3"><a href="#cb251-3" tabindex="-1"></a>umbra_shapefile <span class="op">=</span> <span class="st">&#39;umbra17&#39;</span></span>
<span id="cb251-4"><a href="#cb251-4" tabindex="-1"></a>penumbra_shapefile <span class="op">=</span> <span class="st">&#39;penum17&#39;</span></span>
<span id="cb251-5"><a href="#cb251-5" tabindex="-1"></a></span>
<span id="cb251-6"><a href="#cb251-6" tabindex="-1"></a>shapefile_exts <span class="op">=</span> [<span class="st">&#39;.shp&#39;</span>, <span class="st">&#39;.shx&#39;</span>, <span class="st">&#39;.dbf&#39;</span>, <span class="st">&#39;.prj&#39;</span>]</span>
<span id="cb251-7"><a href="#cb251-7" tabindex="-1"></a>data_url <span class="op">=</span> <span class="st">&#39;https://github.com/spatialthoughts/python-dataviz-web/releases/&#39;</span> \</span>
<span id="cb251-8"><a href="#cb251-8" tabindex="-1"></a>  <span class="st">&#39;download/eclipse/&#39;</span></span>
<span id="cb251-9"><a href="#cb251-9" tabindex="-1"></a></span>
<span id="cb251-10"><a href="#cb251-10" tabindex="-1"></a><span class="cf">for</span> shapefile <span class="kw">in</span> [path_shapefile, umbra_shapefile, penumbra_shapefile]:</span>
<span id="cb251-11"><a href="#cb251-11" tabindex="-1"></a>  <span class="cf">for</span> ext <span class="kw">in</span> shapefile_exts:</span>
<span id="cb251-12"><a href="#cb251-12" tabindex="-1"></a>    url <span class="op">=</span> data_url <span class="op">+</span> shapefile <span class="op">+</span> ext</span>
<span id="cb251-13"><a href="#cb251-13" tabindex="-1"></a>    download(url)</span>
<span id="cb251-14"><a href="#cb251-14" tabindex="-1"></a></span>
<span id="cb251-15"><a href="#cb251-15" tabindex="-1"></a><span class="co"># Get the Blue Marble basemap image</span></span>
<span id="cb251-16"><a href="#cb251-16" tabindex="-1"></a>data_url <span class="op">=</span> <span class="st">&#39;https://github.com/spatialthoughts/python-dataviz-web/releases/&#39;</span> \</span>
<span id="cb251-17"><a href="#cb251-17" tabindex="-1"></a>  <span class="st">&#39;download/bluemarble/&#39;</span></span>
<span id="cb251-18"><a href="#cb251-18" tabindex="-1"></a>basemap_file <span class="op">=</span> <span class="st">&#39;eo_base_2020_clean_geo_resampled.tif&#39;</span></span>
<span id="cb251-19"><a href="#cb251-19" tabindex="-1"></a>download(data_url <span class="op">+</span> basemap_file)</span></code></pre></div>
</div>
<div id="data-pre-processing-6" class="section level4">
<h4>Data Pre-Processing</h4>
<div class="sourceCode" id="cb252"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb252-1"><a href="#cb252-1" tabindex="-1"></a>path_shapefile_path <span class="op">=</span> os.path.join(</span>
<span id="cb252-2"><a href="#cb252-2" tabindex="-1"></a>    data_folder, path_shapefile <span class="op">+</span> <span class="st">&#39;.shp&#39;</span>)</span>
<span id="cb252-3"><a href="#cb252-3" tabindex="-1"></a>umbra_shapefile_path <span class="op">=</span> os.path.join(</span>
<span id="cb252-4"><a href="#cb252-4" tabindex="-1"></a>    data_folder, umbra_shapefile <span class="op">+</span> <span class="st">&#39;.shp&#39;</span>)</span>
<span id="cb252-5"><a href="#cb252-5" tabindex="-1"></a>penumbra_shapefile_path <span class="op">=</span> os.path.join(</span>
<span id="cb252-6"><a href="#cb252-6" tabindex="-1"></a>    data_folder, penumbra_shapefile <span class="op">+</span> <span class="st">&#39;.shp&#39;</span>)</span>
<span id="cb252-7"><a href="#cb252-7" tabindex="-1"></a></span>
<span id="cb252-8"><a href="#cb252-8" tabindex="-1"></a>path_gdf <span class="op">=</span> gpd.read_file(path_shapefile_path)</span>
<span id="cb252-9"><a href="#cb252-9" tabindex="-1"></a>umbra_gdf <span class="op">=</span> gpd.read_file(umbra_shapefile_path)</span>
<span id="cb252-10"><a href="#cb252-10" tabindex="-1"></a>penumbra_gdf <span class="op">=</span> gpd.read_file(penumbra_shapefile_path)</span></code></pre></div>
<p>Choose a Orthographic Projection centered on the continental USA.
Convert the CartoPy projection to a GeoPandas projection and reproject
the data layers.</p>
<div class="sourceCode" id="cb253"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb253-1"><a href="#cb253-1" tabindex="-1"></a>cartopy_crs <span class="op">=</span> ccrs.Orthographic(<span class="op">-</span><span class="dv">100</span>, <span class="dv">45</span>)</span>
<span id="cb253-2"><a href="#cb253-2" tabindex="-1"></a>crs<span class="op">=</span> cartopy_crs.proj4_init</span>
<span id="cb253-3"><a href="#cb253-3" tabindex="-1"></a></span>
<span id="cb253-4"><a href="#cb253-4" tabindex="-1"></a><span class="co"># Reproject using GeoPandas</span></span>
<span id="cb253-5"><a href="#cb253-5" tabindex="-1"></a><span class="co"># CartoPy reprojection on-the-fly while plotting results in artifacts</span></span>
<span id="cb253-6"><a href="#cb253-6" tabindex="-1"></a>penumbra_gdf_reprojected <span class="op">=</span> penumbra_gdf.to_crs(crs)</span>
<span id="cb253-7"><a href="#cb253-7" tabindex="-1"></a>umbra_gdf_reprojected <span class="op">=</span> umbra_gdf.to_crs(crs)</span>
<span id="cb253-8"><a href="#cb253-8" tabindex="-1"></a>path_gdf_reprojected <span class="op">=</span> path_gdf.to_crs(crs)</span></code></pre></div>
<p>Read the Blue Marble basemap image</p>
<div class="sourceCode" id="cb254"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb254-1"><a href="#cb254-1" tabindex="-1"></a>basemapth_path <span class="op">=</span> os.path.join(data_folder, basemap_file)</span>
<span id="cb254-2"><a href="#cb254-2" tabindex="-1"></a>basemap_ds <span class="op">=</span> rxr.open_rasterio(basemapth_path)</span></code></pre></div>
</div>
<div id="create-a-globe-visualization" class="section level4">
<h4>Create a Globe Visualization</h4>
<div class="sourceCode" id="cb255"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb255-1"><a href="#cb255-1" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">1</span>, subplot_kw<span class="op">=</span>{<span class="st">&#39;projection&#39;</span>: cartopy_crs})</span>
<span id="cb255-2"><a href="#cb255-2" tabindex="-1"></a>fig.set_size_inches(<span class="dv">8</span>, <span class="dv">8</span>)</span>
<span id="cb255-3"><a href="#cb255-3" tabindex="-1"></a></span>
<span id="cb255-4"><a href="#cb255-4" tabindex="-1"></a><span class="co"># Plot the basemap</span></span>
<span id="cb255-5"><a href="#cb255-5" tabindex="-1"></a>basemap_ds.plot.imshow(</span>
<span id="cb255-6"><a href="#cb255-6" tabindex="-1"></a>    ax<span class="op">=</span>ax,</span>
<span id="cb255-7"><a href="#cb255-7" tabindex="-1"></a>    transform<span class="op">=</span>ccrs.PlateCarree(),</span>
<span id="cb255-8"><a href="#cb255-8" tabindex="-1"></a>    robust<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb255-9"><a href="#cb255-9" tabindex="-1"></a></span>
<span id="cb255-10"><a href="#cb255-10" tabindex="-1"></a><span class="co"># Plot the DataFrames</span></span>
<span id="cb255-11"><a href="#cb255-11" tabindex="-1"></a></span>
<span id="cb255-12"><a href="#cb255-12" tabindex="-1"></a><span class="co"># Plot penumbra shadows with just fills</span></span>
<span id="cb255-13"><a href="#cb255-13" tabindex="-1"></a>penumbra_gdf_reprojected.plot(</span>
<span id="cb255-14"><a href="#cb255-14" tabindex="-1"></a>    ax<span class="op">=</span>ax,</span>
<span id="cb255-15"><a href="#cb255-15" tabindex="-1"></a>    column<span class="op">=</span><span class="st">&#39;Obscur&#39;</span>,</span>
<span id="cb255-16"><a href="#cb255-16" tabindex="-1"></a>    cmap<span class="op">=</span><span class="st">&#39;Greys&#39;</span>,</span>
<span id="cb255-17"><a href="#cb255-17" tabindex="-1"></a>    edgecolor<span class="op">=</span><span class="st">&#39;none&#39;</span>,</span>
<span id="cb255-18"><a href="#cb255-18" tabindex="-1"></a>    alpha<span class="op">=</span><span class="fl">0.2</span></span>
<span id="cb255-19"><a href="#cb255-19" tabindex="-1"></a>)</span>
<span id="cb255-20"><a href="#cb255-20" tabindex="-1"></a></span>
<span id="cb255-21"><a href="#cb255-21" tabindex="-1"></a><span class="co"># Plot penumbra shadows with outlines</span></span>
<span id="cb255-22"><a href="#cb255-22" tabindex="-1"></a>penumbra_gdf_reprojected.plot(</span>
<span id="cb255-23"><a href="#cb255-23" tabindex="-1"></a>    ax<span class="op">=</span>ax,</span>
<span id="cb255-24"><a href="#cb255-24" tabindex="-1"></a>    column<span class="op">=</span><span class="st">&#39;Obscur&#39;</span>,</span>
<span id="cb255-25"><a href="#cb255-25" tabindex="-1"></a>    cmap<span class="op">=</span><span class="st">&#39;Greys&#39;</span>,</span>
<span id="cb255-26"><a href="#cb255-26" tabindex="-1"></a>    linewidth<span class="op">=</span><span class="dv">1</span>,</span>
<span id="cb255-27"><a href="#cb255-27" tabindex="-1"></a>    facecolor<span class="op">=</span><span class="st">&#39;none&#39;</span>,</span>
<span id="cb255-28"><a href="#cb255-28" tabindex="-1"></a>    alpha<span class="op">=</span><span class="fl">0.5</span></span>
<span id="cb255-29"><a href="#cb255-29" tabindex="-1"></a>)</span>
<span id="cb255-30"><a href="#cb255-30" tabindex="-1"></a></span>
<span id="cb255-31"><a href="#cb255-31" tabindex="-1"></a>path_gdf_reprojected.to_crs(crs).plot(</span>
<span id="cb255-32"><a href="#cb255-32" tabindex="-1"></a>    ax<span class="op">=</span>ax,</span>
<span id="cb255-33"><a href="#cb255-33" tabindex="-1"></a>    facecolor<span class="op">=</span><span class="st">&#39;#636363&#39;</span>,</span>
<span id="cb255-34"><a href="#cb255-34" tabindex="-1"></a>    edgecolor<span class="op">=</span><span class="st">&#39;none&#39;</span>,</span>
<span id="cb255-35"><a href="#cb255-35" tabindex="-1"></a>    alpha<span class="op">=</span><span class="fl">0.5</span>,</span>
<span id="cb255-36"><a href="#cb255-36" tabindex="-1"></a>)</span>
<span id="cb255-37"><a href="#cb255-37" tabindex="-1"></a></span>
<span id="cb255-38"><a href="#cb255-38" tabindex="-1"></a>umbra_gdf_reprojected.to_crs(crs).plot(</span>
<span id="cb255-39"><a href="#cb255-39" tabindex="-1"></a>    ax<span class="op">=</span>ax,</span>
<span id="cb255-40"><a href="#cb255-40" tabindex="-1"></a>    facecolor<span class="op">=</span><span class="st">&#39;#252525&#39;</span>,</span>
<span id="cb255-41"><a href="#cb255-41" tabindex="-1"></a>    edgecolor<span class="op">=</span><span class="st">&#39;none&#39;</span>)</span>
<span id="cb255-42"><a href="#cb255-42" tabindex="-1"></a></span>
<span id="cb255-43"><a href="#cb255-43" tabindex="-1"></a></span>
<span id="cb255-44"><a href="#cb255-44" tabindex="-1"></a>plt.title(<span class="st">&#39;2017 Total Solar Eclipse Path&#39;</span>, fontsize<span class="op">=</span><span class="dv">14</span>)</span>
<span id="cb255-45"><a href="#cb255-45" tabindex="-1"></a></span>
<span id="cb255-46"><a href="#cb255-46" tabindex="-1"></a>plt.show()</span></code></pre></div>
<p><img
src="python-dataviz-output/supplement_eclipse_globe_files/supplement_eclipse_globe_15_0.png" /></p>
<p><a
href="https://colab.research.google.com/github/spatialthoughts/python-dataviz-web/blob/main/supplement_monthly_composites.ipynb"><img
src="https://colab.research.google.com/assets/colab-badge.svg"
alt="Open In Colab" /></a></p>
</div>
</div>
<div id="visualizing-monthly-composites" class="section level3">
<h3>Visualizing Monthly Composites</h3>
<p>This notebook shows how to aggregate a time-series of satellite
imagery to monthly median composites and visualize them in a grid.</p>
<div id="setup-and-data-download-13" class="section level4">
<h4>Setup and Data Download</h4>
<p>The following blocks of code will install the required packages and
download the datasets to your Colab environment.</p>
<div class="sourceCode" id="cb256"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb256-1"><a href="#cb256-1" tabindex="-1"></a><span class="op">%%</span>capture</span>
<span id="cb256-2"><a href="#cb256-2" tabindex="-1"></a><span class="cf">if</span> <span class="st">&#39;google.colab&#39;</span> <span class="kw">in</span> <span class="bu">str</span>(get_ipython()):</span>
<span id="cb256-3"><a href="#cb256-3" tabindex="-1"></a>    <span class="op">!</span>pip install pystac<span class="op">-</span>client odc<span class="op">-</span>stac rioxarray dask</span></code></pre></div>
<div class="sourceCode" id="cb257"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb257-1"><a href="#cb257-1" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb257-2"><a href="#cb257-2" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb257-3"><a href="#cb257-3" tabindex="-1"></a><span class="im">import</span> pystac_client</span>
<span id="cb257-4"><a href="#cb257-4" tabindex="-1"></a><span class="im">from</span> odc.stac <span class="im">import</span> stac_load</span>
<span id="cb257-5"><a href="#cb257-5" tabindex="-1"></a><span class="im">import</span> xarray <span class="im">as</span> xr</span>
<span id="cb257-6"><a href="#cb257-6" tabindex="-1"></a><span class="im">import</span> rioxarray <span class="im">as</span> rxr</span></code></pre></div>
<div class="sourceCode" id="cb258"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb258-1"><a href="#cb258-1" tabindex="-1"></a>data_folder <span class="op">=</span> <span class="st">&#39;data&#39;</span></span>
<span id="cb258-2"><a href="#cb258-2" tabindex="-1"></a>output_folder <span class="op">=</span> <span class="st">&#39;output&#39;</span></span>
<span id="cb258-3"><a href="#cb258-3" tabindex="-1"></a></span>
<span id="cb258-4"><a href="#cb258-4" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> os.path.exists(data_folder):</span>
<span id="cb258-5"><a href="#cb258-5" tabindex="-1"></a>    os.mkdir(data_folder)</span>
<span id="cb258-6"><a href="#cb258-6" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> os.path.exists(output_folder):</span>
<span id="cb258-7"><a href="#cb258-7" tabindex="-1"></a>    os.mkdir(output_folder)</span></code></pre></div>
</div>
<div id="get-satellite-imagery-using-stac-api-1" class="section level4">
<h4>Get Satellite Imagery using STAC API</h4>
<p>We define a location and time of interest to get some satellite
imagery.</p>
<div class="sourceCode" id="cb259"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb259-1"><a href="#cb259-1" tabindex="-1"></a>latitude <span class="op">=</span> <span class="fl">27.163</span></span>
<span id="cb259-2"><a href="#cb259-2" tabindex="-1"></a>longitude <span class="op">=</span> <span class="fl">82.608</span></span>
<span id="cb259-3"><a href="#cb259-3" tabindex="-1"></a>year <span class="op">=</span> <span class="dv">2023</span></span></code></pre></div>
<p>Let’s use Element84 search endpoint to look for items from the
sentinel-2-l2a collection on AWS.</p>
<div class="sourceCode" id="cb260"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb260-1"><a href="#cb260-1" tabindex="-1"></a>catalog <span class="op">=</span> pystac_client.Client.<span class="bu">open</span>(</span>
<span id="cb260-2"><a href="#cb260-2" tabindex="-1"></a>    <span class="st">&#39;https://earth-search.aws.element84.com/v1&#39;</span>)</span>
<span id="cb260-3"><a href="#cb260-3" tabindex="-1"></a></span>
<span id="cb260-4"><a href="#cb260-4" tabindex="-1"></a><span class="co"># Define a small bounding box around the chosen point</span></span>
<span id="cb260-5"><a href="#cb260-5" tabindex="-1"></a>km2deg <span class="op">=</span> <span class="fl">1.0</span> <span class="op">/</span> <span class="dv">111</span></span>
<span id="cb260-6"><a href="#cb260-6" tabindex="-1"></a>x, y <span class="op">=</span> (longitude, latitude)</span>
<span id="cb260-7"><a href="#cb260-7" tabindex="-1"></a>r <span class="op">=</span> <span class="dv">1</span> <span class="op">*</span> km2deg  <span class="co"># radius in degrees</span></span>
<span id="cb260-8"><a href="#cb260-8" tabindex="-1"></a>bbox <span class="op">=</span> (x <span class="op">-</span> r, y <span class="op">-</span> r, x <span class="op">+</span> r, y <span class="op">+</span> r)</span>
<span id="cb260-9"><a href="#cb260-9" tabindex="-1"></a></span>
<span id="cb260-10"><a href="#cb260-10" tabindex="-1"></a>search <span class="op">=</span> catalog.search(</span>
<span id="cb260-11"><a href="#cb260-11" tabindex="-1"></a>    collections<span class="op">=</span>[<span class="st">&#39;sentinel-2-c1-l2a&#39;</span>],</span>
<span id="cb260-12"><a href="#cb260-12" tabindex="-1"></a>    bbox<span class="op">=</span>bbox,</span>
<span id="cb260-13"><a href="#cb260-13" tabindex="-1"></a>    datetime<span class="op">=</span><span class="ss">f&#39;</span><span class="sc">{</span>year<span class="sc">}</span><span class="ss">&#39;</span>,</span>
<span id="cb260-14"><a href="#cb260-14" tabindex="-1"></a>    query<span class="op">=</span>{<span class="st">&#39;eo:cloud_cover&#39;</span>: {<span class="st">&#39;lt&#39;</span>: <span class="dv">30</span>}},</span>
<span id="cb260-15"><a href="#cb260-15" tabindex="-1"></a>)</span>
<span id="cb260-16"><a href="#cb260-16" tabindex="-1"></a>items <span class="op">=</span> search.item_collection()</span></code></pre></div>
<p>Load the matching images as a XArray Dataset.</p>
<div class="sourceCode" id="cb261"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb261-1"><a href="#cb261-1" tabindex="-1"></a>ds <span class="op">=</span> stac_load(</span>
<span id="cb261-2"><a href="#cb261-2" tabindex="-1"></a>    items,</span>
<span id="cb261-3"><a href="#cb261-3" tabindex="-1"></a>    bands<span class="op">=</span>[<span class="st">&#39;red&#39;</span>, <span class="st">&#39;green&#39;</span>, <span class="st">&#39;blue&#39;</span>, <span class="st">&#39;nir&#39;</span>],</span>
<span id="cb261-4"><a href="#cb261-4" tabindex="-1"></a>    resolution<span class="op">=</span><span class="dv">10</span>,</span>
<span id="cb261-5"><a href="#cb261-5" tabindex="-1"></a>    bbox<span class="op">=</span>bbox,</span>
<span id="cb261-6"><a href="#cb261-6" tabindex="-1"></a>    chunks<span class="op">=</span>{},  <span class="co"># &lt;-- use Dask</span></span>
<span id="cb261-7"><a href="#cb261-7" tabindex="-1"></a>    groupby<span class="op">=</span><span class="st">&#39;solar_day&#39;</span>,</span>
<span id="cb261-8"><a href="#cb261-8" tabindex="-1"></a>)</span>
<span id="cb261-9"><a href="#cb261-9" tabindex="-1"></a>ds</span></code></pre></div>
<div class="sourceCode" id="cb262"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb262-1"><a href="#cb262-1" tabindex="-1"></a><span class="op">%%</span>time</span>
<span id="cb262-2"><a href="#cb262-2" tabindex="-1"></a>ds <span class="op">=</span> ds.compute()</span></code></pre></div>
<pre><code>CPU times: user 12.3 s, sys: 24.4 s, total: 36.7 s
Wall time: 1min 31s</code></pre>
</div>
<div id="visualizing-monthly-composites-1" class="section level4">
<h4>Visualizing Monthly Composites</h4>
<p>Aggregate it to a monthly median composites <code>groupby()</code>
method.</p>
<div class="sourceCode" id="cb264"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb264-1"><a href="#cb264-1" tabindex="-1"></a>monthly <span class="op">=</span> ds.groupby(<span class="st">&#39;time.month&#39;</span>).median(dim<span class="op">=</span><span class="st">&#39;time&#39;</span>)</span>
<span id="cb264-2"><a href="#cb264-2" tabindex="-1"></a>monthly</span></code></pre></div>
<p>Using monthly_da to display composites for all months.</p>
<div class="sourceCode" id="cb265"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb265-1"><a href="#cb265-1" tabindex="-1"></a>monthly_da <span class="op">=</span> monthly.to_array(<span class="st">&#39;band&#39;</span>)</span>
<span id="cb265-2"><a href="#cb265-2" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(<span class="dv">4</span>, <span class="dv">3</span>)</span>
<span id="cb265-3"><a href="#cb265-3" tabindex="-1"></a>fig.set_size_inches(<span class="dv">9</span>, <span class="dv">12</span>)</span>
<span id="cb265-4"><a href="#cb265-4" tabindex="-1"></a><span class="cf">for</span> index, ax <span class="kw">in</span> <span class="bu">enumerate</span>(axes.flat):</span>
<span id="cb265-5"><a href="#cb265-5" tabindex="-1"></a>    month_da <span class="op">=</span> monthly_da.isel(month<span class="op">=</span>index)</span>
<span id="cb265-6"><a href="#cb265-6" tabindex="-1"></a>    month_da.sel(band<span class="op">=</span>[<span class="st">&#39;red&#39;</span>, <span class="st">&#39;green&#39;</span>, <span class="st">&#39;blue&#39;</span>]).plot.imshow(</span>
<span id="cb265-7"><a href="#cb265-7" tabindex="-1"></a>      ax<span class="op">=</span>ax,</span>
<span id="cb265-8"><a href="#cb265-8" tabindex="-1"></a>      vmin<span class="op">=</span><span class="dv">0</span>,</span>
<span id="cb265-9"><a href="#cb265-9" tabindex="-1"></a>      vmax<span class="op">=</span><span class="dv">3000</span>)</span>
<span id="cb265-10"><a href="#cb265-10" tabindex="-1"></a>    ax.set_title(<span class="ss">f&#39;</span><span class="sc">{</span>month_da<span class="sc">.</span>month<span class="sc">.</span>values<span class="sc">}</span><span class="ss">&#39;</span>)</span>
<span id="cb265-11"><a href="#cb265-11" tabindex="-1"></a>    ax.set_axis_off()</span>
<span id="cb265-12"><a href="#cb265-12" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb265-13"><a href="#cb265-13" tabindex="-1"></a>plt.show()</span></code></pre></div>
<p><img
src="python-dataviz-output/supplement_monthly_composites_files/supplement_monthly_composites_17_0.png" /></p>
<p><a
href="https://colab.research.google.com/github/spatialthoughts/python-dataviz-web/blob/main/supplement_cartographic_elements.ipynb"><img
src="https://colab.research.google.com/assets/colab-badge.svg"
alt="Open In Colab" /></a></p>
</div>
</div>
<div id="creating-maps-with-cartographic-elements"
class="section level3">
<h3>Creating Maps with Cartographic Elements</h3>
<p>This notebook shows how to use the <a
href="https://eomaps.readthedocs.io/en/latest/index.html">EOMaps</a>
library to create maps with cartographic elements such as north arrow,
scalebar and gridlines.</p>
<div id="setup-and-data-download-14" class="section level4">
<h4>Setup and Data Download</h4>
<p>The following blocks of code will install the required packages and
download the datasets to your Colab environment.</p>
<div class="sourceCode" id="cb266"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb266-1"><a href="#cb266-1" tabindex="-1"></a><span class="op">%%</span>capture</span>
<span id="cb266-2"><a href="#cb266-2" tabindex="-1"></a><span class="cf">if</span> <span class="st">&#39;google.colab&#39;</span> <span class="kw">in</span> <span class="bu">str</span>(get_ipython()):</span>
<span id="cb266-3"><a href="#cb266-3" tabindex="-1"></a>  <span class="op">!</span>pip install eomaps mapclassify</span></code></pre></div>
<div class="sourceCode" id="cb267"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb267-1"><a href="#cb267-1" tabindex="-1"></a><span class="im">from</span> eomaps <span class="im">import</span> Maps</span>
<span id="cb267-2"><a href="#cb267-2" tabindex="-1"></a><span class="im">import</span> geopandas <span class="im">as</span> gpd</span>
<span id="cb267-3"><a href="#cb267-3" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb267-4"><a href="#cb267-4" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb267-5"><a href="#cb267-5" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb267-6"><a href="#cb267-6" tabindex="-1"></a><span class="im">import</span> requests</span></code></pre></div>
<div class="sourceCode" id="cb268"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb268-1"><a href="#cb268-1" tabindex="-1"></a>data_folder <span class="op">=</span> <span class="st">&#39;data&#39;</span></span>
<span id="cb268-2"><a href="#cb268-2" tabindex="-1"></a>output_folder <span class="op">=</span> <span class="st">&#39;output&#39;</span></span>
<span id="cb268-3"><a href="#cb268-3" tabindex="-1"></a></span>
<span id="cb268-4"><a href="#cb268-4" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> os.path.exists(data_folder):</span>
<span id="cb268-5"><a href="#cb268-5" tabindex="-1"></a>    os.mkdir(data_folder)</span>
<span id="cb268-6"><a href="#cb268-6" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> os.path.exists(output_folder):</span>
<span id="cb268-7"><a href="#cb268-7" tabindex="-1"></a>    os.mkdir(output_folder)</span></code></pre></div>
<div class="sourceCode" id="cb269"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb269-1"><a href="#cb269-1" tabindex="-1"></a><span class="kw">def</span> download(url):</span>
<span id="cb269-2"><a href="#cb269-2" tabindex="-1"></a>    filename <span class="op">=</span> os.path.join(data_folder, os.path.basename(url))</span>
<span id="cb269-3"><a href="#cb269-3" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> os.path.exists(filename):</span>
<span id="cb269-4"><a href="#cb269-4" tabindex="-1"></a>      <span class="cf">with</span> requests.get(url, stream<span class="op">=</span><span class="va">True</span>, allow_redirects<span class="op">=</span><span class="va">True</span>) <span class="im">as</span> r:</span>
<span id="cb269-5"><a href="#cb269-5" tabindex="-1"></a>          <span class="cf">with</span> <span class="bu">open</span>(filename, <span class="st">&#39;wb&#39;</span>) <span class="im">as</span> f:</span>
<span id="cb269-6"><a href="#cb269-6" tabindex="-1"></a>              <span class="cf">for</span> chunk <span class="kw">in</span> r.iter_content(chunk_size<span class="op">=</span><span class="dv">8192</span>):</span>
<span id="cb269-7"><a href="#cb269-7" tabindex="-1"></a>                  f.write(chunk)</span>
<span id="cb269-8"><a href="#cb269-8" tabindex="-1"></a>      <span class="bu">print</span>(<span class="st">&#39;Downloaded&#39;</span>, filename)</span></code></pre></div>
<div class="sourceCode" id="cb270"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb270-1"><a href="#cb270-1" tabindex="-1"></a>shapefile_name <span class="op">=</span> <span class="st">&#39;tl_2019_06_tract&#39;</span></span>
<span id="cb270-2"><a href="#cb270-2" tabindex="-1"></a>shapefile_exts <span class="op">=</span> [<span class="st">&#39;.shp&#39;</span>, <span class="st">&#39;.shx&#39;</span>, <span class="st">&#39;.dbf&#39;</span>, <span class="st">&#39;.prj&#39;</span>]</span>
<span id="cb270-3"><a href="#cb270-3" tabindex="-1"></a>data_url <span class="op">=</span> <span class="st">&#39;https://github.com/spatialthoughts/python-dataviz-web/releases/&#39;</span> \</span>
<span id="cb270-4"><a href="#cb270-4" tabindex="-1"></a>  <span class="st">&#39;download/census/&#39;</span></span>
<span id="cb270-5"><a href="#cb270-5" tabindex="-1"></a></span>
<span id="cb270-6"><a href="#cb270-6" tabindex="-1"></a><span class="cf">for</span> ext <span class="kw">in</span> shapefile_exts:</span>
<span id="cb270-7"><a href="#cb270-7" tabindex="-1"></a>  url <span class="op">=</span> data_url <span class="op">+</span> shapefile_name <span class="op">+</span> ext</span>
<span id="cb270-8"><a href="#cb270-8" tabindex="-1"></a>  download(url)</span>
<span id="cb270-9"><a href="#cb270-9" tabindex="-1"></a></span>
<span id="cb270-10"><a href="#cb270-10" tabindex="-1"></a>csv_name <span class="op">=</span> <span class="st">&#39;ACSST5Y2019.S0101_data.csv&#39;</span></span>
<span id="cb270-11"><a href="#cb270-11" tabindex="-1"></a>download(data_url <span class="op">+</span> csv_name)</span></code></pre></div>
</div>
<div id="data-pre-processing-7" class="section level4">
<h4>Data Pre-Processing</h4>
<p>Read the data and perform a table join.</p>
<div class="sourceCode" id="cb271"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb271-1"><a href="#cb271-1" tabindex="-1"></a>shapefile_path <span class="op">=</span> os.path.join(data_folder, shapefile_name <span class="op">+</span> <span class="st">&#39;.shp&#39;</span>)</span>
<span id="cb271-2"><a href="#cb271-2" tabindex="-1"></a>tracts <span class="op">=</span> gpd.read_file(shapefile_path)</span>
<span id="cb271-3"><a href="#cb271-3" tabindex="-1"></a>csv_path <span class="op">=</span> os.path.join(data_folder, csv_name)</span>
<span id="cb271-4"><a href="#cb271-4" tabindex="-1"></a>table <span class="op">=</span> pd.read_csv(csv_path, skiprows<span class="op">=</span>[<span class="dv">1</span>])</span>
<span id="cb271-5"><a href="#cb271-5" tabindex="-1"></a>filtered <span class="op">=</span> table[[<span class="st">&#39;GEO_ID&#39;</span>,<span class="st">&#39;NAME&#39;</span>, <span class="st">&#39;S0101_C01_001E&#39;</span>]]</span>
<span id="cb271-6"><a href="#cb271-6" tabindex="-1"></a>filtered <span class="op">=</span> filtered.rename(columns <span class="op">=</span> {<span class="st">&#39;S0101_C01_001E&#39;</span>: <span class="st">&#39;Population&#39;</span>, <span class="st">&#39;GEO_ID&#39;</span>: <span class="st">&#39;GEOID&#39;</span>})</span>
<span id="cb271-7"><a href="#cb271-7" tabindex="-1"></a>filtered[<span class="st">&#39;GEOID&#39;</span>] <span class="op">=</span> filtered.GEOID.<span class="bu">str</span>[<span class="op">-</span><span class="dv">11</span>:]</span>
<span id="cb271-8"><a href="#cb271-8" tabindex="-1"></a>gdf <span class="op">=</span> tracts.merge(filtered, on<span class="op">=</span><span class="st">&#39;GEOID&#39;</span>)</span>
<span id="cb271-9"><a href="#cb271-9" tabindex="-1"></a>gdf[<span class="st">&#39;density&#39;</span>] <span class="op">=</span> <span class="fl">1e6</span><span class="op">*</span>gdf[<span class="st">&#39;Population&#39;</span>]<span class="op">/</span>gdf[<span class="st">&#39;ALAND&#39;</span>]</span>
<span id="cb271-10"><a href="#cb271-10" tabindex="-1"></a>gdf</span></code></pre></div>
</div>
<div id="create-a-map-using-eomaps" class="section level4">
<h4>Create a Map using EOMaps</h4>
<p>Initialize a map with a CRS.</p>
<p>Reference: <a
href="https://eomaps.readthedocs.io/en/latest/generated/eomaps.eomaps.Maps.html#eomaps.eomaps.Maps"><code>eomaps.Maps()</code></a></p>
<div class="sourceCode" id="cb272"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb272-1"><a href="#cb272-1" tabindex="-1"></a>m <span class="op">=</span> Maps(crs<span class="op">=</span>Maps.CRS.Orthographic(<span class="op">-</span><span class="dv">120</span>, <span class="dv">35</span>), figsize<span class="op">=</span>(<span class="dv">7</span>, <span class="dv">8</span>))</span></code></pre></div>
<p>Set the map extent.</p>
<div class="sourceCode" id="cb273"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb273-1"><a href="#cb273-1" tabindex="-1"></a>xmin, ymin, xmax, ymax <span class="op">=</span> gdf.total_bounds</span>
<span id="cb273-2"><a href="#cb273-2" tabindex="-1"></a><span class="bu">buffer</span> <span class="op">=</span> <span class="fl">0.25</span></span>
<span id="cb273-3"><a href="#cb273-3" tabindex="-1"></a>m.set_extent([xmin<span class="op">-</span><span class="bu">buffer</span>, xmax<span class="op">+</span><span class="bu">buffer</span>, ymin<span class="op">-</span><span class="bu">buffer</span>, ymax<span class="op">+</span><span class="bu">buffer</span>])</span></code></pre></div>
<p>Add the gridlines.</p>
<p>Reference: <a
href="https://eomaps.readthedocs.io/en/latest/generated/eomaps.eomaps.Maps.add_gridlines.html"><code>eomaps.Maps.add_gridlines()</code></a></p>
<div class="sourceCode" id="cb274"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb274-1"><a href="#cb274-1" tabindex="-1"></a>g <span class="op">=</span> m.add_gridlines(<span class="dv">1</span>, lw<span class="op">=</span><span class="fl">0.25</span>, alpha<span class="op">=</span><span class="fl">0.5</span>, zorder<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb274-2"><a href="#cb274-2" tabindex="-1"></a>gl <span class="op">=</span> g.add_labels(fontsize<span class="op">=</span><span class="dv">8</span>, every <span class="op">=</span> <span class="dv">2</span>)</span>
<span id="cb274-3"><a href="#cb274-3" tabindex="-1"></a>m.show()</span></code></pre></div>
<p>Add North Arrow.</p>
<p>Reference: <a
href="https://eomaps.readthedocs.io/en/latest/generated/eomaps.eomaps.Maps.add_compass.html#eomaps.eomaps.Maps.add_compass"><code>eomaps.Maps.add_compass()</code></a></p>
<div class="sourceCode" id="cb275"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb275-1"><a href="#cb275-1" tabindex="-1"></a>c <span class="op">=</span> m.add_compass(style<span class="op">=</span><span class="st">&#39;compass&#39;</span>, pos<span class="op">=</span>(<span class="fl">0.85</span>, <span class="fl">0.9</span>))</span>
<span id="cb275-2"><a href="#cb275-2" tabindex="-1"></a>m.show()</span></code></pre></div>
<p>Add scalebar.</p>
<p>Reference: <a
href="https://eomaps.readthedocs.io/en/latest/generated/eomaps.eomaps.Maps.add_scalebar.html"><code>eomaps.Maps.add_scalebar()</code></a></p>
<div class="sourceCode" id="cb276"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb276-1"><a href="#cb276-1" tabindex="-1"></a>s <span class="op">=</span> m.add_scalebar(</span>
<span id="cb276-2"><a href="#cb276-2" tabindex="-1"></a>    n<span class="op">=</span><span class="dv">4</span>,</span>
<span id="cb276-3"><a href="#cb276-3" tabindex="-1"></a>    scale<span class="op">=</span><span class="dv">50000</span>,</span>
<span id="cb276-4"><a href="#cb276-4" tabindex="-1"></a>    auto_position<span class="op">=</span>(<span class="fl">0.05</span>,<span class="fl">0.08</span>),</span>
<span id="cb276-5"><a href="#cb276-5" tabindex="-1"></a>    preset<span class="op">=</span><span class="st">&#39;bw&#39;</span>,</span>
<span id="cb276-6"><a href="#cb276-6" tabindex="-1"></a>    rotation<span class="op">=</span><span class="dv">90</span>,</span>
<span id="cb276-7"><a href="#cb276-7" tabindex="-1"></a>    label_props<span class="op">=</span>{<span class="st">&#39;rotation&#39;</span>:<span class="dv">90</span>, <span class="st">&#39;offset&#39;</span>:<span class="fl">1.5</span>, <span class="st">&#39;weight&#39;</span>:<span class="fl">0.5</span>},</span>
<span id="cb276-8"><a href="#cb276-8" tabindex="-1"></a>    scale_props<span class="op">=</span>{<span class="st">&#39;colors&#39;</span>: (<span class="st">&#39;k&#39;</span>,<span class="st">&#39;#bdbdbd&#39;</span>,<span class="st">&#39;k&#39;</span>,<span class="st">&#39;#bdbdbd&#39;</span>,<span class="st">&#39;k&#39;</span>)},</span>
<span id="cb276-9"><a href="#cb276-9" tabindex="-1"></a>    line_props<span class="op">=</span>{<span class="st">&#39;lw&#39;</span>:<span class="dv">0</span>, <span class="st">&#39;ls&#39;</span>: <span class="st">&#39;solid&#39;</span>}</span>
<span id="cb276-10"><a href="#cb276-10" tabindex="-1"></a>)</span>
<span id="cb276-11"><a href="#cb276-11" tabindex="-1"></a>m.show()</span></code></pre></div>
<p>Plot the GeoDataFrame.</p>
<div class="sourceCode" id="cb277"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb277-1"><a href="#cb277-1" tabindex="-1"></a>legend_kwds<span class="op">=</span> {</span>
<span id="cb277-2"><a href="#cb277-2" tabindex="-1"></a>  <span class="st">&#39;loc&#39;</span>: <span class="st">&#39;upper right&#39;</span>,</span>
<span id="cb277-3"><a href="#cb277-3" tabindex="-1"></a>  <span class="st">&#39;bbox_to_anchor&#39;</span>: (<span class="fl">0.97</span>, <span class="fl">0.80</span>),</span>
<span id="cb277-4"><a href="#cb277-4" tabindex="-1"></a>  <span class="st">&#39;fmt&#39;</span>: <span class="st">&#39;</span><span class="sc">{:&lt;5.0f}</span><span class="st">&#39;</span>,</span>
<span id="cb277-5"><a href="#cb277-5" tabindex="-1"></a>  <span class="st">&#39;frameon&#39;</span>: <span class="va">True</span>,</span>
<span id="cb277-6"><a href="#cb277-6" tabindex="-1"></a>  <span class="st">&#39;fontsize&#39;</span>: <span class="dv">8</span>,</span>
<span id="cb277-7"><a href="#cb277-7" tabindex="-1"></a>  <span class="st">&#39;title&#39;</span>: <span class="st">&#39;persons/sq.km.&#39;</span></span>
<span id="cb277-8"><a href="#cb277-8" tabindex="-1"></a>}</span>
<span id="cb277-9"><a href="#cb277-9" tabindex="-1"></a>classification_kwds<span class="op">=</span>{</span>
<span id="cb277-10"><a href="#cb277-10" tabindex="-1"></a>  <span class="st">&#39;bins&#39;</span>:[<span class="dv">1</span>,<span class="dv">10</span>,<span class="dv">25</span>,<span class="dv">50</span>,<span class="dv">100</span>, <span class="dv">250</span>, <span class="dv">500</span>, <span class="dv">1000</span>, <span class="dv">5000</span>]</span>
<span id="cb277-11"><a href="#cb277-11" tabindex="-1"></a>}</span>
<span id="cb277-12"><a href="#cb277-12" tabindex="-1"></a></span>
<span id="cb277-13"><a href="#cb277-13" tabindex="-1"></a>m.add_gdf(gdf, column<span class="op">=</span><span class="st">&#39;density&#39;</span>, cmap<span class="op">=</span><span class="st">&#39;RdYlGn_r&#39;</span>, scheme<span class="op">=</span><span class="st">&#39;User_Defined&#39;</span>,</span>
<span id="cb277-14"><a href="#cb277-14" tabindex="-1"></a>          classification_kwds<span class="op">=</span>classification_kwds,</span>
<span id="cb277-15"><a href="#cb277-15" tabindex="-1"></a>          legend<span class="op">=</span><span class="va">True</span>, legend_kwds<span class="op">=</span>legend_kwds)</span>
<span id="cb277-16"><a href="#cb277-16" tabindex="-1"></a></span>
<span id="cb277-17"><a href="#cb277-17" tabindex="-1"></a><span class="co"># Change the last entry in the legend to &#39;&gt;5000&#39;</span></span>
<span id="cb277-18"><a href="#cb277-18" tabindex="-1"></a>m.ax.get_legend().texts[<span class="op">-</span><span class="dv">1</span>].set_text(<span class="st">&#39;&gt; 5000&#39;</span>)</span>
<span id="cb277-19"><a href="#cb277-19" tabindex="-1"></a>m.add_title(<span class="st">&#39;California Population Density (2019)&#39;</span>, y<span class="op">=</span><span class="fl">0.97</span>)</span>
<span id="cb277-20"><a href="#cb277-20" tabindex="-1"></a></span>
<span id="cb277-21"><a href="#cb277-21" tabindex="-1"></a>m.show()</span></code></pre></div>
<p><img
src="python-dataviz-output/supplement_cartographic_elements_files/supplement_cartographic_elements_22_0.png" /></p>
<pre><code>&lt;Figure size 640x480 with 0 Axes&gt;</code></pre>
<p>Save the map.</p>
<div class="sourceCode" id="cb279"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb279-1"><a href="#cb279-1" tabindex="-1"></a>output_folder <span class="op">=</span> <span class="st">&#39;output&#39;</span></span>
<span id="cb279-2"><a href="#cb279-2" tabindex="-1"></a>output_path <span class="op">=</span> os.path.join(output_folder, <span class="st">&#39;map.png&#39;</span>)</span>
<span id="cb279-3"><a href="#cb279-3" tabindex="-1"></a>m.savefig(output_path, dpi<span class="op">=</span><span class="dv">200</span>)</span></code></pre></div>
<p><a
href="https://colab.research.google.com/github/spatialthoughts/python-dataviz-web/blob/main/supplement_labeling_features.ipynb"><img
src="https://colab.research.google.com/assets/colab-badge.svg"
alt="Open In Colab" /></a></p>
</div>
</div>
<div id="labeling-features" class="section level3">
<h3>Labeling Features</h3>
<p>This example shows how to add labels to vector layer features using
Matplotlib. We will take a polygon layer of districts and add an
annotation to show the district name at the centroid of each
polygon.</p>
<div id="setup-and-data-download-15" class="section level4">
<h4>Setup and Data Download</h4>
<div class="sourceCode" id="cb280"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb280-1"><a href="#cb280-1" tabindex="-1"></a><span class="op">%%</span>capture</span>
<span id="cb280-2"><a href="#cb280-2" tabindex="-1"></a><span class="cf">if</span> <span class="st">&#39;google.colab&#39;</span> <span class="kw">in</span> <span class="bu">str</span>(get_ipython()):</span>
<span id="cb280-3"><a href="#cb280-3" tabindex="-1"></a>  <span class="op">!</span>pip install mapclassify</span></code></pre></div>
<div class="sourceCode" id="cb281"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb281-1"><a href="#cb281-1" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb281-2"><a href="#cb281-2" tabindex="-1"></a><span class="im">import</span> geopandas <span class="im">as</span> gpd</span>
<span id="cb281-3"><a href="#cb281-3" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb281-4"><a href="#cb281-4" tabindex="-1"></a><span class="im">import</span> requests</span></code></pre></div>
<div class="sourceCode" id="cb282"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb282-1"><a href="#cb282-1" tabindex="-1"></a>data_folder <span class="op">=</span> <span class="st">&#39;data&#39;</span></span>
<span id="cb282-2"><a href="#cb282-2" tabindex="-1"></a>output_folder <span class="op">=</span> <span class="st">&#39;output&#39;</span></span>
<span id="cb282-3"><a href="#cb282-3" tabindex="-1"></a></span>
<span id="cb282-4"><a href="#cb282-4" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> os.path.exists(data_folder):</span>
<span id="cb282-5"><a href="#cb282-5" tabindex="-1"></a>    os.mkdir(data_folder)</span>
<span id="cb282-6"><a href="#cb282-6" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> os.path.exists(output_folder):</span>
<span id="cb282-7"><a href="#cb282-7" tabindex="-1"></a>    os.mkdir(output_folder)</span></code></pre></div>
<div class="sourceCode" id="cb283"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb283-1"><a href="#cb283-1" tabindex="-1"></a><span class="kw">def</span> download(url):</span>
<span id="cb283-2"><a href="#cb283-2" tabindex="-1"></a>    filename <span class="op">=</span> os.path.join(data_folder, os.path.basename(url))</span>
<span id="cb283-3"><a href="#cb283-3" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> os.path.exists(filename):</span>
<span id="cb283-4"><a href="#cb283-4" tabindex="-1"></a>      <span class="cf">with</span> requests.get(url, stream<span class="op">=</span><span class="va">True</span>, allow_redirects<span class="op">=</span><span class="va">True</span>) <span class="im">as</span> r:</span>
<span id="cb283-5"><a href="#cb283-5" tabindex="-1"></a>          <span class="cf">with</span> <span class="bu">open</span>(filename, <span class="st">&#39;wb&#39;</span>) <span class="im">as</span> f:</span>
<span id="cb283-6"><a href="#cb283-6" tabindex="-1"></a>              <span class="cf">for</span> chunk <span class="kw">in</span> r.iter_content(chunk_size<span class="op">=</span><span class="dv">8192</span>):</span>
<span id="cb283-7"><a href="#cb283-7" tabindex="-1"></a>                  f.write(chunk)</span>
<span id="cb283-8"><a href="#cb283-8" tabindex="-1"></a>      <span class="bu">print</span>(<span class="st">&#39;Downloaded&#39;</span>, filename)</span></code></pre></div>
<div class="sourceCode" id="cb284"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb284-1"><a href="#cb284-1" tabindex="-1"></a>filename <span class="op">=</span> <span class="st">&#39;karnataka.gpkg&#39;</span></span>
<span id="cb284-2"><a href="#cb284-2" tabindex="-1"></a>data_url <span class="op">=</span> <span class="st">&#39;https://github.com/spatialthoughts/python-dataviz-web/releases/&#39;</span> \</span>
<span id="cb284-3"><a href="#cb284-3" tabindex="-1"></a>  <span class="st">&#39;download/bangalore/&#39;</span></span>
<span id="cb284-4"><a href="#cb284-4" tabindex="-1"></a>download(data_url <span class="op">+</span> filename)</span></code></pre></div>
</div>
<div id="data-pre-processing-8" class="section level4">
<h4>Data Pre-Processing</h4>
<p>We read the <code>districts</code> layer from the input geopackage
using GeoPandas.</p>
<div class="sourceCode" id="cb285"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb285-1"><a href="#cb285-1" tabindex="-1"></a>path <span class="op">=</span> os.path.join(data_folder, filename)</span>
<span id="cb285-2"><a href="#cb285-2" tabindex="-1"></a>districts_gdf <span class="op">=</span> gpd.read_file(path, layer<span class="op">=</span><span class="st">&#39;karnataka_districts&#39;</span>)</span></code></pre></div>
<p>Let’s say we want to add a label for each of the distrit polygons.
First, we need to decide the anchor position of the label. We can use
<code>representative_point()</code> to get a point inside each polygon
that best represents the geometry. It is similar to a centroid, but is
guranteed to be inside the polygon. Below code creates a new field in
the GeoDataFrame called <code>label_position</code> with the coordinates
of the anchor point.</p>
<div class="sourceCode" id="cb286"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb286-1"><a href="#cb286-1" tabindex="-1"></a><span class="kw">def</span> get_label_position(row):</span>
<span id="cb286-2"><a href="#cb286-2" tabindex="-1"></a>  geometry <span class="op">=</span> row[<span class="st">&#39;geometry&#39;</span>]</span>
<span id="cb286-3"><a href="#cb286-3" tabindex="-1"></a>  location <span class="op">=</span> geometry.representative_point()</span>
<span id="cb286-4"><a href="#cb286-4" tabindex="-1"></a>  <span class="co"># We need the location as a tuple of x,y coordinates</span></span>
<span id="cb286-5"><a href="#cb286-5" tabindex="-1"></a>  location_coords <span class="op">=</span> location.coords[<span class="dv">0</span>]</span>
<span id="cb286-6"><a href="#cb286-6" tabindex="-1"></a>  <span class="cf">return</span> location_coords</span>
<span id="cb286-7"><a href="#cb286-7" tabindex="-1"></a></span>
<span id="cb286-8"><a href="#cb286-8" tabindex="-1"></a>districts_gdf[<span class="st">&#39;label_position&#39;</span>] <span class="op">=</span> districts_gdf.<span class="bu">apply</span>(get_label_position, axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb286-9"><a href="#cb286-9" tabindex="-1"></a>districts_gdf</span></code></pre></div>
</div>
<div id="annotating-labels" class="section level4">
<h4>Annotating Labels</h4>
<p>We can now plot the districts and add an annotation for each polygon.
We iterate over each row of the GeoDataFrame and add the annotation with
name of the district at its centroid coordinates using
<code>annotate()</code> function.</p>
<div class="sourceCode" id="cb287"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb287-1"><a href="#cb287-1" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb287-2"><a href="#cb287-2" tabindex="-1"></a>fig.set_size_inches(<span class="dv">10</span>,<span class="dv">15</span>)</span>
<span id="cb287-3"><a href="#cb287-3" tabindex="-1"></a>districts_gdf.plot(ax<span class="op">=</span>ax, linewidth<span class="op">=</span><span class="dv">1</span>, facecolor<span class="op">=</span><span class="st">&#39;none&#39;</span>, edgecolor<span class="op">=</span><span class="st">&#39;#252525&#39;</span>)</span>
<span id="cb287-4"><a href="#cb287-4" tabindex="-1"></a></span>
<span id="cb287-5"><a href="#cb287-5" tabindex="-1"></a></span>
<span id="cb287-6"><a href="#cb287-6" tabindex="-1"></a><span class="cf">for</span> idx, row <span class="kw">in</span> districts_gdf.iterrows():</span>
<span id="cb287-7"><a href="#cb287-7" tabindex="-1"></a>   ax.annotate(text<span class="op">=</span>row[<span class="st">&#39;DISTRICT&#39;</span>], xy<span class="op">=</span>row[<span class="st">&#39;label_position&#39;</span>], horizontalalignment<span class="op">=</span><span class="st">&#39;center&#39;</span>)</span>
<span id="cb287-8"><a href="#cb287-8" tabindex="-1"></a>ax.set_axis_off()</span>
<span id="cb287-9"><a href="#cb287-9" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb287-10"><a href="#cb287-10" tabindex="-1"></a>plt.show()</span>
<span id="cb287-11"><a href="#cb287-11" tabindex="-1"></a></span></code></pre></div>
<p><img
src="python-dataviz-output/supplement_labeling_features_files/supplement_labeling_features_14_0.png" /></p>
<div class="sourceCode" id="cb288"><pre
class="sourceCode python"><code class="sourceCode python"></code></pre></div>
<p><a
href="https://colab.research.google.com/github/spatialthoughts/python-dataviz-web/blob/main/supplement_ndvi_time_series.ipynb"><img
src="https://colab.research.google.com/assets/colab-badge.svg"
alt="Open In Colab" /></a></p>
</div>
</div>
<div id="creating-time-series-charts" class="section level3">
<h3>Creating Time-Series Charts</h3>
<div class="sourceCode" id="cb289"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb289-1"><a href="#cb289-1" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb289-2"><a href="#cb289-2" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb289-3"><a href="#cb289-3" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb289-4"><a href="#cb289-4" tabindex="-1"></a><span class="im">import</span> matplotlib.dates <span class="im">as</span> mdates</span>
<span id="cb289-5"><a href="#cb289-5" tabindex="-1"></a><span class="im">import</span> requests</span></code></pre></div>
<div class="sourceCode" id="cb290"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb290-1"><a href="#cb290-1" tabindex="-1"></a>data_folder <span class="op">=</span> <span class="st">&#39;data&#39;</span></span>
<span id="cb290-2"><a href="#cb290-2" tabindex="-1"></a>output_folder <span class="op">=</span> <span class="st">&#39;output&#39;</span></span>
<span id="cb290-3"><a href="#cb290-3" tabindex="-1"></a></span>
<span id="cb290-4"><a href="#cb290-4" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> os.path.exists(data_folder):</span>
<span id="cb290-5"><a href="#cb290-5" tabindex="-1"></a>    os.mkdir(data_folder)</span>
<span id="cb290-6"><a href="#cb290-6" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> os.path.exists(output_folder):</span>
<span id="cb290-7"><a href="#cb290-7" tabindex="-1"></a>    os.mkdir(output_folder)</span></code></pre></div>
<div class="sourceCode" id="cb291"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb291-1"><a href="#cb291-1" tabindex="-1"></a><span class="kw">def</span> download(url):</span>
<span id="cb291-2"><a href="#cb291-2" tabindex="-1"></a>    filename <span class="op">=</span> os.path.join(data_folder, os.path.basename(url))</span>
<span id="cb291-3"><a href="#cb291-3" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> os.path.exists(filename):</span>
<span id="cb291-4"><a href="#cb291-4" tabindex="-1"></a>      <span class="cf">with</span> requests.get(url, stream<span class="op">=</span><span class="va">True</span>, allow_redirects<span class="op">=</span><span class="va">True</span>) <span class="im">as</span> r:</span>
<span id="cb291-5"><a href="#cb291-5" tabindex="-1"></a>          <span class="cf">with</span> <span class="bu">open</span>(filename, <span class="st">&#39;wb&#39;</span>) <span class="im">as</span> f:</span>
<span id="cb291-6"><a href="#cb291-6" tabindex="-1"></a>              <span class="cf">for</span> chunk <span class="kw">in</span> r.iter_content(chunk_size<span class="op">=</span><span class="dv">8192</span>):</span>
<span id="cb291-7"><a href="#cb291-7" tabindex="-1"></a>                  f.write(chunk)</span></code></pre></div>
<div class="sourceCode" id="cb292"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb292-1"><a href="#cb292-1" tabindex="-1"></a>data_url <span class="op">=</span> <span class="st">&#39;https://github.com/spatialthoughts/python-dataviz-web/releases/&#39;</span> \</span>
<span id="cb292-2"><a href="#cb292-2" tabindex="-1"></a>  <span class="st">&#39;download/misc/&#39;</span></span>
<span id="cb292-3"><a href="#cb292-3" tabindex="-1"></a>filename <span class="op">=</span> <span class="st">&#39;ndvi_data.xlsx&#39;</span></span>
<span id="cb292-4"><a href="#cb292-4" tabindex="-1"></a></span>
<span id="cb292-5"><a href="#cb292-5" tabindex="-1"></a>download(data_url <span class="op">+</span> filename)</span></code></pre></div>
<div id="data-pre-processing-9" class="section level4">
<h4>Data Pre-Processing</h4>
<div class="sourceCode" id="cb293"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb293-1"><a href="#cb293-1" tabindex="-1"></a>filepath <span class="op">=</span> os.path.join(data_folder, filename)</span>
<span id="cb293-2"><a href="#cb293-2" tabindex="-1"></a>df <span class="op">=</span> pd.read_excel(filepath)</span>
<span id="cb293-3"><a href="#cb293-3" tabindex="-1"></a>df</span></code></pre></div>
<p>We set the ‘Date’ column as the index of the dateframe. This will
allow us to filter and plot the time-series data easily.</p>
<div class="sourceCode" id="cb294"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb294-1"><a href="#cb294-1" tabindex="-1"></a>df <span class="op">=</span> df.set_index(pd.to_datetime(df[<span class="st">&#39;Date&#39;</span>]))</span>
<span id="cb294-2"><a href="#cb294-2" tabindex="-1"></a>df</span></code></pre></div>
<p>Create a chart with time-series of values in the ‘NDVI’ column. We
use <code>mdates</code> module to control the tick-marks on X-Axis.</p>
<div class="sourceCode" id="cb295"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb295-1"><a href="#cb295-1" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb295-2"><a href="#cb295-2" tabindex="-1"></a>fig.set_size_inches(<span class="dv">20</span>,<span class="dv">10</span>)</span>
<span id="cb295-3"><a href="#cb295-3" tabindex="-1"></a>df.plot(y<span class="op">=</span><span class="st">&#39;NDVI&#39;</span>, kind<span class="op">=</span><span class="st">&#39;line&#39;</span>, ax<span class="op">=</span>ax,</span>
<span id="cb295-4"><a href="#cb295-4" tabindex="-1"></a>        marker<span class="op">=</span><span class="st">&#39;o&#39;</span>, markersize<span class="op">=</span><span class="dv">2</span>, color<span class="op">=</span><span class="st">&#39;#238b45&#39;</span>,</span>
<span id="cb295-5"><a href="#cb295-5" tabindex="-1"></a>        label<span class="op">=</span><span class="st">&#39;Original NDVI&#39;</span>)</span>
<span id="cb295-6"><a href="#cb295-6" tabindex="-1"></a></span>
<span id="cb295-7"><a href="#cb295-7" tabindex="-1"></a>ax.xaxis.set_major_locator(mdates.MonthLocator(interval<span class="op">=</span><span class="dv">6</span>))</span>
<span id="cb295-8"><a href="#cb295-8" tabindex="-1"></a>ax.xaxis.set_major_formatter(mdates.DateFormatter(<span class="st">&quot;%Y-%m&quot;</span>))</span>
<span id="cb295-9"><a href="#cb295-9" tabindex="-1"></a></span>
<span id="cb295-10"><a href="#cb295-10" tabindex="-1"></a>ax.grid(<span class="st">&#39;on&#39;</span>)</span>
<span id="cb295-11"><a href="#cb295-11" tabindex="-1"></a>ax.set_title(<span class="st">&#39;NDVI Time-Series&#39;</span>)</span>
<span id="cb295-12"><a href="#cb295-12" tabindex="-1"></a>ax.set_ylabel(<span class="st">&#39;NDVI&#39;</span>)</span>
<span id="cb295-13"><a href="#cb295-13" tabindex="-1"></a></span>
<span id="cb295-14"><a href="#cb295-14" tabindex="-1"></a><span class="co"># Save the plot</span></span>
<span id="cb295-15"><a href="#cb295-15" tabindex="-1"></a>output_folder <span class="op">=</span> <span class="st">&#39;output&#39;</span></span>
<span id="cb295-16"><a href="#cb295-16" tabindex="-1"></a>output_path <span class="op">=</span> os.path.join(output_folder, <span class="st">&#39;ndvi_time_series.png&#39;</span>)</span>
<span id="cb295-17"><a href="#cb295-17" tabindex="-1"></a>plt.savefig(output_path)</span>
<span id="cb295-18"><a href="#cb295-18" tabindex="-1"></a></span>
<span id="cb295-19"><a href="#cb295-19" tabindex="-1"></a>plt.show()</span></code></pre></div>
<p><img
src="python-dataviz-output/supplement_ndvi_time_series_files/supplement_ndvi_time_series_10_0.png" /></p>
</div>
<div id="time-series-smoothing-with-moving-average"
class="section level4">
<h4>Time Series Smoothing with Moving Average</h4>
<p>Pandas has built-in method <code>rolling()</code> to allow us to
compute moving averages. Let’s smooth the time-series with a
moving-window average.</p>
<div class="sourceCode" id="cb296"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb296-1"><a href="#cb296-1" tabindex="-1"></a>window_size_days <span class="op">=</span> <span class="dv">30</span></span>
<span id="cb296-2"><a href="#cb296-2" tabindex="-1"></a>window <span class="op">=</span> <span class="st">&#39;</span><span class="sc">{}</span><span class="st">D&#39;</span>.<span class="bu">format</span>(window_size_days)</span>
<span id="cb296-3"><a href="#cb296-3" tabindex="-1"></a>df_smooth <span class="op">=</span> df.copy()</span>
<span id="cb296-4"><a href="#cb296-4" tabindex="-1"></a>df_smooth[<span class="st">&#39;NDVI_smooth&#39;</span>] <span class="op">=</span> df_smooth[<span class="st">&#39;NDVI&#39;</span>].rolling(window, center<span class="op">=</span><span class="va">True</span>).mean()</span>
<span id="cb296-5"><a href="#cb296-5" tabindex="-1"></a>df_smooth</span></code></pre></div>
<div class="sourceCode" id="cb297"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb297-1"><a href="#cb297-1" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb297-2"><a href="#cb297-2" tabindex="-1"></a>fig.set_size_inches(<span class="dv">20</span>,<span class="dv">10</span>)</span>
<span id="cb297-3"><a href="#cb297-3" tabindex="-1"></a>df_smooth.plot(y<span class="op">=</span><span class="st">&#39;NDVI&#39;</span>, kind<span class="op">=</span><span class="st">&#39;line&#39;</span>, ax<span class="op">=</span>ax,</span>
<span id="cb297-4"><a href="#cb297-4" tabindex="-1"></a>                  marker<span class="op">=</span><span class="st">&#39;o&#39;</span>, markersize<span class="op">=</span><span class="dv">1</span>, color<span class="op">=</span><span class="st">&#39;#66c2a4&#39;</span>, linestyle<span class="op">=</span><span class="st">&#39;dotted&#39;</span>,</span>
<span id="cb297-5"><a href="#cb297-5" tabindex="-1"></a>                  label<span class="op">=</span><span class="st">&#39;Original&#39;</span>)</span>
<span id="cb297-6"><a href="#cb297-6" tabindex="-1"></a>df_smooth.plot(y<span class="op">=</span><span class="st">&#39;NDVI_smooth&#39;</span>, kind<span class="op">=</span><span class="st">&#39;line&#39;</span>, ax<span class="op">=</span>ax,</span>
<span id="cb297-7"><a href="#cb297-7" tabindex="-1"></a>                  marker<span class="op">=</span><span class="st">&#39;o&#39;</span>, linewidth<span class="op">=</span> <span class="dv">2</span>, markersize<span class="op">=</span><span class="dv">0</span>, color<span class="op">=</span><span class="st">&#39;#238b45&#39;</span>,</span>
<span id="cb297-8"><a href="#cb297-8" tabindex="-1"></a>                  label<span class="op">=</span><span class="st">&#39;</span><span class="sc">{}</span><span class="st"> Day Moving-Average&#39;</span>.<span class="bu">format</span>(window_size_days))</span>
<span id="cb297-9"><a href="#cb297-9" tabindex="-1"></a>ax.xaxis.set_major_locator(mdates.MonthLocator(interval<span class="op">=</span><span class="dv">6</span>))</span>
<span id="cb297-10"><a href="#cb297-10" tabindex="-1"></a>ax.xaxis.set_major_formatter(mdates.DateFormatter(<span class="st">&quot;%Y-%m&quot;</span>))</span>
<span id="cb297-11"><a href="#cb297-11" tabindex="-1"></a></span>
<span id="cb297-12"><a href="#cb297-12" tabindex="-1"></a>ax.grid(<span class="st">&#39;on&#39;</span>)</span>
<span id="cb297-13"><a href="#cb297-13" tabindex="-1"></a></span>
<span id="cb297-14"><a href="#cb297-14" tabindex="-1"></a>ax.set_title(<span class="st">&#39;NDVI Time-Series&#39;</span>)</span>
<span id="cb297-15"><a href="#cb297-15" tabindex="-1"></a>ax.set_ylabel(<span class="st">&#39;NDVI&#39;</span>)</span>
<span id="cb297-16"><a href="#cb297-16" tabindex="-1"></a></span>
<span id="cb297-17"><a href="#cb297-17" tabindex="-1"></a><span class="co"># Save the plot</span></span>
<span id="cb297-18"><a href="#cb297-18" tabindex="-1"></a>output_folder <span class="op">=</span> <span class="st">&#39;output&#39;</span></span>
<span id="cb297-19"><a href="#cb297-19" tabindex="-1"></a>output_path <span class="op">=</span> os.path.join(output_folder, <span class="st">&#39;smooth_ndvi_time_series.png&#39;</span>)</span>
<span id="cb297-20"><a href="#cb297-20" tabindex="-1"></a>plt.savefig(output_path)</span>
<span id="cb297-21"><a href="#cb297-21" tabindex="-1"></a></span>
<span id="cb297-22"><a href="#cb297-22" tabindex="-1"></a>plt.show()</span></code></pre></div>
<p><img
src="python-dataviz-output/supplement_ndvi_time_series_files/supplement_ndvi_time_series_13_0.png" /></p>
<p><a
href="https://colab.research.google.com/github/spatialthoughts/python-dataviz-web/blob/main/supplement_feature_correlation_matrix.ipynb"><img
src="https://colab.research.google.com/assets/colab-badge.svg"
alt="Open In Colab" /></a></p>
</div>
</div>
<div id="feature-correlation-matrix" class="section level3">
<h3>Feature Correlation Matrix</h3>
<p>Correlation Matrix is used in Machine Learning to identify redudant
features that are correlated. We will take a table of feature samples
generated from a multiband image and create a correlation matrix. This
matrix is used to identify and visualize patterns in the given data and
select features for a machine learning model.</p>
<div id="setup-and-data-download-16" class="section level4">
<h4>Setup and Data Download</h4>
<p>The following blocks of code will install the required packages and
download the datasets to your Colab environment.</p>
<div class="sourceCode" id="cb298"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb298-1"><a href="#cb298-1" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb298-2"><a href="#cb298-2" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb298-3"><a href="#cb298-3" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb298-4"><a href="#cb298-4" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb298-5"><a href="#cb298-5" tabindex="-1"></a><span class="im">import</span> requests</span></code></pre></div>
<div class="sourceCode" id="cb299"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb299-1"><a href="#cb299-1" tabindex="-1"></a>data_folder <span class="op">=</span> <span class="st">&#39;data&#39;</span></span>
<span id="cb299-2"><a href="#cb299-2" tabindex="-1"></a>output_folder <span class="op">=</span> <span class="st">&#39;output&#39;</span></span>
<span id="cb299-3"><a href="#cb299-3" tabindex="-1"></a></span>
<span id="cb299-4"><a href="#cb299-4" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> os.path.exists(data_folder):</span>
<span id="cb299-5"><a href="#cb299-5" tabindex="-1"></a>    os.mkdir(data_folder)</span>
<span id="cb299-6"><a href="#cb299-6" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> os.path.exists(output_folder):</span>
<span id="cb299-7"><a href="#cb299-7" tabindex="-1"></a>    os.mkdir(output_folder)</span></code></pre></div>
<div class="sourceCode" id="cb300"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb300-1"><a href="#cb300-1" tabindex="-1"></a><span class="kw">def</span> download(url):</span>
<span id="cb300-2"><a href="#cb300-2" tabindex="-1"></a>    filename <span class="op">=</span> os.path.join(data_folder, os.path.basename(url))</span>
<span id="cb300-3"><a href="#cb300-3" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> os.path.exists(filename):</span>
<span id="cb300-4"><a href="#cb300-4" tabindex="-1"></a>      <span class="cf">with</span> requests.get(url, stream<span class="op">=</span><span class="va">True</span>, allow_redirects<span class="op">=</span><span class="va">True</span>) <span class="im">as</span> r:</span>
<span id="cb300-5"><a href="#cb300-5" tabindex="-1"></a>          <span class="cf">with</span> <span class="bu">open</span>(filename, <span class="st">&#39;wb&#39;</span>) <span class="im">as</span> f:</span>
<span id="cb300-6"><a href="#cb300-6" tabindex="-1"></a>              <span class="cf">for</span> chunk <span class="kw">in</span> r.iter_content(chunk_size<span class="op">=</span><span class="dv">8192</span>):</span>
<span id="cb300-7"><a href="#cb300-7" tabindex="-1"></a>                  f.write(chunk)</span>
<span id="cb300-8"><a href="#cb300-8" tabindex="-1"></a>      <span class="bu">print</span>(<span class="st">&#39;Downloaded&#39;</span>, filename)</span></code></pre></div>
<div class="sourceCode" id="cb301"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb301-1"><a href="#cb301-1" tabindex="-1"></a>data_url <span class="op">=</span> <span class="st">&#39;https://github.com/spatialthoughts/python-dataviz-web/releases/&#39;</span> \</span>
<span id="cb301-2"><a href="#cb301-2" tabindex="-1"></a>  <span class="st">&#39;download/misc/&#39;</span></span>
<span id="cb301-3"><a href="#cb301-3" tabindex="-1"></a>csv_name <span class="op">=</span> <span class="st">&#39;feature_sample_data.csv&#39;</span></span>
<span id="cb301-4"><a href="#cb301-4" tabindex="-1"></a></span>
<span id="cb301-5"><a href="#cb301-5" tabindex="-1"></a>download(data_url <span class="op">+</span> csv_name)</span></code></pre></div>
</div>
<div id="data-pre-processing-10" class="section level4">
<h4>Data Pre-Processing</h4>
<div class="sourceCode" id="cb302"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb302-1"><a href="#cb302-1" tabindex="-1"></a>csv_path <span class="op">=</span> os.path.join(data_folder, csv_name)</span>
<span id="cb302-2"><a href="#cb302-2" tabindex="-1"></a>table <span class="op">=</span> pd.read_csv(csv_path)</span></code></pre></div>
<p>We use Pandas’ <a
href="https://pandas.pydata.org/pandas-docs/stable/reference/api/pandas.DataFrame.corr.html"><code>pd.DataFrame.corr()</code></a>
method to calculate pairwise Pearson’s Correlation Coefficient for each
variable.</p>
<div class="sourceCode" id="cb303"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb303-1"><a href="#cb303-1" tabindex="-1"></a>correlations <span class="op">=</span> table.corr()</span></code></pre></div>
</div>
<div id="plotting-using-matplotlib-1" class="section level4">
<h4>Plotting using Matplotlib</h4>
<p>We can use Matplotlib’s <a
href="https://matplotlib.org/stable/api/_as_gen/matplotlib.pyplot.matshow.html"><code>matplotlib.pyplot.matshow</code></a>
to display any array as a matrix.</p>
<div class="sourceCode" id="cb304"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb304-1"><a href="#cb304-1" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb304-2"><a href="#cb304-2" tabindex="-1"></a>fig.set_size_inches(<span class="dv">18</span>,<span class="dv">18</span>)</span>
<span id="cb304-3"><a href="#cb304-3" tabindex="-1"></a>im <span class="op">=</span> ax.matshow(correlations, vmin<span class="op">=-</span><span class="dv">1</span>, vmax<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb304-4"><a href="#cb304-4" tabindex="-1"></a>fig.colorbar(im, shrink<span class="op">=</span><span class="fl">0.8</span>)</span>
<span id="cb304-5"><a href="#cb304-5" tabindex="-1"></a></span>
<span id="cb304-6"><a href="#cb304-6" tabindex="-1"></a>ticks <span class="op">=</span> np.arange(<span class="dv">0</span>,<span class="bu">len</span>(table.columns),<span class="dv">1</span>)</span>
<span id="cb304-7"><a href="#cb304-7" tabindex="-1"></a>ax.set_xticks(ticks)</span>
<span id="cb304-8"><a href="#cb304-8" tabindex="-1"></a>ax.set_yticks(ticks)</span>
<span id="cb304-9"><a href="#cb304-9" tabindex="-1"></a>ax.set_xticklabels(table.columns)</span>
<span id="cb304-10"><a href="#cb304-10" tabindex="-1"></a>ax.set_yticklabels(table.columns)</span>
<span id="cb304-11"><a href="#cb304-11" tabindex="-1"></a></span>
<span id="cb304-12"><a href="#cb304-12" tabindex="-1"></a></span>
<span id="cb304-13"><a href="#cb304-13" tabindex="-1"></a>output_folder <span class="op">=</span> <span class="st">&#39;output&#39;</span></span>
<span id="cb304-14"><a href="#cb304-14" tabindex="-1"></a>output_path <span class="op">=</span> os.path.join(output_folder, <span class="st">&#39;correlation_matrix.png&#39;</span>)</span>
<span id="cb304-15"><a href="#cb304-15" tabindex="-1"></a></span>
<span id="cb304-16"><a href="#cb304-16" tabindex="-1"></a>plt.savefig(output_path, dpi<span class="op">=</span><span class="dv">300</span>)</span>
<span id="cb304-17"><a href="#cb304-17" tabindex="-1"></a>plt.show()</span></code></pre></div>
<p><a
href="https://colab.research.google.com/github/spatialthoughts/python-dataviz-web/blob/main/supplement_matplotlib_anatomy.ipynb"><img
src="https://colab.research.google.com/assets/colab-badge.svg"
alt="Open In Colab" /></a></p>
</div>
</div>
<div id="matplotlib-anatomy" class="section level3">
<h3>Matplotlib Anatomy</h3>
<p>This notebook creates the figures showing the anatomy of a matplotlib
plot. It is also a good reference showing how to create annotations with
callouts and curved arrows.</p>
<div id="setup-and-data-download-17" class="section level4">
<h4>Setup and Data Download</h4>
<p>The following blocks of code will install the required packages and
download the datasets to your Colab environment.</p>
<div class="sourceCode" id="cb305"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb305-1"><a href="#cb305-1" tabindex="-1"></a><span class="op">%%</span>capture</span>
<span id="cb305-2"><a href="#cb305-2" tabindex="-1"></a><span class="cf">if</span> <span class="st">&#39;google.colab&#39;</span> <span class="kw">in</span> <span class="bu">str</span>(get_ipython()):</span>
<span id="cb305-3"><a href="#cb305-3" tabindex="-1"></a>    <span class="op">!</span>pip install rioxarray</span></code></pre></div>
<div class="sourceCode" id="cb306"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb306-1"><a href="#cb306-1" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb306-2"><a href="#cb306-2" tabindex="-1"></a><span class="im">import</span> rioxarray <span class="im">as</span> rxr</span>
<span id="cb306-3"><a href="#cb306-3" tabindex="-1"></a><span class="im">from</span> rioxarray.merge <span class="im">import</span> merge_arrays</span>
<span id="cb306-4"><a href="#cb306-4" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb306-5"><a href="#cb306-5" tabindex="-1"></a><span class="im">import</span> matplotlib.patches <span class="im">as</span> patches</span></code></pre></div>
<div class="sourceCode" id="cb307"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb307-1"><a href="#cb307-1" tabindex="-1"></a>data_folder <span class="op">=</span> <span class="st">&#39;data&#39;</span></span>
<span id="cb307-2"><a href="#cb307-2" tabindex="-1"></a>output_folder <span class="op">=</span> <span class="st">&#39;output&#39;</span></span>
<span id="cb307-3"><a href="#cb307-3" tabindex="-1"></a></span>
<span id="cb307-4"><a href="#cb307-4" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> os.path.exists(data_folder):</span>
<span id="cb307-5"><a href="#cb307-5" tabindex="-1"></a>    os.mkdir(data_folder)</span>
<span id="cb307-6"><a href="#cb307-6" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> os.path.exists(output_folder):</span>
<span id="cb307-7"><a href="#cb307-7" tabindex="-1"></a>    os.mkdir(output_folder)</span></code></pre></div>
<div class="sourceCode" id="cb308"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb308-1"><a href="#cb308-1" tabindex="-1"></a><span class="kw">def</span> download(url):</span>
<span id="cb308-2"><a href="#cb308-2" tabindex="-1"></a>    filename <span class="op">=</span> os.path.join(data_folder, os.path.basename(url))</span>
<span id="cb308-3"><a href="#cb308-3" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> os.path.exists(filename):</span>
<span id="cb308-4"><a href="#cb308-4" tabindex="-1"></a>        <span class="im">from</span> urllib.request <span class="im">import</span> urlretrieve</span>
<span id="cb308-5"><a href="#cb308-5" tabindex="-1"></a>        local, _ <span class="op">=</span> urlretrieve(url, filename)</span>
<span id="cb308-6"><a href="#cb308-6" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">&#39;Downloaded &#39;</span> <span class="op">+</span> local)</span>
<span id="cb308-7"><a href="#cb308-7" tabindex="-1"></a></span>
<span id="cb308-8"><a href="#cb308-8" tabindex="-1"></a>srtm_tiles <span class="op">=</span> [</span>
<span id="cb308-9"><a href="#cb308-9" tabindex="-1"></a>  <span class="st">&#39;N27E086.hgt&#39;</span>,</span>
<span id="cb308-10"><a href="#cb308-10" tabindex="-1"></a>  <span class="st">&#39;N27E087.hgt&#39;</span>,</span>
<span id="cb308-11"><a href="#cb308-11" tabindex="-1"></a>  <span class="st">&#39;N28E086.hgt&#39;</span>,</span>
<span id="cb308-12"><a href="#cb308-12" tabindex="-1"></a>  <span class="st">&#39;N28E087.hgt&#39;</span></span>
<span id="cb308-13"><a href="#cb308-13" tabindex="-1"></a>]</span>
<span id="cb308-14"><a href="#cb308-14" tabindex="-1"></a></span>
<span id="cb308-15"><a href="#cb308-15" tabindex="-1"></a>data_url <span class="op">=</span> <span class="st">&#39;https://github.com/spatialthoughts/python-dataviz-web/releases/&#39;</span> \</span>
<span id="cb308-16"><a href="#cb308-16" tabindex="-1"></a>  <span class="st">&#39;download/srtm/&#39;</span></span>
<span id="cb308-17"><a href="#cb308-17" tabindex="-1"></a></span>
<span id="cb308-18"><a href="#cb308-18" tabindex="-1"></a><span class="cf">for</span> tile <span class="kw">in</span> srtm_tiles:</span>
<span id="cb308-19"><a href="#cb308-19" tabindex="-1"></a>  url <span class="op">=</span> <span class="st">&#39;</span><span class="sc">{}</span><span class="st">/</span><span class="sc">{}</span><span class="st">&#39;</span>.<span class="bu">format</span>(data_url, tile)</span>
<span id="cb308-20"><a href="#cb308-20" tabindex="-1"></a>  download(url)</span></code></pre></div>
</div>
<div id="creating-a-figure-with-multiple-axes-and-frame"
class="section level4">
<h4>Creating a Figure with Multiple Axes and Frame</h4>
<div class="sourceCode" id="cb309"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb309-1"><a href="#cb309-1" tabindex="-1"></a>datasets <span class="op">=</span> []</span>
<span id="cb309-2"><a href="#cb309-2" tabindex="-1"></a><span class="cf">for</span> tile <span class="kw">in</span> srtm_tiles:</span>
<span id="cb309-3"><a href="#cb309-3" tabindex="-1"></a>    path <span class="op">=</span> os.path.join(data_folder, tile)</span>
<span id="cb309-4"><a href="#cb309-4" tabindex="-1"></a>    rds <span class="op">=</span> rxr.open_rasterio(path)</span>
<span id="cb309-5"><a href="#cb309-5" tabindex="-1"></a>    band <span class="op">=</span> rds.sel(band<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb309-6"><a href="#cb309-6" tabindex="-1"></a>    datasets.append(band)</span></code></pre></div>
<div class="sourceCode" id="cb310"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb310-1"><a href="#cb310-1" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(<span class="dv">2</span>, <span class="dv">2</span>,edgecolor<span class="op">=</span><span class="st">&#39;black&#39;</span>)</span>
<span id="cb310-2"><a href="#cb310-2" tabindex="-1"></a>fig.set_size_inches(<span class="dv">7</span>,<span class="dv">7</span>)</span>
<span id="cb310-3"><a href="#cb310-3" tabindex="-1"></a><span class="cf">for</span> index, ax <span class="kw">in</span> <span class="bu">enumerate</span>(axes.flat):</span>
<span id="cb310-4"><a href="#cb310-4" tabindex="-1"></a>    da <span class="op">=</span> datasets[index]</span>
<span id="cb310-5"><a href="#cb310-5" tabindex="-1"></a>    im <span class="op">=</span> da.plot.imshow(</span>
<span id="cb310-6"><a href="#cb310-6" tabindex="-1"></a>        ax<span class="op">=</span>ax, cmap<span class="op">=</span><span class="st">&#39;Greys_r&#39;</span>,</span>
<span id="cb310-7"><a href="#cb310-7" tabindex="-1"></a>        vmin<span class="op">=</span><span class="dv">1000</span>, vmax<span class="op">=</span><span class="dv">8000</span>,</span>
<span id="cb310-8"><a href="#cb310-8" tabindex="-1"></a>        add_colorbar<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb310-9"><a href="#cb310-9" tabindex="-1"></a>    filename <span class="op">=</span> srtm_tiles[index]</span>
<span id="cb310-10"><a href="#cb310-10" tabindex="-1"></a>    ax.tick_params(axis<span class="op">=</span><span class="st">&#39;both&#39;</span>, which<span class="op">=</span><span class="st">&#39;major&#39;</span>, labelsize<span class="op">=</span><span class="dv">7</span>)</span>
<span id="cb310-11"><a href="#cb310-11" tabindex="-1"></a>    ax.set_title(filename,fontsize<span class="op">=</span><span class="dv">9</span>)</span>
<span id="cb310-12"><a href="#cb310-12" tabindex="-1"></a>    ax.set_xlabel(<span class="st">&#39;&#39;</span>,fontsize <span class="op">=</span> <span class="dv">7</span>)</span>
<span id="cb310-13"><a href="#cb310-13" tabindex="-1"></a>    ax.set_ylabel(<span class="st">&#39;&#39;</span>,fontsize <span class="op">=</span> <span class="dv">7</span>)</span>
<span id="cb310-14"><a href="#cb310-14" tabindex="-1"></a>    <span class="cf">if</span> index <span class="kw">in</span> [<span class="dv">0</span>, <span class="dv">2</span>]:</span>
<span id="cb310-15"><a href="#cb310-15" tabindex="-1"></a>        ax.set_ylabel(<span class="st">&#39;latitude&#39;</span>,fontsize <span class="op">=</span> <span class="dv">7</span>)</span>
<span id="cb310-16"><a href="#cb310-16" tabindex="-1"></a>    <span class="cf">if</span> index <span class="kw">in</span> [<span class="dv">2</span>, <span class="dv">3</span>]:</span>
<span id="cb310-17"><a href="#cb310-17" tabindex="-1"></a>        ax.set_xlabel(<span class="st">&#39;longitude&#39;</span>,fontsize <span class="op">=</span> <span class="dv">7</span>)</span>
<span id="cb310-18"><a href="#cb310-18" tabindex="-1"></a></span>
<span id="cb310-19"><a href="#cb310-19" tabindex="-1"></a>    ax.set_aspect(<span class="st">&#39;equal&#39;</span>) <span class="co"># maintain aspect ratio</span></span>
<span id="cb310-20"><a href="#cb310-20" tabindex="-1"></a></span>
<span id="cb310-21"><a href="#cb310-21" tabindex="-1"></a>plt.suptitle(<span class="st">&#39;SRTM 30m Elevation Tiles&#39;</span>, fontsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb310-22"><a href="#cb310-22" tabindex="-1"></a></span>
<span id="cb310-23"><a href="#cb310-23" tabindex="-1"></a><span class="co"># Add a frame</span></span>
<span id="cb310-24"><a href="#cb310-24" tabindex="-1"></a>frame <span class="op">=</span> patches.Rectangle((<span class="op">-</span><span class="fl">0.02</span>, <span class="op">-</span><span class="fl">0.02</span>), <span class="fl">1.04</span>, <span class="fl">1.04</span>,</span>
<span id="cb310-25"><a href="#cb310-25" tabindex="-1"></a>                          transform<span class="op">=</span>fig.transFigure,</span>
<span id="cb310-26"><a href="#cb310-26" tabindex="-1"></a>                          edgecolor<span class="op">=</span><span class="st">&#39;black&#39;</span>,</span>
<span id="cb310-27"><a href="#cb310-27" tabindex="-1"></a>                          facecolor<span class="op">=</span><span class="st">&#39;none&#39;</span>,</span>
<span id="cb310-28"><a href="#cb310-28" tabindex="-1"></a>                          linewidth<span class="op">=</span><span class="fl">1.5</span>)</span>
<span id="cb310-29"><a href="#cb310-29" tabindex="-1"></a>fig.patches.append(frame)</span>
<span id="cb310-30"><a href="#cb310-30" tabindex="-1"></a></span>
<span id="cb310-31"><a href="#cb310-31" tabindex="-1"></a><span class="co"># Create a new axes for the colorbar at the bottom spanning two axes</span></span>
<span id="cb310-32"><a href="#cb310-32" tabindex="-1"></a><span class="co"># [left, bottom, width, height] in figure coordinates</span></span>
<span id="cb310-33"><a href="#cb310-33" tabindex="-1"></a>cax <span class="op">=</span> fig.add_axes([<span class="fl">0.25</span>, <span class="fl">0.02</span>, <span class="fl">0.5</span>, <span class="fl">0.03</span>])</span>
<span id="cb310-34"><a href="#cb310-34" tabindex="-1"></a></span>
<span id="cb310-35"><a href="#cb310-35" tabindex="-1"></a>cbar <span class="op">=</span> fig.colorbar(im, cax<span class="op">=</span>cax, orientation<span class="op">=</span><span class="st">&#39;horizontal&#39;</span>)</span>
<span id="cb310-36"><a href="#cb310-36" tabindex="-1"></a>cbar.ax.tick_params(labelsize<span class="op">=</span><span class="dv">7</span>) <span class="co"># Set fontsize of colorbar labels</span></span>
<span id="cb310-37"><a href="#cb310-37" tabindex="-1"></a></span>
<span id="cb310-38"><a href="#cb310-38" tabindex="-1"></a>plt.show()</span></code></pre></div>
<p><img
src="python-dataviz-output/supplement_matplotlib_anatomy_files/supplement_matplotlib_anatomy_8_0.png" /></p>
</div>
<div id="adding-arrow-annotations" class="section level4">
<h4>Adding Arrow Annotations</h4>
<p>We create a helper function to add labels with curved arrows using <a
href="https://matplotlib.org/stable/api/_as_gen/matplotlib.patches.FancyArrowPatch.html"><code>FancyArrowPatch</code></a>.</p>
<div class="sourceCode" id="cb311"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb311-1"><a href="#cb311-1" tabindex="-1"></a><span class="kw">def</span> add_annotation(fig, title_text, arrow_start_coords, arrow_end_coords):</span>
<span id="cb311-2"><a href="#cb311-2" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb311-3"><a href="#cb311-3" tabindex="-1"></a><span class="co">    Adds a title annotation with an arrow pointing to it on the given figure.</span></span>
<span id="cb311-4"><a href="#cb311-4" tabindex="-1"></a></span>
<span id="cb311-5"><a href="#cb311-5" tabindex="-1"></a><span class="co">    Parameters:</span></span>
<span id="cb311-6"><a href="#cb311-6" tabindex="-1"></a><span class="co">    - fig: The Matplotlib figure to add the annotation to.</span></span>
<span id="cb311-7"><a href="#cb311-7" tabindex="-1"></a><span class="co">    - title_text: The text of the title annotation.</span></span>
<span id="cb311-8"><a href="#cb311-8" tabindex="-1"></a><span class="co">    - arrow_start_coords: Tuple (x, y) for the starting position</span></span>
<span id="cb311-9"><a href="#cb311-9" tabindex="-1"></a><span class="co">         of the arrow outside the frame in normalized figure coordinates.</span></span>
<span id="cb311-10"><a href="#cb311-10" tabindex="-1"></a><span class="co">    - arrow_end_coords (title_coords): Tuple (x, y) for the end position</span></span>
<span id="cb311-11"><a href="#cb311-11" tabindex="-1"></a><span class="co">         of the arrow in normalized figure coordinates.</span></span>
<span id="cb311-12"><a href="#cb311-12" tabindex="-1"></a><span class="co">    - arrow_color: The color of the arrow.</span></span>
<span id="cb311-13"><a href="#cb311-13" tabindex="-1"></a><span class="co">    &quot;&quot;&quot;</span></span>
<span id="cb311-14"><a href="#cb311-14" tabindex="-1"></a>    arrow_start_x, arrow_start_y <span class="op">=</span> arrow_start_coords</span>
<span id="cb311-15"><a href="#cb311-15" tabindex="-1"></a>    arrow_end_x, arrow_end_y <span class="op">=</span> arrow_end_coords</span>
<span id="cb311-16"><a href="#cb311-16" tabindex="-1"></a></span>
<span id="cb311-17"><a href="#cb311-17" tabindex="-1"></a></span>
<span id="cb311-18"><a href="#cb311-18" tabindex="-1"></a>    bbox_props <span class="op">=</span> {</span>
<span id="cb311-19"><a href="#cb311-19" tabindex="-1"></a>        <span class="st">&#39;boxstyle&#39;</span>:<span class="st">&#39;round,pad=0.3&#39;</span>,</span>
<span id="cb311-20"><a href="#cb311-20" tabindex="-1"></a>        <span class="st">&#39;edgecolor&#39;</span>:<span class="st">&#39;black&#39;</span>,</span>
<span id="cb311-21"><a href="#cb311-21" tabindex="-1"></a>        <span class="st">&#39;facecolor&#39;</span>:<span class="st">&#39;white&#39;</span>}</span>
<span id="cb311-22"><a href="#cb311-22" tabindex="-1"></a>    arrowstyle<span class="op">=</span><span class="st">&#39;-|&gt;&#39;</span></span>
<span id="cb311-23"><a href="#cb311-23" tabindex="-1"></a>    arrow_color<span class="op">=</span><span class="st">&#39;blue&#39;</span></span>
<span id="cb311-24"><a href="#cb311-24" tabindex="-1"></a>    connectionstyle<span class="op">=</span><span class="st">&#39;arc3,rad=-.2&#39;</span></span>
<span id="cb311-25"><a href="#cb311-25" tabindex="-1"></a>    mutation_scale<span class="op">=</span><span class="dv">15</span></span>
<span id="cb311-26"><a href="#cb311-26" tabindex="-1"></a>    mutation_aspect<span class="op">=</span><span class="dv">1</span></span>
<span id="cb311-27"><a href="#cb311-27" tabindex="-1"></a>    linewidth<span class="op">=</span><span class="dv">1</span></span>
<span id="cb311-28"><a href="#cb311-28" tabindex="-1"></a></span>
<span id="cb311-29"><a href="#cb311-29" tabindex="-1"></a>    <span class="co"># Create and add the arrow</span></span>
<span id="cb311-30"><a href="#cb311-30" tabindex="-1"></a>    arrow <span class="op">=</span> patches.FancyArrowPatch(</span>
<span id="cb311-31"><a href="#cb311-31" tabindex="-1"></a>        (arrow_start_x, arrow_start_y),</span>
<span id="cb311-32"><a href="#cb311-32" tabindex="-1"></a>        (arrow_end_x, arrow_end_y),</span>
<span id="cb311-33"><a href="#cb311-33" tabindex="-1"></a>        connectionstyle<span class="op">=</span>connectionstyle,</span>
<span id="cb311-34"><a href="#cb311-34" tabindex="-1"></a>        transform<span class="op">=</span>fig.transFigure,</span>
<span id="cb311-35"><a href="#cb311-35" tabindex="-1"></a>        color<span class="op">=</span>arrow_color,</span>
<span id="cb311-36"><a href="#cb311-36" tabindex="-1"></a>        arrowstyle<span class="op">=</span>arrowstyle,</span>
<span id="cb311-37"><a href="#cb311-37" tabindex="-1"></a>        mutation_scale<span class="op">=</span>mutation_scale,</span>
<span id="cb311-38"><a href="#cb311-38" tabindex="-1"></a>        mutation_aspect<span class="op">=</span>mutation_aspect,</span>
<span id="cb311-39"><a href="#cb311-39" tabindex="-1"></a>        linewidth<span class="op">=</span>linewidth</span>
<span id="cb311-40"><a href="#cb311-40" tabindex="-1"></a>    )</span>
<span id="cb311-41"><a href="#cb311-41" tabindex="-1"></a>    fig.patches.append(arrow)</span>
<span id="cb311-42"><a href="#cb311-42" tabindex="-1"></a></span>
<span id="cb311-43"><a href="#cb311-43" tabindex="-1"></a>    <span class="co"># Add the title annotation with bounding box at the end of the arrow</span></span>
<span id="cb311-44"><a href="#cb311-44" tabindex="-1"></a>    fig.text(</span>
<span id="cb311-45"><a href="#cb311-45" tabindex="-1"></a>        arrow_start_x,</span>
<span id="cb311-46"><a href="#cb311-46" tabindex="-1"></a>        arrow_start_y,</span>
<span id="cb311-47"><a href="#cb311-47" tabindex="-1"></a>        title_text,</span>
<span id="cb311-48"><a href="#cb311-48" tabindex="-1"></a>        ha<span class="op">=</span><span class="st">&#39;center&#39;</span>,</span>
<span id="cb311-49"><a href="#cb311-49" tabindex="-1"></a>        va<span class="op">=</span><span class="st">&#39;center&#39;</span>,</span>
<span id="cb311-50"><a href="#cb311-50" tabindex="-1"></a>        fontsize<span class="op">=</span><span class="dv">12</span>,</span>
<span id="cb311-51"><a href="#cb311-51" tabindex="-1"></a>        bbox<span class="op">=</span>bbox_props</span>
<span id="cb311-52"><a href="#cb311-52" tabindex="-1"></a>    )</span></code></pre></div>
<p>Create a plot showing different parts of a matplotlib figure.</p>
<div class="sourceCode" id="cb312"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb312-1"><a href="#cb312-1" tabindex="-1"></a>fig, axes <span class="op">=</span> plt.subplots(<span class="dv">2</span>, <span class="dv">2</span>,edgecolor<span class="op">=</span><span class="st">&#39;black&#39;</span>)</span>
<span id="cb312-2"><a href="#cb312-2" tabindex="-1"></a>fig.set_size_inches(<span class="fl">7.5</span>, <span class="fl">7.5</span>)</span>
<span id="cb312-3"><a href="#cb312-3" tabindex="-1"></a></span>
<span id="cb312-4"><a href="#cb312-4" tabindex="-1"></a><span class="cf">for</span> index, ax <span class="kw">in</span> <span class="bu">enumerate</span>(axes.flat):</span>
<span id="cb312-5"><a href="#cb312-5" tabindex="-1"></a>    da <span class="op">=</span> datasets[index]</span>
<span id="cb312-6"><a href="#cb312-6" tabindex="-1"></a>    im <span class="op">=</span> da.plot.imshow(ax<span class="op">=</span>ax, cmap<span class="op">=</span><span class="st">&#39;Greys_r&#39;</span>,add_colorbar<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb312-7"><a href="#cb312-7" tabindex="-1"></a>    filename <span class="op">=</span> srtm_tiles[index]</span>
<span id="cb312-8"><a href="#cb312-8" tabindex="-1"></a>    ax.margins(<span class="fl">0.2</span>) <span class="co"># Add padding around the axes</span></span>
<span id="cb312-9"><a href="#cb312-9" tabindex="-1"></a>    ax.tick_params(axis<span class="op">=</span><span class="st">&#39;both&#39;</span>, which<span class="op">=</span><span class="st">&#39;major&#39;</span>, labelsize<span class="op">=</span><span class="dv">7</span>)</span>
<span id="cb312-10"><a href="#cb312-10" tabindex="-1"></a>    ax.set_title(<span class="st">&#39;&#39;</span>)</span>
<span id="cb312-11"><a href="#cb312-11" tabindex="-1"></a>    ax.set_xlabel(<span class="st">&#39;longitude&#39;</span>,fontsize <span class="op">=</span> <span class="dv">7</span>)</span>
<span id="cb312-12"><a href="#cb312-12" tabindex="-1"></a>    ax.set_ylabel(<span class="st">&#39;latitude&#39;</span>,fontsize <span class="op">=</span> <span class="dv">7</span>)</span>
<span id="cb312-13"><a href="#cb312-13" tabindex="-1"></a>    ax.set_aspect(<span class="st">&#39;equal&#39;</span>) <span class="co"># maintain aspect ratio</span></span>
<span id="cb312-14"><a href="#cb312-14" tabindex="-1"></a></span>
<span id="cb312-15"><a href="#cb312-15" tabindex="-1"></a>plt.suptitle(<span class="st">&#39;SRTM 30m Elevation Tiles&#39;</span>, fontsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb312-16"><a href="#cb312-16" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb312-17"><a href="#cb312-17" tabindex="-1"></a></span>
<span id="cb312-18"><a href="#cb312-18" tabindex="-1"></a><span class="co"># Add a frame</span></span>
<span id="cb312-19"><a href="#cb312-19" tabindex="-1"></a>frame <span class="op">=</span> patches.Rectangle((<span class="dv">0</span>, <span class="dv">0</span>), <span class="dv">1</span>, <span class="dv">1</span>,</span>
<span id="cb312-20"><a href="#cb312-20" tabindex="-1"></a>                          transform<span class="op">=</span>fig.transFigure,</span>
<span id="cb312-21"><a href="#cb312-21" tabindex="-1"></a>                          edgecolor<span class="op">=</span><span class="st">&#39;black&#39;</span>,</span>
<span id="cb312-22"><a href="#cb312-22" tabindex="-1"></a>                          facecolor<span class="op">=</span><span class="st">&#39;none&#39;</span>,</span>
<span id="cb312-23"><a href="#cb312-23" tabindex="-1"></a>                          linewidth<span class="op">=</span><span class="fl">1.5</span>)</span>
<span id="cb312-24"><a href="#cb312-24" tabindex="-1"></a>fig.patches.append(frame)</span>
<span id="cb312-25"><a href="#cb312-25" tabindex="-1"></a></span>
<span id="cb312-26"><a href="#cb312-26" tabindex="-1"></a>output_path <span class="op">=</span> os.path.join(output_folder, <span class="st">&#39;frame.png&#39;</span>)</span>
<span id="cb312-27"><a href="#cb312-27" tabindex="-1"></a>plt.savefig(output_path, dpi<span class="op">=</span><span class="dv">300</span>, bbox_inches<span class="op">=</span><span class="st">&#39;tight&#39;</span>)</span>
<span id="cb312-28"><a href="#cb312-28" tabindex="-1"></a></span>
<span id="cb312-29"><a href="#cb312-29" tabindex="-1"></a><span class="co"># Define the titles and arrow positions</span></span>
<span id="cb312-30"><a href="#cb312-30" tabindex="-1"></a><span class="co"># Tile Text, Arrow Start Coords and Arrow End Coords</span></span>
<span id="cb312-31"><a href="#cb312-31" tabindex="-1"></a>annotations <span class="op">=</span> [</span>
<span id="cb312-32"><a href="#cb312-32" tabindex="-1"></a>    (<span class="st">&#39;Figure&#39;</span>, (<span class="fl">1.15</span>, <span class="fl">0.95</span>), (<span class="fl">0.9</span>, <span class="fl">1.0</span>)),</span>
<span id="cb312-33"><a href="#cb312-33" tabindex="-1"></a>    (<span class="st">&#39;Axes&#39;</span>, (<span class="fl">1.15</span>, <span class="fl">0.8</span>), (<span class="fl">0.75</span>, <span class="fl">0.8</span>)),</span>
<span id="cb312-34"><a href="#cb312-34" tabindex="-1"></a>    (<span class="st">&#39;Axes&#39;</span>, (<span class="fl">1.15</span>, <span class="fl">0.8</span>), (<span class="fl">0.25</span>, <span class="fl">0.8</span>)),</span>
<span id="cb312-35"><a href="#cb312-35" tabindex="-1"></a>    (<span class="st">&#39;Axes&#39;</span>, (<span class="fl">1.15</span>, <span class="fl">0.8</span>), (<span class="fl">0.75</span>, <span class="fl">0.3</span>)),</span>
<span id="cb312-36"><a href="#cb312-36" tabindex="-1"></a>    (<span class="st">&#39;Axes&#39;</span>, (<span class="fl">1.15</span>, <span class="fl">0.8</span>), (<span class="fl">0.25</span>, <span class="fl">0.3</span>)),</span>
<span id="cb312-37"><a href="#cb312-37" tabindex="-1"></a>    (<span class="st">&#39;Y-Axis&#39;</span>, (<span class="op">-</span><span class="fl">0.15</span>, <span class="fl">0.85</span>), (<span class="fl">0.07</span>, <span class="fl">0.80</span>)),</span>
<span id="cb312-38"><a href="#cb312-38" tabindex="-1"></a>    (<span class="st">&#39;X-Axis&#39;</span>, (<span class="op">-</span><span class="fl">0.15</span>, <span class="fl">0.65</span>), (<span class="fl">0.38</span>, <span class="fl">0.52</span>)),</span>
<span id="cb312-39"><a href="#cb312-39" tabindex="-1"></a>    (<span class="st">&#39;Y-Label&#39;</span>, (<span class="op">-</span><span class="fl">0.15</span>, <span class="fl">0.75</span>), (<span class="fl">0.02</span>, <span class="fl">0.72</span>)),</span>
<span id="cb312-40"><a href="#cb312-40" tabindex="-1"></a>    (<span class="st">&#39;X-Label&#39;</span>, (<span class="op">-</span><span class="fl">0.15</span>, <span class="fl">0.55</span>), (<span class="fl">0.25</span>, <span class="fl">0.5</span>)),</span>
<span id="cb312-41"><a href="#cb312-41" tabindex="-1"></a>    (<span class="st">&#39;Y-Ticks&#39;</span>, (<span class="fl">1.15</span>, <span class="fl">0.3</span>), (<span class="fl">0.56</span>, <span class="fl">0.22</span>)),</span>
<span id="cb312-42"><a href="#cb312-42" tabindex="-1"></a>    (<span class="st">&#39;X-Ticks&#39;</span>, (<span class="fl">1.15</span>, <span class="fl">0.2</span>), (<span class="fl">0.82</span>, <span class="fl">0.05</span>)),</span>
<span id="cb312-43"><a href="#cb312-43" tabindex="-1"></a>    (<span class="st">&#39;Spines&#39;</span>, (<span class="op">-</span><span class="fl">0.15</span>, <span class="fl">0.2</span>), (<span class="fl">0.2</span>, <span class="fl">0.46</span>)),</span>
<span id="cb312-44"><a href="#cb312-44" tabindex="-1"></a>    (<span class="st">&#39;Spines&#39;</span>, (<span class="op">-</span><span class="fl">0.15</span>, <span class="fl">0.2</span>), (<span class="fl">0.48</span>, <span class="fl">0.2</span>)),</span>
<span id="cb312-45"><a href="#cb312-45" tabindex="-1"></a>]</span>
<span id="cb312-46"><a href="#cb312-46" tabindex="-1"></a></span>
<span id="cb312-47"><a href="#cb312-47" tabindex="-1"></a><span class="co"># We apply the annotations and also save a series of images</span></span>
<span id="cb312-48"><a href="#cb312-48" tabindex="-1"></a><span class="co"># showing the addition of different elements</span></span>
<span id="cb312-49"><a href="#cb312-49" tabindex="-1"></a><span class="cf">for</span> title_text, arrow_start_coords, arrow_end_coords <span class="kw">in</span> annotations:</span>
<span id="cb312-50"><a href="#cb312-50" tabindex="-1"></a>  add_annotation(fig<span class="op">=</span>fig,</span>
<span id="cb312-51"><a href="#cb312-51" tabindex="-1"></a>               title_text<span class="op">=</span>title_text ,</span>
<span id="cb312-52"><a href="#cb312-52" tabindex="-1"></a>               arrow_start_coords<span class="op">=</span>arrow_start_coords,</span>
<span id="cb312-53"><a href="#cb312-53" tabindex="-1"></a>               arrow_end_coords<span class="op">=</span>arrow_end_coords)</span>
<span id="cb312-54"><a href="#cb312-54" tabindex="-1"></a>  output_path <span class="op">=</span> os.path.join(output_folder, title_text.lower())</span>
<span id="cb312-55"><a href="#cb312-55" tabindex="-1"></a>  plt.savefig(output_path, dpi<span class="op">=</span><span class="dv">300</span>, bbox_inches<span class="op">=</span><span class="st">&#39;tight&#39;</span>)</span>
<span id="cb312-56"><a href="#cb312-56" tabindex="-1"></a></span>
<span id="cb312-57"><a href="#cb312-57" tabindex="-1"></a>plt.show()</span></code></pre></div>
<p><img
src="python-dataviz-output/supplement_matplotlib_anatomy_files/supplement_matplotlib_anatomy_12_0.png" /></p>
</div>
</div>
</div>
<div id="animation" class="section level2">
<h2>Animation</h2>
<p><a
href="https://colab.research.google.com/github/spatialthoughts/python-dataviz-web/blob/main/supplement_animating_maps.ipynb"><img
src="https://colab.research.google.com/assets/colab-badge.svg"
alt="Open In Colab" /></a></p>
<div id="creating-animated-maps" class="section level3">
<h3>Creating Animated Maps</h3>
<p>We take the dataset for 2017 solar eclipse and animate the path of
the solar eclipse.</p>
<p><img src='https://courses.spatialthoughts.com/images/python_dataviz/eclipse_animation.gif' width=600/></p>
<div id="setup-and-data-download-18" class="section level4">
<h4>Setup and Data Download</h4>
<p>The following blocks of code will install the required packages and
download the datasets to your Colab environment.</p>
<div class="sourceCode" id="cb313"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb313-1"><a href="#cb313-1" tabindex="-1"></a><span class="op">%%</span>capture</span>
<span id="cb313-2"><a href="#cb313-2" tabindex="-1"></a><span class="cf">if</span> <span class="st">&#39;google.colab&#39;</span> <span class="kw">in</span> <span class="bu">str</span>(get_ipython()):</span>
<span id="cb313-3"><a href="#cb313-3" tabindex="-1"></a>  <span class="op">!</span>pip install contextily</span></code></pre></div>
<div class="sourceCode" id="cb314"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb314-1"><a href="#cb314-1" tabindex="-1"></a><span class="im">import</span> requests</span>
<span id="cb314-2"><a href="#cb314-2" tabindex="-1"></a><span class="im">import</span> contextily <span class="im">as</span> cx</span>
<span id="cb314-3"><a href="#cb314-3" tabindex="-1"></a><span class="im">import</span> geopandas <span class="im">as</span> gpd</span>
<span id="cb314-4"><a href="#cb314-4" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb314-5"><a href="#cb314-5" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb314-6"><a href="#cb314-6" tabindex="-1"></a><span class="im">from</span> matplotlib.animation <span class="im">import</span> FuncAnimation, PillowWriter</span>
<span id="cb314-7"><a href="#cb314-7" tabindex="-1"></a><span class="im">import</span> shapely</span></code></pre></div>
<div class="sourceCode" id="cb315"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb315-1"><a href="#cb315-1" tabindex="-1"></a>data_folder <span class="op">=</span> <span class="st">&#39;data&#39;</span></span>
<span id="cb315-2"><a href="#cb315-2" tabindex="-1"></a>output_folder <span class="op">=</span> <span class="st">&#39;output&#39;</span></span>
<span id="cb315-3"><a href="#cb315-3" tabindex="-1"></a></span>
<span id="cb315-4"><a href="#cb315-4" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> os.path.exists(data_folder):</span>
<span id="cb315-5"><a href="#cb315-5" tabindex="-1"></a>    os.mkdir(data_folder)</span>
<span id="cb315-6"><a href="#cb315-6" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> os.path.exists(output_folder):</span>
<span id="cb315-7"><a href="#cb315-7" tabindex="-1"></a>    os.mkdir(output_folder)</span></code></pre></div>
<div class="sourceCode" id="cb316"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb316-1"><a href="#cb316-1" tabindex="-1"></a><span class="kw">def</span> download(url):</span>
<span id="cb316-2"><a href="#cb316-2" tabindex="-1"></a>    filename <span class="op">=</span> os.path.join(data_folder, os.path.basename(url))</span>
<span id="cb316-3"><a href="#cb316-3" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> os.path.exists(filename):</span>
<span id="cb316-4"><a href="#cb316-4" tabindex="-1"></a>      <span class="cf">with</span> requests.get(url, stream<span class="op">=</span><span class="va">True</span>, allow_redirects<span class="op">=</span><span class="va">True</span>) <span class="im">as</span> r:</span>
<span id="cb316-5"><a href="#cb316-5" tabindex="-1"></a>          <span class="cf">with</span> <span class="bu">open</span>(filename, <span class="st">&#39;wb&#39;</span>) <span class="im">as</span> f:</span>
<span id="cb316-6"><a href="#cb316-6" tabindex="-1"></a>              <span class="cf">for</span> chunk <span class="kw">in</span> r.iter_content(chunk_size<span class="op">=</span><span class="dv">8192</span>):</span>
<span id="cb316-7"><a href="#cb316-7" tabindex="-1"></a>                  f.write(chunk)</span>
<span id="cb316-8"><a href="#cb316-8" tabindex="-1"></a>      <span class="bu">print</span>(<span class="st">&#39;Downloaded&#39;</span>, filename)</span></code></pre></div>
<div class="sourceCode" id="cb317"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb317-1"><a href="#cb317-1" tabindex="-1"></a>path_shapefile <span class="op">=</span> <span class="st">&#39;upath17&#39;</span></span>
<span id="cb317-2"><a href="#cb317-2" tabindex="-1"></a>umbra_shapefile <span class="op">=</span> <span class="st">&#39;umbra17&#39;</span></span>
<span id="cb317-3"><a href="#cb317-3" tabindex="-1"></a>shapefile_exts <span class="op">=</span> [<span class="st">&#39;.shp&#39;</span>, <span class="st">&#39;.shx&#39;</span>, <span class="st">&#39;.dbf&#39;</span>, <span class="st">&#39;.prj&#39;</span>]</span>
<span id="cb317-4"><a href="#cb317-4" tabindex="-1"></a>data_url <span class="op">=</span> <span class="st">&#39;https://github.com/spatialthoughts/python-dataviz-web/releases/&#39;</span> \</span>
<span id="cb317-5"><a href="#cb317-5" tabindex="-1"></a>  <span class="st">&#39;download/eclipse/&#39;</span></span>
<span id="cb317-6"><a href="#cb317-6" tabindex="-1"></a></span>
<span id="cb317-7"><a href="#cb317-7" tabindex="-1"></a><span class="cf">for</span> shapefile <span class="kw">in</span> [path_shapefile, umbra_shapefile]:</span>
<span id="cb317-8"><a href="#cb317-8" tabindex="-1"></a>  <span class="cf">for</span> ext <span class="kw">in</span> shapefile_exts:</span>
<span id="cb317-9"><a href="#cb317-9" tabindex="-1"></a>    url <span class="op">=</span> data_url <span class="op">+</span> shapefile <span class="op">+</span> ext</span>
<span id="cb317-10"><a href="#cb317-10" tabindex="-1"></a>    download(url)</span></code></pre></div>
</div>
<div id="data-pre-processing-11" class="section level4">
<h4>Data Pre-Processing</h4>
<div class="sourceCode" id="cb318"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb318-1"><a href="#cb318-1" tabindex="-1"></a>path_shapefile_path <span class="op">=</span> os.path.join(data_folder, path_shapefile <span class="op">+</span> <span class="st">&#39;.shp&#39;</span>)</span>
<span id="cb318-2"><a href="#cb318-2" tabindex="-1"></a>path_gdf <span class="op">=</span> gpd.read_file(path_shapefile_path)</span></code></pre></div>
<div class="sourceCode" id="cb319"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb319-1"><a href="#cb319-1" tabindex="-1"></a>umbra_shapefile_path <span class="op">=</span> os.path.join(data_folder, umbra_shapefile <span class="op">+</span> <span class="st">&#39;.shp&#39;</span>)</span>
<span id="cb319-2"><a href="#cb319-2" tabindex="-1"></a>umbra_gdf <span class="op">=</span> gpd.read_file(umbra_shapefile_path)</span></code></pre></div>
<div class="sourceCode" id="cb320"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb320-1"><a href="#cb320-1" tabindex="-1"></a>crs <span class="op">=</span> <span class="st">&#39;EPSG:9311&#39;</span></span>
<span id="cb320-2"><a href="#cb320-2" tabindex="-1"></a></span>
<span id="cb320-3"><a href="#cb320-3" tabindex="-1"></a>path_reprojected <span class="op">=</span> path_gdf.to_crs(crs)</span>
<span id="cb320-4"><a href="#cb320-4" tabindex="-1"></a>umbra_reprojected <span class="op">=</span> umbra_gdf.to_crs(crs)</span>
<span id="cb320-5"><a href="#cb320-5" tabindex="-1"></a></span>
<span id="cb320-6"><a href="#cb320-6" tabindex="-1"></a><span class="co"># Use the bounding box coordinates for continental us</span></span>
<span id="cb320-7"><a href="#cb320-7" tabindex="-1"></a>usa <span class="op">=</span> shapely.geometry.box(<span class="op">-</span><span class="dv">125</span>, <span class="dv">24</span>, <span class="op">-</span><span class="dv">66</span>, <span class="dv">49</span>)</span>
<span id="cb320-8"><a href="#cb320-8" tabindex="-1"></a>usa_gdf <span class="op">=</span> gpd.GeoDataFrame(geometry<span class="op">=</span>[usa], crs<span class="op">=</span><span class="st">&#39;EPSG:4326&#39;</span>)</span>
<span id="cb320-9"><a href="#cb320-9" tabindex="-1"></a>usa_gdf_reprojected <span class="op">=</span> usa_gdf.to_crs(crs)</span>
<span id="cb320-10"><a href="#cb320-10" tabindex="-1"></a>bounds <span class="op">=</span> usa_gdf_reprojected.total_bounds</span></code></pre></div>
<div class="sourceCode" id="cb321"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb321-1"><a href="#cb321-1" tabindex="-1"></a>path_boundary <span class="op">=</span> path_reprojected.geometry.unary_union</span>
<span id="cb321-2"><a href="#cb321-2" tabindex="-1"></a>umbra_subset <span class="op">=</span> umbra_reprojected[umbra_reprojected.geometry.intersects(path_boundary)]</span></code></pre></div>
</div>
<div id="creating-animation" class="section level4">
<h4>Creating Animation</h4>
<p>We use Matplotlibs <code>FuncAnimation</code> function from the
<code>animation</code> module to create an animation with each frame
showing the position of the umbra through the solar eclipse.</p>
<p>Reference: <a
href="https://matplotlib.org/stable/api/_as_gen/matplotlib.animation.FuncAnimation.html"><code>matplotlib.animation.FuncAnimation</code></a></p>
<div class="sourceCode" id="cb322"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb322-1"><a href="#cb322-1" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb322-2"><a href="#cb322-2" tabindex="-1"></a>fig.set_size_inches(<span class="dv">15</span>,<span class="dv">7</span>)</span>
<span id="cb322-3"><a href="#cb322-3" tabindex="-1"></a></span>
<span id="cb322-4"><a href="#cb322-4" tabindex="-1"></a><span class="kw">def</span> animate(i):</span>
<span id="cb322-5"><a href="#cb322-5" tabindex="-1"></a>    ax.clear()</span>
<span id="cb322-6"><a href="#cb322-6" tabindex="-1"></a>    <span class="co"># Set the bounds</span></span>
<span id="cb322-7"><a href="#cb322-7" tabindex="-1"></a>    ax.set_xlim(bounds[<span class="dv">0</span>], bounds[<span class="dv">2</span>])</span>
<span id="cb322-8"><a href="#cb322-8" tabindex="-1"></a>    ax.set_ylim(bounds[<span class="dv">1</span>], bounds[<span class="dv">3</span>])</span>
<span id="cb322-9"><a href="#cb322-9" tabindex="-1"></a>    <span class="co"># Get the point from the points list at index i</span></span>
<span id="cb322-10"><a href="#cb322-10" tabindex="-1"></a>    umbra_filtered <span class="op">=</span> umbra_subset.iloc[i:i<span class="op">+</span><span class="dv">1</span>]</span>
<span id="cb322-11"><a href="#cb322-11" tabindex="-1"></a></span>
<span id="cb322-12"><a href="#cb322-12" tabindex="-1"></a>    path_reprojected.plot(</span>
<span id="cb322-13"><a href="#cb322-13" tabindex="-1"></a>      ax<span class="op">=</span>ax,</span>
<span id="cb322-14"><a href="#cb322-14" tabindex="-1"></a>      facecolor<span class="op">=</span><span class="st">&#39;#969696&#39;</span>,</span>
<span id="cb322-15"><a href="#cb322-15" tabindex="-1"></a>      edgecolor<span class="op">=</span><span class="st">&#39;none&#39;</span>,</span>
<span id="cb322-16"><a href="#cb322-16" tabindex="-1"></a>      alpha<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb322-17"><a href="#cb322-17" tabindex="-1"></a>    umbra_filtered.plot(</span>
<span id="cb322-18"><a href="#cb322-18" tabindex="-1"></a>      ax<span class="op">=</span>ax,</span>
<span id="cb322-19"><a href="#cb322-19" tabindex="-1"></a>      facecolor<span class="op">=</span><span class="st">&#39;#252525&#39;</span>,</span>
<span id="cb322-20"><a href="#cb322-20" tabindex="-1"></a>      edgecolor<span class="op">=</span><span class="st">&#39;none&#39;</span>)</span>
<span id="cb322-21"><a href="#cb322-21" tabindex="-1"></a>    cx.add_basemap(ax,</span>
<span id="cb322-22"><a href="#cb322-22" tabindex="-1"></a>      crs<span class="op">=</span>path_reprojected.crs,</span>
<span id="cb322-23"><a href="#cb322-23" tabindex="-1"></a>      source<span class="op">=</span>cx.providers.OpenTopoMap,</span>
<span id="cb322-24"><a href="#cb322-24" tabindex="-1"></a>      zoom<span class="op">=</span><span class="dv">5</span>)</span>
<span id="cb322-25"><a href="#cb322-25" tabindex="-1"></a>    ax.set_axis_off()</span>
<span id="cb322-26"><a href="#cb322-26" tabindex="-1"></a>    props <span class="op">=</span> <span class="bu">dict</span>(boxstyle<span class="op">=</span><span class="st">&#39;round&#39;</span>, facecolor<span class="op">=</span><span class="st">&#39;wheat&#39;</span>, alpha<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb322-27"><a href="#cb322-27" tabindex="-1"></a>    time <span class="op">=</span> umbra_filtered.iloc[<span class="dv">0</span>].Time</span>
<span id="cb322-28"><a href="#cb322-28" tabindex="-1"></a>    text <span class="op">=</span> <span class="st">&#39;Time: </span><span class="sc">{}</span><span class="st"> UTC&#39;</span>.<span class="bu">format</span>(time)</span>
<span id="cb322-29"><a href="#cb322-29" tabindex="-1"></a>    ax.text(<span class="fl">0.05</span>, <span class="fl">0.20</span>, text, transform<span class="op">=</span>ax.transAxes, fontsize<span class="op">=</span><span class="dv">16</span>,</span>
<span id="cb322-30"><a href="#cb322-30" tabindex="-1"></a>            verticalalignment<span class="op">=</span><span class="st">&#39;top&#39;</span>, bbox<span class="op">=</span>props)</span>
<span id="cb322-31"><a href="#cb322-31" tabindex="-1"></a>    ax.set_title(<span class="st">&#39;2017 Total Solar Eclipse Path&#39;</span>, size <span class="op">=</span> <span class="dv">18</span>)</span>
<span id="cb322-32"><a href="#cb322-32" tabindex="-1"></a></span>
<span id="cb322-33"><a href="#cb322-33" tabindex="-1"></a>ani <span class="op">=</span> FuncAnimation(fig, animate, frames<span class="op">=</span><span class="bu">len</span>(umbra_subset),</span>
<span id="cb322-34"><a href="#cb322-34" tabindex="-1"></a>                    interval<span class="op">=</span><span class="dv">500</span>, repeat<span class="op">=</span><span class="va">True</span>, cache_frame_data<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb322-35"><a href="#cb322-35" tabindex="-1"></a>plt.close()</span></code></pre></div>
<div class="sourceCode" id="cb323"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb323-1"><a href="#cb323-1" tabindex="-1"></a>output_folder <span class="op">=</span> <span class="st">&#39;output&#39;</span></span>
<span id="cb323-2"><a href="#cb323-2" tabindex="-1"></a>output_path <span class="op">=</span> os.path.join(output_folder, <span class="st">&#39;solar_eclipse.gif&#39;</span>)</span>
<span id="cb323-3"><a href="#cb323-3" tabindex="-1"></a></span>
<span id="cb323-4"><a href="#cb323-4" tabindex="-1"></a>ani.save(output_path, writer<span class="op">=</span>PillowWriter(fps<span class="op">=</span><span class="dv">5</span>))</span>
<span id="cb323-5"><a href="#cb323-5" tabindex="-1"></a>plt.close()</span></code></pre></div>
</div>
</div>
</div>
<div id="leafmap" class="section level2">
<h2>Leafmap</h2>
<p><a
href="https://colab.research.google.com/github/spatialthoughts/python-dataviz-web/blob/main/supplement_leafmap_osm.ipynb"><img
src="https://colab.research.google.com/assets/colab-badge.svg"
alt="Open In Colab" /></a></p>
<div id="downloading-and-visualizing-osm-data-with-leafmap"
class="section level3">
<h3>Downloading and Visualizing OSM Data with LeafMap</h3>
<p>We can use the popular package OSMNx to download data from the OSM
database and visualize it using leafmap.</p>
<p><img src='https://courses.spatialthoughts.com/images/python_dataviz/leafmap_osm.png' width=600/></p>
<div id="setup-and-data-download-19" class="section level4">
<h4>Setup and Data Download</h4>
<div class="sourceCode" id="cb324"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb324-1"><a href="#cb324-1" tabindex="-1"></a><span class="op">%%</span>capture</span>
<span id="cb324-2"><a href="#cb324-2" tabindex="-1"></a><span class="cf">if</span> <span class="st">&#39;google.colab&#39;</span> <span class="kw">in</span> <span class="bu">str</span>(get_ipython()):</span>
<span id="cb324-3"><a href="#cb324-3" tabindex="-1"></a>  <span class="op">!</span>pip install leafmap osmnx mapclassify</span></code></pre></div>
<div class="sourceCode" id="cb325"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb325-1"><a href="#cb325-1" tabindex="-1"></a><span class="im">import</span> folium</span>
<span id="cb325-2"><a href="#cb325-2" tabindex="-1"></a><span class="im">import</span> geopandas <span class="im">as</span> gpd</span>
<span id="cb325-3"><a href="#cb325-3" tabindex="-1"></a><span class="im">import</span> leafmap.foliumap <span class="im">as</span> leafmap</span>
<span id="cb325-4"><a href="#cb325-4" tabindex="-1"></a><span class="im">import</span> osmnx <span class="im">as</span> ox</span>
<span id="cb325-5"><a href="#cb325-5" tabindex="-1"></a><span class="im">import</span> os</span></code></pre></div>
<div class="sourceCode" id="cb326"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb326-1"><a href="#cb326-1" tabindex="-1"></a>data_folder <span class="op">=</span> <span class="st">&#39;data&#39;</span></span>
<span id="cb326-2"><a href="#cb326-2" tabindex="-1"></a>output_folder <span class="op">=</span> <span class="st">&#39;output&#39;</span></span>
<span id="cb326-3"><a href="#cb326-3" tabindex="-1"></a></span>
<span id="cb326-4"><a href="#cb326-4" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> os.path.exists(data_folder):</span>
<span id="cb326-5"><a href="#cb326-5" tabindex="-1"></a>    os.mkdir(data_folder)</span>
<span id="cb326-6"><a href="#cb326-6" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> os.path.exists(output_folder):</span>
<span id="cb326-7"><a href="#cb326-7" tabindex="-1"></a>    os.mkdir(output_folder)</span></code></pre></div>
</div>
<div id="downloading-osm-data" class="section level4">
<h4>Downloading OSM Data</h4>
<p>We can easily download data for a city or a region by its name using
the <code>osmnx.features.features_from_place()</code> function. We can
specify the list of required tags using a dictionary. See <a
href="https://wiki.openstreetmap.org/wiki/Map_features">OSM Wiki</a> for
a complete list of tags and values.</p>
<p>You can also download data using a bounding box using
<code>osmnx.features.features_from_bbox()</code> function.</p>
<p>Reference: <a
href="https://osmnx.readthedocs.io/en/stable/user-reference.html#osmnx.features.features_from_place"><code>osmnx.features.features_from_place</code></a></p>
<div class="sourceCode" id="cb327"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb327-1"><a href="#cb327-1" tabindex="-1"></a>parking_gdf <span class="op">=</span> ox.features.features_from_place(</span>
<span id="cb327-2"><a href="#cb327-2" tabindex="-1"></a>    query<span class="op">=</span><span class="st">&#39;Bangalore&#39;</span>,</span>
<span id="cb327-3"><a href="#cb327-3" tabindex="-1"></a>    tags<span class="op">=</span>{<span class="st">&#39;amenity&#39;</span>: [<span class="st">&#39;parking&#39;</span>, <span class="st">&#39;parking_space&#39;</span>, <span class="st">&#39;parking_entrance&#39;</span>]}</span>
<span id="cb327-4"><a href="#cb327-4" tabindex="-1"></a>  )</span></code></pre></div>
<p>The GeoDataFrame has a hierarchical MultiIndex. Let’s flatten it
using <code>reset_index()</code></p>
<div class="sourceCode" id="cb328"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb328-1"><a href="#cb328-1" tabindex="-1"></a>parking_gdf <span class="op">=</span> parking_gdf.reset_index(level<span class="op">=</span>[<span class="dv">0</span>,<span class="dv">1</span>])</span></code></pre></div>
<p>The result has many columns. Let’s filter to required columns.</p>
<div class="sourceCode" id="cb329"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb329-1"><a href="#cb329-1" tabindex="-1"></a>parking_gdf_subset <span class="op">=</span> parking_gdf[[<span class="st">&#39;amenity&#39;</span>,<span class="st">&#39;parking&#39;</span>, <span class="st">&#39;access&#39;</span>, <span class="st">&#39;geometry&#39;</span>]]</span></code></pre></div>
<p>The results contains both points and polygon features. Let’s separate
them out.</p>
<div class="sourceCode" id="cb330"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb330-1"><a href="#cb330-1" tabindex="-1"></a>parking_zones <span class="op">=</span> parking_gdf_subset[</span>
<span id="cb330-2"><a href="#cb330-2" tabindex="-1"></a>    parking_gdf_subset[<span class="st">&#39;geometry&#39;</span>].<span class="bu">apply</span>(<span class="kw">lambda</span> x : x.geom_type <span class="op">==</span> <span class="st">&#39;Polygon&#39;</span> )]</span>
<span id="cb330-3"><a href="#cb330-3" tabindex="-1"></a>parking_locations <span class="op">=</span> parking_gdf_subset[</span>
<span id="cb330-4"><a href="#cb330-4" tabindex="-1"></a>    parking_gdf_subset[<span class="st">&#39;geometry&#39;</span>].<span class="bu">apply</span>(<span class="kw">lambda</span> x : x.geom_type <span class="op">==</span> <span class="st">&#39;Point&#39;</span> )]</span></code></pre></div>
<p>We can save the resulting GeoDataFrame to a GeoPackage.</p>
<div class="sourceCode" id="cb331"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb331-1"><a href="#cb331-1" tabindex="-1"></a>output_file <span class="op">=</span> <span class="st">&#39;parking.gpkg&#39;</span></span>
<span id="cb331-2"><a href="#cb331-2" tabindex="-1"></a>output_path <span class="op">=</span> os.path.join(output_folder, output_file)</span>
<span id="cb331-3"><a href="#cb331-3" tabindex="-1"></a>parking_zones.to_file(driver<span class="op">=</span><span class="st">&#39;GPKG&#39;</span>, filename<span class="op">=</span>output_path, layer<span class="op">=</span><span class="st">&#39;zones&#39;</span>)</span>
<span id="cb331-4"><a href="#cb331-4" tabindex="-1"></a>parking_locations.to_file(driver<span class="op">=</span><span class="st">&#39;GPKG&#39;</span>, filename<span class="op">=</span>output_path, layer<span class="op">=</span><span class="st">&#39;locations&#39;</span>)</span></code></pre></div>
</div>
<div id="visualizing-osm-data" class="section level4">
<h4>Visualizing OSM Data</h4>
<p>For visualizing the data, we first download the city boundary from
OSM. We use <code>osmnx.geocoder.geocode_to_gdf</code> function to
extract the boundary as a GeoDataFrame.</p>
<p>Reference: <a
href="https://osmnx.readthedocs.io/en/stable/user-reference.html#osmnx.geocoder.geocode_to_gdf"><code>osmnx.geocoder.geocode_to_gdf</code></a></p>
<div class="sourceCode" id="cb332"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb332-1"><a href="#cb332-1" tabindex="-1"></a>boundary <span class="op">=</span> ox.geocoder.geocode_to_gdf(query<span class="op">=</span><span class="st">&#39;Bangalore&#39;</span>)</span></code></pre></div>
<p>We initialize a leafmap Map and select a basemap. See all available
basemaps names using <code>leafmap.basemaps.keys()</code>.</p>
<div class="sourceCode" id="cb333"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb333-1"><a href="#cb333-1" tabindex="-1"></a>m <span class="op">=</span> leafmap.Map(width<span class="op">=</span><span class="dv">800</span>, height<span class="op">=</span><span class="dv">500</span>)</span>
<span id="cb333-2"><a href="#cb333-2" tabindex="-1"></a>m.add_basemap(<span class="st">&#39;CartoDB.DarkMatter&#39;</span>)</span>
<span id="cb333-3"><a href="#cb333-3" tabindex="-1"></a>m</span></code></pre></div>
<p>We can add the GeoDataFrame to the map as well using GeoPanda’s
<code>explore()</code> function which allows us to customize the
marker’s shape, size for the point layer.</p>
<div class="sourceCode" id="cb334"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb334-1"><a href="#cb334-1" tabindex="-1"></a>m <span class="op">=</span> leafmap.Map(width<span class="op">=</span><span class="dv">800</span>, height<span class="op">=</span><span class="dv">500</span>)</span>
<span id="cb334-2"><a href="#cb334-2" tabindex="-1"></a>m.add_basemap(<span class="st">&#39;CartoDB.DarkMatter&#39;</span>)</span>
<span id="cb334-3"><a href="#cb334-3" tabindex="-1"></a>m.zoom_to_gdf(boundary)</span>
<span id="cb334-4"><a href="#cb334-4" tabindex="-1"></a></span>
<span id="cb334-5"><a href="#cb334-5" tabindex="-1"></a>boundary.explore(</span>
<span id="cb334-6"><a href="#cb334-6" tabindex="-1"></a>  style_kwds<span class="op">=</span>{<span class="st">&#39;fillColor&#39;</span>: <span class="st">&#39;None&#39;</span>, <span class="st">&#39;color&#39;</span>: <span class="st">&#39;blue&#39;</span>},</span>
<span id="cb334-7"><a href="#cb334-7" tabindex="-1"></a>  m<span class="op">=</span>m,</span>
<span id="cb334-8"><a href="#cb334-8" tabindex="-1"></a>  name<span class="op">=</span><span class="st">&#39;Bangalore&#39;</span></span>
<span id="cb334-9"><a href="#cb334-9" tabindex="-1"></a>)</span>
<span id="cb334-10"><a href="#cb334-10" tabindex="-1"></a></span>
<span id="cb334-11"><a href="#cb334-11" tabindex="-1"></a>parking_zones.explore(</span>
<span id="cb334-12"><a href="#cb334-12" tabindex="-1"></a>    style_kwds<span class="op">=</span>{<span class="st">&#39;fillOpacity&#39;</span>: <span class="fl">0.3</span>, <span class="st">&#39;weight&#39;</span>: <span class="fl">0.5</span>},</span>
<span id="cb334-13"><a href="#cb334-13" tabindex="-1"></a>    color<span class="op">=</span><span class="st">&#39;orange&#39;</span>,</span>
<span id="cb334-14"><a href="#cb334-14" tabindex="-1"></a>    name<span class="op">=</span><span class="st">&#39;parking zones&#39;</span>,</span>
<span id="cb334-15"><a href="#cb334-15" tabindex="-1"></a>    m<span class="op">=</span>m)</span>
<span id="cb334-16"><a href="#cb334-16" tabindex="-1"></a></span>
<span id="cb334-17"><a href="#cb334-17" tabindex="-1"></a>parking_locations.explore(</span>
<span id="cb334-18"><a href="#cb334-18" tabindex="-1"></a>    marker_type<span class="op">=</span><span class="st">&#39;circle&#39;</span>,</span>
<span id="cb334-19"><a href="#cb334-19" tabindex="-1"></a>    marker_kwds<span class="op">=</span>{<span class="st">&#39;radius&#39;</span>: <span class="dv">1</span>},</span>
<span id="cb334-20"><a href="#cb334-20" tabindex="-1"></a>    color<span class="op">=</span><span class="st">&#39;yellow&#39;</span>,</span>
<span id="cb334-21"><a href="#cb334-21" tabindex="-1"></a>    name<span class="op">=</span><span class="st">&#39;parking locations&#39;</span>,</span>
<span id="cb334-22"><a href="#cb334-22" tabindex="-1"></a>    m<span class="op">=</span>m)</span>
<span id="cb334-23"><a href="#cb334-23" tabindex="-1"></a>m</span></code></pre></div>
<p><a
href="https://colab.research.google.com/github/spatialthoughts/python-dataviz-web/blob/main/supplement_lonboard_leafmap.ipynb"><img
src="https://colab.research.google.com/assets/colab-badge.svg"
alt="Open In Colab" /></a></p>
</div>
</div>
<div id="visualizing-large-vector-datasets-with-lonboard"
class="section level3">
<h3>Visualizing Large Vector Datasets with Lonboard</h3>
<p><a href="https://github.com/developmentseed/lonboard">Lonboard</a> is
a deck-gl based Python library that allows you to interactively
visualize large vector datasets. You can use Lonboard in Leafmap via the
<a href="https://leafmap.org/deckgl/">deckgl module</a>.</p>
<p>Lonboard uses a different terminology for different types of vector
layers.</p>
<ul>
<li><a
href="https://developmentseed.org/lonboard/latest/api/layers/scatterplot-layer/">ScatterplotLayer</a>:
Reders points as circles.</li>
<li><a
href="https://developmentseed.org/lonboard/latest/api/layers/path-layer/">PathLayer</a>:
Renders polylines.</li>
<li><a
href="https://developmentseed.org/lonboard/latest/api/layers/solid-polygon-layer/">SolidPolygonLayer</a>:
Renders filled and/or extruded polygons.</li>
</ul>
<p>When visualizing vector data via lonboard, please refer to the
documentation for appropriate class for the parameter values.</p>
<p>We will visualize and style a very large layer of rivers using
Leafmap and Lonboard.</p>
<p><img src='https://courses.spatialthoughts.com/images/python_dataviz/lonboard_rivers.png' width=800/></p>
<div id="setup-and-data-download-20" class="section level4">
<h4>Setup and Data Download</h4>
<div class="sourceCode" id="cb335"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb335-1"><a href="#cb335-1" tabindex="-1"></a><span class="op">%%</span>capture</span>
<span id="cb335-2"><a href="#cb335-2" tabindex="-1"></a><span class="cf">if</span> <span class="st">&#39;google.colab&#39;</span> <span class="kw">in</span> <span class="bu">str</span>(get_ipython()):</span>
<span id="cb335-3"><a href="#cb335-3" tabindex="-1"></a>  <span class="op">!</span>pip install leafmap lonboard palettable</span></code></pre></div>
<div class="sourceCode" id="cb336"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb336-1"><a href="#cb336-1" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb336-2"><a href="#cb336-2" tabindex="-1"></a><span class="im">import</span> leafmap.deckgl <span class="im">as</span> leafmap</span>
<span id="cb336-3"><a href="#cb336-3" tabindex="-1"></a><span class="im">import</span> geopandas <span class="im">as</span> gpd</span>
<span id="cb336-4"><a href="#cb336-4" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb336-5"><a href="#cb336-5" tabindex="-1"></a><span class="im">import</span> requests</span>
<span id="cb336-6"><a href="#cb336-6" tabindex="-1"></a><span class="im">import</span> palettable</span>
<span id="cb336-7"><a href="#cb336-7" tabindex="-1"></a><span class="im">import</span> lonboard</span></code></pre></div>
<div class="sourceCode" id="cb337"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb337-1"><a href="#cb337-1" tabindex="-1"></a>data_folder <span class="op">=</span> <span class="st">&#39;data&#39;</span></span>
<span id="cb337-2"><a href="#cb337-2" tabindex="-1"></a>output_folder <span class="op">=</span> <span class="st">&#39;output&#39;</span></span>
<span id="cb337-3"><a href="#cb337-3" tabindex="-1"></a></span>
<span id="cb337-4"><a href="#cb337-4" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> os.path.exists(data_folder):</span>
<span id="cb337-5"><a href="#cb337-5" tabindex="-1"></a>    os.mkdir(data_folder)</span>
<span id="cb337-6"><a href="#cb337-6" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> os.path.exists(output_folder):</span>
<span id="cb337-7"><a href="#cb337-7" tabindex="-1"></a>    os.mkdir(output_folder)</span></code></pre></div>
<div class="sourceCode" id="cb338"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb338-1"><a href="#cb338-1" tabindex="-1"></a><span class="kw">def</span> download(url):</span>
<span id="cb338-2"><a href="#cb338-2" tabindex="-1"></a>    filename <span class="op">=</span> os.path.join(data_folder, os.path.basename(url))</span>
<span id="cb338-3"><a href="#cb338-3" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> os.path.exists(filename):</span>
<span id="cb338-4"><a href="#cb338-4" tabindex="-1"></a>      <span class="cf">with</span> requests.get(url, stream<span class="op">=</span><span class="va">True</span>, allow_redirects<span class="op">=</span><span class="va">True</span>) <span class="im">as</span> r:</span>
<span id="cb338-5"><a href="#cb338-5" tabindex="-1"></a>          <span class="cf">with</span> <span class="bu">open</span>(filename, <span class="st">&#39;wb&#39;</span>) <span class="im">as</span> f:</span>
<span id="cb338-6"><a href="#cb338-6" tabindex="-1"></a>              <span class="cf">for</span> chunk <span class="kw">in</span> r.iter_content(chunk_size<span class="op">=</span><span class="dv">8192</span>):</span>
<span id="cb338-7"><a href="#cb338-7" tabindex="-1"></a>                  f.write(chunk)</span>
<span id="cb338-8"><a href="#cb338-8" tabindex="-1"></a>      <span class="bu">print</span>(<span class="st">&#39;Downloaded&#39;</span>, filename)</span></code></pre></div>
<div class="sourceCode" id="cb339"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb339-1"><a href="#cb339-1" tabindex="-1"></a>countries_file <span class="op">=</span> <span class="st">&#39;ne_10m_admin_0_countries_ind.zip&#39;</span></span>
<span id="cb339-2"><a href="#cb339-2" tabindex="-1"></a></span>
<span id="cb339-3"><a href="#cb339-3" tabindex="-1"></a>data_url <span class="op">=</span> <span class="st">&#39;https://github.com/spatialthoughts/python-dataviz-web/releases/download/&#39;</span></span>
<span id="cb339-4"><a href="#cb339-4" tabindex="-1"></a></span>
<span id="cb339-5"><a href="#cb339-5" tabindex="-1"></a><span class="co"># This is a subset of the main HydroRivers dataset of all</span></span>
<span id="cb339-6"><a href="#cb339-6" tabindex="-1"></a><span class="co"># rivers having `UPLAND_SKM` value  greater than 100 sq. km.</span></span>
<span id="cb339-7"><a href="#cb339-7" tabindex="-1"></a>hydrorivers_file <span class="op">=</span> <span class="st">&#39;hydrorivers_100.gpkg&#39;</span></span>
<span id="cb339-8"><a href="#cb339-8" tabindex="-1"></a>hydrorivers_url <span class="op">=</span> data_url <span class="op">+</span> <span class="st">&#39;hydrosheds/&#39;</span></span>
<span id="cb339-9"><a href="#cb339-9" tabindex="-1"></a></span>
<span id="cb339-10"><a href="#cb339-10" tabindex="-1"></a>countries_file <span class="op">=</span> <span class="st">&#39;ne_10m_admin_0_countries_ind.zip&#39;</span></span>
<span id="cb339-11"><a href="#cb339-11" tabindex="-1"></a>countries_url <span class="op">=</span> data_url <span class="op">+</span> <span class="st">&#39;naturalearth/&#39;</span></span>
<span id="cb339-12"><a href="#cb339-12" tabindex="-1"></a></span>
<span id="cb339-13"><a href="#cb339-13" tabindex="-1"></a></span>
<span id="cb339-14"><a href="#cb339-14" tabindex="-1"></a>download(hydrorivers_url <span class="op">+</span> hydrorivers_file)</span>
<span id="cb339-15"><a href="#cb339-15" tabindex="-1"></a>download(countries_url <span class="op">+</span> countries_file)</span></code></pre></div>
</div>
<div id="data-pre-processing-12" class="section level4">
<h4>Data Pre-Processing</h4>
<p>Read the countries shapefile.</p>
<div class="sourceCode" id="cb340"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb340-1"><a href="#cb340-1" tabindex="-1"></a>countries_filepath <span class="op">=</span> os.path.join(data_folder, countries_file)</span></code></pre></div>
<p>For the assignment, you need to pick the country for which you want
to create the map. We can print a list of values from the
<code>SOVEREIGNT</code> column of <code>country_gdf</code> GeoDataFrame
using <code>country_gdf.SOVEREIGNT.values</code> to know the names of
all countries.</p>
<div class="sourceCode" id="cb341"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb341-1"><a href="#cb341-1" tabindex="-1"></a>country_gdf <span class="op">=</span> gpd.read_file(countries_filepath)</span>
<span id="cb341-2"><a href="#cb341-2" tabindex="-1"></a><span class="bu">print</span>(<span class="bu">sorted</span>(country_gdf.SOVEREIGNT.unique()))</span></code></pre></div>
<p>Select a country name. Replace the value below with your chosen
country.</p>
<div class="sourceCode" id="cb342"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb342-1"><a href="#cb342-1" tabindex="-1"></a>country <span class="op">=</span> <span class="st">&#39;United States of America&#39;</span></span></code></pre></div>
<p>Apply filters to select the country feature. We use an additional
filter <code>TYPE != 'Dependency'</code> to exclude overseas
territories. You may have to adjust the filter to get the correct
country polygon.</p>
<div class="sourceCode" id="cb343"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb343-1"><a href="#cb343-1" tabindex="-1"></a>selected_country <span class="op">=</span> country_gdf[</span>
<span id="cb343-2"><a href="#cb343-2" tabindex="-1"></a>    (country_gdf[<span class="st">&#39;SOVEREIGNT&#39;</span>] <span class="op">==</span> country) <span class="op">&amp;</span></span>
<span id="cb343-3"><a href="#cb343-3" tabindex="-1"></a>    (country_gdf[<span class="st">&#39;TYPE&#39;</span>] <span class="op">!=</span> <span class="st">&#39;Dependency&#39;</span>)</span>
<span id="cb343-4"><a href="#cb343-4" tabindex="-1"></a>]</span>
<span id="cb343-5"><a href="#cb343-5" tabindex="-1"></a>selected_country</span></code></pre></div>
<p>We read the river network data from HydroRivers. We specify the
<code>mask</code> parameter which clips the layer to the country
boundary while reading the data.</p>
<p><em>This step can take a few minutes depending on the size of the
country.</em></p>
<div class="sourceCode" id="cb344"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb344-1"><a href="#cb344-1" tabindex="-1"></a>hydrorivers_filepath <span class="op">=</span> os.path.join(data_folder, hydrorivers_file)</span>
<span id="cb344-2"><a href="#cb344-2" tabindex="-1"></a>river_gdf <span class="op">=</span> gpd.read_file(hydrorivers_filepath, mask<span class="op">=</span>selected_country)</span>
<span id="cb344-3"><a href="#cb344-3" tabindex="-1"></a>river_gdf</span></code></pre></div>
</div>
<div id="visualize-geodataframe-using-lonboard" class="section level4">
<h4>Visualize GeoDataFrame using Lonboard</h4>
<p>Lonboard renders line layers using the <a
href="https://developmentseed.org/lonboard/latest/api/layers/path-layer/"><code>PathLayer</code></a>
object. We supply the lonboard parameters as keyword arguents to
leafmap.</p>
<div class="sourceCode" id="cb345"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb345-1"><a href="#cb345-1" tabindex="-1"></a>m <span class="op">=</span> leafmap.Map(height<span class="op">=</span><span class="dv">600</span>)</span>
<span id="cb345-2"><a href="#cb345-2" tabindex="-1"></a>m.add_gdf(river_gdf,</span>
<span id="cb345-3"><a href="#cb345-3" tabindex="-1"></a>          zoom_to_layer<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb345-4"><a href="#cb345-4" tabindex="-1"></a>          pickable<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb345-5"><a href="#cb345-5" tabindex="-1"></a>          get_width<span class="op">=</span><span class="dv">2</span>,</span>
<span id="cb345-6"><a href="#cb345-6" tabindex="-1"></a>          get_color<span class="op">=</span><span class="st">&#39;blue&#39;</span>,</span>
<span id="cb345-7"><a href="#cb345-7" tabindex="-1"></a>          width_units<span class="op">=</span><span class="st">&#39;pixels&#39;</span></span>
<span id="cb345-8"><a href="#cb345-8" tabindex="-1"></a>)</span>
<span id="cb345-9"><a href="#cb345-9" tabindex="-1"></a>m</span></code></pre></div>
<p>We want to style the rivers so that the width of the line is
proportional to the value in the <code>UPLAND_SKM</code> attribute. We
add a new column <code>width</code> to the GeoDataFrame by scaling the
input values to a range of target widths.</p>
<div class="sourceCode" id="cb346"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb346-1"><a href="#cb346-1" tabindex="-1"></a>original_min <span class="op">=</span> <span class="dv">300</span></span>
<span id="cb346-2"><a href="#cb346-2" tabindex="-1"></a>original_max <span class="op">=</span> <span class="dv">10000</span></span>
<span id="cb346-3"><a href="#cb346-3" tabindex="-1"></a>target_min <span class="op">=</span> <span class="fl">0.1</span></span>
<span id="cb346-4"><a href="#cb346-4" tabindex="-1"></a>target_max <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb346-5"><a href="#cb346-5" tabindex="-1"></a>scaled <span class="op">=</span> (river_gdf[<span class="st">&#39;UPLAND_SKM&#39;</span>] <span class="op">-</span> original_min) <span class="op">/</span> (original_max <span class="op">-</span> original_min)</span>
<span id="cb346-6"><a href="#cb346-6" tabindex="-1"></a>river_gdf[<span class="st">&#39;width&#39;</span>] <span class="op">=</span> scaled.clip(<span class="dv">0</span>, <span class="dv">1</span>) <span class="op">*</span> (target_max <span class="op">-</span> target_min) <span class="op">+</span> target_min</span>
<span id="cb346-7"><a href="#cb346-7" tabindex="-1"></a>river_gdf_final <span class="op">=</span> river_gdf.sort_values([<span class="st">&#39;UPLAND_SKM&#39;</span>, <span class="st">&#39;width&#39;</span>])[</span>
<span id="cb346-8"><a href="#cb346-8" tabindex="-1"></a>    [<span class="st">&#39;MAIN_RIV&#39;</span>, <span class="st">&#39;UPLAND_SKM&#39;</span>, <span class="st">&#39;width&#39;</span>, <span class="st">&#39;geometry&#39;</span>]]</span>
<span id="cb346-9"><a href="#cb346-9" tabindex="-1"></a>river_gdf_final</span></code></pre></div>
<p>We want to assign a color based on the <code>MAIN_RIV</code>
attribute. We will split the rivers into 10 equal bins.</p>
<div class="sourceCode" id="cb347"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb347-1"><a href="#cb347-1" tabindex="-1"></a>river_gdf_final[<span class="st">&#39;color&#39;</span>] <span class="op">=</span> pd.qcut(</span>
<span id="cb347-2"><a href="#cb347-2" tabindex="-1"></a>    river_gdf_final.MAIN_RIV, q<span class="op">=</span><span class="dv">10</span>,</span>
<span id="cb347-3"><a href="#cb347-3" tabindex="-1"></a>    labels<span class="op">=</span><span class="va">False</span>, duplicates<span class="op">=</span><span class="st">&#39;drop&#39;</span>)</span>
<span id="cb347-4"><a href="#cb347-4" tabindex="-1"></a>river_gdf_final</span></code></pre></div>
<p>We create a discreate colormap by assigning a color to each bin.</p>
<div class="sourceCode" id="cb348"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb348-1"><a href="#cb348-1" tabindex="-1"></a>cmap <span class="op">=</span> palettable.colorbrewer.diverging.Spectral_10</span>
<span id="cb348-2"><a href="#cb348-2" tabindex="-1"></a></span>
<span id="cb348-3"><a href="#cb348-3" tabindex="-1"></a>colormap <span class="op">=</span> {}</span>
<span id="cb348-4"><a href="#cb348-4" tabindex="-1"></a><span class="cf">for</span> i, color <span class="kw">in</span> <span class="bu">enumerate</span>(cmap.colors):</span>
<span id="cb348-5"><a href="#cb348-5" tabindex="-1"></a>    colormap[i] <span class="op">=</span> color</span>
<span id="cb348-6"><a href="#cb348-6" tabindex="-1"></a>colormap</span></code></pre></div>
<div class="sourceCode" id="cb349"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb349-1"><a href="#cb349-1" tabindex="-1"></a>basemap <span class="op">=</span> lonboard.basemap.CartoBasemap.DarkMatterNoLabels</span>
<span id="cb349-2"><a href="#cb349-2" tabindex="-1"></a>cmap <span class="op">=</span> palettable.colorbrewer.diverging.Spectral_10</span>
<span id="cb349-3"><a href="#cb349-3" tabindex="-1"></a>widths <span class="op">=</span> river_gdf_final[<span class="st">&#39;width&#39;</span>]</span>
<span id="cb349-4"><a href="#cb349-4" tabindex="-1"></a>colors <span class="op">=</span> lonboard.colormap.apply_categorical_cmap(</span>
<span id="cb349-5"><a href="#cb349-5" tabindex="-1"></a>    river_gdf_final[<span class="st">&#39;color&#39;</span>], colormap)</span>
<span id="cb349-6"><a href="#cb349-6" tabindex="-1"></a></span>
<span id="cb349-7"><a href="#cb349-7" tabindex="-1"></a>m <span class="op">=</span> leafmap.Map(height<span class="op">=</span><span class="dv">700</span>, basemap_style<span class="op">=</span>basemap)</span>
<span id="cb349-8"><a href="#cb349-8" tabindex="-1"></a>m.add_gdf(river_gdf_final,</span>
<span id="cb349-9"><a href="#cb349-9" tabindex="-1"></a>          zoom_to_layer<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb349-10"><a href="#cb349-10" tabindex="-1"></a>          pickable<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb349-11"><a href="#cb349-11" tabindex="-1"></a>          get_width<span class="op">=</span>widths,</span>
<span id="cb349-12"><a href="#cb349-12" tabindex="-1"></a>          get_color<span class="op">=</span>colors,</span>
<span id="cb349-13"><a href="#cb349-13" tabindex="-1"></a>          width_units<span class="op">=</span><span class="st">&#39;pixels&#39;</span></span>
<span id="cb349-14"><a href="#cb349-14" tabindex="-1"></a>)</span>
<span id="cb349-15"><a href="#cb349-15" tabindex="-1"></a>m</span></code></pre></div>
</div>
</div>
</div>
<div id="streamlit" class="section level2">
<h2>Streamlit</h2>
<div id="interactive-mapping-dashboard" class="section level3">
<h3>Interactive Mapping Dashboard</h3>
<p>We can utilize the bi-directional <code>st_folium()</code> component
from the <code>streamlit-folium</code> package to make an interactive
mapping dashboard. This component allows us to get information back when
the user interacts with the map. We can use this information to update
the app. The app below shows how we can modify the <a
href="#create-a-mapping-dashboard">Mapping Dashboard</a> created earlier
to make the map interactive.</p>
<p>See the live demo: <a
href="https://interactive-mapping-dashboard.streamlit.app/"><img
src="https://static.streamlit.io/badges/streamlit_badge_black_white.svg"
alt="An Interactive Mapping Dashboard App" /></a></p>
<div class="sourceCode" id="cb350"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb350-1"><a href="#cb350-1" tabindex="-1"></a><span class="im">import</span> streamlit <span class="im">as</span> st</span>
<span id="cb350-2"><a href="#cb350-2" tabindex="-1"></a><span class="im">import</span> folium</span>
<span id="cb350-3"><a href="#cb350-3" tabindex="-1"></a><span class="im">import</span> leafmap.foliumap <span class="im">as</span> leafmap</span>
<span id="cb350-4"><a href="#cb350-4" tabindex="-1"></a><span class="im">import</span> geopandas <span class="im">as</span> gpd</span>
<span id="cb350-5"><a href="#cb350-5" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb350-6"><a href="#cb350-6" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb350-7"><a href="#cb350-7" tabindex="-1"></a></span>
<span id="cb350-8"><a href="#cb350-8" tabindex="-1"></a><span class="cf">if</span> <span class="st">&#39;selected_district&#39;</span> <span class="kw">not</span> <span class="kw">in</span> st.session_state:</span>
<span id="cb350-9"><a href="#cb350-9" tabindex="-1"></a>    st.session_state[<span class="st">&#39;selected_district&#39;</span>] <span class="op">=</span> <span class="st">&#39;Bidar&#39;</span></span>
<span id="cb350-10"><a href="#cb350-10" tabindex="-1"></a>    </span>
<span id="cb350-11"><a href="#cb350-11" tabindex="-1"></a>st.set_page_config(page_title<span class="op">=</span><span class="st">&quot;Dashboard&quot;</span>, layout<span class="op">=</span><span class="st">&quot;wide&quot;</span>)</span>
<span id="cb350-12"><a href="#cb350-12" tabindex="-1"></a></span>
<span id="cb350-13"><a href="#cb350-13" tabindex="-1"></a>st.title(<span class="st">&#39;Interactive Highway Dashboard&#39;</span>)</span>
<span id="cb350-14"><a href="#cb350-14" tabindex="-1"></a></span>
<span id="cb350-15"><a href="#cb350-15" tabindex="-1"></a>st.sidebar.title(<span class="st">&quot;About&quot;</span>)</span>
<span id="cb350-16"><a href="#cb350-16" tabindex="-1"></a>st.sidebar.info(<span class="st">&#39;Explore the Roads&#39;</span>)</span>
<span id="cb350-17"><a href="#cb350-17" tabindex="-1"></a>st.sidebar.markdown(<span class="st">&#39;Click on any feature to see the stats. &#39;</span></span>
<span id="cb350-18"><a href="#cb350-18" tabindex="-1"></a>  <span class="st">&#39;The text and chart below will update as you click on the map.&#39;</span>)</span>
<span id="cb350-19"><a href="#cb350-19" tabindex="-1"></a></span>
<span id="cb350-20"><a href="#cb350-20" tabindex="-1"></a>selected <span class="op">=</span> st.sidebar.markdown(<span class="ss">f&#39;Current selection: :red[</span><span class="sc">{</span>st<span class="sc">.</span>session_state<span class="sc">.</span>selected_district<span class="sc">}</span><span class="ss">]&#39;</span>)</span>
<span id="cb350-21"><a href="#cb350-21" tabindex="-1"></a></span>
<span id="cb350-22"><a href="#cb350-22" tabindex="-1"></a>data_url <span class="op">=</span> <span class="st">&#39;https://github.com/spatialthoughts/python-dataviz-web/releases/&#39;</span> \</span>
<span id="cb350-23"><a href="#cb350-23" tabindex="-1"></a>        <span class="st">&#39;download/osm/&#39;</span></span>
<span id="cb350-24"><a href="#cb350-24" tabindex="-1"></a>gpkg_file <span class="op">=</span> <span class="st">&#39;karnataka.gpkg&#39;</span></span>
<span id="cb350-25"><a href="#cb350-25" tabindex="-1"></a>csv_file <span class="op">=</span> <span class="st">&#39;highway_lengths_by_district.csv&#39;</span></span>
<span id="cb350-26"><a href="#cb350-26" tabindex="-1"></a></span>
<span id="cb350-27"><a href="#cb350-27" tabindex="-1"></a><span class="at">@st.cache_data</span></span>
<span id="cb350-28"><a href="#cb350-28" tabindex="-1"></a><span class="kw">def</span> read_gdf(url, layer):</span>
<span id="cb350-29"><a href="#cb350-29" tabindex="-1"></a>    gdf <span class="op">=</span> gpd.read_file(url, layer<span class="op">=</span>layer)</span>
<span id="cb350-30"><a href="#cb350-30" tabindex="-1"></a>    <span class="cf">return</span> gdf</span>
<span id="cb350-31"><a href="#cb350-31" tabindex="-1"></a></span>
<span id="cb350-32"><a href="#cb350-32" tabindex="-1"></a><span class="at">@st.cache_data</span></span>
<span id="cb350-33"><a href="#cb350-33" tabindex="-1"></a><span class="kw">def</span> read_csv(url):</span>
<span id="cb350-34"><a href="#cb350-34" tabindex="-1"></a>    df <span class="op">=</span> pd.read_csv(url)</span>
<span id="cb350-35"><a href="#cb350-35" tabindex="-1"></a>    <span class="cf">return</span> df</span>
<span id="cb350-36"><a href="#cb350-36" tabindex="-1"></a>    </span>
<span id="cb350-37"><a href="#cb350-37" tabindex="-1"></a>   </span>
<span id="cb350-38"><a href="#cb350-38" tabindex="-1"></a>gpkg_url <span class="op">=</span> data_url <span class="op">+</span> gpkg_file</span>
<span id="cb350-39"><a href="#cb350-39" tabindex="-1"></a>csv_url <span class="op">=</span> data_url <span class="op">+</span> csv_file</span>
<span id="cb350-40"><a href="#cb350-40" tabindex="-1"></a>districts_gdf <span class="op">=</span> read_gdf(gpkg_url, <span class="st">&#39;karnataka_districts&#39;</span>)</span>
<span id="cb350-41"><a href="#cb350-41" tabindex="-1"></a>roads_gdf <span class="op">=</span> read_gdf(gpkg_url, <span class="st">&#39;karnataka_highways&#39;</span>)</span>
<span id="cb350-42"><a href="#cb350-42" tabindex="-1"></a>lengths_df <span class="op">=</span> read_csv(csv_url)</span>
<span id="cb350-43"><a href="#cb350-43" tabindex="-1"></a></span>
<span id="cb350-44"><a href="#cb350-44" tabindex="-1"></a></span>
<span id="cb350-45"><a href="#cb350-45" tabindex="-1"></a></span>
<span id="cb350-46"><a href="#cb350-46" tabindex="-1"></a>m <span class="op">=</span> leafmap.Map(</span>
<span id="cb350-47"><a href="#cb350-47" tabindex="-1"></a>    layers_control<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb350-48"><a href="#cb350-48" tabindex="-1"></a>    draw_control<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb350-49"><a href="#cb350-49" tabindex="-1"></a>    measure_control<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb350-50"><a href="#cb350-50" tabindex="-1"></a>    fullscreen_control<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb350-51"><a href="#cb350-51" tabindex="-1"></a>)</span>
<span id="cb350-52"><a href="#cb350-52" tabindex="-1"></a></span>
<span id="cb350-53"><a href="#cb350-53" tabindex="-1"></a>m.add_gdf(</span>
<span id="cb350-54"><a href="#cb350-54" tabindex="-1"></a>    gdf<span class="op">=</span>districts_gdf,</span>
<span id="cb350-55"><a href="#cb350-55" tabindex="-1"></a>    layer_name<span class="op">=</span><span class="st">&#39;districts&#39;</span>,</span>
<span id="cb350-56"><a href="#cb350-56" tabindex="-1"></a>    zoom_to_layer<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb350-57"><a href="#cb350-57" tabindex="-1"></a>    info_mode<span class="op">=</span><span class="st">&#39;none&#39;</span>,</span>
<span id="cb350-58"><a href="#cb350-58" tabindex="-1"></a>    style<span class="op">=</span>{<span class="st">&#39;color&#39;</span>: <span class="st">&#39;black&#39;</span>, <span class="st">&#39;fillOpacity&#39;</span>: <span class="fl">0.3</span>, <span class="st">&#39;weight&#39;</span>: <span class="fl">0.5</span>},</span>
<span id="cb350-59"><a href="#cb350-59" tabindex="-1"></a>    )</span>
<span id="cb350-60"><a href="#cb350-60" tabindex="-1"></a></span>
<span id="cb350-61"><a href="#cb350-61" tabindex="-1"></a> </span>
<span id="cb350-62"><a href="#cb350-62" tabindex="-1"></a>map_data <span class="op">=</span> m.to_streamlit(<span class="dv">800</span>, <span class="dv">600</span>, bidirectional<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb350-63"><a href="#cb350-63" tabindex="-1"></a></span>
<span id="cb350-64"><a href="#cb350-64" tabindex="-1"></a></span>
<span id="cb350-65"><a href="#cb350-65" tabindex="-1"></a></span>
<span id="cb350-66"><a href="#cb350-66" tabindex="-1"></a>district_lengths <span class="op">=</span> lengths_df[lengths_df[<span class="st">&#39;DISTRICT&#39;</span>] <span class="op">==</span> st.session_state.selected_district]</span>
<span id="cb350-67"><a href="#cb350-67" tabindex="-1"></a></span>
<span id="cb350-68"><a href="#cb350-68" tabindex="-1"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb350-69"><a href="#cb350-69" tabindex="-1"></a>district_lengths.plot(kind<span class="op">=</span><span class="st">&#39;bar&#39;</span>, ax<span class="op">=</span>ax, color<span class="op">=</span>[<span class="st">&#39;blue&#39;</span>, <span class="st">&#39;red&#39;</span>, <span class="st">&#39;gray&#39;</span>], </span>
<span id="cb350-70"><a href="#cb350-70" tabindex="-1"></a>  ylabel<span class="op">=</span><span class="st">&#39;Kilometers&#39;</span>, xlabel<span class="op">=</span><span class="st">&#39;Category&#39;</span>)</span>
<span id="cb350-71"><a href="#cb350-71" tabindex="-1"></a>ax.get_xaxis().set_ticklabels([])</span>
<span id="cb350-72"><a href="#cb350-72" tabindex="-1"></a>ax.set_ylim(<span class="dv">0</span>, <span class="dv">2500</span>)</span>
<span id="cb350-73"><a href="#cb350-73" tabindex="-1"></a>stats <span class="op">=</span> st.sidebar.pyplot(fig)</span>
<span id="cb350-74"><a href="#cb350-74" tabindex="-1"></a></span>
<span id="cb350-75"><a href="#cb350-75" tabindex="-1"></a><span class="cf">if</span> map_data[<span class="st">&#39;last_object_clicked&#39;</span>]:</span>
<span id="cb350-76"><a href="#cb350-76" tabindex="-1"></a>    clicked_district <span class="op">=</span> map_data[<span class="st">&#39;last_active_drawing&#39;</span>][<span class="st">&#39;properties&#39;</span>][<span class="st">&#39;DISTRICT&#39;</span>]</span>
<span id="cb350-77"><a href="#cb350-77" tabindex="-1"></a>    st.session_state.selected_district <span class="op">=</span> clicked_district</span>
<span id="cb350-78"><a href="#cb350-78" tabindex="-1"></a>    selected.write(<span class="ss">f&#39;Current selection: :red[</span><span class="sc">{</span>st<span class="sc">.</span>session_state<span class="sc">.</span>selected_district<span class="sc">}</span><span class="ss">]&#39;</span>)</span></code></pre></div>
<p>We must make sure to include a <code>requirements.txt</code> with the
following content.</p>
<div class="sourceCode" id="cb351"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb351-1"><a href="#cb351-1" tabindex="-1"></a>streamlit</span>
<span id="cb351-2"><a href="#cb351-2" tabindex="-1"></a>leafmap</span>
<span id="cb351-3"><a href="#cb351-3" tabindex="-1"></a>pandas</span>
<span id="cb351-4"><a href="#cb351-4" tabindex="-1"></a>geopandas</span>
<span id="cb351-5"><a href="#cb351-5" tabindex="-1"></a>streamlit<span class="op">-</span>folium</span></code></pre></div>
</div>
<div id="bouding-box-app" class="section level3">
<h3>Bouding Box App</h3>
<p>This is a simple app to get the coordinates and bounding-box of any
place in the world. This uses the <code>geopy</code> library for
geocoding and <code>streamlit-folium</code> bi-directional component to
get the real-time update of the map bounds. We use <a
href="https://docs.streamlit.io/develop/api-reference/caching-and-state/st.session_state">Session
State</a> to store the map center and zoom level. This is used within
the <code>folium.Map()</code> to initialized it the saved center and
zoom level.</p>
<p>See the live demo: <a href="https://boundingbox.streamlit.app/"><img
src="https://static.streamlit.io/badges/streamlit_badge_black_white.svg"
alt="Bounding Box App" /></a></p>
<div class="sourceCode" id="cb352"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb352-1"><a href="#cb352-1" tabindex="-1"></a><span class="co"># import folium</span></span>
<span id="cb352-2"><a href="#cb352-2" tabindex="-1"></a><span class="im">import</span> streamlit <span class="im">as</span> st</span>
<span id="cb352-3"><a href="#cb352-3" tabindex="-1"></a><span class="im">from</span> geopy.geocoders <span class="im">import</span> Nominatim</span>
<span id="cb352-4"><a href="#cb352-4" tabindex="-1"></a><span class="im">import</span> folium</span>
<span id="cb352-5"><a href="#cb352-5" tabindex="-1"></a><span class="im">from</span> streamlit_folium <span class="im">import</span> st_folium</span>
<span id="cb352-6"><a href="#cb352-6" tabindex="-1"></a></span>
<span id="cb352-7"><a href="#cb352-7" tabindex="-1"></a><span class="co"># Initialize session state</span></span>
<span id="cb352-8"><a href="#cb352-8" tabindex="-1"></a><span class="cf">if</span> <span class="st">&quot;center&quot;</span> <span class="kw">not</span> <span class="kw">in</span> st.session_state:</span>
<span id="cb352-9"><a href="#cb352-9" tabindex="-1"></a>    st.session_state[<span class="st">&quot;center&quot;</span>] <span class="op">=</span> [<span class="fl">37.7749</span>, <span class="op">-</span><span class="fl">122.4194</span>]  <span class="co"># Default to San Francisco</span></span>
<span id="cb352-10"><a href="#cb352-10" tabindex="-1"></a><span class="cf">if</span> <span class="st">&quot;zoom&quot;</span> <span class="kw">not</span> <span class="kw">in</span> st.session_state:</span>
<span id="cb352-11"><a href="#cb352-11" tabindex="-1"></a>    st.session_state[<span class="st">&quot;zoom&quot;</span>] <span class="op">=</span> <span class="dv">13</span></span>
<span id="cb352-12"><a href="#cb352-12" tabindex="-1"></a>    </span>
<span id="cb352-13"><a href="#cb352-13" tabindex="-1"></a>st.title(<span class="st">&#39;Bounding Box Tool&#39;</span>)</span>
<span id="cb352-14"><a href="#cb352-14" tabindex="-1"></a>st.markdown(<span class="st">&#39;This app allows you to get coordinates and bounding box for any &#39;</span></span>
<span id="cb352-15"><a href="#cb352-15" tabindex="-1"></a>  <span class="st">&#39;place in the world - powered by OpenStreetMap.&#39;</span>)</span>
<span id="cb352-16"><a href="#cb352-16" tabindex="-1"></a></span>
<span id="cb352-17"><a href="#cb352-17" tabindex="-1"></a>address <span class="op">=</span> st.text_input(<span class="st">&#39;Enter an address.&#39;</span>)</span>
<span id="cb352-18"><a href="#cb352-18" tabindex="-1"></a></span>
<span id="cb352-19"><a href="#cb352-19" tabindex="-1"></a>col1, col2 <span class="op">=</span> st.columns([<span class="fl">0.3</span>, <span class="fl">0.7</span>])</span>
<span id="cb352-20"><a href="#cb352-20" tabindex="-1"></a>col1.text(<span class="st">&#39;Center Coordinates&#39;</span>)</span>
<span id="cb352-21"><a href="#cb352-21" tabindex="-1"></a>col1.caption(<span class="st">&#39;Format is X,Y (Longitude/Latitude)&#39;</span>)</span>
<span id="cb352-22"><a href="#cb352-22" tabindex="-1"></a>coordinate_text <span class="op">=</span> col2.text(<span class="st">&#39;&#39;</span>)</span>
<span id="cb352-23"><a href="#cb352-23" tabindex="-1"></a>col3, col4 <span class="op">=</span> st.columns([<span class="fl">0.3</span>, <span class="fl">0.7</span>])</span>
<span id="cb352-24"><a href="#cb352-24" tabindex="-1"></a>col3.text(<span class="st">&#39;Bounding Box&#39;</span>)</span>
<span id="cb352-25"><a href="#cb352-25" tabindex="-1"></a>col3.caption(<span class="st">&#39;Format is [Xmin,Ymin,XMax,YMax]&#39;</span>)</span>
<span id="cb352-26"><a href="#cb352-26" tabindex="-1"></a>boundingbox_text <span class="op">=</span> col4.text(<span class="st">&#39;&#39;</span>)</span>
<span id="cb352-27"><a href="#cb352-27" tabindex="-1"></a></span>
<span id="cb352-28"><a href="#cb352-28" tabindex="-1"></a><span class="co"># Function to update the center</span></span>
<span id="cb352-29"><a href="#cb352-29" tabindex="-1"></a><span class="kw">def</span> update_map(lat, lon, zoom):</span>
<span id="cb352-30"><a href="#cb352-30" tabindex="-1"></a>    st.session_state[<span class="st">&quot;center&quot;</span>] <span class="op">=</span> [lat, lon]</span>
<span id="cb352-31"><a href="#cb352-31" tabindex="-1"></a>    st.session_state[<span class="st">&#39;zoom&#39;</span>] <span class="op">=</span> zoom</span>
<span id="cb352-32"><a href="#cb352-32" tabindex="-1"></a>    </span>
<span id="cb352-33"><a href="#cb352-33" tabindex="-1"></a></span>
<span id="cb352-34"><a href="#cb352-34" tabindex="-1"></a><span class="at">@st.cache_data</span></span>
<span id="cb352-35"><a href="#cb352-35" tabindex="-1"></a><span class="kw">def</span> geocode(query):</span>
<span id="cb352-36"><a href="#cb352-36" tabindex="-1"></a>    geolocator <span class="op">=</span> Nominatim(user_agent<span class="op">=</span><span class="st">&#39;streamlit-boundingbox&#39;</span>)</span>
<span id="cb352-37"><a href="#cb352-37" tabindex="-1"></a>    location <span class="op">=</span> geolocator.geocode(address)</span>
<span id="cb352-38"><a href="#cb352-38" tabindex="-1"></a>    <span class="cf">return</span> location</span>
<span id="cb352-39"><a href="#cb352-39" tabindex="-1"></a>    </span>
<span id="cb352-40"><a href="#cb352-40" tabindex="-1"></a><span class="cf">if</span> address:</span>
<span id="cb352-41"><a href="#cb352-41" tabindex="-1"></a>    location <span class="op">=</span> geocode(address)</span>
<span id="cb352-42"><a href="#cb352-42" tabindex="-1"></a>    <span class="cf">if</span> location:</span>
<span id="cb352-43"><a href="#cb352-43" tabindex="-1"></a>        geocode_lat <span class="op">=</span> location.latitude</span>
<span id="cb352-44"><a href="#cb352-44" tabindex="-1"></a>        geocode_lng <span class="op">=</span> location.longitude</span>
<span id="cb352-45"><a href="#cb352-45" tabindex="-1"></a>        zoom <span class="op">=</span> <span class="dv">8</span></span>
<span id="cb352-46"><a href="#cb352-46" tabindex="-1"></a>        update_map(geocode_lat, geocode_lng, zoom)</span>
<span id="cb352-47"><a href="#cb352-47" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb352-48"><a href="#cb352-48" tabindex="-1"></a>        st.error(<span class="st">&#39;Request failed. No results.&#39;</span>)</span>
<span id="cb352-49"><a href="#cb352-49" tabindex="-1"></a></span>
<span id="cb352-50"><a href="#cb352-50" tabindex="-1"></a><span class="co"># Create a folium map</span></span>
<span id="cb352-51"><a href="#cb352-51" tabindex="-1"></a>m <span class="op">=</span> folium.Map(location<span class="op">=</span>st.session_state[<span class="st">&quot;center&quot;</span>], zoom_start<span class="op">=</span>st.session_state[<span class="st">&quot;zoom&quot;</span>])</span>
<span id="cb352-52"><a href="#cb352-52" tabindex="-1"></a></span>
<span id="cb352-53"><a href="#cb352-53" tabindex="-1"></a><span class="co"># Display the map</span></span>
<span id="cb352-54"><a href="#cb352-54" tabindex="-1"></a>st_data <span class="op">=</span> st_folium(</span>
<span id="cb352-55"><a href="#cb352-55" tabindex="-1"></a>    m,</span>
<span id="cb352-56"><a href="#cb352-56" tabindex="-1"></a>    center<span class="op">=</span>st.session_state[<span class="st">&quot;center&quot;</span>],</span>
<span id="cb352-57"><a href="#cb352-57" tabindex="-1"></a>    zoom<span class="op">=</span>st.session_state[<span class="st">&quot;zoom&quot;</span>],</span>
<span id="cb352-58"><a href="#cb352-58" tabindex="-1"></a>    key<span class="op">=</span><span class="st">&quot;map&quot;</span>,</span>
<span id="cb352-59"><a href="#cb352-59" tabindex="-1"></a>    height<span class="op">=</span><span class="dv">400</span>,</span>
<span id="cb352-60"><a href="#cb352-60" tabindex="-1"></a>    width<span class="op">=</span><span class="dv">700</span>,</span>
<span id="cb352-61"><a href="#cb352-61" tabindex="-1"></a>)</span>
<span id="cb352-62"><a href="#cb352-62" tabindex="-1"></a>        </span>
<span id="cb352-63"><a href="#cb352-63" tabindex="-1"></a>center <span class="op">=</span> st_data[<span class="st">&#39;center&#39;</span>]</span>
<span id="cb352-64"><a href="#cb352-64" tabindex="-1"></a>lat <span class="op">=</span> center[<span class="st">&#39;lat&#39;</span>]</span>
<span id="cb352-65"><a href="#cb352-65" tabindex="-1"></a>lng <span class="op">=</span> center[<span class="st">&#39;lng&#39;</span>]</span>
<span id="cb352-66"><a href="#cb352-66" tabindex="-1"></a>bounds <span class="op">=</span> st_data[<span class="st">&#39;bounds&#39;</span>]</span>
<span id="cb352-67"><a href="#cb352-67" tabindex="-1"></a>lowerleft <span class="op">=</span> bounds[<span class="st">&#39;_southWest&#39;</span>]</span>
<span id="cb352-68"><a href="#cb352-68" tabindex="-1"></a>upperright <span class="op">=</span> bounds[<span class="st">&#39;_northEast&#39;</span>]</span>
<span id="cb352-69"><a href="#cb352-69" tabindex="-1"></a>ymin <span class="op">=</span> lowerleft[<span class="st">&#39;lat&#39;</span>]</span>
<span id="cb352-70"><a href="#cb352-70" tabindex="-1"></a>xmin <span class="op">=</span> lowerleft[<span class="st">&#39;lng&#39;</span>]</span>
<span id="cb352-71"><a href="#cb352-71" tabindex="-1"></a>ymax <span class="op">=</span> upperright[<span class="st">&#39;lat&#39;</span>]</span>
<span id="cb352-72"><a href="#cb352-72" tabindex="-1"></a>xmax <span class="op">=</span> upperright[<span class="st">&#39;lng&#39;</span>]</span>
<span id="cb352-73"><a href="#cb352-73" tabindex="-1"></a></span>
<span id="cb352-74"><a href="#cb352-74" tabindex="-1"></a>coordinate_text.text(<span class="ss">f&#39;</span><span class="sc">{</span>lng<span class="sc">:.4f}</span><span class="ss">, </span><span class="sc">{</span>lat<span class="sc">:.4f}</span><span class="ss">&#39;</span>)</span>
<span id="cb352-75"><a href="#cb352-75" tabindex="-1"></a>boundingbox_text.text(<span class="ss">f&#39;[</span><span class="sc">{</span>xmin<span class="sc">:.4f}</span><span class="ss">, </span><span class="sc">{</span>ymin<span class="sc">:.4f}</span><span class="ss">, </span><span class="sc">{</span>xmax<span class="sc">:.4f}</span><span class="ss">, </span><span class="sc">{</span>ymax<span class="sc">:.4f}</span><span class="ss">]&#39;</span>)</span></code></pre></div>
<p>We must make sure to include a <code>requirements.txt</code> with the
following content.</p>
<div class="sourceCode" id="cb353"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb353-1"><a href="#cb353-1" tabindex="-1"></a>streamlit<span class="op">-</span>folium</span>
<span id="cb353-2"><a href="#cb353-2" tabindex="-1"></a>geopy</span></code></pre></div>
</div>
</div>
</div>
<div id="resources" class="section level1">
<h1>Resources</h1>
<ul>
<li>Spatial Thoughts’ <a
href="https://www.geopythontutorials.com/">Geospatial Python
Tutorials</a> covering step-by-step tutorials for data analysis and
advanced visualizations using GeoPandas, XArray and more.</li>
<li><a
href="https://jakevdp.github.io/PythonDataScienceHandbook/04.00-introduction-to-matplotlib.html">Visualization
with Matplotlib</a>: Python Data Science Handbook by Jake
VanderPlas</li>
<li><a href="https://locatepress.com/book/pymaps">Python Maps:
Geospatial Visualization with Python</a>: Book by Adam Symington</li>
<li><a href="https://python-graph-gallery.com/">The Python Graph
Gallery</a>: Collection of hundreds of charts made with Python with
detailed walk-throughs.</li>
<li><a
href="https://github.com/MarcSkovMadsen/awesome-streamlit">Awesome
Streamlit</a>: A curated list of Awesome Streamlit resources and gallery
of Streamlit apps.</li>
</ul>
</div>
<div id="data-credits" class="section level1">
<h1>Data Credits</h1>
<ul>
<li>London Crime Statistics: ASB Incidents, Crime and Outcome - UK Home
Office. Retrieved 2022-01-20. <a href="https://data.police.uk/about/"
class="uri">https://data.police.uk/about/</a></li>
<li>California Census Data: U.S. Census Bureau, 2019 American Community
Survey 5-Year Estimates and Cartographic Boundary Files - Shapefile:
2019</li>
<li>Eclipse Shapefiles: NASA’s Scientific Visualization Studio
Downloaded from <a href="https://svs.gsfc.nasa.gov/4518"
class="uri">https://svs.gsfc.nasa.gov/4518</a></li>
<li>NASA Shuttle Radar Topography Mission (SRTM) Elevation Dataset.
Downloaded from <a href="https://dwtkns.com/srtm30m/%5D">30m SRTM Tile
Downloader</a>.</li>
<li>Temperature Anomalies: GISTEMP Team, 2022: GISS Surface Temperature
Analysis (GISTEMP), version 4. NASA Goddard Institute for Space Studies.
Dataset accessed 2022-01-26 at <a
href="https://data.giss.nasa.gov/gistemp/"
class="uri">https://data.giss.nasa.gov/gistemp/</a>.</li>
<li>OpenStreetMap (osm) data layers: Data/Maps Copyright 2019 Geofabrik
GmbH and OpenStreetMap Contributors. <a
href="https://download.geofabrik.de/asia/india.html">OSM India free
extract</a> downloaded from Geofabrik.</li>
<li>Bangalore Ward Maps Provided by <a
href="http://projects.datameet.org/Municipal_Spatial_Data/">Spatial Data
of Municipalities (Maps) Project</a> by Data{Meet}.</li>
<li>Bangalore LandCover Data: <a
href="https://esa-worldcover.org/en">ESA WorldCover project 2020</a> /
Contains modified Copernicus Sentinel data (2020) processed by ESA
WorldCover consortium</li>
<li>VIIRS NightTime Lights: Created from <a
href="https://developers.google.com/earth-engine/datasets/catalog/NOAA_VIIRS_DNB_MONTHLY_V1_VCMCFG#description">VIIRS
Nighttime Day/Night Band Composites Version 1</a>, Earth Observation
Group, Payne Institute for Public Policy, Colorado School of Mines</li>
</ul>
</div>
<div id="license" class="section level1">
<h1>License</h1>
<p>This course material is licensed under a <a
href="https://creativecommons.org/licenses/by/4.0/">Creative Commons
Attribution 4.0 International (CC BY 4.0)</a>. You are free to re-use
and adapt the material but are required to give appropriate credit to
the original author as below:</p>
<p><em>Mapping and Data Visualization with Python Course</em> by Ujaval
Gandhi <a
href="https://spatialthoughts.com">www.spatialthoughts.com</a></p>
<hr />
<p><strong>This course is offered as an instructor-led online class.
Visit <a href="https://spatialthoughts.com/events">Spatial Thoughts</a>
to know details of upcoming sessions.</strong></p>
<hr />
<p>© 2022 Spatial Thoughts <a
href="https://spatialthoughts.com">www.spatialthoughts.com</a></p>
</div>

<!-- Comment Section Powered by utterances -->
<div id="comments">
  <hr />
  <p>If you want to report any issues with this page, please comment below.</p>
<script src="https://utteranc.es/client.js"
        repo="spatialthoughts/courses"
        issue-term="title"
        label="comment"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>
</div>



</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.odd').parent('tbody').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open');
  });
});
</script>

<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
